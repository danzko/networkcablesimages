(function(define,global){define(function(require){when.promise=promise;when.resolve=resolve;when.reject=reject;when.defer=defer;when.join=join;when.all=all;when.map=map;when.reduce=reduce;when.settle=settle;when.any=any;when.some=some;when.isPromise=isPromiseLike;when.isPromiseLike=isPromiseLike;function when(promiseOrValue,onFulfilled,onRejected,onProgress){return cast(promiseOrValue).then(onFulfilled,onRejected,onProgress)}function cast(x){return x instanceof Promise?x:resolve(x)}function Promise(sendMessage,inspect){this._message=sendMessage;this.inspect=inspect}Promise.prototype={then:function(onFulfilled,onRejected,onProgress){var args,sendMessage;args=arguments;sendMessage=this._message;return _promise(function(resolve,reject,notify){sendMessage("when",args,resolve,notify)},this._status&&this._status.observed())},otherwise:function(onRejected){return this.then(undef,onRejected)},ensure:function(onFulfilledOrRejected){return typeof onFulfilledOrRejected==="function"?this.then(injectHandler,injectHandler)["yield"](this):this;function injectHandler(){return resolve(onFulfilledOrRejected())}},yield:function(value){return this.then(function(){return value})},tap:function(onFulfilledSideEffect){return this.then(onFulfilledSideEffect)["yield"](this)},spread:function(onFulfilled){return this.then(function(array){return all(array,function(array){return onFulfilled.apply(undef,array)})})},always:function(onFulfilledOrRejected,onProgress){return this.then(onFulfilledOrRejected,onFulfilledOrRejected,onProgress)}};function resolve(value){return promise(function(resolve){resolve(value)})}function reject(promiseOrValue){return when(promiseOrValue,rejected)}function defer(){var deferred,pending,resolved;deferred={promise:undef,resolve:undef,reject:undef,notify:undef,resolver:{resolve:undef,reject:undef,notify:undef}};deferred.promise=pending=promise(makeDeferred);return deferred;function makeDeferred(resolvePending,rejectPending,notifyPending){deferred.resolve=deferred.resolver.resolve=function(value){if(resolved){return resolve(value)}resolved=true;resolvePending(value);return pending};deferred.reject=deferred.resolver.reject=function(reason){if(resolved){return resolve(rejected(reason))}resolved=true;rejectPending(reason);return pending};deferred.notify=deferred.resolver.notify=function(update){notifyPending(update);return update}}}function promise(resolver){return _promise(resolver,monitorApi.PromiseStatus&&monitorApi.PromiseStatus())}function _promise(resolver,status){var self,value,consumers=[];self=new Promise(_message,inspect);self._status=status;try{resolver(promiseResolve,promiseReject,promiseNotify)}catch(e){promiseReject(e)}return self;function _message(type,args,resolve,notify){consumers?consumers.push(deliver):enqueue(function(){deliver(value)});function deliver(p){p._message(type,args,resolve,notify)}}function inspect(){return value?value.inspect():toPendingState()}function promiseResolve(val){if(!consumers){return}var queue=consumers;consumers=undef;enqueue(function(){value=coerce(self,val);if(status){updateStatus(value,status)}runHandlers(queue,value)})}function promiseReject(reason){promiseResolve(rejected(reason))}function promiseNotify(update){if(consumers){var queue=consumers;enqueue(function(){runHandlers(queue,progressed(update))})}}}function runHandlers(queue,value){for(var i=0;i<queue.length;i++){queue[i](value)}}function fulfilled(value){return near(new NearFulfilledProxy(value),function(){return toFulfilledState(value)})}function rejected(reason){return near(new NearRejectedProxy(reason),function(){return toRejectedState(reason)})}function near(proxy,inspect){return new Promise(function(type,args,resolve){try{resolve(proxy[type].apply(proxy,args))}catch(e){resolve(rejected(e))}},inspect)}function progressed(update){return new Promise(function(type,args,_,notify){var onProgress=args[2];try{notify(typeof onProgress==="function"?onProgress(update):update)}catch(e){notify(e)}})}function coerce(self,x){if(x===self){return rejected(new TypeError())}if(x instanceof Promise){return x}try{var untrustedThen=x===Object(x)&&x.then;return typeof untrustedThen==="function"?assimilate(untrustedThen,x):fulfilled(x)}catch(e){return rejected(e)}}function assimilate(untrustedThen,x){return promise(function(resolve,reject){fcall(untrustedThen,x,resolve,reject)})}function NearFulfilledProxy(value){this.value=value}NearFulfilledProxy.prototype.when=function(onResult){return typeof onResult==="function"?onResult(this.value):this.value};function NearRejectedProxy(reason){this.reason=reason}NearRejectedProxy.prototype.when=function(_,onError){if(typeof onError==="function"){return onError(this.reason)}else{throw this.reason}};function updateStatus(value,status){value.then(statusFulfilled,statusRejected);function statusFulfilled(){status.fulfilled()}function statusRejected(r){status.rejected(r)}}function isPromiseLike(x){return x&&typeof x.then==="function"}function some(promisesOrValues,howMany,onFulfilled,onRejected,onProgress){return when(promisesOrValues,function(promisesOrValues){return promise(resolveSome).then(onFulfilled,onRejected,onProgress);function resolveSome(resolve,reject,notify){var toResolve,toReject,values,reasons,fulfillOne,rejectOne,len,i;len=promisesOrValues.length>>>0;toResolve=Math.max(0,Math.min(howMany,len));values=[];toReject=(len-toResolve)+1;reasons=[];if(!toResolve){resolve(values)}else{rejectOne=function(reason){reasons.push(reason);if(!--toReject){fulfillOne=rejectOne=identity;reject(reasons)}};fulfillOne=function(val){values.push(val);if(!--toResolve){fulfillOne=rejectOne=identity;resolve(values)}};for(i=0;i<len;++i){if(i in promisesOrValues){when(promisesOrValues[i],fulfiller,rejecter,notify)}}}function rejecter(reason){rejectOne(reason)}function fulfiller(val){fulfillOne(val)}}})}function any(promisesOrValues,onFulfilled,onRejected,onProgress){function unwrapSingleResult(val){return onFulfilled?onFulfilled(val[0]):val[0]}return some(promisesOrValues,1,unwrapSingleResult,onRejected,onProgress)}function all(promisesOrValues,onFulfilled,onRejected,onProgress){return _map(promisesOrValues,identity).then(onFulfilled,onRejected,onProgress)}function join(){return _map(arguments,identity)}function settle(array){return _map(array,toFulfilledState,toRejectedState)}function map(array,mapFunc){return _map(array,mapFunc)}function _map(array,mapFunc,fallback){return when(array,function(array){return _promise(resolveMap);function resolveMap(resolve,reject,notify){var results,len,toResolve,i;toResolve=len=array.length>>>0;results=[];if(!toResolve){resolve(results);return}for(i=0;i<len;i++){if(i in array){resolveOne(array[i],i)}else{--toResolve}}function resolveOne(item,i){when(item,mapFunc,fallback).then(function(mapped){results[i]=mapped;if(!--toResolve){resolve(results)}},reject,notify)}}})}function reduce(promise,reduceFunc){var args=fcall(slice,arguments,1);return when(promise,function(array){var total;total=array.length;args[0]=function(current,val,i){return when(current,function(c){return when(val,function(value){return reduceFunc(c,value,i,total)})})};return reduceArray.apply(array,args)})}function toFulfilledState(x){return{state:"fulfilled",value:x}}function toRejectedState(x){return{state:"rejected",reason:x}}function toPendingState(){return{state:"pending"}}var reduceArray,slice,fcall,nextTick,handlerQueue,setTimeout,funcProto,call,arrayProto,monitorApi,cjsRequire,MutationObserver,undef;cjsRequire=require;handlerQueue=[];function enqueue(task){if(handlerQueue.push(task)===1){nextTick(drainQueue)}}function drainQueue(){runHandlers(handlerQueue);handlerQueue=[]}setTimeout=global.setTimeout;monitorApi=typeof console!="undefined"?console:when;if(typeof process==="object"&&process.nextTick){nextTick=process.nextTick}else{if(MutationObserver=global.MutationObserver||global.WebKitMutationObserver){nextTick=(function(document,MutationObserver,drainQueue){var el=document.createElement("div");new MutationObserver(drainQueue).observe(el,{attributes:true});return function(){el.setAttribute("x","x")}}(document,MutationObserver,drainQueue))}else{try{nextTick=cjsRequire("vertx").runOnLoop||cjsRequire("vertx").runOnContext}catch(ignore){nextTick=function(t){setTimeout(t,0)}}}}funcProto=Function.prototype;call=funcProto.call;fcall=funcProto.bind?call.bind(call):function(f,context){return f.apply(context,slice.call(arguments,2))};arrayProto=[];slice=arrayProto.slice;reduceArray=arrayProto.reduce||function(reduceFunc){var arr,args,reduced,len,i;i=0;arr=Object(this);len=arr.length>>>0;args=arguments;if(args.length<=1){for(;;){if(i in arr){reduced=arr[i++];break}if(++i>=len){throw new TypeError()}}}else{reduced=args[1]}for(;i<len;++i){if(i in arr){reduced=reduceFunc(reduced,arr[i],i,arr)}}return reduced};function identity(x){return x}return when})})(typeof define==="function"&&define.amd?define:function(factory){module.exports=factory(require)},this);