/*!
 &copy; http://www.oknosoft.ru 2014-2015
 @license content of this file is covered by Oknosoft Commercial license. Usage without proper license is prohibited. To obtain it contact info@oknosoft.ru
 @author Evgeniy Malyarov
 */
!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.$p=t()}(this,function(){function MetaEngine(){this.version="0.9.205",this.toString=function(){return"Oknosoft data engine. v:"+this.version},this.injected_data={}}function Messages(){this.toString=function(){return"Интернационализация сообщений"},"undefined"!=typeof window&&"dhtmlx"in window&&(this.show_msg=function(e,t){if(e){if("string"==typeof e){if($p.iface.synctxt)return void $p.iface.synctxt.show_message(e);e={type:"info",text:e}}t&&"function"==typeof t.setText&&t.setText(e.text),dhtmlx.message(e)}},this.check_soap_result=function(e){return e?"limit_query"==e.error?($p.iface.docs.progressOff(),$p.msg.show_msg({type:"alert-warning",text:$p.msg.limit_query.replace("%1",e.queries).replace("%2",e.queries_avalable),title:$p.msg.srv_overload}),!0):"network"==e.error||"empty"==e.error?($p.iface.docs.progressOff(),$p.msg.show_msg({type:"alert-warning",text:$p.msg.error_network,title:$p.msg.error_critical}),!0):e.error&&e.error_description?($p.iface.docs.progressOff(),-1!=e.error_description.indexOf("Недостаточно прав")&&(e.error_type="alert-warning",e.error_title=$p.msg.error_rights),$p.msg.show_msg({type:e.error_type||"alert-error",text:e.error_description,title:e.error_title||$p.msg.error_critical}),!0):e.error&&!e.messages?($p.iface.docs.progressOff(),$p.msg.show_msg({type:"alert-error",title:$p.msg.error_critical,text:$p.msg.unknown_error.replace("%1","unknown_error")}),!0):void 0:($p.msg.show_msg({type:"alert-error",text:$p.msg.empty_response,title:$p.msg.error_critical}),!0)},this.show_not_implemented=function(){$p.msg.show_msg({type:"alert-warning",text:$p.msg.not_implemented,title:$p.msg.main_title})})}function InterfaceObjs(){this.toString=function(){return"Объекты интерфейса пользователя"},this.clear_svgs=function(e){for("string"==typeof e&&(e=document.getElementById(e));e.firstChild;)e.removeChild(e.firstChild)},this.get_offset=function(e){var t={left:0,top:0};if(e.offsetParent)do t.left+=e.offsetLeft,t.top+=e.offsetTop;while(e=e.offsetParent);return t},this.normalize_xml=function(e){if(!e)return"";var t={"&":"&amp;",'"':"&quot;","'":"&apos;","<":"&lt;",">":"&gt;"};return e.replace(/[&"'<>]/g,function(e){return t[e]})},this.scale_svg=function(e,t,n){var r,a,o,s,i,_,c,u,p,l={};i=e.indexOf(">"),c=e.substring(5,i),o=c.split(" "),s=e.substr(i+1),s=s.substr(0,s.length-6);for(r in o)e=o[r].split("="),("width"==e[0]||"height"==e[0])&&(e[1]=Number(e[1].replace(/"/g,"")),l[e[0]]=e[1]);return-1!=(_=c.indexOf("viewBox="))?(u=c.substring(_+9),p='viewBox="'+u.substring(0,u.indexOf('"'))+'"'):p='viewBox="0 0 '+(l.width-n)+" "+(l.height-n)+'"',a=t/(l.height-n),l.height=t,l.width=Math.round(l.width*a),'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="'+l.width+'" height="'+l.height+'" xml:space="preserve" '+p+">"+s+"</svg>"},this.bind_help=function(e,t){function n(e){return e.help_path?void 0:void $p.msg.show_msg({title:"Справка",type:"alert-info",text:$p.msg.not_implemented})}e instanceof dhtmlXCellObject||(!e.help_path&&t&&(e.help_path=t),e.button("help").show(),e.button("help").enable(),e.attachEvent("onHelp",n))},this.set_hash=function(e,t,n,r){var a={},o=$p.job_prm.parse_url();1==arguments.length&&"object"==typeof e&&(a=e,a.hasOwnProperty("obj")&&(e=a.obj,delete a.obj),a.hasOwnProperty("ref")&&(t=a.ref,delete a.ref),a.hasOwnProperty("frm")&&(n=a.frm,delete a.frm),a.hasOwnProperty("view")&&(r=a.view,delete a.view)),void 0===e&&(e=o.obj||""),void 0===t&&(t=o.ref||""),void 0===n&&(n=o.frm||""),void 0===r&&(r=o.view||"");var s="obj="+e+"&ref="+t+"&frm="+n+"&view="+r;for(var i in a)s+="&"+i+"="+a[i];location.hash.substr(1)==s?this.hash_route():location.hash=s},this.hash_route=function(e){var t,n=$p.job_prm.parse_url(),r=$p.eve.hash_route.execute(n);return r===!1||$p.iface.before_route&&$p.iface.before_route(e)===!1||$p.ajax.authorized&&(n.ref&&"undefined"!=typeof _md?(t=_md.mgr_by_class_name(n.obj),t&&t[n.frm||"form_obj"]($p.iface.docs,n.ref)):n.view&&$p.iface.swith_view&&$p.iface.swith_view(n.view)),e?$p.cancel_bubble(e):void 0},this.oninit=null,this.ontimer=null,setTimeout(function(){$p.iface.ontimer&&"function"==typeof $p.iface.ontimer&&setInterval($p.iface.ontimer,9e4)},2e4)}function Modifiers(){var e=[];this.push=function(t){e.push(t)},this.detache=function(t){var n=e.indexOf(t);-1!=n&&e.splice(n,1)},this.execute=function(t){var n,r;return e.forEach(function(e){r="function"==typeof e?e(t):$p.injected_data[e](t),n!==!1&&(n=r)}),n}}function JobPrm(){function e(){return $p.wsql.get_user_param("rest_path")||$p.job_prm.rest_path||"/a/zd/%1/odata/standard.odata/"}this.parse_url=function(){function e(e){var t,n={},r=[];if(("#"===e.substr(0,1)||"?"===e.substr(0,1))&&(e=e.substr(1)),e.length>2){t=decodeURI(e).split("&");for(var a in t)if(r=t[a].split("="),"m"==r[0])try{n[r[0]]=JSON.parse(r[1])}catch(o){n[r[0]]={}}else n[r[0]]=r[1]||""}return n}return e(location.search)._mixin(e(location.hash))},this.check_dhtmlx=!0,this.offline=!1,this.local_storage_prefix="",this.create_tables=!0,"undefined"!=typeof window?this.url_prm=this.parse_url():this.url_prm={},"function"==typeof $p.settings&&$p.settings(this,$p.modifiers);for(var t in this)"url_prm"!==t&&"function"!=typeof this[t]&&this.url_prm.hasOwnProperty[t]&&(this[t]=this.url_prm[t]);this.hs_url=function(){var e=this.hs_path||"/a/zd/%1/hs/upzp",t=$p.wsql.get_user_param("zone","number");return t?e.replace("%1",t):e.replace("%1/","")},this.rest_url=function(){var t=e(),n=$p.wsql.get_user_param("zone","number");return n?t.replace("%1",n):t.replace("%1/","")},this.irest_url=function(){var t=e(),n=$p.wsql.get_user_param("zone","number");return t=t.replace("odata/standard.odata","hs/rest"),n?t.replace("%1",n):t.replace("%1/","")}}function WSQL(){function e(e,t){if("object"==t){try{e=JSON.parse(e)}catch(n){e={}}return e}return"number"==t?$p.fix_number(e,!0):"date"==t?$p.fix_date(e,!0):"boolean"==t?$p.fix_boolean(e):e}var t,n=this,r={};"undefined"==typeof localStorage?"undefined"==typeof WorkerGlobalScope&&"undefined"==typeof localStorage&&(t=new require("node-localstorage").LocalStorage("./localstorage")):t=localStorage,n.promise=function(e,t){return new Promise(function(r,a){n.alasql(e,t||[],function(e,t){t?a(t):r(e)})})},n.set_user_param=function(e,n){return new Promise(function(a,o){var s=n;"object"==typeof n?s=JSON.stringify(n):n===!1&&(s=""),t&&t.setItem($p.job_prm.local_storage_prefix+e,s),r[e]=n,a()})},n.get_user_param=function(n,a){return!r.hasOwnProperty(n)&&t&&(r[n]=e(t.getItem($p.job_prm.local_storage_prefix+n),a)),r[n]},n.save_options=function(e,t){return n.set_user_param(e+"_"+t.name,t)},n.restore_options=function(e,t){var r=n.get_user_param(e+"_"+t.name,"object");for(var a in r)if("object"!=typeof r[a])t[a]=r[a];else{t[a]||(t[a]={});for(var o in r[a])t[a][o]=r[a][o]}return t},n.init_params=function(e,r){n.alasql=e||alasql,n.aladb=new n.alasql.Database("md");var a,o=[{p:"user_name",v:"",t:"string"},{p:"user_pwd",v:"",t:"string"},{p:"browser_uid",v:$p.generate_guid(),t:"string"},{p:"zone",v:$p.job_prm.hasOwnProperty("zone")?$p.job_prm.zone:1,t:"number"},{p:"enable_save_pwd",v:"",t:"boolean"},{p:"reset_local_data",v:"",t:"boolean"},{p:"autologin",v:"",t:"boolean"},{p:"cache_cat_date",v:0,t:"number"},{p:"margin",v:60,t:"number"},{p:"discount",v:15,t:"number"},{p:"offline",v:$p.job_prm.offline||"",t:"boolean"},{p:"skin",v:"dhx_web",t:"string"},{p:"rest_path",v:"",t:"string"}];return $p.job_prm.additional_params&&(o=o.concat($p.job_prm.additional_params)),t.getItem($p.job_prm.local_storage_prefix+"zone")||(a=$p.job_prm.hasOwnProperty("zone")?$p.job_prm.zone:1),$p.job_prm.url_prm.hasOwnProperty("zone")&&(a=$p.fix_number($p.job_prm.url_prm.zone,!0)),void 0!==a&&n.set_user_param("zone",a),o.forEach(function(e){(void 0==n.get_user_param(e.p,e.t)||!n.get_user_param(e.p,e.t)&&-1!=e.p.indexOf("url"))&&n.set_user_param(e.p,$p.job_prm.hasOwnProperty(e.p)?$p.job_prm[e.p]:e.v)}),n.set_user_param("cache_cat_date",0),n.set_user_param("reset_local_data",""),new Promise(function(e,t){r?n.alasql(r,[],e):$p.job_prm.create_tables?$p.job_prm.create_tables_sql?n.alasql($p.job_prm.create_tables_sql,[],function(){delete $p.job_prm.create_tables_sql,e()}):$p.injected_data["create_tables.sql"]?n.alasql($p.injected_data["create_tables.sql"],[],function(){delete $p.injected_data["create_tables.sql"],e()}):"string"==typeof $p.job_prm.create_tables?$p.ajax.get($p.job_prm.create_tables).then(function(t){n.alasql(t.response,[],e)}):e():e()})},n.drop_tables=function(e){function t(){o--,0>=o?setTimeout(e,10):r()}function r(){var e=s[o-1].tableid;"_"==e.substr(0,1)?t():n.alasql("drop table IF EXISTS "+e,[],t)}function a(e){s=e,(o=e.length)?r():t()}var o=0,s=[];n.alasql("SHOW TABLES",[],a)},n.backup_database=function(e){},n.restore_database=function(){},n.idx_connect=function(e,t){return e||(e=n.idx_name||$p.job_prm.local_storage_prefix||"md"),new Promise(function(r,a){var o=indexedDB.open(e,1);o.onerror=function(e){a(e)},o.onsuccess=function(){r(o.result)},o.onupgradeneeded=function(r){return r.currentTarget.result.createObjectStore(t,{keyPath:"ref"}),n.idx_connect(e,t)}})},n.idx_save=function(e,t,r){return new Promise(function(a,o){function s(t){var n=t.transaction([r],"readwrite").objectStore(r).put(e instanceof DataObj?e._obj:e);n.onerror=function(e){o(e)},n.onsuccess=function(){a(n.result)}}!r&&e._manager&&(r=e._manager.table_name),t?s(t):n.idx_connect(null,r).then(s)})},n.idx_get=function(e,t,r){return new Promise(function(a,o){function s(t){var n=t.transaction([r],"readonly").objectStore(r).get(e);n.onerror=function(e){o(e)},n.onsuccess=function(){a(n.result)}}t?s(t):n.idx_connect(null,r).then(s)})},n.idx_delete=function(e,t,r){return new Promise(function(a,o){function s(t){var n=t.transaction([r],"readwrite").objectStore(r)["delete"](e instanceof DataObj?e.ref:e);n.onerror=function(e){o(e)},n.onsuccess=function(){a(n.result)}}!r&&e._manager&&(r=e._manager.table_name),t?s(t):n.idx_connect(null,r).then(s)})},n.idx_clear=function(e,t,r){return new Promise(function(a,o){function s(e){var t=e.transaction([r],"readwrite").objectStore(r).clear();t.onerror=function(e){o(e)},t.onsuccess=function(){a(t.result)}}!r&&e._manager&&(r=e._manager.table_name),t?s(t):n.idx_connect(null,r).then(s)})}}function _load(e){function t(){return a.cachable?$p.wsql.promise(a.get_sql_struct(e),[]).then($p.iface.data_to_tree):void 0}function n(){return a.cachable?$p.wsql.promise(a.get_sql_struct(e),[]).then(function(t){return $p.iface.data_to_grid.call(a,t,e)}):void 0}var r,a=_md.mgr_by_class_name(e.class_name);return"get_tree"==e.action&&(r=t())?r:"get_selection"==e.action&&(r=n())?r:$p.job_prm.offline?Promise.reject(Error($p.msg.offline_request)):(e.browser_uid=$p.wsql.get_user_param("browser_uid"),$p.ajax.post_ex($p.job_prm.hs_url(),JSON.stringify(e),!0).then(function(e){return e.response}))}function Meta(e,t){var n,r=e&&e.response?JSON.parse(e.response):e;_md=$p.md=this,t&&Meta._patch(r,t.response?JSON.parse(t.response):t),e=null,"undefined"!=typeof window&&(t=$p.injected_data["log.json"],Meta._patch(r,t),t=null),_md.get=function(e,t){var n=e.split("."),a={multiline_mode:!1,note:"",synonym:"",tooltip:"",type:{is_ref:!1,types:["string"]}};return t?("doc"==n[0]&&"number_doc"==t?(a.synonym="Номер",a.tooltip="Номер документа",a.type.str_len=11):"doc"==n[0]&&"date"==t?(a.synonym="Дата",a.tooltip="Дата документа",a.type.date_part="date_time",a.type.types[0]="date"):"doc"==n[0]&&"posted"==t?(a.synonym="Проведен",a.type.types[0]="boolean"):"cat"==n[0]&&"id"==t?a.synonym="Код":"cat"==n[0]&&"name"==t?a.synonym="Наименование":"deleted"==t?(a.synonym="Пометка удаления",a.type.types[0]="boolean"):"is_folder"==t?(a.synonym="Это группа",a.type.types[0]="boolean"):"lc_changed"==t?(a.synonym="Изменено в 1С",a.tooltip="Время записи в 1С",a.type.types[0]="number",a.type.digits=15,a.type.fraction_figits=0):"ref"==t?(a.synonym="Ссылка",a.type.is_ref=!0,a.type.types[0]=e):a=t?r[n[0]][n[1]].fields[t]:r[n[0]][n[1]],a):r[n[0]][n[1]]},_md.get_classes=function(){var e={};for(var t in r){e[t]=[];for(var n in r[t])e[t].push(n)}return e},_md.create_tables=function(e,t){function n(t){"number"==typeof t?(o--,0==o?e?setTimeout(function(){e(_)},10):alasql.utils.saveFile("create_tables.sql",_):r()):t&&t.hasOwnProperty("message")&&$p.iface&&$p.iface.docs&&($p.iface.docs.progressOff(),$p.msg.show_msg({title:$p.msg.error_critical,type:"alert-error",text:t.message}))}function r(){var e=s[o-1];_+=e["class"][e.name].get_sql_struct(t)+";\n",n(1)}var a,o=0,s=[],i=_md.get_classes(),_=t&&t.postgres?"":"USE md;\n";for(a in i.cat)s.push({"class":_cat,name:i.cat[a]});o=s.length;for(a in i.ireg)s.push({"class":_ireg,name:i.ireg[a]}),o++;for(a in i.doc)s.push({"class":_doc,name:i.doc[a]}),o++;for(a in i.enm)s.push({"class":_enm,name:i.enm[a]}),o++;for(a in i.cch)s.push({"class":_cch,name:i.cch[a]}),o++;for(a in i.cacc)s.push({"class":_cacc,name:i.cacc[a]}),o++;r()},_md.sql_type=function(e,t,n,r){var a;return a="type"==t&&"cch_properties"==e.table_name||"svg"==t&&"cat_production_params"==e.table_name?" JSON":n.is_ref||-1!=n.types.indexOf("guid")?r?n.types.every(function(e){return 0==e.indexOf("enm.")})?" character varying(100)":n.hasOwnProperty("str_len")?" character varying("+Math.max(36,n.str_len)+")":" uuid":" CHAR":n.hasOwnProperty("str_len")?r?n.str_len?" character varying("+n.str_len+")":" text":" CHAR":n.date_part?r&&"date"!=n.date_part?"date_time"==n.date_part?" timestamp with time zone":" time without time zone":" Date":n.hasOwnProperty("digits")?0==n.fraction_figits?r?n.digits<7?" integer":" bigint":" INT":r?" numeric("+n.digits+","+n.fraction_figits+")":" FLOAT":-1!=n.types.indexOf("boolean")?" BOOLEAN":-1!=n.types.indexOf("json")?" JSON":r?" character varying(255)":" CHAR"},_md.sql_composite=function(e,t,n,r){var a="";return e[t].type.types.length>1&&"type"!=t&&(n=n?n.substr(0,29)+"_T":t.substr(0,29)+"_T",a=r?', "'+n+'" character varying(255)':_md.sql_mask(n)+" CHAR"),a},_md.sql_mask=function(e,t){return", "+(t?"_t_.":"")+("`"+e+"`")},_md.mgr_by_class_name=function(e){if(e){var t=e.split(".");if(t[1]&&$p[t[0]])return $p[t[0]][t[1]]}},_md.value_mgr=function(e,t,n,r,a){function o(e){return e&&1==n.types.length&&(n._mgr=e),e}var s,i,_,c,u;if(n._mgr)return n._mgr;if(1==n.types.length){if(_=n.types[0].split("."),_.length>1&&$p[_[0]])return o($p[_[0]][_[1]])}else if(a&&a.type&&(_=a.type.split("."),_.length>1&&$p[_[0]]))return o($p[_[0]][_[1]]);if(s=e.property||e.param,"value"==t&&s){if(i=_cch.properties.get(s,!1),$p.is_data_obj(i)){if(i.is_new())return _cat.property_values;for(c in i.type.types)if(i.type.types[c].indexOf(".")>-1){_=i.type.types[c].split(".");break}return _&&_.length>1&&$p[_[0]]?o($p[_[0]][_[1]]):i.type}}else{if(c=[],n.types.forEach(function(e){_=e.split("."),_.length>1&&$p[_[0]][_[1]]&&c.push($p[_[0]][_[1]])}),1==c.length)return o(c[0]);if(r)return c;if((s=e[t])instanceof DataObj)return s._manager;if($p.is_guid(s)&&s!=$p.blank.guid)for(var p in c)if(u=c[p],u.get(s,!1,!0))return u}},_md.control_by_type=function(e){var t;return t=e.is_ref?-1==e.types.join().indexOf("enm.")?"ocombo":"refc":e.date_part?"dhxCalendar":e.digits?e.fraction_figits<5?"calck":"edn":"boolean"==e.types[0]?"ch":e.hasOwnProperty("str_len")&&(e.str_len>=100||0==e.str_len)?"txt":"ed"},_md.ts_captions=function(e,t,n){n||(n={});var r,a=_md.get(e).tabular_sections[t],o=_md.get(e).form,s=a.fields;if(o&&o.obj){if(!o.obj.tabular_sections[t])return;n._mixin(o.obj.tabular_sections[t])}else{"contact_information"===t&&(s={type:"",kind:"",presentation:""}),n.fields=["row"],n.headers="№",n.widths="40",n.min_widths="",n.aligns="",n.sortings="na",n.types="cntr";for(var i in s)r=a.fields[i],r.hide||(n.fields.push(i),n.headers+=","+(r.synonym?r.synonym.replace(/,/g," "):i),n.types+=","+_md.control_by_type(r.type),n.sortings+=",na")}return!0},_md.syns_js=function(e){var t={DeletionMark:"deleted",Description:"name",DataVersion:"data_version",IsFolder:"is_folder",Number:"number_doc",Date:"date","Дата":"date",Posted:"posted",Code:"id",Parent_Key:"parent",Owner_Key:"owner",Owner:"owner",Ref_Key:"ref","Ссылка":"ref",LineNumber:"row"};return t[e]?t[e]:r.syns_js[r.syns_1с.indexOf(e)]||e},_md.syns_1с=function(e){var t={deleted:"DeletionMark",name:"Description",data_version:"DataVersion",is_folder:"IsFolder",number_doc:"Number",date:"Date",posted:"Posted",id:"Code",ref:"Ref_Key",parent:"Parent_Key",owner:"Owner_Key",row:"LineNumber"};return t[e]?t[e]:r.syns_1с[r.syns_js.indexOf(e)]||e},_md.printing_plates=function(e){if(e)for(var t in e.doc)r.doc[t].printing_plates=e.doc[t]},_md.class_name_from_1c=function(e){var t=e.split(".");return 1==t.length?"enm."+e:("Перечисление"==t[0]?e="enm.":"Справочник"==t[0]?e="cat.":"Документ"==t[0]?e="doc.":"РегистрСведений"==t[0]?e="ireg.":"РегистрНакопления"==t[0]?e="areg.":"РегистрБухгалтерии"==t[0]?e="aссreg.":"ПланВидовХарактеристик"==t[0]?e="cch.":"ПланСчетов"==t[0]?e="cacc.":"Обработка"==t[0]?e="dp.":"Отчет"==t[0]&&(e="rep."),e+t[1])},_md.class_name_to_1c=function(e){var t=e.split(".");return 1==t.length?"Перечисление."+e:("enm"==t[0]?e="Перечисление.":"cat"==t[0]?e="Справочник.":"doc"==t[0]?e="Документ.":"ireg"==t[0]?e="РегистрСведений.":"areg"==t[0]?e="РегистрНакопления.":"aссreg"==t[0]?e="РегистрБухгалтерии.":"cch"==t[0]?e="ПланВидовХарактеристик.":"cacc"==t[0]?e="ПланСчетов.":"dp"==t[0]?e="Обработка.":"rep"==t[0]&&(e="Отчет."),e+t[1])},_md.dates=function(){return{md_date:r.md_date,cat_date:r.cat_date}};for(n in r.enm)_enm[n]=new EnumManager(r.enm[n],"enm."+n);for(n in r.cat)_cat[n]=new CatManager("cat."+n);for(n in r.doc)_doc[n]=new DocManager("doc."+n);for(n in r.ireg)"$log"==n?_ireg[n]=new LogManager("ireg."+n):_ireg[n]=new InfoRegManager("ireg."+n);for(n in r.dp)_dp[n]=new DataProcessorsManager("dp."+n);for(n in r.cch)_cch[n]=new ChartOfCharacteristicManager("cch."+n);for(n in r.cacc)_cacc[n]=new ChartOfAccountManager("cacc."+n);$p.modifiers.execute($p),$p.eve.callEvent("meta")}function DataManager(class_name){var _metadata=_md.get(class_name),_cachable,_async_write=_metadata.async_write,_events={after_create:[],after_load:[],before_save:[],after_save:[],value_change:[]};_cachable=-1!=class_name.indexOf("enm.")?!0:$p.job_prm.offline?!0:-1!=class_name.indexOf("doc.")||-1!=class_name.indexOf("dp.")||-1!=class_name.indexOf("rep.")?!1:!0,$p.job_prm.offline||void 0==_metadata.cachable||(_cachable="НеКешировать"!=_metadata.cachable),this.__define({cachable:{value:_cachable,writable:!0,enumerable:!1},async_write:{value:_async_write,writable:!1,enumerable:!1},class_name:{value:class_name,writable:!1,enumerable:!1},alatable:{get:function(){return $p.wsql.aladb.tables[this.table_name]?$p.wsql.aladb.tables[this.table_name].data:[]},enumerable:!1},metadata:{value:function(e){return e?_metadata.fields[e]||_metadata.tabular_sections[e]:_metadata},enumerable:!1},attache_event:{value:function(e,t,n){n?_events[e].push(t):_events[e].push(t)},enumerable:!1},handle_event:{value:function(e,t,n){var r,a=[];return _events[t].forEach(function(t){a!==!1&&(r=t.call(e,n),r===!1?a=r:r&&a.push(r))}),a.length?1==a.length?a[0]:a.some(function(e){return"object"==typeof e&&e.then})?Promise.all(a):a:void 0},enumerable:!1}});var _obj_сonstructor=this._obj_сonstructor||DataObj;if(!(this instanceof EnumManager)){var obj_сonstructor_name=class_name.split(".")[1];if(this._obj_сonstructor=eval("(function "+obj_сonstructor_name.charAt(0).toUpperCase()+obj_сonstructor_name.substr(1)+"(attr, manager){manager._obj_сonstructor.superclass.constructor.call(this, attr, manager)})"),this._obj_сonstructor._extend(_obj_сonstructor),this instanceof InfoRegManager){delete this._obj_сonstructor.prototype.deleted,delete this._obj_сonstructor.prototype.ref,delete this._obj_сonstructor.prototype.lc_changed;for(var f in this.metadata().dimensions)this._obj_сonstructor.prototype.__define(f,{get:new Function("return this._getter('"+f+"')"),set:new Function("v","this._setter('"+f+"',v)"),enumerable:!0});for(var f in this.metadata().resources)this._obj_сonstructor.prototype.__define(f,{get:new Function("return this._getter('"+f+"')"),set:new Function("v","this._setter('"+f+"',v)"),enumerable:!0})}else{this._ts_сonstructors={};for(var f in this.metadata().fields)this._obj_сonstructor.prototype.__define(f,{get:new Function("return this._getter('"+f+"')"),set:new Function("v","this._setter('"+f+"',v)"),enumerable:!0});for(var f in this.metadata().tabular_sections){var row_сonstructor_name=obj_сonstructor_name.charAt(0).toUpperCase()+obj_сonstructor_name.substr(1)+f.charAt(0).toUpperCase()+f.substr(1)+"Row";this._ts_сonstructors[f]=eval("(function "+row_сonstructor_name+"(owner) 			{owner._owner._manager._ts_сonstructors[owner._name].superclass.constructor.call(this, owner)})"),this._ts_сonstructors[f]._extend(TabularSectionRow);for(var rf in this.metadata().tabular_sections[f].fields)this._ts_сonstructors[f].prototype.__define(rf,{get:new Function("return this._getter('"+rf+"')"),set:new Function("v","this._setter('"+rf+"',v)"),enumerable:!0});this._obj_сonstructor.prototype.__define(f,{get:new Function("return this._getter_ts('"+f+"')"),set:new Function("v","this._setter_ts('"+f+"',v)"),enumerable:!0})}}}_obj_сonstructor=null}function RefDataManager(e){var t=this,n={};RefDataManager.superclass.constructor.call(t,e),t.push=function(e,t){t&&t!=e.ref?(delete n[e.ref],n[t]=e):n[e.ref]=e},t.all=function(){return n},t.each=function(e){for(var t in n)if(t&&t!=$p.blank.guid&&1==e.call(this,n[t]))break},t.get=function(e,r,a){var o=n[e]||n[e=$p.fix_guid(e)];if(!o){if(a&&!r)return;o=new t._obj_сonstructor(e,t,!0)}return r===!1?o:void 0===r&&e===$p.blank.guid?o:!t.cachable||o.is_new()?o.load():r?Promise.resolve(o):o},t.create=function(e,r){e&&"object"==typeof e||(e={}),e.ref&&$p.is_guid(e.ref)&&!$p.is_empty_guid(e.ref)||(e.ref=$p.generate_guid());var a=n[e.ref];if(!a){if(a=new t._obj_сonstructor(e,t),!t.cachable&&r){var o={};return $p.ajax.default_attr(o,$p.job_prm.irest_url()),o.url+=t.rest_name+"/Create()",$p.ajax.get_ex(o.url,o).then(function(e){return a._mixin(JSON.parse(e.response),void 0,["ref"])})}if(r){var s=a._obj;for(var i in t.metadata().fields)void 0==s[i]&&(s[i]="")}}return Promise.resolve(a)},t.delete_loc=function(e){var r;delete n[e];for(var a in t.alatable)if(t.alatable[a].ref==e){r=a;break}void 0!=r&&t.alatable.splice(r,1)},t.find=function(e){return $p._find(n,e)},t.find_rows=function(e,r){return $p._find_rows.call(t,n,e,r)},t.save=function(e){return e&&(e.specify||$p.is_guid(e.ref)&&!t.cachable)?_load({class_name:t.class_name,action:e.action||"save",attr:e}).then(JSON.parse):Promise.reject()},t.load_array=function(e,r){var a,o;for(var s in e)a=$p.fix_guid(e[s]),(o=n[a])?(o.is_new()||r)&&(o._mixin(e[s]),o._set_loaded()):(o=new t._obj_сonstructor(e[s],t),r&&o._set_loaded())},t.predefined=function(e){var n=t.metadata().predefined[e];if(n)return t.get(n.ref)},t.first_folder=function(e){for(var r in n){var a=n[r];if(a.is_folder&&(!e||$p.is_equal(e,a.owner)))return a}return t.get()}}function DataProcessorsManager(e){DataProcessorsManager.superclass.constructor.call(this,e),this.create=function(){return new this._obj_сonstructor({},this)}}function EnumManager(e,t){EnumManager.superclass.constructor.call(this,t),this._obj_сonstructor=EnumObj,this.push=function(e,t){this.__define(t,{value:e,enumerable:!1})},this.get=function(e){if(e instanceof EnumObj)return e;e&&e!=$p.blank.guid||(e="_");var t=this[e];return t||(t=new EnumObj({name:e},this)),t},this.each=function(e){this.alatable.forEach(function(t){t.ref&&t.ref!=$p.blank.guid&&e.call(this[t.ref])})};for(var n in e)new EnumObj(e[n],this)}function RegisterManager(e){var t={};this._obj_сonstructor=RegisterRow,RegisterManager.superclass.constructor.call(this,e),this.push=function(e,n){n&&n!=e.ref?(delete t[e.ref],t[n]=e):t[e.ref]=e},this.get=function(e,n,r){e||(e={}),e.action="select";var a,o=$p.wsql.alasql(this.get_sql_struct(e),e._values);if(delete e.action,delete e._values,o.length)if(r)a=t[this.get_ref(o[0])];else{a=[];for(var s in o)a.push(t[this.get_ref(o[s])])}return n?Promise.resolve(a):a},this.load_array=function(e){var n,r,a=[];for(var o in e)n=this.get_ref(e[o]),(r=t[n])?r._mixin(e[o]):new this._obj_сonstructor(e[o],this),a.push(t[n]);return a},this.find_rows=function(e,t){return $p._find_rows.call(this,this.alatable,e,t)}}function InfoRegManager(e){InfoRegManager.superclass.constructor.call(this,e)}function LogManager(){LogManager.superclass.constructor.call(this,"ireg.$log");var e;this.record=function(t){if(t instanceof Error){console&&console.log(t);var n=t;t={"class":"error",note:n.toString()}}"object"!=typeof t&&(t={note:t}),t.date=Date.now()+$p.eve.time_diff(),e||(e=alasql.compile("select MAX(`sequence`) as `sequence` from `ireg_$log` where `date` = ?"));var r=e([t.date]);r.length&&void 0!==r[0].sequence?t.sequence=r[0].sequence+1:t.sequence=0,t["class"]||(t["class"]="note"),$p.wsql.alasql("insert into `ireg_$log` (`date`, `sequence`, `class`, `note`, `obj`) values (?, ?, ?, ?, ?)",[t.date,t.sequence,t["class"],t.note,t.obj?JSON.stringify(t.obj):""])},this.backup=function(e,t){},this.restore=function(e,t){},this.clear=function(e,t){},this.show=function(e){},this.get_sql_struct=function(e){if(e&&"get_selection"==e.action){var t="select * from `ireg_$log`";return e.date_from?t+=e.date_till?" where `date` >= ? and `date` <= ?":" where `date` >= ?":e.date_till&&(t+=" where `date` <= ?"),t}return LogManager.superclass.get_sql_struct.call(this,e)},this.caption_flds=function(e){function t(e,t,n,r,a,o){this.id=e,this.width=t,this.type=n,this.align=r,this.sort=a,this.caption=o}var n='<column id="%1" width="%2" type="%3" align="%4" sort="%5">%6</column>',r=[],a=(this.metadata(),"");if(r.push(new t("date","140","ro","left","server","Дата")),r.push(new t("class","100","ro","left","server","Класс")),r.push(new t("note","*","ro","left","server","Событие")),e.get_header){a="<head>";for(var o in r)a+=n.replace("%1",r[o].id).replace("%2",r[o].width).replace("%3",r[o].type).replace("%4",r[o].align).replace("%5",r[o].sort).replace("%6",r[o].caption);a+="</head>"}return{head:a,acols:r}},this.data_to_grid=function(e,t){var n="<?xml version='1.0' encoding='UTF-8'?><rows total_count='%1' pos='%2' set_parent='%3'>".replace("%1",e.length).replace("%2",t.start).replace("%3",t.set_parent||""),r=this.caption_flds(t),a=$p.eve.time_diff();return n+=r.head,e.forEach(function(e){n+='<row id="'+e.date+"_"+e.sequence+'"><cell>'+$p.dateFormat(e.date-a,$p.dateFormat.masks.date_time)+(e.sequence?"."+e.sequence:"")+"</cell><cell>"+e["class"]+"</cell><cell>"+e.note+"</cell></row>"}),n+"</rows>"}}function AccumRegManager(e){AccumRegManager.superclass.constructor.call(this,e)}function CatManager(e){this._obj_сonstructor=CatObj,CatManager.superclass.constructor.call(this,e),this.metadata().hierarchical&&this.metadata().group_hierarchy&&this._obj_сonstructor.prototype.__define("is_folder",{get:function(){return this._obj.is_folder||!1},set:function(e){this._obj.is_folder=$p.fix_boolean(e)},enumerable:!0})}function ChartOfCharacteristicManager(e){this._obj_сonstructor=CatObj,ChartOfCharacteristicManager.superclass.constructor.call(this,e)}function ChartOfAccountManager(e){this._obj_сonstructor=CatObj,ChartOfAccountManager.superclass.constructor.call(this,e)}function DocManager(e){this._obj_сonstructor=DocObj,DocManager.superclass.constructor.call(this,e)}function TabularSection(e,t){t._obj[e]||(t._obj[e]=[]),this.__define("_name",{value:e,enumerable:!1}),this.__define("_owner",{value:t,enumerable:!1}),this.__define("_obj",{value:t._obj[e],writable:!1,enumerable:!1})}function TabularSectionRow(e){var t={};this.__define("_owner",{value:e,enumerable:!1}),this.__define("_obj",{value:t,writable:!1,enumerable:!1})}function DataObj(e,t){var n,r,a={},o={data_version:""},s=!(this instanceof EnumObj);return t instanceof DataProcessorsManager||t instanceof EnumManager||(r=t.get(e,!1,!0)),r?r:(t instanceof EnumManager?o.ref=n=e.name:t instanceof RegisterManager?n=t.get_ref(e):(o.ref=n=$p.fix_guid(e),o.deleted=!1,o.lc_changed=0),this.__define("_manager",{value:t,enumerable:!1}),this.__define("is_new",{value:function(){return s},enumerable:!1}),this.__define("_set_loaded",{value:function(e){s=!1,t.push(this,e)},enumerable:!1}),this.__define("_obj",{value:o,writable:!1,enumerable:!1}),this.__define("_ts_",{value:function(e){return a[e]||(a[e]=new TabularSection(e,this)),a[e]},enumerable:!1}),void(t.alatable&&t.push&&(t.alatable.push(o),t.push(this,n))))}function CatObj(e,t){var n="";CatObj.superclass.constructor.call(this,e,t),this.__define("presentation",{get:function(){return this.name||this.id?this.name||this.id||this._metadata.obj_presentation:n},set:function(e){e&&(n=String(e))},enumerable:!1}),e&&"object"==typeof e&&(e._not_set_loaded?(delete e._not_set_loaded,this._mixin(e)):(this._mixin(e),$p.is_empty_guid(this.ref)||!e.id&&!e.name||this._set_loaded(this.ref)))}function DocObj(e,t){var n="";DocObj.superclass.constructor.call(this,e,t),this.__define("presentation",{get:function(){return this.number_str||this.number_doc?this._metadata.obj_presentation+" №"+(this.number_str||this.number_doc)+" от "+$p.dateFormat(this.date,$p.dateFormat.masks.ru):n},set:function(e){e&&(n=String(e))},enumerable:!1}),e&&"object"==typeof e&&this._mixin(e),!$p.is_empty_guid(this.ref)&&e.number_doc&&this._set_loaded(this.ref)}function DataProcessorObj(e,t){DataProcessorObj.superclass.constructor.call(this,e,t);var n,r=t.metadata();for(n in r.fields)e[n]=$p.fetch_type("",r.fields[n].type);for(n in r.tabular_sections)e[n]=[];this._mixin(e),this.unload=function(){for(n in this)this[n]instanceof TabularSection?(this[n].clear(),delete this[n]):"function"!=typeof this[n]&&delete this[n]}}function EnumObj(e,t){EnumObj.superclass.constructor.call(this,e,t),e&&"object"==typeof e&&this._mixin(e)}function RegisterRow(e,t){RegisterRow.superclass.constructor.call(this,e,t),e&&"object"==typeof e&&this._mixin(e)}function Rest(){this.filter_date=function(e,t,n){t||(t=new Date("2015-01-01"));var r=e+" gt datetime'"+$p.dateFormat(t,$p.dateFormat.masks.isoDateTime)+"'";return n&&(r+=" and "+e+" lt datetime'"+$p.dateFormat(n,$p.dateFormat.masks.isoDateTime)+"'"),r},this.to_data=function(e,t){var n,r,a,o,s,i,_={},c=t.metadata().fields,u=t.metadata().tabular_sections;t instanceof RefDataManager?(e.hasOwnProperty("DeletionMark")&&(_.deleted=e.DeletionMark),e.hasOwnProperty("DataVersion")&&(_.data_version=e.DataVersion),e.hasOwnProperty("Ref_Key")&&(_.ref=e.Ref_Key)):c=[]._mixin(t.metadata().dimensions)._mixin(t.metadata().resources),t instanceof DocManager?(e.hasOwnProperty("Number")?_.number_doc=e.Number||e.number_doc:e.hasOwnProperty("number_doc")&&(_.number_doc=e.number_doc),e.hasOwnProperty("Date")?_.date=e.Date:e.hasOwnProperty("date")&&(_.date=e.date),e.hasOwnProperty("Posted")?_.posted=e.Posted:e.hasOwnProperty("posted")&&(_.posted=e.posted)):(t.metadata().main_presentation_name&&(e.hasOwnProperty("Description")?_.name=e.Description:e.hasOwnProperty("name")&&(_.name=e.name)),t.metadata().code_length&&(e.hasOwnProperty("Code")?_.id=e.Code:e.hasOwnProperty("id")&&(_.id=e.id)));for(r in c)if(e.hasOwnProperty(r))_[r]=e[r];else{if(s=_md.syns_1с(r),-1==s.indexOf("_Key")&&c[r].type.is_ref&&e[s+"_Key"]&&(s+="_Key"),!e.hasOwnProperty(s))continue;_[r]=e[s]}for(n in u)i="extra_fields"==n||e.hasOwnProperty(n)?n:_md.syns_1с(n),e.hasOwnProperty(i)&&(_[n]=[],e[i]&&(e[i].sort(function(e,t){return(e.LineNumber||e.row)>(t.LineNumber||t.row)}),e[i].forEach(function(e){o={};for(a in u[n].fields)s=e.hasOwnProperty(a)||"extra_fields"==n&&("property"==a||"value"==a)?a:_md.syns_1с(a),-1==s.indexOf("_Key")&&u[n].fields[a].type.is_ref&&e[s+"_Key"]&&(s+="_Key"),o[a]=e[s];_[n].push(o)})));return _},this.ajax_to_data=function(e,t){return $p.ajax.get_ex(e.url,e).then(function(e){return JSON.parse(e.response)}).then(function(e){var n=[];return e.value.forEach(function(e){n.push(_rest.to_data(e,t));
}),n})},this.build_select=function(e,t){function n(e,r){"function"==typeof r?o+=r(t,e):(s=_md.syns_1с(e),i=_md.get(t.class_name,e),i&&(i=i.type,i.is_ref&&-1==s.indexOf("_Key")&&i.types.length&&-1==i.types[0].indexOf("enm.")&&(s+="_Key"),i.types.length&&(-1!=["boolean","number"].indexOf(typeof r)?o+=s+" eq "+r:i.is_ref&&"object"!=typeof r||r instanceof DataObj?o+=s+" eq guid'"+r+"'":"string"==typeof r?o+=s+" eq '"+r+"'":"object"==typeof r&&(r.hasOwnProperty("like")?o+=s+" like '%"+r.like+"%'":r.hasOwnProperty("not")?o+=" not ("+n(e,r.not)+") ":r.hasOwnProperty("in")&&(o+=s+" in ("+(i.is_ref?r["in"].map(function(e){return"guid'"+e+"'"}).join(","):r["in"].join(","))+") ")))))}function r(e){for(var t in e)if(o?o+=" and ":o="&$filter=","or"==t&&Array.isArray(e[t])){var r=!0;e[t].forEach(function(e){r?(o+=" ( ",r=!1):o+=" or ";var t=Object.keys(e)[0];n(t,e[t])}),o+=" ) "}else n(t,e[t])}var a,o,s,i,_="";e||(e={}),e.fields&&(e.fields.forEach(function(e){"ref"==e?s="Ref_Key":(s=_md.syns_1с(e),i=_md.get(t.class_name,e).type,i.is_ref&&-1==s.indexOf("_Key")&&i.types.length&&-1==i.types[0].indexOf("enm.")&&(s+="_Key")),a?a+=",":a="&$select=",a+=s}),_+=a),e.selection&&("function"==typeof e.selection||(Array.isArray(e.selection)?e.selection.forEach(r):r(e.selection)),o&&(_+=o)),$p.job_prm.rest&&-1==t.rest_name.indexOf("Module_")&&-1==t.rest_name.indexOf("DataProcessor_")&&-1==t.rest_name.indexOf("Report_")&&-1==_.indexOf(" like ")&&-1==_.indexOf(" in ")&&!t.metadata().irest?$p.ajax.default_attr(e,$p.job_prm.rest_url()):$p.ajax.default_attr(e,$p.job_prm.irest_url()),e.url+=t.rest_name+"?allowedOnly=true&$format=json&$top="+(e.top||300)+_},this.load_array=function(e,t){return _rest.build_select(e,t),_rest.ajax_to_data(e,t)},this.load_obj=function(e){var t={};return $p.ajax.default_attr(t,!e._metadata.irest&&$p.job_prm.rest?$p.job_prm.rest_url():$p.job_prm.irest_url()),t.url+=e._manager.rest_name+"(guid'"+e.ref+"')?$format=json",$p.ajax.get_ex(t.url,t).then(function(e){return JSON.parse(e.response)}).then(function(t){return e._mixin(_rest.to_data(t,e._manager))._set_loaded(),e})["catch"](function(t){return 404==t.status?e:void $p.record_log(t)})},this.save_irest=function(e,t){var n=JSON.stringify(e),r=(void 0!=t.post?",post="+t.post:"")+(void 0!=t.operational?",operational="+t.operational:"");return $p.ajax.default_attr(t,$p.job_prm.irest_url()),t.url+=e._manager.rest_name+"(guid'"+e.ref+"'"+r+")",$p.ajax.post_ex(t.url,n,t).then(function(e){return JSON.parse(e.response)}).then(function(t){return e._mixin(t)})},this.save_rest=function(e,t){var n,r=e.to_atom();return $p.ajax.default_attr(t,$p.job_prm.rest_url()),n=t.url+e._manager.rest_name,t.url=n+"(guid'"+e.ref+"')?$format=json&$select=Ref_Key,DeletionMark",$p.ajax.get_ex(t.url,t)["catch"](function(e){return 404==e.status?{response:JSON.stringify({is_new:!0})}:Promise.reject(e)}).then(function(e){return JSON.parse(e.response)}).then(function(a){return a.is_new?$p.ajax.post_ex(n,r,t):$p.ajax.patch_ex(n+"(guid'"+e.ref+"')",r,t)}).then(function(t){var n=xmlToJSON.parseString(t.response,{mergeCDATA:!1,grokAttr:!0,grokText:!1,normalize:!0,xmlns:!1,namespaceKey:"_ns",textKey:"_text",valueKey:"_value",attrKey:"_attr",cdataKey:"_cdata",attrsAsObject:!1,stripAttrPrefix:!0,stripElemPrefix:!0,childrenAsArray:!1});if(n.entry&&n.entry.content&&n.entry.updated){var r,a=n.entry.content.properties,o={};o.lc_changed=new Date(n.entry.updated._text);for(var s in a)if(0!=s.indexOf("_"))if(r=a[s].element)if(o[s]=[],Array.isArray(r))for(var i in r){o[s][i]={};for(var _ in r[i])0!=_.indexOf("_")&&(o[s][i][_]="false"===r[i][_]._text?!1:r[i][_]._text)}else{o[s][0]={};for(var _ in r)0!=_.indexOf("_")&&(o[s][0][_]="false"===r[_]._text?!1:r[_]._text)}else o[s]="false"===a[s]._text?!1:a[s]._text;return _rest.to_data(o,e._manager)}}).then(function(t){return e._mixin(t)})}}function SocketMsg(){function e(e){if(e&&"react"==e.type)try{var t=_md?_md.mgr_by_class_name(e.class_name):null;t&&t.load_array([e.obj],!0)}catch(n){$p.record_log(n)}}var t,n,r,a=0,o=this;o.connect=function(e){if(t||(t=$p.job_prm.parse_url().socket_uid||""),e&&(a=0),a++,$p.job_prm.ws_url&&(!n||!r))try{n=new WebSocket($p.job_prm.ws_url),n.onopen=function(){r=!0,n.send(JSON.stringify({socket_uid:t,zone:$p.wsql.get_user_param("zone"),browser_uid:$p.wsql.get_user_param("browser_uid"),_side:"js",_mirror:!0}))},n.onclose=function(){r=!1,setTimeout(o.connect,3>a?3e4:6e5)},n.onmessage=function(e){var t;try{t=JSON.parse(e.data)}catch(n){t=e.data}$p.eve.callEvent("socket_msg",[t])},n.onerror=$p.record_log}catch(s){setTimeout(o.connect,3>a?3e4:6e5),$p.record_log(s)}},o.send=function(e){n&&r&&(e?"object"!=typeof e&&(e={data:e}):e={},e.socket_uid=t,e._side="js",n.send(JSON.stringify(e)))},$p.eve.attachEvent("socket_msg",e)}var $p=new MetaEngine;"undefined"!=typeof window&&($p.load_script=function(e,t,n){var r=document.createElement(t);"script"==t?(r.type="text/javascript",r.src=e,n?(r.async=!0,r.addEventListener("load",n,!1)):r.async=!1):(r.type="text/css",r.rel="stylesheet",r.href=e),document.head.appendChild(r)}),Object.defineProperty(Object.prototype,"__define",{value:function(e,t){return t?Object.defineProperty(this,e,t):Object.defineProperties(this,e),this},enumerable:!1}),Object.prototype.__define({_extend:{value:function(e){var t=function(){};t.prototype=e.prototype,this.prototype=new t,this.prototype.constructor=this,this.__define("superclass",{value:e.prototype,enumerable:!1})},enumerable:!1},_mixin:{value:function(e,t,n){var r,a,o={};if(t&&t.length)for(r=0;r<t.length;r++)a=t[r],n&&-1!=n.indexOf(a)||("undefined"==typeof o[a]||o[a]!=e[a])&&(this[a]=e[a]);else for(a in e)n&&-1!=n.indexOf(a)||("undefined"==typeof o[a]||o[a]!=e[a])&&(this[a]=e[a]);return this},enumerable:!1},_clone:{value:function(){if(!this||"object"!=typeof this)return this;var e,t,n="function"==typeof this.pop?[]:{};for(e in this)this.hasOwnProperty(e)&&(t=this[e],t?"function"==typeof t||t instanceof DataObj||t instanceof DataManager?n[e]=t:"object"==typeof t?n[e]=t._clone():n[e]=t:n[e]=t);return n},enumerable:!1}}),Object.observe||Object.unobserve||Object.getNotifier||Object.prototype.__define({observe:{value:function(e,t){e._observers||e.__define({_observers:{value:[],enumerable:!1},_notis:{value:[],enumerable:!1}}),e._observers.push(t)},enumerable:!1},unobserve:{value:function(e,t){if(e._observers)for(var n in e._observers)if(e._observers[n]===t){e._observers.splice(n,1);break}},enumerable:!1},getNotifier:{value:function(e){var t;return{notify:function(n){e._observers&&(e._notis.push(n),t||(t=!0,setTimeout(function(){e._observers.forEach(function(t){t(e._notis)}),e._notis.length=0,t=!1},10)))}}},enumerable:!1}}),/**
 * Date Format 1.2.3
 * (c) 2007-2009 Steven Levithan <stevenlevithan.com>
 * MIT license
 *
 * Includes enhancements by Scott Trenda <scott.trenda.net>
 * and Kris Kowal <cixar.com/~kris.kowal/>
 *
 * Accepts a date, a mask, or a date and a mask.
 * Returns a formatted version of the given date.
 * The date defaults to the current date/time.
 * The mask defaults to dateFormat.masks.default.
 * @method dateFormat
 * @for MetaEngine
 * @param date {Date} - источник
 * @param mask {dateFormat.masks} - маска формата
 * @param utc {Boolean} Converts the date from local time to UTC/GMT
 * @return {String}
 */
$p.dateFormat=function(){var e=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,t=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,n=/[^-+\dA-Z]/g,r=function(e,t){for(e=String(e),t=t||2;e.length<t;)e="0"+e;return e};return function(a,o,s){var i=$p.dateFormat;o||(o=$p.dateFormat.masks.ru),1!=arguments.length||"[object String]"!=Object.prototype.toString.call(a)||/\d/.test(a)||(o=a,a=void 0),a=a?new Date(a):new Date,isNaN(a)&&(a=new Date(0)),o=String(i.masks[o]||o||i.masks["default"]),"UTC:"==o.slice(0,4)&&(o=o.slice(4),s=!0);var _=s?"getUTC":"get",c=a[_+"Date"](),u=a[_+"Day"](),p=a[_+"Month"](),l=a[_+"FullYear"](),f=a[_+"Hours"](),d=a[_+"Minutes"](),m=a[_+"Seconds"](),h=a[_+"Milliseconds"](),g=s?0:a.getTimezoneOffset(),b={d:c,dd:r(c),ddd:i.i18n.dayNames[u],dddd:i.i18n.dayNames[u+7],m:p+1,mm:r(p+1),mmm:i.i18n.monthNames[p],mmmm:i.i18n.monthNames[p+12],yy:String(l).slice(2),yyyy:l,h:f%12||12,hh:r(f%12||12),H:f,HH:r(f),M:d,MM:r(d),s:m,ss:r(m),l:r(h,3),L:r(h>99?Math.round(h/10):h),t:12>f?"a":"p",tt:12>f?"am":"pm",T:12>f?"A":"P",TT:12>f?"AM":"PM",Z:s?"UTC":(String(a).match(t)||[""]).pop().replace(n,""),o:(g>0?"-":"+")+r(100*Math.floor(Math.abs(g)/60)+Math.abs(g)%60,4),S:["th","st","nd","rd"][c%10>3?0:(c%100-c%10!=10)*c%10]};return o.replace(e,function(e){return e in b?b[e]:e.slice(1,e.length-1)})}}(),$p.dateFormat.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'",atom:"yyyy-mm-dd'T'HH:MM:ss'Z'",ru:"dd.mm.yyyy HH:MM",short_ru:"dd.mm.yyyy",date:"dd.mm.yy",date_time:"dd.mm.yy HH:MM"},$p.ajax=new function(){function e(e,t,n,r,a){return new Promise(function(o,s){if("undefined"==typeof window&&r&&r.request)r.request({url:encodeURI(t),headers:{Authorization:r.auth}},function(e,t,n){e?s(e):200!=t.statusCode?s({message:t.statusMessage,description:n,status:t.statusCode}):o({response:n})});else{var i=new XMLHttpRequest;if(window.dhx4&&window.dhx4.isIE&&(t=encodeURI(t)),r){var _,c;"object"==typeof r&&r.username&&r.hasOwnProperty("password")?(_=r.username,c=r.password):$p.ajax.username&&$p.ajax.authorized?(_=$p.ajax.username,c=$p.ajax.password):(_=$p.wsql.get_user_param("user_name"),c=$p.wsql.get_user_param("user_pwd"),!_&&$p.job_prm&&$p.job_prm.guest_name&&(_=$p.job_prm.guest_name,c=$p.job_prm.guest_pwd)),i.open(e,t,!0,_,c),i.withCredentials=!0,i.setRequestHeader("Authorization","Basic "+btoa(unescape(encodeURIComponent(_+":"+c))))}else i.open(e,t,!0);a&&a.call(this,i),"GET"!=e?this.hide_headers||r.hide_headers||(i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.setRequestHeader("X-Requested-With","XMLHttpRequest")):n=null,i.onload=function(){200==i.status&&(i.response instanceof Blob||"<!DOCTYPE"!==i.response.substr(0,9))?(void 0==i.responseURL&&(i.responseURL=t),o(i)):s(i.response?{message:i.statusText,description:i.response,status:i.status}:Error(i.statusText))},i.onerror=function(){s(Error("Network Error"))},i.send(n)}})}this.username="",this.password="",this.authorized=!1,this.get=function(t){return e.call(this,"GET",t)},this.post=function(t,n){return 1==arguments.length?n="":2==arguments.length&&"function"==typeof n?(onLoad=n,n=""):n=String(n),e.call(this,"POST",t,n)},this.get_ex=function(t,n,r){return e.call(this,"GET",t,null,n,r)},this.post_ex=function(t,n,r,a){return e.call(this,"POST",t,n,r,a)},this.put_ex=function(t,n,r,a){return e.call(this,"PUT",t,n,r,a)},this.patch_ex=function(t,n,r,a){return e.call(this,"PATCH",t,n,r,a)},this.delete_ex=function(t,n,r){return e.call(this,"DELETE",t,null,n,r)},this.get_and_show_blob=function(e,t,n){function r(t){return e=window.URL.createObjectURL(t.response),a=window.open(e,"wnd_print",o),a.onload=function(t){window.URL.revokeObjectURL(e)},a}var a,o="menubar=no,toolbar=no,location=no,status=no,directories=no,resizable=yes,scrollbars=yes";return!n||"string"==typeof n&&-1!=n.toLowerCase().indexOf("post")?this.post_ex(e,"object"==typeof t?JSON.stringify(t):t,!0,function(e){e.responseType="blob"}).then(r):this.get_ex(e,!0,function(e){e.responseType="blob"}).then(r)},this.get_and_save_blob=function(e,t,n){return this.post_ex(e,"object"==typeof t?JSON.stringify(t):t,!0,function(e){e.responseType="blob"}).then(function(e){saveAs(e.response,n)})},this.default_attr=function(e,t){e.url||(e.url=t),e.username||(e.username=this.username),e.password||(e.password=this.password),e.hide_headers=!0,$p.job_prm["1c"]&&(e.auth=$p.job_prm["1c"].auth,e.request=$p.job_prm["1c"].request)}},$p.m={point_pos:function(e,t,n,r,a,o){return Math.abs(n-a)<.2?(e-n)*(r-o):Math.abs(r-o)<.2?(t-r)*(a-n):(t-r)*(a-n)-(o-r)*(e-n)},arc_cntr:function(e,t,n,r,a,o){var s,i,_,c,u,p,l,f,d;if(o){var m=e,h=t;e=n,t=r,n=m,r=h}return e!=n?(s=(e*e-n*n-r*r+t*t)/(2*(e-n)),i=(r-t)/(e-n),_=i*i+1,c=-2*((e-s)*i+t),u=(e-s)*(e-s)-a*a+t*t,p=(-c+Math.sqrt(c*c-4*_*u))/(2*_),l=s+i*p,f=(-c-Math.sqrt(c*c-4*_*u))/(2*_),d=s+i*f):(s=(t*t-r*r-n*n+e*e)/(2*(t-r)),i=(n-e)/(t-r),_=i*i+1,c=-2*((t-s)*i+e),u=(t-s)*(t-s)-a*a+e*e,l=(-c-Math.sqrt(c*c-4*_*u))/(2*_),p=s+i*l,d=(-c+Math.sqrt(c*c-4*_*u))/(2*_),f=s+i*d),$p.m.point_pos(l,p,e,t,n,r)>0?{x:l,y:p}:{x:d,y:f}},arc_point:function(e,t,n,r,a,o,s){var i={x:(e+n)/2,y:(t+r)/2};if(a>0){var _,c,u,p=e-n,l=t-r,f=a*a-(p*p+l*l)/4;f>=0&&(u=$p.m.arc_cntr(e,t,n,r,a,o),p=u.x-i.x,l=i.y-u.y,_=Math.sqrt(p*p+l*l),c=s?a+Math.sqrt(f):a-Math.sqrt(f),i.x+=p*c/_,i.y+=l*c/_)}return i}},$p.blank=new function(){this.date=new Date("0001-01-01"),this.guid="00000000-0000-0000-0000-000000000000",this.by_type=function(e){var t;return t=e.is_ref?$p.blank.guid:e.date_part?$p.blank.date:e.digits?0:e.types&&"boolean"==e.types[0]?!1:""}},$p.is_guid=function(e){return"string"!=typeof e||e.length<36?!1:(e.length>36&&(e=e.substr(0,36)),/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(e))},$p.is_empty_guid=function(e){return!e||e===$p.blank.guid},$p.generate_guid=function(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:7&n|8).toString(16)})},$p.fix_guid=function(e,t){if(e&&"string"==typeof e);else{if(e instanceof DataObj)return e.ref;if(e&&"object"==typeof e)if(e.presentation){if(e.ref)return e.ref;if(e.name)return e.name}else e="object"==typeof e.ref&&e.ref.hasOwnProperty("ref")?e.ref.ref:e.ref}return $p.is_guid(e)||t===!1?e:t?$p.generate_guid():$p.blank.guid},$p.fix_number=function(e,t){var n=parseFloat(e);return isNaN(n)?t?0:e:n},$p.fix_boolean=function(e){return"string"==typeof e?!(!e||"false"==e.toLowerCase()):!!e},$p.fix_date=function(e,t){var n=/(^\d{1,4}[\.|\\/|-]\d{1,2}[\.|\\/|-]\d{1,4})(\s*(?:0?[1-9]:[0-5]|1(?=[012])\d:[0-5])\d\s*[ap]m)?$/;if(e instanceof Date)return e;if(e&&"string"==typeof e&&n.test(e.substr(0,10))){var r,a,o=e.split(" "),s=o[0].split(".");if(1==s.length&&(s=o[0].split("/"),1==s.length&&(s=o[0].split("-"))),3==s.length&&4==s[2].length){a=s[2]+"-"+s[1]+"-"+s[0];for(var i=1;i<o.length;i++)a+=" "+o[i];r=new Date(a)}else r=new Date(e);if(r&&r.getFullYear()>0)return r}return t?$p.blank.date:e},$p.date_add_day=function(e,t){var n=new Date;return n.setDate(e.getDate()+t),n},$p.cancel_bubble=function(e){var t=e||event;return t&&t.stopPropagation&&t.stopPropagation(),t&&!t.cancelBubble&&(t.cancelBubble=!0),!1},$p.msg=new Messages,$p.iface=new InterfaceObjs,$p.Modifiers=Modifiers,$p.eve="undefined"!=typeof window&&window.dhx4?dhx4:{},$p.eve.__define({onload:{value:new Modifiers,enumerable:!1,configurable:!1},hash_route:{value:new Modifiers,enumerable:!1,configurable:!1}}),$p.__define("modifiers",{value:new Modifiers,enumerable:!1,configurable:!1}),$p.JobPrm=JobPrm,$p.wsql=new WSQL;var msg=$p.msg;$p.dateFormat.i18n={dayNames:["Вс","Пн","Вт","Ср","Чт","Пт","Сб","Воскресенье","Понедельник","Вторник","Среда","Четверг","Пятница","Суббота"],monthNames:["Янв","Фев","Maр","Aпр","Maй","Июн","Июл","Aвг","Сен","Окт","Ноя","Дек","Январь","Февраль","Март","Апрель","Maй","Июнь","Июль","Август","Сентябрь","Oктябрь","Ноябрь","Декабрь"]},"undefined"!=typeof window&&window.dhx4&&(dhx4.dateFormat.ru="%d.%m.%Y",dhx4.dateLang="ru",dhx4.dateStrings={ru:{monthFullName:["Январь","Февраль","Март","Апрель","Maй","Июнь","Июль","Август","Сентябрь","Oктябрь","Ноябрь","Декабрь"],monthShortName:["Янв","Фев","Maр","Aпр","Maй","Июн","Июл","Aвг","Сен","Окт","Ноя","Дек"],dayFullName:["Воскресенье","Понедельник","Вторник","Среда","Четверг","Пятница","Суббота"],dayShortName:["Вс","Пн","Вт","Ср","Чт","Пт","Сб"]}}),$p.msg.russian_names=function(){$p.job_prm.russian_names&&(window.__define({"Метаданные":{get:function(){return _md},enumerable:!1},"Справочники":{get:function(){return _cat},enumerable:!1},"Документы":{get:function(){return _doc},enumerable:!1},"РегистрыСведений":{get:function(){return _ireg},enumerable:!1},"РегистрыНакопления":{get:function(){return _areg},enumerable:!1},"РегистрыБухгалтерии":{get:function(){return _aссreg},enumerable:!1},"Обработки":{get:function(){return _dp},enumerable:!1},"Отчеты":{get:function(){return _rep},enumerable:!1},"ОбластьКонтента":{get:function(){return $p.iface.docs},enumerable:!1},"Сообщить":{get:function(){return $p.msg.show_msg},enumerable:!1},"Истина":{value:!0,enumerable:!1},"Ложь":{value:!1,enumerable:!1}}),DataManager.prototype.__define({"ФормаВыбора":{get:function(){return this.form_selection},enumerable:!1},"ФормаОбъекта":{get:function(){return this.form_obj},enumerable:!1},"Найти":{get:function(){return this.find},enumerable:!1},"НайтиСтроки":{get:function(){return this.find_rows},enumerable:!1},"НайтиПоНаименованию":{get:function(){return this.by_name},enumerable:!1}}),DataObj.prototype.__define({"ФормаОбъекта":{get:function(){return this.form_obj},enumerable:!1}}))},$p.fias=function(){},function(e){e.toString=function(){return"Коды адресного классификатора"},e.types=["владение","здание","помещение"],e[1010]={name:"дом",type:1,order:1,fid:2,syn:[" д."," д "," дом"]},e[1020]={name:"владение",type:1,order:2,fid:1,syn:[" вл."," вл "," влад."," влад "," владен."," владен "," владение"]},e[1030]={name:"домовладение",type:1,order:3,fid:3},e[1050]={name:"корпус",type:2,order:1,syn:[" к."," к "," корп."," корп ","корпус"]},e[1060]={name:"строение",type:2,order:2,fid:1,syn:[" стр."," стр "," строен."," строен ","строение"]},e[1080]={name:"литера",type:2,order:3,fid:3,syn:[" л."," л "," лит."," лит ","литера"]},e[1070]={name:"сооружение",type:2,order:4,fid:2,syn:[" соор."," соор "," сооруж."," сооруж ","сооружение"]},e[1040]={name:"участок",type:2,order:5,syn:[" уч."," уч ","участок"]},e[2010]={name:"квартира",type:3,order:1,syn:["кв.","кв ","кварт.","кварт ","квартира","-"]},e[2030]={name:"офис",type:3,order:2,syn:["оф.","оф ","офис","-"]},e[2040]={name:"бокс",type:3,order:3},e[2020]={name:"помещение",type:3,order:4},e[2050]={name:"комната",type:3,order:5,syn:["комн.","комн ","комната"]},e[101e5]={name:"Почтовый индекс"},e[102e5]={name:"Адресная точка"},e[103e5]={name:"Садовое товарищество"},e[104e5]={name:"Элемент улично-дорожной сети, планировочной структуры дополнительного адресного элемента"},e[105e5]={name:"Промышленная зона"},e[106e5]={name:"Гаражно-строительный кооператив"},e[107e5]={name:"Территория"}}($p.fias),msg.store_url_od="https://chrome.google.com/webstore/detail/hcncallbdlondnoadgjomnhifopfaage",msg.align_node_right="Уравнять вертикально вправо",msg.align_node_bottom="Уравнять горизонтально вниз",msg.align_node_top="Уравнять горизонтально вверх",msg.align_node_left="Уравнять вертикально влево",msg.align_set_right="Установить размер сдвигом вправо",msg.align_set_bottom="Установить размер сдвигом вниз",msg.align_set_top="Установить размер сдвигом вверх",msg.align_set_left="Установить размер сдвигом влево",msg.align_invalid_direction="Неприменимо для элемента с данной ориентацией",msg.argument_is_not_ref="Аргумент не является ссылкой",msg.addr_title="Ввод адреса",msg.cache_update_title="Обновление кеша браузера",msg.cache_update="Выполняется загрузка измененных файлов<br/>и их кеширование в хранилище браузера",msg.delivery_area_empty="Укажите район доставки",msg.empty_login_password="Не указаны имя пользователя или пароль",msg.empty_response="Пустой ответ сервера",msg.empty_geocoding="Пустой ответ геокодера. Вероятно, отслеживание адреса запрещено в настройках браузера",msg.error_auth="Авторизация пользователя не выполнена",msg.error_critical="Критическая ошибка",msg.error_metadata="Ошибка загрузки метаданных конфигурации",msg.error_network="Ошибка сети или сервера - запрос отклонен",msg.error_rights="Ограничение доступа",msg.file_size="Запрещена загрузка файлов<br/>размером более ",msg.file_confirm_delete="Подтвердите удаление файла ",msg.file_new_date="Файлы на сервере обновлены<br /> Рекомендуется закрыть браузер и войти<br />повторно для применения обновления",msg.file_new_date_title="Версия файлов",msg.init_catalogues="Загрузка справочников с сервера",msg.init_catalogues_meta=": Метаданные объектов",msg.init_catalogues_tables=": Реструктуризация таблиц",msg.init_catalogues_nom=": Базовые типы + номенклатура",msg.init_catalogues_sys=": Технологические справочники",msg.init_login="Укажите имя пользователя и пароль",msg.requery="Повторите попытку через 1-2 минуты",msg.limit_query="Превышено число обращений к серверу<br/>Запросов за минуту:%1<br/>Лимит запросов:%2<br/>"+msg.requery,msg.long_operation="Длительная операция",msg.main_title="Окнософт: заказ дилера ",msg.meta_cat="Справочники",msg.meta_doc="Документы",msg.meta_cch="Планы видов характеристик",msg.meta_cacc="Планы счетов",msg.meta_ireg="Регистры сведений",msg.meta_areg="Регистры накопления",msg.meta_mgr="Менеджер",msg.meta_cat_mgr="Менеджер справочников",msg.meta_doc_mgr="Менеджер документов",msg.meta_enn_mgr="Менеджер перечислений",msg.meta_ireg_mgr="Менеджер регистров сведений",msg.meta_areg_mgr="Менеджер регистров накопления",msg.meta_accreg_mgr="Менеджер регистров бухгалтерии",msg.meta_dp_mgr="Менеджер обработок",msg.meta_reports_mgr="Менеджер отчетов",msg.meta_charts_of_accounts_mgr="Менеджер планов счетов",msg.meta_charts_of_characteristic_mgr="Менеджер планов видов характеристик",msg.meta_extender="Модификаторы объектов и менеджеров",msg.no_metadata="Не найдены метаданные объекта '%1'",msg.no_selected_row="Не выбрана строка табличной части '%1'",msg.no_dhtmlx="Библиотека dhtmlx не загружена",msg.not_implemented="Не реализовано в текущей версии",msg.offline_request="Запрос к серверу в автономном режиме",msg.onbeforeunload="Окнософт: легкий клиент. Закрыть программу?",msg.order_sent_title="Подтвердите отправку заказа",msg.order_sent_message="Отправленный заказ нельзя изменить.<br/>После проверки менеджером<br/>он будет запущен в работу",msg.request_title="Окнософт: Запрос регистрации",msg.request_message="Заявка зарегистрирована. После обработки менеджером будет сформировано ответное письмо",msg.select_from_list="Выбор из списка",msg.select_grp="Укажите группу, а не элемент",msg.select_elm="Укажите элемент, а не группу",msg.select_file_import="Укажите файл для импорта",msg.srv_overload="Сервер перегружен",msg.sub_row_change_disabled="Текущая строка подчинена продукции.<br/>Строку нельзя изменить-удалить в документе<br/>только через построитель",msg.sync_script="Обновление скриптов приложения:",msg.sync_data="Синхронизация с сервером выполняется:<br />* при первом старте программы<br /> * при обновлении метаданных<br /> * при изменении цен или технологических справочников",msg.sync_break="Прервать синхронизацию",msg.sync_no_data="Файл не содержит подходящих элементов для загрузки",msg.unsupported_browser_title="Браузер не поддерживается",msg.unsupported_browser="Несовместимая версия браузера<br/>Рекомендуется Google Chrome",msg.supported_browsers="Рекомендуется Chrome, Safari или Opera",msg.unsupported_mode_title="Режим не поддерживается",msg.unsupported_mode="Программа не установлена<br/> в <a href='"+msg.store_url_od+"'>приложениях Google Chrome</a>",msg.unknown_error="Неизвестная ошибка в функции '%1'",msg.value="Значение",msg.bld_constructor="Конструктор объектов графического построителя",msg.bld_title="Графический построитель",msg.bld_empty_param="Не заполнен обязательный параметр <br />",msg.bld_not_product="В текущей строке нет изделия построителя",msg.bld_not_draw="Отсутствует эскиз или не указана система профилей",msg.bld_wnd_title="Построитель изделия № ",msg.bld_from_blocks_title="Выбор типового блока",msg.bld_from_blocks="Текущее изделие будет заменено конфигурацией типового блока. Продолжить?",msg.bld_split_imp="В параметрах продукции<br />'%1'<br />запрещены незамкнутые контуры<br />Для включения деления импостом,<br />установите это свойство в 'Истина'",$p.is_data_obj=function(e){return e&&e instanceof DataObj},$p.fetch_type=function(e,t){var n=e;return t.is_ref?n=$p.fix_guid(e):t.date_part?n=$p.fix_date(e,!0):t.digits?n=$p.fix_number(e,!0):"boolean"==t.types[0]&&(n=$p.fix_boolean(e)),n},$p.is_equal=function(e,t){return e==t?!0:typeof e==typeof t?!1:$p.fix_guid(e,!1)==$p.fix_guid(t,!1)},$p._find=function(e,t){var n,r,a;if("object"!=typeof t)for(r in e){n=e[r];for(var o in n)if("function"!=typeof n[o]&&$p.is_equal(n[o],t))return n}else for(r in e){n=e[r],a=!0;for(var o in t)if("function"!=typeof n[o]&&!$p.is_equal(n[o],t[o])){a=!1;break}if(a)return n}},$p._find_rows=function(e,t,n){var r,a,o,s,i,_=[],c=0;t&&(t._top?(i=t._top,delete t._top):i=300);for(o in e){if(a=e[o],r=!0,t)if("function"==typeof t)r=t(a);else for(s in t)if("_"!=s.substr(0,1))if("function"==typeof t[s]){if(r=t[s](a,s),!r)break}else if("or"==s&&Array.isArray(t[s])){if(r=t[s].some(function(e){var t=Object.keys(e)[0];return e[t].hasOwnProperty("like")?-1!=a[t].toLowerCase().indexOf(e[t].like.toLowerCase()):$p.is_equal(a[t],e[t])}),!r)break}else if(t[s].hasOwnProperty("like")){if(-1==a[s].toLowerCase().indexOf(t[s].like.toLowerCase())){r=!1;break}}else if(t[s].hasOwnProperty("not")){if($p.is_equal(a[s],t[s].not)){r=!1;break}}else if(t[s].hasOwnProperty("in")){if(r=t[s]["in"].some(function(e){return $p.is_equal(e,a[s])}),!r)break}else if(!$p.is_equal(a[s],t[s])){r=!1;break}if(r){if(n){if(n.call(this,a)===!1)break}else _.push(a);if(i&&(c++,c>=i))break}}return _};var _cat=$p.cat=new function(){this.toString=function(){return $p.msg.meta_cat_mgr}},_enm=$p.enm=new function(){this.toString=function(){return $p.msg.meta_enn_mgr}},_doc=$p.doc=new function(){this.toString=function(){return $p.msg.meta_doc_mgr}},_ireg=$p.ireg=new function(){this.toString=function(){return $p.msg.meta_ireg_mgr}},_areg=$p.areg=new function(){this.toString=function(){return $p.msg.meta_areg_mgr}},_aссreg=$p.aссreg=new function(){this.toString=function(){return $p.msg.meta_accreg_mgr}},_dp=$p.dp=new function(){this.toString=function(){return $p.msg.meta_dp_mgr}},_rep=$p.rep=new function(){this.toString=function(){return $p.msg.meta_reports_mgr}},_cacc=$p.cacc=new function(){this.toString=function(){return $p.msg.meta_charts_of_accounts_mgr}},_cch=$p.cch=new function(){this.toString=function(){return $p.msg.meta_charts_of_characteristic_mgr}},_md;$p.Meta=Meta,Meta._patch=function(e,t){for(var n in t)"object"==typeof t[n]&&e[n]?Meta._patch(e[n],t[n]):e[n]=t[n]},Meta.init_meta=function(e){return new Promise(function(t,n){function r(e){var r,a,o=[$p.ajax.get($p.job_prm.data_url+"meta.json?v="+$p.job_prm.files_date),$p.ajax.get($p.job_prm.data_url+"meta_patch.json?v="+$p.job_prm.files_date)];$p.eve.reduce_promices(o,function(e){e instanceof XMLHttpRequest&&200==e.status?-1!=e.responseURL.indexOf("meta.json")?r=JSON.parse(e.response):-1!=e.responseURL.indexOf("meta_patch.json")&&(a=JSON.parse(e.response)):$p.record_log(e)}).then(function(){r?(r.ref="meta",$p.wsql.idx_save(r,e,"meta").then(function(){a.ref="meta_patch",$p.wsql.idx_save(a,e,"meta")}).then(function(){t(new Meta(r,a))})):n(new Error("Ошибка чтения файла метаданных"))})}$p.injected_data["meta.json"]?t(new Meta($p.injected_data["meta.json"],$p.injected_data["meta_patch.json"])):$p.injected_data["meta_patch.json"]?t(new Meta($p.injected_data["meta_patch.json"])):$p.wsql.idx_connect(null,"meta").then(function(n){var a;$p.wsql.idx_get("meta",n,"meta").then(function(o){o&&!e?(a=o,$p.wsql.idx_get("meta_patch",n,"meta").then(function(e){t(new Meta(a,e))})):$p.job_prm.files_date?r(n):$p.eve.update_files_version().then(function(){r(n)})})})})},Meta.init_static=function(e){return new Promise(function(e,t){$p.wsql.idx_connect(null,"static").then(function(e){$p.wsql.idx_get("p0",e,"static").then(function(e){})})})},$p.record_log=function(e){$p.ireg&&$p.ireg.$log?$p.ireg.$log.record(e):console.log(e)},_cat.load_soap_to_grid=function(e,t,n){function r(e){"{"==e.substr(0,1)&&(e=JSON.parse(e)),"string"==typeof e?t.parse(e,function(){n&&n(e)},"xml"):n&&n(e)}t.xmlFileUrl="exec";var a=_md.mgr_by_class_name(e.class_name);!a.cachable&&($p.job_prm.rest||$p.job_prm.irest_enabled||e.rest)?a.rest_selection(e).then(r)["catch"]($p.record_log):_load(e).then(r)["catch"]($p.record_log)},DataManager.prototype.__define("family_name",{get:function(){return $p.msg["meta_"+this.class_name.split(".")[0]+"_mgr"].replace($p.msg.meta_mgr+" ","")},enumerable:!1}),DataManager.prototype.register_ex=function(){},DataManager.prototype.sync_grid=function(e,t){var n;this.cachable||($p.job_prm.rest||$p.job_prm.irest_enabled||t.rest)&&("get_tree"==t.action?n=this.rest_tree():"get_selection"==t.action&&(n=this.rest_selection()))},DataManager.prototype.get_option_list=function(e,t){function n(t){return $p.is_equal(t.value,e)&&(t.selected=!0),t}var r,a,o,s=this,i=[];if(t.presentation&&(r=s.metadata().input_by_string)&&(a=t.presentation.like,delete t.presentation,t.or=[],r.forEach(function(e){o={},o[e]={like:a},t.or.push(o)})),s.cachable||t&&t._local)return s.find_rows(t,function(e){i.push(n({text:e.presentation,value:e.ref}))}),Promise.resolve(i);var _={selection:t,top:t._top};return delete t._top,s instanceof DocManager?_.fields=["ref","date","number_doc"]:s.metadata().main_presentation_name?_.fields=["ref","name"]:_.fields=["ref","id"],_rest.load_array(_,s).then(function(e){return e.forEach(function(e){i.push(n({text:s instanceof DocManager?e.number_doc+" от "+$p.dateFormat(e.date,$p.dateFormat.masks.ru):e.name||e.id,value:e.ref}))}),i})},DataManager.prototype.tabular_captions=function(e,t){},DataManager.prototype.get_property_grid_xml=function(e,t,n){var r,a,o,s,i,_,c,u=this,p="<rows>",l=function(){if(!e)if(o=u.metadata(),o.form&&o.form.obj&&o.form.obj.head)e=o.form.obj.head;else{if(e={" ":[]},t instanceof CatObj?(o.code_length&&e[" "].push("id"),o.main_presentation_name&&e[" "].push("name")):t instanceof DocObj&&(e[" "].push("number_doc"),e[" "].push("date")),!t.is_folder)for(r in o.fields)o.fields[r].hide||e[" "].push(r);o.tabular_sections.extra_fields&&(e["Дополнительные реквизиты"]=[])}},f=function(e,t){_=$p.is_data_obj(e)?e.presentation:e,t.type.is_ref||(t.type.date_part?_=$p.dateFormat(_,""):"boolean"==t.type.types[0]&&(_=_?"1":"0"))},d=function(e){i=_md.control_by_type(o.type),f(e,o)},m=function(e,r){if(r){var a=e.property||e.param||e["Параметр"],l=void 0!=e.value?e.value:e["Значение"];a.empty()?(c=r+"|empty",i="ro",_="",o={synonym:"?"}):(o={synonym:a.presentation,type:a.type},c=r+"|"+a.ref,d(l),"edn"==i&&(i="calck"),a.mandatory&&(i+='" class="cell_mandatory'))}else if("object"==typeof e)o={synonym:e.synonym},c=e.id,i=e.type,_="",e.hasOwnProperty("txt")?_=e.txt:void 0!==(s=t[c])&&f(s,_md.get(u.class_name,c));else if(n&&n.meta&&void 0!==(o=n.meta[e]))c=e,d(s=t[e]);else{if(void 0===(s=t[e]))return;o=_md.get(u.class_name,c=e),d(s)}p+='<row id="'+c+'"><cell>'+(o.synonym||o.name)+'</cell><cell type="'+i+'">'+_+"</cell></row>"};l();for(r in e){" "!=r&&(p+='<row open="1"><cell>'+r+"</cell>");for(a in e[r])m(e[r][a]);if(n&&r==n.title&&t[n.ts]){t[n.ts].find_rows(n.selection,function(e){m(e,n.ts)})}" "!=r&&(p+="</row>")}return p+="</rows>"},DataManager.prototype.__define("table_name",{get:function(){return this.class_name.replace(".","_")},enumerable:!1}),DataManager.prototype.print=function(e,t,n){function r(e){n&&n.progressOff&&n.progressOff(),e&&e.focus()}n&&n.progressOn&&n.progressOn();var a={};$p.ajax.default_attr(a,$p.job_prm.irest_url()),a.url+=this.rest_name+"(guid'"+$p.fix_guid(e)+"')/Print(model="+t+", browser_uid="+$p.wsql.get_user_param("browser_uid")+")",$p.ajax.get_and_show_blob(a.url,a,"get").then(r)["catch"]($p.record_log),setTimeout(r,3e3)},DataManager.prototype.printing_plates=function(){var e={},t=this;return $p.job_prm.offline?Promise.resolve({}):(t.metadata().printing_plates&&(t._printing_plates=t.metadata().printing_plates),t._printing_plates?Promise.resolve(t._printing_plates):($p.ajax.default_attr(e,$p.job_prm.irest_url()),e.url+=t.rest_name+"/Print()",$p.ajax.get_ex(e.url,e).then(function(e){return t.__define("_printing_plates",{value:JSON.parse(e.response),enumerable:!1}),t._printing_plates})["catch"](function(){}).then(function(e){return e||(t._printing_plates={})})))},RefDataManager._extend(DataManager),RefDataManager.prototype.get_sql_struct=function(e){function t(){function t(){var e=[],t="_t_.ref, _t_.`deleted`";return i.form&&i.form.selection?i.form.selection.fields.forEach(function(t){e.push(t)}):s instanceof DocManager?(e.push("posted"),e.push("date"),e.push("number_doc")):(i.hierarchical&&i.group_hierarchy?e.push("is_folder"):e.push("0 as is_folder"),s instanceof ChartOfAccountManager?(e.push("id"),e.push("name as presentation")):i.main_presentation_name?e.push("name as presentation"):i.code_length?e.push("id as presentation"):e.push("'...' as presentation"),i.has_owners&&e.push("owner"),i.code_length&&e.push("id")),e.forEach(function(e){t+=-1!=e.indexOf(" as ")?", "+e:_md.sql_mask(e,!0)}),t}function n(){var e,t="";if(i.form&&i.form.selection)for(var n in i.form.selection.fields)-1!=i.form.selection.fields[n].indexOf(" as ")&&-1==i.form.selection.fields[n].indexOf("_t_.")&&(e=i.form.selection.fields[n].split(" as "),e[0]=e[0].split("."),e[0].length>1&&(t&&(t+="\n"),t+="left outer join "+e[0][0]+" on "+e[0][0]+".ref = _t_."+e[1]));return t}function r(){var t;return t=s instanceof ChartOfAccountManager?" WHERE ("+(l?0:1):i.hierarchical?i.has_owners?" WHERE ("+(c||l?1:0)+" OR _t_.parent = '"+u+"') AND ("+(_==$p.blank.guid?1:0)+" OR _t_.owner = '"+_+"') AND ("+(l?0:1):" WHERE ("+(c||l?1:0)+" OR _t_.parent = '"+u+"') AND ("+(l?0:1):i.has_owners?" WHERE ("+(_==$p.blank.guid?1:0)+" OR _t_.owner = '"+_+"') AND ("+(l?0:1):" WHERE ("+(l?0:1),s.sql_selection_where_flds?t+=s.sql_selection_where_flds(l):s instanceof DocManager?t+=" OR _t_.number_doc LIKE '"+l+"'":((i.main_presentation_name||s instanceof ChartOfAccountManager)&&(t+=" OR _t_.name LIKE '"+l+"'"),i.code_length&&(t+=" OR _t_.id LIKE '"+l+"'")),t+=") AND (_t_.ref != '"+$p.blank.guid+"')",e.selection&&("function"==typeof e.selection||e.selection.forEach(function(e){for(var n in e)"function"==typeof e[n]?t+="\n AND "+e[n](s,n)+" ":i.fields.hasOwnProperty(n)?t+=e[n]===!0?"\n AND _t_."+n+" ":e[n]===!1?"\n AND (not _t_."+n+") ":"string"==typeof e[n]||"object"==typeof e[n]?"\n AND (_t_."+n+" = '"+e[n]+"') ":"\n AND (_t_."+n+" = "+e[n]+") ":"is_folder"==n&&i.hierarchical&&i.group_hierarchy})),t}function a(){return s instanceof ChartOfAccountManager?"ORDER BY id":i.hierarchical?i.group_hierarchy?"ORDER BY _t_.is_folder desc, is_initial_value, presentation":"ORDER BY _t_.parent desc, is_initial_value, presentation":"ORDER BY is_initial_value, presentation"}function o(){function t(t){t?(f=e.set_parent=t.parent.ref,u=f,c=!1):(l||c)&&"cat.base_blocks"==s.class_name&&(_==$p.blank.guid&&(_=_cat.bases.predefined("main")),u=s.first_folder(_).ref),l&&-1==l.indexOf("%")&&(l="%"+l+"%")}i.has_owners&&(_=e.owner,e.selection&&"function"!=typeof e.selection&&e.selection.forEach(function(e){e.owner&&(_="object"==typeof e.owner?e.owner.valueOf():e.owner,delete e.owner)}),_||(_=$p.blank.guid)),p!=$p.blank.guid&&c&&i.hierarchical?t(s.get(p,!1)):t()}var _,c=!e.parent,u=e.parent||$p.blank.guid,p=e.initial_value||$p.blank.guid,l=e.filter||"",f=$p.blank.guid;o();var d;return d=s.sql_selection_list_flds?s.sql_selection_list_flds(p):("SELECT %2, case when _t_.ref = '"+p+"' then 0 else 1 end as is_initial_value FROM `"+s.table_name+"` AS _t_ %j %3 %4 LIMIT 300").replace("%2",t()).replace("%j",n()),d.replace("%3",r()).replace("%4",a())}function n(){var t="CREATE TABLE IF NOT EXISTS ";if(e&&e.postgres){t+=s.table_name+" (ref uuid PRIMARY KEY NOT NULL, deleted boolean, lc_changed bigint",s instanceof DocManager?t+=", posted boolean, date timestamp with time zone, number_doc character(11)":(i.code_length&&(t+=", id character("+i.code_length+")"),t+=", name character varying(50), is_folder boolean");for(a in i.fields)a.length>30?i.fields[a].short_name?o=i.fields[a].short_name:(c++,o=a[0]+c+a.substr(a.length-27)):o=a,t+=", "+o+_md.sql_type(s,a,i.fields[a].type,!0)+_md.sql_composite(i.fields,a,o,!0);for(a in i.tabular_sections)t+=", ts_"+a+" JSON"}else{t+="`"+s.table_name+"` (ref CHAR PRIMARY KEY NOT NULL, `deleted` BOOLEAN, lc_changed INT",t+=s instanceof DocManager?", posted boolean, date Date, number_doc CHAR":", id CHAR, name CHAR, is_folder BOOLEAN";for(a in i.fields)t+=_md.sql_mask(a)+_md.sql_type(s,a,i.fields[a].type)+_md.sql_composite(i.fields,a);for(a in i.tabular_sections)t+=", `ts_"+a+"` JSON"}return t+=")"}function r(){var e=["ref","deleted","lc_changed"],t="INSERT INTO `"+s.table_name+"` (ref, `deleted`, lc_changed",n="(?";"cat"==s.class_name.substr(0,3)?(t+=", id, name, is_folder",e.push("id"),e.push("name"),e.push("is_folder")):"doc"==s.class_name.substr(0,3)&&(t+=", posted, date, number_doc",e.push("posted"),e.push("date"),e.push("number_doc"));for(a in i.fields)t+=_md.sql_mask(a),e.push(a);for(a in i.tabular_sections)t+=", `ts_"+a+"`",e.push("ts_"+a);for(t+=") VALUES ",a=1;a<e.length;a++)n+=", ?";return n+=")",t+=n,{sql:t,fields:e,values:n}}var a,o,s=this,i=s.metadata(),_={},c=0,u=e&&e.action?e.action:"create_table";return"create_table"==u?_=n():-1!=["insert","update","replace"].indexOf(u)?_[s.table_name]=r():"select"==u?_="SELECT * FROM `"+s.table_name+"` WHERE ref = ?":"select_all"==u?_="SELECT * FROM `"+s.table_name+"`":"delete"==u?_="DELETE FROM `"+s.table_name+"` WHERE ref = ?":"drop"==u?_="DROP TABLE IF EXISTS `"+s.table_name+"`":"get_tree"==u?_=!e.filter||e.filter.is_folder?"SELECT ref, parent, name as presentation FROM `"+s.table_name+"` WHERE is_folder order by parent, name":"SELECT ref, parent, name as presentation FROM `"+s.table_name+"` order by parent, name":"get_selection"==u&&(_=t()),_},RefDataManager.prototype.caption_flds=function(e){function t(e,t,n,r,a,o){this.id=e,this.width=t,this.type=n,this.align=r,this.sort=a,this.caption=o}var n='<column id="%1" width="%2" type="%3" align="%4" sort="%5">%6</column>',r=[],a=this.metadata(),o="";if(a.form&&a.form.selection?r=a.form.selection.cols:this instanceof DocManager?(r.push(new t("date","120","ro","left","server","Дата")),r.push(new t("number_doc","120","ro","left","server","Номер"))):this instanceof ChartOfAccountManager?(r.push(new t("id","120","ro","left","server","Код")),r.push(new t("presentation","*","ro","left","server","Наименование"))):r.push(new t("presentation","*","ro","left","server","Наименование")),e.get_header&&r.length){o="<head>";for(var s in r)o+=n.replace("%1",r[s].id).replace("%2",r[s].width).replace("%3",r[s].type).replace("%4",r[s].align).replace("%5",r[s].sort).replace("%6",r[s].caption);o+="</head>"}return{head:o,acols:r}},RefDataManager.prototype.load_cached_server_array=function(e,t){var n,r=[],a=this,o=t?{class_name:a.class_name,rest_name:t}:a,s=!t;if(e.forEach(function(e){n=a.get(e.ref||e,!1,!0),(!n||s&&n.is_new())&&r.push(e.ref||e)}),r.length){var i={url:"",selection:{ref:{"in":r}}};return s&&(i.fields=["ref"]),$p.rest.build_select(i,o),$p.ajax.get_ex(i.url,i).then(function(t){
var n=JSON.parse(t.response);if(s)n=n.value;else{n=n.data;for(var r in n)!n[r].ref&&n[r].id&&(n[r].ref=n[r].id),n[r].Код&&(n[r].id=n[r].Код,delete n[r].Код),n[r]._not_set_loaded=!0}return a.load_array(n),e})}return Promise.resolve(e)},DataProcessorsManager._extend(DataManager),EnumManager._extend(RefDataManager),EnumManager.prototype.get_sql_struct=function(e){var t="CREATE TABLE IF NOT EXISTS ",n=e&&e.action?e.action:"create_table";return e&&e.postgres?"create_table"==n?t+=this.table_name+" (ref character varying(255) PRIMARY KEY NOT NULL, sequence INT, synonym character varying(255))":-1!=["insert","update","replace"].indexOf(n)?(t={},t[this.table_name]={sql:"INSERT INTO "+this.table_name+" (ref, sequence, synonym) VALUES ($1, $2, $3)",fields:["ref","sequence","synonym"],values:"($1, $2, $3)"}):"delete"==n&&(t="DELETE FROM "+this.table_name+" WHERE ref = $1"):"create_table"==n?t+="`"+this.table_name+"` (ref CHAR PRIMARY KEY NOT NULL, sequence INT, synonym CHAR)":-1!=["insert","update","replace"].indexOf(n)?(t={},t[this.table_name]={sql:"INSERT INTO `"+this.table_name+"` (ref, sequence, synonym) VALUES (?, ?, ?)",fields:["ref","sequence","synonym"],values:"(?, ?, ?)"}):"delete"==n&&(t="DELETE FROM `"+this.table_name+"` WHERE ref = ?"),t},EnumManager.prototype.get_option_list=function(e,t){function n(t){return $p.is_equal(t.value,e)&&(t.selected=!0),t}var r=[],a="";if(t)for(var o in t)"_"!=o.substr(0,1)&&(a=t[o]);return"object"==typeof a&&(a=a.like?a.like:""),a=a.toLowerCase(),this.alatable.forEach(function(e){(!a||e.synonym&&-1!=e.synonym.toLowerCase().indexOf(a))&&r.push(n({text:e.synonym||"",value:e.ref}))}),Promise.resolve(r)},RegisterManager._extend(DataManager),RegisterManager.prototype.get_sql_struct=function(e){function t(){var t="CREATE TABLE IF NOT EXISTS ",n=!0;if(e&&e.postgres){t+=o.table_name+" (",s.splitted&&(t+="zone integer",n=!1);for(a in s.dimensions)n?(t+=a,n=!1):t+=", "+a,t+=_md.sql_type(o,a,s.dimensions[a].type,!0)+_md.sql_composite(s.dimensions,a,"",!0);for(a in s.resources)t+=", "+a+_md.sql_type(o,a,s.resources[a].type,!0)+_md.sql_composite(s.resources,a,"",!0);t+=", PRIMARY KEY (",n=!0,s.splitted&&(t+="zone",n=!1);for(a in s.dimensions)n?(t+=a,n=!1):t+=", "+a}else{t+="`"+o.table_name+"` (";for(a in s.dimensions)n?(t+="`"+a+"`",n=!1):t+=_md.sql_mask(a),t+=_md.sql_type(o,a,s.dimensions[a].type)+_md.sql_composite(s.dimensions,a);for(a in s.resources)t+=_md.sql_mask(a)+_md.sql_type(o,a,s.resources[a].type)+_md.sql_composite(s.resources,a);t+=", PRIMARY KEY (",n=!0;for(a in s.dimensions)n?(t+="`"+a+"`",n=!1):t+=_md.sql_mask(a)}return t+="))"}function n(){var e="INSERT OR REPLACE INTO `"+o.table_name+"` (",t=[],n=!0;for(a in s.dimensions)n?(e+=a,n=!1):e+=", "+a,t.push(a);for(a in s.resources)e+=", "+a,t.push(a);for(e+=") VALUES (?",a=1;a<t.length;a++)e+=", ?";return e+=")",{sql:e,fields:t}}function r(){var t="SELECT * FROM `"+o.table_name+"` WHERE ",n=!0;e._values=[];for(var r in s.dimensions)n?n=!1:t+=" and ",t+="`"+r+"`=?",e._values.push(e[r]);return n&&(t+="1"),t}var a,o=this,s=o.metadata(),i={},_=e&&e.action?e.action:"create_table";return"create_table"==_?i=t():_ in{insert:"",update:"",replace:""}?i[o.table_name]=n():"select"==_?i=r():"select_all"==_?i=r():"delete"==_?i="DELETE FROM `"+o.table_name+"` WHERE ref = ?":"drop"==_&&(i="DROP TABLE IF EXISTS `"+o.table_name+"`"),i},RegisterManager.prototype.get_ref=function(e){var t="",n=this.metadata().dimensions;e instanceof RegisterRow&&(e=e._obj);for(var r in n)t+=t?"_":"",t+=n[r].type.is_ref?$p.fix_guid(e[r]):!e[r]&&n[r].type.digits?"0":n[r].date_part?$p.dateFormat(e[r]||$p.blank.date,$p.dateFormat.masks.atom):void 0!=e[r]?String(e[r]):"$";return t},InfoRegManager._extend(RegisterManager),InfoRegManager.prototype.slice_first=function(e){},InfoRegManager.prototype.slice_last=function(e){},LogManager._extend(InfoRegManager),AccumRegManager._extend(RegisterManager),CatManager._extend(RefDataManager),CatManager.prototype.by_name=function(e){var t;return this.find_rows({name:e},function(e){return t=e,!1}),t||(t=this.get()),t},CatManager.prototype.by_id=function(e){var t;return this.find_rows({id:e},function(e){return t=e,!1}),t||(t=this.get()),t},CatManager.prototype.path=function(e){var t,n=[];if(t=e instanceof DataObj?e:this.get(e,!1,!0),t&&n.push({ref:t.ref,presentation:t.presentation}),t&&this.metadata().hierarchical)for(;;){if(t=t.parent,t.empty())break;n.push({ref:t.ref,presentation:t.presentation})}return n},ChartOfCharacteristicManager._extend(CatManager),ChartOfAccountManager._extend(CatManager),DocManager._extend(RefDataManager),TabularSection.prototype.toString=function(){return"Табличная часть "+this._owner._manager.class_name+"."+this._name},TabularSection.prototype.get=function(e){return this._obj[e]._row},TabularSection.prototype.count=function(){return this._obj.length},TabularSection.prototype.clear=function(e){for(var t in this._obj)delete this._obj[t];this._obj.length=0,e||Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name})},TabularSection.prototype.del=function(e){var t,n=this._obj,r=0;if("undefined"!=typeof e){if("number"==typeof e)t=e;else if(n[e.row-1]._row===e)t=e.row-1;else for(var a in n)if(n[a]._row===e){t=Number(a),delete n[a]._row;break}if(void 0!=t){n.splice(t,1);for(var a in n)r++,n[a].row=r;Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name})}}},TabularSection.prototype.find=function(e){var t=$p._find(this._obj,e);return t?t._row:void 0},TabularSection.prototype.find_rows=function(e,t){var n=this,r=t?function(e){return t.call(n,e._row)}:null;return $p._find_rows.call(n,n._obj,e,r)},TabularSection.prototype.swap=function(e,t){var n=this._obj[e];this._obj[e]=this._obj[t],this._obj[t]=n,Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name})},TabularSection.prototype.add=function(e,t){var n=new this._owner._manager._ts_сonstructors[this._name](this);e||(e={});for(var r in n._metadata.fields)n[r]=e[r]||"";return n._obj.row=this._obj.push(n._obj),n._obj.__define("_row",{value:n,enumerable:!1}),t||Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name}),e=null,n},TabularSection.prototype.each=function(e){var t=this;t._obj.forEach(function(n){return e.call(t,n._row)})},TabularSection.prototype.load=function(e){var t,n=this;n.clear(!0),e instanceof TabularSection?t=e._obj:Array.isArray(e)&&(t=e),t&&t.forEach(function(e){n.add(e,!0)}),Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name})},TabularSection.prototype.sync_grid=function(e,t){for(var n={rows:[]},r=[],a=0;a<e.getColumnCount();a++)r.push(e.getColumnId(a));e.clearAll(),this.find_rows(t,function(e){var t=[];r.forEach(function(n){$p.is_data_obj(e[n])?t.push(e[n].presentation):t.push(e[n])}),n.rows.push({id:e.row,data:t})});try{e.parse(n,"json")}catch(o){}e.callEvent("onGridReconstructed",[])},TabularSection.prototype.toJSON=function(){return this._obj},TabularSectionRow.prototype.__define("_metadata",{get:function(){return this._owner._owner._metadata.tabular_sections[this._owner._name]},enumerable:!1}),TabularSectionRow.prototype.__define("row",{get:function(){return this._obj.row||0},enumerable:!0}),TabularSectionRow.prototype.__define("_clone",{value:function(){return new this._owner._owner._manager._ts_сonstructors[this._owner._name](this._owner)._mixin(this._obj)},enumerable:!1}),TabularSectionRow.prototype._getter=DataObj.prototype._getter,TabularSectionRow.prototype._setter=function(e,t){this._obj[e]!=t&&(Object.getNotifier(this._owner._owner).notify({type:"row",row:this,tabular:this._owner._name,name:e,oldValue:this._obj[e]}),DataObj.prototype.__setter.call(this,e,t))},DataObj.prototype.valueOf=function(){return this.ref},DataObj.prototype.toJSON=function(){return this._obj},DataObj.prototype._getter=function(e){var t,n=this._metadata.fields[e].type;return"type"==e&&"object"==typeof this._obj[e]?this._obj[e]:"ref"==e?this._obj[e]:n.is_ref?(t=_md.value_mgr(this._obj,e,n))?t instanceof DataManager?t.get(this._obj[e],!1):$p.fetch_type(this._obj[e],t):this._obj[e]?(console.log([e,n,this._obj]),null):void 0:n.date_part?$p.fix_date(this._obj[e],!0):n.digits?$p.fix_number(this._obj[e],!0):"boolean"==n.types[0]?$p.fix_boolean(this._obj[e]):this._obj[e]||""},DataObj.prototype.__setter=function(e,t){var n,r=this._metadata.fields[e].type;"type"==e&&t.types?this._obj[e]=t:"ref"==e?this._obj[e]=$p.fix_guid(t):r.is_ref?(this._obj[e]=$p.fix_guid(t),n=_md.value_mgr(this._obj,e,r,!1,t),n?n instanceof EnumManager?"string"==typeof t?this._obj[e]=t:t?"object"==typeof t&&(this._obj[e]=t.ref||t.name||""):this._obj[e]="":t&&t.presentation?(!t.type||t instanceof DataObj||delete t.type,n.create(t)):n instanceof DataManager||(this._obj[e]=$p.fetch_type(t,n)):"object"!=typeof t&&(this._obj[e]=t)):r.date_part?this._obj[e]=$p.fix_date(t,!0):r.digits?this._obj[e]=$p.fix_number(t,!0):"boolean"==r.types[0]?this._obj[e]=$p.fix_boolean(t):this._obj[e]=t},DataObj.prototype.__notify=function(e){Object.getNotifier(this).notify({type:"update",name:e,oldValue:this._obj[e]})},DataObj.prototype._setter=function(e,t){this._obj[e]!=t&&(this.__notify(e),this.__setter(e,t))},DataObj.prototype._getter_ts=function(e){return this._ts_(e)},DataObj.prototype._setter_ts=function(e,t){var n=this._ts_(e);n instanceof TabularSection&&Array.isArray(t)&&n.load(t)},DataObj.prototype.load=function(){function e(e){if("string"==typeof e&&(e=JSON.parse(e)),!$p.msg.check_soap_result(e)){var n=$p.fix_guid(e);return t.is_new()&&!$p.is_empty_guid(n)&&t._set_loaded(n),t._mixin(e)}}var t=this;return t._manager.cachable&&!t.is_new()?Promise.resolve(t):t.ref==$p.blank.guid?(t instanceof CatObj?t.id="000000000":t.number_doc="000000000",Promise.resolve(t)):$p.job_prm.rest||$p.job_prm.irest_enabled?_rest.load_obj(t):_load({class_name:t._manager.class_name,action:"load",ref:t.ref}).then(e)},DataObj.prototype.save=function(e,t){var n,r=this._manager.handle_event(this,"before_save");return r===!1?Promise.resolve(this):"object"==typeof r&&r.then?r:(this instanceof DocObj&&$p.blank.date==this.date&&(this.date=new Date),n=$p.job_prm.offline?function(e){return Promise.resolve(e)}:$p.job_prm.irest_enabled?_rest.save_irest:_rest.save_rest,n(this,{post:e,operational:t}).then(function(e){return e._manager.handle_event(e,"after_save")}))},DataObj.prototype.empty=function(){return $p.is_empty_guid(this._obj.ref)},DataObj.prototype.__define("_metadata",{get:function(){return this._manager.metadata()},enumerable:!1}),DataObj.prototype.__define("ref",{get:function(){return this._obj.ref},set:function(e){this._obj.ref=$p.fix_guid(e)},enumerable:!0,configurable:!0}),DataObj.prototype.__define("deleted",{get:function(){return this._obj.deleted},set:function(e){this.__notify("deleted"),this._obj.deleted=!!e},enumerable:!0,configurable:!0}),DataObj.prototype.__define("data_version",{get:function(){return this._obj.data_version||""},set:function(e){this.__notify("data_version"),this._obj.data_version=String(e)},enumerable:!0}),DataObj.prototype.__define("lc_changed",{get:function(){return this._obj.lc_changed||0},set:function(e){this.__notify("lc_changed"),this._obj.lc_changed=$p.fix_number(e,!0)},enumerable:!0,configurable:!0}),CatObj._extend(DataObj),CatObj.prototype.__define("id",{get:function(){return this._obj.id||""},set:function(e){this.__notify("id"),this._obj.id=e},enumerable:!0}),CatObj.prototype.__define("name",{get:function(){return this._obj.name||""},set:function(e){this.__notify("name"),this._obj.name=String(e)},enumerable:!0}),DocObj._extend(DataObj),DocObj.prototype.__define("number_doc",{get:function(){return this._obj.number_doc||""},set:function(e){this.__notify("number_doc"),this._obj.number_doc=e},enumerable:!0}),DocObj.prototype.__define("date",{get:function(){return this._obj.date||$p.blank.date},set:function(e){this.__notify("date"),this._obj.date=$p.fix_date(e,!0)},enumerable:!0}),DocObj.prototype.__define("posted",{get:function(){return this._obj.posted||!1},set:function(e){this.__notify("posted"),this._obj.posted=$p.fix_boolean(e)},enumerable:!0}),DataProcessorObj._extend(DataObj),EnumObj._extend(DataObj),EnumObj.prototype.__define("order",{get:function(){return this._obj.sequence},set:function(e){this._obj.sequence=parseInt(e)},enumerable:!0}),EnumObj.prototype.__define("name",{get:function(){return this._obj.ref},set:function(e){this._obj.ref=String(e)},enumerable:!0}),EnumObj.prototype.__define("synonym",{get:function(){return this._obj.synonym||""},set:function(e){this._obj.synonym=String(e)},enumerable:!0}),EnumObj.prototype.__define("presentation",{get:function(){return this.synonym||this.name},enumerable:!1}),EnumObj.prototype.empty=function(){return"_"==this.ref},RegisterRow._extend(DataObj),RegisterRow.prototype.__define("_metadata",{get:function(){var e=this._manager.metadata();return e.fields||(e.fields={}._mixin(e.dimensions)._mixin(e.resources)),e},enumerable:!1}),RegisterRow.prototype.__define("ref",{get:function(){return this._manager.get_ref(this)},enumerable:!0});var _rest=$p.rest=new Rest;return DataManager.prototype.__define("rest_name",{get:function(e){var t=this.class_name.split("."),n={cat:"Catalog",doc:"Document",ireg:"InformationRegister",areg:"AccumulationRegister",cch:"ChartOfCharacteristicTypes",cacc:"ChartOfAccounts"};return n[t[0]]+"_"+_md.syns_1с(t[1])+(e||"")},enumerable:!1}),DataManager.prototype.rest_tree=function(e){var t,n,r=this,a=r.metadata(),o=[];return $p.ajax.default_attr(e,!a.irest&&$p.job_prm.rest?$p.job_prm.rest_url():$p.job_prm.irest_url()),e.url+=this.rest_name+"?allowedOnly=true&$format=json&$top=1000&$select=Ref_Key,DeletionMark,Parent_Key,Description&$filter=IsFolder eq true",$p.ajax.get_ex(e.url,e).then(function(e){return JSON.parse(e.response)}).then(function(e){for(var r=0;r<e.value.length;r++)n=e.value[r],t={ref:n.Ref_Key,deleted:n.DeletionMark,parent:n.Parent_Key,presentation:n.Description},o.push(t);return $p.iface.data_to_tree(o)})},DataManager.prototype.rest_selection=function(e){if("get_tree"==e.action)return this.rest_tree(e);var t,n,r,a,o,s,i=this,_=i.metadata(),c=[],u=[];return o=function(){var e="$select=Ref_Key,DeletionMark";return _.form&&_.form.selection?_.form.selection.fields.forEach(function(e){c.push(e)}):i instanceof DocManager?(c.push("posted"),c.push("date"),c.push("number_doc")):(_.hierarchical&&_.group_hierarchy?c.push("is_folder"):c.push("0 as is_folder"),_.main_presentation_name?c.push("name as presentation"):_.code_length?c.push("id as presentation"):c.push("'...' as presentation"),_.has_owners&&c.push("owner"),_.code_length&&c.push("id")),c.forEach(function(t){var n;if(-1!=t.indexOf(" as "))if(n=t.split(" as ")[0].split("."),1==n.length)t=n[0];else{if("_t_"!=n[0])return;t=n[1]}"0"!=t&&(r=_md.syns_1с(t),_md.get(i.class_name,t).type.is_ref&&-1==r.indexOf("_Key")&&_md.get(i.class_name,t).type.types.length&&-1==_md.get(i.class_name,t).type.types[0].indexOf("enm.")&&(r+="_Key"),e+=","+r)}),c.push("ref"),c.push("deleted"),e}(),$p.ajax.default_attr(e,!_.irest&&$p.job_prm.rest?$p.job_prm.rest_url():$p.job_prm.irest_url()),e.url+=(_.irest&&_.irest.selection?_.irest.selection:this.rest_name)+"?allowedOnly=true&$format=json&$top=1000&"+o,_md.get(i.class_name,"date")&&(e.url+="&$filter="+_rest.filter_date("Date",e.date_from,e.date_till),s=!0),e.parent&&(e.url+=s?" and ":"&$filter=",e.url+="Parent_Key eq guid'"+e.parent+"'",s=!0),$p.ajax.get_ex(e.url,e).then(function(e){return JSON.parse(e.response)}).then(function(o){for(var s=0;s<o.value.length;s++)n=o.value[s],t={},c.forEach(function(e){var o;if("ref"==e)return void(t[e]=n.Ref_Key);if(-1!=e.indexOf(" as ")?(o=e.split(" as ")[1],e=e.split(" as ")[0].split("."),e=e[e.length-1]):o=e,r=_md.syns_1с(e),a=_md.get(i.class_name,e),-1==r.indexOf("_Key")&&a.type.is_ref&&a.type.types.length&&-1==a.type.types[0].indexOf("enm.")&&(r+="_Key"),a.type.date_part)t[o]=$p.dateFormat(n[r],$p.dateFormat.masks[a.type.date_part]);else if(a.type.is_ref)if(n[r]&&n[r]!=$p.blank.guid){var s=_md.value_mgr(t,e,a.type,!1,n[r]);s?t[o]=s.get(n[r]).presentation:t[o]=""}else t[o]="";else t[o]=n[r]}),u.push(t);return $p.iface.data_to_grid.call(i,u,e)})},InfoRegManager.prototype.rest_slice_last=function(e){e.period||(e.period=$p.date_add_day(new Date,1));var t=this,n=t.metadata(),r="Period=datetime'"+$p.dateFormat(e.period,$p.dateFormat.masks.isoDateTime)+"'",a="";for(var o in n.dimensions)if(void 0!==e[o]){var s=_md.syns_1с(o),i=n.dimensions[o];-1==s.indexOf("_Key")&&i.type.is_ref&&i.type.types.length&&-1==i.type.types[0].indexOf("enm.")?(s+="_Key",a&&(a+=" and "),a+=s+" eq guid'"+e[o].ref+"'"):(a&&(a+=" and "),a+=i.type.digits?s+" eq "+$p.fix_number(e[o]):i.type.date_part?s+" eq datetime'"+$p.dateFormat(e[o],$p.dateFormat.masks.isoDateTime)+"'":s+" eq '"+e[o]+"'")}return a&&(r+=",Condition='"+a+"'"),$p.ajax.default_attr(e,$p.job_prm.rest_url()),e.url+=this.rest_name+"/SliceLast(%sl)?allowedOnly=true&$format=json&$top=1000".replace("%sl",r),_rest.ajax_to_data(e,t).then(function(e){return t.load_array(e)})},DataObj.prototype.to_atom=function(e){function t(e){var t=e._metadata.fields,a=e instanceof TabularSectionRow?"\n	<d:":"\n<d:";for(n in t){if(r=t[n],i=_md.syns_1с(n),_=e[n],_ instanceof EnumObj)_=_.empty()?"":_.name;else if(_ instanceof DataObj)-1==i.indexOf("_Key")&&(i+="_Key"),_=_.ref;else if(r.type.date_part)_=_.getFullYear()<1e3?"0001-01-01T00:00:00Z":$p.dateFormat(_,$p.dateFormat.masks.atom);else if(void 0==_)continue;u+=a+i+">"+_+"</d:"+i+">"}}var n,r,a,o,s,i,_,c='<entry><category term="StandardODATA.%n" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme"/>				\n<title type="text"/><updated>%d</updated><author/><summary/><content type="application/xml">				\n<m:properties xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices" xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata">			%p			\n</m:properties></content></entry>'.replace("%n",this._manager.rest_name).replace("%d",$p.dateFormat(new Date,$p.dateFormat.masks.atom)),u="\n<d:Ref_Key>"+this.ref+"</d:Ref_Key>\n<d:DeletionMark>"+this.deleted+"</d:DeletionMark>\n<d:DataVersion>"+this.data_version+"</d:DataVersion>";this instanceof DocObj?(u+="\n<d:Date>"+$p.dateFormat(this.date,$p.dateFormat.masks.atom)+"</d:Date>",u+="\n<d:Number>"+this.number_doc+"</d:Number>"):(this._metadata.main_presentation_name&&(u+="\n<d:Description>"+this.name+"</d:Description>"),this._metadata.code_length&&(u+="\n<d:Code>"+this.id+"</d:Code>"),this._metadata.hierarchical&&this._metadata.group_hierarchy&&(u+="\n<d:IsFolder>"+this.is_folder+"</d:IsFolder>")),t(this);for(a in this._metadata.tabular_sections)s=this._metadata.tabular_sections[a],i="StandardODATA."+this._manager.rest_name+"_"+_md.syns_1с(a)+"_RowType",o=this[a],o.count()?(u+="\n<d:"+_md.syns_1с(a)+' m:type="Collection('+i+')">',o.each(function(e){u+='\n	<d:element m:type="'+i+'">',u+="\n	<d:LineNumber>"+e.row+"</d:LineNumber>",t(e),u+="\n	</d:element>"}),u+="\n</d:"+_md.syns_1с(a)+">"):u+="\n<d:"+_md.syns_1с(a)+' m:type="Collection('+i+')" />';return c.replace("%p",u)},function(e){e._evnts={data:{}},e.attachEvent=function(e,t){e=String(e).toLowerCase(),this._evnts.data[e]||(this._evnts.data[e]={});var n=$p.generate_guid();return this._evnts.data[e][n]=t,n},e.detachEvent=function(e){for(var t in this._evnts.data){var n=0;for(var r in this._evnts.data[t])r==e?(this._evnts.data[t][r]=null,delete this._evnts.data[t][r]):n++;0==n&&(this._evnts.data[t]=null,delete this._evnts.data[t])}},e.checkEvent=function(e){return e=String(e).toLowerCase(),null!=this._evnts.data[e]},e.callEvent=function(e,t){if(e=String(e).toLowerCase(),null==this._evnts.data[e])return!0;var n=!0;for(var r in this._evnts.data[e])n=this._evnts.data[e][r].apply(this,t)&&n;return n},e.detachAllEvents=function(){for(var e in this._evnts.data){for(var t in this._evnts.data[e])this._evnts.data[e][t]=null,delete this._evnts.data[e][t];this._evnts.data[e]=null,delete this._evnts.data[e]}},e=null}($p.eve),$p.eve.socket=new SocketMsg,$p.eve.pop=function(){$p.eve.stepper.cat_ini_date;return $p.job_prm.offline||!$p.job_prm.irest_enabled?Promise.resolve(!1):Promise.resolve(!1)},$p.eve.push=function(){},$p.eve.from_json_to_data_obj=function(e){var t,n=$p.eve.stepper;if("string"==typeof e?e=JSON.parse(e):e instanceof XMLHttpRequest&&(e=e.response?JSON.parse(e.response):{}),n.do_break)$p.iface.sync.close(),$p.eve.redirect=!0,location.reload(!0);else if(e.cat_date||e.force){e.cat_date>n.cat_ini_date&&(n.cat_ini_date=e.cat_date),e.cat_date>n.cat_date&&(n.cat_date=e.cat_date),e.count_all&&(n.count_all=e.count_all),e.current&&(n.current=e.current);for(t in e.cch)_cch[t]&&_cch[t].load_array(e.cch[t]);for(t in e.cacc)_cacc[t]&&_cacc[t].load_array(e.cacc[t]);for(t in e.cat)_cat[t]&&_cat[t].load_array(e.cat[t]);for(t in e.doc)_doc[t]&&_doc[t].load_array(e.doc[t]);for(t in e.ireg)_ireg[t]&&_ireg[t].load_array(e.ireg[t]);for(t in e.areg)_areg[t]&&_areg[t].load_array(e.areg[t]);return e.current&&e.current>=n.step_size}},$p.eve.reduce_promices=function(e,t){return e.reduce(function(e,n){return e.then(function(){return n}).then(t)["catch"](t)},Promise.resolve())},$p.eve.js_time_diff=-new Date("0001-01-01").valueOf(),$p.eve.time_diff=function(){var e=$p.wsql.get_user_param("time_diff","number");return!e||isNaN(e)||621355716e5>e||e>62135622e6?$p.eve.js_time_diff:e},$p.from_file=function(e){return new Promise(function(t,n){require("fs").readFile(e,{encoding:"utf8"},function(e,r){e?n(e):t(r.toString().trim())})})},$p.eve.init_node=function(e){$p.job_prm=new $p.JobPrm;var t=$p.job_prm.data_url||"/data/",n=require("pg");return $p.from_file(t+"create_tables.sql").then(function(t){return $p.wsql.init_params(e,t)}).then(function(){return $p.from_file(t+"meta.json")}).then(function(e){return $p.from_file(t+"meta_patch.json").then(function(t){return[JSON.parse(e),JSON.parse(t)]})}).then(function(e){return new $p.Meta(e[0],e[1])}).then(function(){function e(e){return n.connect($p.job_prm.pg_cnn,e)}return $p.job_prm.pg_cnn&&($p.wsql.postgres=function(t,n){return new Promise(function(r,a){return t?(n||(n=[]),void e(function(e,o,s){return e?void a(e):void o.query(t,n,function(e,t){return e?(s(),void a(e)):void r(t)})})):void r({rows:[]})})},$p.wsql.postgres.connect=e),$p.from_file(t+"create_tables_pg.sql")}).then(function(e){return $p.wsql.postgres(e)})},DataManager.prototype.load_full=function(){var e=this,t=e.metadata(),n={};return $p.ajax.default_attr(n,!t.irest&&$p.job_prm.rest?$p.job_prm.rest_url():$p.job_prm.irest_url()),n.url+=(t.irest&&t.irest.selection?t.irest.selection:e.rest_name)+"?allowedOnly=true&$format=json&$top=10000&$select=Ref_Key",$p.ajax.get_ex(n.url,n).then(function(e){return JSON.parse(e.response)}).then(function(e){var t=[],n=[],r=50,a=1;return e.value.forEach(function(e){n.push(e.Ref_Key),a==r&&(a=1,t.push(n),n=[]),a++}),-1==t.indexOf(n)&&t.push(n),t}).then(function(t){return new Promise(function(n,r){function a(){e.load_cached_server_array(t[o]).then(function(){o++,o<t.length?setTimeout(a,1e3):n()})["catch"](r)}var o=0;a()})})},RefDataManager.prototype.from_postgres=function(){},RefDataManager.prototype.to_postgres=function(){},$p});