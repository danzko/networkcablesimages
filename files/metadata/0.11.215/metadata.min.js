/*!
 metadata.js &copy; Evgeniy Malyarov http://www.oknosoft.ru 2014-2016
 metadata.js may be freely distributed under the AGPL-3.0. To obtain _Oknosoft Commercial license_, contact info@oknosoft.ru
 */
!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.$p=t()}(this,function(){function MetaEngine(){this.__define({version:{value:"0.11.215",writable:!1},toString:{value:function(){return"Oknosoft data engine. v:"+this.version},writable:!1},utils:{value:new Utils},injected_data:{value:{},writable:!1},ajax:{value:new Ajax,writable:!1},msg:{value:new Messages,writable:!1},wsql:{value:new WSQL,writable:!1},eve:{value:new AppEvents,writable:!1},aes:{value:new Aes("metadata.js"),writable:!1},moment:{get:function(){return this.utils.moment}},_patch:{value:function(e,t){for(var n in t)"object"==typeof t[n]&&e[n]&&"object"==typeof e[n]?$p._patch(e[n],t[n]):e[n]=t[n];return e}},_find:{value:function(e,t,n){var a,i,r;if("object"!=typeof t)for(i in e){a=e[i];for(var o in a)if("function"!=typeof a[o]&&$p.utils.is_equal(a[o],t))return a}else for(i in e){a=e[i],r=!0;for(var o in t)if("function"!=typeof a[o]&&!$p.utils.is_equal(a[o],t[o])){r=!1;break}if(r)return a}}},_selection:{value:function(e,t){var n,a,i,r=!0;if(t)if("function"==typeof t)r=t.call(this,e);else for(n in t)if(a=t[n],i="object"==typeof a,"_"!=n.substr(0,1))if("function"==typeof a){if(r=a.call(this,e,n),!r)break}else if("or"==n&&Array.isArray(a)){if(r=a.some(function(t){var n=Object.keys(t)[0];return t[n].hasOwnProperty("like")?e[n]&&e[n].toLowerCase().indexOf(t[n].like.toLowerCase())!=-1:$p.utils.is_equal(e[n],t[n])}),!r)break}else if(i&&a.hasOwnProperty("like")){if(!e[n]||e[n].toLowerCase().indexOf(a.like.toLowerCase())==-1){r=!1;break}}else if(i&&a.hasOwnProperty("not")){if($p.utils.is_equal(e[n],a.not)){r=!1;break}}else if(i&&a.hasOwnProperty("in")){if(r=a.in.some(function(t){return $p.utils.is_equal(t,e[n])}),!r)break}else if(i&&a.hasOwnProperty("lt")){if(r=e[n]<a.lt,!r)break}else if(i&&a.hasOwnProperty("gt")){if(r=e[n]>a.gt,!r)break}else if(i&&a.hasOwnProperty("between")){var o=e[n];if("number"!=typeof o&&(o=$p.utils.fix_date(e[n])),r=o>=a.between[0]&&o<=a.between[1],!r)break}else if(!$p.utils.is_equal(e[n],a)){r=!1;break}return r}},_find_rows:{value:function(e,t,n){var a,i,r=[],o=0;t&&(t._top?(i=t._top,delete t._top):i=300);for(var s in e)if(a=e[s],$p._selection.call(this,a,t)){if(n){if(n.call(this,a)===!1)break}else r.push(a);if(i&&(o++,o>=i))break}return r}},on:{value:function(e,t){if("object"!=typeof e)return this.eve.attachEvent(e,t);for(var n in e)e[n]._evnts||(e[n]._evnts=[]),e[n]._evnts.push(this.eve.attachEvent(n,e[n]))}},off:{value:function(e){"function"==typeof e&&e._evnts?e._evnts.forEach(function(e){$p.eve.detachEvent(e)}):e?$p.eve.detachEvent(e):$p.eve.detachAllEvents()}},record_log:{value:function(e){$p.ireg&&$p.ireg.$log&&$p.ireg.$log.record(e),console.log(e)}},md:{value:new Meta},enm:{value:new function(){this.toString=function(){return $p.msg.meta_enn_mgr}}},cat:{value:new function(){this.toString=function(){return $p.msg.meta_cat_mgr}}},doc:{value:new function(){this.toString=function(){return $p.msg.meta_doc_mgr}}},ireg:{value:new function(){this.toString=function(){return $p.msg.meta_ireg_mgr}}},areg:{value:new function(){this.toString=function(){return $p.msg.meta_areg_mgr}}},"aссreg":{value:new function(){this.toString=function(){return $p.msg.meta_accreg_mgr}}},dp:{value:new function(){this.toString=function(){return $p.msg.meta_dp_mgr}}},rep:{value:new function(){this.toString=function(){return $p.msg.meta_reports_mgr}}},cacc:{value:new function(){this.toString=function(){return $p.msg.meta_charts_of_accounts_mgr}}},cch:{value:new function(){this.toString=function(){return $p.msg.meta_charts_of_characteristic_mgr}}},tsk:{value:new function(){this.toString=function(){return $p.msg.meta_task_mgr}}},bp:{value:new function(){this.toString=function(){return $p.msg.meta_bp_mgr}}},DataManager:{value:DataManager},RefDataManager:{value:RefDataManager},DataProcessorsManager:{value:DataProcessorsManager},EnumManager:{value:EnumManager},RegisterManager:{value:RegisterManager},InfoRegManager:{value:InfoRegManager},InfoRegManager:{value:InfoRegManager},LogManager:{value:LogManager},AccumRegManager:{value:AccumRegManager},CatManager:{value:CatManager},ChartOfCharacteristicManager:{value:ChartOfCharacteristicManager},ChartOfAccountManager:{value:ChartOfAccountManager},DocManager:{value:DocManager},TaskManager:{value:TaskManager},BusinessProcessManager:{value:BusinessProcessManager},DataObj:{value:DataObj},CatObj:{value:CatObj},DocObj:{value:DocObj},DataProcessorObj:{value:DataProcessorObj},TaskObj:{value:TaskObj},BusinessProcessObj:{value:BusinessProcessObj},EnumObj:{value:EnumObj},RegisterRow:{value:RegisterRow},TabularSection:{value:TabularSection},TabularSectionRow:{value:TabularSectionRow}})}function Utils(){this.moment="function"==typeof moment?moment:require("moment"),this.moment._masks={date:"DD.MM.YY",date_time:"DD.MM.YYYY HH:mm",ldt:"DD MMMM YYYY, HH:mm",iso:"YYYY-MM-DDTHH:mm:ss"},this.fix_date=function(e,t){if(e instanceof Date)return e;var n=this.moment(e,["DD-MM-YYYY","DD-MM-YYYY HH:mm","DD-MM-YYYY HH:mm:ss","DD-MM-YY HH:mm","YYYYDDMMHHmmss",this.moment.ISO_8601]);return n.isValid()?n.toDate():t?this.blank.date:e},this.fix_guid=function(e,t){if(e&&"string"==typeof e);else{if(e instanceof DataObj)return e.ref;if(e&&"object"==typeof e)if(e.presentation){if(e.ref)return e.ref;if(e.name)return e.name}else e="object"==typeof e.ref&&e.ref.hasOwnProperty("ref")?e.ref.ref:e.ref}return this.is_guid(e)||t===!1?e:t?this.generate_guid():this.blank.guid},this.fix_number=function(e,t){var n=parseFloat(e);return isNaN(n)?t?0:e:n},this.fix_boolean=function(e){return"string"==typeof e?!(!e||"false"==e.toLowerCase()):!!e},this.blank={date:this.fix_date("0001-01-01T00:00:00"),guid:"00000000-0000-0000-0000-000000000000",by_type:function(e){var t;return t=e.is_ref?this.guid:e.date_part?this.date:e.digits?0:(!e.types||"boolean"!=e.types[0])&&""}},this.fetch_type=function(e,t){var n=e;return t.is_ref?n=this.fix_guid(e):t.date_part?n=this.fix_date(e,!0):t.digits?n=this.fix_number(e,!0):"boolean"==t.types[0]&&(n=this.fix_boolean(e)),n},this.date_add_day=function(e,t,n){var a=new Date(e);return a.setDate(e.getDate()+t),n&&a.setHours(0,-a.getTimezoneOffset(),0,0),a},this.generate_guid=function(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:7&n|8).toString(16)})},this.is_guid=function(e){return!("string"!=typeof e||e.length<36)&&(e.length>36&&(e=e.substr(0,36)),/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(e))},this.is_empty_guid=function(e){return!e||e===this.blank.guid},this.is_data_obj=function(e){return e&&e instanceof DataObj},this.is_data_mgr=function(e){return e&&e instanceof DataManager},this.is_equal=function(e,t){return e==t||typeof e!=typeof t&&this.fix_guid(e,!1)==this.fix_guid(t,!1)},this.blob_as_text=function(e,t){return new Promise(function(n,a){var i=new FileReader;i.onload=function(e){n(i.result)},i.onerror=function(e){a(e)},"data_url"==t?i.readAsDataURL(e):i.readAsText(e)})}}function Ajax(){function e(e,t,n,a,i){return new Promise(function(r,o){if("undefined"==typeof window&&a&&a.request)a.request({url:encodeURI(t),headers:{Authorization:a.auth}},function(e,t,n){e?o(e):200!=t.statusCode?o({message:t.statusMessage,description:n,status:t.statusCode}):r({response:n})});else{var s=new XMLHttpRequest;if(window.dhx4&&window.dhx4.isIE&&(t=encodeURI(t)),a){var l,c;"object"==typeof a&&a.username&&a.hasOwnProperty("password")?(l=a.username,c=a.password):$p.ajax.username&&$p.ajax.authorized?(l=$p.ajax.username,c=$p.aes.Ctr.decrypt($p.ajax.password)):(l=$p.wsql.get_user_param("user_name"),c=$p.aes.Ctr.decrypt($p.wsql.get_user_param("user_pwd")),!l&&$p.job_prm&&$p.job_prm.guest_name&&(l=$p.job_prm.guest_name,c=$p.aes.Ctr.decrypt($p.job_prm.guest_pwd))),s.open(e,t,!0,l,c),s.withCredentials=!0,s.setRequestHeader("Authorization","Basic "+btoa(unescape(encodeURIComponent(l+":"+c))))}else s.open(e,t,!0);i&&i.call(this,s),"GET"!=e?this.hide_headers||a.hide_headers||(s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.setRequestHeader("X-Requested-With","XMLHttpRequest")):n=null,s.onload=function(){200==s.status&&(s.response instanceof Blob||"<!DOCTYPE"!==s.response.substr(0,9))?(void 0==s.responseURL&&(s.responseURL=t),r(s)):o(s.response?{message:s.statusText,description:s.response,status:s.status}:Error(s.statusText))},s.onerror=function(){o(Error("Network Error"))},s.send(n)}})}this.username="",this.password="",this.root=!0,this.authorized=!1,this.get=function(t){return e.call(this,"GET",t)},this.post=function(t,n){return 1==arguments.length?n="":2==arguments.length&&"function"==typeof n?(onLoad=n,n=""):n=String(n),e.call(this,"POST",t,n)},this.get_ex=function(t,n,a){return e.call(this,"GET",t,null,n,a)},this.post_ex=function(t,n,a,i){return e.call(this,"POST",t,n,a,i)},this.put_ex=function(t,n,a,i){return e.call(this,"PUT",t,n,a,i)},this.patch_ex=function(t,n,a,i){return e.call(this,"PATCH",t,n,a,i)},this.delete_ex=function(t,n,a){return e.call(this,"DELETE",t,null,n,a)},this.get_and_show_blob=function(e,t,n){function a(t){return e=window.URL.createObjectURL(t.response),i=window.open(e,"wnd_print",r),i.onload=function(t){window.URL.revokeObjectURL(e)},i}var i,r="menubar=no,toolbar=no,location=no,status=no,directories=no,resizable=yes,scrollbars=yes";return!n||"string"==typeof n&&n.toLowerCase().indexOf("post")!=-1?this.post_ex(e,"object"==typeof t?JSON.stringify(t):t,!0,function(e){e.responseType="blob"}).then(a):this.get_ex(e,!0,function(e){e.responseType="blob"}).then(a)},this.get_and_save_blob=function(e,t,n){return this.post_ex(e,"object"==typeof t?JSON.stringify(t):t,!0,function(e){e.responseType="blob"}).then(function(e){saveAs(e.response,n)})},this.default_attr=function(e,t){e.url||(e.url=t),e.username||(e.username=this.username),e.password||(e.password=this.password),e.hide_headers=!0,$p.job_prm["1c"]&&(e.auth=$p.job_prm["1c"].auth,e.request=$p.job_prm["1c"].request)}}function WSQL(){var e,t=this,n={};this.__define({js_time_diff:{value:-new Date("0001-01-01").valueOf()},time_diff:{get:function(){var e=this.get_user_param("time_diff","number");return!e||isNaN(e)||e<621355716e5||e>62135622e6?this.js_time_diff:e}},set_user_param:{value:function(t,a){var i=a;"object"==typeof a?i=JSON.stringify(a):a===!1&&(i=""),e.setItem($p.job_prm.local_storage_prefix+t,i),n[t]=a}},get_user_param:{value:function(t,a){return!n.hasOwnProperty(t)&&e&&(n[t]=this.fetch_type(e.getItem($p.job_prm.local_storage_prefix+t),a)),n[t]}},promise:{value:function(e,n){return new Promise(function(a,i){t.alasql(e,n||[],function(e,t){t?i(t):a(e)})})}},save_options:{value:function(e,n){return t.set_user_param(e+"_"+n.name,n)}},restore_options:{value:function(e,n){var a=t.get_user_param(e+"_"+n.name,"object");for(var i in a)if("object"!=typeof a[i])n[i]=a[i];else{n[i]||(n[i]={});for(var r in a[i])n[i][r]=a[i][r]}return n}},fetch_type:{value:function(e,t){if("object"==t){try{e=JSON.parse(e)}catch(t){e={}}return e}return"number"==t?$p.utils.fix_number(e,!0):"date"==t?$p.utils.fix_date(e,!0):"boolean"==t?$p.utils.fix_boolean(e):e}},alasql:{value:"undefined"!=typeof alasql?alasql:require("alasql")},init_params:{value:function(){if(!$p.job_prm.local_storage_prefix&&!$p.job_prm.create_tables)return Promise.resolve();e="undefined"==typeof localStorage?"undefined"==typeof WorkerGlobalScope?new require("node-localstorage").LocalStorage("./localstorage"):{setItem:function(e,t){},getItem:function(e){}}:localStorage;var n,a=[{p:"user_name",v:"",t:"string"},{p:"user_pwd",v:"",t:"string"},{p:"browser_uid",v:$p.utils.generate_guid(),t:"string"},{p:"zone",v:$p.job_prm.hasOwnProperty("zone")?$p.job_prm.zone:1,t:$p.job_prm.zone_is_string?"string":"number"},{p:"enable_save_pwd",v:$p.job_prm.enable_save_pwd,t:"boolean"},{p:"autologin",v:"",t:"boolean"},{p:"skin",v:"dhx_web",t:"string"},{p:"rest_path",v:"",t:"string"}];$p.job_prm.additional_params&&(a=a.concat($p.job_prm.additional_params)),e.getItem($p.job_prm.local_storage_prefix+"zone")||(n=$p.job_prm.hasOwnProperty("zone")?$p.job_prm.zone:1),$p.job_prm.url_prm.hasOwnProperty("zone")&&(n=$p.job_prm.zone_is_string?$p.job_prm.url_prm.zone:$p.utils.fix_number($p.job_prm.url_prm.zone,!0)),void 0!==n&&t.set_user_param("zone",n),a.forEach(function(e){(void 0==t.get_user_param(e.p,e.t)||!t.get_user_param(e.p,e.t)&&e.p.indexOf("url")!=-1)&&t.set_user_param(e.p,$p.job_prm.hasOwnProperty(e.p)?$p.job_prm[e.p]:e.v)});var i={path:t.get_user_param("couch_path","string")||$p.job_prm.couch_path||"",zone:t.get_user_param("zone","number"),prefix:$p.job_prm.local_storage_prefix,suffix:t.get_user_param("couch_suffix","string")||""};i.path&&(t.__define("pouch",{value:new Pouch}),t.pouch.init(i)),this.create_tables&&(this.alasq(this.create_tables,[]),this.create_tables="")}},drop_tables:{value:function(e){function n(){r--,r<=0?setTimeout(e,10):a()}function a(){var e=o[r-1].tableid;"_"==e.substr(0,1)?n():t.alasql("drop table IF EXISTS "+e,[],n)}function i(e){o=e,(r=e.length)?a():n()}var r=0,o=[];t.alasql("SHOW TABLES",[],i)}}}),this.__define({aladb:{value:new this.alasql.Database("md")}})}function Col_struct(e,t,n,a,i,r){this.id=e,this.width=t,this.type=n,this.align=a,this.sort=i,this.caption=r}function InterfaceObjs(){var e=this;this.clear_svgs=function(e){for("string"==typeof e&&(e=document.getElementById(e));e.firstChild;)e.removeChild(e.firstChild)},this.get_offset=function(e){var t={left:0,top:0};if(e.offsetParent)do t.left+=e.offsetLeft,t.top+=e.offsetTop;while(e=e.offsetParent);return t},this.normalize_xml=function(e){if(!e)return"";var t={"&":"&amp;",'"':"&quot;","'":"&apos;","<":"&lt;",">":"&gt;"};return e.replace(/[&"'<>]/g,function(e){return t[e]})},this.scale_svg=function(e,t,n){var a,i,r,o,s,l,c,d,u,f={},p="number"==typeof t?t:t.height,_="number"==typeof t?(1.5*t).round(0):t.width,h="number"==typeof t?1/0:t.zoom||1/0;s=e.indexOf(">"),c=e.substring(5,s),r=c.split(" "),o=e.substr(s+1),o=o.substr(0,o.length-6);for(a in r)e=r[a].split("="),"width,height,x,y".indexOf(e[0])!=-1&&(e[1]=Number(e[1].replace(/"/g,"")),f[e[0]]=e[1]);(l=c.indexOf("viewBox="))!=-1?(d=c.substring(l+9),u='viewBox="'+d.substring(0,d.indexOf('"'))+'"'):u='viewBox="'+(f.x||0)+" "+(f.y||0)+" "+(f.width-n)+" "+(f.height-n)+'"';var m=f.height,g=f.width;return i=(p-n)/m,f.height=p,f.width=(g*i).round(0),f.width>_&&(i=(_-n)/g,f.height=(m*i).round(0),f.width=_),i>h&&(i=h,f.height=(m*i).round(0),f.width=(g*i).round(0)),f.x=(f.x*i).round(0),f.y=(f.y*i).round(0),'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="'+f.width+'" height="'+f.height+'" x="'+f.x+'" y="'+f.y+'" xml:space="preserve" '+u+">"+o+"</svg>"},this.bind_help=function(e,t){function n(e){if(!e.help_path)return void $p.msg.show_msg({title:"Справка",type:"alert-info",text:$p.msg.not_implemented})}e instanceof dhtmlXCellObject||(!e.help_path&&t&&(e.help_path=t),e.button("help").show(),e.button("help").enable(),e.attachEvent("onHelp",n))},this.set_hash=function(t,n,a,i){var r={},o=$p.job_prm.parse_url();1==arguments.length&&"object"==typeof t&&(r=t,r.hasOwnProperty("obj")&&(t=r.obj,delete r.obj),r.hasOwnProperty("ref")&&(n=r.ref,delete r.ref),r.hasOwnProperty("frm")&&(a=r.frm,delete r.frm),r.hasOwnProperty("view")&&(i=r.view,delete r.view)),void 0===t&&(t=o.obj||""),void 0===n&&(n=o.ref||""),void 0===a&&(a=o.frm||""),void 0===i&&(i=o.view||"");var s="obj="+t+"&ref="+n+"&frm="+a+"&view="+i;for(var l in r)s+="&"+l+"="+r[l];location.hash.substr(1)==s?e.hash_route():location.hash=s},this.hash_route=function(t){var n,a=$p.job_prm.parse_url(),i=$p.eve.callEvent("hash_route",[a]);if(i===!1||e.before_route&&e.before_route(t)===!1||$p.ajax.authorized&&(a.ref&&"undefined"!=typeof _md?(n=_md.mgr_by_class_name(a.obj),n&&n[a.frm||"form_obj"](e.docs,a.ref)):a.view&&e.swith_view&&e.swith_view(a.view)),t)return e.cancel_bubble(t)},this.cancel_bubble=function(e){var t=e||event;return t&&t.stopPropagation&&t.stopPropagation(),t&&!t.cancelBubble&&(t.cancelBubble=!0),!1},this.Col_struct=Col_struct}function Pouch(){var e,t,n,a,i=this,r={};i.__define({DB:{value:"undefined"==typeof PouchDB?require("pouchdb-core").plugin(require("pouchdb-adapter-memory")).plugin(require("pouchdb-adapter-http")).plugin(require("pouchdb-replication")).plugin(require("pouchdb-mapreduce")):PouchDB},init:{value:function(e){r._mixin(e),r.path&&0!=r.path.indexOf("http")&&"undefined"!=typeof location&&(r.path=location.protocol+"//"+location.host+r.path)}},local:{get:function(){if(!e){var t={auto_compaction:!0,revs_limit:2};e={ram:new i.DB(r.prefix+r.zone+"_ram",t),doc:new i.DB(r.prefix+r.zone+"_doc",t),meta:new i.DB(r.prefix+"meta",t),sync:{}}}return r.path&&!e._meta&&(e._meta=new i.DB(r.path+"meta",{auth:{username:"guest",password:"meta"},skip_setup:!0}),i.run_sync(e.meta,e._meta,"meta")),e}},remote:{get:function(){return!t&&n&&(t={ram:new i.DB(r.path+r.zone+"_ram",{auth:{username:n.username,password:n.password},skip_setup:!0}),doc:new i.DB(r.path+r.zone+"_doc"+r.suffix,{auth:{username:n.username,password:n.password},skip_setup:!0})}),t}},log_in:{value:function(e,t){return void 0==e&&void 0==t&&(e=$p.job_prm.guest_name,t=$p.aes.Ctr.decrypt($p.job_prm.guest_pwd)),n?n.username==e?Promise.resolve():Promise.reject():$p.ajax.get_ex(r.path+r.zone+"_ram",{username:e,password:t}).then(function(a){return n={username:e,password:t},setTimeout(function(){dhx4.callEvent("log_in",[e])}),{ram:i.run_sync(i.local.ram,i.remote.ram,"ram"),doc:i.run_sync(i.local.doc,i.remote.doc,"doc")}})}},log_out:{value:function(){if(n){if(e.sync.doc)try{e.sync.doc.cancel()}catch(e){}if(e.sync.ram)try{e.sync.ram.cancel()}catch(e){}n=null}t&&t.ram&&delete t.ram,t&&t.doc&&delete t.doc,t=null,dhx4.callEvent("log_out")}},reset_local_data:{value:function(){var e=i.local.ram.destroy.bind(i.local.ram),t=i.local.doc.destroy.bind(i.local.doc),n=function(){setTimeout(function(){$p.eve.redirect=!0,location.reload(!0)},1e3)};i.log_out(),setTimeout(function(){e().then(t).catch(t).then(n).catch(n)},1e3)}},load_data:{value:function(){var e={limit:200,include_docs:!0},t={total_rows:0,limit:e.limit,page:0,start:Date.now()};return new Promise(function(n,r){function o(){i.local.ram.allDocs(e,function(s,l){l?(t.page++,t.total_rows=l.total_rows,t.duration=Date.now()-t.start,$p.eve.callEvent("pouch_load_data_page",[t]),i.load_changes(l,e)?o():(n(),a=!0,$p.eve.callEvent("pouch_load_data_loaded",[t]),t.note="pouch_load_data_loaded",$p.record_log(t))):s&&(r(s),$p.eve.callEvent("pouch_load_data_error",[s]))})}i.local.ram.info().then(function(e){e.doc_count>=($p.job_prm.pouch_ram_doc_count||10)?($p.eve.callEvent("pouch_load_data_start",[t]),o()):($p.eve.callEvent("pouch_load_data_error",[e]),r(e))})})}},authorized:{get:function(){return n&&n.username}},data_loaded:{get:function(){return!!a}},run_sync:{value:function(t,n,r){var o,s;return t.info().then(function(e){return o=e,n.info()}).then(function(e){return"ram"!=r?e:n.get("data_version").then(function(t){return t.version!=$p.wsql.get_user_param("couch_ram_data_version")&&($p.wsql.get_user_param("couch_ram_data_version")&&(e=i.reset_local_data()),$p.wsql.set_user_param("couch_ram_data_version",t.version)),e}).catch(function(e){$p.record_log(e)}).then(function(){return e})}).then(function(l){if(l){"ram"==r&&o.doc_count<($p.job_prm.pouch_ram_doc_count||10)?(s={total_rows:l.doc_count,local_rows:o.doc_count,docs_written:0,limit:200,page:0,start:Date.now()},$p.eve.callEvent("pouch_load_data_start",[s])):"doc"==r&&setTimeout(function(){$p.eve.callEvent("pouch_doc_sync_start")});var c="ram"==r||"meta"==r||$p.wsql.get_user_param("zone")==$p.job_prm.zone_demo?t.replicate.from:t.sync,d={live:!0,retry:!0,batch_size:200,batches_limit:8};return"meta"==r?d.filter="auth/meta":$p.job_prm.pouch_filter&&$p.job_prm.pouch_filter[r]&&(d.filter=$p.job_prm.pouch_filter[r]),e.sync[r]=c(n,d),e.sync[r].on("change",function(e){"ram"==r&&(i.load_changes(e),o.doc_count<($p.job_prm.pouch_ram_doc_count||10)&&(s.page++,s.docs_written=e.docs_written,s.duration=Date.now()-s.start,$p.eve.callEvent("pouch_load_data_page",[s]),s.docs_written>=s.total_rows&&(a=!0,$p.eve.callEvent("pouch_load_data_loaded",[s]),s.note="pouch_load_data_loaded",$p.record_log(s)))),$p.eve.callEvent("pouch_change",[r,e])}).on("paused",function(e){e&&$p.eve.callEvent("pouch_paused",[r,e])}).on("active",function(e){$p.eve.callEvent("pouch_active",[r,e])}).on("denied",function(e){$p.eve.callEvent("pouch_denied",[r,e])}).on("complete",function(e){$p.eve.callEvent("pouch_complete",[r,e])}).on("error",function(e){$p.eve.callEvent("pouch_error",[r,e])}),e.sync[r]}})}},load_obj:{value:function(e){return e._manager.pouch_db.get(e._manager.class_name+"|"+e.ref).then(function(t){delete t._id,delete t._rev,e._mixin(t)._set_loaded()}).catch(function(e){if(404!=e.status)throw e}).then(function(t){return e})}},save_obj:{value:function(e,t){var n=e._obj._clone(),a=e._manager.pouch_db;return n._id=e._manager.class_name+"|"+e.ref,delete n.ref,t.attachments&&(n._attachments=t.attachments),(e.is_new()?Promise.resolve():a.get(n._id)).then(function(e){if(e){n._rev=e._rev;for(var t in e._attachments)n._attachments||(n._attachments={}),n._attachments[t]||(n._attachments[t]=e._attachments[t])}}).catch(function(e){if(404!=e.status)throw e}).then(function(){return a.put(n)}).then(function(){if(e.is_new()&&e._set_loaded(e.ref),n._attachments){e._attachments||(e._attachments={});for(var a in n._attachments)e._attachments[a]&&n._attachments[a].stub||(e._attachments[a]=n._attachments[a])}return n=null,t=null,e})}},load_changes:{value:function(e,t){var n,a,i,r,o={};if(t)n=e.rows;else if(e.direction){if("pull"!=e.direction)return;n=e.change.docs}else n=e.docs;if(n.length>0){t&&(t.startkey=n[n.length-1].key,t.skip=1),n.forEach(function(e){if(a=t?e.doc:e,!a)if(e.value&&e.value.deleted)a={_id:e.id,_deleted:!0};else if(e.error)return;r=a._id.split("|"),i=r[0].split("."),a.ref=r[1],delete a._id,delete a._rev,o[i[0]]||(o[i[0]]={}),o[i[0]][i[1]]||(o[i[0]][i[1]]=[]),o[i[0]][i[1]].push(a)});for(var s in o)for(i in o[s])$p[s]&&$p[s][i]&&$p[s][i].load_array(o[s][i],!0);return o=e=n=a=null,!0}return!1}},backup_database:{value:function(e){}},restore_database:{value:function(e){}}})}function Messages(){this.toString=function(){return"Интернационализация сообщений"},this.russian_names=function(){$p.job_prm.russian_names&&(window.__define({"Метаданные":{get:function(){return $p.md},enumerable:!1},"Справочники":{get:function(){return $p.cat},enumerable:!1},"Документы":{get:function(){return $p.doc},enumerable:!1},"РегистрыСведений":{get:function(){return $p.ireg},enumerable:!1},"РегистрыНакопления":{get:function(){return $p.areg},enumerable:!1},"РегистрыБухгалтерии":{get:function(){return $p.accreg},enumerable:!1},"Обработки":{get:function(){return $p.dp},enumerable:!1},"Отчеты":{get:function(){return $p.rep},enumerable:!1},"ОбластьКонтента":{get:function(){return $p.iface.docs},enumerable:!1},"Сообщить":{get:function(){return $p.msg.show_msg},enumerable:!1},"Истина":{value:!0,enumerable:!1},"Ложь":{value:!1,enumerable:!1}}),DataManager.prototype.__define({"ФормаВыбора":{get:function(){return this.form_selection},enumerable:!1},"ФормаОбъекта":{get:function(){return this.form_obj},enumerable:!1},"Найти":{get:function(){return this.find},enumerable:!1},"НайтиСтроки":{get:function(){return this.find_rows},enumerable:!1},"НайтиПоНаименованию":{get:function(){return this.by_name},enumerable:!1}}),DataObj.prototype.__define({"ФормаОбъекта":{get:function(){return this.form_obj},enumerable:!1}}))},"undefined"!=typeof window&&"dhtmlx"in window&&(this.show_msg=function(e,t){if(e){if("string"==typeof e){if($p.iface.synctxt)return void $p.iface.synctxt.show_message(e);e={type:"info",text:e}}t&&"function"==typeof t.setText&&t.setText(e.text),dhtmlx.message(e)}},this.check_soap_result=function(e){return e?"limit_query"==e.error?($p.iface.docs.progressOff(),$p.msg.show_msg({type:"alert-warning",text:$p.msg.limit_query.replace("%1",e.queries).replace("%2",e.queries_avalable),title:$p.msg.srv_overload}),!0):"network"==e.error||"empty"==e.error?($p.iface.docs.progressOff(),$p.msg.show_msg({type:"alert-warning",text:$p.msg.error_network,title:$p.msg.error_critical}),!0):e.error&&e.error_description?($p.iface.docs.progressOff(),e.error_description.indexOf("Недостаточно прав")!=-1&&(e.error_type="alert-warning",e.error_title=$p.msg.error_rights),$p.msg.show_msg({type:e.error_type||"alert-error",text:e.error_description,title:e.error_title||$p.msg.error_critical}),!0):e.error&&!e.messages?($p.iface.docs.progressOff(),$p.msg.show_msg({type:"alert-error",title:$p.msg.error_critical,text:$p.msg.unknown_error.replace("%1","unknown_error")}),!0):void 0:($p.msg.show_msg({type:"alert-error",text:$p.msg.empty_response,title:$p.msg.error_critical}),!0)},this.show_not_implemented=function(){$p.msg.show_msg({type:"alert-warning",text:$p.msg.not_implemented,title:$p.msg.main_title})})}function Meta(){function e(e){return e.info().then(function(){return e.get("meta")}).then(function(n){return t=n,n=null,e.get("meta_patch")}).then(function(e){$p._patch(t,e),e=null,delete t._id,delete t._rev})}var t;_md=this,_md.create_managers=function(){},_md.init=function(n){function a(){return!n||o||s?e(n||$p.wsql.pouch.local.meta).then(function(){return o?void _md.create_managers():t}).catch($p.record_log):(t=n,n=null,_md.create_managers(),void 0)}function i(){dhtmlx.confirm({title:$p.msg.file_new_date_title,text:$p.msg.file_new_date,ok:"Перезагрузка",cancel:"Продолжить",callback:function(e){e?($p.wsql.pouch.log_out(),setTimeout(function(){$p.eve.redirect=!0,location.reload(!0)},1e3)):(r++,setTimeout(i,3e4*r))}})}var r=0,o=!n||$p.wsql.pouch&&n==$p.wsql.pouch.local.meta,s=n&&$p.wsql.pouch&&n==$p.wsql.pouch.local._meta;return $p.on("pouch_change",function(e,n){"meta"==e&&(t?performance.now()>2e4&&n.docs.some(function(e){return"meta"!=e._id.substr(0,4)})&&i():a())}),a()},_md.get=function(e,n){var a=e.split(".");if(!n)return t[a[0]][a[1]];var i={multiline_mode:!1,note:"",synonym:"",tooltip:"",type:{is_ref:!1,types:["string"]}},r="doc,tsk,bp".indexOf(a[0])!=-1,o="cat,cch,cacc,tsk".indexOf(a[0])!=-1;return r&&"number_doc"==n?(i.synonym="Номер",i.tooltip="Номер документа",i.type.str_len=11):r&&"date"==n?(i.synonym="Дата",i.tooltip="Дата документа",i.type.date_part="date_time",i.type.types[0]="date"):r&&"posted"==n?(i.synonym="Проведен",i.type.types[0]="boolean"):o&&"id"==n?i.synonym="Код":o&&"name"==n?i.synonym="Наименование":"_deleted"==n?(i.synonym="Пометка удаления",i.type.types[0]="boolean"):"is_folder"==n?(i.synonym="Это группа",i.type.types[0]="boolean"):"ref"==n?(i.synonym="Ссылка",i.type.is_ref=!0,i.type.types[0]=e):i=n?t[a[0]][a[1]].fields[n]:t[a[0]][a[1]],i},_md.get_classes=function(){var e={};for(var n in t){e[n]=[];for(var a in t[n])e[n].push(a)}return e},_md.sql_type=function(e,t,n,a){var i;return i="type"==t&&"cch_properties"==e.table_name||"svg"==t&&"cat_production_params"==e.table_name?" JSON":n.is_ref||n.types.indexOf("guid")!=-1?a?n.types.every(function(e){return 0==e.indexOf("enm.")})?" character varying(100)":n.hasOwnProperty("str_len")?" character varying("+Math.max(36,n.str_len)+")":" uuid":" CHAR":n.hasOwnProperty("str_len")?a?n.str_len?" character varying("+n.str_len+")":" text":" CHAR":n.date_part?a&&"date"!=n.date_part?"date_time"==n.date_part?" timestamp with time zone":" time without time zone":" Date":n.hasOwnProperty("digits")?0==n.fraction_figits?a?n.digits<7?" integer":" bigint":" INT":a?" numeric("+n.digits+","+n.fraction_figits+")":" FLOAT":n.types.indexOf("boolean")!=-1?" BOOLEAN":n.types.indexOf("json")!=-1?" JSON":a?" character varying(255)":" CHAR"},_md.sql_composite=function(e,t,n,a){var i="";return e[t].type.types.length>1&&"type"!=t&&(n=n?n.substr(0,29)+"_T":t.substr(0,29)+"_T",i=a?', "'+n+'" character varying(255)':_md.sql_mask(n)+" CHAR"),i},_md.sql_mask=function(e,t){return", "+(t?"_t_.":"")+("`"+e+"`")},_md.mgr_by_class_name=function(e){if(e){var t=e.split(".");if(t[1]&&$p[t[0]])return $p[t[0]][t[1]]}},_md.value_mgr=function(e,t,n,a,i){function r(e){return e&&1==n.types.length&&(n._mgr=e),e}var o,s,l,c,d;if(n._mgr)return n._mgr;if(1==n.types.length){if(l=n.types[0].split("."),l.length>1&&$p[l[0]])return r($p[l[0]][l[1]])}else if(i&&i.type&&(l=i.type.split("."),l.length>1&&$p[l[0]]))return r($p[l[0]][l[1]]);if(o=e.property||e.param,"value"==t&&o){if($p.utils.is_data_obj(o))s=o;else{if(!$p.utils.is_guid(o))return;s=$p.cch.properties.get(o,!1)}if($p.utils.is_data_obj(s)){if(s.is_new())return $p.cat.property_values;for(c in s.type.types)if(s.type.types[c].indexOf(".")>-1){l=s.type.types[c].split(".");break}return l&&l.length>1&&$p[l[0]]?r($p[l[0]][l[1]]):s.type}}else{if(c=[],n.types.forEach(function(e){l=e.split("."),l.length>1&&$p[l[0]][l[1]]&&c.push($p[l[0]][l[1]])}),1==c.length||e[t]==$p.utils.blank.guid)return r(c[0]);if(a)return c;if((o=e[t])instanceof DataObj)return o._manager;if($p.utils.is_guid(o)&&o!=$p.utils.blank.guid)for(var u in c)if(d=c[u],d.get(o,!1,!0))return d}},_md.control_by_type=function(e,t){var n;return n="boolean"==typeof t&&e.types.indexOf("boolean")!=-1?"ch":"number"==typeof t&&e.digits?e.fraction_figits<5?"calck":"edn":t instanceof Date&&e.date_part?"dhxCalendar":e.is_ref?"ocombo":e.date_part?"dhxCalendar":e.digits?e.fraction_figits<5?"calck":"edn":"boolean"==e.types[0]?"ch":e.hasOwnProperty("str_len")&&(e.str_len>=100||0==e.str_len)?"txt":"ed"},_md.ts_captions=function(e,t,n){n||(n={});var a,i=_md.get(e).tabular_sections[t],r=_md.get(e).form,o=i.fields;if(r&&r.obj){if(!r.obj.tabular_sections[t])return;n._mixin(r.obj.tabular_sections[t])}else{"contact_information"===t&&(o={type:"",kind:"",presentation:""}),n.fields=["row"],n.headers="№",n.widths="40",n.min_widths="",n.aligns="",n.sortings="na",n.types="cntr";for(var s in o)a=i.fields[s],a.hide||(n.fields.push(s),n.headers+=","+(a.synonym?a.synonym.replace(/,/g," "):s),n.types+=","+_md.control_by_type(a.type),n.sortings+=",na")}return!0},_md.syns_js=function(e){var n={DeletionMark:"_deleted",Description:"name",DataVersion:"data_version",IsFolder:"is_folder",Number:"number_doc",Date:"date","Дата":"date",Posted:"posted",Code:"id",Parent_Key:"parent",Owner_Key:"owner",Owner:"owner",Ref_Key:"ref","Ссылка":"ref",LineNumber:"row"};return n[e]?n[e]:t.syns_js[t.syns_1с.indexOf(e)]||e},_md.syns_1с=function(e){var n={_deleted:"DeletionMark",name:"Description",is_folder:"IsFolder",number_doc:"Number",date:"Date",posted:"Posted",id:"Code",ref:"Ref_Key",parent:"Parent_Key",owner:"Owner_Key",row:"LineNumber"};return n[e]?n[e]:t.syns_1с[t.syns_js.indexOf(e)]||e},_md.printing_plates=function(e){if(e)for(var n in e.doc)t.doc[n].printing_plates=e.doc[n]},_md.class_name_from_1c=function(e){var t=e.split(".");return 1==t.length?"enm."+e:("Перечисление"==t[0]?e="enm.":"Справочник"==t[0]?e="cat.":"Документ"==t[0]?e="doc.":"РегистрСведений"==t[0]?e="ireg.":"РегистрНакопления"==t[0]?e="areg.":"РегистрБухгалтерии"==t[0]?e="aссreg.":"ПланВидовХарактеристик"==t[0]?e="cch.":"ПланСчетов"==t[0]?e="cacc.":"Обработка"==t[0]?e="dp.":"Отчет"==t[0]&&(e="rep."),e+_md.syns_js(t[1]))},_md.class_name_to_1c=function(e){var t=e.split(".");return 1==t.length?"Перечисление."+e:("enm"==t[0]?e="Перечисление.":"cat"==t[0]?e="Справочник.":"doc"==t[0]?e="Документ.":"ireg"==t[0]?e="РегистрСведений.":"areg"==t[0]?e="РегистрНакопления.":"aссreg"==t[0]?e="РегистрБухгалтерии.":"cch"==t[0]?e="ПланВидовХарактеристик.":"cacc"==t[0]?e="ПланСчетов.":"dp"==t[0]?e="Обработка.":"rep"==t[0]&&(e="Отчет."),e+_md.syns_1с(t[1]))},_md.create_tables=function(e,t){function n(){r--,0==r?e?e(l):alasql.utils.saveFile("create_tables.sql",l):a()}function a(){var e=o[r-1];l+=e.class[e.name].get_sql_struct(t)+"; ",n()}var i,r=0,o=[],s=_md.get_classes(),l=t&&t.postgres?"":"USE md; ";"enm,cch,cacc,cat,bp,tsk,doc,ireg,areg".split(",").forEach(function(e){for(i in s[e])o.push({class:$p[e],name:s[e][i]})}),r=o.length,
a()}}function DataManager(e){var t=_md.get(e),n={after_create:[],after_load:[],before_save:[],after_save:[],value_change:[],add_row:[],del_row:[]};this.__define({cachable:{get:function(){return e.indexOf("enm.")!=-1?"ram":t.cachable?t.cachable:e.indexOf("doc.")!=-1||e.indexOf("dp.")!=-1||e.indexOf("rep.")!=-1?"doc":"ram"}},class_name:{value:e,writable:!1},alatable:{get:function(){return $p.wsql.aladb.tables[this.table_name]?$p.wsql.aladb.tables[this.table_name].data:[]}},metadata:{value:function(e){return e?t.fields[e]||t.tabular_sections[e]:t}},on:{value:function(e,t){if("object"==typeof e)for(var a in e)e.hasOwnProperty(a)&&n[a].push(e[a]);else n[e].push(t)}},off:{value:function(e,t){}},handle_event:{value:function(e,t,a){var i,r=[];if(n[t].forEach(function(t){r!==!1&&(i=t.call(e,a),i===!1?r=i:i&&r.push(i))}),r.length)return 1==r.length?r[0]:r.some(function(e){return"object"==typeof e&&e.then})?Promise.all(r):r}},by_ref:{value:{}}})}function RefDataManager(e){RefDataManager.superclass.constructor.call(this,e)}function DataProcessorsManager(e){DataProcessorsManager.superclass.constructor.call(this,e)}function EnumManager(e){EnumManager.superclass.constructor.call(this,e);var t=$p.md.get(e);for(var n in t)new EnumObj(t[n],this)}function RegisterManager(e){RegisterManager.superclass.constructor.call(this,e),this.push=function(e,t){t&&t!=e.ref?(delete this.by_ref[e.ref],this.by_ref[t]=e):this.by_ref[e.ref]=e},this.get=function(e,t,n){if(e?"string"==typeof e&&(e={ref:e}):e={},e.ref&&n)return t?Promise.resolve(this.by_ref[e.ref]):this.by_ref[e.ref];e.action="select";var a,i=$p.wsql.alasql(this.get_sql_struct(e),e._values);if(delete e.action,delete e._values,i.length)if(n)a=this.by_ref[this.get_ref(i[0])];else{a=[];for(var r in i)a.push(this.by_ref[this.get_ref(i[r])])}return t?Promise.resolve(a):a},this.unload_obj=function(e){delete this.by_ref[e],this.alatable.some(function(t,n,a){if(t.ref==e)return a.splice(n,1),!0})},this.load_array=function(e,t){for(var n,a,i=[],r=0;r<e.length;r++){if(n=this.get_ref(e[r]),a=this.by_ref[n],a||e[r]._deleted){if(a&&e[r]._deleted){a.unload();continue}(a.is_new()||t)&&(a._mixin(e[r]),a._set_loaded())}else a=new($p[this.obj_constructor()])(e[r],this),t&&a._set_loaded();i.push(a)}return i}}function InfoRegManager(e){InfoRegManager.superclass.constructor.call(this,e)}function LogManager(){LogManager.superclass.constructor.call(this,"ireg.$log");var e;this.__define({record:{value:function(t){t instanceof Error?(console&&console.log(t),t={class:"error",note:t.toString()}):"object"!=typeof t||t.class||t.obj?"object"!=typeof t&&(t={note:t}):t={class:"obj",obj:t,note:t.note},t.date=Date.now()+$p.wsql.time_diff,e||(e=alasql.compile("select MAX(`sequence`) as `sequence` from `ireg_$log` where `date` = ?"));var n=e([t.date]);n.length&&void 0!==n[0].sequence?t.sequence=parseInt(n[0].sequence)+1:t.sequence=0,t.class||(t.class="note"),$p.wsql.alasql("insert into `ireg_$log` (`ref`, `date`, `sequence`, `class`, `note`, `obj`) values (?,?,?,?,?,?)",[t.date+"¶"+t.sequence,t.date,t.sequence,t.class,t.note,t.obj?JSON.stringify(t.obj):""])}},backup:{value:function(e,t){}},restore:{value:function(e,t){}},clear:{value:function(e,t){}},show:{value:function(e){}},get:{value:function(e,t,n){if("object"==typeof e&&(e=e.ref||""),!this.by_ref[e]){if(t===!1)return;var a=e.split("¶");$p.wsql.alasql("select * from `ireg_$log` where date="+a[0]+" and sequence="+a[1]).forEach(function(e){new RegisterRow(e,this)}.bind(this))}return t?Promise.resolve(this.by_ref[e]):this.by_ref[e]}},get_sql_struct:{value:function(e){if(e&&"get_selection"==e.action){var t="select * from `ireg_$log`";return e.date_from?t+=e.date_till?" where `date` >= ? and `date` <= ?":" where `date` >= ?":e.date_till&&(t+=" where `date` <= ?"),t}return LogManager.superclass.get_sql_struct.call(this,e)}},caption_flds:{value:function(e){var t='<column id="%1" width="%2" type="%3" align="%4" sort="%5">%6</column>',n=[],a="";if(n.push(new Col_struct("date","200","ro","left","server","Дата")),n.push(new Col_struct("class","100","ro","left","server","Класс")),n.push(new Col_struct("note","*","ro","left","server","Событие")),e.get_header){a="<head>";for(var i in n)a+=t.replace("%1",n[i].id).replace("%2",n[i].width).replace("%3",n[i].type).replace("%4",n[i].align).replace("%5",n[i].sort).replace("%6",n[i].caption);a+="</head>"}return{head:a,acols:n}}},data_to_grid:{value:function(e,t){var n="<?xml version='1.0' encoding='UTF-8'?><rows total_count='%1' pos='%2' set_parent='%3'>".replace("%1",e.length).replace("%2",t.start).replace("%3",t.set_parent||""),a=this.caption_flds(t);return n+=a.head,e.forEach(function(e){n+='<row id="'+e.ref+'"><cell>'+$p.moment(e.date-$p.wsql.time_diff).format("DD.MM.YYYY HH:mm:ss")+"."+e.sequence+"</cell><cell>"+(e.class||"")+"</cell><cell>"+(e.note||"")+"</cell></row>"}),n+"</rows>"}}})}function AccumRegManager(e){AccumRegManager.superclass.constructor.call(this,e)}function CatManager(e){CatManager.superclass.constructor.call(this,e),this.metadata().hierarchical&&this.metadata().group_hierarchy&&$p[this.obj_constructor()].prototype.__define("is_folder",{get:function(){return this._obj.is_folder||!1},set:function(e){this._obj.is_folder=$p.utils.fix_boolean(e)},enumerable:!0,configurable:!0})}function ChartOfCharacteristicManager(e){ChartOfCharacteristicManager.superclass.constructor.call(this,e)}function ChartOfAccountManager(e){ChartOfAccountManager.superclass.constructor.call(this,e)}function DocManager(e){DocManager.superclass.constructor.call(this,e)}function TaskManager(e){TaskManager.superclass.constructor.call(this,e)}function BusinessProcessManager(e){BusinessProcessManager.superclass.constructor.call(this,e)}function DataObj(e,t){var n,a={},i={},r={_is_new:!(this instanceof EnumObj)};return t instanceof DataProcessorsManager||t instanceof EnumManager||(n=t.get(e,!1,!0)),n?(e=null,n):(t instanceof EnumManager?i.ref=e.name:t instanceof RegisterManager?i.ref=t.get_ref(e):i.ref=$p.utils.fix_guid(e),this.__define({_obj:{value:i,configurable:!0},_ts_:{value:function(e){return a[e]||(a[e]=new TabularSection(e,this)),a[e]},configurable:!0},_manager:{value:t},_data:{value:r,configurable:!0}}),t.alatable&&t.push&&(t.alatable.push(i),t.push(this,i.ref)),void(e=null))}function CatObj(e,t){var n="";CatObj.superclass.constructor.call(this,e,t),this.__define("presentation",{get:function(){return this.name||this.id?this.name||this.id||this._metadata.obj_presentation||this._metadata.synonym:n},set:function(e){e&&(n=String(e))}}),e&&"object"==typeof e&&(e._not_set_loaded?(delete e._not_set_loaded,this._mixin(e)):(this._mixin(e),$p.utils.is_empty_guid(this.ref)||!e.id&&!e.name||this._set_loaded(this.ref))),e=null}function DocObj(e,t){var n="";DocObj.superclass.constructor.call(this,e,t),this.__define("presentation",{get:function(){return this.number_doc?(this._metadata.obj_presentation||this._metadata.synonym)+" №"+this.number_doc+" от "+$p.moment(this.date).format($p.moment._masks.ldt):n},set:function(e){e&&(n=String(e))}}),e&&"object"==typeof e&&this._mixin(e),!$p.utils.is_empty_guid(this.ref)&&e.number_doc&&this._set_loaded(this.ref),e=null}function doc_props_date_number(e){e.__define({number_doc:{get:function(){return this._obj.number_doc||""},set:function(e){this.__notify("number_doc"),this._obj.number_doc=e},enumerable:!0},date:{get:function(){return this._obj.date||$p.utils.blank.date},set:function(e){this.__notify("date"),this._obj.date=$p.utils.fix_date(e,!0)},enumerable:!0}})}function DataProcessorObj(e,t){DataProcessorObj.superclass.constructor.call(this,e,t);var n,a=t.metadata();for(n in a.fields)e[n]=$p.utils.fetch_type("",a.fields[n].type);for(n in a.tabular_sections)e[n]=[];this._mixin(e)}function TaskObj(e,t){TaskObj.superclass.constructor.call(this,e,t)}function BusinessProcessObj(e,t){BusinessProcessObj.superclass.constructor.call(this,e,t)}function EnumObj(e,t){EnumObj.superclass.constructor.call(this,e,t),e&&"object"==typeof e&&this._mixin(e)}function RegisterRow(e,t){RegisterRow.superclass.constructor.call(this,e,t),e&&"object"==typeof e&&this._mixin(e);for(var n in t.metadata().dimensions)if(!e.hasOwnProperty(n)&&e.ref){var a=e.ref.split("¶");Object.keys(t.metadata().dimensions).forEach(function(e,t){this[e]=a[t]}.bind(this));break}}function TabularSection(e,t){t._obj[e]||(t._obj[e]=[]),this.__define("_name",{value:e,enumerable:!1}),this.__define("_owner",{value:t,enumerable:!1}),this.__define("_obj",{value:t._obj[e],writable:!1,enumerable:!1})}function TabularSectionRow(e){var t={};this.__define("_owner",{value:e,enumerable:!1}),this.__define("_obj",{value:t,writable:!1,enumerable:!1})}function Rest(){this.filter_date=function(e,t,n){t||(t=new Date("2015-01-01"));var a=e+" gt datetime'"+$p.moment(t).format($p.moment._masks.iso)+"'";return n&&(a+=" and "+e+" lt datetime'"+$p.moment(n).format($p.moment._masks.iso)+"'"),a},this.to_data=function(e,t){var n,a,i,r,o,s,l={},c=t.metadata(),d=c.fields,u=c.tabular_sections;t instanceof RefDataManager?(e.hasOwnProperty("DeletionMark")&&(l._deleted=e.DeletionMark),e.hasOwnProperty("DataVersion"),e.hasOwnProperty("Ref_Key")&&(l.ref=e.Ref_Key)):d={}._mixin(c.dimensions)._mixin(c.resources)._mixin(c.attributes),t instanceof DocManager?(e.hasOwnProperty("Number")?l.number_doc=e.Number||e.number_doc:e.hasOwnProperty("number_doc")&&(l.number_doc=e.number_doc),e.hasOwnProperty("Date")?l.date=e.Date:e.hasOwnProperty("date")&&(l.date=e.date),e.hasOwnProperty("Posted")?l.posted=e.Posted:e.hasOwnProperty("posted")&&(l.posted=e.posted)):(c.main_presentation_name&&(e.hasOwnProperty("Description")?l.name=e.Description:e.hasOwnProperty("name")&&(l.name=e.name)),c.code_length&&(e.hasOwnProperty("Code")?l.id=e.Code:e.hasOwnProperty("id")&&(l.id=e.id)));for(a in d)if(e.hasOwnProperty(a))l[a]=e[a];else{if(o=_md.syns_1с(a),o.indexOf("_Key")==-1&&d[a].type.is_ref&&e[o+"_Key"]&&(o+="_Key"),!e.hasOwnProperty(o))continue;l[a]=e[o]}for(n in u)s="extra_fields"==n||e.hasOwnProperty(n)?n:_md.syns_1с(n),e.hasOwnProperty(s)&&(l[n]=[],e[s]&&(e[s].sort(function(e,t){return(e.LineNumber||e.row)>(t.LineNumber||t.row)}),e[s].forEach(function(e){r={};for(i in u[n].fields)o=e.hasOwnProperty(i)||"extra_fields"==n&&("property"==i||"value"==i)?i:_md.syns_1с(i),o.indexOf("_Key")==-1&&u[n].fields[i].type.is_ref&&e[o+"_Key"]&&(o+="_Key"),r[i]=e[o];l[n].push(r)})));return l},this.ajax_to_data=function(e,t){return $p.ajax.get_ex(e.url,e).then(function(e){return JSON.parse(e.response)}).then(function(e){var n=[];return e.value.forEach(function(e){n.push(_rest.to_data(e,t))}),n})},this.build_select=function(e,t){function n(e,a){"function"==typeof a?r+=a(t,e):(o=_md.syns_1с(e),s=_md.get(t.class_name,e),s&&(s=s.type,s.is_ref&&o.indexOf("_Key")==-1&&s.types.length&&s.types[0].indexOf("enm.")==-1&&(o+="_Key"),s.types.length&&(["boolean","number"].indexOf(typeof a)!=-1?r+=o+" eq "+a:s.is_ref&&"object"!=typeof a||a instanceof DataObj?r+=o+" eq guid'"+a+"'":"string"==typeof a?r+=o+" eq '"+a+"'":"object"==typeof a&&(a.hasOwnProperty("like")?r+=o+" like '%"+a.like+"%'":a.hasOwnProperty("not")?r+=" not ("+n(e,a.not)+") ":a.hasOwnProperty("in")&&(r+=o+" in ("+(s.is_ref?a.in.map(function(e){return"guid'"+e+"'"}).join(","):a.in.join(","))+") ")))))}function a(e){for(var t in e)if(r?r+=" and ":r="&$filter=","or"==t&&Array.isArray(e[t])){var a=!0;e[t].forEach(function(e){a?(r+=" ( ",a=!1):r+=" or ";var t=Object.keys(e)[0];n(t,e[t])}),r+=" ) "}else n(t,e[t])}var i,r,o,s,l="";e||(e={}),e.fields&&(e.fields.forEach(function(e){"ref"==e?o="Ref_Key":(o=_md.syns_1с(e),s=_md.get(t.class_name,e).type,s.is_ref&&o.indexOf("_Key")==-1&&s.types.length&&s.types[0].indexOf("enm.")==-1&&(o+="_Key")),i?i+=",":i="&$select=",i+=o}),l+=i),e.selection&&("function"==typeof e.selection||(Array.isArray(e.selection)?e.selection.forEach(a):a(e.selection)),r&&(l+=r)),$p.job_prm.rest&&t.rest_name.indexOf("Module_")==-1&&t.rest_name.indexOf("DataProcessor_")==-1&&t.rest_name.indexOf("Report_")==-1&&l.indexOf(" like ")==-1&&l.indexOf(" in ")==-1&&!t.metadata().irest?$p.ajax.default_attr(e,$p.job_prm.rest_url()):$p.ajax.default_attr(e,$p.job_prm.irest_url()),e.url+=t.rest_name+"?allowedOnly=true&$format=json&$top="+(e.top||300)+l},this.load_array=function(e,t){return _rest.build_select(e,t),_rest.ajax_to_data(e,t)},this.load_obj=function(e){var t={};return $p.ajax.default_attr(t,!e._metadata.irest&&$p.job_prm.rest?$p.job_prm.rest_url():$p.job_prm.irest_url()),t.url+=e._manager.rest_name+"(guid'"+e.ref+"')?$format=json",$p.ajax.get_ex(t.url,t).then(function(e){return JSON.parse(e.response)}).then(function(t){return e._mixin(_rest.to_data(t,e._manager))._set_loaded(),e}).catch(function(t){return 404==t.status?e:void $p.record_log(t)})},this.save_irest=function(e,t){var n=JSON.stringify(e),a=(void 0!=t.post?",post="+t.post:"")+(void 0!=t.operational?",operational="+t.operational:"");return $p.ajax.default_attr(t,$p.job_prm.irest_url()),t.url+=e._manager.rest_name+"(guid'"+e.ref+"'"+a+")",$p.ajax.post_ex(t.url,n,t).then(function(e){return JSON.parse(e.response)}).then(function(t){return e._mixin(t)})},this.save_rest=function(e,t){var n,a=e.to_atom();return $p.ajax.default_attr(t,$p.job_prm.rest_url()),n=t.url+e._manager.rest_name,t.url=n+"(guid'"+e.ref+"')?$format=json&$select=Ref_Key,DeletionMark",$p.ajax.get_ex(t.url,t).catch(function(e){return 404==e.status?{response:JSON.stringify({is_new:!0})}:Promise.reject(e)}).then(function(e){return JSON.parse(e.response)}).then(function(i){return i.is_new?$p.ajax.post_ex(n,a,t):$p.ajax.patch_ex(n+"(guid'"+e.ref+"')",a,t)}).then(function(t){var n=xmlToJSON.parseString(t.response,{mergeCDATA:!1,grokAttr:!0,grokText:!1,normalize:!0,xmlns:!1,namespaceKey:"_ns",textKey:"_text",valueKey:"_value",attrKey:"_attr",cdataKey:"_cdata",attrsAsObject:!1,stripAttrPrefix:!0,stripElemPrefix:!0,childrenAsArray:!1});if(n.entry&&n.entry.content&&n.entry.updated){var a,i=n.entry.content.properties,r={};for(var o in i)if(0!=o.indexOf("_"))if(a=i[o].element)if(r[o]=[],Array.isArray(a))for(var s in a){r[o][s]={};for(var l in a[s])0!=l.indexOf("_")&&(r[o][s][l]="false"!==a[s][l]._text&&a[s][l]._text)}else{r[o][0]={};for(var l in a)0!=l.indexOf("_")&&(r[o][0][l]="false"!==a[l]._text&&a[l]._text)}else r[o]="false"!==i[o]._text&&i[o]._text;return _rest.to_data(r,e._manager)}}).then(function(t){return e._mixin(t)})}}function eXcell_ocombo(e){if(e){var t=this;t.cell=e,t.grid=e.parentNode.grid,t.setValue=function(e){t.setCValue(e instanceof DataObj?e.presentation:e||"")},t.getValue=function(){return t.grid.get_cell_value()},t.shiftNext=function(){t.grid.editStop()},t.edit=function(){t.combo||(t.val=t.getValue(),t.cell.innerHTML="",t.combo=new OCombo({parent:t.cell}._mixin(t.grid.get_cell_field())),t.combo.getInput().focus())},t.detach=function(){if(t.combo){if(t.combo.getComboText){t.setValue(t.combo.getComboText()),t.combo.getSelectedValue()||t.combo.callEvent("onChange");var e=!$p.utils.is_equal(t.val,t.getValue());return t.combo.unload(),e}t.combo.unload&&t.combo.unload()}return!0}}}function eXcell_pwd(e){var t;e&&(this.cell=e,this.grid=e.parentNode.grid,eXcell_ed.call(this),t=this.edit,this.edit=function(){t.call(this),this.obj.type="password"},this.setValue=function(){this.setCValue("*********")},this.getValue=function(){return this.grid.get_cell_value()},this.detach=function(){if(this.grid.get_cell_field){var e=this.grid.get_cell_field();e.obj[e.field]=this.obj.value}return this.setValue(),t=null,this.val!=this.getValue()})}function ODropdownList(e){function t(t){r.innerHTML=e.values[r.getAttribute("current")],e.event_name&&!t&&dhx4.callEvent(e.event_name,[r.getAttribute("current")])}function n(){i.classList.remove("open")}var a,i,r,o=document.createElement("ul");e.container.innerHTML='<div class="dropdown_list">'+e.title+'<a href="#" class="dropdown_list"></a></div>',i=e.container.firstChild,r=i.querySelector("a"),r.setAttribute("current",Array.isArray(e.values)?"0":Object.keys(e.values)[0]),i.onclick=function(e){if(i.classList.contains("open")){if("LI"==e.target.tagName)for(var a in o.childNodes)if(o.childNodes[a]==e.target){r.setAttribute("current",e.target.getAttribute("current")),t();break}n()}else i.classList.add("open");return $p.iface.cancel_bubble(e)},i.appendChild(o),o.className="dropdown_menu",e.class_name&&(i.classList.add(e.class_name),o.classList.add(e.class_name));for(var s in e.values){a=document.createElement("li");var l=e.values[s].indexOf("<i");a.innerHTML=e.values[s].substr(l)+" "+e.values[s].substr(0,l),a.setAttribute("current",s),o.appendChild(a)}document.body.addEventListener("keydown",function(e){27==e.keyCode&&i.classList.remove("open")}),document.body.addEventListener("click",n),this.unload=function(){for(var t;t=i.lastChild;)i.removeChild(t);e.container.removeChild(i),a=o=i=r=e=null},t(!0)}function OCombo(e){function t(e){var t={_top:30};return p&&p.metadata().hierarchical&&p.metadata().group_hierarchy&&("elm"==f.choice_groups_elm?t.is_folder=!1:"grp"!=f.choice_groups_elm&&"parent"!=u||(t.is_folder=!0)),f.choice_links&&f.choice_links.forEach(function(e){e.name&&"selection"==e.name[0]&&(d instanceof TabularSectionRow?e.path.length<2?t[e.name[1]]="function"==typeof e.path[0]?e.path[0]:d._owner._owner[e.path[0]]:t[e.name[1]]=d[e.path[1]]:t[e.name[1]]="function"==typeof e.path[0]?e.path[0]:d[e.path[0]])}),f.choice_params&&f.choice_params.forEach(function(e){var n=Array.isArray(e.path)?{in:e.path}:e.path;t[e.name]?Array.isArray(t[e.name])?t[e.name].push(n):(t[e.name]=[t[e.name]],t[e.name].push(n)):t[e.name]=n}),f._option_list_local&&(t._local=!0),e&&(t.presentation={like:e}),t}function n(a){if("select"==this.name)p?p.form_selection(g,{initial_value:d[u].ref,selection:[t()]}):n.call({name:"type"});else if("add"==this.name)p&&p.create({},!0).then(function(t){t._set_loaded(t.ref),t.form_obj(e.pwnd)});else if("open"==this.name)d&&d[u]&&!d[u].empty()&&d[u].form_obj(e.pwnd);else if("type"==this.name){var i,r,o=[],s=d,l=u;f.type.types.forEach(function(e){i=_md.mgr_by_class_name(e),r=i.metadata(),o.push({presentation:r.synonym||r.name,mgr:i,selected:p===i})}),$p.iface.select_from_list(o).then(function(e){(!s[l]||s[l]&&s[l]._manager!=e.mgr)&&(p=e.mgr,d=s,u=l,f=d._metadata.fields[u],p.form_selection({on_select:function(e){d[u]=e,d=null,u=null,f=null}},{selection:[t()]})),p=null,i=null,r=null,s=null,l=null})}if(a)return $p.iface.cancel_bubble(a)}function a(){h=!1,setTimeout(function(){h||($p.iface.popup.p&&$p.iface.popup.p.onmouseover&&($p.iface.popup.p.onmouseover=null),$p.iface.popup.p&&$p.iface.popup.p.onmouseout&&($p.iface.popup.p.onmouseout=null),$p.iface.popup.clear(),$p.iface.popup.hide())},300)}function i(){if(!(p instanceof EnumManager)){h=!0;var e=document.createElement("div"),t="<a href='#' name='select' title='Форма выбора {F4}'>Показать все</a><a href='#' name='open' style='margin-left: 9px;' title='Открыть форму элемента {Ctrl+Shift+F4}'><i class='fa fa-external-link fa-fw'></i></a>";$p.ajax.root&&(t+="&nbsp;<a href='#' name='add' title='Создать новый элемент {F8}'><i class='fa fa-plus fa-fwfa-fw'></i></a>"),f.type.types.length>1&&(t+="&nbsp;<a href='#' name='type' title='Выбрать тип значения {Alt+T}'><i class='fa fa-level-up fa-fw'></i></a>"),e.innerHTML=t;for(var i=0;i<e.children.length;i++)e.children[i].onclick=n;$p.iface.popup.clear(),$p.iface.popup.attachObject(e),$p.iface.popup.show(dhx4.absLeft(m.getButton())-77,dhx4.absTop(m.getButton()),m.getButton().offsetWidth,m.getButton().offsetHeight),$p.iface.popup.p.onmouseover=function(){h=!0},$p.iface.popup.p.onmouseout=a}}function r(e){return setTimeout(i,10),e.preventDefault(),!1}function o(n){if(!(p instanceof EnumManager))return 115==n.keyCode?(n.ctrlKey&&n.shiftKey?d[u].empty()||d[u].form_obj(e.pwnd):n.ctrlKey||n.shiftKey||p&&p.form_selection(g,{initial_value:d[u].ref,selection:[t()]}),$p.iface.cancel_bubble(n)):void 0}function s(e){setTimeout(function(){m&&m.getInput&&m.getInput().select()},50)}function l(e){m&&m.getBase&&(m.getBase().parentElement?d instanceof TabularSectionRow||e.forEach(function(e){e.name==u&&c(d[u])}):setTimeout(m.unload))}function c(e){if(e&&e instanceof DataObj&&!e.empty()){if(m.getOption(e.ref)||m.addOption(e.ref,e.presentation),m.getSelectedValue()==e.ref)return;m.setComboValue(e.ref)}else m.getSelectedValue()||(m.setComboValue(""),m.setComboText(""))}var d,u,f,p,_,h,m=this,g={on_select:e.on_select||function(e){d[u]=e}};e.pwnd&&e.pwnd.setModal&&(g.setModal=e.pwnd.setModal.bind(e.pwnd)),OCombo.superclass.constructor.call(m,e),e.on_select?(m.getBase().style.border="none",m.getInput().style.left="-3px",e.is_tabular||(m.getButton().style.right="9px")):m.getBase().style.marginBottom="4px",e.left&&(m.getBase().style.left=left+"px"),this.attachEvent("onChange",function(){d&&u&&(d[u]=this.getSelectedValue())}),this.attachEvent("onBlur",function(){!this.getSelectedValue()&&this.getComboText()&&this.setComboText("")}),this.attachEvent("onDynXLS",function(e){p||(p=_md.value_mgr(d,u,f.type)),p&&(m.clearAll(),p.get_option_list(null,t(e)).then(function(e){m.addOption&&(m.addOption(e),m.openSelect())}))}),m.getButton().addEventListener("mouseover",i),m.getButton().addEventListener("mouseout",a),m.getBase().addEventListener("click",$p.iface.cancel_bubble),m.getBase().addEventListener("contextmenu",r),m.getInput().addEventListener("keyup",o),m.getInput().addEventListener("focus",s),this.attach=function(e){d&&(d instanceof TabularSectionRow?Object.unobserve(d._owner._owner,l):Object.unobserve(d,l)),d=e.obj,u=e.field,_=e.property,e.metadata?f=e.metadata:_?(f=d._metadata.fields[u]._clone(),f.type=_.type):f=d._metadata.fields[u],m.clearAll(),p=_md.value_mgr(d,u,f.type),(p||e.get_option_list)&&(e.get_option_list||p.get_option_list).call(p,d[u],t()).then(function(e){m.addOption&&(m.addOption(e),c(d[u]))}),d instanceof TabularSectionRow?Object.observe(d._owner._owner,l,["row"]):Object.observe(d,l,["update"])};var b=this.unload;this.unload=function(){a(),m.getButton().removeEventListener("mouseover",i),m.getButton().removeEventListener("mouseout",a),m.getBase().removeEventListener("click",$p.iface.cancel_bubble),m.getBase().removeEventListener("contextmenu",r),m.getInput().removeEventListener("keyup",o),m.getInput().removeEventListener("focus",s),d&&(d instanceof TabularSectionRow?Object.unobserve(d._owner._owner,l):Object.unobserve(d,l)),m.conf&&m.conf.tm_confirm_blur&&clearTimeout(m.conf.tm_confirm_blur),d=null,u=null,f=null,p=null,g=null;try{b.call(m)}catch(e){}},e.obj&&e.field&&this.attach(e),this.enableFilteringMode("between","dummy",!1,!1),this.__define({value:{get:function(){if(d)return d[u]}}})}function ODateRangePicker(e,t){var n=this._cont=document.createElement("div");e instanceof dhtmlXCellObject?e.appendObject(this._cont):e.appendChild(this._cont),this._cont.style="cursor: pointer; padding: 6px 0 6px 8px; width: 100%; font-size: 90%",this._cont.innerHTML='<i class="fa fa-calendar"></i>&nbsp; <span></span> &nbsp;<i class="fa fa-caret-down"></i>',this.__define({set_text:{value:function(){$("span",n).html(this.date_from.format("DD MMM YY")+" - "+this.date_till.format("DD MMM YY"))}},on:{value:function(e,t){return $(n).on(e,t)}},date_from:{get:function(){return $(n).data("daterangepicker").startDate},set:function(e){$(n).data("daterangepicker").setStartDate(e),this.set_text()}},date_till:{get:function(){return $(n).data("daterangepicker").endDate},set:function(e){$(n).data("daterangepicker").setEndDate(e),this.set_text()}}}),$(n).daterangepicker({startDate:t.date_from?moment(t.date_from):moment().subtract(29,"days"),endDate:moment(t.date_till),showDropdowns:!0,alwaysShowCalendars:!0,opens:"left",ranges:{"Сегодня":[moment(),moment()],"Вчера":[moment().subtract(1,"days"),moment().subtract(1,"days")],"Последние 7 дней":[moment().subtract(6,"days"),moment()],"Последние 30 дней":[moment().subtract(29,"days"),moment()],"Этот месяц":[moment().startOf("month"),moment().endOf("month")],"Прошлый месяц":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")]}},this.set_text.bind(this)),this.set_text()}function _clear_all(){$p.iface.docs.__define({clear_all:{value:function(){this.detachToolbar(),this.detachStatusBar(),this.detachObject(!0)},enumerable:!1},"Очистить":{get:function(){return this.clear_all},enumerable:!1},"Контейнер":{get:function(){return this.cell.querySelector(".dhx_cell_cont_layout")},enumerable:!1}})}function OTooolBar(e){function t(e){for(var t=0;t<c.children.length;t++)c.children[t].classList.remove("selected");e&&!this.classList.contains("selected")&&this.classList.add("selected")}function n(){r=!1,setTimeout(function(){r||$p.iface.popup.hide()},300)}function a(){e.onclick&&e.onclick.call(l,this.name.replace(e.name+"_",""),e.name)}var i,r,o,s,l=this,c=document.createElement("div");e.image_path||(e.image_path=dhtmlx.image_path),e.hasOwnProperty("class_name")?c.className=e.class_name:c.className="md_otooolbar",l.cell=c,l.buttons={},this.add=function(t){function d(e){if(e||(e=u),e.subdiv&&!o&&!s){for(;e.subdiv.firstChild;)e.subdiv.removeChild(e.subdiv.firstChild);e.subdiv.parentNode.removeChild(e.subdiv),e.subdiv=null}}var u=$p.iface.add_button(c,e,t);u.onclick=a,u.onmouseover=function(){t.title&&!t.sub&&(r=!0,$p.iface.popup.clear(),$p.iface.popup.attachHTML(t.title),$p.iface.popup.show(dhx4.absLeft(u),dhx4.absTop(u),u.offsetWidth,u.offsetHeight),$p.iface.popup.p.onmouseover=function(){r=!0},$p.iface.popup.p.onmouseout=n,e.on_popup&&e.on_popup($p.iface.popup,u))},u.onmouseout=n,l.buttons[t.name]=u,t.sub&&(u.onmouseover=function(){for(var n=0;n<u.parentNode.children.length;n++)if(u.parentNode.children[n]!=u&&u.parentNode.children[n].subdiv){d(u.parentNode.children[n]);break}if(s=!0,!this.subdiv){this.subdiv=document.createElement("div"),this.subdiv.className="md_otooolbar",i=$p.iface.get_offset(u),"right"==t.sub.align?this.subdiv.style.left=i.left+u.offsetWidth-(parseInt(t.sub.width.replace(/\D+/g,""))||56)+"px":this.subdiv.style.left=i.left+"px",this.subdiv.style.top=i.top+c.offsetHeight+"px",this.subdiv.style.height=t.sub.height||"198px",this.subdiv.style.width=t.sub.width||"56px";for(var n in t.sub.buttons){var r=$p.iface.add_button(this.subdiv,e,t.sub.buttons[n]);r.onclick=a}e.wrapper.appendChild(this.subdiv),this.subdiv.onmouseover=function(){o=!0},this.subdiv.onmouseout=function(){o=!1,setTimeout(d,500)},t.title&&$p.iface.popup.show(dhx4.absLeft(this.subdiv),dhx4.absTop(this.subdiv),this.subdiv.offsetWidth,this.subdiv.offsetHeight)}},u.onmouseout=function(){s=!1,setTimeout(d,500)})},this.select=function(n){for(var a=0;a<c.children.length;a++){var i=c.children[a];if(i.name==e.name+"_"+n)return void t.call(i,!0)}},this.get_selected=function(){for(var e=0;e<c.children.length;e++){var t=c.children[e];if(t.classList.contains("selected"))return t.name}},this.unload=function(){for(;c.firstChild;)c.removeChild(c.firstChild);e.wrapper.removeChild(c)},e.wrapper.appendChild(c),c.style.width=e.width||"28px",c.style.height=e.height||"150px",c.style.position="absolute",e.top&&(c.style.top=e.top),e.left&&(c.style.left=e.left),e.bottom&&(c.style.bottom=e.bottom),e.right&&(c.style.right=e.right),e.paddingRight&&(c.style.paddingRight=e.paddingRight),e.paddingLeft&&(c.style.paddingLeft=e.paddingLeft),e.buttons&&e.buttons.forEach(function(e){l.add(e)})}function eXcell_addr(e){if(e){var t,n=this,a=function(e){return eXcell_proto.input_keydown(e,n)},i=function(e){var t={grid:n.grid}._mixin(n.grid.get_cell_field());return wnd_address(t),$p.iface.cancel_bubble(e)};n.cell=e,n.grid=n.cell.parentNode.grid,n.open_selection=i,n.setValue=function(e){n.setCValue(e)},n.getValue=function(){return n.grid.get_cell_value()},n.edit=function(){var e;n.val=n.getValue(),n.cell.innerHTML='<div class="ref_div21"><input type="text" class="dhx_combo_edit" style="height: 20px;"><div class="ref_field21">&nbsp;</div></div>',t=n.cell.firstChild,e=t.childNodes[0],e.value=n.val,e.onclick=$p.iface.cancel_bubble,e.readOnly=!0,e.focus(),e.onkeydown=a,t.childNodes[1].onclick=i},n.detach=function(){return n.setValue(n.getValue()),!$p.utils.is_equal(n.val,n.getValue())}}}function wnd_address(e){function t(){var e={name:"wnd_addr",wnd:{id:"wnd_addr",top:130,left:200,width:800,height:560,modal:!0,center:!0,pwnd:g,allow_close:!0,allow_minmax:!0,on_close:_,caption:m.shipping_address}};g&&g.getHeight&&e.wnd.height>g.getHeight()&&(e.wnd.height=g.getHeight()),h=$p.iface.dat_blank(null,e.wnd),h.elmnts.layout=h.attachLayout("2E"),h.elmnts.cell_frm=h.elmnts.layout.cells("a"),h.elmnts.cell_frm.setHeight("110"),h.elmnts.cell_frm.hideHeader(),h.elmnts.cell_frm.fixSize(0,1),h.elmnts.pgrid=h.elmnts.cell_frm.attachPropertyGrid(),h.elmnts.pgrid.setDateFormat("%d.%m.%Y %H:%i"),h.elmnts.pgrid.init(),h.elmnts.pgrid.parse(m._manager.get_property_grid_xml({" ":[{id:"delivery_area",path:"o.delivery_area",synonym:"Район доставки",type:"ref",txt:y.delivery_area.presentation},{id:"region",path:"o.region",synonym:"Регион",type:"ro",txt:y.region},{id:"city",path:"o.city",synonym:"Населенный пункт",type:"ed",txt:y.city},{id:"street",path:"o.street",synonym:"Улица, дом, корпус, литера, квартира",type:"ed",txt:y.street}]},y),function(){h.elmnts.pgrid.enableAutoHeight(!0),h.elmnts.pgrid.setInitWidthsP("40,60"),h.elmnts.pgrid.setSizes(),h.elmnts.pgrid.attachEvent("onPropertyChanged",p)},"xml"),h.elmnts.pgrid.get_cell_field=function(){return{obj:y,field:"delivery_area",on_select:a,pwnd:h,metadata:{synonym:"Район",tooltip:"Район (зона, направление) доставки для группировки при планировании и оптимизации маршрута геокодером",choice_groups_elm:"elm",type:{types:["cat.delivery_areas"],is_ref:!0}}}},h.elmnts.toolbar=h.attachToolbar({icons_path:dhtmlx.image_path+"dhxtoolbar"+dhtmlx.skin_suffix()}),h.elmnts.toolbar.loadStruct('<toolbar><item id="btn_select" type="button" title="Установить адрес" text="&lt;b&gt;Выбрать&lt;/b&gt;" /></toolbar>',function(){this.attachEvent("onclick",n)}),h.elmnts.cell_map=h.elmnts.layout.cells("b"),h.elmnts.cell_map.hideHeader();var t={center:new google.maps.LatLng(y.latitude,y.longitude),zoom:y.street?15:12,mapTypeId:google.maps.MapTypeId.ROADMAP};h.elmnts.map=h.elmnts.cell_map.attachMap(t),y.marker=new google.maps.Marker({map:h.elmnts.map,draggable:!0,animation:google.maps.Animation.DROP,position:t.center}),google.maps.event.addListener(y.marker,"click",u),google.maps.event.addListener(y.marker,"dragend",f),r()}function n(e){"btn_select"==e&&(m.delivery_area=y.delivery_area,l(),m.coordinates=JSON.stringify([y.latitude,y.longitude])),h.close()}function a(e){if(void 0!==e){var t,n=b;b=$p.utils.is_data_obj(e)?e:$p.cat.delivery_areas.get(e,!1),t=n!=b,$p.utils.is_data_obj(b)||(b=$p.cat.delivery_areas.get()),h.elmnts.pgrid.cells().setValue(e.presentation),i(t)}}function i(e){if(!y.delivery_area.empty()&&e&&(y.street=""),y.delivery_area.region?(y.region=y.delivery_area.region,h.elmnts.pgrid.cells("region",1).setValue(y.region)):e&&(y.region=""),y.delivery_area.city?(y.city=y.delivery_area.city,h.elmnts.pgrid.cells("city",1).setValue(y.city)):e&&(y.city=""),y.delivery_area.latitude&&y.delivery_area.longitude){var t=new google.maps.LatLng(y.delivery_area.latitude,y.delivery_area.longitude);h.elmnts.map.setCenter(t),y.marker.setPosition(t)}r()}function r(){h.elmnts.pgrid.cells("region",1).setValue(y.region),h.elmnts.pgrid.cells("city",1).setValue(y.city),h.elmnts.pgrid.cells("street",1).setValue(y.street)}function o(){var e=y.street?15:12;h.elmnts.map.getZoom()!=e&&h.elmnts.map.setZoom(e),d(function(e,t){if(t==google.maps.GeocoderStatus.OK){var n=e[0].geometry.location;h.elmnts.map.setCenter(n),y.marker.setPosition(n),y.latitude=n.lat(),y.longitude=n.lng(),y.postal_code=$p.ipinfo.components({},e[0].address_components).postal_code||""}})}function s(){return(y.street?y.street.replace(/,/g," ")+", ":"")+(y.city?y.city+", ":"")+(y.region?y.region+", ":"")+y.country+(y.postal_code?", "+y.postal_code:"")}function l(){m.shipping_address=s();var e='<КонтактнаяИнформация  \t\t\t\txmlns="http://www.v8.1c.ru/ssl/contactinfo" \t\t\t\txmlns:xs="http://www.w3.org/2001/XMLSchema" \t\t\t\txmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"   \t\t\t\tПредставление="%1">   \t\t\t\t\t<Комментарий/>  \t\t\t\t\t<Состав xsi:type="Адрес" Страна="РОССИЯ">   \t\t\t\t\t\t<Состав xsi:type="АдресРФ">'.replace("%1",m.shipping_address);
if(y.region&&(e+="\n<СубъектРФ>"+y.region+"</СубъектРФ>"),y.city&&(e+=y.city.indexOf("г.")!=-1||y.city.indexOf("г ")!=-1||y.city.indexOf(" г")!=-1?"\n<Город>"+y.city+"</Город>":"\n<НаселПункт>"+y.city+"</НаселПункт>"),y.street){var t,n,a,i,r,o=y.street.replace(/,/g," ");for(var l in $p.fias){if(1==$p.fias[l].type)for(var c in $p.fias[l].syn)if((n=o.indexOf($p.fias[l].syn[c]))!=-1){i=l,t=o.substr(n+$p.fias[l].syn[c].length).trim(),o=o.substr(0,n).trim();break}if(i)break}if(i||(i="1010",(n=o.indexOf(" "))!=-1&&(t=o.substr(n),o=o.substr(0,n))),e+="\n<Улица>"+o.trim()+"</Улица>",t){a=t.toLowerCase(),t="";for(var l in $p.fias){if(3==$p.fias[l].type)for(var c in $p.fias[l].syn)if((n=a.indexOf($p.fias[l].syn[c]))!=-1){r=l,t=a.substr(n+$p.fias[l].syn[c].length),a=a.substr(0,n);break}if(r)break}r||(r="2010",(n=a.indexOf(" "))!=-1&&(t=a.substr(n),a=a.substr(0,n))),e+='\n<ДопАдрЭл><Номер Тип="'+i+'" Значение="'+a.trim()+'"/></ДопАдрЭл>'}t&&(e+='\n<ДопАдрЭл><Номер Тип="'+r+'" Значение="'+t.trim()+'"/></ДопАдрЭл>')}y.postal_code&&(e+='<ДопАдрЭл ТипАдрЭл="10100000" Значение="'+y.postal_code+'"/>'),e+="</Состав> \t\t\t\t\t</Состав></КонтактнаяИнформация>",m.address_fields=e}function c(){function e(e){if(e.attributes&&2==e.attributes.length){var t={};return t[e.attributes[0].value]=e.attributes[1].value,t}}if(m.address_fields){y.xml=(new DOMParser).parseFromString(m.address_fields,"text/xml");var t,n={},a={building_room:""},i=[],r="СубъектРФ,Округ,СвРайМО,СвРайМО,ВнутригРайон,НаселПункт,Улица,Город,ДопАдрЭл,Адрес_по_документу,Местоположение".split(",");for(var o in r)n[r[o]]=y.xml.getElementsByTagName(r[o]);for(var o in n)for(var s in n[o])if("length"!=s&&n[o].hasOwnProperty(s))if(t=e(n[o][s]))a[o]||(a[o]=[]),a[o].push(t);else if(n[o][s].childNodes.length)for(var l in n[o][s].childNodes)"length"!=l&&n[o][s].childNodes.hasOwnProperty(l)&&((t=e(n[o][s].childNodes[l]))?(a[o]||(a[o]=[]),a[o].push(t)):n[o][s].childNodes[l].nodeValue&&(a[o]?a[o]+=" "+n[o][s].childNodes[l].nodeValue:a[o]=n[o][s].childNodes[l].nodeValue));for(var o in a["ДопАдрЭл"]){for(var s in $p.fias)4==s.length&&a["ДопАдрЭл"][o][s]&&(i[$p.fias[s].type]=$p.fias[s].name+" "+a["ДопАдрЭл"][o][s]);a["ДопАдрЭл"][o][101e5]&&(y.postal_code=a["ДопАдрЭл"][o][101e5])}y.address_fields=a,y.region=a["СубъектРФ"]||a["Округ"]||"",y.city=a["Город"]||a["НаселПункт"]||"",y.street=a["Улица"]||"";for(var o in i)y.street+=" "+i[o]}return new Promise(function(e,t){if($p.ipinfo||($p.ipinfo=new IPInfo),window.google&&window.google.maps)e();else{$p.load_script("//maps.google.com/maps/api/js?callback=$p.ipinfo.location_callback","script",function(){});var n=$p.eve.attachEvent("geo_google_ready",function(){a&&clearTimeout(a),n&&($p.eve.detachEvent(n),n=null,e())}),a=setTimeout(function(){n&&($p.eve.detachEvent(n),n=null),$p.msg.show_msg({type:"alert-warning",text:$p.msg.error_geocoding+" Google",title:$p.msg.main_title}),e()},1e4)}}).then(function(){y.coordinates.length?(y.latitude=y.coordinates[0],y.longitude=y.coordinates[1]):m.shipping_address?d(function(e,t){t==google.maps.GeocoderStatus.OK&&(y.latitude=e[0].geometry.location.lat(),y.longitude=e[0].geometry.location.lng())}):$p.ipinfo.latitude&&$p.ipinfo.longitude?(y.latitude=$p.ipinfo.latitude,y.longitude=$p.ipinfo.longitude):(y.latitude=55.635924,y.longitude=37.6066379,$p.msg.show_msg($p.msg.empty_geocoding))})}function d(e){var t=s();$p.ipinfo.ggeocoder.geocode({address:t},e)}function u(){null!=y.marker.getAnimation()?y.marker.setAnimation(null):(y.marker.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){y.marker.setAnimation(null)},1500))}function f(e){$p.ipinfo.ggeocoder.geocode({latLng:e.latLng},function(t,n){if(n==google.maps.GeocoderStatus.OK&&t[0]){var a=t[0];h.setText(a.formatted_address),$p.ipinfo.components(y,a.address_components),r();var i=y.street?15:12;h.elmnts.map.getZoom()!=i&&(h.elmnts.map.setZoom(i),h.elmnts.map.setCenter(e.latLng)),y.latitude=e.latLng.lat(),y.longitude=e.latLng.lng()}})}function p(e,t,n){e&&(y.delivery_area.empty()?(t=n,$p.msg.show_msg({type:"alert",text:$p.msg.delivery_area_empty,title:$p.msg.addr_title}),setTimeout(function(){h.elmnts.pgrid.selectRowById("delivery_area")},50)):"delivery_area"==e?a(t):(y[h.elmnts.pgrid.getSelectedRowId()]=t,o()))}function _(t){return e.grid.editStop(),!t.error}var h,m=e.obj,g=e.pwnd,b=m.delivery_area,y={coordinates:m.coordinates?JSON.parse(m.coordinates):[],country:"Россия",region:"",city:"",street:"",postal_code:"",marker:{}};return y.__define("delivery_area",{get:function(){return b},set:function(e){a(e)}}),c().then(t),h}function AppEvents(){if(this.__define({init:{value:function(){$p.__define("job_prm",{value:new JobPrm,writable:!1}),$p.wsql.init_params()}},do_eventable:{value:function(e){function t(e,t){e=String(e).toLowerCase(),this._evnts.data[e]||(this._evnts.data[e]={});var n=$p.utils.generate_guid();return this._evnts.data[e][n]=t,n}function n(e){if(!e)return a.call(this);for(var t in this._evnts.data){var n=0;for(var i in this._evnts.data[t])i==e?(this._evnts.data[t][i]=null,delete this._evnts.data[t][i]):n++;0==n&&(this._evnts.data[t]=null,delete this._evnts.data[t])}}function a(){for(var e in this._evnts.data){for(var t in this._evnts.data[e])this._evnts.data[e][t]=null,delete this._evnts.data[e][t];this._evnts.data[e]=null,delete this._evnts.data[e]}}function i(e,t){if(e=String(e).toLowerCase(),null==this._evnts.data[e])return!0;var n=!0;for(var a in this._evnts.data[e])n=this._evnts.data[e][a].apply(this,t)&&n;return n}function r(){for(var e in this._evnts.evnts){var t=this._evnts.evnts[e].length;if(t){for(var n=0;n<t;n++)this.emit(e,this._evnts.evnts[e][n]);this._evnts.evnts[e].length=0}}this._evnts.timer=0}e.__define({_evnts:{value:{data:{},timer:0,evnts:{}}},on:{value:t},attachEvent:{value:t},off:{value:n},detachEvent:{value:n},detachAllEvents:{value:a},checkEvent:{value:function(e){return e=String(e).toLowerCase(),null!=this._evnts.data[e]}},callEvent:{value:i},emit:{value:i},emit_async:{value:function(e,t){this._evnts.evnts[e]||(this._evnts.evnts[e]=[]),this._evnts.evnts[e].push(t),this._evnts.timer&&clearTimeout(this._evnts.timer),this._evnts.timer=setTimeout(r.bind(this),4)}}})}}}),"undefined"!=typeof window&&window.dhx4){for(var e in dhx4)this[e]=dhx4[e],delete dhx4[e];window.dhx4=this}else"undefined"==typeof WorkerGlobalScope&&this.do_eventable(this)}function JobPrm(){function e(){return $p.wsql.get_user_param("rest_path")||$p.job_prm.rest_path||"/a/zd/%1/odata/standard.odata/"}function t(){function e(e){var t,n={},a=[];if("#"!==e.substr(0,1)&&"?"!==e.substr(0,1)||(e=e.substr(1)),e.length>2){t=decodeURI(e).split("&");for(var i in t)if(a=t[i].split("="),"m"==a[0])try{n[a[0]]=JSON.parse(a[1])}catch(e){n[a[0]]={}}else n[a[0]]=a[1]||""}return n}return e(location.search)._mixin(e(location.hash))}this.__define({parse_url:{value:t},offline:{value:!1,writable:!0},local_storage_prefix:{value:"",writable:!0},create_tables:{value:!0,writable:!0},url_prm:{value:"undefined"!=typeof window?t():{}},rest_url:{value:function(){var t=e(),n=$p.wsql.get_user_param("zone",$p.job_prm.zone_is_string?"string":"number");return n?t.replace("%1",n):t.replace("%1/","")}},irest_url:{value:function(){var t=e(),n=$p.wsql.get_user_param("zone",$p.job_prm.zone_is_string?"string":"number");return t=t.replace("odata/standard.odata","hs/rest"),n?t.replace("%1",n):t.replace("%1/","")}}}),$p.eve.callEvent("settings",[this]);for(var n in this)"url_prm"!==n&&"function"!=typeof this[n]&&this.url_prm.hasOwnProperty[n]&&(this[n]=this.url_prm[n])}function Modifiers(){var e=[];this.push=function(t){e.push(t)},this.detache=function(t){var n=e.indexOf(t);n!=-1&&e.splice(n,1)},this.clear=function(){e.length=0},this.execute=function(t){var n,a;return e.forEach(function(e){a="function"==typeof e?e(t):$p.injected_data[e](t),n!==!1&&(n=a)}),n},this.execute_external=function(e){var t=$p.wsql.get_user_param("modifiers");return t=t?t.split("\n").map(function(e){return e?new Promise(function(t,n){$p.load_script(e,"script",t)}):Promise.resolve()}):[],Promise.all(t).then(function(){this.execute(e)}.bind(this))}}function IPInfo(){function e(){this.geocode=function(e){return Promise.resolve(!1)}}var t,n,a,i="";this.__define({ipgeo:{value:function(){return $p.ajax.get("//api.sypexgeo.net/").then(function(e){return JSON.parse(e.response)}).catch($p.record_log)}},yageocoder:{get:function(){return t||(t=new e),t},enumerable:!1,configurable:!1},ggeocoder:{get:function(){return n},enumerable:!1,configurable:!1},addr:{get:function(){return i}},parts:{get:function(){return a}},components:{value:function(e,t){var n,a,i,r="",o="",s="";for(n in t){a=t[n];for(i in a.types)switch(a.types[i]){case"route":a.short_name.indexOf("Unnamed")==-1&&(r=a.short_name+(r?" "+r:""),o=a.long_name.replace("улица","").trim());break;case"administrative_area_level_1":e.region=a.long_name;break;case"administrative_area_level_2":e.city=a.short_name,e.city_long=a.long_name;break;case"locality":s=(s?s+" ":"")+a.short_name;break;case"street_number":r=(r?r+" ":"")+a.short_name;break;case"postal_code":e.postal_code=a.short_name}}return e.region&&e.region==e.city_long?e.city.indexOf(s)==-1?e.city=s:e.city="":s&&e.city.indexOf(s)==-1&&e.region.indexOf(s)==-1&&(r=s+", "+r),e.street&&e.street.indexOf(o)!=-1||(e.street=r),e}},location_callback:{value:function(){n=new google.maps.Geocoder,$p.eve.callEvent("geo_google_ready"),navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){$p.ipinfo.latitude=e.coords.latitude,$p.ipinfo.longitude=e.coords.longitude;var t=new google.maps.LatLng($p.ipinfo.latitude,$p.ipinfo.longitude);n.geocode({latLng:t},function(e,t){t==google.maps.GeocoderStatus.OK&&(a=!e[1]||e[0].address_components.length>=e[1].address_components.length?e[0]:e[1],i=a.formatted_address,$p.eve.callEvent("geo_current_position",[$p.ipinfo.components({},a.address_components)]))})},$p.record_log,{timeout:3e4})}}})}function SpreadsheetDocument(e){this._attr={orientation:"portrait",title:"",content:document.createElement("DIV")},e&&"string"==typeof e?this.content=e:"object"==typeof e&&this._mixin(e),e=null}function HandsontableDocument(e,t){var n=function(){this._then&&this._then(this)}.bind(this);this._online=t&&t.allow_offline||navigator.onLine&&$p.wsql.pouch.authorized,e instanceof dhtmlXCellObject?(this._cont=document.createElement("div"),e.detachObject(!0),e.attachObject(this._cont)):this._cont=e,this._cont.classList.add("handsontable_wrapper"),this._online?this._cont.innerHTML=t.autorun?$p.msg.report_prepare:$p.msg.report_need_prepare:this._cont.innerHTML=$p.msg.report_need_online,this.then=function(e){return this._then=e,this},this.requery=function(e){this.hot&&this.hot.destroy(),this._cont.innerHTML="",this.hot=new Handsontable(this._cont,e)},"function"!=typeof Handsontable&&this._online?$p.load_script("//cdnjs.cloudflare.com/ajax/libs/pikaday/1.4.0/pikaday.min.js","script").then(function(){return $p.load_script("//cdnjs.cloudflare.com/ajax/libs/numbro/1.9.2/numbro.min.js","script")}).then(function(){return $p.load_script("//cdn.jsdelivr.net/g/zeroclipboard,handsontable@0.26(handsontable.min.js)","script")}).then(function(){return Promise.all([$p.load_script("//cdn.jsdelivr.net/handsontable/0.26/handsontable.min.css","link"),$p.load_script("//cdnjs.cloudflare.com/ajax/libs/numbro/1.9.2/languages/ru-RU.min.js","script")])}).then(n):setTimeout(n)}function Aes(e){"use strict";function t(e){return encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)})}function n(e){try{return decodeURIComponent(escape(e))}catch(t){return e}}function a(e){if("undefined"!=typeof btoa)return btoa(e);if("undefined"!=typeof Buffer)return new Buffer(e,"binary").toString("base64");throw new Error("No Base64 Encode")}function i(e){if("undefined"!=typeof atob)return atob(e);if("undefined"!=typeof Buffer)return new Buffer(e,"base64").toString("binary");throw new Error("No Base64 Decode")}var r=this;r.cipher=function(e,t){for(var n=4,a=t.length/n-1,i=[[],[],[],[]],o=0;o<4*n;o++)i[o%4][Math.floor(o/4)]=e[o];i=r.addRoundKey(i,t,0,n);for(var s=1;s<a;s++)i=r.subBytes(i,n),i=r.shiftRows(i,n),i=r.mixColumns(i,n),i=r.addRoundKey(i,t,s,n);i=r.subBytes(i,n),i=r.shiftRows(i,n),i=r.addRoundKey(i,t,a,n);for(var l=new Array(4*n),o=0;o<4*n;o++)l[o]=i[o%4][Math.floor(o/4)];return l},r.keyExpansion=function(e){for(var t=4,n=e.length/4,a=n+6,i=new Array(t*(a+1)),o=new Array(4),s=0;s<n;s++){var l=[e[4*s],e[4*s+1],e[4*s+2],e[4*s+3]];i[s]=l}for(var s=n;s<t*(a+1);s++){i[s]=new Array(4);for(var c=0;c<4;c++)o[c]=i[s-1][c];if(s%n==0){o=r.subWord(r.rotWord(o));for(var c=0;c<4;c++)o[c]^=r.rCon[s/n][c]}else n>6&&s%n==4&&(o=r.subWord(o));for(var c=0;c<4;c++)i[s][c]=i[s-n][c]^o[c]}return i},r.subBytes=function(e,t){for(var n=0;n<4;n++)for(var a=0;a<t;a++)e[n][a]=r.sBox[e[n][a]];return e},r.shiftRows=function(e,t){for(var n=new Array(4),a=1;a<4;a++){for(var i=0;i<4;i++)n[i]=e[a][(i+a)%t];for(var i=0;i<4;i++)e[a][i]=n[i]}return e},r.mixColumns=function(e,t){for(var n=0;n<4;n++){for(var a=new Array(4),i=new Array(4),r=0;r<4;r++)a[r]=e[r][n],i[r]=128&e[r][n]?e[r][n]<<1^283:e[r][n]<<1;e[0][n]=i[0]^a[1]^i[1]^a[2]^a[3],e[1][n]=a[0]^i[1]^a[2]^i[2]^a[3],e[2][n]=a[0]^a[1]^i[2]^a[3]^i[3],e[3][n]=a[0]^i[0]^a[1]^a[2]^i[3]}return e},r.addRoundKey=function(e,t,n,a){for(var i=0;i<4;i++)for(var r=0;r<a;r++)e[i][r]^=t[4*n+r][i];return e},r.subWord=function(e){for(var t=0;t<4;t++)e[t]=r.sBox[e[t]];return e},r.rotWord=function(e){for(var t=e[0],n=0;n<3;n++)e[n]=e[n+1];return e[3]=t,e},r.sBox=[99,124,119,123,242,107,111,197,48,1,103,43,254,215,171,118,202,130,201,125,250,89,71,240,173,212,162,175,156,164,114,192,183,253,147,38,54,63,247,204,52,165,229,241,113,216,49,21,4,199,35,195,24,150,5,154,7,18,128,226,235,39,178,117,9,131,44,26,27,110,90,160,82,59,214,179,41,227,47,132,83,209,0,237,32,252,177,91,106,203,190,57,74,76,88,207,208,239,170,251,67,77,51,133,69,249,2,127,80,60,159,168,81,163,64,143,146,157,56,245,188,182,218,33,16,255,243,210,205,12,19,236,95,151,68,23,196,167,126,61,100,93,25,115,96,129,79,220,34,42,144,136,70,238,184,20,222,94,11,219,224,50,58,10,73,6,36,92,194,211,172,98,145,149,228,121,231,200,55,109,141,213,78,169,108,86,244,234,101,122,174,8,186,120,37,46,28,166,180,198,232,221,116,31,75,189,139,138,112,62,181,102,72,3,246,14,97,53,87,185,134,193,29,158,225,248,152,17,105,217,142,148,155,30,135,233,206,85,40,223,140,161,137,13,191,230,66,104,65,153,45,15,176,84,187,22],r.rCon=[[0,0,0,0],[1,0,0,0],[2,0,0,0],[4,0,0,0],[8,0,0,0],[16,0,0,0],[32,0,0,0],[64,0,0,0],[128,0,0,0],[27,0,0,0],[54,0,0,0]],r.Ctr={},r.Ctr.encrypt=function(n,i,o){var s=16;128!=o&&192!=o&&256!=o&&(o=128),n=t(n),i=t(i||e);for(var l=o/8,c=new Array(l),d=0;d<l;d++)c[d]=d<i.length?i.charCodeAt(d):0;var u=r.cipher(c,r.keyExpansion(c));u=u.concat(u.slice(0,l-16));for(var f=new Array(s),p=(new Date).getTime(),_=p%1e3,h=Math.floor(p/1e3),m=Math.floor(65535*Math.random()),d=0;d<2;d++)f[d]=_>>>8*d&255;for(var d=0;d<2;d++)f[d+2]=m>>>8*d&255;for(var d=0;d<4;d++)f[d+4]=h>>>8*d&255;for(var g="",d=0;d<8;d++)g+=String.fromCharCode(f[d]);for(var b=r.keyExpansion(u),y=Math.ceil(n.length/s),v="",w=0;w<y;w++){for(var x=0;x<4;x++)f[15-x]=w>>>8*x&255;for(var x=0;x<4;x++)f[15-x-4]=w/4294967296>>>8*x;for(var $=r.cipher(f,b),k=w<y-1?s:(n.length-1)%s+1,j=new Array(k),d=0;d<k;d++)j[d]=$[d]^n.charCodeAt(w*s+d),j[d]=String.fromCharCode(j[d]);v+=j.join(""),"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&w%1e3==0&&self.postMessage({progress:w/y})}return v=a(g+v)},r.Ctr.decrypt=function(a,o,s){var l=16;128!=s&&192!=s&&256!=s&&(s=128),a=i(a),o=t(o||e);for(var c=s/8,d=new Array(c),u=0;u<c;u++)d[u]=u<o.length?o.charCodeAt(u):0;var f=r.cipher(d,r.keyExpansion(d));f=f.concat(f.slice(0,c-16));for(var p=new Array(8),_=a.slice(0,8),u=0;u<8;u++)p[u]=_.charCodeAt(u);for(var h=r.keyExpansion(f),m=Math.ceil((a.length-8)/l),g=new Array(m),b=0;b<m;b++)g[b]=a.slice(8+b*l,8+b*l+l);a=g;for(var y="",b=0;b<m;b++){for(var v=0;v<4;v++)p[15-v]=b>>>8*v&255;for(var v=0;v<4;v++)p[15-v-4]=(b+1)/4294967296-1>>>8*v&255;for(var w=r.cipher(p,h),x=new Array(a[b].length),u=0;u<a[b].length;u++)x[u]=w[u]^a[b].charCodeAt(u),x[u]=String.fromCharCode(x[u]);y+=x.join(""),"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&b%1e3==0&&self.postMessage({progress:b/m})}return y=n(y)}}!function(e,t){"object"==typeof exports&&"undefined"!=typeof module&&"function"==typeof require?t(require("../moment")):"function"==typeof define&&define.amd?define(["../moment"],t):t(e.moment)}(this,function(e){"use strict";function t(e,t){var n=e.split("_");return t%10===1&&t%100!==11?n[0]:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?n[1]:n[2]}function n(e,n,a){var i={mm:n?"минута_минуты_минут":"минуту_минуты_минут",hh:"час_часа_часов",dd:"день_дня_дней",MM:"месяц_месяца_месяцев",yy:"год_года_лет"};return"m"===a?n?"минута":"минуту":e+" "+t(i[a],+e)}var a=[/^янв/i,/^фев/i,/^мар/i,/^апр/i,/^ма[йя]/i,/^июн/i,/^июл/i,/^авг/i,/^сен/i,/^окт/i,/^ноя/i,/^дек/i],i=e.defineLocale("ru",{months:{format:"января_февраля_марта_апреля_мая_июня_июля_августа_сентября_октября_ноября_декабря".split("_"),standalone:"январь_февраль_март_апрель_май_июнь_июль_август_сентябрь_октябрь_ноябрь_декабрь".split("_")},monthsShort:{format:"янв._февр._мар._апр._мая_июня_июля_авг._сент._окт._нояб._дек.".split("_"),standalone:"янв._февр._март_апр._май_июнь_июль_авг._сент._окт._нояб._дек.".split("_")},weekdays:{standalone:"воскресенье_понедельник_вторник_среда_четверг_пятница_суббота".split("_"),format:"воскресенье_понедельник_вторник_среду_четверг_пятницу_субботу".split("_"),isFormat:/\[ ?[Вв] ?(?:прошлую|следующую|эту)? ?\] ?dddd/},weekdaysShort:"вс_пн_вт_ср_чт_пт_сб".split("_"),weekdaysMin:"вс_пн_вт_ср_чт_пт_сб".split("_"),monthsParse:a,longMonthsParse:a,shortMonthsParse:a,monthsRegex:/^(январ[ья]|янв\.?|феврал[ья]|февр?\.?|марта?|мар\.?|апрел[ья]|апр\.?|ма[йя]|июн[ья]|июн\.?|июл[ья]|июл\.?|августа?|авг\.?|сентябр[ья]|сент?\.?|октябр[ья]|окт\.?|ноябр[ья]|нояб?\.?|декабр[ья]|дек\.?)/i,monthsShortRegex:/^(январ[ья]|янв\.?|феврал[ья]|февр?\.?|марта?|мар\.?|апрел[ья]|апр\.?|ма[йя]|июн[ья]|июн\.?|июл[ья]|июл\.?|августа?|авг\.?|сентябр[ья]|сент?\.?|октябр[ья]|окт\.?|ноябр[ья]|нояб?\.?|декабр[ья]|дек\.?)/i,monthsStrictRegex:/^(январ[яь]|феврал[яь]|марта?|апрел[яь]|ма[яй]|июн[яь]|июл[яь]|августа?|сентябр[яь]|октябр[яь]|ноябр[яь]|декабр[яь])/i,monthsShortStrictRegex:/^(янв\.|февр?\.|мар[т.]|апр\.|ма[яй]|июн[ья.]|июл[ья.]|авг\.|сент?\.|окт\.|нояб?\.|дек\.)/i,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY г.",LLL:"D MMMM YYYY г., HH:mm",LLLL:"dddd, D MMMM YYYY г., HH:mm"},calendar:{sameDay:"[Сегодня в] LT",nextDay:"[Завтра в] LT",lastDay:"[Вчера в] LT",nextWeek:function(e){if(e.week()===this.week())return 2===this.day()?"[Во] dddd [в] LT":"[В] dddd [в] LT";switch(this.day()){case 0:return"[В следующее] dddd [в] LT";case 1:case 2:case 4:return"[В следующий] dddd [в] LT";case 3:case 5:case 6:return"[В следующую] dddd [в] LT"}},lastWeek:function(e){if(e.week()===this.week())return 2===this.day()?"[Во] dddd [в] LT":"[В] dddd [в] LT";switch(this.day()){case 0:return"[В прошлое] dddd [в] LT";case 1:case 2:case 4:return"[В прошлый] dddd [в] LT";case 3:case 5:case 6:return"[В прошлую] dddd [в] LT"}},sameElse:"L"},relativeTime:{future:"через %s",past:"%s назад",s:"несколько секунд",m:n,mm:n,h:"час",hh:n,d:"день",dd:n,M:"месяц",MM:n,y:"год",yy:n},meridiemParse:/ночи|утра|дня|вечера/i,isPM:function(e){return/^(дня|вечера)$/.test(e)},meridiem:function(e,t,n){return e<4?"ночи":e<12?"утра":e<17?"дня":"вечера"},ordinalParse:/\d{1,2}-(й|го|я)/,ordinal:function(e,t){switch(t){case"M":case"d":case"DDD":return e+"-й";case"D":return e+"-го";case"w":case"W":return e+"-я";default:return e}},week:{dow:1,doy:7}});return i}),Object.defineProperties(Object.prototype,{__define:{value:function(e,t){return t?Object.defineProperty(this,e,t):Object.defineProperties(this,e),this}},_extend:{value:function(e){var t=function(){};t.prototype=e.prototype,this.prototype=new t,this.prototype.constructor=this,this.__define("superclass",{value:e.prototype,enumerable:!1})}},_mixin:{value:function(e,t,n){var a,i,r={};if(t&&t.length)for(a=0;a<t.length;a++)i=t[a],n&&n.indexOf(i)!=-1||"undefined"!=typeof r[i]&&r[i]==e[i]||(this[i]=e[i]);else for(i in e)n&&n.indexOf(i)!=-1||"undefined"!=typeof r[i]&&r[i]==e[i]||(this[i]=e[i]);return this}},_clone:{value:function(){if(!this||"object"!=typeof this)return this;var e,t,n="function"==typeof this.pop?[]:{};for(e in this)this.hasOwnProperty(e)&&(t=this[e],t?"function"==typeof t||t instanceof DataObj||t instanceof DataManager||t instanceof Date?n[e]=t:"object"==typeof t?n[e]=t._clone():n[e]=t:n[e]=t);return n}}}),Number.prototype.round||(Number.prototype.round=function(e){var t=Math.pow(10,e);return Math.round(this*t)/t}),Number.prototype.pad||(Number.prototype.pad=function(e){for(var t=String(this);t.length<(e||2);)t="0"+t;return t}),Object.observe||Object.unobserve||Object.getNotifier||Object.prototype.__define({observe:{value:function(e,t){e._observers||e.__define({_observers:{value:[],enumerable:!1},_notis:{value:[],enumerable:!1}}),e._observers.push(t)},enumerable:!1},unobserve:{value:function(e,t){if(e._observers)for(var n=0;n<e._observers.length;n++)if(e._observers[n]===t){e._observers.splice(n,1);break}},enumerable:!1},getNotifier:{value:function(e){var t;return{notify:function(n){e._observers&&n&&(n.object||(n.object=e),e._notis.push(n),n=null,t&&clearTimeout(t),t=setTimeout(function(){e._notis.length&&(e._observers.forEach(function(t){t(e._notis)}),e._notis.length=0),t=!1},4))}}},enumerable:!1}});var $p=new MetaEngine;$p.__define({iface:{value:new InterfaceObjs,writable:!1},current_user:{get:function(){return $p.cat&&$p.cat.users?$p.cat.users.by_id($p.wsql.get_user_param("user_name")):$p.cat.users.get()}},current_acl:{get:function(){var e;return $p.cat&&$p.cat.users_acl&&$p.cat.users_acl.find_rows({owner:$p.current_user},function(t){return e=t,!1}),e}},load_script:{value:function(e,t,n){return new Promise(function(a,i){var r=document.createElement(t);"script"==t?(r.type="text/javascript",r.src=e,r.async=!0,r.addEventListener("load",n?function(){n(),a()}:a,!1)):(r.type="text/css",r.rel="stylesheet",r.href=e),document.head.appendChild(r),"script"!=t&&a()})}}}),"undefined"!=typeof window&&window.dhx4&&(dhx4.dateFormat.ru="%d.%m.%Y",dhx4.dateLang="ru",dhx4.dateStrings={ru:{monthFullName:["Январь","Февраль","Март","Апрель","Maй","Июнь","Июль","Август","Сентябрь","Oктябрь","Ноябрь","Декабрь"],monthShortName:["Янв","Фев","Maр","Aпр","Maй","Июн","Июл","Aвг","Сен","Окт","Ноя","Дек"],dayFullName:["Воскресенье","Понедельник","Вторник","Среда","Четверг","Пятница","Суббота"],dayShortName:["Вс","Пн","Вт","Ср","Чт","Пт","Сб"]}}),$p.fias=function(){},function(e){e.toString=function(){return"Коды адресного классификатора"},e.types=["владение","здание","помещение"],e[1010]={name:"дом",type:1,order:1,fid:2,syn:[" д."," д "," дом"]},e[1020]={name:"владение",type:1,order:2,fid:1,syn:[" вл."," вл "," влад."," влад "," владен."," владен "," владение"]},e[1030]={name:"домовладение",type:1,order:3,fid:3},e[1050]={name:"корпус",type:2,order:1,syn:[" к."," к "," корп."," корп ","корпус"]},e[1060]={name:"строение",type:2,order:2,fid:1,syn:[" стр."," стр "," строен."," строен ","строение"]},e[1080]={name:"литера",type:2,order:3,fid:3,syn:[" л."," л "," лит."," лит ","литера"]},e[1070]={name:"сооружение",type:2,order:4,fid:2,syn:[" соор."," соор "," сооруж."," сооруж ","сооружение"]},e[1040]={name:"участок",type:2,order:5,syn:[" уч."," уч ","участок"]},e[2010]={name:"квартира",type:3,order:1,syn:["кв.","кв ","кварт.","кварт ","квартира","-"]},e[2030]={name:"офис",type:3,order:2,syn:["оф.","оф ","офис","-"]},e[2040]={name:"бокс",type:3,order:3},e[2020]={name:"помещение",type:3,order:4},e[2050]={name:"комната",type:3,order:5,syn:["комн.","комн ","комната"]},e[101e5]={name:"Почтовый индекс"},e[102e5]={name:"Адресная точка"},e[103e5]={name:"Садовое товарищество"},e[104e5]={name:"Элемент улично-дорожной сети, планировочной структуры дополнительного адресного элемента"},e[105e5]={name:"Промышленная зона"},e[106e5]={name:"Гаражно-строительный кооператив"},e[107e5]={name:"Территория"}}($p.fias),function(e){e.store_url_od="https://chrome.google.com/webstore/detail/hcncallbdlondnoadgjomnhifopfaage",e.argument_is_not_ref="Аргумент не является ссылкой",e.addr_title="Ввод адреса",e.cache_update_title="Обновление кеша браузера",e.cache_update="Выполняется загрузка измененных файлов<br/>и их кеширование в хранилище браузера",e.cancel="Отмена",e.delivery_area_empty="Укажите район доставки",e.empty_login_password="Не указаны имя пользователя или пароль",e.empty_response="Пустой ответ сервера",e.empty_geocoding="Пустой ответ геокодера. Вероятно, отслеживание адреса запрещено в настройках браузера",e.error_geocoding="Ошибка геокодера",e.error_auth="Авторизация пользователя не выполнена",e.error_critical="Критическая ошибка",e.error_metadata="Ошибка загрузки метаданных конфигурации",e.error_network="Ошибка сети или сервера - запрос отклонен",e.error_rights="Ограничение доступа",e.error_low_acl="Недостаточно прав для выполнения операции",e.file_size="Запрещена загрузка файлов<br/>размером более ",e.file_confirm_delete="Подтвердите удаление файла ",e.file_new_date="Файлы на сервере обновлены<br /> Рекомендуется закрыть браузер и войти<br />повторно для применения обновления",e.file_new_date_title="Версия файлов",e.init_catalogues="Загрузка справочников с сервера",e.init_catalogues_meta=": Метаданные объектов",e.init_catalogues_tables=": Реструктуризация таблиц",e.init_catalogues_nom=": Базовые типы + номенклатура",e.init_catalogues_sys=": Технологические справочники",e.init_login="Укажите имя пользователя и пароль",e.requery="Повторите попытку через 1-2 минуты",e.limit_query="Превышено число обращений к серверу<br/>Запросов за минуту:%1<br/>Лимит запросов:%2<br/>"+e.requery,e.long_operation="Длительная операция",e.logged_in="Авторизован под именем: ",e.log_out_title="Отключиться от сервера?",e.log_out_break="<br/>Завершить синхронизацию?",e.sync_title="Обмен с сервером",e.sync_complite="Синхронизация завершена",e.main_title="Окнософт: заказ дилера ",e.mark_delete_confirm="Пометить объект %1 на удаление?",e.mark_undelete_confirm="Снять пометку удаления с объекта %1?",e.meta={cat:"Справочник",doc:"Документ",cch:"План видов характеристик",cacc:"Планы счетов",tsk:"Задача",ireg:"Регистр сведений",areg:"Регистр накопления",bp:"Бизнес процесс",ts_row:"Строка табличной части",dp:"Обработка",rep:"Отчет"},e.meta_cat="Справочники",e.meta_doc="Документы",e.meta_cch="Планы видов характеристик",e.meta_cacc="Планы счетов",e.meta_tsk="Задачи",e.meta_ireg="Регистры сведений",e.meta_areg="Регистры накопления",e.meta_mgr="Менеджер",e.meta_cat_mgr="Менеджер справочников",e.meta_doc_mgr="Менеджер документов",e.meta_enn_mgr="Менеджер перечислений",e.meta_ireg_mgr="Менеджер регистров сведений",e.meta_areg_mgr="Менеджер регистров накопления",e.meta_accreg_mgr="Менеджер регистров бухгалтерии",e.meta_dp_mgr="Менеджер обработок",e.meta_task_mgr="Менеджер задач",e.meta_bp_mgr="Менеджер бизнес-процессов",e.meta_reports_mgr="Менеджер отчетов",e.meta_charts_of_accounts_mgr="Менеджер планов счетов",e.meta_charts_of_characteristic_mgr="Менеджер планов видов характеристик",e.meta_extender="Модификаторы объектов и менеджеров",e.modified_close="Объект изменен<br/>Закрыть без сохранения?",e.mandatory_title="Обязательный реквизит",e.mandatory_field="Укажите значение реквизита '%1'",e.no_metadata="Не найдены метаданные объекта '%1'",e.no_selected_row="Не выбрана строка табличной части '%1'",e.no_dhtmlx="Библиотека dhtmlx не загружена",e.not_implemented="Не реализовано в текущей версии",e.offline_request="Запрос к серверу в автономном режиме",e.onbeforeunload="Окнософт: легкий клиент. Закрыть программу?",e.order_sent_title="Подтвердите отправку заказа",e.order_sent_message="Отправленный заказ нельзя изменить.<br/>После проверки менеджером<br/>он будет запущен в работу",e.report_prepare="<i class='fa fa-spinner fa-spin fa-2x fa-fw'></i> Подготовка отчета",e.report_need_prepare="<i class='fa fa-info fa-2x fa-fw'></i> Нажмите 'Сформировать' для получения отчета",e.report_need_online="<i class='fa fa-plug fa-2x fa-fw'></i> Нет подключения. Отчет недоступен в автономном режиме",e.request_title="Окнософт: Запрос регистрации",e.request_message="Заявка зарегистрирована. После обработки менеджером будет сформировано ответное письмо",e.select_from_list="Выбор из списка",e.select_grp="Укажите группу, а не элемент",e.select_elm="Укажите элемент, а не группу",e.select_file_import="Укажите файл для импорта",e.srv_overload="Сервер перегружен",e.sub_row_change_disabled="Текущая строка подчинена продукции.<br/>Строку нельзя изменить-удалить в документе<br/>только через построитель",e.sync_script="Обновление скриптов приложения:",e.sync_data="Синхронизация с сервером выполняется:<br />* при первом старте программы<br /> * при обновлении метаданных<br /> * при изменении цен или технологических справочников",e.sync_break="Прервать синхронизацию",e.sync_no_data="Файл не содержит подходящих элементов для загрузки",e.unsupported_browser_title="Браузер не поддерживается",e.unsupported_browser="Несовместимая версия браузера<br/>Рекомендуется Google Chrome",e.supported_browsers="Рекомендуется Chrome, Safari или Opera",e.unsupported_mode_title="Режим не поддерживается",e.unsupported_mode="Программа не установлена<br/> в <a href='"+e.store_url_od+"'>приложениях Google Chrome</a>",e.unknown_error="Неизвестная ошибка в функции '%1'",e.value="Значение"}($p.msg),DataManager.prototype.__define({family_name:{get:function(){return $p.msg["meta_"+this.class_name.split(".")[0]+"_mgr"].replace($p.msg.meta_mgr+" ","")}},table_name:{get:function(){return this.class_name.replace(".","_")}},find_rows:{value:function(e,t){return $p._find_rows.call(this,this.by_ref,e,t)}},extra_fields:{value:function(e){var t=$p.cat.destinations||$p.cch.destinations,n=_md.class_name_to_1c(this.class_name).replace(".","_"),a=[];return t&&t.find_rows({predefined_name:n},function(e){var t=e.extra_fields||e.ДополнительныеРеквизиты;return t&&t.each(function(e){e._deleted||e.ПометкаУдаления||a.push(e.property||e.Свойство)}),!1}),a}},extra_properties:{value:function(e){return[]}},obj_constructor:{value:function(e){var t=this.class_name.split("."),n=t[0].charAt(0).toUpperCase()+t[0].substr(1)+t[1].charAt(0).toUpperCase()+t[1].substr(1);return e?n+e.charAt(0).toUpperCase()+e.substr(1)+"Row":n}}}),DataManager.prototype.sync_grid=function(e,t){function n(){if(e.custom_selection)return e.custom_selection(e);if("ram"==i.cachable){if("get_tree"==e.action)return $p.wsql.promise(i.get_sql_struct(e),[]).then($p.iface.data_to_tree);if("get_selection"==e.action)return $p.wsql.promise(i.get_sql_struct(e),[]).then(function(t){return $p.iface.data_to_grid.call(i,t,e)})}else if(0==i.cachable.indexOf("doc")){if("get_tree"==e.action)return i.pouch_tree(e);if("get_selection"==e.action)return i.pouch_selection(e)}else{if("get_tree"==e.action)return i.rest_tree(e);if("get_selection"==e.action)return i.rest_selection(e)}}function a(e){return new Promise(function(n,a){"string"==typeof e?("{"==e.substr(0,1)&&(e=JSON.parse(e)),t&&t.parse?(t.xmlFileUrl="exec",t.parse(e,function(){n(e)},"xml")):n(e)):n(e)})}var i=this;return n().then(a).catch($p.record_log)},DataManager.prototype.get_option_list=function(e,t){function n(t){return $p.utils.is_equal(t.value,e)&&(t.selected=!0),t}var a,i,r,o=this,s=[];if(t.presentation&&(a=o.metadata().input_by_string)&&(i=t.presentation.like,delete t.presentation,t.or=[],a.forEach(function(e){r={},r[e]={like:i},t.or.push(r)})),"ram"==o.cachable||t&&t._local)return o.find_rows(t,function(e){s.push(n({text:e.presentation,value:e.ref}))}),Promise.resolve(s);if("e1cib"!=o.cachable)return o.pouch_find_rows(t).then(function(e){return e.forEach(function(e){s.push(n({text:e.presentation,value:e.ref}))}),s});var l={selection:t,top:t._top},c=o instanceof DocManager||o instanceof BusinessProcessManager;
return delete t._top,c?l.fields=["ref","date","number_doc"]:o.metadata().main_presentation_name?l.fields=["ref","name"]:l.fields=["ref","id"],_rest.load_array(l,o).then(function(e){return e.forEach(function(e){s.push(n({text:c?e.number_doc+" от "+$p.moment(e.date).format($p.moment._masks.ldt):e.name||e.id,value:e.ref}))}),s})},DataManager.prototype.tabular_captions=function(e,t){},DataManager.prototype.get_property_grid_xml=function(e,t,n){var a,i,r,o,s,l,c,d=this,u="<rows>",f=function(){if(!e)if(r=d.metadata(),r.form&&r.form.obj&&r.form.obj.head)e=r.form.obj.head;else{if(e={" ":[]},t instanceof CatObj?(r.code_length&&e[" "].push("id"),r.main_presentation_name&&e[" "].push("name")):t instanceof DocObj&&(e[" "].push("number_doc"),e[" "].push("date")),!t.is_folder)for(a in r.fields)"predefined_name"==a||r.fields[a].hide||e[" "].push(a);r.tabular_sections&&r.tabular_sections.extra_fields&&(e["Дополнительные реквизиты"]=[])}},p=function(e,t){l=$p.utils.is_data_obj(e)?e.presentation:e,t.type.is_ref||(t.type.date_part?l=$p.moment(l).format($p.moment._masks[t.type.date_part]):"boolean"==t.type.types[0]&&(l=l?"1":"0"))},_=function(e){s=_md.control_by_type(r.type,e),p(e,r)},h=function(e,a){if(a){var i=e.property||e.param||e.Параметр||e.Свойство,f=void 0!=e.value?e.value:e.Значение;i.empty()?(c=a+"|empty",s="ro",l="",r={synonym:"?"}):(r={synonym:i.presentation,type:i.type},c=a+"|"+i.ref,_(f),"edn"==s&&(s="calck"),i.mandatory&&(s+='" class="cell_mandatory'))}else if("object"==typeof e)c=e.id,r=n&&n.metadata&&n.metadata[c],r?e.synonym&&(r.synonym=e.synonym):r={synonym:e.synonym},s=e.type,l="",e.hasOwnProperty("txt")?l=e.txt:void 0!==(o=t[c])&&p(o,r.type?r:_md.get(d.class_name,c));else if(n&&n.metadata&&void 0!==(r=n.metadata[e]))c=e,_(o=t[e]);else{if(void 0===(o=t[e]))return;r=_md.get(d.class_name,c=e),_(o)}u+='<row id="'+c+'"><cell>'+(r.synonym||r.name)+'</cell><cell type="'+s+'">'+l+"</cell></row>"};f();for(a in e){" "!=a&&(u+='<row open="1"><cell>'+a+"</cell>");for(i in e[a])h(e[a][i]);if(n&&a==n.title&&t[n.ts]){var m,g=d.extra_fields(t),b="property,param,Свойство,Параметр".split(","),y=t[n.ts]._owner._metadata.tabular_sections[t[n.ts]._name].fields;b.some(function(e){if(y[e])return m=e,!0})&&(t[n.ts].forEach(function(e){var t=g.indexOf(e[m]);t!=-1&&g.splice(t,1)}),g.forEach(function(e){var a=t[n.ts].add();a[m]=e})),t[n.ts].find_rows(n.selection,function(e){h(e,n.ts)})}" "!=a&&(u+="</row>")}return u+="</rows>"},DataManager.prototype.print=function(e,t,n){function a(e){n&&n.progressOff&&n.progressOff(),e&&e.focus()}if(n&&n.progressOn&&n.progressOn(),setTimeout(a,3e3),this._printing_plates[t]instanceof DataObj&&(t=this._printing_plates[t]),t instanceof DataObj&&t.execute)return e instanceof DataObj?t.execute(e).then(a):this.get(e,!0,!0).then(t.execute.bind(t)).then(a);var i={};return $p.ajax.default_attr(i,$p.job_prm.irest_url()),i.url+=this.rest_name+"(guid'"+$p.utils.fix_guid(e)+"')/Print(model="+t+", browser_uid="+$p.wsql.get_user_param("browser_uid")+")",$p.ajax.get_and_show_blob(i.url,i,"get").then(a)},DataManager.prototype.printing_plates=function(){var e={},t=this;return t._printing_plates||(t.metadata().printing_plates?t._printing_plates=t.metadata().printing_plates:("ram"==t.metadata().cachable||t.metadata().cachable&&0==t.metadata().cachable.indexOf("doc"))&&(t._printing_plates={})),!t._printing_plates&&$p.ajax.authorized?($p.ajax.default_attr(e,$p.job_prm.irest_url()),e.url+=t.rest_name+"/Print()",$p.ajax.get_ex(e.url,e).then(function(e){return t._printing_plates=JSON.parse(e.response),t._printing_plates}).catch(function(){}).then(function(e){return e||(t._printing_plates={})})):Promise.resolve(t._printing_plates)},RefDataManager._extend(DataManager),RefDataManager.prototype.__define({push:{value:function(e,t){t&&t!=e.ref?(delete this.by_ref[e.ref],this.by_ref[t]=e):this.by_ref[e.ref]=e}},each:{value:function(e){for(var t in this.by_ref)if(t&&t!=$p.utils.blank.guid&&1==e.call(this,this.by_ref[t]))break}},forEach:{value:function(e){return this.each.call(this,e)}},get:{value:function(e,t,n){var a=this.by_ref[e]||this.by_ref[e=$p.utils.fix_guid(e)];if(!a){if(n&&!t)return;a=new($p[this.obj_constructor()])(e,this,(!0))}return t===!1?a:void 0===t&&e===$p.utils.blank.guid?a:a.is_new()?a.load():t?Promise.resolve(a):a}},create:{value:function(e,t){e&&"object"==typeof e||(e={}),e.ref&&$p.utils.is_guid(e.ref)&&!$p.utils.is_empty_guid(e.ref)||(e.ref=$p.utils.generate_guid());var n=this.by_ref[e.ref];if(!n)if(n=new($p[this.obj_constructor()])(e,this),!t&&e.ref&&e.presentation&&2==Object.keys(e).length);else{n instanceof DocObj&&n.date==$p.utils.blank.date&&(n.date=new Date);var a=this.handle_event(n,"after_create");if(a===!1)return Promise.resolve(n);if("object"==typeof a&&a.then)return a;if("e1cib"==this.cachable&&t){var i={};return $p.ajax.default_attr(i,$p.job_prm.irest_url()),i.url+=this.rest_name+"/Create()",$p.ajax.get_ex(i.url,i).then(function(e){return n._mixin(JSON.parse(e.response),void 0,["ref"])})}}return Promise.resolve(n)}},unload_obj:{value:function(e){delete this.by_ref[e],this.alatable.some(function(t,n,a){if(t.ref==e)return a.splice(n,1),!0})}},find:{value:function(e,t){return $p._find(this.by_ref,e,t)}},load_array:{value:function(e,t){for(var n,a,i=[],r=0;r<e.length;r++)n=$p.utils.fix_guid(e[r]),a=this.by_ref[n],a?(a.is_new()||t)&&(a._mixin(e[r]),a._set_loaded()):(a=new($p[this.obj_constructor()])(e[r],this),t&&a._set_loaded()),i.push(a);return i}},first_folder:{value:function(e){for(var t in this.by_ref){var n=this.by_ref[t];if(n.is_folder&&(!e||$p.utils.is_equal(e,n.owner)))return n}return this.get()}},get_sql_struct:{value:function(e){function t(){function t(){var e=[],t="_t_.ref, _t_.`_deleted`";return s.form&&s.form.selection?s.form.selection.fields.forEach(function(t){e.push(t)}):o instanceof DocManager?(e.push("posted"),e.push("date"),e.push("number_doc")):(s.hierarchical&&s.group_hierarchy?e.push("is_folder"):e.push("0 as is_folder"),o instanceof ChartOfAccountManager?(e.push("id"),e.push("name as presentation")):s.main_presentation_name?e.push("name as presentation"):s.code_length?e.push("id as presentation"):e.push("'...' as presentation"),s.has_owners&&e.push("owner"),s.code_length&&e.push("id")),e.forEach(function(e){t+=e.indexOf(" as ")!=-1?", "+e:_md.sql_mask(e,!0)}),t}function n(){var e,t="";if(s.form&&s.form.selection)for(var n in s.form.selection.fields)s.form.selection.fields[n].indexOf(" as ")!=-1&&s.form.selection.fields[n].indexOf("_t_.")==-1&&(e=s.form.selection.fields[n].split(" as "),e[0]=e[0].split("."),e[0].length>1&&(t&&(t+="\n"),t+="left outer join "+e[0][0]+" on "+e[0][0]+".ref = _t_."+e[1]));return t}function a(){var t;return t=o instanceof ChartOfAccountManager?" WHERE ("+(f?0:1):s.hierarchical?s.has_owners?" WHERE ("+(c||f?1:0)+" OR _t_.parent = '"+d+"') AND ("+(l==$p.utils.blank.guid?1:0)+" OR _t_.owner = '"+l+"') AND ("+(f?0:1):" WHERE ("+(c||f?1:0)+" OR _t_.parent = '"+d+"') AND ("+(f?0:1):s.has_owners?" WHERE ("+(l==$p.utils.blank.guid?1:0)+" OR _t_.owner = '"+l+"') AND ("+(f?0:1):" WHERE ("+(f?0:1),o.sql_selection_where_flds?t+=o.sql_selection_where_flds(f):o instanceof DocManager?t+=" OR _t_.number_doc LIKE '"+f+"'":((s.main_presentation_name||o instanceof ChartOfAccountManager)&&(t+=" OR _t_.name LIKE '"+f+"'"),s.code_length&&(t+=" OR _t_.id LIKE '"+f+"'")),t+=") AND (_t_.ref != '"+$p.utils.blank.guid+"')",e.selection&&("function"==typeof e.selection||e.selection.forEach(function(e){for(var n in e)if("function"==typeof e[n])t+="\n AND "+e[n](o,n)+" ";else if(s.fields.hasOwnProperty(n))if(e[n]===!0)t+="\n AND _t_."+n+" ";else if(e[n]===!1)t+="\n AND (not _t_."+n+") ";else if("object"==typeof e[n])if($p.utils.is_data_obj(e[n]))t+="\n AND (_t_."+n+" = '"+e[n]+"') ";else{var a,i=Object.keys(e[n]),r=e[n][i[0]],l=s.fields[n];l&&l.type.is_ref&&(a=_md.value_mgr({},n,l.type,!0,r)),t+="not"==i[0]?"\n AND (not _t_."+n+" = '"+r+"') ":"\n AND (_t_."+n+" = '"+r+"') "}else t+="string"==typeof e[n]?"\n AND (_t_."+n+" = '"+e[n]+"') ":"\n AND (_t_."+n+" = "+e[n]+") ";else"is_folder"==n&&s.hierarchical&&s.group_hierarchy})),t}function i(){return o instanceof ChartOfAccountManager?"ORDER BY id":s.hierarchical?s.group_hierarchy?"ORDER BY _t_.is_folder desc, is_initial_value, presentation":"ORDER BY _t_.parent desc, is_initial_value, presentation":"ORDER BY is_initial_value, presentation"}function r(){function t(t){t&&(p=e.set_parent=t.parent.ref,d=p,c=!1),f&&f.indexOf("%")==-1&&(f="%"+f+"%")}s.has_owners&&(l=e.owner,e.selection&&"function"!=typeof e.selection&&e.selection.forEach(function(e){e.owner&&(l="object"==typeof e.owner?e.owner.valueOf():e.owner,delete e.owner)}),l||(l=$p.utils.blank.guid)),u!=$p.utils.blank.guid&&c&&s.hierarchical?t(o.get(u,!1)):t()}var l,c=!e.parent,d=e.parent||$p.utils.blank.guid,u=e.initial_value||$p.utils.blank.guid,f=e.filter||"",p=$p.utils.blank.guid;r();var _;return _=o.sql_selection_list_flds?o.sql_selection_list_flds(u):("SELECT %2, case when _t_.ref = '"+u+"' then 0 else 1 end as is_initial_value FROM `"+o.table_name+"` AS _t_ %j %3 %4 LIMIT 300").replace("%2",t()).replace("%j",n()),_.replace("%3",a()).replace("%4",i())}function n(){var t="CREATE TABLE IF NOT EXISTS ";if(e&&e.postgres){t+=o.table_name+" (ref uuid PRIMARY KEY NOT NULL, _deleted boolean",o instanceof DocManager?t+=", posted boolean, date timestamp with time zone, number_doc character(11)":(s.code_length&&(t+=", id character("+s.code_length+")"),t+=", name character varying(50), is_folder boolean");for(i in s.fields)i.length>30?s.fields[i].short_name?r=s.fields[i].short_name:(c++,r=i[0]+c+i.substr(i.length-27)):r=i,t+=", "+r+_md.sql_type(o,i,s.fields[i].type,!0)+_md.sql_composite(s.fields,i,r,!0);for(i in s.tabular_sections)t+=", ts_"+i+" JSON"}else{t+="`"+o.table_name+"` (ref CHAR PRIMARY KEY NOT NULL, `_deleted` BOOLEAN",t+=o instanceof DocManager?", posted boolean, date Date, number_doc CHAR":", id CHAR, name CHAR, is_folder BOOLEAN";for(i in s.fields)t+=_md.sql_mask(i)+_md.sql_type(o,i,s.fields[i].type)+_md.sql_composite(s.fields,i);for(i in s.tabular_sections)t+=", `ts_"+i+"` JSON"}return t+=")"}function a(){var e=["ref","_deleted"],t="INSERT INTO `"+o.table_name+"` (ref, `_deleted`",n="(?";"cat"==o.class_name.substr(0,3)?(t+=", id, name, is_folder",e.push("id"),e.push("name"),e.push("is_folder")):"doc"==o.class_name.substr(0,3)&&(t+=", posted, date, number_doc",e.push("posted"),e.push("date"),e.push("number_doc"));for(i in s.fields)t+=_md.sql_mask(i),e.push(i);for(i in s.tabular_sections)t+=", `ts_"+i+"`",e.push("ts_"+i);for(t+=") VALUES ",i=1;i<e.length;i++)n+=", ?";return n+=")",t+=n,{sql:t,fields:e,values:n}}var i,r,o=this,s=o.metadata(),l={},c=0,d=e&&e.action?e.action:"create_table";return"create_table"==d?l=n():["insert","update","replace"].indexOf(d)!=-1?l[o.table_name]=a():"select"==d?l="SELECT * FROM `"+o.table_name+"` WHERE ref = ?":"select_all"==d?l="SELECT * FROM `"+o.table_name+"`":"delete"==d?l="DELETE FROM `"+o.table_name+"` WHERE ref = ?":"drop"==d?l="DROP TABLE IF EXISTS `"+o.table_name+"`":"get_tree"==d?l=!e.filter||e.filter.is_folder?"SELECT ref, parent, name as presentation FROM `"+o.table_name+"` WHERE is_folder order by parent, name":"SELECT ref, parent, name as presentation FROM `"+o.table_name+"` order by parent, name":"get_selection"==d&&(l=t()),l}},caption_flds:{value:function(e){var t=e.metadata||this.metadata(),n='<column id="%1" width="%2" type="%3" align="%4" sort="%5">%6</column>',a=[],i="";if(t.form&&t.form.selection?a=t.form.selection.cols:this instanceof DocManager?(a.push(new Col_struct("date","160","ro","left","server","Дата")),a.push(new Col_struct("number_doc","140","ro","left","server","Номер")),t.fields.note&&a.push(new Col_struct("note","*","ro","left","server",t.fields.note.synonym)),t.fields.responsible&&a.push(new Col_struct("responsible","*","ro","left","server",t.fields.responsible.synonym))):this instanceof ChartOfAccountManager?(a.push(new Col_struct("id","140","ro","left","server","Код")),a.push(new Col_struct("presentation","*","ro","left","server","Наименование"))):a.push(new Col_struct("presentation","*","ro","left","server","Наименование")),e.get_header&&a.length){i="<head>";for(var r in a)i+=n.replace("%1",a[r].id).replace("%2",a[r].width).replace("%3",a[r].type).replace("%4",a[r].align).replace("%5",a[r].sort).replace("%6",a[r].caption);i+="</head>"}return{head:i,acols:a}}},load_cached_server_array:{value:function(e,t){var n,a=[],i=this,r=t?{class_name:i.class_name,rest_name:t}:i,o=!t;if(e.forEach(function(e){n=i.get(e.ref||e,!1,!0),(!n||o&&n.is_new())&&a.push(e.ref||e)}),a.length){var s={url:"",selection:{ref:{in:a}}};return o&&(s.fields=["ref"]),$p.rest.build_select(s,r),$p.ajax.get_ex(s.url,s).then(function(t){var n=JSON.parse(t.response);if(o)n=n.value;else{n=n.data;for(var a in n)!n[a].ref&&n[a].id&&(n[a].ref=n[a].id),n[a].Код&&(n[a].id=n[a].Код,delete n[a].Код),n[a]._not_set_loaded=!0}return i.load_array(n),e})}return Promise.resolve(e)}},predefined:{value:function(e){return this._predefined||(this._predefined={}),this._predefined[e]||(this._predefined[e]=this.get(),this.find_rows({predefined_name:e},function(t){return this._predefined[e]=t,!1})),this._predefined[e]}}}),DataProcessorsManager._extend(DataManager),DataProcessorsManager.prototype.__define({create:{value:function(){return new($p[this.obj_constructor()])({},this)}},unload_obj:{value:function(){}}}),EnumManager._extend(RefDataManager),EnumManager.prototype.__define({get:{value:function(e){if(e instanceof EnumObj)return e;e&&e!=$p.utils.blank.guid||(e="_");var t=this[e];return t||(t=new EnumObj({name:e},this)),t}},push:{value:function(e,t){this.__define(t,{value:e})}},each:{value:function(e){this.alatable.forEach(function(t){t.ref&&"_"!=t.ref&&t.ref!=$p.utils.blank.guid&&e.call(this[t.ref])}.bind(this))}}}),EnumManager.prototype.get_sql_struct=function(e){var t="CREATE TABLE IF NOT EXISTS ",n=e&&e.action?e.action:"create_table";return e&&e.postgres?"create_table"==n?t+=this.table_name+" (ref character varying(255) PRIMARY KEY NOT NULL, sequence INT, synonym character varying(255))":["insert","update","replace"].indexOf(n)!=-1?(t={},t[this.table_name]={sql:"INSERT INTO "+this.table_name+" (ref, sequence, synonym) VALUES ($1, $2, $3)",fields:["ref","sequence","synonym"],values:"($1, $2, $3)"}):"delete"==n&&(t="DELETE FROM "+this.table_name+" WHERE ref = $1"):"create_table"==n?t+="`"+this.table_name+"` (ref CHAR PRIMARY KEY NOT NULL, sequence INT, synonym CHAR)":["insert","update","replace"].indexOf(n)!=-1?(t={},t[this.table_name]={sql:"INSERT INTO `"+this.table_name+"` (ref, sequence, synonym) VALUES (?, ?, ?)",fields:["ref","sequence","synonym"],values:"(?, ?, ?)"}):"delete"==n&&(t="DELETE FROM `"+this.table_name+"` WHERE ref = ?"),t},EnumManager.prototype.get_option_list=function(e,t){function n(t){return $p.utils.is_equal(t.value,e)&&(t.selected=!0),t}var a,i=[],r="";if(t)for(var o in t)"_"!=o.substr(0,1)&&("ref"==o?a=t[o].hasOwnProperty("in")?t[o].in:t[o]:r=t[o]);return"object"==typeof r&&(r=r.like?r.like:""),r=r.toLowerCase(),this.alatable.forEach(function(e){if(!r||e.synonym&&e.synonym.toLowerCase().indexOf(r)!=-1){if(a)if(Array.isArray(a)){if(!a.some(function(t){return t.name==e.ref||t.ref==e.ref||t==e.ref}))return}else if(a.name!=e.ref&&a.ref!=e.ref&&a!=e.ref)return;i.push(n({text:e.synonym||"",value:e.ref}))}}),Promise.resolve(i)},RegisterManager._extend(DataManager),RegisterManager.prototype.__define({get_sql_struct:{value:function(e){function t(){function t(){var e=[],t="_t_.ref";if(s.form&&s.form.selection)s.form.selection.fields.forEach(function(t){e.push(t)});else for(var n in s.dimensions)e.push(n);return e.forEach(function(e){t+=e.indexOf(" as ")!=-1?", "+e:_md.sql_mask(e,!0)}),t}function n(){var e,t="";if(s.form&&s.form.selection)for(var n in s.form.selection.fields)s.form.selection.fields[n].indexOf(" as ")!=-1&&s.form.selection.fields[n].indexOf("_t_.")==-1&&(e=s.form.selection.fields[n].split(" as "),e[0]=e[0].split("."),e[0].length>1&&(t&&(t+="\n"),t+="left outer join "+e[0][0]+" on "+e[0][0]+".ref = _t_."+e[1]));return t}function a(){var t=" WHERE ("+(r?0:1);return o.sql_selection_where_flds&&(t+=o.sql_selection_where_flds(r)),t+=")",e.selection&&("function"==typeof e.selection||e.selection.forEach(function(e){for(var n in e)if("function"==typeof e[n])t+="\n AND "+e[n](o,n)+" ";else if(s.fields.hasOwnProperty(n))if(e[n]===!0)t+="\n AND _t_."+n+" ";else if(e[n]===!1)t+="\n AND (not _t_."+n+") ";else if("object"==typeof e[n])if($p.utils.is_data_obj(e[n]))t+="\n AND (_t_."+n+" = '"+e[n]+"') ";else{var a,i=Object.keys(e[n]),r=e[n][i[0]],l=s.fields[n];l&&l.type.is_ref&&(a=_md.value_mgr({},n,l.type,!0,r)),t+="not"==i[0]?"\n AND (not _t_."+n+" = '"+r+"') ":"\n AND (_t_."+n+" = '"+r+"') "}else t+="string"==typeof e[n]?"\n AND (_t_."+n+" = '"+e[n]+"') ":"\n AND (_t_."+n+" = "+e[n]+") ";else"is_folder"==n&&s.hierarchical&&s.group_hierarchy})),t}function i(){return""}var r=e.filter||"";r&&r.indexOf("%")==-1&&(r="%"+r+"%");var l;return l=o.sql_selection_list_flds?o.sql_selection_list_flds():("SELECT %2 FROM `"+o.table_name+"` AS _t_ %j %3 %4 LIMIT 300").replace("%2",t()).replace("%j",n()),l.replace("%3",a()).replace("%4",i())}function n(){var t="CREATE TABLE IF NOT EXISTS ",n=!0;if(e&&e.postgres){t+=o.table_name+" (",s.splitted&&(t+="zone integer",n=!1);for(r in s.dimensions)n?(t+=r,n=!1):t+=", "+r,t+=_md.sql_type(o,r,s.dimensions[r].type,!0)+_md.sql_composite(s.dimensions,r,"",!0);for(r in s.resources)t+=", "+r+_md.sql_type(o,r,s.resources[r].type,!0)+_md.sql_composite(s.resources,r,"",!0);for(r in s.attributes)t+=", "+r+_md.sql_type(o,r,s.attributes[r].type,!0)+_md.sql_composite(s.attributes,r,"",!0);t+=", PRIMARY KEY (",n=!0,s.splitted&&(t+="zone",n=!1);for(r in s.dimensions)n?(t+=r,n=!1):t+=", "+r}else{t+="`"+o.table_name+"` (ref CHAR PRIMARY KEY NOT NULL, `_deleted` BOOLEAN";for(r in s.dimensions)t+=_md.sql_mask(r)+_md.sql_type(o,r,s.dimensions[r].type);for(r in s.resources)t+=_md.sql_mask(r)+_md.sql_type(o,r,s.resources[r].type);for(r in s.attributes)t+=_md.sql_mask(r)+_md.sql_type(o,r,s.attributes[r].type)}return t+=")"}function a(){var e="INSERT OR REPLACE INTO `"+o.table_name+"` (",t=[],n=!0;for(r in s.dimensions)n?(e+=r,n=!1):e+=", "+r,t.push(r);for(r in s.resources)e+=", "+r,t.push(r);for(r in s.attributes)e+=", "+r,t.push(r);for(e+=") VALUES (?",r=1;r<t.length;r++)e+=", ?";return e+=")",{sql:e,fields:t}}function i(){var t="SELECT * FROM `"+o.table_name+"` WHERE ",n=!0;e._values=[];for(var a in s.dimensions)n?n=!1:t+=" and ",t+="`"+a+"`=?",e._values.push(e[a]);return n&&(t+="1"),t}var r,o=this,s=o.metadata(),l={},c=e&&e.action?e.action:"create_table";return"create_table"==c?l=n():c in{insert:"",update:"",replace:""}?l[o.table_name]=a():"select"==c?l=i():"select_all"==c?l=i():"delete"==c?l="DELETE FROM `"+o.table_name+"` WHERE ref = ?":"drop"==c?l="DROP TABLE IF EXISTS `"+o.table_name+"`":"get_selection"==c&&(l=t()),l}},get_ref:{value:function(e){if(e instanceof RegisterRow&&(e=e._obj),e.ref)return e.ref;var t="",n=this.metadata().dimensions;for(var a in n)t+=t?"¶":"",t+=n[a].type.is_ref?$p.utils.fix_guid(e[a]):!e[a]&&n[a].type.digits?"0":n[a].date_part?$p.moment(e[a]||$p.utils.blank.date).format($p.moment.defaultFormatUtc):void 0!=e[a]?String(e[a]):"$";return t}},caption_flds:{value:function(e){var t=e.metadata||this.metadata(),n='<column id="%1" width="%2" type="%3" align="%4" sort="%5">%6</column>',a=[],i="";if(t.form&&t.form.selection)a=t.form.selection.cols;else for(var r in t.dimensions)a.push(new Col_struct(r,"*","ro","left","server",t.dimensions[r].synonym));if(e.get_header&&a.length){i="<head>";for(var o in a)i+=n.replace("%1",a[o].id).replace("%2",a[o].width).replace("%3",a[o].type).replace("%4",a[o].align).replace("%5",a[o].sort).replace("%6",a[o].caption);i+="</head>"}return{head:i,acols:a}}},create:{value:function(e){e&&"object"==typeof e||(e={});var t=this.by_ref[e.ref];if(!t){t=new($p[this.obj_constructor()])(e,this);var n=this.handle_event(t,"after_create");if(n===!1)return Promise.resolve(t);if("object"==typeof n&&n.then)return n}return Promise.resolve(t)}}}),InfoRegManager._extend(RegisterManager),InfoRegManager.prototype.slice_first=function(e){},InfoRegManager.prototype.slice_last=function(e){},LogManager._extend(InfoRegManager),AccumRegManager._extend(RegisterManager),CatManager._extend(RefDataManager),CatManager.prototype.by_name=function(e){var t;return this.find_rows({name:e},function(e){return t=e,!1}),t||(t=this.get()),t},CatManager.prototype.by_id=function(e){var t;return this.find_rows({id:e},function(e){return t=e,!1}),t||(t=this.get()),t},CatManager.prototype.path=function(e){var t,n=[];if(t=e instanceof DataObj?e:this.get(e,!1,!0),t&&n.push({ref:t.ref,presentation:t.presentation}),t&&this.metadata().hierarchical)for(;;){if(t=t.parent,t.empty())break;n.push({ref:t.ref,presentation:t.presentation})}return n},ChartOfCharacteristicManager._extend(CatManager),ChartOfAccountManager._extend(CatManager),DocManager._extend(RefDataManager),TaskManager._extend(CatManager),BusinessProcessManager._extend(CatManager),DataObj.prototype._getter=function(e){var t,n=this._metadata.fields[e].type,a=this._obj?this._obj[e]:"";return"type"==e&&"object"==typeof a?a:"ref"==e?a:n.is_ref?n.digits&&"number"==typeof a?a:n.hasOwnProperty("str_len")&&!$p.utils.is_guid(a)?a:(t=_md.value_mgr(this._obj,e,n))?$p.utils.is_data_mgr(t)?t.get(a,!1):$p.utils.fetch_type(a,t):a?(console.log([e,n,this._obj]),null):void 0:n.date_part?$p.utils.fix_date(this._obj[e],!0):n.digits?$p.utils.fix_number(this._obj[e],!n.hasOwnProperty("str_len")):"boolean"==n.types[0]?$p.utils.fix_boolean(this._obj[e]):this._obj[e]||""},DataObj.prototype.__setter=function(e,t){var n,a=this._metadata.fields[e].type;"type"==e&&t.types?this._obj[e]=t:"ref"==e?this._obj[e]=$p.utils.fix_guid(t):a.is_ref?a.digits&&"number"==typeof t||a.hasOwnProperty("str_len")&&"string"==typeof t&&!$p.utils.is_guid(t)?this._obj[e]=t:(this._obj[e]=$p.utils.fix_guid(t),n=_md.value_mgr(this._obj,e,a,!1,t),n?n instanceof EnumManager?"string"==typeof t?this._obj[e]=t:t?"object"==typeof t&&(this._obj[e]=t.ref||t.name||""):this._obj[e]="":t&&t.presentation?(!t.type||t instanceof DataObj||delete t.type,n.create(t)):$p.utils.is_data_mgr(n)||(this._obj[e]=$p.utils.fetch_type(t,n)):"object"!=typeof t&&(this._obj[e]=t)):a.date_part?this._obj[e]=$p.utils.fix_date(t,!0):a.digits?this._obj[e]=$p.utils.fix_number(t,!a.hasOwnProperty("str_len")):"boolean"==a.types[0]?this._obj[e]=$p.utils.fix_boolean(t):this._obj[e]=t},DataObj.prototype.__notify=function(e){this._data._silent||Object.getNotifier(this).notify({type:"update",name:e,oldValue:this._obj[e]})},DataObj.prototype._setter=function(e,t){this._obj[e]!=t&&(this.__notify(e),this.__setter(e,t),this._data._modified=!0)},DataObj.prototype._getter_ts=function(e){return this._ts_(e)},DataObj.prototype._setter_ts=function(e,t){var n=this._ts_(e);n instanceof TabularSection&&Array.isArray(t)&&n.load(t)},DataObj.prototype.__define({valueOf:{value:function(){return this.ref}},toJSON:{value:function(){return this._obj}},toString:{value:function(){return this.presentation}},_metadata:{get:function(){return this._manager.metadata()}},_deleted:{get:function(){return!!this._obj._deleted}},_modified:{get:function(){return!!this._data&&!!this._data._modified}},is_new:{value:function(){return this._data._is_new}},_set_loaded:{value:function(e){this._manager.push(this,e),this._data._modified=!1,this._data._is_new=!1}},mark_deleted:{value:function(e){this._obj._deleted=!!e,this.save(),this.__notify("_deleted")}},ref:{get:function(){return this._obj.ref},set:function(e){this._obj.ref=$p.utils.fix_guid(e)},enumerable:!0,configurable:!0},empty:{value:function(){return $p.utils.is_empty_guid(this._obj.ref)}},load:{value:function(){var e=function(){return e=null,this._data._modified=!1,this}.bind(this);return this.ref==$p.utils.blank.guid?(this instanceof CatObj?this.id="000000000":this.number_doc="000000000",Promise.resolve(this)):this._manager.cachable&&"e1cib"!=this._manager.cachable?$p.wsql.pouch.load_obj(this).then(e):_rest.load_obj(this).then(e)}},unload:{value:function(){var e,t=this._obj;this._manager.unload_obj(this.ref),this._observers&&(this._observers.length=0),this._notis&&(this._notis.length=0);for(e in this._metadata.tabular_sections)this[e].clear(!0);for(e in this)this.hasOwnProperty(e)&&delete this[e];for(e in t)delete t[e];["_ts_","_obj","_data"].forEach(function(e){delete this[e]}.bind(this)),e=t=null}},save:{value:function(e,t,n){this instanceof DocObj&&"boolean"==typeof e&&(this.posted=e);var a,i=this._manager.handle_event(this,"before_save"),r=function(){return i!==!1&&(this._data._modified=!1),a=null,i=null,r=null,this}.bind(this);if(this._metadata.hierarchical&&!this._obj.parent&&(this._obj.parent=$p.utils.blank.guid),!this.id&&this._metadata.code_length&&"ram"!=this._manager.cachable){var o=($p.current_acl&&$p.current_acl.prefix||"")+($p.wsql.get_user_param("zone")+"-"),s=this._metadata.code_length-o.length,l="",c=$p.wsql.alasql("select max(id) as id from ? where id like '"+o+"%'",[this._manager.alatable]);if(c.length){for(var d=c[0].id||"",u=d.length-1;u>0&&!isNaN(parseInt(d[u]));u--)l=d[u]+l;l=(parseInt(l||0)+1).toFixed(0)}else l="1";for(;l.length<s;)l="0"+l;this.id=o+l}if(this instanceof DocObj&&$p.utils.blank.date==this.date&&(this.date=new Date),$p.msg&&$p.msg.show_msg)for(var f in this._metadata.fields)if(this._metadata.fields[f].mandatory&&!this._obj[f])return $p.msg.show_msg({title:$p.msg.mandatory_title,type:"alert-error",text:$p.msg.mandatory_field.replace("%1",this._metadata.fields[f].synonym)}),i=!1,Promise.reject(r());return i===!1?Promise.resolve(this).then(r):i instanceof Promise||"object"==typeof i&&i.then?i.then(r):(a=this._manager.cachable&&"e1cib"!=this._manager.cachable?$p.wsql.pouch.save_obj:_rest.save_irest,a(this,{post:e,operational:t,attachments:n}).then(function(e){return e._manager.handle_event(e,"after_save")}).then(r))}},get_attachment:{value:function(e){return this._manager.get_attachment(this.ref,e)}},save_attachment:{value:function(e,t,n){return this._manager.save_attachment(this.ref,e,t,n)}},delete_attachment:{value:function(e){return this._manager.get_attachment(this.ref,e)}},_silent:{value:function(e){"boolean"==typeof e?this._data._silent=e:(this._data._silent=!0,setTimeout(function(){this._data._silent=!1}.bind(this)))}},print:{value:function(e,t){return this._manager.print(this,e,t)}}}),CatObj._extend(DataObj),CatObj.prototype.__define("id",{get:function(){return this._obj.id||""},set:function(e){this.__notify("id"),this._obj.id=e},enumerable:!0}),CatObj.prototype.__define("name",{get:function(){return this._obj.name||""},set:function(e){this.__notify("name"),this._obj.name=String(e)},enumerable:!0}),DocObj._extend(DataObj),DocObj.prototype.__define({posted:{get:function(){return this._obj.posted||!1},set:function(e){this.__notify("posted"),this._obj.posted=$p.utils.fix_boolean(e)},enumerable:!0}}),doc_props_date_number(DocObj.prototype),DataProcessorObj._extend(DataObj),TaskObj._extend(CatObj),doc_props_date_number(TaskObj.prototype),BusinessProcessObj._extend(CatObj),doc_props_date_number(BusinessProcessObj.prototype),EnumObj._extend(DataObj),EnumObj.prototype.__define({order:{get:function(){return this._obj.sequence},set:function(e){this._obj.sequence=parseInt(e)},enumerable:!0},name:{get:function(){return this._obj.ref},set:function(e){this._obj.ref=String(e)},enumerable:!0},synonym:{get:function(){return this._obj.synonym||""},set:function(e){this._obj.synonym=String(e)},enumerable:!0},presentation:{get:function(){return this.synonym||this.name}},empty:{value:function(){return!this.ref||"_"==this.ref}}}),RegisterRow._extend(DataObj),RegisterRow.prototype.__define({_metadata:{get:function(){var e=this._manager.metadata();return e.fields||(e.fields={}._mixin(e.dimensions)._mixin(e.resources)._mixin(e.attributes)),e}},ref:{get:function(){return this._manager.get_ref(this)},enumerable:!0},presentation:{get:function(){return this._metadata.obj_presentation||this._metadata.synonym}}}),TabularSection.prototype.toString=function(){return"Табличная часть "+this._owner._manager.class_name+"."+this._name},TabularSection.prototype.get=function(e){return this._obj[e]._row},TabularSection.prototype.count=function(){return this._obj.length},TabularSection.prototype.clear=function(e){for(var t in this._obj)delete this._obj[t];return this._obj.length=0,e||this._owner._data._silent||Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name}),this},TabularSection.prototype.del=function(e,t){var n,a=this._obj;if("undefined"!=typeof e){if("number"==typeof e)n=e;else if(a[e.row-1]._row===e)n=e.row-1;else for(var i in a)if(a[i]._row===e){n=Number(i),delete a[i]._row;break}void 0!=n&&(a.splice(n,1),a.forEach(function(e,t){e.row=t+1}),t||this._owner._data._silent||Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name}),this._owner._data._modified=!0)}},TabularSection.prototype.find=function(e,t){var n=$p._find(this._obj,e,t);if(n)return n._row},TabularSection.prototype.find_rows=function(e,t){var n=this,a=t?function(e){return t.call(n,e._row)}:null;return $p._find_rows.call(n,n._obj,e,a)},TabularSection.prototype.swap=function(e,t){var n=this._obj[e];this._obj[e]=this._obj[t],this._obj[t]=n,this._owner._data._silent||Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name})},TabularSection.prototype.add=function(e,t){var n=new($p[this._owner._manager.obj_constructor(this._name)])(this);e||(e={});for(var a in n._metadata.fields)n[a]=e[a]||"";return n._obj.row=this._obj.push(n._obj),n._obj.__define("_row",{value:n,enumerable:!1}),t||this._owner._data._silent||Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name}),e=null,this._owner._data._modified=!0,n},TabularSection.prototype.each=function(e){var t=this;t._obj.forEach(function(n){return e.call(t,n._row)})},TabularSection.prototype.forEach=TabularSection.prototype.each,TabularSection.prototype.group_by=function(e,t){try{var n=this.aggregate(e,t,"SUM",!0);return this.clear(!0).load(n)}catch(e){}},TabularSection.prototype.sort=function(e){"string"==typeof e&&(e=e.split(","));var t="select * from ? order by ",n=!0;e.forEach(function(e){e=e.trim().replace(/\s{1,}/g," ").split(" "),n?n=!1:t+=", ",t+="`"+e[0]+"`",e[1]&&(t+=" "+e[1])});try{return n=$p.wsql.alasql(t,[this._obj]),this.clear(!0).load(n)}catch(e){$p.record_log(e)}},TabularSection.prototype.aggregate=function(e,t,n,a){if("string"==typeof e&&(e=e.split(",")),"string"==typeof t&&(t=t.split(",")),n||(n="sum"),!e.length&&1==t.length&&"sum"==n)return this._obj.reduce(function(e,n,a,i){return e+n[t[0]]},0);var i,r=!0;t.forEach(function(e){i?i+=", "+n+"(`"+e+"`) `"+e+"`":i="select "+n+"(`"+e+"`) `"+e+"`"}),e.forEach(function(e){i?i+=", `"+e+"`":i="select `"+e+"`"}),i+=" from ? ",e.forEach(function(e){r?(i+="group by ",r=!1):i+=", ",i+="`"+e+"`"});try{return r=$p.wsql.alasql(i,[this._obj]),a||(r=1==t.length?r.length?r[0][t[0]]:0:r.length?r[0]:{}),r}catch(e){$p.record_log(e)}},TabularSection.prototype.load=function(e){var t,n=this;return n.clear(!0),e instanceof TabularSection?t=e._obj:Array.isArray(e)&&(t=e),t&&t.forEach(function(e){n.add(e,!0)}),this._owner._data._silent||Object.getNotifier(n._owner).notify({type:"rows",tabular:n._name}),n},TabularSection.prototype.sync_grid=function(e,t){for(var n={rows:[]},a=[],i=0;i<e.getColumnCount();i++)a.push(e.getColumnId(i));if(e.clearAll(),this.find_rows(t,function(e){var t=[];a.forEach(function(n){$p.utils.is_data_obj(e[n])?t.push(e[n].presentation):t.push(e[n])}),n.rows.push({id:e.row,data:t})}),e.objBox)try{e.parse(n,"json"),e.callEvent("onGridReconstructed",[])}catch(e){}},TabularSection.prototype.toJSON=function(){return this._obj},TabularSectionRow.prototype.__define("_metadata",{get:function(){return this._owner._owner._metadata.tabular_sections[this._owner._name]},enumerable:!1}),TabularSectionRow.prototype.__define("row",{
get:function(){return this._obj.row||0},enumerable:!0}),TabularSectionRow.prototype.__define("_clone",{value:function(){return new($p[this._owner._owner._manager.obj_constructor(this._owner._name)])(this._owner)._mixin(this._obj)},enumerable:!1}),TabularSectionRow.prototype._getter=DataObj.prototype._getter,TabularSectionRow.prototype._setter=function(e,t){if(this._obj[e]!=t&&(t||this._obj[e]!=$p.utils.blank.guid)){if(this._owner._owner._data._silent||Object.getNotifier(this._owner._owner).notify({type:"row",row:this,tabular:this._owner._name,name:e,oldValue:this._obj[e]}),this._metadata.fields[e].choice_type){var n;n=2==this._metadata.fields[e].choice_type.path.length?this[this._metadata.fields[e].choice_type.path[1]]:this._owner._owner[this._metadata.fields[e].choice_type.path[0]],n&&n.type&&(t=$p.utils.fetch_type(t,n.type))}DataObj.prototype.__setter.call(this,e,t),this._owner._owner._data._modified=!0}};var _rest=$p.rest=new Rest;DataManager.prototype.__define("rest_name",{get:function(){var e=this.class_name.split("."),t={cat:"Catalog",doc:"Document",ireg:"InformationRegister",areg:"AccumulationRegister",cch:"ChartOfCharacteristicTypes",cacc:"ChartOfAccounts",tsk:"Task",bp:"BusinessProcess"};return t[e[0]]+"_"+_md.syns_1с(e[1])},enumerable:!1}),DataManager.prototype.rest_tree=function(e){var t,n,a=this,i=a.metadata(),r=[];return $p.ajax.default_attr(e,!i.irest&&$p.job_prm.rest?$p.job_prm.rest_url():$p.job_prm.irest_url()),e.url+=this.rest_name+"?allowedOnly=true&$format=json&$top=1000&$select=Ref_Key,DeletionMark,Parent_Key,Description&$filter=IsFolder eq true",$p.ajax.get_ex(e.url,e).then(function(e){return JSON.parse(e.response)}).then(function(e){for(var a=0;a<e.value.length;a++)n=e.value[a],t={ref:n.Ref_Key,_deleted:n.DeletionMark,parent:n.Parent_Key,presentation:n.Description},r.push(t);return $p.iface.data_to_tree(r)})},DataManager.prototype.rest_selection=function(e){if("get_tree"==e.action)return this.rest_tree(e);var t,n,a,i,r,o,s=this,l=s.metadata(),c=[],d=[];return r=function(){var e="$select=Ref_Key,DeletionMark";return l.form&&l.form.selection?l.form.selection.fields.forEach(function(e){c.push(e)}):s instanceof DocManager?(c.push("posted"),c.push("date"),c.push("number_doc")):s instanceof TaskManager?(c.push("name as presentation"),c.push("date"),c.push("number_doc"),c.push("completed")):s instanceof BusinessProcessManager?(c.push("date"),c.push("number_doc"),c.push("started"),c.push("finished")):(l.hierarchical&&l.group_hierarchy?c.push("is_folder"):c.push("0 as is_folder"),l.main_presentation_name?c.push("name as presentation"):l.code_length?c.push("id as presentation"):c.push("'...' as presentation"),l.has_owners&&c.push("owner"),l.code_length&&c.push("id")),c.forEach(function(t){var n;if(t.indexOf(" as ")!=-1)if(n=t.split(" as ")[0].split("."),1==n.length)t=n[0];else{if("_t_"!=n[0])return;t=n[1]}"0"!=t&&(a=_md.syns_1с(t),_md.get(s.class_name,t).type.is_ref&&a.indexOf("_Key")==-1&&_md.get(s.class_name,t).type.types.length&&_md.get(s.class_name,t).type.types[0].indexOf("enm.")==-1&&(a+="_Key"),e+=","+a)}),c.push("ref"),c.push("_deleted"),e}(),$p.ajax.default_attr(e,!l.irest&&$p.job_prm.rest?$p.job_prm.rest_url():$p.job_prm.irest_url()),e.url+=(l.irest&&l.irest.selection?l.irest.selection:this.rest_name)+"?allowedOnly=true&$format=json&$top=1000&"+r,_md.get(s.class_name,"date")&&(e.date_from||e.date_till)&&(e.url+="&$filter="+_rest.filter_date("Date",e.date_from,e.date_till),o=!0),l.hierarchical&&e.parent&&(e.url+=o?" and ":"&$filter=",e.url+="Parent_Key eq guid'"+e.parent+"'",o=!0),l.has_owners&&e.owner&&(e.url+=o?" and ":"&$filter=",e.url+="Owner_Key eq guid'"+e.owner+"'",o=!0),e.filter&&(e.url+=o?" and ":"&$filter=",e.url+="$filter eq '"+e.filter+"'",o=!0),$p.ajax.get_ex(e.url,e).then(function(e){return JSON.parse(e.response)}).then(function(r){for(var o=0;o<r.value.length;o++)n=r.value[o],t={},c.forEach(function(e){var r;if("ref"==e)return void(t[e]=n.Ref_Key);if(e.indexOf(" as ")!=-1?(r=e.split(" as ")[1],e=e.split(" as ")[0].split("."),e=e[e.length-1]):r=e,a=_md.syns_1с(e),i=_md.get(s.class_name,e))if(a.indexOf("_Key")==-1&&i.type.is_ref&&i.type.types.length&&i.type.types[0].indexOf("enm.")==-1&&(a+="_Key"),i.type.date_part)t[r]=$p.moment(n[a]).format($p.moment._masks[i.type.date_part]);else if(i.type.is_ref)if(n[a]&&n[a]!=$p.utils.blank.guid){var o=_md.value_mgr(t,e,i.type,!1,n[a]);o?t[r]=o.get(n[a]).presentation:t[r]=""}else t[r]="";else t[r]=n[a]}),d.push(t);return $p.iface.data_to_grid.call(s,d,e)})},InfoRegManager.prototype.rest_slice_last=function(e){e.period||(e.period=$p.utils.date_add_day(new Date,1));var t=this,n=t.metadata(),a="Period=datetime'"+$p.moment(e.period).format($p.moment._masks.iso)+"'",i="";for(var r in n.dimensions)if(void 0!==e[r]){var o=_md.syns_1с(r),s=n.dimensions[r];o.indexOf("_Key")==-1&&s.type.is_ref&&s.type.types.length&&s.type.types[0].indexOf("enm.")==-1?(o+="_Key",i&&(i+=" and "),i+=o+" eq guid'"+e[r].ref+"'"):(i&&(i+=" and "),i+=s.type.digits?o+" eq "+$p.utils.fix_number(e[r]):s.type.date_part?o+" eq datetime'"+$p.moment(e[r]).format($p.moment._masks.iso)+"'":o+" eq '"+e[r]+"'")}return i&&(a+=",Condition='"+i+"'"),$p.ajax.default_attr(e,$p.job_prm.rest_url()),e.url+=this.rest_name+"/SliceLast(%sl)?allowedOnly=true&$format=json&$top=1000".replace("%sl",a),_rest.ajax_to_data(e,t).then(function(e){return t.load_array(e)})},DataObj.prototype.to_atom=function(e){function t(e){var t=e._metadata.fields,i=e instanceof TabularSectionRow?"\n\t<d:":"\n<d:";for(n in t){if(a=t[n],s=_md.syns_1с(n),l=e[n],l instanceof EnumObj)l=l.empty()?"":l.name;else if(l instanceof DataObj)s.indexOf("_Key")==-1&&(s+="_Key"),l=l.ref;else if(a.type.date_part)l=l.getFullYear()<1e3?"0001-01-01T00:00:00Z":$p.moment(l).format($p.moment.defaultFormatUtc);else if(void 0==l)continue;d+=i+s+">"+l+"</d:"+s+">"}}var n,a,i,r,o,s,l,c='<entry><category term="StandardODATA.%n" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme"/>\t\t\t\t\n<title type="text"/><updated>%d</updated><author/><summary/><content type="application/xml">\t\t\t\t\n<m:properties xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices" xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata">\t\t\t%p\t\t\t\n</m:properties></content></entry>'.replace("%n",this._manager.rest_name).replace("%d",$p.moment().format($p.moment.defaultFormatUtc)),d="\n<d:Ref_Key>"+this.ref+"</d:Ref_Key>\n<d:DeletionMark>"+this._deleted+"</d:DeletionMark>";this instanceof DocObj?(d+="\n<d:Date>"+$p.moment(this.date).format($p.moment.defaultFormatUtc)+"</d:Date>",d+="\n<d:Number>"+this.number_doc+"</d:Number>"):(this._metadata.main_presentation_name&&(d+="\n<d:Description>"+this.name+"</d:Description>"),this._metadata.code_length&&(d+="\n<d:Code>"+this.id+"</d:Code>"),this._metadata.hierarchical&&this._metadata.group_hierarchy&&(d+="\n<d:IsFolder>"+this.is_folder+"</d:IsFolder>")),t(this);for(i in this._metadata.tabular_sections)o=this._metadata.tabular_sections[i],s="StandardODATA."+this._manager.rest_name+"_"+_md.syns_1с(i)+"_RowType",r=this[i],r.count()?(d+="\n<d:"+_md.syns_1с(i)+' m:type="Collection('+s+')">',r.each(function(e){d+='\n\t<d:element m:type="'+s+'">',d+="\n\t<d:LineNumber>"+e.row+"</d:LineNumber>",t(e),d+="\n\t</d:element>"}),d+="\n</d:"+_md.syns_1с(i)+">"):d+="\n<d:"+_md.syns_1с(i)+' m:type="Collection('+s+')" />';return c.replace("%p",d)},DataManager.prototype.__define({pouch_load_array:{value:function(e,t){var n={limit:e.length+1,include_docs:!0,keys:e.map(function(e){return this.class_name+"|"+e}.bind(this))};return t&&(n.attachments=!0,n.binary=!0),this.pouch_db.allDocs(n).then(function(e){return $p.wsql.pouch.load_changes(e,{})})}},pouch_load_view:{value:function(e){var t,n=this,a=[],i={limit:1e3,include_docs:!0,startkey:n.class_name+"|",endkey:n.class_name+"|￿"};return new Promise(function(r,o){function s(l,c){c?c.rows.length?(i.startkey=c.rows[c.rows.length-1].key,i.skip=1,c.rows.forEach(function(e){t=e.doc,key=t._id.split("|"),t.ref=key[1],a.push(t)}),n.load_array(a),a.length=0,n.pouch_db.query(e,i,s)):r():l&&o(l)}n.pouch_db.query(e,i,s)})}},pouch_db:{get:function(){return this.cachable.indexOf("_remote")!=-1?$p.wsql.pouch.remote[this.cachable.replace("_remote","")]:$p.wsql.pouch.local[this.cachable]||$p.wsql.pouch.remote[this.cachable]}},pouch_find_rows:{value:function(e){var t,n,a,i,r,o,s=this,l=[],c=0,d=0,u=0,f={limit:100,include_docs:!0,startkey:s.class_name+"|",endkey:s.class_name+"|￿"};return e&&(e._top?(r=e._top,delete e._top):r=300,e._raw&&(n=e._raw,delete e._raw),e._total_count&&(i=e._total_count,delete e._total_count),e._view&&(a=e._view,delete e._view),e._key&&("des"==e._key._order_by?(f.startkey=e._key.endkey||e._key+"￿",f.endkey=e._key.startkey||e._key,f.descending=!0):(f.startkey=e._key.startkey||e._key,f.endkey=e._key.endkey||e._key+"￿")),"number"==typeof e._skip&&(d=e._skip,delete e._skip),e._attachments&&(f.attachments=!0,f.binary=!0,delete e._attachments)),i&&(o=!0,i=0,Object.keys(e).length<=1&&e._key&&e._key.hasOwnProperty("_search"))?(f.include_docs=!1,f.limit=1e5,s.pouch_db.query(a,f).then(function(t){return t.rows.forEach(function(t){if(!e._key._search||t.key[t.key.length-1].toLowerCase().indexOf(e._key._search)!=-1){if(i++,d&&(u++,u<d))return;if(r&&(c++,c>r))return;l.push(t.id)}}),delete f.startkey,delete f.endkey,f.descending&&delete f.descending,f.keys=l,f.include_docs=!0,s.pouch_db.allDocs(f)}).then(function(e){return{rows:e.rows.map(function(e){var t=e.doc;return t.ref=t._id.split("|")[1],n||(delete t._id,delete t._rev),t}),_total_count:i}})):new Promise(function(p,_){function h(a,h){h?h.rows.length?(f.startkey=h.rows[h.rows.length-1].key,f.skip=1,h.rows.forEach(function(a){t=a.doc,key=t._id.split("|"),t.ref=key[1],n||(delete t._id,delete t._rev),$p._selection.call(s,t,e)&&(o&&i++,d&&(u++,u<d)||r&&(c++,c>r)||l.push(t))}),r&&c>r&&!o?p(n?l:s.load_array(l)):m()):p(o?{rows:n?l:s.load_array(l),_total_count:i}:n?l:s.load_array(l)):a&&_(a)}function m(){a?s.pouch_db.query(a,f,h):s.pouch_db.allDocs(f,h)}m()})}},pouch_selection:{value:function(e){var t,n,a,i=this,r=e.metadata||i.metadata(),o=["ref","_deleted"],s={_raw:!0,_total_count:!0,_top:e.count||30,_skip:e.start||0},l=[];if(r.form&&r.form.selection?r.form.selection.fields.forEach(function(e){o.push(e)}):i instanceof DocManager?(o.push("posted"),o.push("date"),o.push("number_doc")):i instanceof TaskManager?(o.push("name as presentation"),o.push("date"),o.push("number_doc"),o.push("completed")):i instanceof BusinessProcessManager?(o.push("date"),o.push("number_doc"),o.push("started"),o.push("finished")):(r.hierarchical&&r.group_hierarchy?o.push("is_folder"):o.push("0 as is_folder"),r.main_presentation_name?o.push("name as presentation"):r.code_length?o.push("id as presentation"):o.push("'...' as presentation"),r.has_owners&&o.push("owner"),r.code_length&&o.push("id")),_md.get(i.class_name,"date")&&(e.date_from||e.date_till)&&(e.date_from||(e.date_from=new Date("2015-01-01")),e.date_till||(e.date_till=$p.utils.date_add_day(new Date,1)),s.date={between:[e.date_from,e.date_till]}),r.hierarchical&&e.parent&&(s.parent=e.parent),e.selection)if(Array.isArray(e.selection))e.selection.forEach(function(e){for(a in e)"_"==a[0]&&"_view"!=a&&"_key"!=a||(s[a]=e[a])});else for(a in e.selection)"_"==a[0]&&"_view"!=a&&"_key"!=a||(s[a]=e.selection[a]);return s._key&&s._key._drop_date&&s.date&&delete s.date,!e.filter||s._key&&s._key._search||(1==r.input_by_string.length?s[r.input_by_string]={like:e.filter}:(s.or=[],r.input_by_string.forEach(function(t){var n={};n[t]={like:e.filter},s.or.push(n)}))),s._key&&s._key._order_by&&(s._key._order_by=e.direction),i.pouch_find_rows(s).then(function(r){return r.hasOwnProperty("_total_count")&&r.hasOwnProperty("rows")&&(e._total_count=r._total_count,r=r.rows),r.forEach(function(e){t={},o.forEach(function(r){if("ref"==r)return void(t[r]=e[r]);if(r.indexOf(" as ")!=-1?(a=r.split(" as ")[1],r=r.split(" as ")[0].split("."),r=r[r.length-1]):a=r,n=_md.get(i.class_name,r))if(n.type.date_part)t[a]=$p.moment(e[r]).format($p.moment._masks[n.type.date_part]);else if(n.type.is_ref)if(e[r]&&e[r]!=$p.utils.blank.guid){var o=_md.value_mgr(t,r,n.type,!1,e[r]);o?t[a]=o.get(e[r]).presentation:t[a]=""}else t[a]="";else"number"==typeof e[r]&&n.type.fraction_figits?t[a]=e[r].toFixed(n.type.fraction_figits):t[a]=e[r]}),l.push(t)}),$p.iface.data_to_grid.call(i,l,e)}).catch($p.record_log)}},pouch_tree:{value:function(e){return this.pouch_find_rows({is_folder:!0,_raw:!0,_top:e.count||300,_skip:e.start||0}).then(function(e){return e.sort(function(e,t){return e.parent==$p.utils.blank.guid&&t.parent!=$p.utils.blank.guid?-1:t.parent==$p.utils.blank.guid&&e.parent!=$p.utils.blank.guid?1:e.name<t.name?-1:e.name>t.name?1:0}),e.map(function(e){return{ref:e.ref,parent:e.parent,presentation:e.name}})}).then($p.iface.data_to_tree)}},save_attachment:{value:function(e,t,n,a){a||(a={type:"text/plain"}),n instanceof Blob||a.indexOf("text")!=-1||(n=new Blob([n],{type:a}));var i,r=this.pouch_db;return e=this.class_name+"|"+$p.utils.fix_guid(e),r.get(e).then(function(e){e&&(i=e._rev)}).catch(function(e){if(404!=e.status)throw e}).then(function(){return r.putAttachment(e,t,i,n,a)})}},get_attachment:{value:function(e,t){return this.pouch_db.getAttachment(this.class_name+"|"+$p.utils.fix_guid(e),t)}},delete_attachment:{value:function(e,t){var n,a=this.pouch_db;return e=this.class_name+"|"+$p.utils.fix_guid(e),a.get(e).then(function(e){e&&(n=e._rev)}).catch(function(e){if(404!=e.status)throw e}).then(function(){return a.removeAttachment(e,t,n)})}}}),DocObj.prototype.__define({new_number_doc:{value:function(){var e=this,t=($p.current_acl&&$p.current_acl.prefix||"")+(e.organization&&e.organization.prefix?e.organization.prefix:$p.wsql.get_user_param("zone")+"-"),n=e._metadata.code_length-t.length,a="";return e._manager.pouch_db.query("doc/number_doc",{limit:1,include_docs:!1,startkey:[e._manager.class_name,t+"￿"],endkey:[e._manager.class_name,t],descending:!0}).then(function(i){if(i.rows.length){for(var r=i.rows[0].key[1],o=r.length-1;o>0&&!isNaN(parseInt(r[o]));o--)a=r[o]+a;a=(parseInt(a||0)+1).toFixed(0)}else a="1";for(;a.length<n;)a="0"+a;return e.number_doc=t+a,e})}}}),$p.iface.OBtnAuthSync=function(){function e(){$p.wsql.pouch.authorized?dhtmlx.confirm({title:$p.msg.log_out_title,text:$p.msg.logged_in+$p.wsql.pouch.authorized+$p.msg.log_out_break,cancel:$p.msg.cancel,callback:function(e){e&&$p.wsql.pouch.log_out()}}):$p.iface.frm_auth({modal_dialog:!0})}function t(e){e&&a?clearTimeout(a):i.forEach(function(t){e?t.buttons.sync.innerHTML='<i class="fa fa-refresh fa-spin md-fa-lg"></i>':$p.wsql.pouch.authorized?t.buttons.sync.innerHTML='<i class="fa fa-refresh md-fa-lg"></i>':t.buttons.sync.innerHTML='<i class="fa fa-ban md-fa-lg"></i>'}),a=e?setTimeout(t,3e3):0}function n(){i.forEach(function(e){$p.wsql.pouch.authorized?(e.buttons.auth.title="Отключиться от сервера",e.buttons.auth.innerHTML='<span class="span_user">'+$p.wsql.pouch.authorized+"</span>",e.buttons.sync.title="Синхронизация выполняется...",e.buttons.sync.innerHTML='<i class="fa fa-refresh md-fa-lg"></i>'):(e.buttons.auth.title="Войти на сервер и включить синхронизацию данных",e.buttons.auth.innerHTML='&nbsp;<i class="fa fa-sign-in md-fa-lg"></i><span class="span_user">Вход...</span>',e.buttons.sync.title="Синхронизация не выполняется - пользователь не авторизован на сервере",e.buttons.sync.innerHTML='<i class="fa fa-ban md-fa-lg"></i>')})}var a,i=[];this.bind=function(t){return t.buttons.auth.onclick=e,t.buttons.sync.onclick=null,i.push(t),setTimeout(n),t},$p.on({pouch_load_data_start:function(e){$p.iface.sync||$p.iface.wnd_sync(),$p.iface.sync.create($p.eve.stepper),$p.eve.stepper.frm_sync.setItemValue("text_bottom","Читаем справочники"),e.hasOwnProperty("local_rows")&&e.local_rows<10?($p.eve.stepper.wnd_sync.setText("Первый запуск - подготовка данных"),$p.eve.stepper.frm_sync.setItemValue("text_processed","Загрузка начального образа")):($p.eve.stepper.wnd_sync.setText("Загрузка данных из IndexedDB"),$p.eve.stepper.frm_sync.setItemValue("text_processed","Извлечение начального образа")),t(!0)},pouch_load_data_page:function(e){if(t(!0),$p.eve.stepper.wnd_sync){var n=e.docs_written||e.page*e.limit;$p.eve.stepper.frm_sync.setItemValue("text_current","Обработано элементов: "+n+" из "+e.total_rows),$p.eve.stepper.frm_sync.setItemValue("text_bottom","Текущий запрос: "+e.page+" ("+(100*n/e.total_rows).toFixed(0)+"%)")}},pouch_change:function(e,n){t(!0)},pouch_load_data_loaded:function(e){$p.eve.stepper.wnd_sync&&(e.docs_written?$p.iface.sync.close():$p.iface.sync.close())},pouch_load_data_error:function(e){t(),$p.eve.stepper.wnd_sync&&$p.iface.sync.close()},log_in:function(e){n()},log_out:function(){n()}})};var eXcell_proto=new eXcell;eXcell_proto.input_keydown=function(e,t){function n(e){t.source.on_select&&t.source.on_select.call(t.source,e)}if(8===e.keyCode||46===e.keyCode)t.setValue(""),t.grid.editStop(),t.source.on_select&&t.source.on_select.call(t.source,"");else if(9===e.keyCode||13===e.keyCode)t.grid.editStop();else if(115===e.keyCode)t.cell.firstChild.childNodes[1].onclick(e);else if(113===e.keyCode)if(t.source.tabular_section){if(t.mgr=_md.value_mgr(t.source.row,t.source.col,t.source.row._metadata.fields[t.source.col].type),t.mgr){var a=t.source.row[t.source.col];t.mgr.form_obj(t.source.wnd,{o:a,on_select:n})}}else if(1==t.fpath.length&&(t.mgr=_md.value_mgr(t.source.o._obj,t.fpath[0],t.source.o._metadata.fields[t.fpath[0]].type),t.mgr)){var a=t.source.o[t.fpath[0]];t.mgr.form_obj(t.source.wnd,{o:a,on_select:n})}return $p.iface.cancel_bubble(e)},eXcell_ocombo.prototype=eXcell_proto,window.eXcell_ocombo=eXcell_ocombo,window.eXcell_ref=eXcell_ocombo,window.eXcell_refc=eXcell_ocombo,eXcell_pwd.prototype=eXcell_proto,window.eXcell_pwd=eXcell_pwd,dhtmlXCalendarObject.prototype._dateToStr=function(e,t){return e instanceof Date&&e.getFullYear()<1e3?"":window.dhx4.date2str(e,t||this._dateFormat,this._dateStrings())},eXcell_dhxCalendar.prototype.edit=function(){var e=this.grid.getPosition(this.cell);this.grid._grid_calendarA._show(!1,!1),this.grid._grid_calendarA.setPosition(e[0],e[1]+this.cell.offsetHeight),this.grid._grid_calendarA._last_operation_calendar=!1,this.grid.callEvent("onCalendarShow",[this.grid._grid_calendarA,this.cell.parentNode.idd,this.cell._cellIndex]),this.cell._cediton=!0,this.val=this.cell.val,this.val instanceof Date&&this.val.getFullYear()<1e3&&(this.val=new Date),this._val=this.cell.innerHTML;var t=this.grid._grid_calendarA.draw;this.grid._grid_calendarA.draw=function(){},this.grid._grid_calendarA.setDateFormat(this.grid._dtmask||"%d.%m.%Y"),this.grid._grid_calendarA.setDate(this.val||new Date),this.grid._grid_calendarA.draw=t},function(){function e(e,t,n,a){if(n.indexOf("odata/standard.odata")!=-1||n.indexOf("/hs/rest")!=-1){var i,r;$p.ajax.authorized?(i=$p.ajax.username,r=$p.aes.Ctr.decrypt($p.ajax.password)):$p.job_prm.guest_name?(i=$p.job_prm.guest_name,r=$p.aes.Ctr.decrypt($p.job_prm.guest_pwd)):(i=$p.wsql.get_user_param("user_name"),r=$p.aes.Ctr.decrypt($p.wsql.get_user_param("user_pwd"))),e.open(t,n,a,i,r),e.withCredentials=!0,e.setRequestHeader("Authorization","Basic "+btoa(unescape(encodeURIComponent(i+":"+r))))}else e.open(t,n,a)}dhx4.ajax._call=function(t,n,a,i,r,o,s){var l=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),c=null!=navigator.userAgent.match(/AppleWebKit/)&&null!=navigator.userAgent.match(/Qt/)&&null!=navigator.userAgent.match(/Safari/);if(1==i&&(l.onreadystatechange=function(){if(4==l.readyState||1==c&&3==l.readyState){if((200!=l.status||""==l.responseText)&&!dhx4.callEvent("onAjaxError",[{xmlDoc:l,filePath:n,async:i}]))return;window.setTimeout(function(){"function"==typeof r&&r.apply(window,[{xmlDoc:l,filePath:n,async:i}]),null!=o&&("undefined"!=typeof o.postData?dhx4.ajax.postLong(o.url,o.postData,r):dhx4.ajax.getLong(o.url,r)),r=null,l=null},1)}}),"GET"==t&&(n+=this._dhxr(n)),l.open(t,n,i),e(l,t,n,i),null!=s)for(var d in s)l.setRequestHeader(d,s[d]);else"POST"==t||"PUT"==t||"DELETE"==t?l.setRequestHeader("Content-Type","application/x-www-form-urlencoded"):"GET"==t&&(a=null);return l.setRequestHeader("X-Requested-With","XMLHttpRequest"),l.send(a),1!=i&&(4==l.readyState||1==c&&3==l.readyState)&&(200==l.status&&""!=l.responseText||dhx4.callEvent("onAjaxError",[{xmlDoc:l,filePath:n,async:i}])),{xmlDoc:l,filePath:n,async:i}},dhtmlx.ajax.prototype.send=function(t,n,a){var i=this.getXHR();if("function"==typeof a&&(a=[a]),"object"==typeof n){var r=[];for(var o in n){var s=n[o];null!==s&&s!==dhtmlx.undefined||(s=""),r.push(o+"="+encodeURIComponent(s))}n=r.join("&")}n&&!this.post&&(t=t+(t.indexOf("?")!=-1?"&":"?")+n,n=null),e(i,this.post?"POST":"GET",t,!this._sync),this.post&&i.setRequestHeader("Content-type","application/x-www-form-urlencoded");var l=this;return i.onreadystatechange=function(){if(!i.readyState||4==i.readyState){if(a&&l)for(var e=0;e<a.length;e++)a[e]&&a[e].call(l.master||l,i.responseText,i.responseXML,i);l.master=null,a=l=null}},i.send(n||null),i}}(),dhtmlXCellObject.prototype.is_visible=function(){var e=this.cell.getBoundingClientRect();return e.right>0&&e.bottom>0},$p.iface.data_to_grid=function(e,t){function n(e){var t;return t=e.is_folder?"cell_ref_folder":"cell_ref_elm",e._deleted&&(t+="_deleted"),t}function a(e){return e instanceof Date?e.getHours()||e.getMinutes()?$p.moment(e).format($p.moment._masks.date_time):$p.moment(e).format($p.moment._masks.date):"number"==typeof e?e:$p.iface.normalize_xml(e||"")}if(this.data_to_grid)return this.data_to_grid(e,t);var i="<?xml version='1.0' encoding='UTF-8'?><rows total_count='%1' pos='%2' set_parent='%3'>".replace("%1",t._total_count||e.length).replace("%2",t.start).replace("%3",t.set_parent||""),r=this.caption_flds(t);return i+=r.head,e.forEach(function(e){i+='<row id="'+e.ref+'"><cell class="'+n(e)+'">'+a(e[r.acols[0].id])+"</cell>";for(var t=1;t<r.acols.length;t++)i+="<cell>"+a(e[r.acols[t].id])+"</cell>";i+="</row>"}),i+"</rows>"},$p.iface.data_to_tree=function(e){function t(e,a){n=n+'<item text="'+e.presentation.replace(/"/g,"'")+'" id="'+e.ref+'" im0="'+dhtmlx.image_cache("tree","folderClosed")+'">',$p._find_rows(a,{parent:e.ref},function(e){t(e,a)}),n+="</item>"}var n="<?xml version='1.0' encoding='UTF-8'?><tree id=\"0\">";return t({presentation:"...",ref:$p.utils.blank.guid},[]),$p._find_rows(e,{parent:$p.utils.blank.guid},function(n){t(n,e)}),n+"</tree>"},$p.iface.ODropdownList=ODropdownList,dhtmlXCellObject.prototype.attachDynTree=function(e,t,n){this.setCollapsedText&&this.setCollapsedText("Дерево"),t||(t={is_folder:!0});var a=this.attachTree();return a.setImagePath(dhtmlx.image_path+"dhxtree"+dhtmlx.skin_suffix()),a.setIconsPath(dhtmlx.image_path+"dhxtree"+dhtmlx.skin_suffix()),"desktop"==$p.job_prm.device_type&&a.enableKeyboardNavigation(!0),a.__define({filter:{get:function(){},set:function(e){t=e},enumerable:!1,configurable:!1}}),setTimeout(function(){e.sync_grid({action:"get_tree",filter:t},a).then(function(e){n&&n(e)})}),a},OCombo._extend(dhtmlXCombo),$p.iface.OCombo=OCombo,$p.iface.select_from_list=function(e,t){return new Promise(function(n,a){function i(e){"cancel"!=e&&(r=c.getSelectedRowId()),l.close()}Array.isArray(e)&&e.length?1==e.length&&n(e[0]):n(void 0);var r,o,s={name:"wnd_select_from_list",wnd:{id:"wnd_select_from_list",width:300,height:300,modal:!0,center:!0,caption:$p.msg.select_from_list,allow_close:!0,on_close:function(){return r&&n(e[parseInt(r)-1]),!0}}},l=$p.iface.dat_blank(null,s.wnd),c=l.attachGrid(),d=l.attachToolbar({items:[{id:"select",type:"button",text:$p.msg.select_from_list},{id:"cancel",type:"button",text:"Отмена"}],onClick:i});c.setIconsPath(dhtmlx.image_path),c.setImagePath(dhtmlx.image_path),c.setHeader($p.msg.value),c.setColTypes("ro"),c.enableAutoWidth(!0,1200,600),c.attachEvent("onRowDblClicked",i),c.enableMultiselect(!!t),c.setNoHeader(!0),c.init(),d.addSpacer("select"),l.hideHeader(),l.cell.offsetParent.querySelector(".dhxwin_brd").style.border="none",e.forEach(function(e,t){var n;n="object"==typeof e?e.presentation||e.text||e.toString():e.toString(),c.addRow(1+t,n),e.selected&&(o=1+t)}),o&&c.selectRowById(o)})},$p.iface.ODateRangePicker=ODateRangePicker,dhtmlXCellObject.prototype.attachHeadFields=function(e){function t(e){if(a)f.entBox&&!f.entBox.parentElement?setTimeout(f.destructor):e.forEach(function(e){"unload"==e.type?u&&u.close?u.close():f.destructor():f.forEachRow(function(t){t==e.name&&f.cells(t,1).setValue(a[e.name])})});else{var i=[];e.forEach(function(e){i.indexOf[e.object]==-1&&(i.push(e.object),Object.unobserve(e.object,t),c&&c instanceof TabularSection&&Object.unobserve(e.object,n))}),i=null}}function n(t){var n;t.forEach(function(t){!n&&f.clearAll&&l==t.tabular&&(n=!0,f.clearAll(),f.parse(o.get_property_grid_xml(i,a,{title:e.ts_title,ts:l,selection:s,metadata:r}),function(){},"xml"))})}var a,i,r,o,s,l,c,d,u=this,f=u.attachGrid(),p=f.destructor;return new dhtmlXPropertyGrid(f),f.setInitWidthsP("40,60"),f.setDateFormat("%d.%m.%Y %H:%i"),f.init(),f.setSizes(),f.attachEvent("onPropertyChanged",function(e,t,n){if(e||f&&f.getSelectedRowId())return d.on_select(t)}),f.attachEvent("onCheckbox",function(e,t,n){if(void 0!=a[e])return d.on_select(n,{obj:a,field:e})}),f.attachEvent("onKeyPress",function(e,t,n){switch(e){case 13:case 9:f.editStop&&f.editStop();break;case 46:}}),e.read_only&&f.setEditable(!1),f.__define({selection:{get:function(){return s},set:function(e){s=e,this.reload}},reload:{value:function(){n([{tabular:l}])}},get_cell_field:{value:function(){if(a){var e={row_id:f.getSelectedRowId()},t=e.row_id.split("|");if(t.length<2)return{obj:a,field:t[0]}._mixin(d);var n;return s?a[t[0]].find_rows(s,function(e){if(e.property==t[1]||e.param==t[1]||e.Свойство==t[1]||e.Параметр==t[1])return n=e,!1}):n=a[t[0]].find(t[1]),n?(e.obj=n,n["Значение"]?(e.field="Значение",e.property=n.Свойство||n.Параметр):(e.field="value",e.property=n.property||n.param),e._mixin(d)):void 0}},enumerable:!1},_obj:{get:function(){return a}},_owner_cell:{get:function(){return u}},destructor:{value:function(){a&&Object.unobserve(a,t),c&&c instanceof TabularSection&&Object.unobserve(c,n),a=null,c=null,r=null,o=null,d=null,p.call(f)}},attach:{value:function(e){a&&Object.unobserve(a,t),c&&c instanceof TabularSection&&Object.unobserve(a,n),e.oxml&&(i=e.oxml),e.selection&&(s=e.selection),a=e.obj,r=e.metadata||a._metadata.fields,o=a._manager,l=e.ts||"",c=l?a[l]:a.extra_fields||a["ДополнительныеРеквизиты"],c&&!l&&(l=a.extra_fields?"extra_fields":"ДополнительныеРеквизиты"),d={on_select:function(e,t){if(t||(t=f.get_cell_field()),t){var n=o.handle_event(a,"value_change",{field:t.field,value:e,tabular_section:t.row_id?l:"",grid:f,cell:f.cells(t.row_id||t.field,1),wnd:d.pwnd});return"boolean"!=typeof n&&(t.obj[t.field]=e,n=!0),n}},pwnd:e.pwnd||u},Object.observe(a,t,["update","unload"]),c&&c instanceof TabularSection&&Object.observe(a,n,["row","rows"]),l&&!e.ts_title&&(e.ts_title=a._metadata.tabular_sections[l].synonym),n([{tabular:l}])}}}),e&&f.attach(e),f},dhtmlXGridObject.prototype.get_cell_value=function(){var e=this.get_cell_field();if(e&&e.obj)return e.obj[e.field]},dhtmlXCellObject.prototype.attachTabular=function(e){function t(e){var t=p.getSelectedRowId();return t&&!isNaN(Number(t))?Number(t)-1:void(e||$p.msg.show_msg({type:"alert-warning",text:$p.msg.no_selected_row.replace("%1",r._metadata.tabular_sections[o].synonym||o),title:(r._metadata.obj_presentation||r._metadata.synonym)+": "+r.presentation}))}function n(e,t,n,a,i){if(2!=e||a==i)return!0;var s=p.get_cell_field(),c=l.handle_event(r,"value_change",{field:s.field,value:a,tabular_section:o,grid:p,row:s.obj,cell:t&&n?p.cells(t,n):p.getSelectedCellIndex()>=0?p.cells():null,wnd:m.pwnd});return"boolean"!=typeof c&&(s.obj[s.field]=a,c=!0),c}function a(e){p.clearAll&&e.some(function(e){if("rows"==e.type&&e.tabular==o)return s.sync_grid(p,f),!0})}function i(e){if(e.length>20)try{s.sync_grid(p,f)}catch(e){}else e.forEach(function(e){o==e.tabular&&(e.row&&p.getSelectedRowId()==e.row.row?void 0!=p.getColIndexById(e.name)&&p.cells(e.row.row,p.getColIndexById(e.name)).setCValue($p.utils.is_data_obj(e.row[e.name])?e.row[e.name].presentation:e.row[e.name]):s.sync_grid(p,f))})}var r=e.obj,o=e.ts,s=r[o],l=r._manager,c=e.metadata||l.metadata().tabular_sections[o].fields,d=this,u={},f=e.selection;if(_md.ts_captions(l.class_name,o,u)){var p=this.attachGrid(),_=this.attachToolbar(),h=p.destructor,m={on_select:function(e){n(2,null,null,e)},pwnd:e.pwnd||d,is_tabular:!0};return p.setDateFormat("%d.%m.%Y %H:%i"),p.enableAccessKeyMap(),p._add_row=function(){if(!e.read_only){var t=s.add();if(l.handle_event(r,"add_row",{tabular_section:o,grid:p,row:t,wnd:m.pwnd})===!1)return;setTimeout(function(){p.selectRowById(t.row)},100)}},p._del_row=function(){if(!e.read_only){var n=t();if(void 0!=n){if(l.handle_event(r,"del_row",{tabular_section:o,grid:p,row:n,wnd:m.pwnd})===!1)return;s.del(n),setTimeout(function(){p.selectRowById(n<s.count()?n+1:n)},100)}}},_.setIconsPath(dhtmlx.image_path+"dhxtoolbar"+dhtmlx.skin_suffix()),_.loadStruct(e.toolbar_struct||$p.injected_data["toolbar_add_del.xml"],function(){this.attachEvent("onclick",function(e){switch(e){case"btn_add":p._add_row();break;case"btn_delete":p._del_row()}})}),p.setIconsPath(dhtmlx.image_path),p.setImagePath(dhtmlx.image_path),p.setHeader(u.headers),u.min_widths&&p.setInitWidths(u.widths),u.min_widths&&p.setColumnMinWidth(u.min_widths),u.aligns&&p.setColAlign(u.aligns),p.setColSorting(u.sortings),p.setColTypes(u.types),p.setColumnIds(u.fields.join(",")),p.enableAutoWidth(!0,1200,600),p.enableEditTabOnly(!0),p.init(),e.read_only&&(p.setEditable(!1),_.forEachItem(function(e){["btn_add","btn_delete"].indexOf(e)!=-1&&_.disableItem(e)})),p.__define({selection:{get:function(){return f},set:function(e){f=e,a([{tabular:o,type:"rows"}])}},destructor:{value:function(){r&&(Object.unobserve(r,i),Object.unobserve(r,a)),r=null,s=null,c=null,l=null,m=null,d.detachToolbar(),h.call(p)}},get_cell_field:{value:function(){if(s){var e,n,a=t(!0),i=p.getSelectedCellIndex();if(void 0!=a?e=s.get(a):p._last&&(e=s.get(p._last.row)),i>=0?n=p.getColumnId(i):p._last&&(n=p.getColumnId(p._last.cindex)),e&&n)return{obj:e,field:n}._mixin(m)}}},refresh_row:{value:function(e){p.selectRowById(e.row),p.forEachCell(e.row,function(t,n){var a=e[p.getColumnId(n)];t.setCValue($p.utils.is_data_obj(a)?a.presentation:a)})}}}),p.attachEvent("onEditCell",n),p.attachEvent("onRowSelect",function(e,t){s&&(p._last={row:e-1,cindex:t})}),a([{tabular:o,type:"rows"}]),Object.observe(r,i,["row"]),Object.observe(r,a,["rows"]),p}},$p.iface.Toolbar_filter=function(e){function t(){i&&clearTimeout(i),i=setTimeout(function(){i&&a.call_event()},500)}function n(e,t){"min"==t?a.сalendar.setSensitiveRange(e.value,null):a.сalendar.setSensitiveRange(null,e.value)}var a=this,i=0,r="desktop"==$p.job_prm.device_type?300:120,o={};e.pos||(e.pos=6),a.__define({custom_selection:{get:function(){return o},enumerable:!1,configurable:!1},toolbar:{get:function(){return e.toolbar},enumerable:!1,configurable:!1},call_event:{value:function(){i&&(clearTimeout(i),i=0),e.onchange.call(a,a.get_filter())}}}),a.toolbar.addText("div_filter",e.pos,""),a.div=a.toolbar.objPull[a.toolbar.idPrefix+"div_filter"],e.pos++,(e.manager instanceof DocManager||e.period)&&(r="desktop"==$p.job_prm.device_type?180:120,a.toolbar.addInput("input_date_from",e.pos,"","desktop"==$p.job_prm.device_type?80:72),e.pos++,a.toolbar.addText("lbl_date_till",e.pos,"-"),e.pos++,a.toolbar.addInput("input_date_till",e.pos,"","desktop"==$p.job_prm.device_type?80:72),e.pos++,a.input_date_from=a.toolbar.getInput("input_date_from"),a.input_date_from.onclick=function(){n(a.input_date_till,"max")},a.input_date_till=a.toolbar.getInput("input_date_till"),a.input_date_till.onclick=function(){n(a.input_date_from,"min")},a.сalendar=new dhtmlXCalendarObject([a.input_date_from,a.input_date_till]),a.сalendar.attachEvent("onclick",a.call_event),
e.date_from||(e.date_from=new Date((new Date).getFullYear().toFixed()+"-01-01")),e.date_till||(e.date_till=$p.utils.date_add_day(new Date,1)),a.input_date_from.value=$p.moment(e.date_from).format("L"),a.input_date_till.value=$p.moment(e.date_till).format("L")),e.hide_filter?a.input_date_till?a.toolbar.addSpacer("input_date_till"):a.toolbar.getItemText("btn_delete")&&a.toolbar.addSpacer("btn_delete"):(a.toolbar.addSeparator("filter_sep",e.pos),e.pos++,a.toolbar.addInput("input_filter",e.pos,"",r),a.input_filter=a.toolbar.getInput("input_filter"),a.input_filter.onchange=a.call_event,a.input_filter.onkeydown=t,a.input_filter.type="search",a.input_filter.setAttribute("placeholder","Фильтр"),a.toolbar.addSpacer("input_filter"))},$p.iface.Toolbar_filter.prototype.__define({get_filter:{value:function(e){var t,n,a={date_from:this.input_date_from?$p.utils.date_add_day(dhx4.str2date(this.input_date_from.value),0,!0):"",date_till:this.input_date_till?$p.utils.date_add_day(dhx4.str2date(this.input_date_till.value),1,!0):"",filter:this.input_filter?this.input_filter.value:""};if(!e)for(t in this.custom_selection)a.selection||(a.selection=[]),n={},n[t]=this.custom_selection[t].value,a.selection.push(n);return a}},add_filter:{value:function(e){var t=this.toolbar.getPosition("input_filter")-2,n=dhx4.newId(),a=(this.toolbar.getWidth("input_filter")/2).round(0);this.toolbar.setWidth("input_filter",a),this.toolbar.addText("lbl_"+n,t,e.text||""),t++,this.toolbar.addInput("input_"+n,t,"",a),this.custom_selection[e.name]=this.toolbar.getInput("input_"+n)}}}),$p.iface.dat_blank=function(e,t){t||(t={});var n,a=(e||$p.iface.w).createWindow({id:dhx4.newId(),left:t.left||700,top:t.top||20,width:t.width||220,height:t.height||300,move:!0,park:!t.allow_close,center:!!t.center,resize:!0,caption:t.caption||"Tools"}),i={x:(e||$p.iface.w).vp.clientWidth,y:(e||$p.iface.w).vp.clientHeight};return a.getPosition()[0]+a.getDimension()[0]>i.x?(i.x=i.x-a.getDimension()[0],n=!0):i.x=a.getPosition()[0],a.getPosition()[1]+a.getDimension()[1]>i.y?(i.y=i.y-a.getDimension()[1],n=!0):i.y=a.getPosition()[1],n&&(i.x<0||i.y<0?a.maximize():a.setPosition(i.x,i.y)),e=null,t.hasOwnProperty("allow_minmax")&&!t.allow_minmax&&a.button("minmax").hide(),t.allow_close?a.button("park").hide():a.button("close").hide(),a.attachEvent("onClose",function(){var e="function"!=typeof t.on_close||t.on_close(a);if(e)return t.pwnd_modal&&t.pwnd&&t.pwnd.setModal&&t.pwnd.setModal(1),e}),a.setIconCss("without_icon"),a.cell.parentNode.children[1].classList.add("dat_gui"),$p.iface.bind_help(a,t.help_path),a.elmnts={grids:{}},a.wnd_options=function(e){var t=a.getPosition(),n=a.getDimension(),i=a.isParked();e.left=t[0],e.top=t[1],e.width=n[0],e.parked=i,i||(e.height=n[1])},a.bottom_toolbar=function(e){var t={wrapper:a.cell,width:"100%",height:"28px",bottom:"0px",left:"0px",name:"tb_bottom",buttons:[{name:"btn_cancel",text:"Отмена",title:"Закрыть без сохранения",width:"60px",float:"right"},{name:"btn_ok",b:"Ок",title:"Применить изменения",width:"30px",float:"right"}],onclick:function(e){return!1}}._mixin(e),n=new OTooolBar(t),i=a.attachStatusBar({height:12});return i.style.zIndex=-1e3,i.firstChild.style.backgroundColor="transparent",i.firstChild.style.border="none",n},t.modal&&(t.pwnd&&t.pwnd.setModal&&(t.pwnd_modal=t.pwnd.isModal(),t.pwnd.setModal(0)),a.setModal(1)),a},$p.iface.pgrid_on_select=function(e){if(void 0!==e){var t=this.grid instanceof dhtmlXGridObject?this.grid:this,n=t.getUserData("","source"),a=t.getSelectedRowId();if(void 0!=n.o[a])"number"==typeof n.o[a]?n.o[a]=$p.utils.fix_number(e,!0):n.o[a]=e;else if(a.indexOf("fprms")>-1){var i=$p._find(n.o.fprms,a.split("|")[1]);i.value=e}t.cells().setValue($p.utils.is_data_obj(e)?e.presentation:e||""),n.grid_on_change&&n.grid_on_change.call(t,a,e)}},$p.iface.pgrid_on_change=function(e,t,n){e&&$p.iface.pgrid_on_select.call(this,t)},$p.iface.pgrid_on_checkbox=function(e,t,n){var a=this.grid instanceof dhtmlXGridObject?this.grid:this,i=a.getUserData("","source");void 0!=i.o[e]&&(i.o[e]=n),i.grid_on_change&&i.grid_on_change(e,n)},$p.iface.layout_2u=function(e){var t=$p.iface;return t.main=new dhtmlXLayoutObject({parent:document.body,pattern:"2U"}),t.main.attachEvent("onCollapse",function(e){if("b"==e)return t.docs.expand(),!1}),t.docs=t.main.cells("b"),_clear_all(),t.cell_tree=t.main.cells("a"),t.cell_tree.setText("Режим"),t.cell_tree.setWidth("190"),t.cell_tree.fixSize(!1,!1),t.cell_tree.collapse(),t.tree=t.cell_tree.attachTree(),t.tree.setImagePath(dhtmlx.image_path+"dhxtree"+dhtmlx.skin_suffix()),t.tree.setIconsPath(dhtmlx.image_path+"dhxtree"+dhtmlx.skin_suffix()),e?(t.tree.attachEvent("onSelect",e.onselect),new Promise(function(n,a){t.tree.loadXML(e.path,function(){this.tree_filteres=e.path,n(this)})})):(t.tree.attachEvent("onSelect",function(e){var n=e.split(".");if(n.length>1&&"oper"==t.swith_view(n[0])){var a=$p.md.mgr_by_class_name(e.substr(5));"function"==typeof t.docs.close&&t.docs.close(),a&&a.form_list(t.docs,{})}}),Promise.resolve(t.tree))},$p.iface.layout_1c=function(){var e=$p.iface;return new Promise(function(t,n){try{e.main=new dhtmlXLayoutObject({parent:document.body,pattern:"1C",offsets:{top:4,right:4,bottom:4,left:4}}),e.docs=e.main.cells("a"),_clear_all(),t(!0)}catch(e){n(e)}})},$p.iface.frm_auth=function(e,t,n){function a(n,a){$p.ajax.username=n,$p.ajax.password=$p.aes.Ctr.encrypt(a),n?($p.wsql.get_user_param("user_name")!=n&&$p.wsql.set_user_param("user_name",n),$p.wsql.pouch.log_in(n,a).then(function(){$p.wsql.get_user_param("enable_save_pwd")?$p.aes.Ctr.decrypt($p.wsql.get_user_param("user_pwd"))!=a&&$p.wsql.set_user_param("user_pwd",$p.aes.Ctr.encrypt(a)):""!=$p.wsql.get_user_param("user_pwd")&&$p.wsql.set_user_param("user_pwd",""),$p.eve.logged_in=!0,e.modal_dialog?r.close():t&&t()}).catch(function(e){l=!0,o.onerror(e)}).then(function(){$p.iface.sync&&$p.iface.sync.close(),r&&r.progressOff&&(r.progressOff(),!l&&e.hide_header&&r.hideHeader()),$p.iface.cell_tree&&!l&&$p.iface.cell_tree.expand()})):this.validate()}function i(e){if(l=!1,this.resetValidateCss(),"guest"==this.getCheckedValue("type")){var t=this.getItemValue("guest"),n="";$p.job_prm.guests&&$p.job_prm.guests.length&&$p.job_prm.guests.some(function(e){if(e.username==t)return n=$p.aes.Ctr.decrypt(e.password),!0}),a.call(this,t,n)}else"auth"==this.getCheckedValue("type")&&a.call(this,this.getItemValue("login"),this.getItemValue("password"))}e||(e={});var r,o,s,l;e.modal_dialog?(e.options||(e.options={name:"frm_auth",caption:"Вход на сервер",width:360,height:300,center:!0,allow_close:!0,allow_minmax:!0,modal:!0}),r=$p.iface.dat_blank(e._dxw,e.options),r.attachEvent("onClose",function(e){return l?n&&n(err):t&&t(),!0}),o=r.attachForm()):(r=e.cell||$p.iface.docs,o=$p.iface.auth=r.attachForm(),$p.msg.show_msg($p.msg.init_login,r)),o.loadStruct($p.injected_data["form_auth.xml"],function(){var t;if($p.job_prm.guests&&$p.job_prm.guests.length){var n=$p.job_prm.guests.map(function(e){var n={text:e.username,value:e.username};return $p.wsql.get_user_param("user_name")==e.username&&(n.selected=!0,t=e.username),n});t||(n[0].selected=!0,t=n[0].value),o.reloadOptions("guest",n)}$p.wsql.get_user_param("user_name")&&$p.wsql.get_user_param("user_name")!=t&&(o.setItemValue("login",$p.wsql.get_user_param("user_name")),o.setItemValue("type","auth"),$p.wsql.get_user_param("enable_save_pwd")&&$p.wsql.get_user_param("user_pwd")&&o.setItemValue("password",$p.aes.Ctr.decrypt($p.wsql.get_user_param("user_pwd")))),e.modal_dialog||((s=((r.getWidth?r.getWidth():r.cell.offsetWidth)-500)/2)>=10?o.cont.style.paddingLeft=s.toFixed()+"px":o.cont.style.paddingLeft="20px"),setTimeout(function(){dhx4.callEvent("on_draw_auth",[o]),($p.wsql.get_user_param("autologin")||e.try_auto)&&(t||$p.wsql.get_user_param("user_name")&&$p.wsql.get_user_param("user_pwd"))&&i.call(o)})}),o.attachEvent("onButtonClick",i),o.attachEvent("onKeyDown",function(e,t,n,a){13==t.keyCode&&("password"!=n&&"guest"!=this.getCheckedValue("type")||i.call(this))}),o.onerror=function(e){$p.ajax.authorized=!1;var t=e.message.toLowerCase();t.indexOf("auth")!=-1?($p.msg.show_msg({title:$p.msg.main_title+$p.version,type:"alert-error",text:$p.msg.error_auth}),o.setItemValue("password",""),o.validate()):t.indexOf("gateway")==-1&&t.indexOf("net")==-1||$p.msg.show_msg({title:$p.msg.main_title+$p.version,type:"alert-error",text:$p.msg.error_network})}},$p.iface.open_settings=function(e){var t=e||("undefined"!=typeof event?event:void 0);t&&t.preventDefault();var n=$p.job_prm.parse_url();return $p.iface.set_hash(n.obj,n.ref,n.frm,"settings"),$p.iface.cancel_bubble(t)},$p.iface.swith_view=function(e){var t,n=$p.iface,a=function(e){function t(e,t){return e.text>t.text?1:e.text<t.text?-1:void 0}if(n.tree){if(n.tree._view!=e&&["rep","cal"].indexOf(e)==-1){if(n.tree.deleteChildItems(0),"oper"==e){var a,i,r={id:0,item:[{id:"oper_cat",text:$p.msg.meta_cat,open:!0,item:[]},{id:"oper_doc",text:$p.msg.meta_doc,item:[]},{id:"oper_cch",text:$p.msg.meta_cch,item:[]},{id:"oper_cacc",text:$p.msg.meta_cacc,item:[]},{id:"oper_tsk",text:$p.msg.meta_tsk,item:[]}]},o=r.item[0].item;for(a in $p.cat)"function"!=typeof $p.cat[a]&&(i=$p.cat[a].metadata(),i.hide||o.push({id:"oper.cat."+a,text:i.synonym||i.name,tooltip:i.illustration||i.list_presentation}));o.sort(t),o=r.item[1].item;for(a in $p.doc)"function"!=typeof $p.doc[a]&&(i=$p.doc[a].metadata(),i.hide||o.push({id:"oper.doc."+a,text:i.synonym||i.name,tooltip:i.illustration||i.list_presentation}));o.sort(t),o=r.item[2].item;for(a in $p.cch)"function"!=typeof $p.cch[a]&&(i=$p.cch[a].metadata(),i.hide||o.push({id:"oper.cch."+a,text:i.synonym||i.name,tooltip:i.illustration||i.list_presentation}));o.sort(t),o=r.item[3].item;for(a in $p.cacc)"function"!=typeof $p.cacc[a]&&(i=$p.cacc[a].metadata(),i.hide||o.push({id:"oper.cacc."+a,text:i.synonym||i.name,tooltip:i.illustration||i.list_presentation}));o.sort(t),o=r.item[4].item;for(a in $p.tsk)"function"!=typeof $p.tsk[a]&&(i=$p.tsk[a].metadata(),i.hide||o.push({id:"oper.tsk."+a,text:i.synonym||i.name,tooltip:i.illustration||i.list_presentation}));o.sort(t),n.tree.parse(r,function(){var e=$p.job_prm.parse_url();e.obj&&n.tree.selectItem(e.view+"."+e.obj,!0)},"json")}else n.tree.loadXML(n.tree.tree_filteres,function(){});n.tree._view=e}}else{var s=$p.job_prm.parse_url();if(s.obj){var l=s.obj.split(".");if(l.length>1){var c=$p.md.mgr_by_class_name(s.obj);"function"==typeof n.docs.close&&n.docs.close(),c&&c.form_list(n.docs,{})}}}};return 0==e.indexOf(n.docs.getViewName())?n.docs.getViewName():(t=n.docs.showView(e),1==t&&("cal"!=e||window.dhtmlXScheduler||($p.load_script("dist/dhtmlxscheduler.min.js","script",function(){scheduler.config.first_hour=8,scheduler.config.last_hour=22,n.docs.scheduler=n.docs.attachScheduler(new Date("2015-11-20"),"week","scheduler_here"),n.docs.scheduler.attachEvent("onBeforeViewChange",function(e,t,n,a){return"timeline"!=n||($p.msg.show_not_implemented(),!1)})}),$p.load_script("dist/dhtmlxscheduler.css","link"))),a(e),void("def"==e?n.main.showStatusBar():n.main.hideStatusBar()))},$p.iface.OTooolBar=OTooolBar,$p.iface.add_button=function(e,t,n){var a=document.createElement("div"),i="";return a.name=(t?t.name+"_":"")+n.name,e.appendChild(a),a.className=0==n.name.indexOf("sep_")?"md_otooolbar_sep":"md_otooolbar_button",n.hasOwnProperty("class_name")&&a.classList.add(n.class_name),n.img&&(i='<img src="'+(t?t.image_path:"")+n.img+'">'),n.b?i+='<b style="vertical-align: super;"> '+n.b+"</b>":n.text?i+='<span style="vertical-align: super;"> '+n.text+"</span>":n.css&&a.classList.add(n.css),a.innerHTML=i,n.float&&(a.style.float=n.float),n.clear&&(a.style.clear=n.clear),n.width&&(a.style.width=n.width),n.paddingRight&&(a.style.paddingRight=n.paddingRight),n.paddingLeft&&(a.style.paddingLeft=n.paddingLeft),n.tooltip&&(a.title=n.tooltip),a},"undefined"!=typeof window&&"dhtmlx"in window&&(eXcell_addr.prototype=eXcell_proto,window.eXcell_addr=eXcell_addr),DataManager.prototype.form_obj=function(e,t){function n(){h||((e instanceof dhtmlXLayoutCell||e instanceof dhtmlXSideBarCell||e instanceof dhtmlXCarouselCell)&&(t.bind_pwnd||t.Приклеить)?("function"==typeof e.close&&e.close(!0),p=e,p.close=function(t){var n=p||e;(t||u())&&(n&&(n.elmnts&&["vault","vault_pop"].forEach(function(e){n.elmnts[e]&&n.elmnts[e].unload&&n.elmnts[e].unload()}),y&&y.class_name&&$p.eve.callEvent("frm_close",[y.class_name,w&&w._obj?w.ref:""]),n.conf&&(n.detachToolbar(),n.detachStatusBar(),n.conf.unloading=!0,n.detachObject(!0))),d(t))},p.elmnts={grids:{}}):(_={name:"wnd_obj_"+y.class_name,wnd:{top:80+40*Math.random(),left:120+80*Math.random(),width:700,height:400,modal:!0,center:!1,pwnd:e,allow_close:!0,allow_minmax:!0,on_close:f,caption:v.obj_presentation||v.synonym}},p=$p.iface.dat_blank(null,_.wnd)),p.ref||p.__define({ref:{get:function(){return w?w.ref:$p.utils.blank.guid},enumerable:!1,configurable:!0},set_text:{value:function(e){if(t&&t.set_text||p&&p.setText){var n=w.presentation;if(!n)return;w instanceof CatObj&&(n=(v.obj_presentation||v.synonym)+": "+n),w._modified&&n.lastIndexOf("*")!=n.length-1?n+=" *":w._modified||n.lastIndexOf("*")!=n.length-1||(n=n.replace(" *","")),(e||g!==n)&&(g=n,t.set_text?t.set_text(n):p.setText(n))}},enumerable:!1,configurable:!0}}),p.elmnts.frm_tabs=p.attachTabbar({arrows_mode:"auto",offsets:{top:0,right:0,bottom:0,left:0}}),p.elmnts.frm_tabs.addTab("tab_header","&nbsp;Реквизиты&nbsp;",null,null,!0),p.elmnts.tabs={tab_header:p.elmnts.frm_tabs.cells("tab_header")},p.elmnts.frm_toolbar=p.attachToolbar(),p.elmnts.frm_toolbar.setIconsPath(dhtmlx.image_path+"dhxtoolbar"+dhtmlx.skin_suffix()),p.elmnts.frm_toolbar.loadStruct(t.toolbar_struct||$p.injected_data["toolbar_obj.xml"],function(){if(p===e&&(this.cont.style.top="4px"),this.addSpacer("btn_unpost"),this.attachEvent("onclick",t.toolbar_click||r),$p.current_acl&&$p.current_acl._acl){var n=y.class_name.split("."),a=$p.current_acl._acl[n[0]][n[1]]||"e";y instanceof DocManager&&a.indexOf("p")!=-1?this.enableItem("btn_post"):this.hideItem("btn_post"),y instanceof DocManager&&a.indexOf("o")!=-1?this.enableItem("btn_unpost"):this.hideItem("btn_unpost"),a.indexOf("e")==-1&&(this.hideItem("btn_save_close"),this.disableItem("btn_save"))}t.on_select&&this.setItemText("btn_save_close","Записать и выбрать"),y instanceof CatManager||y instanceof DocManager?(y.printing_plates().then(function(e){for(var t in e)p.elmnts.frm_toolbar.addListOption("bs_print",t,"~","button",e[t].toString())}),p.elmnts.vault_pop=new dhtmlXPopup({toolbar:this,id:"btn_files"}),p.elmnts.vault_pop.attachEvent("onShow",s)):this.disableItem("bs_print"),p!=e&&this.hideItem("btn_close")}),h=!0)}function a(e){w&&p&&p.set_text()}function i(){if(h||(clearTimeout(m),n()),p.set_text(),!t.hide_header&&p.showHeader&&p.showHeader(),t.draw_tabular_sections)t.draw_tabular_sections(w,p,l);else if(!w.is_folder)if(v.form&&v.form.obj&&v.form.obj.tabular_sections_order)v.form.obj.tabular_sections_order.forEach(function(e){l(e)});else for(var e in v.tabular_sections)"extra_fields"!==e&&w[e]instanceof TabularSection&&l(e);if(t.draw_pg_header)t.draw_pg_header(w,p);else{var i,r=y.class_name.split(".");i=$p.current_acl&&$p.current_acl._acl?$p.current_acl._acl[r[0]][r[1]]||"e":"e",p.elmnts.pg_header=p.elmnts.tabs.tab_header.attachHeadFields({obj:w,pwnd:p,read_only:i.indexOf("e")==-1}),p.attachEvent("onResizeFinish",function(e){p.elmnts.pg_header.enableAutoHeight(!1,p.elmnts.tabs.tab_header._getHeight()-20,!0)})}return Object.observe(w,a,["update","row"]),{wnd:p,o:w}}function r(e){"btn_save_close"==e?c("close"):"btn_save"==e?c("save"):"btn_post"==e?c("post"):"btn_unpost"==e?c("unpost"):"btn_close"==e?p.close():"btn_go_connection"==e?o():"prn_"==e.substr(0,4)?y.print(w,e,p):"btn_import"==e?y.import(null,w):"btn_export"==e&&y.export({items:[w],pwnd:p,obj:!0})}function o(){$p.msg.show_not_implemented()}function s(){if(!p.elmnts.vault){var e={};$p.ajax.default_attr(e,$p.job_prm.irest_url()),e.url+=y.rest_name+"(guid'"+w.ref+"')/Files?$format=json",p.elmnts.vault=p.elmnts.vault_pop.attachVault(400,250,{uploadUrl:e.url,buttonClear:!1,autoStart:!0,filesLimit:10}),p.elmnts.vault.conf.wnd=p,p.elmnts.vault.attachEvent("onUploadFile",function(e,t){}),p.elmnts.vault.attachEvent("onBeforeFileAdd",function(e){return e.size<=this.getMaxFileSize()||($p.msg.show_msg({type:"alert-warning",text:$p.msg.file_size+this._readableSize(this.getMaxFileSize()),title:$p.msg.main_title}),!1)}),p.elmnts.vault.attachEvent("onBeforeFileRemove",function(e){return!!p.elmnts.vault.file_data[e.id].delete_confirmed||(dhtmlx.confirm({title:$p.msg.main_title,text:$p.msg.file_confirm_delete+e.name,cancel:"Отмена",callback:function(t){t&&$p.ajax.post_ex(p.elmnts.vault.actionUrl(e.id,"drop"),"",!0).then(function(t){p.elmnts.vault.file_data[e.id].delete_confirmed=!0,p.elmnts.vault._removeFileFromQueue(e.id)})}}),!1)})}}function l(e,t){if(_md.ts_captions(y.class_name,e)){p.elmnts.frm_tabs.addTab("tab_"+e,"&nbsp;"+v.tabular_sections[e].synonym+"&nbsp;"),p.elmnts.tabs["tab_"+e]=p.elmnts.frm_tabs.cells("tab_"+e);var n,a=y.class_name.split(".");if(n=$p.current_acl&&$p.current_acl._acl?$p.current_acl._acl[a[0]][a[1]]||"e":"e",p.elmnts.grids[e]=p.elmnts.tabs["tab_"+e].attachTabular({obj:w,ts:e,pwnd:p,read_only:n.indexOf("e")==-1,toolbar_struct:t}),n.indexOf("e")==-1){var i=p.elmnts.tabs["tab_"+e].getAttachedToolbar();i.disableItem("btn_add"),i.disableItem("btn_delete")}}}function c(e){p.progressOn();var n;w instanceof DocObj&&("post"==e?n=!0:"unpost"==e&&(n=!1)),w.save(n).then(function(){p.progressOff(),"close"==e?(t.on_select&&t.on_select(w),p.close()):p.set_text()}).catch(function(e){p.progressOff(),e instanceof Error&&$p.record_log(e)})}function d(n){t&&t.on_close&&!n&&t.on_close(),n||(delete p.ref,delete p.set_text,Object.unobserve(w,a),y=p=w=v=_=e=t=null)}function u(){return!(w._modified&&!b)||(dhtmlx.confirm({title:w.presentation,text:$p.msg.modified_close,cancel:$p.msg.cancel,callback:function(e){e&&(b=!0,"ram"==w._manager.cachable?this.close():w.is_new()?(w.unload(),this.close()):(setTimeout(w.load.bind(w),100),this.close()))}.bind(p)}),!1)}function f(e){if(u())return setTimeout(d),e&&e.elmnts&&["vault","vault_pop"].forEach(function(t){e.elmnts[t]&&e.elmnts[t].unload&&e.elmnts[t].unload()}),y&&y.class_name&&$p.eve.callEvent("frm_close",[y.class_name,w&&w._obj?w.ref:""]),!0}var p,_,h,m,g,b,y=this,v=y.metadata(),w=t.o;return m=setTimeout(n),$p.utils.is_data_obj(w)?w.is_new()&&t.on_select?y.create({},!0).then(function(e){return w=e,e=null,i()}):w.is_new()&&!w.empty()?w.load().then(i):Promise.resolve(i()):(e&&e.progressOn&&e.progressOn(),y.get(t.hasOwnProperty("ref")?t.ref:t,!0,!0).then(function(t){return w=t,t=null,e&&e.progressOff&&e.progressOff(),i()}).catch(function(t){e&&e.progressOff&&e.progressOff(),p.close(),$p.record_log(t)}))},DataObj.prototype.form_obj=function(e,t){return t||(t={}),t.o=this,this._manager.form_obj(e,t)},DataProcessorsManager.prototype.form_rep=function(e,t){function n(){if((e instanceof dhtmlXLayoutCell||e instanceof dhtmlXSideBarCell||e instanceof dhtmlXCarouselCell)&&(t.bind_pwnd||t.Приклеить)){if(o==e&&o._mgr==c)return;"function"==typeof e.close&&e.close(!0),o=e,o.close=function(t){var n=o||e;(t||check_modified())&&(n&&n.conf&&(n.detachToolbar(),n.detachStatusBar(),n.conf.unloading=!0,n.detachObject(!0)),r(t))},o.elmnts={grids:{}}}else s={name:"wnd_rep_"+c.class_name,wnd:{top:80+40*Math.random(),left:120+80*Math.random(),width:700,height:400,modal:!0,center:!1,pwnd:e,allow_close:!0,allow_minmax:!0,on_close:frm_close,caption:d.obj_presentation||d.synonym}},o=$p.iface.dat_blank(null,s.wnd);o._mgr=c,o.report=c.create(),o.set_text||o.__define({set_text:{value:function(e){if(t&&t.set_text||o&&o.setText){var n=d.obj_presentation||d.synonym;(e||l!==n)&&(l=n,t.set_text?t.set_text(n):o.setText(n))}},configurable:!0}}),o.elmnts.layout=o.attachLayout({pattern:"2U",cells:[{id:"a",text:"Отчет",header:!1},{id:"b",text:"Параметры",collapsed_text:"Параметры",width:220}],offsets:{top:0,right:0,bottom:0,left:0}}),o.elmnts.frm_toolbar=o.attachToolbar(),o.elmnts.frm_toolbar.setIconsPath(dhtmlx.image_path+"dhxtoolbar"+dhtmlx.skin_suffix()),o.elmnts.frm_toolbar.loadStruct(t.toolbar_struct||$p.injected_data["toolbar_rep.xml"],function(){o===e&&(this.cont.style.top="4px"),this.addSpacer("btn_run"),this.attachEvent("onclick",t.toolbar_click||a)}),o.set_text(),!t.hide_header&&o.showHeader&&o.showHeader(),o.elmnts.table=new $p.HandsontableDocument(o.elmnts.layout.cells("a"),{allow_offline:o.report.allow_offline,autorun:!1}).then(function(e){if(!e._online)return o.elmnts.table=null}),o.elmnts.frm_prm=document.createElement("DIV"),o.elmnts.frm_prm.style="height: 100%; min-height: 300px; width: 100%",o.elmnts.layout.cells("b").attachObject(o.elmnts.frm_prm),o.report.daterange=new $p.iface.ODateRangePicker(o.elmnts.frm_prm,t)}function a(e){"btn_close"==e?o.close():"btn_run"==e&&o.report.build().then(i).catch(i)}function i(e){e instanceof Error||o.elmnts.table.requery(e)}function r(n){t&&t.on_close&&!n&&t.on_close(),n||(delete o.set_text,o.elmnts.table&&o.elmnts.table.hot.destroy(),o.report.daterange&&o.report.daterange.remove(),o.report=null,c=o=d=s=e=t=null)}var o,s,l,c=this,d=c.metadata();return t||(t={}),t.date_from||(t.date_from=new Date((new Date).getFullYear().toFixed()+"-01-01")),t.date_till||(t.date_till=new Date((new Date).getFullYear().toFixed()+"-12-31")),n(),o},DataManager.prototype.form_selection=function(e,t){function n(){e instanceof dhtmlXCellObject?(e instanceof dhtmlXTabBarCell||"function"!=typeof e.close||e.close(!0),_=e,_.close=function(t){(_||e)&&((_||e).detachToolbar(),(_||e).detachStatusBar(),(_||e).conf&&((_||e).conf.unloading=!0),(_||e).detachObject(!0)),d(t)},t.hide_header||setTimeout(function(){_.showHeader()})):(_=$p.iface.w.createWindow(null,0,0,700,500),_.centerOnScreen(),_.setModal(1),_.button("park").hide(),_.button("minmax").show(),_.button("minmax").enable(),_.attachEvent("onClose",u)),$p.iface.bind_help(_),_.setText&&!t.hide_text&&_.setText("Список "+(h.class_name.indexOf("doc.")==-1?'справочника "':'документов "')+(m.list_presentation||m.synonym)+'"'),document.body.addEventListener("keydown",a,!1),_.elmnts={status_bar:_.attachStatusBar()},_.elmnts.status_bar.setText("<div id='"+h.class_name.replace(".","_")+"_select_recinfoArea'></div>"),_.elmnts.toolbar=_.attachToolbar(),_.elmnts.toolbar.setIconsPath(dhtmlx.image_path+"dhxtoolbar"+dhtmlx.skin_suffix()),_.elmnts.toolbar.loadStruct(t.toolbar_struct||$p.injected_data["toolbar_selection.xml"],function(){this.attachEvent("onclick",o),_===e&&(this.cont.parentElement.classList.add("dhx_cell_toolbar_no_borders"),this.cont.parentElement.classList.remove("dhx_cell_toolbar_def"),this.cont.style.top="4px");var n={manager:h,toolbar:this,onchange:i,hide_filter:t.hide_filter};if(t.date_from&&(n.date_from=t.date_from),t.date_till&&(n.date_till=t.date_till),t.period&&(n.period=t.period),_.elmnts.filter=new $p.iface.Toolbar_filter(n),$p.current_acl&&$p.current_acl._acl){var a=h.class_name.split("."),s=$p.current_acl._acl[a[0]][a[1]]||"e";s.indexOf("i")==-1&&this.hideItem("btn_new"),s.indexOf("v")==-1&&this.hideItem("btn_edit"),s.indexOf("d")==-1&&this.hideItem("btn_delete")}w||(this.hideItem("btn_select"),this.hideItem("sep1"),$p.iface.docs&&$p.iface.docs.getViewName&&"oper"==$p.iface.docs.getViewName()&&this.addListOption("bs_more","btn_order_list","~","button","<i class='fa fa-briefcase fa-lg fa-fw'></i> Список заказов")),this.addListOption("bs_more","btn_import","~","button","<i class='fa fa-upload fa-lg fa-fw'></i> Загрузить из файла"),this.addListOption("bs_more","btn_export","~","button","<i class='fa fa-download fa-lg fa-fw'></i> Выгрузить в файл"),h.printing_plates?h.printing_plates().then(function(e){var t;for(var n in e)_.elmnts.toolbar.addListOption("bs_print",n,"~","button",e[n].toString()),t=!0;t||_.elmnts.toolbar.hideItem("bs_print")}):_.elmnts.toolbar.hideItem("bs_print"),r()}),_._mgr=h}function a(e){function t(){var e;return $p.iface.w.forEachWindow(function(t){t==_||!t.isModal()&&$p.iface.w.getTopmostWindow()!=t||(e=!0)}),e}if(_&&_.is_visible&&_.is_visible())if(e.ctrlKey&&70==e.keyCode){if(!t())return setTimeout(function(){_.elmnts.filter.input_filter&&"desktop"==$p.job_prm.device_type&&_.elmnts.filter.input_filter.focus()}),$p.iface.cancel_bubble(e)}else if(e.shiftKey&&116==e.keyCode){if(!t())return setTimeout(function(){_.elmnts.grid.reload()}),e.preventDefault&&e.preventDefault(),$p.iface.cancel_bubble(e)}else 27==e.keyCode&&(t()||setTimeout(function(){_.close()}))}function i(e){_&&_.elmnts&&(g&&(e.filter?_.elmnts.cell_tree.collapse():_.elmnts.cell_tree.expand()),_.elmnts.grid.reload())}function r(){var e,n,a,i,r,o;g?(e=_.attachLayout("2U"),a=e.cells("b"),a.hideHeader(),n=_.elmnts.cell_tree=e.cells("a"),n.setWidth("220"),n.hideHeader(),i=_.elmnts.tree=n.attachDynTree(h,null,function(){setTimeout(function(){r&&r.reload&&r.reload()},20)}),i.attachEvent("onSelect",function(){this.do_not_reload?delete this.do_not_reload:setTimeout(function(){r&&r.reload&&r.reload()},20)}),i.attachEvent("onDblClick",function(e){s(e)})):(a=_,setTimeout(function(){r&&r.reload&&r.reload()},20)),r=_.elmnts.grid=a.attachGrid(),r.setIconsPath(dhtmlx.image_path),r.setImagePath(dhtmlx.image_path),r.setPagingWTMode(!0,!0,!0,[20,30,60]),r.enablePaging(!0,30,8,h.class_name.replace(".","_")+"_select_recinfoArea"),r.setPagingSkin("toolbar",dhtmlx.skin),r.attachEvent("onBeforeSorting",p),r.attachEvent("onBeforePageChanged",function(){return!!this.getRowsNum()}),r.attachEvent("onXLE",function(){a.progressOff()}),r.attachEvent("onXLS",function(){a.progressOn()}),r.attachEvent("onDynXLS",function(e,t){var n=f(e,t);if(n)return h.sync_grid(n,r),!1}),r.attachEvent("onRowDblClicked",function(e,t){var n=null;i&&(n=i.getIndexById(e)),null!=n?i.selectItem(e,!0):s(e)}),$p.iface.docs&&$p.iface.docs.getViewName&&"oper"==$p.iface.docs.getViewName()&&r.enableMultiselect(!0),r.reload=function(){var e=f();return e?(a.progressOn(),r.clearAll(),h.sync_grid(e,r).then(function(n){if("object"==typeof n)$p.msg.check_soap_result(n);else if(!o){if(e.initial_value){var s=n.indexOf("set_parent"),l=n.indexOf("'>",s),c=n.substr(s+12,l-s-12);$p.utils.is_guid(c)&&g&&(i.do_not_reload=!0,i.selectItem(c,!1)),r.selectRowById(e.initial_value)}else e.parent&&$p.utils.is_guid(e.parent)&&g&&(i.do_not_reload=!0,i.selectItem(e.parent,!1));r.setColumnMinWidth(200,r.getColIndexById("presentation")),r.enableAutoWidth(!0,1200,600),r.setSizes(),o=!0,_.elmnts.filter.input_filter&&"desktop"==$p.job_prm.device_type&&_.elmnts.filter.input_filter.focus(),t.on_grid_inited&&t.on_grid_inited()}y&&o&&r.setSortImgState(!0,b,y),a.progressOff()})):Promise.resolve()}}function o(e){if("btn_select"==e)s();else if("btn_new"==e)h.create({},!0).then(function(e){t.on_new?t.on_new(e,_):$p.job_prm.keep_hash?e.form_obj(_):(e._set_loaded(e.ref),$p.iface.set_hash(h.class_name,e.ref))});else if("btn_edit"==e){var n=_.elmnts.grid.getSelectedRowId();n?t.on_edit?t.on_edit(h,n,_):$p.job_prm.keep_hash?h.form_obj(_,{ref:n}):$p.iface.set_hash(h.class_name,n):$p.msg.show_msg({type:"alert-warning",text:$p.msg.no_selected_row.replace("%1",""),title:$p.msg.main_title})}else"prn_"==e.substr(0,4)?l(e):"btn_order_list"==e?$p.iface.set_hash("","","","def"):"btn_delete"==e?c():"btn_import"==e?h.import():"btn_export"==e?h.export(_.elmnts.grid.getSelectedRowId()):"btn_requery"==e&&(v={},_.elmnts.grid.reload())}function s(n){n||(n=_.elmnts.grid.getSelectedRowId());var a;if(t.selection&&t.selection.forEach(function(e){for(var t in e)"is_folder"==t&&(a=e[t])}),_.elmnts.tree&&null!=_.elmnts.tree.getIndexById(n)&&_.elmnts.tree.getSelectedItemId()!=n)return void _.elmnts.tree.selectItem(n,!0);if(n&&a===!0&&_.elmnts.grid.cells(n,0).cell.classList.contains("cell_ref_elm"))return void $p.msg.show_msg($p.msg.select_grp);if(!n&&_.elmnts.tree||_.elmnts.tree&&_.elmnts.tree.getSelectedItemId()==n){if(a===!1)return void $p.msg.show_msg($p.msg.select_elm);n=_.elmnts.tree.getSelectedItemId()}n&&(t.on_edit?t.on_edit(h,n,_):w?h.get(n,!0).then(function(t){_.close(),w.call(e.grid||e,t)}):$p.job_prm.keep_hash?h.form_obj(_,{ref:n}):$p.iface.set_hash(h.class_name,n))}function l(e){var t=_.elmnts.grid.getSelectedRowId();t?h.print(t,e,_):$p.msg.show_msg({type:"alert-warning",text:$p.msg.no_selected_row.replace("%1",""),title:$p.msg.main_title})}function c(){var e=_.elmnts.grid.getSelectedRowId();e?h.get(e,!0,!0).then(function(e){dhtmlx.confirm({title:$p.msg.main_title,text:e._deleted?$p.msg.mark_undelete_confirm.replace("%1",e.presentation):$p.msg.mark_delete_confirm.replace("%1",e.presentation),cancel:"Отмена",callback:function(t){t&&e.mark_deleted(!e._deleted)}})}):$p.msg.show_msg({type:"alert-warning",text:$p.msg.no_selected_row.replace("%1",""),title:$p.msg.main_title})}function d(n){document.body.removeEventListener("keydown",a),t&&t.on_close&&!n&&t.on_close(),n||(h=_=m=v=w=e=t=null)}function u(){return setTimeout(d,10),e.on_unload&&e.on_unload.call(e.grid||e),x&&($p.eve.detachEvent(x),x=null),!0}function f(e,n){var a=_.elmnts.filter.get_filter()._mixin({action:"get_selection",metadata:m,class_name:h.class_name,order_by:_.elmnts.grid.columnIds[b]||b,direction:y,start:e||((_.elmnts.grid.currentPage||1)-1)*_.elmnts.grid.rowsBufferOutSize,count:n||_.elmnts.grid.rowsBufferOutSize,get_header:void 0==v.get_header}),i=g?_.elmnts.tree.getSelectedItemId():null;if(t.date_from&&!a.date_from&&(a.date_from=t.date_from),t.date_till&&!a.date_till&&(a.date_till=t.date_till),t.initial_value&&(a.initial_value=t.initial_value),t.custom_selection&&(a.custom_selection=t.custom_selection),t.selection)if(a.selection)if(Array.isArray(t.selection))t.selection.forEach(function(e){a.selection.push(e)});else for(var r in t.selection){res.selection||(res.selection=[]);var o={};o[r]=t.selection[r],a.selection.push(o)}else a.selection=t.selection;t.owner&&!a.owner&&(a.owner=t.owner),a.parent=!i&&!t.parent||a.filter?null:i||t.parent,g&&!a.parent&&(a.parent=$p.utils.blank.guid);for(var s in a)if(v[s]!=a[s])return v=a,a}function p(e){var t=_.elmnts.grid.getSortingState();return b=e,y="des"==t[1]?"asc":"des",_.elmnts.grid.reload(),!0}e||(e=t&&t.pwnd?t.pwnd:{}),t||e instanceof dhtmlXCellObject||(t=e,e={}),t||(t={});var _,h=this,m=t.metadata||h.metadata(),g=m.hierarchical&&!(h instanceof ChartOfAccountManager),b=0,y="asc",v={},w=e.on_select||t.on_select;g&&t.initial_value&&t.initial_value!=$p.utils.blank.guid&&!t.parent?h.get(t.initial_value,!0).then(function(e){t.parent=e.parent.ref,t.set_parent=t.parent,n()}):n();var x=$p.eve.attachEvent("frm_close",function(e,t){h&&h.class_name==e&&_.elmnts.grid.reload().then(function(){$p.utils.is_empty_guid(t)||_.elmnts.grid.selectRowById(t,!1,!0,!0)})});return _},DataManager.prototype.form_list=function(e,t){return this.form_selection(e,t)},$p.iface.wnd_sync=function(){function e(){var e={name:"wnd_sync",wnd:{id:"wnd_sync",top:130,left:200,width:496,height:290,modal:!0,center:!0,caption:"Подготовка данных"}};t.wnd_sync=$p.iface.dat_blank(null,e.wnd);var n=[{type:"block",name:"form_block_1",list:[{type:"label",name:"form_label_1",label:$p.msg.sync_data},{type:"block",name:"form_block_2",list:[{type:"template",name:"img_long",className:"img_long"},{type:"newcolumn"},{type:"template",name:"text_processed"},{type:"template",name:"text_current"},{type:"template",name:"text_bottom"}]}]},{type:"button",name:"form_button_1",value:$p.msg.sync_break}];t.frm_sync=t.wnd_sync.attachForm(n),t.frm_sync.attachEvent("onButtonClick",function(e){t&&(t.do_break=!0)}),t.frm_sync.setItemValue("text_processed","Инициализация"),t.frm_sync.setItemValue("text_bottom","Загружается структура таблиц...")}var t,n=$p.iface.sync={};n.create=function(n){t=n,e()},n.update=function(e){t.frm_sync.setItemValue("text_processed","Обработано элементов: "+t.step*t.step_size+" из "+t.count_all);var n,a="",i=0;for(var r in e){if(i++,i>4)break;a&&(a+="<br />"),n=$p.cat[r].metadata(),a+=(n.list_presentation||n.synonym)+" ("+e[r].length+")"}t.frm_sync.setItemValue("text_current","Текущий запрос: "+t.step+" ("+Math.round(t.step*t.step_size*100/t.count_all)+"%)"),
t.frm_sync.setItemValue("text_bottom",a)},n.close=function(){t&&t.wnd_sync&&(t.wnd_sync.close(),delete t.wnd_sync,delete t.frm_sync)}},DataManager.prototype.export=function(e){function t(){$p.wsql.restore_options("data_manager",l),l.wnd.caption="Экспорт "+s.family_name+" '"+(s.metadata().synonym||s.metadata().name)+"'",o=$p.iface.dat_blank(null,l.wnd),o.bottom_toolbar({buttons:[{name:"btn_cancel",text:'<i class="fa fa-times fa-lg"></i> Отмена',title:"Отмена",width:"80px",float:"right"},{name:"btn_ok",b:'<i class="fa fa-floppy-o"></i> Ок',title:"Выполнить экспорт",width:"50px",float:"right"}],onclick:function(e){return"btn_ok"==e?i():o.close(),!1}}),o.button("close").show(),o.button("park").hide(),o.attachEvent("onClose",r);var t=[{type:"fieldset",name:"form_range",label:"Выгрузить",list:[{type:"settings",labelWidth:320,labelAlign:"left",position:"label-right"},{type:"radio",name:"range",label:"Выделенные строки",value:"selected"},{type:"radio",name:"range",label:"Весь справочник",value:"all"}]},{type:"fieldset",name:"form_fieldset_2",label:"Дополнительно выгрузить",list:[{type:"settings",labelWidth:160,position:"label-right"},{type:"checkbox",name:"meta",label:"Описание метаданных",labelAlign:"left",position:"label-right",checked:l.meta},{type:"newcolumn"},{type:"checkbox",name:"relation",label:"Связанные объекты",position:"label-right",checked:l.relation,tooltip:"Связанные объекты по ссылкам (пока не реализовано)"}]},{type:"fieldset",name:"fieldset_format",label:"Формат файла",list:[{type:"settings",labelWidth:60,labelAlign:"left",position:"label-right"},{type:"radio",name:"format",label:"json",value:"json",tooltip:"Выгрузить в формате JSON"},{type:"newcolumn"},{type:"radio",name:"format",label:"xlsx",value:"xlsx",tooltip:"Выгрузить в офисном формате XLSX"},{type:"newcolumn"},{type:"radio",name:"format",label:"atom",value:"atom",tooltip:"Выгрузить в формате XML Atom"}]}];o.elmnts.frm=o.attachForm(t),o.elmnts.frm.setItemValue("range",l.range||"all"),e.items&&1==e.items.length?(e.obj?o.elmnts.frm.setItemLabel("range","selected","Тек. объект: "+e.items[0].presentation):s.get(e.items[0],!0).then(function(e){o.elmnts.frm.setItemLabel("range","selected","Тек. объект: "+e.presentation)}),o.elmnts.frm.setItemValue("range","selected")):e.items&&e.items.length&&o.elmnts.frm.setItemLabel("range","selected","Выделенные строки ("+e.items.length+" элем.)"),s instanceof DocManager&&o.elmnts.frm.setItemLabel("range","all","Все документы из кеша (0 элем.)"),o.elmnts.frm.setItemValue("format",l.format||"json"),o.elmnts.frm.attachEvent("onChange",n),n(),e.pwnd&&e.pwnd.isModal&&e.pwnd.isModal()&&(e.set_pwnd_modal=!0,e.pwnd.setModal(!1)),o.setModal(!0)}function n(){o.elmnts.frm.setItemValue("relation",!1),o.elmnts.frm.disableItem("relation"),"all"==o.elmnts.frm.getItemValue("range")?(o.elmnts.frm.disableItem("format","atom"),"atom"==o.elmnts.frm.getItemValue("format")&&o.elmnts.frm.setItemValue("format","json")):o.elmnts.frm.enableItem("format","atom"),"json"==o.elmnts.frm.getItemValue("format")?o.elmnts.frm.enableItem("meta"):"sql"==o.elmnts.frm.getItemValue("format")?(o.elmnts.frm.setItemValue("meta",!1),o.elmnts.frm.disableItem("meta")):(o.elmnts.frm.setItemValue("meta",!1),o.elmnts.frm.disableItem("meta"))}function a(){return l.format=o.elmnts.frm.getItemValue("format"),l.range=o.elmnts.frm.getItemValue("range"),l.meta=o.elmnts.frm.getItemValue("meta"),l.relation=o.elmnts.frm.getItemValue("relation"),l}function i(){function t(){e.obj?$p.wsql.alasql("SELECT * INTO XLSX('"+s.table_name+".xlsx',{headers:true}) FROM ?",[e.items[0]._obj]):$p.wsql.alasql("SELECT * INTO XLSX('"+s.table_name+".xlsx',{headers:true}) FROM "+s.table_name)}a();var n={meta:{},items:{}},i=n.items[s.class_name]=[];if(l.meta&&(n.meta[s.class_name]=s.metadata()),"json"==l.format)e.obj?i.push(e.items[0]._obj):s.each(function(t){"all"!=l.range&&e.items.indexOf(t.ref)==-1||i.push(t._obj)}),e.items.length&&!i.length?s.get(e.items[0],!0).then(function(e){i.push(e._obj),alasql.utils.saveFile(s.table_name+".json",JSON.stringify(n,null,4))}):alasql.utils.saveFile(s.table_name+".json",JSON.stringify(n,null,4));else if("xlsx"==l.format)window.xlsx?t():$p.load_script("//cdn.jsdelivr.net/js-xlsx/latest/xlsx.core.min.js","script",t);else if("atom"==l.format&&e.items.length){var r=e.obj?Promise.resolve(e.items[0]):s.get(e.items[0],!0);r.then(function(e){alasql.utils.saveFile(s.table_name+".xml",e.to_atom())})}else $p.msg.show_not_implemented()}function r(t){return $p.iface.popup.hide(),o.wnd_options(l.wnd),$p.wsql.save_options("data_manager",a()),o.setModal(!1),e.set_pwnd_modal&&e.pwnd.setModal&&e.pwnd.setModal(!0),!0}e&&"string"==typeof e?e={items:e.split(",")}:e||(e={items:[]});var o,s=this,l={name:"export",wnd:{top:130,left:200,width:480,height:350}};t()},DataManager.prototype.import=function(e,t){function n(e){function n(e,n){var a=_md.mgr_by_class_name(e);if(n.length)if(t){if(t._manager==a)for(var r in n)$p.utils.fix_guid(n[r])==t.ref&&(i=!0,a.load_array([n[r]],!0))}else i=!0,a.load_array(n,!0)}if(o.close(),a.files.length){var r=new FileReader;r.onload=function(e){try{var t=JSON.parse(r.result);if(t.items)for(var a in t.items)n(a,t.items[a]);else["cat","doc","ireg","areg","cch","cacc"].forEach(function(e){if(t[e])for(var a in t[e])n(e+"."+a,t.cat[a])});i||$p.msg.show_msg($p.msg.sync_no_data)}catch(e){$p.msg.show_msg(e.message)}},r.readAsText(a.files[0])}}var a,i;if(!e&&void 0!=typeof window){var r={name:"import",wnd:{width:300,height:100,caption:$p.msg.select_file_import}},o=$p.iface.dat_blank(null,r.wnd);a=document.createElement("input"),a.setAttribute("id","json_file"),a.setAttribute("type","file"),a.setAttribute("accept",".json"),a.setAttribute("value","*.json"),a.onchange=n,o.button("close").show(),o.button("park").hide(),o.attachObject(a),o.centerOnScreen(),o.setModal(!0),setTimeout(function(){a.click()},100)}},$p.eve.__define({set_offline:{value:function(e){var t=$p.job_prm.offline;$p.job_prm.offline=!(!e&&!$p.wsql.get_user_param("offline","boolean")),t!=$p.job_prm.offline&&(t=$p.job_prm.offline)}},on_rotate:{value:function(e){$p.job_prm.device_orient=0==w.orientation||180==w.orientation?"portrait":"landscape","undefined"!=typeof e&&eve.callEvent("onOrientationChange",[$p.job_prm.device_orient])}},steps:{value:{load_meta:0,authorization:1,create_managers:2,process_access:3,load_data_files:4,load_data_db:5,load_data_wsql:6,save_data_wsql:7}},log_in:{value:function(e){var t,n={};return e($p.eve.steps.load_meta),$p.ajax.default_attr(n,$p.job_prm.irest_url()),($p.job_prm.offline?Promise.resolve({responseURL:"",response:""}):$p.ajax.get_ex(n.url,n)).then(function(e){if($p.job_prm.offline||($p.job_prm.irest_enabled=!0),"{"==e.response[0])return JSON.parse(e.response)}).catch(function(){}).then(function(n){return e($p.eve.steps.authorization),t=n,t.root=!0,$p.job_prm.offline||$p.job_prm.irest_enabled?t:$p.ajax.get_ex($p.job_prm.rest_url()+"?$format=json",!0).then(function(){return t})}).catch(function(e){throw $p.iface.auth.onerror&&$p.iface.auth.onerror(e),e}).then(function(t){return e($p.eve.steps.load_data_files),$p.job_prm.offline?t:(eve.callEvent("log_in",[$p.ajax.authorized=!0]),"string"==typeof t&&(t=JSON.parse(t)),void($p.msg.check_soap_result(t)||($p.wsql.get_user_param("enable_save_pwd")?$p.wsql.set_user_param("user_pwd",$p.ajax.password):$p.wsql.get_user_param("user_pwd")&&$p.wsql.set_user_param("user_pwd",""),t.now_1с&&t.now_js&&$p.wsql.set_user_param("time_diff",t.now_1с-t.now_js))))}).then(function(){_md.printing_plates(t.printing_plates)})}}}),function(w){var eve=$p.eve,msg=$p.msg,timer_setted=!1,cache;w.addEventListener("online",eve.set_offline),w.addEventListener("offline",function(){eve.set_offline(!0)}),w.addEventListener("load",function(){function do_reload(){$p.ajax.authorized||(eve.redirect=!0,location.reload(!0))}setTimeout(function(){function navigate(e){e&&(location.origin+location.pathname).indexOf(e)==-1&&location.replace(e)}function init_params(){function e(){var e=dhtmlx.codebase,t=!0,n=!0;for(e.indexOf("cdn.jsdelivr.net")!=-1&&(e="//cdn.jsdelivr.net/metadata/latest/"),i=0;i<document.styleSheets.length;i++)document.styleSheets[i].href&&(document.styleSheets[i].href.indexOf("dhx_web")==-1&&document.styleSheets[i].href.indexOf("dhx_terrace")==-1||(t=!1),document.styleSheets[i].href.indexOf("metadata.css")!=-1&&(n=!1));dhtmlx.skin=$p.wsql.get_user_param("skin")||$p.job_prm.skin||"dhx_web",t&&$p.load_script(e+("dhx_web"==dhtmlx.skin?"dhx_web.css":"dhx_terrace.css"),"link"),n&&$p.load_script(e+"metadata.css","link"),$p.job_prm.additional_css&&$p.job_prm.additional_css.forEach(function(e){(dhx4.isIE||e.indexOf("ie_only")==-1)&&$p.load_script(e,"link")}),dhtmlx.image_path="//oknosoft.github.io/metadata.js/lib/imgs/",dhtmlx.skin_suffix=function(){return dhtmlx.skin.replace("dhx","")+"/"},dhx4.ajax.cache=!0,$p.iface.__define("w",{value:new dhtmlXWindows,enumerable:!1}),$p.iface.w.setSkin(dhtmlx.skin),$p.iface.__define("popup",{value:new dhtmlXPopup,enumerable:!1})}"dhtmlx"in w&&e(),eve.stepper={step:0,count_all:0,step_size:57,files:0},eve.set_offline(!navigator.onLine),setTimeout(function(){$p.wsql.init_params(),$p.wsql.pouch.load_data().catch($p.record_log);var e;(e=document.querySelector("#splash"))&&e.parentNode.removeChild(e),eve.callEvent("iface_init",[$p])},10),$p.msg.russian_names(),$p.wsql.get_user_param("use_service_worker","boolean")&&"undefined"!=typeof navigator&&"serviceWorker"in navigator&&location.protocol.indexOf("https")!=-1?navigator.serviceWorker.register("metadata_service_worker.js",{scope:"/"}).then(function(e){$p.record_log("serviceWorker register succeeded")}).catch($p.record_log):(cache=w.applicationCache)&&(cache.addEventListener("noupdate",function(e){},!1),cache.addEventListener("cached",function(e){timer_setted=!0,$p.iface.appcache&&$p.iface.appcache.close()},!1),cache.addEventListener("updateready",function(e){try{cache.swapCache(),$p.iface.appcache&&$p.iface.appcache.close()}catch(e){}do_reload()},!1),cache.addEventListener("error",$p.record_log,!1))}if(!w.JSON||!w.indexedDB)throw eve.redirect=!0,msg.show_msg({type:"alert-error",text:msg.unsupported_browser,title:msg.unsupported_browser_title}),msg.unsupported_browser;$p.__define("job_prm",{value:new JobPrm,writable:!1}),($p.job_prm.use_ip_geo||$p.job_prm.use_google_geo)&&($p.ipinfo=new IPInfo),$p.job_prm.use_google_geo&&(window.google&&window.google.maps?location_callback():$p.on("iface_init",function(){setTimeout(function(){$p.load_script("//maps.google.com/maps/api/js?callback=$p.ipinfo.location_callback","script",function(){})},100)})),$p.job_prm.allow_post_message&&w.addEventListener("message",function(event){if(("*"==$p.job_prm.allow_post_message||$p.job_prm.allow_post_message==event.origin)&&"string"==typeof event.data)try{var res=eval(event.data);if(res&&event.source){if("object"==typeof res)res=JSON.stringify(res);else if("function"==typeof res)return;event.source.postMessage(res,"*")}}catch(e){$p.record_log(e)}}),"undefined"==typeof w.orientation?$p.job_prm.device_orient=w.innerWidth>w.innerHeight?"landscape":"portrait":eve.on_rotate(),w.addEventListener("orientationchange",eve.on_rotate,!1),$p.job_prm.__define("device_type",{get:function(){var e=$p.wsql.get_user_param("device_type");return e||(e=function(e){return e<800?"phone":e<1024?"tablet":"desktop"}(Math.max(screen.width,screen.height)),$p.wsql.set_user_param("device_type",e)),e},set:function(e){$p.wsql.set_user_param("device_type",e)}}),document.body.addEventListener("keydown",function(e){eve.callEvent("keydown",[e])},!1),setTimeout(init_params,10)},10)},!1),w.onbeforeunload=function(){if(!eve.redirect)return msg.onbeforeunload},w.addEventListener("popstat",$p.iface.hash_route),w.addEventListener("hashchange",$p.iface.hash_route)}(window),SpreadsheetDocument.prototype.__define({clear:{value:function(){for(;this._attr.content.firstChild;)this._attr.content.removeChild(this._attr.content.firstChild)}},put:{value:function(e,t){var n;e instanceof HTMLElement?(n=document.createElement(e.tagName),n.innerHTML=e.innerHTML,t||(t=e.attributes)):(n=document.createElement("DIV"),n.innerHTML=e),t&&Object.keys(t).forEach(function(e){"id"!=e&&"id"!=t[e].name&&n.setAttribute(t[e].name||e,t[e].value||t[e])}),this._attr.content.appendChild(n)}},content:{get:function(){return this._attr.content},set:function(e){this.clear(),"string"==typeof e?this._attr.content.innerHTML=e:e instanceof HTMLElement&&(this._attr.content.innerHTML=e.innerHTML)}},title:{get:function(){return this._attr.title},set:function(e){this._attr.title=e}}}),$p.SpreadsheetDocument=SpreadsheetDocument,$p.HandsontableDocument=HandsontableDocument,$p.injected_data._mixin({"form_auth.xml":'<?xml version="1.0" encoding="UTF-8"?>\n<items>\n\t<item type="settings" position="label-left" labelWidth="80" inputWidth="180" noteWidth="180"/>\n\t<item type="fieldset" name="data" inputWidth="auto" label="Авторизация">\n\n        <item type="radio" name="type" labelWidth="auto" position="label-right" checked="true" value="guest" label="Гостевой (демо) режим">\n            <item type="select" name="guest" label="Роль">\n                <option value="Дилер" label="Дилер"/>\n            </item>\n        </item>\n\n\t\t<item type="radio" name="type" labelWidth="auto" position="label-right" value="auth" label="Есть учетная запись">\n\t\t\t<item type="input" value="" name="login" label="Логин" validate="NotEmpty" />\n\t\t\t<item type="password" value="" name="password" label="Пароль" validate="NotEmpty" />\n\t\t</item>\n\n\t\t<item type="button" value="Войти" name="submit"/>\n\n        <item type="template" name="text_options" className="order_dealer_options" inputWidth="170"\n              value="&lt;a href=\'#\' onclick=\'$p.iface.open_settings();\' title=\'Страница настроек программы\' &gt; &lt;i class=\'fa fa-cog fa-lg\'&gt;&lt;/i&gt; Настройки &lt;/a&gt; &lt;a href=\'//www.oknosoft.ru/feedback\' target=\'_blank\' style=\'margin-left: 9px;\' title=\'Задать вопрос через форму обратной связи\' &gt; &lt;i class=\'fa fa-question-circle fa-lg\'&gt;&lt;/i&gt; Вопрос &lt;/a&gt;"  />\n\n\t</item>\n</items>',"toolbar_add_del.xml":'<?xml version="1.0" encoding=\'utf-8\'?>\r\n<toolbar>\r\n    <item id="sep0" type="separator"/>\r\n    <item type="button" id="btn_add"    text="&lt;i class=\'fa fa-plus-circle fa-fw\'&gt;&lt;/i&gt; Добавить" title="Добавить строку"  />\r\n    <item type="button" id="btn_delete" text="&lt;i class=\'fa fa-times fa-fw\'&gt;&lt;/i&gt; Удалить"  title="Удалить строку" />\r\n</toolbar>',"toolbar_obj.xml":'<?xml version="1.0" encoding=\'utf-8\'?>\r\n<toolbar>\r\n    <item id="sep0" type="separator"/>\r\n    <item type="button" id="btn_save_close" text="&lt;b&gt;Записать и закрыть&lt;/b&gt;" title="Рассчитать, записать и закрыть" />\r\n    <item type="button" id="btn_save" text="&lt;i class=\'fa fa-floppy-o fa-fw\'&gt;&lt;/i&gt;" title="Рассчитать и записать данные"/>\r\n    <item type="button" id="btn_post" enabled="false" text="&lt;i class=\'fa fa-check-square-o fa-fw\'&gt;&lt;/i&gt;" title="Провести документ" />\r\n    <item type="button" id="btn_unpost" enabled="false" text="&lt;i class=\'fa fa-square-o fa-fw\'&gt;&lt;/i&gt;" title="Отмена проведения" />\r\n\r\n    <item type="button" id="btn_files" text="&lt;i class=\'fa fa-paperclip fa-fw\'&gt;&lt;/i&gt;" title="Присоединенные файлы"/>\r\n\r\n    <item type="buttonSelect" id="bs_print" text="&lt;i class=\'fa fa-print fa-fw\'&gt;&lt;/i&gt;" title="Печать" openAll="true">\r\n    </item>\r\n\r\n    <item type="buttonSelect" id="bs_create_by_virtue" text="&lt;i class=\'fa fa-bolt fa-fw\'&gt;&lt;/i&gt;" title="Создать на основании" openAll="true" >\r\n        <item type="button" id="btn_message" enabled="false" text="Сообщение" />\r\n    </item>\r\n\r\n    <item type="buttonSelect" id="bs_go_to" text="&lt;i class=\'fa fa-external-link fa-fw\'&gt;&lt;/i&gt;" title="Перейти" openAll="true" >\r\n        <item type="button" id="btn_go_connection" enabled="false" text="Связи" />\r\n    </item>\r\n\r\n    <item type="buttonSelect"   id="bs_more"  text="&lt;i class=\'fa fa-th-large fa-fw\'&gt;&lt;/i&gt;"  title="Дополнительно" openAll="true">\r\n\r\n        <item type="button" id="btn_import" text="&lt;i class=\'fa fa-upload fa-fw\'&gt;&lt;/i&gt; Загрузить из файла" />\r\n        <item type="button" id="btn_export" text="&lt;i class=\'fa fa-download fa-fw\'&gt;&lt;/i&gt; Выгрузить в файл" />\r\n    </item>\r\n\r\n    <item id="sep1" type="separator"/>\r\n    <item type="button" id="btn_close" text="&lt;i class=\'fa fa-times fa-fw\'&gt;&lt;/i&gt;" title="Закрыть форму"/>\r\n    <item id="sep2" type="separator"/>\r\n\r\n</toolbar>\r\n',"toolbar_ok_cancel.xml":'<?xml version="1.0" encoding=\'utf-8\'?>\r\n<toolbar>\r\n    <item id="btn_ok"       type="button"   img=""  imgdis=""   text="&lt;b&gt;Ок&lt;/b&gt;"  />\r\n    <item id="btn_cancel"   type="button"\timg=""  imgdis=""   text="Отмена" />\r\n</toolbar>',"toolbar_rep.xml":'<?xml version="1.0" encoding=\'utf-8\'?>\r\n<toolbar>\r\n    <item id="sep0" type="separator"/>\r\n    <item type="button" id="btn_run" text="&lt;i class=\'fa fa-play fa-fw\'&gt;&lt;/i&gt; Сформировать" title="Сформировать отчет"/>\r\n\r\n    <item type="buttonSelect"   id="bs_more"  text="&lt;i class=\'fa fa-th-large fa-fw\'&gt;&lt;/i&gt;"  title="Дополнительно" openAll="true">\r\n\r\n        <item type="button" id="btn_print" text="&lt;i class=\'fa fa-print fa-fw\'&gt;&lt;/i&gt; Печать" />\r\n\r\n        <item id="sep3" type="separator"/>\r\n\r\n        <item type="button" id="btn_export" text="&lt;i class=\'fa fa-file-excel-o fa-fw\'&gt;&lt;/i&gt; Выгрузить в файл" />\r\n\r\n        <item id="sep4" type="separator"/>\r\n\r\n        <item type="button" id="btn_import" text="&lt;i class=\'fa fa-folder-open-o fa-fw\'&gt;&lt;/i&gt; Выбрать вариант" />\r\n        <item type="button" id="btn_export" text="&lt;i class=\'fa fa-floppy-o fa-fw\'&gt;&lt;/i&gt; Сохранить вариант" />\r\n\r\n    </item>\r\n\r\n    <item id="sep1" type="separator"/>\r\n\r\n</toolbar>\r\n',"toolbar_selection.xml":'<?xml version="1.0" encoding=\'utf-8\'?>\r\n<toolbar>\r\n\r\n    <item id="sep0" type="separator"/>\r\n\r\n    <item id="btn_select"   type="button"   title="Выбрать элемент списка" text="&lt;b&gt;Выбрать&lt;/b&gt;"  />\r\n\r\n    <item id="sep1" type="separator"/>\r\n    <item id="btn_new"      type="button"\ttext="&lt;i class=\'fa fa-plus-circle fa-fw\'&gt;&lt;/i&gt;"\ttitle="Создать" />\r\n    <item id="btn_edit"     type="button"\ttext="&lt;i class=\'fa fa-pencil fa-fw\'&gt;&lt;/i&gt;"\ttitle="Изменить" />\r\n    <item id="btn_delete"   type="button"\ttext="&lt;i class=\'fa fa-times fa-fw\'&gt;&lt;/i&gt;"\ttitle="Удалить" />\r\n    <item id="sep2" type="separator"/>\r\n\r\n    <item type="buttonSelect" id="bs_print" text="&lt;i class=\'fa fa-print fa-fw\'&gt;&lt;/i&gt; Печать" openAll="true" >\r\n    </item>\r\n\r\n    <item type="buttonSelect"   id="bs_more"    text="&lt;i class=\'fa fa-th-large fa-fw\'&gt;&lt;/i&gt;" title="Дополнительно" openAll="true">\r\n        <item id="btn_requery"  type="button"\ttext="&lt;i class=\'fa fa-refresh fa-fw\'&gt;&lt;/i&gt; Обновить список" />\r\n    </item>\r\n\r\n    <item id="sep3" type="separator"/>\r\n\r\n</toolbar>'});var xmlToJSON=function(){this.version="1.3";var e={mergeCDATA:!0,grokAttr:!0,grokText:!0,normalize:!0,xmlns:!0,namespaceKey:"_ns",textKey:"_text",valueKey:"_value",attrKey:"_attr",cdataKey:"_cdata",attrsAsObject:!0,stripAttrPrefix:!0,stripElemPrefix:!0,childrenAsArray:!0},t=new RegExp(/(?!xmlns)^.*:/),n=new RegExp(/^\s+|\s+$/g);return this.grokType=function(e){return/^\s*$/.test(e)?null:/^(?:true|false)$/i.test(e)?"true"===e.toLowerCase():isFinite(e)?parseFloat(e):e},this.parseString=function(e,t){return this.parseXML(this.stringToXML(e),t)},this.parseXML=function(a,i){for(var r in i)e[r]=i[r];var o={},s=0,l="";if(e.xmlns&&a.namespaceURI&&(o[e.namespaceKey]=a.namespaceURI),a.attributes&&a.attributes.length>0){var c={};for(s;s<a.attributes.length;s++){var d=a.attributes.item(s);_={};var u="";u=e.stripAttrPrefix?d.name.replace(t,""):d.name,e.grokAttr?_[e.valueKey]=this.grokType(d.value.replace(n,"")):_[e.valueKey]=d.value.replace(n,""),e.xmlns&&d.namespaceURI&&(_[e.namespaceKey]=d.namespaceURI),e.attrsAsObject?c[u]=_:o[e.attrKey+u]=_}e.attrsAsObject&&(o[e.attrKey]=c)}if(a.hasChildNodes())for(var f,p,_,h=0;h<a.childNodes.length;h++)f=a.childNodes.item(h),4===f.nodeType?e.mergeCDATA?l+=f.nodeValue:o.hasOwnProperty(e.cdataKey)?(o[e.cdataKey].constructor!==Array&&(o[e.cdataKey]=[o[e.cdataKey]]),o[e.cdataKey].push(f.nodeValue)):e.childrenAsArray?(o[e.cdataKey]=[],o[e.cdataKey].push(f.nodeValue)):o[e.cdataKey]=f.nodeValue:3===f.nodeType?l+=f.nodeValue:1===f.nodeType&&(0===s&&(o={}),p=e.stripElemPrefix?f.nodeName.replace(t,""):f.nodeName,_=xmlToJSON.parseXML(f),o.hasOwnProperty(p)?(o[p].constructor!==Array&&(o[p]=[o[p]]),o[p].push(_)):(e.childrenAsArray?(o[p]=[],o[p].push(_)):o[p]=_,s++));else l||(e.childrenAsArray?(o[e.textKey]=[],o[e.textKey].push(null)):o[e.textKey]=null);if(l)if(e.grokText){var m=this.grokType(l.replace(n,""));null!==m&&void 0!==m&&(o[e.textKey]=m)}else e.normalize?o[e.textKey]=l.replace(n,"").replace(/\s+/g," "):o[e.textKey]=l.replace(n,"");return o},this.xmlToString=function(e){try{var t=e.xml?e.xml:(new XMLSerializer).serializeToString(e);return t}catch(e){return null}},this.stringToXML=function(e){try{var t=null;if(window.DOMParser){var n=new DOMParser;return t=n.parseFromString(e,"text/xml")}return t=new ActiveXObject("Microsoft.XMLDOM"),t.async=!1,t.loadXML(e),t}catch(e){return null}},this}();"undefined"!=typeof module&&null!==module&&module.exports?module.exports=xmlToJSON:"function"==typeof define&&define.amd&&define(function(){return xmlToJSON});/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
var saveAs=saveAs||function(e){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var t=e.document,n=function(){return e.URL||e.webkitURL||e},a=t.createElementNS("http://www.w3.org/1999/xhtml","a"),i="download"in a,r=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},o=/Version\/[\d\.]+.*Safari/.test(navigator.userAgent),s=e.webkitRequestFileSystem,l=e.requestFileSystem||s||e.mozRequestFileSystem,c=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},d="application/octet-stream",u=0,f=500,p=function(t){var a=function(){"string"==typeof t?n().revokeObjectURL(t):t.remove()};e.chrome?a():setTimeout(a,f)},_=function(e,t,n){t=[].concat(t);for(var a=t.length;a--;){var i=e["on"+t[a]];if("function"==typeof i)try{i.call(e,n||e)}catch(e){c(e)}}},h=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\ufeff",e],{type:e.type}):e},m=function(t,c,f){f||(t=h(t));var m,g,b,y=this,v=t.type,w=!1,x=function(){_(y,"writestart progress write writeend".split(" "))},$=function(){if(g&&o&&"undefined"!=typeof FileReader){var a=new FileReader;return a.onloadend=function(){var e=a.result;g.location.href="data:attachment/file"+e.slice(e.search(/[,;]/)),y.readyState=y.DONE,x()},a.readAsDataURL(t),void(y.readyState=y.INIT)}if(!w&&m||(m=n().createObjectURL(t)),g)g.location.href=m;else{var i=e.open(m,"_blank");void 0==i&&o&&(e.location.href=m)}y.readyState=y.DONE,x(),p(m)},k=function(e){return function(){if(y.readyState!==y.DONE)return e.apply(this,arguments)}},j={create:!0,exclusive:!1};return y.readyState=y.INIT,c||(c="download"),i?(m=n().createObjectURL(t),void setTimeout(function(){a.href=m,a.download=c,r(a),x(),p(m),y.readyState=y.DONE})):(e.chrome&&v&&v!==d&&(b=t.slice||t.webkitSlice,t=b.call(t,0,t.size,d),w=!0),s&&"download"!==c&&(c+=".download"),(v===d||s)&&(g=e),l?(u+=t.size,void l(e.TEMPORARY,u,k(function(e){e.root.getDirectory("saved",j,k(function(e){var n=function(){e.getFile(c,j,k(function(e){e.createWriter(k(function(n){n.onwriteend=function(t){g.location.href=e.toURL(),y.readyState=y.DONE,_(y,"writeend",t),p(e)},n.onerror=function(){var e=n.error;e.code!==e.ABORT_ERR&&$()},"writestart progress write abort".split(" ").forEach(function(e){n["on"+e]=y["on"+e]}),n.write(t),y.abort=function(){n.abort(),y.readyState=y.DONE},y.readyState=y.WRITING}),$)}),$)};e.getFile(c,{create:!1},k(function(e){e.remove(),n()}),k(function(e){e.code===e.NOT_FOUND_ERR?n():$()}))}),$)}),$)):void $())},g=m.prototype,b=function(e,t,n){return new m(e,t,n)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return n||(e=h(e)),navigator.msSaveOrOpenBlob(e,t||"download")}:(g.abort=function(){var e=this;e.readyState=e.DONE,_(e,"abort")},g.readyState=g.INIT=0,g.WRITING=1,g.DONE=2,g.error=g.onwritestart=g.onprogress=g.onwrite=g.onabort=g.onerror=g.onwriteend=null,b)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);/*!
* @version: 2.1.24
* @author: Dan Grossman http://www.dangrossman.info/
* @copyright: Copyright (c) 2012-2016 Dan Grossman. All rights reserved.
* @license: Licensed under the MIT license. See http://www.opensource.org/licenses/mit-license.php
* @website: https://www.improvely.com/
*/
return"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!=define.amd&&define([],function(){return saveAs}),"undefined"!=typeof module&&module.exports&&(module.exports=Aes),function(){"use strict";var e=[["","один","два","три","четыре","пять","шесть","семь","восемь","девять","десять","одиннадцать","двенадцать","тринадцать","четырнадцать","пятнадцать","шестнадцать","семнадцать","восемнадцать","девятнадцать"],["","","двадцать","тридцать","сорок","пятьдесят","шестьдесят","семьдесят","восемьдесят","девяносто"],["","сто","двести","триста","четыреста","пятьсот","шестьсот","семьсот","восемьсот","девятьсот"]],t=function(e){return parseFloat(e)},n=function(e,t){if(3!==t.length)return!1;e=Math.abs(e)%100;var n=e%10;return e>10&&e<20?t[2]:n>1&&n<5?t[1]:1===n?t[0]:t[2]},a=function(a,i){var r,o,s="";return 3===a.length&&(r=a.substr(0,1),a=a.substr(1,3),s=""+e[2][r]+" "),a<20?s=s+e[0][t(a)]+" ":(r=a.substr(0,1),o=a.substr(1,2),s=s+e[1][r]+" "+e[0][o]+" "),0===i?s+=n(a,["рубль","рубля","рублей"]):1===i?"  "!==s&&(s+=n(a,["тысяча ","тысячи ","тысяч "]),s=s.replace("один ","одна ").replace("два ","две ")):2===i?"  "!==s&&(s+=n(a,["миллион ","миллиона ","миллионов "])):3===i&&(s+=n(a,["миллиард ","миллиарда ","миллиардов "])),s},i=function(e){var t=n(e,["копейка","копейки","копеек"]);return 0===e?e="00":e<10&&(e="0"+e)," "+e+" "+t},r=function(e){if(!e)return!1;var n=typeof e;if("number"!==n&&"string"!==n)return!1;if("string"===n&&(e=t(e.replace(",",".")),isNaN(e)))return!1;if(e<=0)return!1;var r,o;e=e.toFixed(2),e.indexOf(".")!==-1&&(r=e.split("."),e=r[0],o=r[1]);for(var s,l="",c=e.length-1,d="",u=0;c>=0;)s=e.substr(c,1),d=s+d,3!==d.length&&0!==c||isNaN(t(d))||(l=a(d,u)+l,d="",u++),c--;return l=l.replace(/\s+/g," "),o&&(l+=i(t(o))),l};Number.prototype.in_words||(Number.prototype.in_words=function(){return r(this)})}(),function(e,t){if("function"==typeof define&&define.amd)define(["moment","jquery"],function(n,a){return e.daterangepicker=t(n,a)});else if("object"==typeof module&&module.exports){var n="undefined"!=typeof window?window.jQuery:void 0;n||(n=require("jquery"),n.fn||(n.fn={})),module.exports=t(require("moment"),n)}else e.daterangepicker=t(e.moment,e.jQuery)}(this,function(e,t){var n=function(n,a,i){if(this.parentEl="body",this.element=t(n),this.startDate=e().startOf("day"),this.endDate=e().endOf("day"),this.minDate=!1,this.maxDate=!1,this.dateLimit=!1,this.autoApply=!1,this.singleDatePicker=!1,this.showDropdowns=!1,this.showWeekNumbers=!1,this.showISOWeekNumbers=!1,this.showCustomRangeLabel=!0,this.timePicker=!1,this.timePicker24Hour=!1,this.timePickerIncrement=1,this.timePickerSeconds=!1,this.linkedCalendars=!0,this.autoUpdateInput=!0,this.alwaysShowCalendars=!1,this.ranges={},this.opens="right",this.element.hasClass("pull-right")&&(this.opens="left"),this.drops="down",this.element.hasClass("dropup")&&(this.drops="up"),this.buttonClasses="btn btn-sm",this.applyClass="btn-success",this.cancelClass="btn-default",this.locale={direction:"ltr",format:"DD.MM.YYYY",separator:" - ",applyLabel:"Применить",cancelLabel:"Отмена",weekLabel:"W",customRangeLabel:"Произвольные даты",daysOfWeek:e.weekdaysMin(),monthNames:e.monthsShort(),firstDay:e.localeData().firstDayOfWeek()},this.callback=function(){},this.isShowing=!1,this.leftCalendar={},this.rightCalendar={},"object"==typeof a&&null!==a||(a={}),a=t.extend(this.element.data(),a),"string"==typeof a.template||a.template instanceof t||(a.template='<div class="daterangepicker dropdown-menu"><div class="calendar left"><div class="daterangepicker_input"><input class="input-mini form-control" type="text" name="daterangepicker_start" value="" /><i class="fa fa-calendar glyphicon glyphicon-calendar"></i><div class="calendar-time"><div></div><i class="fa fa-clock-o glyphicon glyphicon-time"></i></div></div><div class="calendar-table"></div></div><div class="calendar right"><div class="daterangepicker_input"><input class="input-mini form-control" type="text" name="daterangepicker_end" value="" /><i class="fa fa-calendar glyphicon glyphicon-calendar"></i><div class="calendar-time"><div></div><i class="fa fa-clock-o glyphicon glyphicon-time"></i></div></div><div class="calendar-table"></div></div><div class="ranges"><div class="range_inputs"><button class="applyBtn" disabled="disabled" type="button"></button> <button class="cancelBtn" type="button"></button></div></div></div>'),this.parentEl=t(a.parentEl&&t(a.parentEl).length?a.parentEl:this.parentEl),this.container=t(a.template).appendTo(this.parentEl),"object"==typeof a.locale&&("string"==typeof a.locale.direction&&(this.locale.direction=a.locale.direction),"string"==typeof a.locale.format&&(this.locale.format=a.locale.format),"string"==typeof a.locale.separator&&(this.locale.separator=a.locale.separator),"object"==typeof a.locale.daysOfWeek&&(this.locale.daysOfWeek=a.locale.daysOfWeek.slice()),"object"==typeof a.locale.monthNames&&(this.locale.monthNames=a.locale.monthNames.slice()),"number"==typeof a.locale.firstDay&&(this.locale.firstDay=a.locale.firstDay),"string"==typeof a.locale.applyLabel&&(this.locale.applyLabel=a.locale.applyLabel),"string"==typeof a.locale.cancelLabel&&(this.locale.cancelLabel=a.locale.cancelLabel),"string"==typeof a.locale.weekLabel&&(this.locale.weekLabel=a.locale.weekLabel),"string"==typeof a.locale.customRangeLabel&&(this.locale.customRangeLabel=a.locale.customRangeLabel)),this.container.addClass(this.locale.direction),"string"==typeof a.startDate&&(this.startDate=e(a.startDate,this.locale.format)),"string"==typeof a.endDate&&(this.endDate=e(a.endDate,this.locale.format)),"string"==typeof a.minDate&&(this.minDate=e(a.minDate,this.locale.format)),"string"==typeof a.maxDate&&(this.maxDate=e(a.maxDate,this.locale.format)),"object"==typeof a.startDate&&(this.startDate=e(a.startDate)),"object"==typeof a.endDate&&(this.endDate=e(a.endDate)),"object"==typeof a.minDate&&(this.minDate=e(a.minDate)),"object"==typeof a.maxDate&&(this.maxDate=e(a.maxDate)),this.minDate&&this.startDate.isBefore(this.minDate)&&(this.startDate=this.minDate.clone()),this.maxDate&&this.endDate.isAfter(this.maxDate)&&(this.endDate=this.maxDate.clone()),"string"==typeof a.applyClass&&(this.applyClass=a.applyClass),"string"==typeof a.cancelClass&&(this.cancelClass=a.cancelClass),"object"==typeof a.dateLimit&&(this.dateLimit=a.dateLimit),"string"==typeof a.opens&&(this.opens=a.opens),"string"==typeof a.drops&&(this.drops=a.drops),"boolean"==typeof a.showWeekNumbers&&(this.showWeekNumbers=a.showWeekNumbers),"boolean"==typeof a.showISOWeekNumbers&&(this.showISOWeekNumbers=a.showISOWeekNumbers),"string"==typeof a.buttonClasses&&(this.buttonClasses=a.buttonClasses),"object"==typeof a.buttonClasses&&(this.buttonClasses=a.buttonClasses.join(" ")),"boolean"==typeof a.showDropdowns&&(this.showDropdowns=a.showDropdowns),"boolean"==typeof a.showCustomRangeLabel&&(this.showCustomRangeLabel=a.showCustomRangeLabel),"boolean"==typeof a.singleDatePicker&&(this.singleDatePicker=a.singleDatePicker,this.singleDatePicker&&(this.endDate=this.startDate.clone())),"boolean"==typeof a.timePicker&&(this.timePicker=a.timePicker),"boolean"==typeof a.timePickerSeconds&&(this.timePickerSeconds=a.timePickerSeconds),"number"==typeof a.timePickerIncrement&&(this.timePickerIncrement=a.timePickerIncrement),"boolean"==typeof a.timePicker24Hour&&(this.timePicker24Hour=a.timePicker24Hour),"boolean"==typeof a.autoApply&&(this.autoApply=a.autoApply),"boolean"==typeof a.autoUpdateInput&&(this.autoUpdateInput=a.autoUpdateInput),"boolean"==typeof a.linkedCalendars&&(this.linkedCalendars=a.linkedCalendars),"function"==typeof a.isInvalidDate&&(this.isInvalidDate=a.isInvalidDate),"function"==typeof a.isCustomDate&&(this.isCustomDate=a.isCustomDate),"boolean"==typeof a.alwaysShowCalendars&&(this.alwaysShowCalendars=a.alwaysShowCalendars),0!=this.locale.firstDay)for(var r=this.locale.firstDay;r>0;)this.locale.daysOfWeek.push(this.locale.daysOfWeek.shift()),r--;var o,s,l;if("undefined"==typeof a.startDate&&"undefined"==typeof a.endDate&&t(this.element).is("input[type=text]")){var c=t(this.element).val(),d=c.split(this.locale.separator);o=s=null,2==d.length?(o=e(d[0],this.locale.format),s=e(d[1],this.locale.format)):this.singleDatePicker&&""!==c&&(o=e(c,this.locale.format),s=e(c,this.locale.format)),null!==o&&null!==s&&(this.setStartDate(o),this.setEndDate(s))}if("object"==typeof a.ranges){for(l in a.ranges){o="string"==typeof a.ranges[l][0]?e(a.ranges[l][0],this.locale.format):e(a.ranges[l][0]),s="string"==typeof a.ranges[l][1]?e(a.ranges[l][1],this.locale.format):e(a.ranges[l][1]),this.minDate&&o.isBefore(this.minDate)&&(o=this.minDate.clone());var u=this.maxDate;if(this.dateLimit&&u&&o.clone().add(this.dateLimit).isAfter(u)&&(u=o.clone().add(this.dateLimit)),u&&s.isAfter(u)&&(s=u.clone()),!(this.minDate&&s.isBefore(this.minDate,this.timepicker?"minute":"day")||u&&o.isAfter(u,this.timepicker?"minute":"day"))){var f=document.createElement("textarea");f.innerHTML=l;var p=f.value;this.ranges[p]=[o,s]}}var _="<ul>";for(l in this.ranges)_+='<li data-range-key="'+l+'">'+l+"</li>";this.showCustomRangeLabel&&(_+='<li data-range-key="'+this.locale.customRangeLabel+'">'+this.locale.customRangeLabel+"</li>"),_+="</ul>",this.container.find(".ranges").prepend(_)}"function"==typeof i&&(this.callback=i),this.timePicker||(this.startDate=this.startDate.startOf("day"),this.endDate=this.endDate.endOf("day"),this.container.find(".calendar-time").hide()),this.timePicker&&this.autoApply&&(this.autoApply=!1),this.autoApply&&"object"!=typeof a.ranges?this.container.find(".ranges").hide():this.autoApply&&this.container.find(".applyBtn, .cancelBtn").addClass("hide"),this.singleDatePicker&&(this.container.addClass("single"),this.container.find(".calendar.left").addClass("single"),this.container.find(".calendar.left").show(),this.container.find(".calendar.right").hide(),this.container.find(".daterangepicker_input input, .daterangepicker_input > i").hide(),this.timePicker?this.container.find(".ranges ul").hide():this.container.find(".ranges").hide()),("undefined"==typeof a.ranges&&!this.singleDatePicker||this.alwaysShowCalendars)&&this.container.addClass("show-calendar"),this.container.addClass("opens"+this.opens),"undefined"!=typeof a.ranges&&"right"==this.opens&&this.container.find(".ranges").prependTo(this.container.find(".calendar.left").parent()),this.container.find(".applyBtn, .cancelBtn").addClass(this.buttonClasses),this.applyClass.length&&this.container.find(".applyBtn").addClass(this.applyClass),this.cancelClass.length&&this.container.find(".cancelBtn").addClass(this.cancelClass),this.container.find(".applyBtn").html(this.locale.applyLabel),this.container.find(".cancelBtn").html(this.locale.cancelLabel),this.container.find(".calendar").on("click.daterangepicker",".prev",t.proxy(this.clickPrev,this)).on("click.daterangepicker",".next",t.proxy(this.clickNext,this)).on("mousedown.daterangepicker","td.available",t.proxy(this.clickDate,this)).on("mouseenter.daterangepicker","td.available",t.proxy(this.hoverDate,this)).on("mouseleave.daterangepicker","td.available",t.proxy(this.updateFormInputs,this)).on("change.daterangepicker","select.yearselect",t.proxy(this.monthOrYearChanged,this)).on("change.daterangepicker","select.monthselect",t.proxy(this.monthOrYearChanged,this)).on("change.daterangepicker","select.hourselect,select.minuteselect,select.secondselect,select.ampmselect",t.proxy(this.timeChanged,this)).on("click.daterangepicker",".daterangepicker_input input",t.proxy(this.showCalendars,this)).on("focus.daterangepicker",".daterangepicker_input input",t.proxy(this.formInputsFocused,this)).on("blur.daterangepicker",".daterangepicker_input input",t.proxy(this.formInputsBlurred,this)).on("change.daterangepicker",".daterangepicker_input input",t.proxy(this.formInputsChanged,this)),this.container.find(".ranges").on("click.daterangepicker","button.applyBtn",t.proxy(this.clickApply,this)).on("click.daterangepicker","button.cancelBtn",t.proxy(this.clickCancel,this)).on("click.daterangepicker","li",t.proxy(this.clickRange,this)).on("mouseenter.daterangepicker","li",t.proxy(this.hoverRange,this)).on("mouseleave.daterangepicker","li",t.proxy(this.updateFormInputs,this)),this.element.is("input")||this.element.is("button")?this.element.on({"click.daterangepicker":t.proxy(this.show,this),"focus.daterangepicker":t.proxy(this.show,this),"keyup.daterangepicker":t.proxy(this.elementChanged,this),"keydown.daterangepicker":t.proxy(this.keydown,this)}):this.element.on("click.daterangepicker",t.proxy(this.toggle,this)),this.element.is("input")&&!this.singleDatePicker&&this.autoUpdateInput?(this.element.val(this.startDate.format(this.locale.format)+this.locale.separator+this.endDate.format(this.locale.format)),this.element.trigger("change")):this.element.is("input")&&this.autoUpdateInput&&(this.element.val(this.startDate.format(this.locale.format)),this.element.trigger("change"))};return n.prototype={constructor:n,setStartDate:function(t){"string"==typeof t&&(this.startDate=e(t,this.locale.format)),"object"==typeof t&&(this.startDate=e(t)),this.timePicker||(this.startDate=this.startDate.startOf("day")),this.timePicker&&this.timePickerIncrement&&this.startDate.minute(Math.round(this.startDate.minute()/this.timePickerIncrement)*this.timePickerIncrement),this.minDate&&this.startDate.isBefore(this.minDate)&&(this.startDate=this.minDate,this.timePicker&&this.timePickerIncrement&&this.startDate.minute(Math.round(this.startDate.minute()/this.timePickerIncrement)*this.timePickerIncrement)),this.maxDate&&this.startDate.isAfter(this.maxDate)&&(this.startDate=this.maxDate,this.timePicker&&this.timePickerIncrement&&this.startDate.minute(Math.floor(this.startDate.minute()/this.timePickerIncrement)*this.timePickerIncrement)),this.isShowing||this.updateElement(),this.updateMonthsInView()},setEndDate:function(t){"string"==typeof t&&(this.endDate=e(t,this.locale.format)),"object"==typeof t&&(this.endDate=e(t)),this.timePicker||(this.endDate=this.endDate.endOf("day")),this.timePicker&&this.timePickerIncrement&&this.endDate.minute(Math.round(this.endDate.minute()/this.timePickerIncrement)*this.timePickerIncrement),this.endDate.isBefore(this.startDate)&&(this.endDate=this.startDate.clone()),this.maxDate&&this.endDate.isAfter(this.maxDate)&&(this.endDate=this.maxDate),this.dateLimit&&this.startDate.clone().add(this.dateLimit).isBefore(this.endDate)&&(this.endDate=this.startDate.clone().add(this.dateLimit)),this.previousRightTime=this.endDate.clone(),this.isShowing||this.updateElement(),this.updateMonthsInView()},isInvalidDate:function(){return!1},isCustomDate:function(){return!1},updateView:function(){this.timePicker&&(this.renderTimePicker("left"),this.renderTimePicker("right"),this.endDate?this.container.find(".right .calendar-time select").removeAttr("disabled").removeClass("disabled"):this.container.find(".right .calendar-time select").attr("disabled","disabled").addClass("disabled")),this.endDate?(this.container.find('input[name="daterangepicker_end"]').removeClass("active"),this.container.find('input[name="daterangepicker_start"]').addClass("active")):(this.container.find('input[name="daterangepicker_end"]').addClass("active"),this.container.find('input[name="daterangepicker_start"]').removeClass("active")),this.updateMonthsInView(),this.updateCalendars(),this.updateFormInputs()},updateMonthsInView:function(){if(this.endDate){if(!this.singleDatePicker&&this.leftCalendar.month&&this.rightCalendar.month&&(this.startDate.format("YYYY-MM")==this.leftCalendar.month.format("YYYY-MM")||this.startDate.format("YYYY-MM")==this.rightCalendar.month.format("YYYY-MM"))&&(this.endDate.format("YYYY-MM")==this.leftCalendar.month.format("YYYY-MM")||this.endDate.format("YYYY-MM")==this.rightCalendar.month.format("YYYY-MM")))return;this.leftCalendar.month=this.startDate.clone().date(2),this.linkedCalendars||this.endDate.month()==this.startDate.month()&&this.endDate.year()==this.startDate.year()?this.rightCalendar.month=this.startDate.clone().date(2).add(1,"month"):this.rightCalendar.month=this.endDate.clone().date(2)}else this.leftCalendar.month.format("YYYY-MM")!=this.startDate.format("YYYY-MM")&&this.rightCalendar.month.format("YYYY-MM")!=this.startDate.format("YYYY-MM")&&(this.leftCalendar.month=this.startDate.clone().date(2),this.rightCalendar.month=this.startDate.clone().date(2).add(1,"month"));this.maxDate&&this.linkedCalendars&&!this.singleDatePicker&&this.rightCalendar.month>this.maxDate&&(this.rightCalendar.month=this.maxDate.clone().date(2),this.leftCalendar.month=this.maxDate.clone().date(2).subtract(1,"month"))},updateCalendars:function(){if(this.timePicker){var e,t,n;if(this.endDate){if(e=parseInt(this.container.find(".left .hourselect").val(),10),t=parseInt(this.container.find(".left .minuteselect").val(),10),n=this.timePickerSeconds?parseInt(this.container.find(".left .secondselect").val(),10):0,!this.timePicker24Hour){var a=this.container.find(".left .ampmselect").val();"PM"===a&&e<12&&(e+=12),"AM"===a&&12===e&&(e=0)}}else if(e=parseInt(this.container.find(".right .hourselect").val(),10),t=parseInt(this.container.find(".right .minuteselect").val(),10),n=this.timePickerSeconds?parseInt(this.container.find(".right .secondselect").val(),10):0,!this.timePicker24Hour){var a=this.container.find(".right .ampmselect").val();"PM"===a&&e<12&&(e+=12),"AM"===a&&12===e&&(e=0)}this.leftCalendar.month.hour(e).minute(t).second(n),this.rightCalendar.month.hour(e).minute(t).second(n)}this.renderCalendar("left"),this.renderCalendar("right"),this.container.find(".ranges li").removeClass("active"),null!=this.endDate&&this.calculateChosenLabel()},renderCalendar:function(n){var a="left"==n?this.leftCalendar:this.rightCalendar,i=a.month.month(),r=a.month.year(),o=a.month.hour(),s=a.month.minute(),l=a.month.second(),c=e([r,i]).daysInMonth(),d=e([r,i,1]),u=e([r,i,c]),f=e(d).subtract(1,"month").month(),p=e(d).subtract(1,"month").year(),_=e([p,f]).daysInMonth(),h=d.day(),a=[];a.firstDay=d,a.lastDay=u;for(var m=0;m<6;m++)a[m]=[];var g=_-h+this.locale.firstDay+1;g>_&&(g-=7),h==this.locale.firstDay&&(g=_-6);for(var b,y,v=e([p,f,g,12,s,l]),m=0,b=0,y=0;m<42;m++,b++,v=e(v).add(24,"hour"))m>0&&b%7===0&&(b=0,y++),a[y][b]=v.clone().hour(o).minute(s).second(l),v.hour(12),this.minDate&&a[y][b].format("YYYY-MM-DD")==this.minDate.format("YYYY-MM-DD")&&a[y][b].isBefore(this.minDate)&&"left"==n&&(a[y][b]=this.minDate.clone()),this.maxDate&&a[y][b].format("YYYY-MM-DD")==this.maxDate.format("YYYY-MM-DD")&&a[y][b].isAfter(this.maxDate)&&"right"==n&&(a[y][b]=this.maxDate.clone());"left"==n?this.leftCalendar.calendar=a:this.rightCalendar.calendar=a;var w="left"==n?this.minDate:this.startDate,x=this.maxDate,$=("left"==n?this.startDate:this.endDate,"ltr"==this.locale.direction?{left:"chevron-left",right:"chevron-right"}:{left:"chevron-right",right:"chevron-left"}),k='<table class="table-condensed">';k+="<thead>",k+="<tr>",(this.showWeekNumbers||this.showISOWeekNumbers)&&(k+="<th></th>"),k+=w&&!w.isBefore(a.firstDay)||this.linkedCalendars&&"left"!=n?"<th></th>":'<th class="prev available"><i class="fa fa-'+$.left+" glyphicon glyphicon-"+$.left+'"></i></th>';var j=this.locale.monthNames[a[1][1].month()]+a[1][1].format(" YYYY");if(this.showDropdowns){for(var D=a[1][1].month(),O=a[1][1].year(),C=x&&x.year()||O+5,E=w&&w.year()||O-50,M=O==E,S=O==C,T='<select class="monthselect">',P=0;P<12;P++)T+=(!M||P>=w.month())&&(!S||P<=x.month())?"<option value='"+P+"'"+(P===D?" selected='selected'":"")+">"+this.locale.monthNames[P]+"</option>":"<option value='"+P+"'"+(P===D?" selected='selected'":"")+" disabled='disabled'>"+this.locale.monthNames[P]+"</option>";T+="</select>";for(var I='<select class="yearselect">',L=E;L<=C;L++)I+='<option value="'+L+'"'+(L===O?' selected="selected"':"")+">"+L+"</option>";I+="</select>",j=T+I}if(k+='<th colspan="5" class="month">'+j+"</th>",k+=x&&!x.isAfter(a.lastDay)||this.linkedCalendars&&"right"!=n&&!this.singleDatePicker?"<th></th>":'<th class="next available"><i class="fa fa-'+$.right+" glyphicon glyphicon-"+$.right+'"></i></th>',k+="</tr>",k+="<tr>",(this.showWeekNumbers||this.showISOWeekNumbers)&&(k+='<th class="week">'+this.locale.weekLabel+"</th>"),t.each(this.locale.daysOfWeek,function(e,t){k+="<th>"+t+"</th>"}),k+="</tr>",k+="</thead>",k+="<tbody>",null==this.endDate&&this.dateLimit){var A=this.startDate.clone().add(this.dateLimit).endOf("day");x&&!A.isBefore(x)||(x=A)}for(var y=0;y<6;y++){k+="<tr>",this.showWeekNumbers?k+='<td class="week">'+a[y][0].week()+"</td>":this.showISOWeekNumbers&&(k+='<td class="week">'+a[y][0].isoWeek()+"</td>");for(var b=0;b<7;b++){var R=[];a[y][b].isSame(new Date,"day")&&R.push("today"),a[y][b].isoWeekday()>5&&R.push("weekend"),a[y][b].month()!=a[1][1].month()&&R.push("off"),this.minDate&&a[y][b].isBefore(this.minDate,"day")&&R.push("off","disabled"),x&&a[y][b].isAfter(x,"day")&&R.push("off","disabled"),this.isInvalidDate(a[y][b])&&R.push("off","disabled"),a[y][b].format("YYYY-MM-DD")==this.startDate.format("YYYY-MM-DD")&&R.push("active","start-date"),null!=this.endDate&&a[y][b].format("YYYY-MM-DD")==this.endDate.format("YYYY-MM-DD")&&R.push("active","end-date"),null!=this.endDate&&a[y][b]>this.startDate&&a[y][b]<this.endDate&&R.push("in-range");var q=this.isCustomDate(a[y][b]);q!==!1&&("string"==typeof q?R.push(q):Array.prototype.push.apply(R,q));for(var N="",Y=!1,m=0;m<R.length;m++)N+=R[m]+" ","disabled"==R[m]&&(Y=!0);Y||(N+="available"),k+='<td class="'+N.replace(/^\s+|\s+$/g,"")+'" data-title="r'+y+"c"+b+'">'+a[y][b].date()+"</td>"}k+="</tr>"}k+="</tbody>",k+="</table>",this.container.find(".calendar."+n+" .calendar-table").html(k)},renderTimePicker:function(e){if("right"!=e||this.endDate){var t,n,a,i=this.maxDate;if(!this.dateLimit||this.maxDate&&!this.startDate.clone().add(this.dateLimit).isAfter(this.maxDate)||(i=this.startDate.clone().add(this.dateLimit)),"left"==e)n=this.startDate.clone(),a=this.minDate;else if("right"==e){n=this.endDate.clone(),a=this.startDate;var r=this.container.find(".calendar.right .calendar-time div");if(!this.endDate&&""!=r.html()&&(n.hour(r.find(".hourselect option:selected").val()||n.hour()),n.minute(r.find(".minuteselect option:selected").val()||n.minute()),n.second(r.find(".secondselect option:selected").val()||n.second()),!this.timePicker24Hour)){var o=r.find(".ampmselect option:selected").val();"PM"===o&&n.hour()<12&&n.hour(n.hour()+12),"AM"===o&&12===n.hour()&&n.hour(0)}n.isBefore(this.startDate)&&(n=this.startDate.clone()),i&&n.isAfter(i)&&(n=i.clone())}t='<select class="hourselect">';for(var s=this.timePicker24Hour?0:1,l=this.timePicker24Hour?23:12,c=s;c<=l;c++){var d=c;this.timePicker24Hour||(d=n.hour()>=12?12==c?12:c+12:12==c?0:c);var u=n.clone().hour(d),f=!1;a&&u.minute(59).isBefore(a)&&(f=!0),i&&u.minute(0).isAfter(i)&&(f=!0),t+=d!=n.hour()||f?f?'<option value="'+c+'" disabled="disabled" class="disabled">'+c+"</option>":'<option value="'+c+'">'+c+"</option>":'<option value="'+c+'" selected="selected">'+c+"</option>"}t+="</select> ",t+=': <select class="minuteselect">';for(var c=0;c<60;c+=this.timePickerIncrement){var p=c<10?"0"+c:c,u=n.clone().minute(c),f=!1;a&&u.second(59).isBefore(a)&&(f=!0),i&&u.second(0).isAfter(i)&&(f=!0),t+=n.minute()!=c||f?f?'<option value="'+c+'" disabled="disabled" class="disabled">'+p+"</option>":'<option value="'+c+'">'+p+"</option>":'<option value="'+c+'" selected="selected">'+p+"</option>"}if(t+="</select> ",this.timePickerSeconds){t+=': <select class="secondselect">';for(var c=0;c<60;c++){var p=c<10?"0"+c:c,u=n.clone().second(c),f=!1;a&&u.isBefore(a)&&(f=!0),i&&u.isAfter(i)&&(f=!0),t+=n.second()!=c||f?f?'<option value="'+c+'" disabled="disabled" class="disabled">'+p+"</option>":'<option value="'+c+'">'+p+"</option>":'<option value="'+c+'" selected="selected">'+p+"</option>"}t+="</select> "}if(!this.timePicker24Hour){t+='<select class="ampmselect">';var _="",h="";a&&n.clone().hour(12).minute(0).second(0).isBefore(a)&&(_=' disabled="disabled" class="disabled"'),i&&n.clone().hour(0).minute(0).second(0).isAfter(i)&&(h=' disabled="disabled" class="disabled"'),t+=n.hour()>=12?'<option value="AM"'+_+'>AM</option><option value="PM" selected="selected"'+h+">PM</option>":'<option value="AM" selected="selected"'+_+'>AM</option><option value="PM"'+h+">PM</option>",t+="</select>"}this.container.find(".calendar."+e+" .calendar-time div").html(t)}},updateFormInputs:function(){this.container.find("input[name=daterangepicker_start]").is(":focus")||this.container.find("input[name=daterangepicker_end]").is(":focus")||(this.container.find("input[name=daterangepicker_start]").val(this.startDate.format(this.locale.format)),this.endDate&&this.container.find("input[name=daterangepicker_end]").val(this.endDate.format(this.locale.format)),this.singleDatePicker||this.endDate&&(this.startDate.isBefore(this.endDate)||this.startDate.isSame(this.endDate))?this.container.find("button.applyBtn").removeAttr("disabled"):this.container.find("button.applyBtn").attr("disabled","disabled"))},move:function(){var e,n={top:0,left:0},a=t(window).width();this.parentEl.is("body")||(n={top:this.parentEl.offset().top-this.parentEl.scrollTop(),left:this.parentEl.offset().left-this.parentEl.scrollLeft()},a=this.parentEl[0].clientWidth+this.parentEl.offset().left),e="up"==this.drops?this.element.offset().top-this.container.outerHeight()-n.top:this.element.offset().top+this.element.outerHeight()-n.top,this.container["up"==this.drops?"addClass":"removeClass"]("dropup"),"left"==this.opens?(this.container.css({top:e,right:a-this.element.offset().left-this.element.outerWidth(),left:"auto"}),this.container.offset().left<0&&this.container.css({right:"auto",left:9})):"center"==this.opens?(this.container.css({top:e,left:this.element.offset().left-n.left+this.element.outerWidth()/2-this.container.outerWidth()/2,right:"auto"}),this.container.offset().left<0&&this.container.css({right:"auto",left:9})):(this.container.css({top:e,left:this.element.offset().left-n.left,right:"auto"}),this.container.offset().left+this.container.outerWidth()>t(window).width()&&this.container.css({left:"auto",right:0}))},show:function(e){this.isShowing||(this._outsideClickProxy=t.proxy(function(e){this.outsideClick(e)},this),t(document).on("mousedown.daterangepicker",this._outsideClickProxy).on("touchend.daterangepicker",this._outsideClickProxy).on("click.daterangepicker","[data-toggle=dropdown]",this._outsideClickProxy).on("focusin.daterangepicker",this._outsideClickProxy),t(window).on("resize.daterangepicker",t.proxy(function(e){this.move(e)},this)),this.oldStartDate=this.startDate.clone(),this.oldEndDate=this.endDate.clone(),this.previousRightTime=this.endDate.clone(),this.updateView(),this.container.show(),this.move(),this.element.trigger("show.daterangepicker",this),this.isShowing=!0)},hide:function(e){this.isShowing&&(this.endDate||(this.startDate=this.oldStartDate.clone(),this.endDate=this.oldEndDate.clone()),this.startDate.isSame(this.oldStartDate)&&this.endDate.isSame(this.oldEndDate)||this.callback(this.startDate,this.endDate,this.chosenLabel),this.updateElement(),t(document).off(".daterangepicker"),t(window).off(".daterangepicker"),this.container.hide(),this.element.trigger("hide.daterangepicker",this),this.isShowing=!1)},toggle:function(e){this.isShowing?this.hide():this.show()},outsideClick:function(e){var n=t(e.target);"focusin"==e.type||n.closest(this.element).length||n.closest(this.container).length||n.closest(".calendar-table").length||(this.hide(),this.element.trigger("outsideClick.daterangepicker",this))},showCalendars:function(){this.container.addClass("show-calendar"),this.move(),this.element.trigger("showCalendar.daterangepicker",this)},hideCalendars:function(){this.container.removeClass("show-calendar"),this.element.trigger("hideCalendar.daterangepicker",this)},hoverRange:function(e){if(!this.container.find("input[name=daterangepicker_start]").is(":focus")&&!this.container.find("input[name=daterangepicker_end]").is(":focus")){var t=e.target.getAttribute("data-range-key");if(t==this.locale.customRangeLabel)this.updateView();else{var n=this.ranges[t];this.container.find("input[name=daterangepicker_start]").val(n[0].format(this.locale.format)),this.container.find("input[name=daterangepicker_end]").val(n[1].format(this.locale.format))}}},clickRange:function(e){var t=e.target.getAttribute("data-range-key");if(this.chosenLabel=t,t==this.locale.customRangeLabel)this.showCalendars();else{var n=this.ranges[t];this.startDate=n[0],this.endDate=n[1],this.timePicker||(this.startDate.startOf("day"),this.endDate.endOf("day")),this.alwaysShowCalendars||this.hideCalendars(),this.clickApply()}},clickPrev:function(e){var n=t(e.target).parents(".calendar");n.hasClass("left")?(this.leftCalendar.month.subtract(1,"month"),this.linkedCalendars&&this.rightCalendar.month.subtract(1,"month")):this.rightCalendar.month.subtract(1,"month"),this.updateCalendars()},clickNext:function(e){var n=t(e.target).parents(".calendar");n.hasClass("left")?this.leftCalendar.month.add(1,"month"):(this.rightCalendar.month.add(1,"month"),this.linkedCalendars&&this.leftCalendar.month.add(1,"month")),this.updateCalendars()},hoverDate:function(e){if(t(e.target).hasClass("available")){var n=t(e.target).attr("data-title"),a=n.substr(1,1),i=n.substr(3,1),r=t(e.target).parents(".calendar"),o=r.hasClass("left")?this.leftCalendar.calendar[a][i]:this.rightCalendar.calendar[a][i];this.endDate&&!this.container.find("input[name=daterangepicker_start]").is(":focus")?this.container.find("input[name=daterangepicker_start]").val(o.format(this.locale.format)):this.endDate||this.container.find("input[name=daterangepicker_end]").is(":focus")||this.container.find("input[name=daterangepicker_end]").val(o.format(this.locale.format));var s=this.leftCalendar,l=this.rightCalendar,c=this.startDate;this.endDate||this.container.find(".calendar td").each(function(e,n){if(!t(n).hasClass("week")){var a=t(n).attr("data-title"),i=a.substr(1,1),r=a.substr(3,1),d=t(n).parents(".calendar"),u=d.hasClass("left")?s.calendar[i][r]:l.calendar[i][r];u.isAfter(c)&&u.isBefore(o)||u.isSame(o,"day")?t(n).addClass("in-range"):t(n).removeClass("in-range")}})}},clickDate:function(e){if(t(e.target).hasClass("available")){var n=t(e.target).attr("data-title"),a=n.substr(1,1),i=n.substr(3,1),r=t(e.target).parents(".calendar"),o=r.hasClass("left")?this.leftCalendar.calendar[a][i]:this.rightCalendar.calendar[a][i];if(this.endDate||o.isBefore(this.startDate,"day")){if(this.timePicker){var s=parseInt(this.container.find(".left .hourselect").val(),10);if(!this.timePicker24Hour){var l=this.container.find(".left .ampmselect").val();"PM"===l&&s<12&&(s+=12),"AM"===l&&12===s&&(s=0)}var c=parseInt(this.container.find(".left .minuteselect").val(),10),d=this.timePickerSeconds?parseInt(this.container.find(".left .secondselect").val(),10):0;o=o.clone().hour(s).minute(c).second(d)}this.endDate=null,this.setStartDate(o.clone())}else if(!this.endDate&&o.isBefore(this.startDate))this.setEndDate(this.startDate.clone());else{if(this.timePicker){var s=parseInt(this.container.find(".right .hourselect").val(),10);if(!this.timePicker24Hour){var l=this.container.find(".right .ampmselect").val();"PM"===l&&s<12&&(s+=12),"AM"===l&&12===s&&(s=0)}var c=parseInt(this.container.find(".right .minuteselect").val(),10),d=this.timePickerSeconds?parseInt(this.container.find(".right .secondselect").val(),10):0;o=o.clone().hour(s).minute(c).second(d)}this.setEndDate(o.clone()),this.autoApply&&(this.calculateChosenLabel(),this.clickApply())}this.singleDatePicker&&(this.setEndDate(this.startDate),this.timePicker||this.clickApply()),this.updateView(),e.stopPropagation()}},calculateChosenLabel:function(){var e=!0,t=0;for(var n in this.ranges){if(this.timePicker){if(this.startDate.isSame(this.ranges[n][0])&&this.endDate.isSame(this.ranges[n][1])){e=!1,this.chosenLabel=this.container.find(".ranges li:eq("+t+")").addClass("active").html();break}}else if(this.startDate.format("YYYY-MM-DD")==this.ranges[n][0].format("YYYY-MM-DD")&&this.endDate.format("YYYY-MM-DD")==this.ranges[n][1].format("YYYY-MM-DD")){
e=!1,this.chosenLabel=this.container.find(".ranges li:eq("+t+")").addClass("active").html();break}t++}e&&this.showCustomRangeLabel&&(this.chosenLabel=this.container.find(".ranges li:last").addClass("active").html(),this.showCalendars())},clickApply:function(e){this.hide(),this.element.trigger("apply.daterangepicker",this)},clickCancel:function(e){this.startDate=this.oldStartDate,this.endDate=this.oldEndDate,this.hide(),this.element.trigger("cancel.daterangepicker",this)},monthOrYearChanged:function(e){var n=t(e.target).closest(".calendar").hasClass("left"),a=n?"left":"right",i=this.container.find(".calendar."+a),r=parseInt(i.find(".monthselect").val(),10),o=i.find(".yearselect").val();n||(o<this.startDate.year()||o==this.startDate.year()&&r<this.startDate.month())&&(r=this.startDate.month(),o=this.startDate.year()),this.minDate&&(o<this.minDate.year()||o==this.minDate.year()&&r<this.minDate.month())&&(r=this.minDate.month(),o=this.minDate.year()),this.maxDate&&(o>this.maxDate.year()||o==this.maxDate.year()&&r>this.maxDate.month())&&(r=this.maxDate.month(),o=this.maxDate.year()),n?(this.leftCalendar.month.month(r).year(o),this.linkedCalendars&&(this.rightCalendar.month=this.leftCalendar.month.clone().add(1,"month"))):(this.rightCalendar.month.month(r).year(o),this.linkedCalendars&&(this.leftCalendar.month=this.rightCalendar.month.clone().subtract(1,"month"))),this.updateCalendars()},timeChanged:function(e){var n=t(e.target).closest(".calendar"),a=n.hasClass("left"),i=parseInt(n.find(".hourselect").val(),10),r=parseInt(n.find(".minuteselect").val(),10),o=this.timePickerSeconds?parseInt(n.find(".secondselect").val(),10):0;if(!this.timePicker24Hour){var s=n.find(".ampmselect").val();"PM"===s&&i<12&&(i+=12),"AM"===s&&12===i&&(i=0)}if(a){var l=this.startDate.clone();l.hour(i),l.minute(r),l.second(o),this.setStartDate(l),this.singleDatePicker?this.endDate=this.startDate.clone():this.endDate&&this.endDate.format("YYYY-MM-DD")==l.format("YYYY-MM-DD")&&this.endDate.isBefore(l)&&this.setEndDate(l.clone())}else if(this.endDate){var c=this.endDate.clone();c.hour(i),c.minute(r),c.second(o),this.setEndDate(c)}this.updateCalendars(),this.updateFormInputs(),this.renderTimePicker("left"),this.renderTimePicker("right")},formInputsChanged:function(n){var a=t(n.target).closest(".calendar").hasClass("right"),i=e(this.container.find('input[name="daterangepicker_start"]').val(),this.locale.format),r=e(this.container.find('input[name="daterangepicker_end"]').val(),this.locale.format);i.isValid()&&r.isValid()&&(a&&r.isBefore(i)&&(i=r.clone()),this.setStartDate(i),this.setEndDate(r),a?this.container.find('input[name="daterangepicker_start"]').val(this.startDate.format(this.locale.format)):this.container.find('input[name="daterangepicker_end"]').val(this.endDate.format(this.locale.format))),this.updateView()},formInputsFocused:function(e){this.container.find('input[name="daterangepicker_start"], input[name="daterangepicker_end"]').removeClass("active"),t(e.target).addClass("active");var n=t(e.target).closest(".calendar").hasClass("right");n&&(this.endDate=null,this.setStartDate(this.startDate.clone()),this.updateView())},formInputsBlurred:function(t){if(!this.endDate){var n=this.container.find('input[name="daterangepicker_end"]').val(),a=e(n,this.locale.format);a.isValid()&&(this.setEndDate(a),this.updateView())}},elementChanged:function(){if(this.element.is("input")&&this.element.val().length&&!(this.element.val().length<this.locale.format.length)){var t=this.element.val().split(this.locale.separator),n=null,a=null;2===t.length&&(n=e(t[0],this.locale.format),a=e(t[1],this.locale.format)),(this.singleDatePicker||null===n||null===a)&&(n=e(this.element.val(),this.locale.format),a=n),n.isValid()&&a.isValid()&&(this.setStartDate(n),this.setEndDate(a),this.updateView())}},keydown:function(e){9!==e.keyCode&&13!==e.keyCode||this.hide()},updateElement:function(){this.element.is("input")&&!this.singleDatePicker&&this.autoUpdateInput?(this.element.val(this.startDate.format(this.locale.format)+this.locale.separator+this.endDate.format(this.locale.format)),this.element.trigger("change")):this.element.is("input")&&this.autoUpdateInput&&(this.element.val(this.startDate.format(this.locale.format)),this.element.trigger("change"))},remove:function(){this.container.remove(),this.element.off(".daterangepicker"),this.element.removeData()}},t.fn.daterangepicker=function(e,a){return this.each(function(){var i=t(this);i.data("daterangepicker")&&i.data("daterangepicker").remove(),i.data("daterangepicker",new n(i,e,a))}),this},n}),$p});