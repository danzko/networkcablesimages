/*
 content of this file is covered by Oknosoft Commercial license. Usage without proper license is prohibited. To obtain it contact info@oknosoft.ru
 @author  Evgeniy Malyarov
 @module  metadata
*/
function MetaEngine(){this.version="0.9.201";this.toString=function(){return"Oknosoft data engine. v:"+this.version}}$p=new MetaEngine;"function"===typeof define&&define.amd?define("$p",$p):"object"===typeof module&&module&&(module.exports=$p);
"undefined"!==typeof window?$p.load_script=function(a,b,c){var e=document.createElement(b);"script"==b?(e.type="text/javascript",e.src=a,c?(e.async=!0,e.addEventListener("load",c,!1)):e.async=!1):(e.type="text/css",e.rel="stylesheet",e.href=a);document.head.appendChild(e)}:"undefined"===typeof WorkerGlobalScope&&("undefined"===typeof localStorage&&(localStorage=(new require("node-localstorage")).LocalStorage("./localstorage")),"undefined"===typeof window&&"undefined"===typeof alasql&&(alasql=require("alasql")));
Object.defineProperty(Object.prototype,"__define",{value:function(a,b){b?Object.defineProperty(this,a,b):Object.defineProperties(this,a);return this},enumerable:!1});
Object.prototype.__define({_extend:{value:function(a){var b=function(){};b.prototype=a.prototype;this.prototype=new b;this.prototype.constructor=this;this.__define("superclass",{value:a.prototype,enumerable:!1})},enumerable:!1},_mixin:{value:function(a,b,c){var e={},d,f;if(b&&b.length)for(d=0;d<b.length;d++){if(f=b[d],!c||-1==c.indexOf(f))if("undefined"==typeof e[f]||e[f]!=a[f])this[f]=a[f]}else for(f in a)if(!c||-1==c.indexOf(f))if("undefined"==typeof e[f]||e[f]!=a[f])this[f]=a[f];return this},enumerable:!1},
_clone:{value:function(){if(!this||"object"!==typeof this)return this;var a,b,c="function"===typeof this.pop?[]:{};for(a in this)this.hasOwnProperty(a)&&(b=this[a],c[a]=b?"function"===typeof b||b instanceof DataObj||b instanceof DataManager?b:"object"===typeof b?b._clone():b:b);return c},enumerable:!1}});
Object.observe||Object.unobserve||Object.getNotifier||Object.prototype.__define({observe:{value:function(a,b){a._observers||a.__define({_observers:{value:[],enumerable:!1},_notis:{value:[],enumerable:!1}});a._observers.push(b)},enumerable:!1},unobserve:{value:function(a,b){if(a._observers)for(var c in a._observers)if(a._observers[c]===b){a._observers.splice(c,1);break}},enumerable:!1},getNotifier:{value:function(a){var b;return{notify:function(c){a._observers&&(a._notis.push(c),b||(b=!0,setTimeout(function(){a._observers.forEach(function(b){b(a._notis)});
a._notis.length=0;b=!1},10)))}}},enumerable:!1}});
$p.dateFormat=function(){var a=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,b=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,c=/[^-+\dA-Z]/g,e=function(a,b){a=String(a);for(b=b||2;a.length<b;)a="0"+a;return a};return function(d,f,g){var h=$p.dateFormat;f||(f=$p.dateFormat.masks.ru);1!=arguments.length||"[object String]"!=Object.prototype.toString.call(d)||/\d/.test(d)||(f=d,d=void 0);d=d?new Date(d):
new Date;isNaN(d)&&(d=new Date(0));f=String(h.masks[f]||f||h.masks["default"]);"UTC:"==f.slice(0,4)&&(f=f.slice(4),g=!0);var k=g?"getUTC":"get",l=d[k+"Date"](),m=d[k+"Day"](),n=d[k+"Month"](),p=d[k+"FullYear"](),q=d[k+"Hours"](),t=d[k+"Minutes"](),r=d[k+"Seconds"](),k=d[k+"Milliseconds"](),u=g?0:d.getTimezoneOffset(),v={d:l,dd:e(l),ddd:h.i18n.dayNames[m],dddd:h.i18n.dayNames[m+7],m:n+1,mm:e(n+1),mmm:h.i18n.monthNames[n],mmmm:h.i18n.monthNames[n+12],yy:String(p).slice(2),yyyy:p,h:q%12||12,hh:e(q%12||
12),H:q,HH:e(q),M:t,MM:e(t),s:r,ss:e(r),l:e(k,3),L:e(99<k?Math.round(k/10):k),t:12>q?"a":"p",tt:12>q?"am":"pm",T:12>q?"A":"P",TT:12>q?"AM":"PM",Z:g?"UTC":(String(d).match(b)||[""]).pop().replace(c,""),o:(0<u?"-":"+")+e(100*Math.floor(Math.abs(u)/60)+Math.abs(u)%60,4),S:["th","st","nd","rd"][3<l%10?0:(10!=l%100-l%10)*l%10]};return f.replace(a,function(a){return a in v?v[a]:a.slice(1,a.length-1)})}}();
$p.dateFormat.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'",atom:"yyyy-mm-dd'T'HH:MM:ss'Z'",ru:"dd.mm.yyyy HH:MM",short_ru:"dd.mm.yyyy",date:"dd.mm.yy",date_time:"dd.mm.yy HH:MM"};
$p.ajax=new function(){function a(a,c,e,d,f){return new Promise(function(g,h){var k=new XMLHttpRequest;"undefined"!=typeof window&&window.dhx4&&window.dhx4.isIE&&(c=encodeURI(c));if(d){var l,m;"object"==typeof d&&d.username&&d.hasOwnProperty("password")?(l=d.username,m=d.password):$p.ajax.username&&$p.ajax.authorized?(l=$p.ajax.username,m=$p.ajax.password):(l=$p.wsql.get_user_param("user_name"),m=$p.wsql.get_user_param("user_pwd"),!l&&$p.job_prm&&$p.job_prm.guest_name&&(l=$p.job_prm.guest_name,m=
$p.job_prm.guest_pwd));k.open(a,c,!0,l,m);k.withCredentials=!0;k.setRequestHeader("Authorization","Basic "+btoa(unescape(encodeURIComponent(l+":"+m))))}else k.open(a,c,!0);f&&f.call(this,k);"GET"!=a?this.hide_headers||d.hide_headers||(k.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),k.setRequestHeader("X-Requested-With","XMLHttpRequest")):e=null;k.onload=function(){200==k.status&&(k.response instanceof Blob||"<!DOCTYPE"!==k.response.substr(0,9))?(void 0==k.responseURL&&(k.responseURL=
c),g(k)):k.response?h({message:k.statusText,description:k.response,status:k.status}):h(Error(k.statusText))};k.onerror=function(){h(Error("Network Error"))};k.send(e)})}this.password=this.username="";this.authorized=!1;this.get=function(b){return a.call(this,"GET",b)};this.post=function(b,c){1==arguments.length?c="":2==arguments.length&&"function"==typeof c?(onLoad=c,c=""):c=String(c);return a.call(this,"POST",b,c)};this.get_ex=function(b,c,e){return a.call(this,"GET",b,null,c,e)};this.post_ex=function(b,
c,e,d){return a.call(this,"POST",b,c,e,d)};this.put_ex=function(b,c,e,d){return a.call(this,"PUT",b,c,e,d)};this.patch_ex=function(b,c,e,d){return a.call(this,"PATCH",b,c,e,d)};this.delete_ex=function(b,c,e){return a.call(this,"DELETE",b,null,c,e)};this.get_and_show_blob=function(a,c,e){function d(c){a=window.URL.createObjectURL(c.response);f=window.open(a,"wnd_print","menubar=no,toolbar=no,location=no,status=no,directories=no,resizable=yes,scrollbars=yes");f.onload=function(c){window.URL.revokeObjectURL(a)};
return f}var f;return e&&-1==e.toLowerCase().indexOf("post")?this.get_ex(a,c,function(a){a.responseType="blob"}).then(d):this.post_ex(a,"object"==typeof c?JSON.stringify(c):c,!0,function(a){a.responseType="blob"}).then(d)};this.get_and_save_blob=function(a,c,e){return this.post_ex(a,"object"==typeof c?JSON.stringify(c):c,!0,function(a){a.responseType="blob"}).then(function(a){require("filesaver").saveAs(a.response,e)})};this.default_attr=function(a,c){a.url||(a.url=c);a.username||(a.username=this.username);
a.password||(a.password=this.password);a.hide_headers=!0}};
$p.m={point_pos:function(a,b,c,e,d,f){return.2>Math.abs(c-d)?(a-c)*(e-f):.2>Math.abs(e-f)?(b-e)*(d-c):(b-e)*(d-c)-(f-e)*(a-c)},arc_cntr:function(a,b,c,e,d,f){var g,h,k,l,m;f&&(f=a,g=b,a=c,b=e,c=f,e=g);a!=c?(f=(a*a-c*c-e*e+b*b)/(2*(a-c)),g=(e-b)/(a-c),h=g*g+1,k=-2*((a-f)*g+b),l=(a-f)*(a-f)-d*d+b*b,d=(-k+Math.sqrt(k*k-4*h*l))/(2*h),m=f+g*d,h=(-k-Math.sqrt(k*k-4*h*l))/(2*h),k=f+g*h):(f=(b*b-e*e-c*c+a*a)/(2*(b-e)),g=(c-a)/(b-e),h=g*g+1,k=-2*((b-f)*g+a),l=(b-f)*(b-f)-d*d+a*a,m=(-k-Math.sqrt(k*k-4*h*l))/
(2*h),d=f+g*m,k=(-k+Math.sqrt(k*k-4*h*l))/(2*h),h=f+g*k);return 0<$p.m.point_pos(m,d,a,b,c,e)?{x:m,y:d}:{x:k,y:h}},arc_point:function(a,b,c,e,d,f,g){var h={x:(a+c)/2,y:(b+e)/2};if(0<d){var k=a-c,l=b-e,m=d*d-(k*k+l*l)/4;0<=m&&(l=$p.m.arc_cntr(a,b,c,e,d,f),k=l.x-h.x,l=h.y-l.y,a=Math.sqrt(k*k+l*l),d=g?d+Math.sqrt(m):d-Math.sqrt(m),h.x+=k*d/a,h.y+=l*d/a)}return h}};
$p.blank=new function(){this.date=new Date("0001-01-01");this.guid="00000000-0000-0000-0000-000000000000";this.by_type=function(a){return a.is_ref?$p.blank.guid:a.date_part?$p.blank.date:a.digits?0:a.types&&"boolean"==a.types[0]?!1:""}};$p.is_guid=function(a){if("string"!==typeof a||36>a.length)return!1;36<a.length&&(a=a.substr(0,36));return/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(a)};$p.is_empty_guid=function(a){return!a||a===$p.blank.guid};
$p.generate_guid=function(){var a=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c=(a+16*Math.random())%16|0;a=Math.floor(a/16);return("x"==b?c:c&7|8).toString(16)})};
$p.fix_guid=function(a,b){if(!a||"string"!=typeof a){if(a instanceof DataObj)return a.ref;if(a&&"object"==typeof a)if(a.presentation){if(a.ref)return a.ref;if(a.name)return a.name}else a="object"==typeof a.ref&&a.ref.hasOwnProperty("ref")?a.ref.ref:a.ref}return $p.is_guid(a)||!1===b?a:b?$p.generate_guid():$p.blank.guid};$p.fix_number=function(a,b){var c=parseFloat(a);return isNaN(c)?b?0:a:c};$p.fix_boolean=function(a){return"string"===typeof a?!(!a||"false"==a.toLowerCase()):!!a};
$p.fix_date=function(a,b){var c=/(^\d{1,4}[\.|\\/|-]\d{1,2}[\.|\\/|-]\d{1,4})(\s*(?:0?[1-9]:[0-5]|1(?=[012])\d:[0-5])\d\s*[ap]m)?$/;if(a instanceof Date)return a;if(a&&"string"==typeof a&&c.test(a.substr(0,10))){var c=a.split(" "),e=c[0].split(".");1==e.length&&(e=c[0].split("/"),1==e.length&&(e=c[0].split("-")));if(3==e.length&&4==e[2].length){for(var e=e[2]+"-"+e[1]+"-"+e[0],d=1;d<c.length;d++)e+=" "+c[d];c=new Date(e)}else c=new Date(a);if(c&&0<c.getFullYear())return c}return b?$p.blank.date:a};
$p.date_add_day=function(a,b){var c=new Date;c.setDate(a.getDate()+b);return c};$p.cancel_bubble=function(a){(a=a||event)&&a.stopPropagation&&a.stopPropagation();a&&!a.cancelBubble&&(a.cancelBubble=!0);return!1};$p.msg=new Messages;
function Messages(){this.toString=function(){return"Интернационализация сообщений"};"undefined"!==typeof window&&"dhtmlx"in window&&(this.show_msg=function(a,b){if(a){if("string"==typeof a){if($p.iface.synctxt){$p.iface.synctxt.show_message(a);return}a={type:"info",text:a}}b&&"function"==typeof b.setText&&b.setText(a.text);dhtmlx.message(a)}},this.check_soap_result=function(a){if(a){if("limit_query"==a.error)return $p.iface.docs.progressOff(),$p.msg.show_msg({type:"alert-warning",text:$p.msg.limit_query.replace("%1",
a.queries).replace("%2",a.queries_avalable),title:$p.msg.srv_overload}),!0;if("network"==a.error||"empty"==a.error)return $p.iface.docs.progressOff(),$p.msg.show_msg({type:"alert-warning",text:$p.msg.error_network,title:$p.msg.error_critical}),!0;if(a.error&&a.error_description)return $p.iface.docs.progressOff(),-1!=a.error_description.indexOf("Недостаточно прав")&&(a.error_type="alert-warning",a.error_title=$p.msg.error_rights),$p.msg.show_msg({type:a.error_type||"alert-error",text:a.error_description,
title:a.error_title||$p.msg.error_critical}),!0;if(a.error&&!a.messages)return $p.iface.docs.progressOff(),$p.msg.show_msg({type:"alert-error",title:$p.msg.error_critical,text:$p.msg.unknown_error.replace("%1","unknown_error")}),!0}else return $p.msg.show_msg({type:"alert-error",text:$p.msg.empty_response,title:$p.msg.error_critical}),!0},this.show_not_implemented=function(){$p.msg.show_msg({type:"alert-warning",text:$p.msg.not_implemented,title:$p.msg.main_title})})}
function InterfaceObjs(){this.toString=function(){return"Объекты интерфейса пользователя"};this.clear_svgs=function(a){for("string"===typeof a&&(a=document.getElementById(a));a.firstChild;)a.removeChild(a.firstChild)};this.get_offset=function(a){var b={left:0,top:0};if(a.offsetParent){do b.left+=a.offsetLeft,b.top+=a.offsetTop;while(a=a.offsetParent)}return b};this.normalize_xml=function(a){if(!a)return"";var b={"&":"&amp;",'"':"&quot;","'":"&apos;","<":"&lt;",">":"&gt;"};return a.replace(/[&"'<>]/g,
function(a){return b[a]})};this.scale_svg=function(a,b,c){var e,d,f,g,h={};f=a.indexOf(">");g=a.substring(5,f);d=g.split(" ");f=a.substr(f+1);f=f.substr(0,f.length-6);for(e in d)if(a=d[e].split("="),"width"==a[0]||"height"==a[0])a[1]=Number(a[1].replace(/"/g,"")),h[a[0]]=a[1];-1!=(a=g.indexOf("viewBox="))?(g=g.substring(a+9),g='viewBox="'+g.substring(0,g.indexOf('"'))+'"'):g='viewBox="0 0 '+(h.width-c)+" "+(h.height-c)+'"';c=b/(h.height-c);h.height=b;h.width=Math.round(h.width*c);return'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="'+
h.width+'" height="'+h.height+'" xml:space="preserve" '+g+">"+f+"</svg>"};this.bind_help=function(a,b){function c(a){a.help_path||$p.msg.show_msg({title:"Справка",type:"alert-info",text:$p.msg.not_implemented})}a instanceof dhtmlXCellObject||(!a.help_path&&b&&(a.help_path=b),a.button("help").show(),a.button("help").enable(),a.attachEvent("onHelp",c))};this.set_hash=function(a,b,c,e){var d={},f=$p.job_prm.parse_url();1==arguments.length&&"object"==typeof a&&(d=a,d.hasOwnProperty("obj")&&(a=d.obj,delete d.obj),
d.hasOwnProperty("ref")&&(b=d.ref,delete d.ref),d.hasOwnProperty("frm")&&(c=d.frm,delete d.frm),d.hasOwnProperty("view")&&(e=d.view,delete d.view));void 0===a&&(a=f.obj||"");void 0===b&&(b=f.ref||"");void 0===c&&(c=f.frm||"");void 0===e&&(e=f.view||"");var f="obj="+a+"&ref="+b+"&frm="+c+"&view="+e,g;for(g in d)f+="&"+g+"="+d[g];location.hash.substr(1)==f?this.hash_route():location.hash=f};this.hash_route=function(a){var b=$p.job_prm.parse_url(),c;if(!1!==$p.eve.hash_route.execute(b)&&(!$p.iface.before_route||
!1!==$p.iface.before_route(a))&&$p.ajax.authorized)if(b.ref&&"undefined"!=typeof _md){if(c=_md.mgr_by_class_name(b.obj))c[b.frm||"form_obj"]($p.iface.docs,b.ref)}else b.view&&$p.iface.swith_view&&$p.iface.swith_view(b.view);if(a)return $p.cancel_bubble(a)};this.ontimer=this.oninit=null;setTimeout(function(){$p.iface.ontimer&&"function"===typeof $p.iface.ontimer&&setInterval($p.iface.ontimer,9E4)},2E4)}$p.iface=new InterfaceObjs;
function Modifiers(){var a=[];this.push=function(b){a.push(b)};this.detache=function(b){b=a.indexOf(b);-1!=b&&a.splice(b,1)};this.execute=function(b){var c,e;a.forEach(function(a){e="function"===typeof a?a(b):require(a)(b);!1!==c&&(c=e)});return e}}$p.Modifiers=Modifiers;
function AppEvents(){this.toString=function(){return"События при начале работы программы"};this.__define("onload",{value:new Modifiers,enumerable:!1,configurable:!1});this.__define("hash_route",{value:new Modifiers,enumerable:!1,configurable:!1})}$p.eve=new AppEvents;$p.__define("modifiers",{value:new Modifiers,enumerable:!1,configurable:!1});
function JobPrm(){function a(){return $p.wsql.get_user_param("rest_path")||$p.job_prm.rest_path||"/a/zd/%1/odata/standard.odata/"}this.parse_url=function(){function a(b){var c={},f=[];if("#"===b.substr(0,1)||"?"===b.substr(0,1))b=b.substr(1);if(2<b.length){b=decodeURI(b).split("&");for(var g in b)if(f=b[g].split("="),"m"==f[0])try{c[f[0]]=JSON.parse(f[1])}catch(h){c[f[0]]={}}else c[f[0]]=f[1]||""}return c}return a(location.search)._mixin(a(location.hash))};this.check_browser_compatibility=!0;this.check_app_installed=
!1;this.check_dhtmlx=!0;this.offline=this.use_builder=!1;this.local_storage_prefix="";this.url_prm=this.parse_url();"function"===typeof $p.settings&&$p.settings(this,$p.modifiers);for(var b in this)"url_prm"!==b&&"function"!==typeof this[b]&&this.url_prm.hasOwnProperty[b]&&(this[b]=this.url_prm[b]);this.hs_url=function(){var a=this.hs_path||"/a/zd/%1/hs/upzp",b=$p.wsql.get_user_param("zone","number");return b?a.replace("%1",b):a.replace("%1/","")};this.rest_url=function(){var b=a(),e=$p.wsql.get_user_param("zone",
"number");return e?b.replace("%1",e):b.replace("%1/","")};this.irest_url=function(){var b=a(),e=$p.wsql.get_user_param("zone","number"),b=b.replace("odata/standard.odata","hs/rest");return e?b.replace("%1",e):b.replace("%1/","")}}
function WSQL(){var a=this,b={},c=0;a.exec=function(b,d,f,g){if(10>c)c++,setTimeout(function(){a.exec(b,d,f,g)},1E3);else{if(100>c)throw new TypeError("alasql init error");Array.isArray(d)||(d=[d]);try{f?alasql(b,d,function(a){f(a,g)}):alasql(b,d)}catch(h){f&&f(h)}}};a.promise=function(a,b){return new Promise(function(c,g){alasql(a,b||[],function(a,b){b?g(b):c(a)})})};a.set_user_param=function(a,c){return new Promise(function(f,g){var h=c;"object"==typeof c?h=JSON.stringify(c):!1===c&&(h="");"undefined"!==
typeof localStorage&&localStorage.setItem($p.job_prm.local_storage_prefix+a,h);b[a]=c;f()})};a.get_user_param=function(a,c){if(!b.hasOwnProperty(a)&&"undefined"!==typeof localStorage){var f;f=localStorage.getItem($p.job_prm.local_storage_prefix+a);if("object"==c)try{f=JSON.parse(f)}catch(g){f={}}else f="number"==c?$p.fix_number(f,!0):"date"==c?$p.fix_date(f,!0):"boolean"==c?$p.fix_boolean(f):f;b[a]=f}return b[a]};a.save_options=function(b,c){return a.set_user_param(b+"_"+c.name,c)};a.restore_options=
function(b,c){var f=a.get_user_param(b+"_"+c.name,"object"),g;for(g in f)if("object"!=typeof f[g])c[g]=f[g];else{c[g]||(c[g]={});for(var h in f[g])c[g][h]=f[g][h]}return c};a.init_params=function(){var b=[{p:"user_name",v:"",t:"string"},{p:"user_pwd",v:"",t:"string"},{p:"browser_uid",v:$p.generate_guid(),t:"string"},{p:"zone",v:$p.job_prm.hasOwnProperty("zone")?$p.job_prm.zone:1,t:"number"},{p:"enable_save_pwd",v:"",t:"boolean"},{p:"reset_local_data",v:"",t:"boolean"},{p:"autologin",v:"",t:"boolean"},
{p:"cache_cat_date",v:0,t:"number"},{p:"files_date",v:20151115E4,t:"number"},{p:"margin",v:60,t:"number"},{p:"discount",v:15,t:"number"},{p:"offline",v:$p.job_prm.offline||"",t:"boolean"},{p:"skin",v:"dhx_web",t:"string"},{p:"rest_path",v:"",t:"string"}],d;$p.job_prm.additional_params&&(b=b.concat($p.job_prm.additional_params));localStorage.getItem($p.job_prm.local_storage_prefix+"zone")||(d=$p.job_prm.hasOwnProperty("zone")?$p.job_prm.zone:1);$p.job_prm.url_prm.hasOwnProperty("zone")&&(d=$p.fix_number($p.job_prm.url_prm.zone,
!0));void 0!==d&&a.set_user_param("zone",d);b.forEach(function(b){(void 0==a.get_user_param(b.p,b.t)||!a.get_user_param(b.p,b.t)&&-1!=b.p.indexOf("url"))&&a.set_user_param(b.p,$p.job_prm.hasOwnProperty(b.p)?$p.job_prm[b.p]:b.v)});a.set_user_param("cache_cat_date",0);a.set_user_param("reset_local_data","");return new Promise(function(a,b){"undefined"!==typeof alasql?$p.job_prm.create_tables?$p.job_prm.create_tables_sql?alasql($p.job_prm.create_tables_sql,[],function(){c=1E3;delete $p.job_prm.create_tables_sql;
a()}):$p.ajax.get($p.job_prm.create_tables).then(function(b){alasql(b.response,[],function(){c=1E3;a()})}):a():a()})};a.drop_tables=function(a){function b(){g--;0>=g?setTimeout(a,10):c()}function c(){var a=h[g-1].tableid;"_"==a.substr(0,1)?b():alasql("drop table IF EXISTS "+a,[],b)}var g=0,h=[];alasql("SHOW TABLES",[],function(a){h=a;(g=a.length)?c():b()})};a.backup_database=function(a){};a.restore_database=function(){};a.idx_connect=function(b,c){return new Promise(function(f,g){var h=indexedDB.open(b,
1);h.onerror=function(a){g(a)};h.onsuccess=function(){f(h.result)};h.onupgradeneeded=function(f){f.currentTarget.result.createObjectStore(c,{keyPath:"ref"});return a.idx_connect(b,c)}})};a.idx_save=function(b,c,f){return new Promise(function(g,h){function k(a){var c=a.transaction([f],"readwrite").objectStore(f).put(b instanceof DataObj?b._obj:b);c.onerror=function(a){h(a)};c.onsuccess=function(){g(c.result)}}!f&&b._manager&&(f=b._manager.table_name);c?k(c):a.idx_connect(a.idx_name||$p.job_prm.local_storage_prefix||
"md",f).then(k)})};a.idx_get=function(b,c,f){return new Promise(function(g,h){function k(a){var c=a.transaction([f],"readonly").objectStore(f).get(b);c.onerror=function(a){h(a)};c.onsuccess=function(){g(c.result)}}c?k(c):a.idx_connect(a.idx_name||$p.job_prm.local_storage_prefix||"md",f).then(k)})};a.idx_delete=function(b,c,f){return new Promise(function(g,h){function k(a){var c=a.transaction([f],"readwrite").objectStore(f).delete(b instanceof DataObj?b.ref:b);c.onerror=function(a){h(a)};c.onsuccess=
function(){g(c.result)}}!f&&b._manager&&(f=b._manager.table_name);c?k(c):a.idx_connect(a.idx_name||$p.job_prm.local_storage_prefix||"md",f).then(k)})};"undefined"!==typeof alasql?a.aladb=new alasql.Database("md"):c=1E3}$p.wsql=new WSQL;var msg=$p.msg;$p.dateFormat.i18n={dayNames:"Вс Пн Вт Ср Чт Пт Сб Воскресенье Понедельник Вторник Среда Четверг Пятница Суббота".split(" "),monthNames:"Янв Фев Maр Aпр Maй Июн Июл Aвг Сен Окт Ноя Дек Январь Февраль Март Апрель Maй Июнь Июль Август Сентябрь Oктябрь Ноябрь Декабрь".split(" ")};
"undefined"!==typeof window&&"dhx4"in window&&(dhx4.dateFormat.ru="%d.%m.%Y",dhx4.dateLang="ru",dhx4.dateStrings={ru:{monthFullName:"Январь Февраль Март Апрель Maй Июнь Июль Август Сентябрь Oктябрь Ноябрь Декабрь".split(" "),monthShortName:"Янв Фев Maр Aпр Maй Июн Июл Aвг Сен Окт Ноя Дек".split(" "),dayFullName:"Воскресенье Понедельник Вторник Среда Четверг Пятница Суббота".split(" "),dayShortName:"Вс Пн Вт Ср Чт Пт Сб".split(" ")}});
$p.msg.russian_names=function(){$p.job_prm.russian_names&&(window.__define({"Метаданные":{get:function(){return _md},enumerable:!1},"Справочники":{get:function(){return _cat},enumerable:!1},"Документы":{get:function(){return _doc},enumerable:!1},"РегистрыСведений":{get:function(){return _ireg},enumerable:!1},"РегистрыНакопления":{get:function(){return _areg},enumerable:!1},"РегистрыБухгалтерии":{get:function(){return _a\u0441\u0441reg},enumerable:!1},"Обработки":{get:function(){return _dp},enumerable:!1},
"Отчеты":{get:function(){return _rep},enumerable:!1},"ОбластьКонтента":{get:function(){return $p.iface.docs},enumerable:!1},"Сообщить":{get:function(){return $p.msg.show_msg},enumerable:!1},"Истина":{value:!0,enumerable:!1},"Ложь":{value:!1,enumerable:!1}}),DataManager.prototype.__define({"ФормаВыбора":{get:function(){return this.form_selection},enumerable:!1},"ФормаОбъекта":{get:function(){return this.form_obj},enumerable:!1},"Найти":{get:function(){return this.find},enumerable:!1},"НайтиСтроки":{get:function(){return this.find_rows},
enumerable:!1},"НайтиПоНаименованию":{get:function(){return this.by_name},enumerable:!1}}),DataObj.prototype.__define({"ФормаОбъекта":{get:function(){return this.form_obj},enumerable:!1}}))};$p.fias=function(){};
(function(a){a.toString=function(){return"Коды адресного классификатора"};a.types=["владение","здание","помещение"];a["1010"]={name:"дом",type:1,order:1,fid:2,syn:[" д."," д "," дом"]};a["1020"]={name:"владение",type:1,order:2,fid:1,syn:" вл.; вл ; влад.; влад ; владен.; владен ; владение".split(";")};a["1030"]={name:"домовладение",type:1,order:3,fid:3};a["1050"]={name:"корпус",type:2,order:1,syn:[" к."," к "," корп."," корп ","корпус"]};a["1060"]={name:"строение",type:2,order:2,fid:1,syn:[" стр.",
" стр "," строен."," строен ","строение"]};a["1080"]={name:"литера",type:2,order:3,fid:3,syn:[" л."," л "," лит."," лит ","литера"]};a["1070"]={name:"сооружение",type:2,order:4,fid:2,syn:[" соор."," соор "," сооруж."," сооруж ","сооружение"]};a["1040"]={name:"участок",type:2,order:5,syn:[" уч."," уч ","участок"]};a["2010"]={name:"квартира",type:3,order:1,syn:"кв.;кв ;кварт.;кварт ;квартира;-".split(";")};a["2030"]={name:"офис",type:3,order:2,syn:["оф.","оф ","офис","-"]};a["2040"]={name:"бокс",type:3,
order:3};a["2020"]={name:"помещение",type:3,order:4};a["2050"]={name:"комната",type:3,order:5,syn:["комн.","комн ","комната"]};a["10100000"]={name:"Почтовый индекс"};a["10200000"]={name:"Адресная точка"};a["10300000"]={name:"Садовое товарищество"};a["10400000"]={name:"Элемент улично-дорожной сети, планировочной структуры дополнительного адресного элемента"};a["10500000"]={name:"Промышленная зона"};a["10600000"]={name:"Гаражно-строительный кооператив"};a["10700000"]={name:"Территория"}})($p.fias);
msg.store_url_od="https://chrome.google.com/webstore/detail/hcncallbdlondnoadgjomnhifopfaage";msg.align_node_right="Уравнять вертикально вправо";msg.align_node_bottom="Уравнять горизонтально вниз";msg.align_node_top="Уравнять горизонтально вверх";msg.align_node_left="Уравнять вертикально влево";msg.align_set_right="Установить размер сдвигом вправо";msg.align_set_bottom="Установить размер сдвигом вниз";msg.align_set_top="Установить размер сдвигом вверх";msg.align_set_left="Установить размер сдвигом влево";
msg.align_invalid_direction="Неприменимо для элемента с данной ориентацией";msg.argument_is_not_ref="Аргумент не является ссылкой";msg.addr_title="Ввод адреса";msg.cache_update_title="Обновление кеша браузера";msg.cache_update="Выполняется загрузка измененных файлов<br/>и их кеширование в хранилище браузера";msg.delivery_area_empty="Укажите район доставки";msg.empty_login_password="Не указаны имя пользователя или пароль";msg.empty_response="Пустой ответ сервера";msg.empty_geocoding="Пустой ответ геокодера. Вероятно, отслеживание адреса запрещено в настройках браузера";
msg.error_auth="Авторизация пользователя не выполнена";msg.error_critical="Критическая ошибка";msg.error_metadata="Ошибка загрузки метаданных конфигурации";msg.error_network="Ошибка сети или сервера - запрос отклонен";msg.error_rights="Ограничение доступа";msg.file_size="Запрещена загрузка файлов<br/>размером более ";msg.file_confirm_delete="Подтвердите удаление файла ";msg.file_new_date="Файлы на сервере обновлены<br /> Рекомендуется закрыть браузер и войти<br />повторно для применения обновления";
msg.file_new_date_title="Версия файлов";msg.init_catalogues="Загрузка справочников с сервера";msg.init_catalogues_meta=": Метаданные объектов";msg.init_catalogues_tables=": Реструктуризация таблиц";msg.init_catalogues_nom=": Базовые типы + номенклатура";msg.init_catalogues_sys=": Технологические справочники";msg.init_login="Укажите имя пользователя и пароль";msg.requery="Повторите попытку через 1-2 минуты";
msg.limit_query="Превышено число обращений к серверу<br/>Запросов за минуту:%1<br/>Лимит запросов:%2<br/>"+msg.requery;msg.long_operation="Длительная операция";msg.main_title="Окнософт: заказ дилера ";msg.meta_cat="Справочники";msg.meta_doc="Документы";msg.meta_cch="Планы видов характеристик";msg.meta_cacc="Планы счетов";msg.meta_ireg="Регистры сведений";msg.meta_areg="Регистры накопления";msg.meta_mgr="Менеджер";msg.meta_cat_mgr="Менеджер справочников";msg.meta_doc_mgr="Менеджер документов";
msg.meta_enn_mgr="Менеджер перечислений";msg.meta_ireg_mgr="Менеджер регистров сведений";msg.meta_areg_mgr="Менеджер регистров накопления";msg.meta_accreg_mgr="Менеджер регистров бухгалтерии";msg.meta_dp_mgr="Менеджер обработок";msg.meta_reports_mgr="Менеджер отчетов";msg.meta_charts_of_accounts_mgr="Менеджер планов счетов";msg.meta_charts_of_characteristic_mgr="Менеджер планов видов характеристик";msg.meta_extender="Модификаторы объектов и менеджеров";msg.no_metadata="Не найдены метаданные объекта '%1'";
msg.no_selected_row="Не выбрана строка табличной части '%1'";msg.no_dhtmlx="Библиотека dhtmlx не загружена";msg.not_implemented="Не реализовано в текущей версии";msg.offline_request="Запрос к серверу в автономном режиме";msg.onbeforeunload="Окнософт: легкий клиент. Закрыть программу?";msg.order_sent_title="Подтвердите отправку заказа";msg.order_sent_message="Отправленный заказ нельзя изменить.<br/>После проверки менеджером<br/>он будет запущен в работу";msg.request_title="Окнософт: Запрос регистрации";
msg.request_message="Заявка зарегистрирована. После обработки менеджером будет сформировано ответное письмо";msg.select_from_list="Выбор из списка";msg.select_grp="Укажите группу, а не элемент";msg.select_elm="Укажите элемент, а не группу";msg.select_file_import="Укажите файл для импорта";msg.srv_overload="Сервер перегружен";msg.sub_row_change_disabled="Текущая строка подчинена продукции.<br/>Строку нельзя изменить-удалить в документе<br/>только через построитель";msg.sync_script="Обновление скриптов приложения:";
msg.sync_data="Синхронизация с сервером выполняется:<br />* при первом старте программы<br /> * при обновлении метаданных<br /> * при изменении цен или технологических справочников";msg.sync_break="Прервать синхронизацию";msg.sync_no_data="Файл не содержит подходящих элементов для загрузки";msg.unsupported_browser_title="Браузер не поддерживается";msg.unsupported_browser="Несовместимая версия браузера<br/>Рекомендуется Google Chrome";msg.supported_browsers="Рекомендуется Chrome, Safari или Opera";
msg.unsupported_mode_title="Режим не поддерживается";msg.unsupported_mode="Программа не установлена<br/> в <a href='"+msg.store_url_od+"'>приложениях Google Chrome</a>";msg.unknown_error="Неизвестная ошибка в функции '%1'";msg.value="Значение";msg.bld_constructor="Конструктор объектов графического построителя";msg.bld_title="Графический построитель";msg.bld_empty_param="Не заполнен обязательный параметр <br />";msg.bld_not_product="В текущей строке нет изделия построителя";msg.bld_not_draw="Отсутствует эскиз или не указана система профилей";
msg.bld_wnd_title="Построитель изделия № ";msg.bld_from_blocks_title="Выбор типового блока";msg.bld_from_blocks="Текущее изделие будет заменено конфигурацией типового блока. Продолжить?";msg.bld_split_imp="В параметрах продукции<br />'%1'<br />запрещены незамкнутые контуры<br />Для включения деления импостом,<br />установите это свойство в 'Истина'";$p.is_data_obj=function(a){return a&&a instanceof DataObj};
$p.fetch_type=function(a,b){var c=a;b.is_ref?c=$p.fix_guid(a):b.date_part?c=$p.fix_date(a,!0):b.digits?c=$p.fix_number(a,!0):"boolean"==b.types[0]&&(c=$p.fix_boolean(a));return c};$p.is_equal=function(a,b){return a==b?!0:typeof a===typeof b?!1:$p.fix_guid(a,!1)==$p.fix_guid(b,!1)};
$p._find=function(a,b){var c,e,d;if("object"!=typeof b)for(e in a){c=a[e];for(var f in c)if("function"!==typeof c[f]&&$p.is_equal(c[f],b))return c}else for(e in a){c=a[e];d=!0;for(f in b)if("function"!==typeof c[f]&&!$p.is_equal(c[f],b[f])){d=!1;break}if(d)return c}};
$p._find_rows=function(a,b,c){var e,d,f,g,h=[],k,l=0;b&&(b._top?(k=b._top,delete b._top):k=300);for(f in a){d=a[f];e=!0;if(b)if("function"==typeof b)e=b(d);else for(g in b)if("_"!=g.substr(0,1))if("function"==typeof b[g]){if(e=b[g](d,g),!e)break}else if("or"==g&&Array.isArray(b[g])){if(e=b[g].some(function(a){var b=Object.keys(a)[0];return a[b].hasOwnProperty("like")?-1!=d[b].toLowerCase().indexOf(a[b].like.toLowerCase()):$p.is_equal(d[b],a[b])}),!e)break}else if(b[g].hasOwnProperty("like")){if(-1==
d[g].toLowerCase().indexOf(b[g].like.toLowerCase())){e=!1;break}}else if(b[g].hasOwnProperty("not")){if($p.is_equal(d[g],b[g].not)){e=!1;break}}else if(b[g].hasOwnProperty("in")){if(e=b[g].in.some(function(a){return $p.is_equal(a,d[g])}),!e)break}else if(!$p.is_equal(d[g],b[g])){e=!1;break}if(e){if(c){if(!1===c.call(this,d))break}else h.push(d);if(k&&(l++,l>=k))break}}return h};
function _load(a){function b(){if(c.cachable)return $p.wsql.promise(c.get_sql_struct(a),[]).then(function(b){return $p.iface.data_to_grid.call(c,b,a)})}var c=_md.mgr_by_class_name(a.class_name),e,d;if(d="get_tree"==a.action)e=c.cachable?$p.wsql.promise(c.get_sql_struct(a),[]).then($p.iface.data_to_tree):void 0,d=e;if(d)return e;"get_orders"==a.action&&(e=void 0);if("get_selection"==a.action&&(e=b()))return e;if($p.job_prm.offline)return Promise.reject(Error($p.msg.offline_request));a.browser_uid=
$p.wsql.get_user_param("browser_uid");return $p.ajax.post_ex($p.job_prm.hs_url(),JSON.stringify(a),!0).then(function(a){return a.response})}
var _cat=$p.cat=new function(){this.toString=function(){return $p.msg.meta_cat_mgr}},_enm=$p.enm=new function(){this.toString=function(){return $p.msg.meta_enn_mgr}},_doc=$p.doc=new function(){this.toString=function(){return $p.msg.meta_doc_mgr}},_ireg=$p.ireg=new function(){this.toString=function(){return $p.msg.meta_ireg_mgr}},_areg=$p.areg=new function(){this.toString=function(){return $p.msg.meta_areg_mgr}},_a\u0441\u0441reg=$p.a\u0441\u0441reg=new function(){this.toString=function(){return $p.msg.meta_accreg_mgr}},
_dp=$p.dp=new function(){this.toString=function(){return $p.msg.meta_dp_mgr}},_rep=$p.rep=new function(){this.toString=function(){return $p.msg.meta_reports_mgr}},_cacc=$p.cacc=new function(){this.toString=function(){return $p.msg.meta_charts_of_accounts_mgr}},_cch=$p.cch=new function(){this.toString=function(){return $p.msg.meta_charts_of_characteristic_mgr}},_md;
function Meta(a,b){function c(a){for(var b in a)for(var c in a[b]){e[b][c]||(e[b][c]={});for(var d in a[b][c])e[b][c][d]?"object"==typeof e[b][c][d]&&e[b][c][d]._mixin(a[b][c][d]):e[b][c][d]=a[b][c][d]}}var e=a instanceof XMLHttpRequest?JSON.parse(a.response):a,d;_md=$p.md=this;b&&c(b instanceof XMLHttpRequest?JSON.parse(b.response):b);a=null;b=require("log");"string"==typeof b&&(b=JSON.parse(b));c(b);b=null;this.get=function(a,b){var c=a.split("."),d={multiline_mode:!1,note:"",synonym:"",tooltip:"",
type:{is_ref:!1,types:["string"]}};if(!b)return e[c[0]][c[1]];"doc"==c[0]&&"number_doc"==b?(d.synonym="Номер",d.tooltip="Номер документа",d.type.str_len=11):"doc"==c[0]&&"date"==b?(d.synonym="Дата",d.tooltip="Дата документа",d.type.date_part="date_time",d.type.types[0]="date"):"doc"==c[0]&&"posted"==b?(d.synonym="Проведен",d.type.types[0]="boolean"):"cat"==c[0]&&"id"==b?d.synonym="Код":"cat"==c[0]&&"name"==b?d.synonym="Наименование":"deleted"==b?(d.synonym="Пометка удаления",d.type.types[0]="boolean"):
"is_folder"==b?(d.synonym="Это группа",d.type.types[0]="boolean"):"lc_changed"==b?(d.synonym="Изменено в 1С",d.tooltip="Время записи в 1С",d.type.types[0]="number",d.type.digits=15,d.type.fraction_figits=0):"ref"==b?(d.synonym="Ссылка",d.type.is_ref=!0,d.type.types[0]=a):d=b?e[c[0]][c[1]].fields[b]:e[c[0]][c[1]];return d};this.get_classes=function(){var a={},b;for(b in e){a[b]=[];for(var c in e[b])a[b].push(c)}return a};this.create_tables=function(a){function b(){var e=d[c-1],e=e["class"][e.name].get_sql_struct();
n+=e+";\n";c--;0==c?(a&&setTimeout(a,10),alasql.utils.saveFile("create_tables.sql",n)):b()}var c=0,d=[],e=this.get_classes(),m,n="USE md;\nCREATE TABLE IF NOT EXISTS refs (ref CHAR);\n";for(m in e.cat)d.push({"class":_cat,name:e.cat[m]});c=d.length;for(m in e.ireg)d.push({"class":_ireg,name:e.ireg[m]}),c++;for(m in e.doc)d.push({"class":_doc,name:e.doc[m]}),c++;for(m in e.enm)d.push({"class":_enm,name:e.enm[m]}),c++;for(m in e.cch)d.push({"class":_cch,name:e.cch[m]}),c++;for(m in e.cacc)d.push({"class":_cacc,
name:e.cacc[m]}),c++;$p.wsql.exec(n);b()};this.sql_type=function(a,b,c){return"type"==b&&"cch_properties"==a.table_name||"svg"==b&&"cat_production_params"==a.table_name?" JSON":c.is_ref||c.hasOwnProperty("str_len")?" CHAR":c.date_part?" Date":c.hasOwnProperty("digits")?0==c.fraction_figits?" INT":" FLOAT":-1!=c.types.indexOf("boolean")?" BOOLEAN":" CHAR"};this.sql_mask=function(a,b){return", "+(b?"_t_.":"")+("`"+a+"`")};this.mgr_by_class_name=function(a){if(a&&(a=a.split("."),a[1]&&$p[a[0]]))return $p[a[0]][a[1]]};
this.value_mgr=function(a,b,c,d,e){function m(a){a&&1==c.types.length&&(c._mgr=a);return a}var n,p,q;if(c._mgr)return c._mgr;if(1==c.types.length){if(p=c.types[0].split("."),1<p.length&&$p[p[0]])return m($p[p[0]][p[1]])}else if(e&&e.type&&(p=e.type.split("."),1<p.length&&$p[p[0]]))return m($p[p[0]][p[1]]);e=a.property||a.param;if("value"==b&&e){if(n=_cch.properties.get(e,!1),$p.is_data_obj(n)){if(n.is_new())return _cat.property_values;for(q in n.type.types)if(-1<n.type.types[q].indexOf(".")){p=n.type.types[q].split(".");
break}return p&&1<p.length&&$p[p[0]]?m($p[p[0]][p[1]]):n.type}}else{q=[];c.types.forEach(function(a){p=a.split(".");1<p.length&&$p[p[0]][p[1]]&&q.push($p[p[0]][p[1]])});if(1==q.length)return m(q[0]);if(d)return q;if((e=a[b])instanceof DataObj)return e._manager;if($p.is_guid(e)&&e!=$p.blank.guid)for(n in q)if(a=q[n],a.get(e,!1,!0))return a}};this.control_by_type=function(a){return a.is_ref?-1==a.types.join().indexOf("enm.")?"ocombo":"refc":a.date_part?"dhxCalendar":a.digits?5>a.fraction_figits?"calck":
"edn":"boolean"==a.types[0]?"ch":a.hasOwnProperty("str_len")&&(100<=a.str_len||0==a.str_len)?"txt":"ed"};this.ts_captions=function(a,b,c){c||(c={});var d=this.get(a).tabular_sections[b];a=this.get(a).form;var e=d.fields;if(a&&a.obj){if(!a.obj.tabular_sections[b])return;c._mixin(a.obj.tabular_sections[b])}else{"contact_information"===b&&(e={type:"",kind:"",presentation:""});c.fields=["row"];c.headers="№";c.widths="40";c.min_widths="";c.aligns="";c.sortings="na";c.types="cntr";for(var m in e)b=d.fields[m],
b.hide||(c.fields.push(m),c.headers+=","+(b.synonym?b.synonym.replace(/,/g," "):m),c.types+=","+this.control_by_type(b.type),c.sortings+=",na")}return!0};this.syns_js=function(a){var b={DeletionMark:"deleted",Description:"name",DataVersion:"data_version",IsFolder:"is_folder",Number:"number_doc",Date:"date","Дата":"date",Posted:"posted",Code:"id",Parent_Key:"parent",Owner_Key:"owner",Owner:"owner",Ref_Key:"ref","Ссылка":"ref",LineNumber:"row"};return b[a]?b[a]:e.syns_js[e.syns_1\u0441.indexOf(a)]||
a};this.syns_1\u0441=function(a){var b={deleted:"DeletionMark",name:"Description",data_version:"DataVersion",is_folder:"IsFolder",number_doc:"Number",date:"Date",posted:"Posted",id:"Code",ref:"Ref_Key",parent:"Parent_Key",owner:"Owner_Key",row:"LineNumber"};return b[a]?b[a]:e.syns_1\u0441[e.syns_js.indexOf(a)]||a};this.printing_plates=function(a){if(a)for(var b in a.doc)e.doc[b].printing_plates=a.doc[b]};for(d in e.enm)_enm[d]=new EnumManager(e.enm[d],"enm."+d);for(d in e.cat)_cat[d]=new CatManager("cat."+
d);for(d in e.doc)_doc[d]=new DocManager("doc."+d);for(d in e.ireg)_ireg[d]="$log"==d?new LogManager("ireg."+d):new InfoRegManager("ireg."+d);for(d in e.dp)_dp[d]=new DataProcessorsManager("dp."+d);for(d in e.cch)_cch[d]=new ChartOfCharacteristicManager("cch."+d);for(d in e.cacc)_cacc[d]=new ChartOfAccountManager("cacc."+d);$p.modifiers.execute($p);return{md_date:e.md_date,cat_date:e.cat_date}}$p.Meta=Meta;$p.record_log=function(a){$p.ireg&&$p.ireg.$log?$p.ireg.$log.record(a):console.log(a)};
_cat.load_soap_to_grid=function(a,b,c){function e(a){"{"==a.substr(0,1)&&(a=JSON.parse(a));"string"==typeof a?b.parse(a,function(){c&&c(a)},"xml"):c&&c(a)}b.xmlFileUrl="exec";var d=_md.mgr_by_class_name(a.class_name);!d.cachable&&($p.job_prm.rest||$p.job_prm.irest_enabled||a.rest)?d.rest_selection(a).then(e).catch($p.record_log):_load(a).then(e).catch($p.record_log)};
function DataManager(a){var b=_md.get(a),c,e=b.async_write,d={after_create:[],after_load:[],before_save:[],after_save:[],value_change:[]};c=-1!=a.indexOf("enm.")?!0:$p.job_prm.offline?!0:-1!=a.indexOf("doc.")||-1!=a.indexOf("dp.")||-1!=a.indexOf("rep.")?!1:!0;!$p.job_prm.offline&&b.hasOwnProperty("cachable")&&(c=b.cachable);this.__define({cachable:{value:c,writable:!0,enumerable:!1},async_write:{value:e,writable:!1,enumerable:!1},class_name:{value:a,writable:!1,enumerable:!1},alatable:{get:function(){return $p.wsql.aladb.tables[this.table_name]?
$p.wsql.aladb.tables[this.table_name].data:[]},enumerable:!1},metadata:{value:function(a){return a?b.fields[a]||b.tabular_sections[a]:b},enumerable:!1},attache_event:{value:function(a,b,c){d[a].push(b)},enumerable:!1},handle_event:{value:function(a,b,c){var e;d[b].forEach(function(b){!1!==e&&(e=b.call(a,c))});return e},enumerable:!1}});c=this._obj_\u0441onstructor||DataObj;if(!(this instanceof EnumManager))if(a=a.split(".")[1],this._obj_\u0441onstructor=eval("(function "+a.charAt(0).toUpperCase()+
a.substr(1)+"(attr, manager){manager._obj_сonstructor.superclass.constructor.call(this, attr, manager)})"),this._obj_\u0441onstructor._extend(c),this instanceof InfoRegManager){delete this._obj_\u0441onstructor.prototype.deleted;delete this._obj_\u0441onstructor.prototype.ref;delete this._obj_\u0441onstructor.prototype.lc_changed;for(var f in this.metadata().dimensions)this._obj_\u0441onstructor.prototype.__define(f,{get:new Function("return this._getter('"+f+"')"),set:new Function("v","this._setter('"+
f+"',v)"),enumerable:!0});for(f in this.metadata().resources)this._obj_\u0441onstructor.prototype.__define(f,{get:new Function("return this._getter('"+f+"')"),set:new Function("v","this._setter('"+f+"',v)"),enumerable:!0})}else{this._ts_\u0441onstructors={};for(f in this.metadata().fields)this._obj_\u0441onstructor.prototype.__define(f,{get:new Function("return this._getter('"+f+"')"),set:new Function("v","this._setter('"+f+"',v)"),enumerable:!0});for(f in this.metadata().tabular_sections){c=a.charAt(0).toUpperCase()+
a.substr(1)+f.charAt(0).toUpperCase()+f.substr(1)+"Row";this._ts_\u0441onstructors[f]=eval("(function "+c+"(owner) \r\n\t\t\t{owner._owner._manager._ts_сonstructors[owner._name].superclass.constructor.call(this, owner)})");this._ts_\u0441onstructors[f]._extend(TabularSectionRow);for(var g in this.metadata().tabular_sections[f].fields)this._ts_\u0441onstructors[f].prototype.__define(g,{get:new Function("return this._getter('"+g+"')"),set:new Function("v","this._setter('"+g+"',v)"),enumerable:!0});
this._obj_\u0441onstructor.prototype.__define(f,{get:new Function("return this._getter_ts('"+f+"')"),set:new Function("v","this._setter_ts('"+f+"',v)"),enumerable:!0})}}c=null}DataManager.prototype.__define("family_name",{get:function(){return $p.msg["meta_"+this.class_name.split(".")[0]+"_mgr"].replace($p.msg.meta_mgr+" ","")},enumerable:!1});DataManager.prototype.register_ex=function(){};
DataManager.prototype.sync_grid=function(a,b){!this.cachable&&($p.job_prm.rest||$p.job_prm.irest_enabled||b.rest)&&("get_tree"==b.action?this.rest_tree():"get_selection"==b.action&&this.rest_selection())};
DataManager.prototype.get_option_list=function(a,b){function c(b){$p.is_equal(b.value,a)&&(b.selected=!0);return b}var e=this,d=[],f,g,h;b.presentation&&(f=e.metadata().input_by_string)&&(g=b.presentation.like,delete b.presentation,b.or=[],f.forEach(function(a){h={};h[a]={like:g};b.or.push(h)}));if(e.cachable||b&&b._local)return e.find_rows(b,function(a){d.push(c({text:a.presentation,value:a.ref}))}),Promise.resolve(d);f={selection:b,top:b._top};delete b._top;e instanceof DocManager?f.fields=["ref",
"date","number_doc"]:e.metadata().main_presentation_name?f.fields=["ref","name"]:f.fields=["ref","id"];return _rest.load_array(f,e).then(function(a){a.forEach(function(a){d.push(c({text:e instanceof DocManager?a.number_doc+" от "+$p.dateFormat(a.date,$p.dateFormat.masks.ru):a.name||a.id,value:a.ref}))});return d})};DataManager.prototype.tabular_captions=function(a,b){};
DataManager.prototype.get_property_grid_xml=function(a,b,c){var e=this,d,f,g,h,k,l,m,n="<rows>",p=function(a,b){l=$p.is_data_obj(a)?a.presentation:a;b.type.is_ref||(b.type.date_part?l=$p.dateFormat(l,""):"boolean"==b.type.types[0]&&(l=l?"1":"0"))},q=function(a){k=_md.control_by_type(g.type);p(a,g)},t=function(a,d){if(d){var f=a.property||a.param||a["Параметр"],w=void 0!=a.value?a.value:a["Значение"];f.empty()?(m=d+"|empty",k="ro",l="",g={synonym:"?"}):(g={synonym:f.presentation,type:f.type},m=d+"|"+
f.ref,q(w),"edn"==k&&(k="calck"),f.mandatory&&(k+='" class="cell_mandatory'))}else if("object"===typeof a)g={synonym:a.synonym},m=a.id,k=a.type,l="",a.hasOwnProperty("txt")?l=a.txt:void 0!==(h=b[m])&&p(h,_md.get(e.class_name,m));else if(c&&c.meta&&void 0!==(g=c.meta[a]))m=a,q(h=b[a]);else if(void 0!==(h=b[a]))g=_md.get(e.class_name,m=a),q(h);else return;n+='<row id="'+m+'"><cell>'+(g.synonym||g.name)+'</cell><cell type="'+k+'">'+l+"</cell></row>"};if(!a)if(g=e.metadata(),g.form&&g.form.obj&&g.form.obj.head)a=
g.form.obj.head;else{a={" ":[]};b instanceof CatObj?(g.code_length&&a[" "].push("id"),g.main_presentation_name&&a[" "].push("name")):b instanceof DocObj&&(a[" "].push("number_doc"),a[" "].push("date"));if(!b.is_folder)for(d in g.fields)g.fields[d].hide||a[" "].push(d);g.tabular_sections.extra_fields&&(a["Дополнительные реквизиты"]=[])}for(d in a){" "!=d&&(n+='<row open="1"><cell>'+d+"</cell>");for(f in a[d])t(a[d][f]);c&&d==c.title&&b[c.ts]&&b[c.ts].find_rows(c.selection,function(a){t(a,c.ts)});" "!=
d&&(n+="</row>")}return n+="</rows>"};DataManager.prototype.__define("table_name",{get:function(){return this.class_name.replace(".","_")},enumerable:!1});
DataManager.prototype.print=function(a,b,c){function e(a){c&&c.progressOff&&c.progressOff();a&&a.focus()}c&&c.progressOn&&c.progressOn();var d={};$p.ajax.default_attr(d,$p.job_prm.irest_url());d.url+=this.rest_name+"(guid'"+$p.fix_guid(a)+"')/Print(model="+b+", browser_uid="+$p.wsql.get_user_param("browser_uid")+")";$p.ajax.get_and_show_blob(d.url,d,"get").then(e).catch($p.record_log);setTimeout(e,3E3)};
DataManager.prototype.printing_plates=function(){var a={},b=this;if($p.job_prm.offline)return Promise.resolve({});b.metadata().printing_plates&&(b._printing_plates=b.metadata().printing_plates);if(b._printing_plates)return Promise.resolve(b._printing_plates);$p.ajax.default_attr(a,$p.job_prm.irest_url());a.url+=b.rest_name+"/Print()";return $p.ajax.get_ex(a.url,a).then(function(a){b.__define("_printing_plates",{value:JSON.parse(a.response),enumerable:!1});return b._printing_plates}).catch(function(a){return{}})};
function RefDataManager(a){var b=this,c={};RefDataManager.superclass.constructor.call(b,a);b.push=function(a,b){b&&b!=a.ref?(delete c[a.ref],c[b]=a):c[a.ref]=a};b.all=function(){return c};b.each=function(a){for(var b in c)if(b&&b!=$p.blank.guid&&1==a.call(this,c[b]))break};b.get=function(a,d,f){var g=c[a]||c[a=$p.fix_guid(a)];if(!g){if(f)return;g=new b._obj_\u0441onstructor(a,b,!0)}return!1===d||void 0===d&&a===$p.blank.guid?g:!b.cachable||g.is_new()?g.load():d?Promise.resolve(g):g};b.create=function(a,
d){a&&"object"==typeof a||(a={});a.ref&&$p.is_guid(a.ref)&&!$p.is_empty_guid(a.ref)||(a.ref=$p.generate_guid());var f=c[a.ref];if(!f){f=new b._obj_\u0441onstructor(a,b);if(!b.cachable&&d){var g={};$p.ajax.default_attr(g,$p.job_prm.irest_url());g.url+=b.rest_name+"/Create()";return $p.ajax.get_ex(g.url,g).then(function(a){return f._mixin(JSON.parse(a.response),void 0,["ref"])})}if(d){var g=f._obj,h;for(h in b.metadata().fields)void 0==g[h]&&(g[h]="")}}return Promise.resolve(f)};b.delete_loc=function(a){var d;
delete c[a];for(var f in b.alatable)if(b.alatable[f].ref==a){d=f;break}void 0!=d&&b.alatable.splice(d,1)};b.find=function(a){return $p._find(c,a)};b.find_rows=function(a,d){return $p._find_rows.call(b,c,a,d)};b.save=function(a){return a&&(a.specify||$p.is_guid(a.ref)&&!b.cachable)?_load({class_name:b.class_name,action:a.action||"save",attr:a}).then(JSON.parse):Promise.reject()};b.load_array=function(a,d){var f,g;for(g in a)if(f=$p.fix_guid(a[g]),!(f=c[f]))new b._obj_\u0441onstructor(a[g],b);else if(f.is_new()||
d)f._mixin(a[g]),f._set_loaded()};b.predefined=function(a){return(a=b.metadata().predefined[a])?b.get(a.ref):void 0};b.first_folder=function(a){for(var d in c){var f=c[d];if(f.is_folder&&(!a||$p.is_equal(a,f.owner)))return f}return b.get()}}RefDataManager._extend(DataManager);
RefDataManager.prototype.get_sql_struct=function(a){function b(){function b(){var a=[],c="_t_.ref, _t_.`deleted`";f.form&&f.form.selection?f.form.selection.fields.forEach(function(b){a.push(b)}):d instanceof DocManager?(a.push("posted"),a.push("date"),a.push("number_doc")):(f.hierarchical&&f.group_hierarchy?a.push("is_folder"):a.push("0 as is_folder"),d instanceof ChartOfAccountManager?(a.push("id"),a.push("name as presentation")):f.main_presentation_name?a.push("name as presentation"):f.code_length?
a.push("id as presentation"):a.push("'...' as presentation"),f.has_owners&&a.push("owner"),f.code_length&&a.push("id"));a.forEach(function(a){c=-1!=a.indexOf(" as ")?c+(", "+a):c+_md.sql_mask(a,!0)});return c}function c(){var a="",b;if(f.form&&f.form.selection)for(var d in f.form.selection.fields)-1!=f.form.selection.fields[d].indexOf(" as ")&&-1==f.form.selection.fields[d].indexOf("_t_.")&&(b=f.form.selection.fields[d].split(" as "),b[0]=b[0].split("."),1<b[0].length&&(a&&(a+="\n"),a+="left outer join "+
b[0][0]+" on "+b[0][0]+".ref = _t_."+b[1]));return a}var e=!a.parent,g=a.parent||$p.blank.guid,h,k=a.initial_value||$p.blank.guid,r=a.filter||"",u=$p.blank.guid;(function(){function b(c){c?(g=u=a.set_parent=c.parent.ref,e=!1):(r||e)&&"cat.base_blocks"==d.class_name&&(h==$p.blank.guid&&(h=_cat.bases.predefined("main")),g=d.first_folder(h).ref);r&&-1==r.indexOf("%")&&(r="%"+r+"%")}f.has_owners&&(h=a.owner,a.selection&&"function"!=typeof a.selection&&a.selection.forEach(function(a){a.owner&&(h="object"==
typeof a.owner?a.owner.valueOf():a.owner,delete a.owner)}),h||(h=$p.blank.guid));k!=$p.blank.guid&&e?f.hierarchical?b(d.get(k,!1)):b():b()})();return(d.sql_selection_list_flds?d.sql_selection_list_flds(k):("SELECT %2, case when _t_.ref = '"+k+"' then 0 else 1 end as is_initial_value FROM `"+d.table_name+"` AS _t_ %j %3 %4 LIMIT 300").replace("%2",b()).replace("%j",c())).replace("%3",function(){var b;b=d instanceof ChartOfAccountManager?" WHERE ("+(r?0:1):f.hierarchical?f.has_owners?" WHERE ("+(e||
r?1:0)+" OR _t_.parent = '"+g+"') AND ("+(h==$p.blank.guid?1:0)+" OR _t_.owner = '"+h+"') AND ("+(r?0:1):" WHERE ("+(e||r?1:0)+" OR _t_.parent = '"+g+"') AND ("+(r?0:1):f.has_owners?" WHERE ("+(h==$p.blank.guid?1:0)+" OR _t_.owner = '"+h+"') AND ("+(r?0:1):" WHERE ("+(r?0:1);if(d.sql_selection_where_flds)b+=d.sql_selection_where_flds(r);else if(d instanceof DocManager)b+=" OR _t_.number_doc LIKE '"+r+"'";else{if(f.main_presentation_name||d instanceof ChartOfAccountManager)b+=" OR _t_.name LIKE '"+
r+"'";f.code_length&&(b+=" OR _t_.id LIKE '"+r+"'")}b+=") AND (_t_.ref != '"+$p.blank.guid+"')";a.selection&&"function"!=typeof a.selection&&a.selection.forEach(function(a){for(var c in a)"function"==typeof a[c]?b+="\n AND "+a[c](d,c)+" ":f.fields.hasOwnProperty(c)&&(b=!0===a[c]?b+("\n AND _t_."+c+" "):!1===a[c]?b+("\n AND (not _t_."+c+") "):"string"==typeof a[c]||"object"==typeof a[c]?b+("\n AND (_t_."+c+" = '"+a[c]+"') "):b+("\n AND (_t_."+c+" = "+a[c]+") "))});return b}()).replace("%4",d instanceof
ChartOfAccountManager?"ORDER BY id":f.hierarchical?f.group_hierarchy?"ORDER BY _t_.is_folder desc, is_initial_value, presentation":"ORDER BY _t_.parent desc, is_initial_value, presentation":"ORDER BY is_initial_value, presentation")}function c(){var a="CREATE TABLE IF NOT EXISTS `"+d.table_name+"` (ref CHAR PRIMARY KEY NOT NULL, `deleted` BOOLEAN, lc_changed INT",a=d instanceof DocManager?a+", posted BOOLEAN, date Date, number_doc CHAR":a+", id CHAR, name CHAR, is_folder BOOLEAN";for(h in f.fields)a+=
_md.sql_mask(h)+_md.sql_type(d,h,f.fields[h].type);for(h in f.tabular_sections)a+=", `ts_"+h+"` JSON";return a+")"}function e(){var a=["ref","deleted","lc_changed"],b="INSERT INTO `"+d.table_name+"` (ref, `deleted`, lc_changed",c="(?";"cat"==d.class_name.substr(0,3)?(b+=", id, name, is_folder",a.push("id"),a.push("name"),a.push("is_folder")):"doc"==d.class_name.substr(0,3)&&(b+=", posted, date, number_doc",a.push("posted"),a.push("date"),a.push("number_doc"));for(h in f.fields)b+=_md.sql_mask(h),
a.push(h);for(h in f.tabular_sections)b+=", `ts_"+h+"`",a.push("ts_"+h);for(h=1;h<a.length;h++)c+=", ?";c+=")";b=b+") VALUES "+c;return{sql:b,fields:a,values:c}}var d=this,f=d.metadata(),g={},h,k=a&&a.action?a.action:"create_table";"create_table"==k?g=c():-1!=["insert","update","replace"].indexOf(k)?g[d.table_name]=e():"select"==k?g="SELECT * FROM `"+d.table_name+"` WHERE ref = ?":"select_all"==k?g="SELECT * FROM `"+d.table_name+"`":"delete"==k?g="DELETE FROM `"+d.table_name+"` WHERE ref = ?":"drop"==
k?g="DROP TABLE IF EXISTS `"+d.table_name+"`":"get_tree"==k?g=!a.filter||a.filter.is_folder?"SELECT ref, parent, name as presentation FROM `"+d.table_name+"` WHERE is_folder order by parent, name":"SELECT ref, parent, name as presentation FROM `"+d.table_name+"` order by parent, name":"get_selection"==k&&(g=b());return g};
RefDataManager.prototype.caption_flds=function(a){function b(a,b,c,d,e,f){this.id=a;this.width=b;this.type=c;this.align=d;this.sort=e;this.caption=f}var c=[],e=this.metadata(),d="";e.form&&e.form.selection?c=e.form.selection.cols:this instanceof DocManager?(c.push(new b("date","120","ro","left","server","Дата")),c.push(new b("number_doc","120","ro","left","server","Номер"))):(this instanceof ChartOfAccountManager&&c.push(new b("id","120","ro","left","server","Код")),c.push(new b("presentation","*",
"ro","left","server","Наименование")));if(a.get_header&&c.length){var d="<head>",f;for(f in c)d+='<column id="%1" width="%2" type="%3" align="%4" sort="%5">%6</column>'.replace("%1",c[f].id).replace("%2",c[f].width).replace("%3",c[f].type).replace("%4",c[f].align).replace("%5",c[f].sort).replace("%6",c[f].caption);d+="</head>"}return{head:d,acols:c}};
RefDataManager.prototype.load_cached_server_array=function(a,b){var c=[],e,d=this,f=b?{class_name:d.class_name,rest_name:b}:d,g=!b;a.forEach(function(a){e=d.get(a.ref||a,!1,!0);(!e||g&&e.is_new())&&c.push(a.ref||a)});if(c.length){var h={url:"",selection:{ref:{in:c}}};g&&(h.fields=["ref"]);$p.rest.build_select(h,f);dhx4.isIE&&(h.url=encodeURI(h.url));return $p.ajax.get_ex(h.url,h).then(function(b){b=JSON.parse(b.response);if(g)b=b.value;else{b=b.data;for(var c in b)!b[c].ref&&b[c].id&&(b[c].ref=b[c].id),
b[c].\u041a\u043e\u0434&&(b[c].id=b[c].\u041a\u043e\u0434,delete b[c].\u041a\u043e\u0434),b[c]._not_set_loaded=!0}d.load_array(b);return a})}return Promise.resolve(a)};function DataProcessorsManager(a){DataProcessorsManager.superclass.constructor.call(this,a);this.create=function(){return new this._obj_\u0441onstructor({},this)}}DataProcessorsManager._extend(DataManager);
function EnumManager(a,b){EnumManager.superclass.constructor.call(this,b);this._obj_\u0441onstructor=EnumObj;this.push=function(a,b){this.__define(b,{value:a,enumerable:!1})};this.get=function(a){if(a instanceof EnumObj)return a;a&&a!=$p.blank.guid||(a="_");var b=this[a];b||(b=new EnumObj({name:a},this));return b};this.each=function(a){this.alatable.forEach(function(b){b.ref&&b.ref!=$p.blank.guid&&a.call(this[b.ref])})};for(var c in a)new EnumObj(a[c],this)}EnumManager._extend(RefDataManager);
EnumManager.prototype.get_sql_struct=function(a){var b;a=a&&a.action?a.action:"create_table";"create_table"==a?b="CREATE TABLE IF NOT EXISTS `"+this.table_name+"` (ref CHAR PRIMARY KEY NOT NULL, sequence INT, synonym CHAR)":-1!=["insert","update","replace"].indexOf(a)?(b={},b[this.table_name]={sql:"INSERT INTO `"+this.table_name+"` (ref, sequence, synonym) VALUES (?, ?, ?)",fields:["ref","sequence","synonym"],values:"(?, ?, ?)"}):"delete"==a&&(b="DELETE FROM `"+this.table_name+"` WHERE ref = ?");
return b};EnumManager.prototype.get_option_list=function(a,b){function c(b){$p.is_equal(b.value,a)&&(b.selected=!0);return b}var e=[],d="";if(b)for(var f in b)"_"!=f.substr(0,1)&&(d=b[f]);"object"==typeof d&&(d=d.like?d.like:"");d=d.toLowerCase();this.alatable.forEach(function(a){(!d||a.synonym&&-1!=a.synonym.toLowerCase().indexOf(d))&&e.push(c({text:a.synonym||"",value:a.ref}))});return Promise.resolve(e)};
function RegisterManager(a){var b={};this._obj_\u0441onstructor=RegisterRow;RegisterManager.superclass.constructor.call(this,a);this.push=function(a,e){e&&e!=a.ref?(delete b[a.ref],b[e]=a):b[a.ref]=a};this.get=function(a,e,d){a||(a={});a.action="select";var f=alasql(this.get_sql_struct(a),a._values),g;delete a.action;delete a._values;if(f.length)if(d)g=b[this.get_ref(f[0])];else{g=[];for(var h in f)g.push(b[this.get_ref(f[h])])}return e?Promise.resolve(g):g};this.load_array=function(a){var e,d,f=
[],g;for(g in a)e=this.get_ref(a[g]),(d=b[e])?d._mixin(a[g]):new this._obj_\u0441onstructor(a[g],this),f.push(b[e]);return f};this.find_rows=function(a,b){return $p._find_rows.call(this,this.alatable,a,b)}}RegisterManager._extend(DataManager);
RegisterManager.prototype.get_sql_struct=function(a){function b(){var a="CREATE TABLE IF NOT EXISTS `"+d.table_name+"` (",b=!0;for(h in f.dimensions)b?(a+="`"+h+"`",b=!1):a+=_md.sql_mask(h),a+=_md.sql_type(d,h,f.dimensions[h].type);for(h in f.resources)a+=_md.sql_mask(h)+_md.sql_type(d,h,f.resources[h].type);a+=", PRIMARY KEY (";b=!0;for(h in f.dimensions)b?(a+="`"+h+"`",b=!1):a+=_md.sql_mask(h);return a+"))"}function c(){var a="INSERT OR REPLACE INTO `"+d.table_name+"` (",b=[],c=!0;for(h in f.dimensions)c?
(a+=h,c=!1):a+=", "+h,b.push(h);for(h in f.resources)a+=", "+h,b.push(h);a+=") VALUES (?";for(h=1;h<b.length;h++)a+=", ?";return{sql:a+")",fields:b}}function e(){var b="SELECT * FROM `"+d.table_name+"` WHERE ",c=!0;a._values=[];for(var e in a)"action"!=e&&"_values"!=e&&(c?c=!1:b+=" and ",b+="`"+e+"`=?",a._values.push(a[e]));c&&(b+="1");return b}var d=this,f=d.metadata(),g={},h,k=a&&a.action?a.action:"create_table";"create_table"==k?g=b():k in{insert:"",update:"",replace:""}?g[d.table_name]=c():"select"==
k?g=e():"select_all"==k?g=e():"delete"==k?g="DELETE FROM `"+d.table_name+"` WHERE ref = ?":"drop"==k&&(g="DROP TABLE IF EXISTS `"+d.table_name+"`");return g};RegisterManager.prototype.get_ref=function(a){var b="",c=this.metadata().dimensions;a instanceof RegisterRow&&(a=a._obj);for(var e in c)b+=b?"_":"",b=c[e].type.is_ref?b+$p.fix_guid(a[e]):!a[e]&&c[e].type.digits?b+"0":c[e].date_part?b+$p.dateFormat(a[e]||$p.blank.date,$p.dateFormat.masks.atom):void 0!=a[e]?b+String(a[e]):b+"$";return b};
function InfoRegManager(a){InfoRegManager.superclass.constructor.call(this,a)}InfoRegManager._extend(RegisterManager);InfoRegManager.prototype.slice_first=function(a){};InfoRegManager.prototype.slice_last=function(a){};
function LogManager(){LogManager.superclass.constructor.call(this,"ireg.$log");var a;this.record=function(b){b instanceof Error&&(console&&console.log(b),b={class:"error",note:b.toString()});"object"!=typeof b&&(b={note:b});b.date=Date.now()+$p.eve.time_diff();a||(a=alasql.compile("select MAX(`sequence`) as `sequence` from `ireg_$log` where `date` = ?"));var c=a([b.date]);b.sequence=c.length&&void 0!==c[0].sequence?c[0].sequence+1:0;b.class||(b.class="note");alasql("insert into `ireg_$log` (`date`, `sequence`, `class`, `note`, `obj`) values (?, ?, ?, ?, ?)",
[b.date,b.sequence,b.class,b.note,b.obj?JSON.stringify(b.obj):""])};this.backup=function(a,c){};this.restore=function(a,c){};this.clear=function(a,c){};this.show=function(a){};this.get_sql_struct=function(a){if(a&&"get_selection"==a.action){var c="select * from `ireg_$log`";a.date_from?c=a.date_till?c+" where `date` >= ? and `date` <= ?":c+" where `date` >= ?":a.date_till&&(c+=" where `date` <= ?");return c}return LogManager.superclass.get_sql_struct.call(this,a)};this.caption_flds=function(a){function c(a,
b,c,d,e,f){this.id=a;this.width=b;this.type=c;this.align=d;this.sort=e;this.caption=f}var e=[];this.metadata();var d="";e.push(new c("date","140","ro","left","server","Дата"));e.push(new c("class","100","ro","left","server","Класс"));e.push(new c("note","*","ro","left","server","Событие"));if(a.get_header){var d="<head>",f;for(f in e)d+='<column id="%1" width="%2" type="%3" align="%4" sort="%5">%6</column>'.replace("%1",e[f].id).replace("%2",e[f].width).replace("%3",e[f].type).replace("%4",e[f].align).replace("%5",
e[f].sort).replace("%6",e[f].caption);d+="</head>"}return{head:d,acols:e}};this.data_to_grid=function(a,c){var e="<?xml version='1.0' encoding='UTF-8'?><rows total_count='%1' pos='%2' set_parent='%3'>".replace("%1",a.length).replace("%2",c.start).replace("%3",c.set_parent||""),d=this.caption_flds(c),f=$p.eve.time_diff(),e=e+d.head;a.forEach(function(a){e+='<row id="'+a.date+"_"+a.sequence+'"><cell>'+$p.dateFormat(a.date-f,$p.dateFormat.masks.date_time)+(a.sequence?"."+a.sequence:"")+"</cell><cell>"+
a.class+"</cell><cell>"+a.note+"</cell></row>"});return e+"</rows>"}}LogManager._extend(InfoRegManager);function AccumRegManager(a){AccumRegManager.superclass.constructor.call(this,a)}AccumRegManager._extend(RegisterManager);
function CatManager(a){this._obj_\u0441onstructor=CatObj;CatManager.superclass.constructor.call(this,a);this.metadata().hierarchical&&this.metadata().group_hierarchy&&this._obj_\u0441onstructor.prototype.__define("is_folder",{get:function(){return this._obj.is_folder||!1},set:function(a){this._obj.is_folder=$p.fix_boolean(a)},enumerable:!0})}CatManager._extend(RefDataManager);CatManager.prototype.by_name=function(a){var b;this.find_rows({name:a},function(a){b=a;return!1});b||(b=this.get());return b};
CatManager.prototype.by_id=function(a){var b;this.find_rows({id:a},function(a){b=a;return!1});b||(b=this.get());return b};CatManager.prototype.path=function(a){var b=[];(a=a instanceof DataObj?a:this.get(a,!1,!0))&&b.push({ref:a.ref,presentation:a.presentation});if(a&&this.metadata().hierarchical)for(;;){a=a.parent;if(a.empty())break;b.push({ref:a.ref,presentation:a.presentation})}return b};
function ChartOfCharacteristicManager(a){this._obj_\u0441onstructor=CatObj;ChartOfCharacteristicManager.superclass.constructor.call(this,a)}ChartOfCharacteristicManager._extend(CatManager);function ChartOfAccountManager(a){this._obj_\u0441onstructor=CatObj;ChartOfAccountManager.superclass.constructor.call(this,a)}ChartOfAccountManager._extend(CatManager);function DocManager(a){this._obj_\u0441onstructor=DocObj;DocManager.superclass.constructor.call(this,a)}DocManager._extend(RefDataManager);
function TabularSection(a,b){b._obj[a]||(b._obj[a]=[]);this.__define("_name",{value:a,enumerable:!1});this.__define("_owner",{value:b,enumerable:!1});this.__define("_obj",{value:b._obj[a],writable:!1,enumerable:!1})}TabularSection.prototype.toString=function(){return"Табличная часть "+this._owner._manager.class_name+"."+this._name};TabularSection.prototype.get=function(a){return this._obj[a]._row};TabularSection.prototype.count=function(){return this._obj.length};
TabularSection.prototype.clear=function(a){for(var b in this._obj)delete this._obj[b];this._obj.length=0;a||Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name})};
TabularSection.prototype.del=function(a){var b,c=this._obj,e=0;if("undefined"!=typeof a){if("number"==typeof a)b=a;else if(c[a.row-1]._row===a)b=a.row-1;else for(var d in c)if(c[d]._row===a){b=Number(d);delete c[d]._row;break}if(void 0!=b){c.splice(b,1);for(d in c)e++,c[d].row=e;Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name})}}};TabularSection.prototype.find=function(a){if(a=$p._find(this._obj,a))return a._row};
TabularSection.prototype.find_rows=function(a,b){var c=this;return $p._find_rows.call(c,c._obj,a,b?function(a){return b.call(c,a._row)}:null)};TabularSection.prototype.swap=function(a,b){var c=this._obj[a];this._obj[a]=this._obj[b];this._obj[b]=c;Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name})};
TabularSection.prototype.add=function(a,b){var c=new this._owner._manager._ts_\u0441onstructors[this._name](this);a||(a={});for(var e in c._metadata.fields)c[e]=a[e]||"";c._obj.row=this._obj.push(c._obj);c._obj.__define("_row",{value:c,enumerable:!1});b||Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name});return c};TabularSection.prototype.each=function(a){var b=this;b._obj.forEach(function(c){return a.call(b,c._row)})};
TabularSection.prototype.load=function(a){var b=this,c;b.clear(!0);a instanceof TabularSection?c=a._obj:Array.isArray(a)&&(c=a);c&&c.forEach(function(a){b.add(a,!0)});Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name})};
TabularSection.prototype.sync_grid=function(a,b){for(var c={rows:[]},e=[],d=0;d<a.getColumnCount();d++)e.push(a.getColumnId(d));a.clearAll();this.find_rows(b,function(a){var b=[];e.forEach(function(c){$p.is_data_obj(a[c])?b.push(a[c].presentation):b.push(a[c])});c.rows.push({id:a.row,data:b})});try{a.parse(c,"json")}catch(f){}a.callEvent("onGridReconstructed",[])};TabularSection.prototype.toJSON=function(){return this._obj};
function TabularSectionRow(a){this.__define("_owner",{value:a,enumerable:!1});this.__define("_obj",{value:{},writable:!1,enumerable:!1})}TabularSectionRow.prototype.__define("_metadata",{get:function(){return this._owner._owner._metadata.tabular_sections[this._owner._name]},enumerable:!1});TabularSectionRow.prototype.__define("row",{get:function(){return this._obj.row||0},enumerable:!0});
TabularSectionRow.prototype.__define("_clone",{value:function(){return(new this._owner._owner._manager._ts_\u0441onstructors[this._owner._name](this._owner))._mixin(this._obj)},enumerable:!1});TabularSectionRow.prototype._getter=DataObj.prototype._getter;TabularSectionRow.prototype._setter=function(a,b){this._obj[a]!=b&&(Object.getNotifier(this._owner._owner).notify({type:"row",row:this,tabular:this._owner._name,name:a,oldValue:this._obj[a]}),DataObj.prototype.__setter.call(this,a,b))};
function DataObj(a,b){var c,e={},d={data_version:""},f=!(this instanceof EnumObj);b instanceof DataProcessorsManager||b instanceof EnumManager||(c=b.get(a,!1,!0));if(c)return c;b instanceof EnumManager?d.ref=c=a.name:b instanceof RegisterManager?c=b.get_ref(a):(d.ref=c=$p.fix_guid(a),d.deleted=!1,d.lc_changed=0);this.__define("_manager",{value:b,enumerable:!1});this.__define("is_new",{value:function(){return f},enumerable:!1});this.__define("_set_loaded",{value:function(a){f=!1;b.push(this,a)},enumerable:!1});
this.__define("_obj",{value:d,writable:!1,enumerable:!1});this.__define("_ts_",{value:function(a){e[a]||(e[a]=new TabularSection(a,this));return e[a]},enumerable:!1});b.alatable&&b.push&&(b.alatable.push(d),b.push(this,c))}DataObj.prototype.valueOf=function(){return this.ref};DataObj.prototype.toJSON=function(){return this._obj};
DataObj.prototype._getter=function(a){var b=this._metadata.fields[a].type,c;if("type"==a&&"object"==typeof this._obj[a]||"ref"==a)return this._obj[a];if(b.is_ref){if(c=_md.value_mgr(this._obj,a,b))return c instanceof DataManager?c.get(this._obj[a],!1):$p.fetch_type(this._obj[a],c);if(this._obj[a])return console.log([a,b,this._obj]),null}else return b.date_part?$p.fix_date(this._obj[a],!0):b.digits?$p.fix_number(this._obj[a],!0):"boolean"==b.types[0]?$p.fix_boolean(this._obj[a]):this._obj[a]||""};
DataObj.prototype.__setter=function(a,b){var c=this._metadata.fields[a].type;"type"==a&&b.types?this._obj[a]=b:"ref"==a?this._obj[a]=$p.fix_guid(b):c.is_ref?(this._obj[a]=$p.fix_guid(b),(c=_md.value_mgr(this._obj,a,c,!1,b))?c instanceof EnumManager?"string"==typeof b?this._obj[a]=b:b?"object"==typeof b&&(this._obj[a]=b.ref||b.name||""):this._obj[a]="":b&&b.presentation?(!b.type||b instanceof DataObj||delete b.type,c.create(b)):c instanceof DataManager||(this._obj[a]=$p.fetch_type(b,c)):"object"!=
typeof b&&(this._obj[a]=b)):this._obj[a]=c.date_part?$p.fix_date(b,!0):c.digits?$p.fix_number(b,!0):"boolean"==c.types[0]?$p.fix_boolean(b):b};DataObj.prototype.__notify=function(a){Object.getNotifier(this).notify({type:"update",name:a,oldValue:this._obj[a]})};DataObj.prototype._setter=function(a,b){this._obj[a]!=b&&(this.__notify(a),this.__setter(a,b))};DataObj.prototype._getter_ts=function(a){return this._ts_(a)};
DataObj.prototype._setter_ts=function(a,b){var c=this._ts_(a);c instanceof TabularSection&&Array.isArray(b)&&c.load(b)};
DataObj.prototype.load=function(){function a(a){"string"==typeof a&&(a=JSON.parse(a));if(!$p.msg.check_soap_result(a)){var e=$p.fix_guid(a);b.is_new()&&!$p.is_empty_guid(e)&&b._set_loaded(e);return b._mixin(a)}}var b=this;return b._manager.cachable&&!b.is_new()?Promise.resolve(b):b.ref==$p.blank.guid?(b instanceof CatObj?b.id="000000000":b.number_doc="000000000",Promise.resolve(b)):$p.job_prm.rest||$p.job_prm.irest_enabled?_rest.load_obj(b):_load({class_name:b._manager.class_name,action:"load",ref:b.ref}).then(a)};
DataObj.prototype.save=function(a,b){if(!1===this._manager.handle_event(this,"before_save"))return Promise.resolve(this);this instanceof DocObj&&$p.blank.date==this.date&&(this.date=new Date);return($p.job_prm.offline?function(a){return Promise.resolve(a)}:$p.job_prm.irest_enabled?_rest.save_irest:_rest.save_rest)(this,{post:a,operational:b}).then(function(a){return a._manager.handle_event(a,"after_save")})};DataObj.prototype.empty=function(){return $p.is_empty_guid(this._obj.ref)};
DataObj.prototype.__define("_metadata",{get:function(){return this._manager.metadata()},enumerable:!1});DataObj.prototype.__define("ref",{get:function(){return this._obj.ref},set:function(a){this._obj.ref=$p.fix_guid(a)},enumerable:!0,configurable:!0});DataObj.prototype.__define("deleted",{get:function(){return this._obj.deleted},set:function(a){this.__notify("deleted");this._obj.deleted=!!a},enumerable:!0,configurable:!0});
DataObj.prototype.__define("data_version",{get:function(){return this._obj.data_version||""},set:function(a){this.__notify("data_version");this._obj.data_version=String(a)},enumerable:!0});DataObj.prototype.__define("lc_changed",{get:function(){return this._obj.lc_changed||0},set:function(a){this.__notify("lc_changed");this._obj.lc_changed=$p.fix_number(a,!0)},enumerable:!0,configurable:!0});
function CatObj(a,b){var c="";CatObj.superclass.constructor.call(this,a,b);this.__define("presentation",{get:function(){return this.name||this.id?this.name||this.id||this._metadata.obj_presentation:c},set:function(a){a&&(c=String(a))},enumerable:!1});a&&"object"==typeof a&&(a._not_set_loaded?(delete a._not_set_loaded,this._mixin(a)):(this._mixin(a),$p.is_empty_guid(this.ref)||!a.id&&!a.name||this._set_loaded(this.ref)))}CatObj._extend(DataObj);
CatObj.prototype.__define("id",{get:function(){return this._obj.id||""},set:function(a){this.__notify("id");this._obj.id=a},enumerable:!0});CatObj.prototype.__define("name",{get:function(){return this._obj.name||""},set:function(a){this.__notify("name");this._obj.name=String(a)},enumerable:!0});
function DocObj(a,b){var c="";DocObj.superclass.constructor.call(this,a,b);this.__define("presentation",{get:function(){return this.number_str||this.number_doc?this._metadata.obj_presentation+" №"+(this.number_str||this.number_doc)+" от "+$p.dateFormat(this.date,$p.dateFormat.masks.ru):c},set:function(a){a&&(c=String(a))},enumerable:!1});a&&"object"==typeof a&&this._mixin(a);!$p.is_empty_guid(this.ref)&&a.number_doc&&this._set_loaded(this.ref)}DocObj._extend(DataObj);
DocObj.prototype.__define("number_doc",{get:function(){return this._obj.number_doc||""},set:function(a){this.__notify("number_doc");this._obj.number_doc=a},enumerable:!0});DocObj.prototype.__define("date",{get:function(){return this._obj.date||$p.blank.date},set:function(a){this.__notify("date");this._obj.date=$p.fix_date(a,!0)},enumerable:!0});
DocObj.prototype.__define("posted",{get:function(){return this._obj.posted||!1},set:function(a){this.__notify("posted");this._obj.posted=$p.fix_boolean(a)},enumerable:!0});
function DataProcessorObj(a,b){DataProcessorObj.superclass.constructor.call(this,a,b);var c,e=b.metadata();for(c in e.fields)a[c]=$p.fetch_type("",e.fields[c].type);for(c in e.tabular_sections)a[c]=[];this._mixin(a);this.unload=function(){for(c in this)this[c]instanceof TabularSection?(this[c].clear(),delete this[c]):"function"!=typeof this[c]&&delete this[c]}}DataProcessorObj._extend(DataObj);
function EnumObj(a,b){EnumObj.superclass.constructor.call(this,a,b);a&&"object"==typeof a&&this._mixin(a)}EnumObj._extend(DataObj);EnumObj.prototype.__define("order",{get:function(){return this._obj.sequence},set:function(a){this._obj.sequence=parseInt(a)},enumerable:!0});EnumObj.prototype.__define("name",{get:function(){return this._obj.ref},set:function(a){this._obj.ref=String(a)},enumerable:!0});
EnumObj.prototype.__define("synonym",{get:function(){return this._obj.synonym||""},set:function(a){this._obj.synonym=String(a)},enumerable:!0});EnumObj.prototype.__define("presentation",{get:function(){return this.synonym||this.name},enumerable:!1});EnumObj.prototype.empty=function(){return"_"==this.ref};function RegisterRow(a,b){RegisterRow.superclass.constructor.call(this,a,b);a&&"object"==typeof a&&this._mixin(a)}RegisterRow._extend(DataObj);
RegisterRow.prototype.__define("_metadata",{get:function(){var a=this._manager.metadata();a.fields||(a.fields={}._mixin(a.dimensions)._mixin(a.resources));return a},enumerable:!1});RegisterRow.prototype.__define("ref",{get:function(){return this._manager.get_ref(this)},enumerable:!0});
function Rest(){this.filter_date=function(a,b,c){b||(b=new Date("2015-01-01"));b=a+" gt datetime'"+$p.dateFormat(b,$p.dateFormat.masks.isoDateTime)+"'";c&&(b+=" and "+a+" lt datetime'"+$p.dateFormat(c,$p.dateFormat.masks.isoDateTime)+"'");return b};this.to_data=function(a,b){var c={},e=b.metadata().fields,d=b.metadata().tabular_sections,f,g,h,k,l;b instanceof RefDataManager?(a.hasOwnProperty("DeletionMark")&&(c.deleted=a.DeletionMark),a.hasOwnProperty("DataVersion")&&(c.data_version=a.DataVersion),
a.hasOwnProperty("Ref_Key")&&(c.ref=a.Ref_Key)):e=[]._mixin(b.metadata().dimensions)._mixin(b.metadata().resources);b instanceof DocManager?(a.hasOwnProperty("Number")?c.number_doc=a.Number||a.number_doc:a.hasOwnProperty("number_doc")&&(c.number_doc=a.number_doc),a.hasOwnProperty("Date")?c.date=a.Date:a.hasOwnProperty("date")&&(c.date=a.date),a.hasOwnProperty("Posted")?c.posted=a.Posted:a.hasOwnProperty("posted")&&(c.posted=a.posted)):(b.metadata().main_presentation_name&&(a.hasOwnProperty("Description")?
c.name=a.Description:a.hasOwnProperty("name")&&(c.name=a.name)),b.metadata().code_length&&(a.hasOwnProperty("Code")?c.id=a.Code:a.hasOwnProperty("id")&&(c.id=a.id)));for(g in e)l=_md.syns_1\u0441(g),-1==l.indexOf("_Key")&&e[g].type.is_ref&&a[l+"_Key"]&&(l+="_Key"),a.hasOwnProperty(l)&&(c[g]=a[l]);for(f in d)e="extra_fields"==f?f:_md.syns_1\u0441(f),a.hasOwnProperty(e)&&(c[f]=[],a[e]&&(a[e].sort(function(a,b){return a.LineNumber>b.LineNumber}),a[e].forEach(function(a){k={};for(h in d[f].fields)l="extra_fields"!=
f||"property"!=h&&"value"!=h?_md.syns_1\u0441(h):h,-1==l.indexOf("_Key")&&d[f].fields[h].type.is_ref&&a[l+"_Key"]&&(l+="_Key"),k[h]=a[l];c[f].push(k)})));return c};this.ajax_to_data=function(a,b){return $p.ajax.get_ex(a.url,a).then(function(a){return JSON.parse(a.response)}).then(function(a){var e=[];a.value.forEach(function(a){e.push(_rest.to_data(a,b))});return e})};this.build_select=function(a,b){function c(a,d){if("function"==typeof d)f+=d(b,a);else if(g=_md.syns_1\u0441(a),h=_md.get(b.class_name,
a))h=h.type,h.is_ref&&-1==g.indexOf("_Key")&&h.types.length&&-1==h.types[0].indexOf("enm.")&&(g+="_Key"),h.types.length&&(-1!=["boolean","number"].indexOf(typeof d)?f+=g+" eq "+d:h.is_ref&&"object"!=typeof d||d instanceof DataObj?f+=g+" eq guid'"+d+"'":"string"==typeof d?f+=g+" eq '"+d+"'":"object"==typeof d&&(d.hasOwnProperty("like")?f+=g+" like '%"+d.like+"%'":d.hasOwnProperty("not")?f+=" not ("+c(a,d.not)+") ":d.hasOwnProperty("in")&&(f+=g+" in ("+(h.is_ref?d.in.map(function(a){return"guid'"+a+
"'"}).join(","):d.in.join(","))+") ")))}function e(a){for(var b in a)if(f=f?f+" and ":"&$filter=","or"==b&&Array.isArray(a[b])){var d=!0;a[b].forEach(function(a){d?(f+=" ( ",d=!1):f+=" or ";var b=Object.keys(a)[0];c(b,a[b])});f+=" ) "}else c(b,a[b])}var d,f,g,h,k="";a||(a={});a.fields&&(a.fields.forEach(function(a){"ref"==a?g="Ref_Key":(g=_md.syns_1\u0441(a),h=_md.get(b.class_name,a).type,h.is_ref&&-1==g.indexOf("_Key")&&h.types.length&&-1==h.types[0].indexOf("enm.")&&(g+="_Key"));d=d?d+",":"&$select=";
d+=g}),k+=d);a.selection&&("function"!=typeof a.selection&&(Array.isArray(a.selection)?a.selection.forEach(e):e(a.selection)),f&&(k+=f));$p.job_prm.rest&&-1==b.rest_name.indexOf("Module_")&&-1==b.rest_name.indexOf("DataProcessor_")&&-1==b.rest_name.indexOf("Report_")&&-1==k.indexOf(" like ")&&-1==k.indexOf(" in ")&&!b.metadata().irest?$p.ajax.default_attr(a,$p.job_prm.rest_url()):$p.ajax.default_attr(a,$p.job_prm.irest_url());a.url+=b.rest_name+"?allowedOnly=true&$format=json&$top="+(a.top||300)+
k};this.load_array=function(a,b){_rest.build_select(a,b);return _rest.ajax_to_data(a,b)};this.load_obj=function(a){var b={};$p.ajax.default_attr(b,!a._metadata.irest&&$p.job_prm.rest?$p.job_prm.rest_url():$p.job_prm.irest_url());b.url+=a._manager.rest_name+"(guid'"+a.ref+"')?$format=json";return $p.ajax.get_ex(b.url,b).then(function(a){return JSON.parse(a.response)}).then(function(b){a._mixin(_rest.to_data(b,a._manager))._set_loaded();return a}).catch(function(b){if(404==b.status)return a;$p.record_log(b)})};
this.save_irest=function(a,b){var c=JSON.stringify(a),e=(void 0!=b.post?",post="+b.post:"")+(void 0!=b.operational?",operational="+b.operational:"");$p.ajax.default_attr(b,$p.job_prm.irest_url());b.url+=a._manager.rest_name+"(guid'"+a.ref+"'"+e+")";return $p.ajax.post_ex(b.url,c,b).then(function(a){return JSON.parse(a.response)}).then(function(b){return a._mixin(b)})};this.save_rest=function(a,b){var c=a.to_atom(),e;$p.ajax.default_attr(b,$p.job_prm.rest_url());e=b.url+a._manager.rest_name;b.url=
e+"(guid'"+a.ref+"')?$format=json&$select=Ref_Key,DeletionMark";return $p.ajax.get_ex(b.url,b).catch(function(a){return 404==a.status?{response:JSON.stringify({is_new:!0})}:Promise.reject(a)}).then(function(a){return JSON.parse(a.response)}).then(function(d){return d.is_new?$p.ajax.post_ex(e,c,b):$p.ajax.patch_ex(e+"(guid'"+a.ref+"')",c,b)}).then(function(b){var c=require("xml_to_json").parseString(b.response,{mergeCDATA:!1,grokAttr:!0,grokText:!1,normalize:!0,xmlns:!1,namespaceKey:"_ns",textKey:"_text",
valueKey:"_value",attrKey:"_attr",cdataKey:"_cdata",attrsAsObject:!1,stripAttrPrefix:!0,stripElemPrefix:!0,childrenAsArray:!1});if(c.entry&&c.entry.content&&c.entry.updated){b=c.entry.content.properties;var e={};e.lc_changed=new Date(c.entry.updated._text);for(var h in b)if(0!=h.indexOf("_"))if(c=b[h].element)if(e[h]=[],Array.isArray(c))for(var k in c){e[h][k]={};for(var l in c[k])0!=l.indexOf("_")&&(e[h][k][l]="false"===c[k][l]._text?!1:c[k][l]._text)}else for(l in e[h][0]={},c)0!=l.indexOf("_")&&
(e[h][0][l]="false"===c[l]._text?!1:c[l]._text);else e[h]="false"===b[h]._text?!1:b[h]._text;return _rest.to_data(e,a._manager)}}).then(function(b){return a._mixin(b)})}}var _rest=$p.rest=new Rest;DataManager.prototype.__define("rest_name",{get:function(a){var b=this.class_name.split(".");return{cat:"Catalog",doc:"Document",ireg:"InformationRegister",areg:"AccumulationRegister",cch:"ChartOfCharacteristicTypes",cacc:"ChartOfAccounts"}[b[0]]+"_"+_md.syns_1\u0441(b[1])+(a||"")},enumerable:!1});
DataManager.prototype.rest_tree=function(a){var b=this.metadata(),c=[],e,d;$p.ajax.default_attr(a,!b.irest&&$p.job_prm.rest?$p.job_prm.rest_url():$p.job_prm.irest_url());a.url+=this.rest_name+"?allowedOnly=true&$format=json&$top=1000&$select=Ref_Key,DeletionMark,Parent_Key,Description&$filter=IsFolder eq true";return $p.ajax.get_ex(a.url,a).then(function(a){return JSON.parse(a.response)}).then(function(a){for(var b=0;b<a.value.length;b++)d=a.value[b],e={ref:d.Ref_Key,deleted:d.DeletionMark,parent:d.Parent_Key,
presentation:d.Description},c.push(e);return $p.iface.data_to_tree(c)})};
DataManager.prototype.rest_selection=function(a){if("get_tree"==a.action)return this.rest_tree(a);var b=this,c=b.metadata(),e=[],d=[],f,g,h,k,l,m;l=function(){var a="$select=Ref_Key,DeletionMark";c.form&&c.form.selection?c.form.selection.fields.forEach(function(a){e.push(a)}):b instanceof DocManager?(e.push("posted"),e.push("date"),e.push("number_doc")):(c.hierarchical&&c.group_hierarchy?e.push("is_folder"):e.push("0 as is_folder"),c.main_presentation_name?e.push("name as presentation"):c.code_length?
e.push("id as presentation"):e.push("'...' as presentation"),c.has_owners&&e.push("owner"),c.code_length&&e.push("id"));e.forEach(function(c){if(-1!=c.indexOf(" as "))if(c=c.split(" as ")[0].split("."),1==c.length)c=c[0];else{if("_t_"!=c[0])return;c=c[1]}"0"!=c&&(h=_md.syns_1\u0441(c),_md.get(b.class_name,c).type.is_ref&&-1==h.indexOf("_Key")&&_md.get(b.class_name,c).type.types.length&&-1==_md.get(b.class_name,c).type.types[0].indexOf("enm.")&&(h+="_Key"),a+=","+h)});e.push("ref");e.push("deleted");
return a}();$p.ajax.default_attr(a,!c.irest&&$p.job_prm.rest?$p.job_prm.rest_url():$p.job_prm.irest_url());a.url+=(c.irest&&c.irest.selection?c.irest.selection:this.rest_name)+"?allowedOnly=true&$format=json&$top=1000&"+l;_md.get(b.class_name,"date")&&(a.url+="&$filter="+_rest.filter_date("Date",a.date_from,a.date_till),m=!0);a.parent&&(a.url+=m?" and ":"&$filter=",a.url+="Parent_Key eq guid'"+a.parent+"'",m=!0);return $p.ajax.get_ex(a.url,a).then(function(a){return JSON.parse(a.response)}).then(function(c){for(var l=
0;l<c.value.length;l++)g=c.value[l],f={},e.forEach(function(a){var c;"ref"==a?f[a]=g.Ref_Key:(-1!=a.indexOf(" as ")?(c=a.split(" as ")[1],a=a.split(" as ")[0].split("."),a=a[a.length-1]):c=a,h=_md.syns_1\u0441(a),k=_md.get(b.class_name,a),-1==h.indexOf("_Key")&&k.type.is_ref&&k.type.types.length&&-1==k.type.types[0].indexOf("enm.")&&(h+="_Key"),k.type.date_part?f[c]=$p.dateFormat(g[h],$p.dateFormat.masks[k.type.date_part]):k.type.is_ref?g[h]&&g[h]!=$p.blank.guid?(a=_md.value_mgr(f,a,k.type,!1,g[h]),
f[c]=a?a.get(g[h]).presentation:""):f[c]="":f[c]=g[h])}),d.push(f);return $p.iface.data_to_grid.call(b,d,a)})};
InfoRegManager.prototype.rest_slice_last=function(a){a.period||(a.period=$p.date_add_day(new Date,1));var b=this,c=b.metadata(),e="Period=datetime'"+$p.dateFormat(a.period,$p.dateFormat.masks.isoDateTime)+"'",d="",f;for(f in c.dimensions)if(void 0!==a[f]){var g=_md.syns_1\u0441(f),h=c.dimensions[f];-1==g.indexOf("_Key")&&h.type.is_ref&&h.type.types.length&&-1==h.type.types[0].indexOf("enm.")?(g+="_Key",d&&(d+=" and "),d+=g+" eq guid'"+a[f].ref+"'"):(d&&(d+=" and "),d=h.type.digits?d+(g+" eq "+$p.fix_number(a[f])):
h.type.date_part?d+(g+" eq datetime'"+$p.dateFormat(a[f],$p.dateFormat.masks.isoDateTime)+"'"):d+(g+" eq '"+a[f]+"'"))}d&&(e+=",Condition='"+d+"'");$p.ajax.default_attr(a,$p.job_prm.rest_url());a.url+=this.rest_name+"/SliceLast(%sl)?allowedOnly=true&$format=json&$top=1000".replace("%sl",e);return _rest.ajax_to_data(a,b).then(function(a){return b.load_array(a)})};
DataObj.prototype.to_atom=function(a){function b(a){var b=a._metadata.fields,f=a instanceof TabularSectionRow?"\n\t<d:":"\n<d:";for(e in b){d=b[e];h=_md.syns_1\u0441(e);k=a[e];if(k instanceof EnumObj)k=k.empty()?"":k.name;else if(k instanceof DataObj)-1==h.indexOf("_Key")&&(h+="_Key"),k=k.ref;else if(d.type.date_part)k=1E3>k.getFullYear()?"0001-01-01T00:00:00Z":$p.dateFormat(k,$p.dateFormat.masks.atom);else if(void 0==k)continue;c+=f+h+">"+k+"</d:"+h+">"}}a='<entry><category term="StandardODATA.%n" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme"/>\r\n\t\t\t\t\n<title type="text"/><updated>%d</updated><author/><summary/><content type="application/xml">\r\n\t\t\t\t\n<m:properties xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices" xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata">\r\n\t\t\t%p\r\n\t\t\t\n</m:properties></content></entry>'.replace("%n",
this._manager.rest_name).replace("%d",$p.dateFormat(new Date,$p.dateFormat.masks.atom));var c="\n<d:Ref_Key>"+this.ref+"</d:Ref_Key>\n<d:DeletionMark>"+this.deleted+"</d:DeletionMark>\n<d:DataVersion>"+this.data_version+"</d:DataVersion>",e,d,f,g,h,k;this instanceof DocObj?(c+="\n<d:Date>"+$p.dateFormat(this.date,$p.dateFormat.masks.atom)+"</d:Date>",c+="\n<d:Number>"+this.number_doc+"</d:Number>"):(this._metadata.main_presentation_name&&(c+="\n<d:Description>"+this.name+"</d:Description>"),this._metadata.code_length&&
(c+="\n<d:Code>"+this.id+"</d:Code>"),this._metadata.hierarchical&&this._metadata.group_hierarchy&&(c+="\n<d:IsFolder>"+this.is_folder+"</d:IsFolder>"));b(this);for(f in this._metadata.tabular_sections)h="StandardODATA."+this._manager.rest_name+"_"+_md.syns_1\u0441(f)+"_RowType",g=this[f],g.count()?(c+="\n<d:"+_md.syns_1\u0441(f)+' m:type="Collection('+h+')">',g.each(function(a){c+='\n\t<d:element m:type="'+h+'">';c+="\n\t<d:LineNumber>"+a.row+"</d:LineNumber>";b(a);c+="\n\t</d:element>"}),c+="\n</d:"+
_md.syns_1\u0441(f)+">"):c+="\n<d:"+_md.syns_1\u0441(f)+' m:type="Collection('+h+')" />';return a.replace("%p",c)};
function only_in_browser(a){var b=$p.eve,c=$p.iface,e=$p.msg,d={},f=!1,g;b.set_offline=function(a){$p.job_prm.offline=!(!a&&!$p.wsql.get_user_param("offline","boolean"))};b.on_rotate=function(b){$p.device_orient=0==a.orientation||180==a.orientation?"portrait":"landscape";"undefined"!=typeof b&&a.dhx4.callEvent("onOrientationChange",[$p.device_orient])};if("undefined"==typeof a.orientation)$p.device_orient=a.innerWidth>a.innerHeight?"landscape":"portrait";else b.on_rotate();a.addEventListener("orientationchange",
b.on_rotate,!1);$p.__define("device_type",{get:function(){var a=$p.wsql.get_user_param("device_type");a||(a=Math.max(screen.width,screen.height),a=1024>a?"phone":1280>a?"tablet":"desktop",$p.wsql.set_user_param("device_type",a));return a},set:function(a){$p.wsql.set_user_param("device_type",a)},enumerable:!1,configurable:!1});a.addEventListener("online",b.set_offline);a.addEventListener("offline",function(){b.set_offline(!0)});a.addEventListener("load",function(){function h(){$p.ajax.authorized||
(b.redirect=!0,location.reload(!0))}function k(a){!d.wnd_appcache&&$p.iface.appcache?$p.iface.appcache.create(d):f||(f=!0,setTimeout(h,25E3));$p.iface.appcache&&(d.loaded=a.loaded||0,d.total=a.total||140,$p.iface.appcache.update());d.do_break&&($p.iface.appcache.close(),setTimeout(h,1E3))}setTimeout(function(){function d(){function a(){this.geocode=function(a){return Promise.resolve(!1)}}var b,c,e="",f;this.__define("yageocoder",{get:function(){b||(b=new a);return b},enumerable:!1,configurable:!1});
this.__define("ggeocoder",{get:function(){return c},enumerable:!1,configurable:!1});this.__define({addr:{get:function(){return e}},parts:{get:function(){return f}},components:{value:function(a,b){var c,d,e,f="",g="",h="";for(c in b)for(e in d=b[c],d.types)switch(d.types[e]){case "route":-1==d.short_name.indexOf("Unnamed")&&(f=d.short_name+(f?" "+f:""),g=d.long_name.replace("улица","").trim());break;case "administrative_area_level_1":a.region=d.long_name;break;case "administrative_area_level_2":a.city=
d.short_name;a.city_long=d.long_name;break;case "locality":h=(h?h+" ":"")+d.short_name;break;case "street_number":f=(f?f+" ":"")+d.short_name;break;case "postal_code":a.postal_code=d.short_name}a.region&&a.region==a.city_long?-1==a.city.indexOf(h)?a.city=h:a.city="":h&&-1==a.city.indexOf(h)&&-1==a.region.indexOf(h)&&(f=h+", "+f);a.street&&-1!=a.street.indexOf(g)||(a.street=f);return a}}});this.location_callback=function(){c=new google.maps.Geocoder;navigator.geolocation.getCurrentPosition(function(a){$p.ipinfo.latitude=
a.coords.latitude;$p.ipinfo.longitude=a.coords.longitude;a=new google.maps.LatLng($p.ipinfo.latitude,$p.ipinfo.longitude);c.geocode({latLng:a},function(a,b){b==google.maps.GeocoderStatus.OK&&(f=!a[1]||a[0].address_components.length>=a[1].address_components.length?a[0]:a[1],e=f.formatted_address,dhx4.callEvent("geo_current_position",[$p.ipinfo.components({},f.address_components)]))})},$p.record_log,{timeout:3E4})}}function m(){$p.wsql.init_params().then(function(){function d(){var a,b,c,e=!0,f=!0,
g=/metadata.js$/,h=/metadata.min.js$/;for(a in document.scripts)if(document.scripts[a].src.match(g)){c=g;b=document.scripts[a].src;break}else if(document.scripts[a].src.match(h)){c=h;b=document.scripts[a].src;break}for(a=0;a<document.styleSheets.length;a++)document.styleSheets[a].href&&(-1!=document.styleSheets[a].href.indexOf("dhx_web")||-1!=document.styleSheets[a].href.indexOf("dhx_terrace")?e=!1:-1!=document.styleSheets[a].href.indexOf("metadata.css")&&(f=!1));dhtmlx.skin=$p.wsql.get_user_param("skin")||
"dhx_web";e&&$p.load_script(b.replace(c,"dhx_web"==dhtmlx.skin?"dhx_web.css":"dhx_terrace.css"),"link");f&&$p.load_script(b.replace(c,"metadata.css"),"link");$p.job_prm.additional_css&&$p.job_prm.additional_css.forEach(function(a){(dhx4.isIE||-1==a.indexOf("ie_only"))&&$p.load_script(a,"link")});dhtmlx.image_path=b.replace(c,"imgs/");dhtmlx.skin_suffix=function(){return dhtmlx.skin.replace("dhx","")+"/"};dhx4.ajax.cache=!0;$p.iface.__define("w",{value:new dhtmlXWindows,enumerable:!1});$p.iface.w.setSkin(dhtmlx.skin);
$p.iface.__define("popup",{value:new dhtmlXPopup,enumerable:!1})}"dhtmlx"in a&&d();b.stepper={step:0,count_all:0,cat_date:0,step_size:57,files:0,cat_ini_date:$p.wsql.get_user_param("cache_cat_date","number")||0};b.set_offline(!navigator.onLine);b.update_files_version();if(document.documentElement.webkitRequestFullScreen&&navigator.userAgent.match(/Android|iPhone|iPad|iPod/i)&&($p.job_prm.request_full_screen||$p.wsql.get_user_param("request_full_screen"))){var e=function(){document.documentElement.webkitRequestFullScreen();
a.removeEventListener("touchstart",e)};a.addEventListener("touchstart",e,!1)}if($p.job_prm.use_builder||$p.job_prm.use_wrapper)$p.wrapper=document.getElementById("owb_wrapper"),$p.risdiv=document.getElementById("risdiv"),$p.ft=document.getElementById("msgfooter"),$p.ft&&($p.ft.style.display="none");b.onload.execute($p);document&&document.querySelector("#splash")&&document.querySelector("#splash").parentNode.removeChild(document.querySelector("#splash"));$p.job_prm.use_builder&&$p.ft?dhtmlxEvent($p.ft,
"click",function(a){$p.cancel_bubble(a);if("ready"==a.qualifier)c.oninit();else $p.eve.builder_click&&$p.eve.builder_click(a)}):setTimeout(c.oninit,100);$p.msg.russian_names();if($p.wsql.get_user_param("use_service_worker","boolean")&&"undefined"!=typeof navigator&&"serviceWorker"in navigator&&-1!=location.protocol.indexOf("https"))navigator.serviceWorker.register("metadata_service_worker.js",{scope:"/"}).then(function(a){$p.record_log("serviceWorker register succeeded")}).catch($p.record_log);else if(g=
a.applicationCache)g.addEventListener("noupdate",function(a){},!1),g.addEventListener("cached",function(a){f=!0;$p.iface.appcache&&$p.iface.appcache.close()},!1),g.addEventListener("downloading",k,!1),g.addEventListener("progress",k,!1),g.addEventListener("updateready",function(a){try{g.swapCache(),$p.iface.appcache&&$p.iface.appcache.close()}catch(b){}h()},!1),g.addEventListener("error",$p.record_log,!1)})}$p.job_prm=new JobPrm;navigator.geolocation&&$p.job_prm.use_google_geo&&($p.ipinfo=new d,window.google&&
window.google.maps?location_callback():$p.eve.onload.push(function(){setTimeout(function(){$p.load_script(location.protocol+"//maps.google.com/maps/api/js?callback=$p.ipinfo.location_callback","script",function(){})},100)}));$p.job_prm.allow_post_message&&a.addEventListener("message",function(a){if(("*"==$p.job_prm.allow_post_message||$p.job_prm.allow_post_message==a.origin)&&"string"==typeof a.data)try{var b=eval(a.data);if(b&&a.source){if("object"==typeof b)b=JSON.stringify(b);else if("function"==
typeof b)return;a.source.postMessage(b,"*")}}catch(c){$p.record_log(c)}});b.socket.connect();!$p.job_prm.check_browser_compatibility||a.JSON&&a.indexedDB&&a.localStorage?$p.job_prm.check_app_installed&&a.chrome&&a.chrome.app&&!a.chrome.app.isInstalled&&!location.hostname.match(/.local/)?(b.redirect=!0,e.show_msg({type:"alert-error",text:e.unsupported_mode,title:e.unsupported_mode_title}),setTimeout(function(){location.replace(e.store_url_od)},6E3)):setTimeout(function(){"function"!==typeof Promise?
$p.load_script("//cdn.jsdelivr.net/es6-promise/latest/es6-promise.min.js","script",function(){ES6Promise.polyfill();m()}):m()},20):(b.redirect=!0,e.show_msg({type:"alert-error",text:e.unsupported_browser,title:e.unsupported_browser_title}),setTimeout(function(){location.replace(e.store_url_od)},6E3))},20)},!1);a.onbeforeunload=function(){if(!b.redirect)return e.onbeforeunload};a.addEventListener("popstat",$p.iface.hash_route);a.addEventListener("hashchange",$p.iface.hash_route)}
"undefined"!==typeof window&&only_in_browser(window);
function SocketMsg(){function a(a){if(a&&"react"==a.type)try{var b=_md?_md.mgr_by_class_name(a.class_name):null;b&&b.load_array([a.obj],!0)}catch(c){$p.record_log(c)}}var b,c,e,d=0,f=this;f.connect=function(a){b||(b=$p.job_prm.parse_url().socket_uid||"");a&&(d=0);d++;if($p.job_prm.ws_url&&(!c||!e))try{c=new WebSocket($p.job_prm.ws_url),c.onopen=function(){e=!0;c.send(JSON.stringify({socket_uid:b,zone:$p.wsql.get_user_param("zone"),browser_uid:$p.wsql.get_user_param("browser_uid"),_side:"js",_mirror:!0}))},
c.onclose=function(){e=!1;setTimeout(f.connect,3>d?3E4:6E5)},c.onmessage=function(a){var b;try{b=JSON.parse(a.data)}catch(c){b=a.data}dhx4.callEvent("socket_msg",[b])},c.onerror=$p.record_log}catch(h){setTimeout(f.connect,3>d?3E4:6E5),$p.record_log(h)}};f.send=function(a){c&&e&&(a?"object"!=typeof a&&(a={data:a}):a={},a.socket_uid=b,a._side="js",c.send(JSON.stringify(a)))};"undefined"!==typeof window&&window.dhx4&&dhx4.attachEvent("socket_msg",a)}$p.eve.socket=new SocketMsg;
$p.eve.steps={load_meta:0,authorization:1,create_managers:2,process_access:3,load_data_files:4,load_data_db:5,load_data_wsql:6,save_data_wsql:7};$p.eve.ontimer=function(){$p.eve.update_files_version()};setInterval($p.eve.ontimer,18E4);
$p.eve.update_files_version=function(){$p.job_prm&&!$p.job_prm.offline&&$p.job_prm.data_url&&($p.job_prm.files_date||($p.job_prm.files_date=$p.wsql.get_user_param("files_date","number")),$p.ajax.get($p.job_prm.data_url+"sync.json?v="+Date.now()).then(function(a){a=JSON.parse(a.response);$p.job_prm.confirmation||$p.job_prm.files_date==a.files_date||($p.wsql.set_user_param("files_date",a.files_date),$p.job_prm.confirmation=!0,dhtmlx.confirm({title:$p.msg.file_new_date_title,text:$p.msg.file_new_date,
ok:"Перезагрузка",cancel:"Продолжить",callback:function(a){delete $p.job_prm.confirmation;a&&($p.eve.redirect=!0,location.reload(!0))}}))}).catch($p.record_log))};$p.eve.pop=function(){return Promise.resolve(!1)};$p.eve.push=function(){};
$p.eve.from_json_to_data_obj=function(a){var b=$p.eve.stepper,c;"string"==typeof a?a=JSON.parse(a):a instanceof XMLHttpRequest&&(a=a.response?JSON.parse(a.response):{});if(b.do_break)$p.iface.sync.close(),$p.eve.redirect=!0,location.reload(!0);else if(a.cat_date||a.force){a.cat_date>b.cat_ini_date&&(b.cat_ini_date=a.cat_date);a.cat_date>b.cat_date&&(b.cat_date=a.cat_date);a.count_all&&(b.count_all=a.count_all);a.current&&(b.current=a.current);for(c in a.cch)_cch[c]&&_cch[c].load_array(a.cch[c]);for(c in a.cacc)_cacc[c]&&
_cacc[c].load_array(a.cacc[c]);for(c in a.cat)_cat[c]&&_cat[c].load_array(a.cat[c]);for(c in a.doc)_doc[c]&&_doc[c].load_array(a.doc[c]);for(c in a.ireg)_ireg[c]&&_ireg[c].load_array(a.ireg[c]);for(c in a.areg)_areg[c]&&_areg[c].load_array(a.areg[c]);return a.current&&a.current>=b.step_size}};$p.eve.reduce_promices=function(a,b){return a.reduce(function(a,e){return a.then(function(){return e}).then(b).catch(b)},Promise.resolve())};$p.eve.js_time_diff=-(new Date("0001-01-01")).valueOf();
$p.eve.time_diff=function(){var a=$p.wsql.get_user_param("time_diff","number");return!a||isNaN(a)||621355716E5>a||62135622E6<a?$p.eve.js_time_diff:a};
$p.eve.log_in=function(a){var b=$p.eve.stepper,c={},e=[],d,f,g,h=$p.job_prm.data_url||"/data/";a($p.eve.steps.load_meta);$p.ajax.default_attr(c,$p.job_prm.irest_url());$p.job_prm.offline||e.push($p.ajax.get_ex(c.url,c));e.push($p.ajax.get(h+"meta.json?v="+$p.job_prm.files_date));e.push($p.ajax.get(h+"meta_patch.json?v="+$p.job_prm.files_date));return $p.eve.reduce_promices(e,function(b){b instanceof XMLHttpRequest&&200==b.status?-1!=b.responseURL.indexOf("/hs/rest")?$p.job_prm.irest_enabled=!0:-1!=
b.responseURL.indexOf("meta.json")?(a($p.eve.steps.create_managers),d=JSON.parse(b.response)):-1!=b.responseURL.indexOf("meta_patch.json")&&(f=JSON.parse(b.response)):$p.record_log(b)}).then(function(){if(d)return new Meta(d,f);throw Error("Ошибка чтения файла метаданных");}).then(function(c){d=f=null;a($p.eve.steps.authorization);return $p.job_prm.offline?c:$p.job_prm.rest||$p.job_prm.irest_enabled?$p.job_prm.irest_enabled?{root:!0}:$p.ajax.get_ex($p.job_prm.rest_url()+"?$format=json",!0).then(function(a){return{root:!0}}):
_load({action:"get_meta",cache_cat_date:b.cat_ini_date,now_js:Date.now(),margin:$p.wsql.get_user_param("margin","number"),ipinfo:$p.ipinfo.hasOwnProperty("latitude")?JSON.stringify($p.ipinfo):""})}).catch(function(a){if($p.iface.auth.onerror)$p.iface.auth.onerror(a);throw a;}).then(function(b){a($p.eve.steps.load_data_files);if($p.job_prm.offline)return b;$p.ajax.authorized=!0;"string"==typeof b&&(b=JSON.parse(b));if(!$p.msg.check_soap_result(b))return $p.wsql.get_user_param("enable_save_pwd")?$p.wsql.set_user_param("user_pwd",
$p.ajax.password):$p.wsql.get_user_param("user_pwd")&&$p.wsql.set_user_param("user_pwd",""),$p.wsql.set_user_param("time_diff",b["now_1с"]-b.now_js),b.cat&&b.cat.clrs&&(_md.get("cat.clrs").predefined.white.ref=b.cat.clrs.predefined.white.ref),b.cat&&b.cat.bases&&(_md.get("cat.bases").predefined.main.ref=b.cat.bases.predefined.main.ref),b}).then(function(a){g=a;b.zone=($p.job_prm.demo?"1":$p.wsql.get_user_param("zone"))+"/";return $p.ajax.get(h+"zones/"+b.zone+"p_0.json?v="+$p.job_prm.files_date)}).then(function(a){a=
JSON.parse(a.response);b.files=a.files-1;b.step_size=0<a.files?Math.round(a.count_all/a.files):57;b.cat_ini_date=a.cat_date;$p.eve.from_json_to_data_obj(a)}).then(function(){e=[];for(var a=1;a<=b.files;a++)e.push($p.ajax.get(h+"zones/"+b.zone+"p_"+a+".json?v="+$p.job_prm.files_date));e.push($p.ajax.get(h+"zones/"+b.zone+"ireg.json?v="+$p.job_prm.files_date));return $p.eve.reduce_promices(e,$p.eve.from_json_to_data_obj)}).then(function(){a($p.eve.steps.load_data_db);b.step_size=57;return $p.eve.pop()}).then(function(){g.access&&
(g.access.force=!0,$p.eve.from_json_to_data_obj(g.access));_md.printing_plates(g.printing_plates);$p.ajax.hasOwnProperty("root")&&delete $p.ajax.root;$p.ajax.__define("root",{value:!!g.root,writable:!1,enumerable:!1})}).then(function(){a($p.eve.steps.save_data_wsql)})};
$p.eve.auto_log_in=function(){var a=$p.eve.stepper,b=$p.job_prm.data_url||"/data/",c=[],e,d,f;a.zone=$p.wsql.get_user_param("zone")+"/";c.push($p.ajax.get(b+"meta.json?v="+$p.job_prm.files_date));c.push($p.ajax.get(b+"meta_patch.json?v="+$p.job_prm.files_date));c.push($p.ajax.get(b+"zones/"+a.zone+"p_0.json?v="+$p.job_prm.files_date));return $p.eve.reduce_promices(c,function(a){a instanceof XMLHttpRequest&&200==a.status?-1!=a.responseURL.indexOf("meta.json")?e=JSON.parse(a.response):-1!=a.responseURL.indexOf("meta_patch.json")?
d=JSON.parse(a.response):-1!=a.responseURL.indexOf("p_0.json")&&(f=JSON.parse(a.response)):$p.record_log(a)}).then(function(){if(e)return new $p.Meta(e,d);throw Error("Ошибка чтения файла метаданных");}).then(function(b){a.files=f.files-1;a.step_size=0<f.files?Math.round(f.count_all/f.files):57;a.cat_ini_date=f.cat_date;$p.eve.from_json_to_data_obj(f)}).then(function(){c=[];for(var d=1;d<=a.files;d++)c.push($p.ajax.get(b+"zones/"+a.zone+"p_"+d+".json?v="+$p.job_prm.files_date));c.push($p.ajax.get(b+
"zones/"+a.zone+"ireg.json?v="+$p.job_prm.files_date));return $p.eve.reduce_promices(c,$p.eve.from_json_to_data_obj)}).then(function(){a.step_size=57})};
