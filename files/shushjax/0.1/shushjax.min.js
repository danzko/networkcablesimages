/**
 * shushjax
 * A standalone implementation of Pushstate AJAX, for non-JQuery webpages.
 * @version 0.1
 * @author JC Hulce
 * @source https://github.com/Team-Pr0xy/shushjax
 * @license MIT
 */
(function(batchdom){var raf=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(cb){return window.setTimeout(cb,1000/60)};var caf=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.mozCancelAnimationFrame||window.mozCancelRequestAnimationFrame||window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.msCancelRequestAnimationFrame||function(id){window.clearTimeout(id)};function BatchDom(){this.frames=[];this.lastId=0;this.raf=raf;this.batch={hash:{},read:[],write:[],mode:null}}BatchDom.prototype.read=function(fn,ctx){var job=this.add("read",fn,ctx);var id=job.id;this.batch.read.push(job.id);var doesntNeedFrame=this.batch.mode==="reading"||this.batch.scheduled;if(doesntNeedFrame){return id}this.scheduleBatch();return id};BatchDom.prototype.write=function(fn,ctx){var job=this.add("write",fn,ctx);var mode=this.batch.mode;var id=job.id;this.batch.write.push(job.id);var doesntNeedFrame=mode==="writing"||mode==="reading"||this.batch.scheduled;if(doesntNeedFrame){return id}this.scheduleBatch();return id};BatchDom.prototype.writelog=function(logtext){var self=this;return this.write(function(){(console.log(logtext))})};BatchDom.prototype.writeinfo=function(logtext){var self=this;return this.write(function(){(console.info(logtext))})};BatchDom.prototype.writeerror=function(logtext){var self=this;return this.write(function(){(console.error(logtext))})};BatchDom.prototype.defer=function(frame,fn,ctx){if(typeof frame==="function"){ctx=fn;fn=frame;frame=1}var self=this;var index=frame-1;return this.schedule(index,function(){self.run({fn:fn,ctx:ctx})})};BatchDom.prototype.clear=function(id){if(typeof id==="function"){return this.clearFrame(id)}var job=this.batch.hash[id];if(!job){return}var list=this.batch[job.type];var index=list.indexOf(id);delete this.batch.hash[id];if(~index){list.splice(index,1)}};BatchDom.prototype.clearFrame=function(frame){var index=this.frames.indexOf(frame);if(~index){this.frames.splice(index,1)}};BatchDom.prototype.scheduleBatch=function(){var self=this;this.schedule(0,function(){self.batch.scheduled=false;self.runBatch()});this.batch.scheduled=true};BatchDom.prototype.uniqueId=function(){return ++this.lastId};BatchDom.prototype.flush=function(list){var id;while(!!(id=list.shift())){this.run(this.batch.hash[id])}};BatchDom.prototype.runBatch=function(){try{this.batch.mode="reading";this.flush(this.batch.read);this.batch.mode="writing";this.flush(this.batch.write);this.batch.mode=null}catch(e){this.runBatch();throw e}};BatchDom.prototype.add=function(type,fn,ctx){var id=this.uniqueId();var result=this.batch.hash[id]={id:id,fn:fn,ctx:ctx,type:type};return result};BatchDom.prototype.run=function(job){var ctx=job.ctx||this;var fn=job.fn;delete this.batch.hash[job.id];if(!this.onError){return fn.call(ctx)}try{fn.call(ctx)}catch(e){this.onError(e)}};BatchDom.prototype.loop=function(){var self=this;var raf=this.raf;if(this.looping){return}raf(function frame(){var fn=self.frames.shift();if(!self.frames.length){self.looping=false}else{raf(frame)}if(fn){fn()}});this.looping=true};BatchDom.prototype.schedule=function(index,fn){if(this.frames[index]){return this.schedule(index+1,fn)}this.loop();var result=this.frames[index]=fn;return result};batchdom=batchdom||new BatchDom();if(typeof module!=="undefined"&&module.exports){module.exports=batchdom}else{if(typeof define==="function"&&define.amd){define(function(){return batchdom})}else{window.batchdom=batchdom}}})(window.batchdom);(function(){var internal={firstrun:true,is_supported:window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/)};internal.addEvent=function(obj,event,callback){if(window.addEventListener){batchdom.writelog("Adding event listener to "+obj+" on event "+event);batchdom.write(function(){obj.addEventListener(event,callback,false)})}else{batchdom.writeinfo("Adding fallback event listeners for old IE versions");batchdom.writelog("Adding event listener to "+obj+" on event "+event);obj.attachEvent("on"+event,callback)}};internal.clone=function(obj){object={};for(var i in obj){if(obj.hasOwnProperty(i)){object[i]=obj[i]}}return object};internal.triggerEvent=function(node,event_name){if(document.createEvent){evt=document.createEvent("HTMLEvents");evt.initEvent(event_name,true,true);node.dispatchEvent(evt)}else{evt=document.createEventObject();evt.eventType="on"+event_name;node.fireEvent(evt.eventType,evt);batchdom.writeinfo("Using createEvent fallbacks for old IE versions")}batchdom.writelog("Firing event "+event_name)};internal.addEvent(window,"popstate",function(st){if(st.state!==null){var opt={url:st.state.url,container:st.state.container,history:false};if(typeof internal.options!=="undefined"){for(var a in internal.options){if(typeof opt[a]==="undefined"){opt[a]=internal.options[a]}}}var options=internal.parseOptions(opt);if(options===false){batchdom.writeerror("Failed to read state data "+st);internal.triggerEvent(options.container,"generalError");return}internal.handle(options);batchdom.writelog("Handling state "+st)}});internal.attach=function(node,options){if(!internal.is_supported){batchdom.writeinfo("No pushstate support in browser, shushjax is disabled");return}if(node.protocol!==document.location.protocol||node.host!==document.location.host){batchdom.writelog("Ignoring external anchor "+node.href);return}if(node.pathname===location.pathname&&node.hash.length>0){batchdom.writelog("Ignoring same-page anchor "+node.hash);return true}options.url=node.href;if(node.getAttribute("data-shushjax")){options.container=node.getAttribute("data-shushjax");batchdom.writelog("Using "+options.container+" as container for "+node.href+" as specified with data-shushjax")}if(node.getAttribute("data-title")){options.title=node.getAttribute("data-title");batchdom.writelog("Using "+options.title+" as title for "+node.href+" as specified with data-title")}options=internal.parseOptions(options);if(options===false){batchdom.writeerror("Invalid options error");internal.triggerEvent(options.container,"generalError");return}internal.addEvent(node,"click",function(event){if(event.which>1||event.metaKey){return}if(event.preventDefault){event.preventDefault()}else{event.returnValue=false}if(document.location.href===options.url){batchdom.writelog("Ignoring same-page anchor "+options.url);return false}internal.handle(options)})};internal.parseLinks=function(dom_obj,options){if(typeof options.useClass!=="undefined"){nodes=dom_obj.getElementsByClassName(options.useClass);batchdom.writelog("Attaching to links with class "+options.useClass)}else{nodes=dom_obj.getElementsByTagName("a");batchdom.writelog("Attaching to all links, useClass is unspecified")}for(var i=0,tmp_opt;i<nodes.length;i++){node=nodes[i];tmp_opt=internal.clone(options);tmp_opt.history=true;internal.attach(node,tmp_opt)}};internal.smartLoad=function(html,options){var tmp=document.createElement("div");tmp.innerHTML=html;var title=tmp.getElementsByTagName("title")[0].innerHTML;if(title){batchdom.writelog("Using returned document title: "+title);document.title=title}tmpNodes=tmp.getElementsByTagName("div");for(var i=0;i<tmpNodes.length;i++){if(tmpNodes[i].id===options.container.id){batchdom.writeinfo("Found container div in the returned HTML, treating as full HTML content and processing with smartLoad");return tmpNodes[i].innerHTML}else{batchdom.writelog("Didn't find container div in the returned HTML, processing as a partial page")}}return html};internal.handle=function(options){internal.triggerEvent(options.container,"beforeSend");internal.request(options.url,options.partial,function(html){if(!html){internal.triggerEvent(options.container,"requestError");return}batchdom.writelog("smartLoad is "+options.smartLoad);if(options.smartLoad){html=internal.smartLoad(html,options)}options.container.innerHTML=html;batchdom.writelog("parseLinksOnLoad is "+options.parseLinksOnload);if(options.parseLinksOnload){internal.parseLinks(options.container,options)}if(typeof options.title==="undefined"){if(options.container.getElementsByTagName("title").length!==0){options.title=options.container.getElementsByTagName("title")[0].innerHTML}else{options.title=document.title}}if(options.history){if(internal.firstrun){window.history.replaceState({url:document.location.href,container:options.container.id},document.title);internal.firstrun=false}window.history.pushState({url:options.url,container:options.container.id},options.title,options.url)}internal.triggerEvent(options.container,"complete");if(xmlhttp.status!==200){internal.triggerEvent(options.container,"requestError");batchdom.writeerror("Request finished with HTTP error "+xmlhttp.status);return}if(html===false||html==="undefined"){internal.triggerEvent(options.container,"requestError");return}else{internal.triggerEvent(options.container,"success")}if(window._gaq){batchdom.writelog("Pushing Google Analytics pageview");_gaq.push(["_trackPageview"])}document.title=options.title})};internal.request=function(location,partial,callback){batchdom.writelog("Requesting page "+location);xmlhttp=window.XMLHttpRequest?new XMLHttpRequest():new ActiveXObject("Microsoft.XMLHTTP");if(typeof xmlhttp.onload!=="undefined"){batchdom.writelog("Using XHR2");xmlhttp.onloadend=function(){batchdom.writelog("Fetch complete, HTTP status code "+xmlhttp.status);if(xmlhttp.status!==200){}callback(xmlhttp.responseText,xmlhttp.status)};xmlhttp.onerror=function(){if(xmlhttp.status===0){batchdom.writeerror("Failed to connect to the server, network error "+xmlhttp.status)}else{batchdom.writeerror("Fetch error, HTTP status code "+xmlhttp.status)}callback(xmlhttp.responseText,xmlhttp.status);return false}}else{batchdom.writeinfo("Falling back to basic XHR");xmlhttp.onreadystatechange=function(){if((xmlhttp.readyState===4)&&(xmlhttp.status===200)){callback(xmlhttp.responseText);batchdom.writelog("Fetch complete")}else{if((xmlhttp.readyState===4)&&(xmlhttp.status!==200)){batchdom.writeerror("Fetch error, HTTP status code "+xmlhttp.status);callback(xmlhttp.responseText);return false}}}}if(typeof(URL)==="function"){formaturl=new URL(location);batchdom.writelog("Using URL() to process location")}else{if(typeof(webkitURL)==="function"){formaturl=new webkitURL(location);batchdom.writeinfo("Using webkitURL() instead of URL()")}else{partial=false;batchdom.writeinfo("Disabling partial file support, browser does not support URL()")}}if(partial===true){getlocation=formaturl.protocol+"//"+formaturl.host+"/partials"+formaturl.pathname;batchdom.writelog("Fetching a partial HTML file")}else{getlocation=location;batchdom.writelog("Fetching a full HTML file")}batchdom.writelog("Fetching "+getlocation);xmlhttp.open("GET",getlocation,true);xmlhttp.setRequestHeader("X-shushjax","true");xmlhttp.setRequestHeader("X-Requested-With","XMLHttpRequest");xmlhttp.send(null)};internal.parseOptions=function(options){opt={};opt.history=true;opt.parseLinksOnload=true;opt.smartLoad=true;opt.partial=false;if(typeof options.url==="undefined"||typeof options.container==="undefined"){batchdom.writeerror("URL and Container must be provided");internal.triggerEvent(options.container,"generalError");return false}if(typeof options.history==="undefined"){options.history=opt.history}else{options.history=(!(options.history===false))}if(typeof options.parseLinksOnload==="undefined"){options.parseLinksOnload=opt.parseLinksOnload}if(typeof options.partial==="undefined"){options.partial=opt.partial}if(typeof options.smartLoad==="undefined"){options.smartLoad=opt.smartLoad}if(typeof options.container==="string"){container=document.getElementById(options.container);if(container===null){batchdom.writeerror("Could not find container with id:"+options.container);internal.triggerEvent(options.container,"generalError");return false}options.container=container}if(typeof options.beforeSend==="function"){internal.addEvent(options.container,"beforeSend",options.beforeSend);batchdom.writelog("shushjax request initiating")}if(typeof options.complete==="function"){internal.addEvent(options.container,"complete",options.complete);batchdom.writelog("shushjax request complete")}if(typeof options.generalError==="function"){internal.addEvent(options.container,"generalError",options.generalError);batchdom.writeerror("An error occurred")}if(typeof options.requestError==="function"){internal.addEvent(options.container,"requestError",options.requestError);batchdom.writeerror("An error occurred during the shushjax request")}if(typeof options.success==="function"){internal.addEvent(options.container,"success",options.success);batchdom.writelog("shushjax request completed successfully")}return options};this.connect=function(){var options={};if(arguments.length===2){options.container=arguments[0];options.useClass=arguments[1]}if(arguments.length===1){if(typeof arguments[0]==="string"){options.container=arguments[0]}else{options=arguments[0]}}delete options.title;delete options.history;internal.options=options;if(document.readyState==="complete"){internal.parseLinks(document,options)}else{internal.addEvent(window,"load",function(){internal.parseLinks(document,options)})}};this.invoke=function(){if(arguments.length===2){options={};options.url=arguments[0];options.container=arguments[1]}else{options=arguments[0]}if(!internal.is_supported){document.location=options.url;batchdom.writeinfo("Browser does not support shushjax. Pushing user directly to the specified page instead");return}options=internal.parseOptions(options);if(options!==false){internal.handle(options)}batchdom.writelog("Everything is okay, activating shushjax")};var shushjax_obj=this;if(typeof define==="function"&&define.amd){define(function(){return shushjax_obj})}else{window.shushjax=shushjax_obj}}).call({});
