/* esri-leaflet-webmap - v0.3.3 - Thu Jul 07 2016 15:03:55 GMT+0900 (東京 (標準時))
 * Copyright (c) 2016 Yusuke Nunokawa <nuno0825@gmail.com>
 * MIT */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("leaflet")):"function"==typeof define&&define.amd?define(["exports","leaflet"],t):t((e.L=e.L||{},e.L.esri=e.L.esri||{}),e.L)}(this,function(e,t){"use strict";function i(e,t){return new M(e,t)}function o(e,t){return new P(e,t)}function r(e,t){return new k(e,t)}function s(e,t){return new T(e,t)}function n(e,t){return new D(e,t)}function a(e,t){return new J(e,t)}function l(e,t){return new C(e,t)}function h(e,t){return new F(e,t)}function u(e,t){var i=/\{([^\]]*)\}/g,o="",r="";void 0!==e.title&&(o=e.title),o=o.replace(i,function(e){var o=i.exec(e);return t[o[1]]}),r='<div class="leaflet-popup-content-title"><h4>'+o+'</h4></div><div class="leaflet-popup-content-description" style="max-height:200px;overflow:auto;">';for(var s=0;s<e.fieldInfos.length;s++)e.fieldInfos[s].visible===!0&&(r+='<div style="font-weight:bold;color:#999;margin-top:5px;word-break:break-all;">'+e.fieldInfos[s].label+'</div><p style="margin-top:0;margin-bottom:5px;word-break:break-all;">'+t[e.fieldInfos[s].fieldName]+"</p>");return r+="</div>",e.mediaInfos.length>0,r}function p(e,t,i){return y(e,t,i)}function y(e,i,o){console.log("generateEsriLayer: ",e.title,e);var r,s,n=[];if(void 0!==e.featureCollection)return console.log("create FeatureCollection"),e.featureCollection.layers[0].layerDefinition.drawingInfo.labelingInfo&&e.featureCollection.layers[0].featureSet&&e.featureCollection.layers[0].featureSet.features.map(function(i){var o=t.Projection.SphericalMercator.unproject(t.point(i.geometry.x,i.geometry.y)),r=e.featureCollection.layers[0].layerDefinition.drawingInfo.labelingInfo,s=h(o,{zIndexOffset:1,properties:i.attributes,labelingInfo:r,offset:[20,20]});n.push(s)}),r=l([],{data:e.itemId||e.featureCollection,opacity:e.opacity,renderer:e.featureCollection.layers[0].layerDefinition.drawingInfo.renderer,onEachFeature:function(t,i){if(void 0!==e.featureCollection.layers[0].popupInfo){var o=u(e.featureCollection.layers[0].popupInfo,t.properties);i.bindPopup(o)}}}),n.length>0&&(s=t.featureGroup(n),r=t.layerGroup([r,s])),i.push({type:"FC",title:e.title||"",layer:r}),r;if("ArcGISFeatureLayer"===e.layerType&&void 0!==e.layerDefinition){var a="1=1";if(void 0!==e.layerDefinition.drawingInfo){if("heatmap"===e.layerDefinition.drawingInfo.renderer.type){console.log("create HeatmapLayer");var p={};return e.layerDefinition.drawingInfo.renderer.colorStops.map(function(e){p[(Math.round(100*e.ratio)/100+6)/7]="rgb("+e.color[0]+","+e.color[1]+","+e.color[2]+")"}),r=t.esri.Heat.heatmapFeatureLayer({url:e.url,minOpacity:.5,max:e.layerDefinition.drawingInfo.renderer.maxPixelIntensity,blur:e.layerDefinition.drawingInfo.renderer.blurRadius,radius:1.3*e.layerDefinition.drawingInfo.renderer.blurRadius,gradient:p}),i.push({type:"HL",title:e.title||"",layer:r}),r}return console.log("create ArcGISFeatureLayer (with layerDefinition.drawingInfo)"),void 0!==e.layerDefinition.definitionExpression&&(a=e.layerDefinition.definitionExpression),s=t.featureGroup(n),r=t.esri.featureLayer({url:e.url,where:a,drawingInfo:e.layerDefinition.drawingInfo,onEachFeature:function(t,i){if(void 0!==e.popupInfo){var o=u(e.popupInfo,t.properties);i.bindPopup(o)}if(void 0!==e.layerDefinition.drawingInfo.labelingInfo){var r,n,a,l,p=e.layerDefinition.drawingInfo.labelingInfo,y=[0,0];"Point"===i.feature.geometry.type?(r=i.feature.geometry.coordinates.reverse(),y=[20,20]):"LineString"===i.feature.geometry.type?(a=i.feature.geometry.coordinates,n=Math.round(a.length/2),r=a[n].reverse()):"MultiLineString"===i.feature.geometry.type?(a=i.feature.geometry.coordinates,n=Math.round(a.length/2),l=a[n],n=Math.round(l.length/2),r=l[n].reverse()):r=i.getBounds().getCenter();var c=h(r,{zIndexOffset:1,properties:t.properties,labelingInfo:p,offset:y});s.addLayer(c)}}}),r=t.layerGroup([r,s]),i.push({type:"FL",title:e.title||"",layer:r}),r}return console.log("create ArcGISFeatureLayer (without layerDefinition.drawingInfo)"),void 0!==e.layerDefinition.definitionExpression&&(a=e.layerDefinition.definitionExpression),r=t.esri.featureLayer({url:e.url,where:a,onEachFeature:function(t,i){if(void 0!==e.popupInfo){var o=u(e.popupInfo,t.properties);i.bindPopup(o)}}}),i.push({type:"FL",title:e.title||"",layer:r}),r}if("ArcGISFeatureLayer"===e.layerType)return console.log("create ArcGISFeatureLayer"),r=t.esri.featureLayer({url:e.url,onEachFeature:function(t,i){if(void 0!==e.popupInfo){var o=u(e.popupInfo,t.properties);i.bindPopup(o)}},pointToLayer:function(i,o){var r=t.marker(o,{opacity:e.opacity});return r}}),i.push({type:"FL",title:e.title||"",layer:r}),r;if("ArcGISImageServiceLayer"===e.layerType)return console.log("create ArcGISImageServiceLayer"),r=t.esri.imageMapLayer({url:e.url}),i.push({type:"IML",title:e.title||"",layer:r}),r;if("ArcGISMapServiceLayer"===e.layerType)return r=t.esri.dynamicMapLayer({url:e.url}),i.push({type:"DML",title:e.title||"",layer:r}),r;if("ArcGISTiledMapServiceLayer"===e.layerType){try{r=t.esri.basemapLayer(e.title)}catch(y){r=t.esri.tiledMapLayer({url:e.url}),t.esri.request(e.url,{},function(e,t){if(e)console.log(e);else{var i=o.getSize().x-55,r='<span class="esri-attributions" style="line-height:14px; vertical-align: -3px; text-overflow:ellipsis; white-space:nowrap; overflow:hidden; display:inline-block; max-width:'+i+'px;">'+t.copyrightText+"</span>";o.attributionControl.addAttribution(r)}})}return i.push({type:"TML",title:e.title||"",layer:r}),r}if("OpenStreetMap"===e.layerType)return r=t.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}),i.push({type:"TL",title:e.title||e.id||"",layer:r}),r;if("WebTiledLayer"===e.layerType){var f=c(e.templateUrl);return r=t.tileLayer(f,{attribution:e.copyright}),i.push({type:"TL",title:e.title||e.id||"",layer:r}),r}return r=t.featureGroup([]),console.log("Unsupported Layer: ",e),r}function c(e){var t=e;return t=t.replace(/\{level}/g,"{z}"),t=t.replace(/\{col}/g,"{x}"),t=t.replace(/\{row}/g,"{y}")}function f(e,t){return new V(e,t)}t="default"in t?t["default"]:t;var d="0.3.3",_=t.Class.extend({initialize:function(e,t){this._symbolJson=e,this.val=null,this._styles={},this._isDefault=!1,this._layerTransparency=1,t&&t.layerTransparency&&(this._layerTransparency=1-t.layerTransparency/100)},pixelValue:function(e){return 1.333*e},colorValue:function(e){return"rgb("+e[0]+","+e[1]+","+e[2]+")"},alphaValue:function(e){var t=e[3]/255;return t*this._layerTransparency},getSize:function(e,t){var i=e.properties,o=t.field,r=0,s=null;if(o){s=i[o];var n,a=t.minSize,l=t.maxSize,h=t.minDataValue,u=t.maxDataValue,p=t.normalizationField,y=i?parseFloat(i[p]):void 0;if(null===s||p&&(isNaN(y)||0===y))return null;isNaN(y)||(s/=y),null!==a&&null!==l&&null!==h&&null!==u&&(s<=h?r=a:s>=u?r=l:(n=(s-h)/(u-h),r=a+n*(l-a))),r=isNaN(r)?0:r}return r},getColor:function(e,t){if(!(e.properties&&t&&t.field&&t.stops))return null;var i,o,r,s,n=e.properties,a=n[t.field],l=t.normalizationField,h=n?parseFloat(n[l]):void 0;if(null===a||l&&(isNaN(h)||0===h))return null;if(isNaN(h)||(a/=h),a<=t.stops[0].value)return t.stops[0].color;var u=t.stops[t.stops.length-1];if(a>=u.value)return u.color;for(var p=0;p<t.stops.length;p++){var y=t.stops[p];if(y.value<=a)i=y.color,r=y.value;else if(y.value>a){o=y.color,s=y.value;break}}if(!isNaN(r)&&!isNaN(s)){var c=s-r;if(c>0){var f=(a-r)/c;if(f){var d=(s-a)/c;if(d){for(var _=[],g=0;g<4;g++)_[g]=Math.round(i[g]*d+o[g]*f);return _}return o}return i}}return null}}),g=t.Path.extend({initialize:function(e,i,o){t.setOptions(this,o),this._size=i,this._latlng=t.latLng(e),this._svgCanvasIncludes()},toGeoJSON:function(){return t.GeoJSON.getFeature(this,{type:"Point",coordinates:t.GeoJSON.latLngToCoords(this.getLatLng())})},_svgCanvasIncludes:function(){},_project:function(){this._point=this._map.latLngToLayerPoint(this._latlng)},_update:function(){this._map&&this._updatePath()},_updatePath:function(){},setLatLng:function(e){return this._latlng=t.latLng(e),this.redraw(),this.fire("move",{latlng:this._latlng})},getLatLng:function(){return this._latlng},setSize:function(e){return this._size=e,this.redraw()},getSize:function(){return this._size}}),m=g.extend({initialize:function(e,t,i){g.prototype.initialize.call(this,e,t,i)},_updatePath:function(){this._renderer._updateCrossMarker(this)},_svgCanvasIncludes:function(){t.Canvas.include({_updateCrossMarker:function(e){var t=e._point,i=e._size/2,o=this._ctx;o.beginPath(),o.moveTo(t.x,t.y+i),o.lineTo(t.x,t.y-i),this._fillStroke(o,e),o.moveTo(t.x-i,t.y),o.lineTo(t.x+i,t.y),this._fillStroke(o,e)}}),t.SVG.include({_updateCrossMarker:function(e){var i=e._point,o=e._size/2;t.Browser.vml&&(i._round(),o=Math.round(o));var r="M"+i.x+","+(i.y+o)+"L"+i.x+","+(i.y-o)+"M"+(i.x-o)+","+i.y+"L"+(i.x+o)+","+i.y;this._setPath(e,r)}})}}),v=function(e,t,i){return new m(e,t,i)},b=g.extend({initialize:function(e,t,i){g.prototype.initialize.call(this,e,t,i)},_updatePath:function(){this._renderer._updateXMarker(this)},_svgCanvasIncludes:function(){t.Canvas.include({_updateXMarker:function(e){var t=e._point,i=e._size/2,o=this._ctx;o.beginPath(),o.moveTo(t.x+i,t.y+i),o.lineTo(t.x-i,t.y-i),this._fillStroke(o,e)}}),t.SVG.include({_updateXMarker:function(e){var i=e._point,o=e._size/2;t.Browser.vml&&(i._round(),o=Math.round(o));var r="M"+(i.x+o)+","+(i.y+o)+"L"+(i.x-o)+","+(i.y-o)+"M"+(i.x-o)+","+(i.y+o)+"L"+(i.x+o)+","+(i.y-o);this._setPath(e,r)}})}}),S=function(e,t,i){return new b(e,t,i)},L=g.extend({options:{fill:!0},initialize:function(e,t,i){g.prototype.initialize.call(this,e,t,i)},_updatePath:function(){this._renderer._updateSquareMarker(this)},_svgCanvasIncludes:function(){t.Canvas.include({_updateSquareMarker:function(e){var t=e._point,i=e._size/2,o=this._ctx;o.beginPath(),o.moveTo(t.x+i,t.y+i),o.lineTo(t.x-i,t.y+i),o.lineTo(t.x-i,t.y-i),o.lineTo(t.x+i,t.y-i),o.closePath(),this._fillStroke(o,e)}}),t.SVG.include({_updateSquareMarker:function(e){var i=e._point,o=e._size/2;t.Browser.vml&&(i._round(),o=Math.round(o));var r="M"+(i.x+o)+","+(i.y+o)+"L"+(i.x-o)+","+(i.y+o)+"L"+(i.x-o)+","+(i.y-o)+"L"+(i.x+o)+","+(i.y-o);r+=t.Browser.svg?"z":"x",this._setPath(e,r)}})}}),x=function(e,t,i){return new L(e,t,i)},I=g.extend({options:{fill:!0},initialize:function(e,t,i){g.prototype.initialize.call(this,e,t,i)},_updatePath:function(){this._renderer._updateDiamondMarker(this)},_svgCanvasIncludes:function(){t.Canvas.include({_updateDiamondMarker:function(e){var t=e._point,i=e._size/2,o=this._ctx;o.beginPath(),o.moveTo(t.x,t.y+i),o.lineTo(t.x-i,t.y),o.lineTo(t.x,t.y-i),o.lineTo(t.x+i,t.y),o.closePath(),this._fillStroke(o,e)}}),t.SVG.include({_updateDiamondMarker:function(e){var i=e._point,o=e._size/2;t.Browser.vml&&(i._round(),o=Math.round(o));var r="M"+i.x+","+(i.y+o)+"L"+(i.x-o)+","+i.y+"L"+i.x+","+(i.y-o)+"L"+(i.x+o)+","+i.y;r+=t.Browser.svg?"z":"x",this._setPath(e,r)}})}}),w=function(e,t,i){return new I(e,t,i)},M=_.extend({statics:{MARKERTYPES:["esriSMSCircle","esriSMSCross","esriSMSDiamond","esriSMSSquare","esriSMSX","esriPMS"]},initialize:function(e,t){if(_.prototype.initialize.call(this,e,t),t&&(this.serviceUrl=t.url),e)if("esriPMS"===e.type){var i=this.serviceUrl+"images/"+this._symbolJson.url;this._iconUrl=t&&t.token?i+"?token="+t.token:i,e.imageData&&(this._iconUrl="data:"+e.contentType+";base64,"+e.imageData),this._icons={},this.icon=this._createIcon(this._symbolJson)}else this._fillStyles()},_fillStyles:function(){this._symbolJson.outline&&this._symbolJson.size>0?(this._styles.stroke=!0,this._styles.weight=this.pixelValue(this._symbolJson.outline.width),this._styles.color=this.colorValue(this._symbolJson.outline.color),this._styles.opacity=this.alphaValue(this._symbolJson.outline.color)):this._styles.stroke=!1,this._symbolJson.color?(this._styles.fillColor=this.colorValue(this._symbolJson.color),this._styles.fillOpacity=this.alphaValue(this._symbolJson.color)):this._styles.fillOpacity=0,"esriSMSCircle"===this._symbolJson.style&&(this._styles.radius=this.pixelValue(this._symbolJson.size)/2)},_createIcon:function(e){var i=this.pixelValue(e.width),o=i;e.height&&(o=this.pixelValue(e.height));var r=i/2,s=o/2;e.xoffset&&(r+=this.pixelValue(e.xoffset)),e.yoffset&&(s+=this.pixelValue(e.yoffset));var n=t.icon({iconUrl:this._iconUrl,iconSize:[i,o],iconAnchor:[r,s]});return this._icons[e.width.toString()]=n,n},_getIcon:function(e){var t=this._icons[e.toString()];return t||(t=this._createIcon({width:e})),t},pointToLayer:function(e,i,o,r){var s=this._symbolJson.size||this._symbolJson.width;if(!this._isDefault){if(o.sizeInfo){var n=this.getSize(e,o.sizeInfo);n&&(s=n)}if(o.colorInfo){var a=this.getColor(e,o.colorInfo);a&&(this._styles.fillColor=this.colorValue(a),this._styles.fillOpacity=this.alphaValue(a))}}if("esriPMS"===this._symbolJson.type){var l=t.extend({},{icon:this._getIcon(s)},r);return t.marker(i,l)}switch(s=this.pixelValue(s),this._symbolJson.style){case"esriSMSSquare":return x(i,s,t.extend({},this._styles,r));case"esriSMSDiamond":return w(i,s,t.extend({},this._styles,r));case"esriSMSCross":return v(i,s,t.extend({},this._styles,r));case"esriSMSX":return S(i,s,t.extend({},this._styles,r))}return this._styles.radius=s/2,t.circleMarker(i,t.extend({},this._styles,r))}}),P=_.extend({statics:{LINETYPES:["esriSLSDash","esriSLSDot","esriSLSDashDotDot","esriSLSDashDot","esriSLSSolid"]},initialize:function(e,t){_.prototype.initialize.call(this,e,t),this._fillStyles()},_fillStyles:function(){if(this._styles.lineCap="butt",this._styles.lineJoin="miter",this._styles.fill=!1,this._styles.weight=0,!this._symbolJson)return this._styles;if(this._symbolJson.color&&(this._styles.color=this.colorValue(this._symbolJson.color),this._styles.opacity=this.alphaValue(this._symbolJson.color)),!isNaN(this._symbolJson.width)){this._styles.weight=this.pixelValue(this._symbolJson.width);var e=[];switch(this._symbolJson.style){case"esriSLSDash":e=[4,3];break;case"esriSLSDot":e=[1,3];break;case"esriSLSDashDot":e=[8,3,1,3];break;case"esriSLSDashDotDot":e=[8,3,1,3,1,3]}if(e.length>0){for(var t=0;t<e.length;t++)e[t]*=this._styles.weight;this._styles.dashArray=e.join(",")}}},style:function(e,t){if(!this._isDefault&&t){if(t.sizeInfo){var i=this.pixelValue(this.getSize(e,t.sizeInfo));i&&(this._styles.weight=i)}if(t.colorInfo){var o=this.getColor(e,t.colorInfo);o&&(this._styles.color=this.colorValue(o),this._styles.opacity=this.alphaValue(o))}}return this._styles}}),k=_.extend({statics:{POLYGONTYPES:["esriSFSSolid"]},initialize:function(e,t){_.prototype.initialize.call(this,e,t),e&&(this._lineStyles=o(e.outline,t).style(),this._fillStyles())},_fillStyles:function(){if(this._lineStyles)if(0===this._lineStyles.weight)this._styles.stroke=!1;else for(var e in this._lineStyles)this._styles[e]=this._lineStyles[e];this._symbolJson&&(this._symbolJson.color&&k.POLYGONTYPES.indexOf(this._symbolJson.style>=0)?(this._styles.fill=!0,this._styles.fillColor=this.colorValue(this._symbolJson.color),this._styles.fillOpacity=this.alphaValue(this._symbolJson.color)):(this._styles.fill=!1,this._styles.fillOpacity=0))},style:function(e,t){if(!this._isDefault&&t&&t.colorInfo){var i=this.getColor(e,t.colorInfo);i&&(this._styles.fillColor=this.colorValue(i),this._styles.fillOpacity=this.alphaValue(i))}return this._styles}}),z=t.Class.extend({options:{proportionalPolygon:!1,clickable:!0},initialize:function(e,i){this._rendererJson=e,this._pointSymbols=!1,this._symbols=[],this._visualVariables=this._parseVisualVariables(e.visualVariables),t.Util.setOptions(this,i)},_parseVisualVariables:function(e){var t={};if(e)for(var i=0;i<e.length;i++)t[e[i].type]=e[i];return t},_createDefaultSymbol:function(){this._rendererJson.defaultSymbol&&(this._defaultSymbol=this._newSymbol(this._rendererJson.defaultSymbol),this._defaultSymbol._isDefault=!0)},_newSymbol:function(e){return"esriSMS"===e.type||"esriPMS"===e.type?(this._pointSymbols=!0,i(e,this.options)):"esriSLS"===e.type?o(e,this.options):"esriSFS"===e.type?r(e,this.options):void 0},_getSymbol:function(){},attachStylesToLayer:function(e){this._pointSymbols?e.options.pointToLayer=t.Util.bind(this.pointToLayer,this):(e.options.style=t.Util.bind(this.style,this),e._originalStyle=e.options.style)},pointToLayer:function(e,i){var o=this._getSymbol(e);return o&&o.pointToLayer?o.pointToLayer(e,i,this._visualVariables,this.options):t.circleMarker(i,{radius:0,opacity:0})},style:function(e){var t;this.options.userDefinedStyle&&(t=this.options.userDefinedStyle(e));var i=this._getSymbol(e);return i?this.mergeStyles(i.style(e,this._visualVariables),t):this.mergeStyles({opacity:0,fillOpacity:0},t)},mergeStyles:function(e,t){var i,o={};for(i in e)e.hasOwnProperty(i)&&(o[i]=e[i]);if(t)for(i in t)t.hasOwnProperty(i)&&(o[i]=t[i]);return o}}),T=z.extend({initialize:function(e,t){z.prototype.initialize.call(this,e,t),this._createSymbol()},_createSymbol:function(){this._rendererJson.symbol&&this._symbols.push(this._newSymbol(this._rendererJson.symbol))},_getSymbol:function(){return this._symbols[0]}}),D=z.extend({initialize:function(e,t){z.prototype.initialize.call(this,e,t),this._field=this._rendererJson.field,this._rendererJson.normalizationType&&"esriNormalizeByField"===this._rendererJson.normalizationType&&(this._normalizationField=this._rendererJson.normalizationField),this._createSymbols()},_createSymbols:function(){var e,t=this._rendererJson.classBreakInfos;this._symbols=[];for(var i=t.length-1;i>=0;i--)e=this.options.proportionalPolygon&&this._rendererJson.backgroundFillSymbol?this._newSymbol(this._rendererJson.backgroundFillSymbol):this._newSymbol(t[i].symbol),e.val=t[i].classMaxValue,this._symbols.push(e);this._symbols.sort(function(e,t){return e.val>t.val?1:-1}),this._createDefaultSymbol(),this._maxValue=this._symbols[this._symbols.length-1].val},_getSymbol:function(e){var t=e.properties[this._field];if(this._normalizationField){var i=e.properties[this._normalizationField];if(isNaN(i)||0===i)return this._defaultSymbol;t/=i}if(t>this._maxValue)return this._defaultSymbol;for(var o=this._symbols[0],r=this._symbols.length-1;r>=0&&!(t>this._symbols[r].val);r--)o=this._symbols[r];return o}}),J=z.extend({initialize:function(e,t){z.prototype.initialize.call(this,e,t),this._field=this._rendererJson.field1,this._createSymbols()},_createSymbols:function(){for(var e,t=this._rendererJson.uniqueValueInfos,i=t.length-1;i>=0;i--)e=this._newSymbol(t[i].symbol),e.val=t[i].value,this._symbols.push(e);this._createDefaultSymbol()},_getSymbol:function(e){var t=e.properties[this._field];if(this._rendererJson.fieldDelimiter&&this._rendererJson.field2){var i=e.properties[this._rendererJson.field2];if(i){t+=this._rendererJson.fieldDelimiter+i;var o=e.properties[this._rendererJson.field3];o&&(t+=this._rendererJson.fieldDelimiter+o)}}for(var r=this._defaultSymbol,s=this._symbols.length-1;s>=0;s--)this._symbols[s].val==t&&(r=this._symbols[s]);return r}});t.esri.FeatureLayer.addInitHook(function(){if(!this.options.ignoreRenderer){var e=t.Util.bind(this.onAdd,this),i=t.Util.bind(this.unbindPopup,this),o=t.Util.bind(this.onRemove,this);t.Util.bind(this.createNewLayer,this),this.onAdd=function(t){this.metadata(function(i,o){if(i)return void console.warn("failed to load metadata from the service.");if(o&&o.drawingInfo){if(this.options.drawingInfo){var r=o;r.drawingInfo=this.options.drawingInfo,this._setRenderers(r)}else this._setRenderers(o);this._setRenderers(o),e(t),this._addPointLayer(t)}},this)},this.onRemove=function(e){if(o(e),this._pointLayer){var t=this._pointLayer.getLayers();for(var i in t)e.removeLayer(t[i])}},this.unbindPopup=function(){if(i(),this._pointLayer){var e=this._pointLayer.getLayers();for(var t in e)e[t].unbindPopup()}},this._addPointLayer=function(e){this._pointLayer&&(this._pointLayer.addTo(e),this._pointLayer.bringToFront())},this._createPointLayer=function(){if(!this._pointLayer&&(this._pointLayer=t.geoJson(),this._pointLayerIds={},this._popup)){var e=function(e,t){t.bindPopup(this._popup(e,t),this._popupOptions)};this._pointLayer.options.onEachFeature=t.Util.bind(e,this)}},this.createNewLayer=function(e){var i=t.GeoJSON.geometryToLayer(e,this.options);if(this._hasProportionalSymbols){var o=this.getPolygonCentroid(e.geometry.coordinates);if(!isNaN(o[0])&&!isNaN(o[0])){this._createPointLayer();var r=e.id.toString();if(!this._pointLayerIds[r]){var s=this.getPointJson(e,o);this._pointLayer.addData(s),this._pointLayerIds[r]=!0}this._pointLayer.bringToFront()}}return i},this.getPolygonCentroid=function(e){var t=e[0][0];2===t.length&&(t=e[0]);for(var i,o,r,s=0,n=0,a=0,l=t.length,h=0,u=l-1;h<l;u=h++)i=t[h],o=t[u],s+=i[0]*o[1],s-=i[1]*o[0],r=i[0]*o[1]-o[0]*i[1],n+=(i[0]+o[0])*r,a+=(i[1]+o[1])*r;return r=3*s,[n/r,a/r]},this.getPointJson=function(e,t){return{type:"Feature",properties:e.properties,id:e.id,geometry:{type:"Point",coordinates:[t[0],t[1]]}}},this._checkForProportionalSymbols=function(e,t){if(this._hasProportionalSymbols=!1,"esriGeometryPolygon"===e&&(t.backgroundFillSymbol&&(this._hasProportionalSymbols=!0),t.classBreakInfos&&t.classBreakInfos.length)){var i=t.classBreakInfos[0].symbol;!i||"esriSMS"!==i.type&&"esriPMS"!==i.type||(this._hasProportionalSymbols=!0)}},this._setRenderers=function(e){var t,i=e.drawingInfo.renderer,o={url:this.options.url};switch(this.options.token&&(o.token=this.options.token),this.options.pane&&(o.pane=this.options.pane),e.drawingInfo.transparency&&(o.layerTransparency=e.drawingInfo.transparency),this.options.style&&(o.userDefinedStyle=this.options.style),i.type){case"classBreaks":if(this._checkForProportionalSymbols(e.geometryType,i),this._hasProportionalSymbols){this._createPointLayer();var r=n(i,o);r.attachStylesToLayer(this._pointLayer),o.proportionalPolygon=!0}t=n(i,o);break;case"uniqueValue":t=a(i,o);break;default:t=s(i,o)}t.attachStylesToLayer(this)},this.metadata(function(e,t){e||(t&&t.drawingInfo&&(this.options.drawingInfo&&(t.drawingInfo=this.options.drawingInfo),this._setRenderers(t)),this._alreadyAdded&&this.setStyle(this._originalStyle))},this)}});var C=t.GeoJSON.extend({options:{data:{},opacity:1,renderer:{}},initialize:function(e,i){t.setOptions(this,i),this.data=this.options.data,this.opacity=this.options.opacity,this.renderer=this.options.renderer,this._layers={};var o,r;if(e)for(o=0,r=e.length;o<r;o++)this.addLayer(e[o]);"string"==typeof this.data?this._getFeatureCollection(this.data):this._parseFeatureCollection(this.data)},_getFeatureCollection:function(e){var i="https://www.arcgis.com/sharing/rest/content/items/"+e+"/data";t.esri.request(i,{},function(e,t){e?console.log(e):this._parseFeatureCollection(t)},this)},_parseFeatureCollection:function(e){var t=e.layers[0].featureSet.features,i=e.layers[0].layerDefinition.geometryType,o=this._featureCollectionToGeoJSON(t,i);this._setRenderers(e.layers[0].layerDefinition),this.addData(o)},_featureCollectionToGeoJSON:function(e,i){var o,r,s={type:"FeatureCollection",features:[]},n=[];for(o=0,r=e.length;o<r;o++){var a,l,h,u,p;if("esriGeometryPoint"===i)l=t.Projection.SphericalMercator.unproject(t.point(e[o].geometry.x,e[o].geometry.y)),h=[l.lng,l.lat],a={type:"Feature",geometry:{type:"Point",coordinates:h},properties:e[o].attributes};else if("esriGeometryMultipoint"===i){var y,c=[];for(u=0,y=e[o].geometry.points.length;u<y;u++)l=t.Projection.SphericalMercator.unproject(t.point(e[o].geometry.points[u][0],e[o].geometry.points[u][1])),h=[l.lng,l.lat],c.push(h);a={type:"Feature",geometry:{type:"MultiPoint",coordinates:c},properties:e[o].attributes}}else if("esriGeometryPolyline"===i){var f,d,_=[];for(u=0,d=e[o].geometry.paths.length;u<d;u++){var g=[];for(p=0,f=e[o].geometry.paths[u].length;p<f;p++)l=t.Projection.SphericalMercator.unproject(t.point(e[o].geometry.paths[u][p][0],e[o].geometry.paths[u][p][1])),h=[l.lng,l.lat],g.push(h);_.push(g)}a={type:"Feature",geometry:{type:"MultiLineString",coordinates:_},properties:e[o].attributes}}else if("esriGeometryPolygon"===i){var m,v,b=[];for(u=0,v=e[o].geometry.rings.length;u<v;u++){var S=[];for(p=0,m=e[o].geometry.rings[u].length;p<m;p++)l=t.Projection.SphericalMercator.unproject(t.point(e[o].geometry.rings[u][p][0],e[o].geometry.rings[u][p][1])),h=[l.lng,l.lat],S.push(h);b.push(S)}a={type:"Feature",geometry:{type:"MultiPolygon",coordinates:b},properties:e[o].attributes}}n.push(a)}return s.features=n,s},_checkForProportionalSymbols:function(e,t){if(this._hasProportionalSymbols=!1,"esriGeometryPolygon"===e&&(t.backgroundFillSymbol&&(this._hasProportionalSymbols=!0),t.classBreakInfos&&t.classBreakInfos.length)){var i=t.classBreakInfos[0].symbol;!i||"esriSMS"!==i.type&&"esriPMS"!==i.type||(this._hasProportionalSymbols=!0)}},_setRenderers:function(e){var t,i=this.renderer,o={};switch(this.options.pane&&(o.pane=this.options.pane),e.drawingInfo.transparency&&(o.layerTransparency=e.drawingInfo.transparency),this.options.style&&(o.userDefinedStyle=this.options.style),i.type){case"classBreaks":if(this._checkForProportionalSymbols(e.geometryType,i),this._hasProportionalSymbols){this._createPointLayer();var r=n(i,o);r.attachStylesToLayer(this._pointLayer),o.proportionalPolygon=!0}t=n(i,o);break;case"uniqueValue":console.log(i,o),t=a(i,o);break;default:t=s(i,o)}t.attachStylesToLayer(this)}}),F=t.Marker.extend({options:{properties:{},labelingInfo:{},offset:[0,0]},initialize:function(e,i){t.setOptions(this,i),this._latlng=t.latLng(e);var o=this._createLabelText(this.options.properties,this.options.labelingInfo);this._setLabelIcon(o,this.options.offset)},_createLabelText:function(e,t){var i=/\[([^\]]*)\]/g,o=t[0].labelExpression;return o=o.replace(i,function(t){var o=i.exec(t);return e[o[1]]})},_setLabelIcon:function(e,i){var o=t.divIcon({iconSize:null,className:"esri-leaflet-webmap-labels",html:"<div>"+e+"</div>",iconAnchor:i});this.setIcon(o)}}),V=t.Evented.extend({options:{map:{},token:null},initialize:function(e,i){t.setOptions(this,i),this._map=this.options.map,this._token=this.options.token,this._webmapId=e,this._loaded=!1,this._metadataLoaded=!1,this.layers=[],this.title="",this.bookmarks=[],this.portalItem={},this.VERSION=d,this._loadWebMapMetaData(e),this._loadWebMap(e)},_loadWebMapMetaData:function(e){var i=this._map,o=this,r="https://www.arcgis.com/sharing/rest/content/items/"+e;t.esri.request(r,{},function(e,t){e?console.log(e):(console.log("WebMap MetaData: ",t),o.portalItem=t,o.title=t.title,o._metadataLoaded=!0,o.fire("metadataLoad"),i.fitBounds([t.extent[0].reverse(),t.extent[1].reverse()]))})},_loadWebMap:function(e){var i=this._map,o=this.layers,r="https://www.arcgis.com/sharing/rest/content/items/"+e+"/data";t.esri.request(r,{},function(e,r){e?console.log(e):(console.log("WebMap: ",r),r.baseMap.baseMapLayers.map(function(e){var t=p(e,o,i).addTo(i);void 0!==t&&e.visibility===!0&&t.addTo(i)}),r.operationalLayers.map(function(e){var t=p(e,o,i);void 0!==t&&e.visibility===!0&&t.addTo(i)}),void 0!==r.bookmarks&&r.bookmarks.length>0&&r.bookmarks.map(function(e){var i=t.Projection.SphericalMercator.unproject(t.point(e.extent.xmax,e.extent.ymax)),o=t.Projection.SphericalMercator.unproject(t.point(e.extent.xmin,e.extent.ymin)),r=t.latLngBounds(o,i);this.bookmarks.push({name:e.name,bounds:r})}.bind(this)),this._loaded=!0,this.fire("load"))}.bind(this))}});e.WebMap=V,e.webMap=f,e.operationalLayer=p,e.FeatureCollection=C,e.featureCollection=l,e.LabelMarker=F,e.labelMarker=h,e.createPopupContent=u,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=esri-leaflet-webmap.js.map