/*! Qoopido.demand 1.0.2, 2015-09-08 | https://github.com/dlueth/qoopido.demand | (c) 2015 Dirk Lueth */
!function(e){"use strict";function t(){var e=this||{},t=f(e,b)?e:null,n=L.call(arguments);return n.forEach(function(e,n){var r=I.path(e,t),a=r.handler,u=r.path,l=pe[a]||(pe[a]={});this[n]=l[u]||(l[u]=new x(e,t).pledge)},n),g.all(n)}function n(){var e,t,n=d(arguments[0],K)?arguments[0]:null,r=n?arguments[1]:arguments[0];if(!n&&S.current&&(e=S.current,n=e.handler+"!"+e.path),!n)throw new v("unspecified anonymous provide");return H(function(){var a,u,l,i=I.path(n),c=pe[i.handler];!e&&c[i.path]?o("duplicate found for module "+i.path):(a=new b(n,r,t||[]),u=pe[a.handler][a.path]=a.pledge,e&&(e.timeout=J(e.timeout),l=e.defered,!e.cached&&e.store(),u.then(function(){l.resolve.apply(null,arguments)},function(){l.reject(new v("unable to resolve module",n,arguments))}),S.length>0&&S.next()))}),{when:function(){t=L.call(arguments)}}}function r(e){var t,n=e.cache,r=e.debug,a=e.version,u=e.timeout,l=e.lifetime,o=e.base,i=e.pattern,c=e.probes;if(O=d(n,V)?n:O,A=d(r,V)?r:A,N=d(a,K)?a:N,m(u)&&(P=1e3*Math.min(Math.max(u,2),10),R=Math.min(Math.max(P/5,1e3),5e3)),m(l)&&(U=1e3*l),d(o,K)&&(T=fe.base=new y("",I.url(o))),h(i))for(t in i)"base"!==t&&(fe[t]=new y(t,i[t]));if(h(c))for(t in c)de[t]=c[t];return!0}function a(e,t,n){he[e]||(he[e]={suffix:t,resolve:n.resolve,modify:n.modify},pe[e]={})}function u(e,t){n(e,function(){return t})}function l(){return+new Date}function o(e){var t=f(e,v)?"error":"warn";d(console,z)||!A&&"warn"===t||console[t](e.toString())}function i(e,t){return new RegExp(e,t)}function c(e){return e.replace(re,"\\$&")}function s(e){return e.replace(le,"")}function p(e){return te.test(e)}function f(e,t){return e instanceof t}function d(e,t){return typeof e===t}function h(e){return e&&d(e,"object")}function m(e){return d(e,"number")&&isFinite(e)&&Math.floor(e)===e&&e>=0}function g(e){function t(){r(Y,arguments)}function n(){r(Z,arguments)}function r(e,t){a.state===W&&(a.state=e,a.value=t,u[e].forEach(function(e){e.apply(null,a.value)}))}var a=this,u={resolved:[],rejected:[]};a.then=function(e,t){if(a.state===W)e&&u[Y].push(e),t&&u[Z].push(t);else switch(a.state){case Y:e.apply(null,a.value);break;case Z:t.apply(null,a.value)}},e(t,n)}function v(e,t,n){var r=this;r.message=e,t&&(r.module=t),n&&(r.stack=L.call(n))}function y(e,t){var n=this;n.weight=e.length,n.url=I.url(t),n.regexPattern=i("^"+c(e)),n.regexUrl=i("^"+c(t))}function w(){var e=this;e.current=null,e.queue=[]}function x(e,t){var n,r,a=this,u=g.defer();I.path.call(a,e,t),a.defered=u,a.pledge=u.pledge,r=he[a.handler],t||a.pledge.then(null,o),r?(a.retrieve(),a.cached?S.add(a):(n=j.test(a.url)?new _:new ee,n.onprogress=function(){},n.ontimeout=n.onerror=n.onabort=function(){u.reject(new v("unable to load module",a.path))},n.onload=function(){a.timeout=J(a.timeout),a.source=n.responseText,S.add(a)},n.open("GET",a.url+r.suffix+"?rnd="+l(),!0),n.send(),a.timeout=H(function(){n.readyState<4&&n.abort()},P))):u.reject(new v('no handler "'+a.handler+'" for',a.path))}function b(e,n,r){var a=this,u=g.defer();I.path.call(a,e),(a.pledge=u.pledge).then(null,function(){o(new v("unable to resolve module",a.path,arguments))}),r.length>0?t.apply(a,r).then(function(){u.resolve(n.apply(null,arguments))},function(){u.reject(new v("unable to resolve dependencies for",a.path,arguments))}):u.resolve(n())}var j,E,S,I,k,q,M,T,O,A,P,R,N,U,D=e.document,H=e.setTimeout,J=e.clearTimeout,L=Array.prototype.slice,X=Array.prototype.concat,$=D.getElementsByTagName("head")[0],C=D.createElement("a"),B=e.localStorage,F="[demand]",G="[state]",Q="[value]",z="undefined",K="string",V="boolean",W="pending",Y="resolved",Z="rejected",_=e.XMLHttpRequest,ee="XDomainRequest"in e&&e.XDomainRequest||_,te=/^\//i,ne=/^([-\w]+\/[-\w]+)!/,re=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,ae=/\/\/#\s+sourceMappingURL\s*=\s*(.+?)\.map/g,ue=/url\(\s*(?:"|'|)(?!data:|http:|https:|\/)(.+?)(?:"|'|)\)/g,le=/^http(s?):/,oe=B&&"remainingSpace"in B,ie={cache:!0,debug:!1,version:"1.0.0",lifetime:0,timeout:5,base:"/"},ce=e.demand.main,se=e.demand.settings,pe={},fe={},de={},he={};I={url:function(e){return C.href=e,C.href},path:function(e,t){var n,r,a=this,u=e.match(ne)||"application/javascript",l=f(a,x);d(u,K)||(e=e.replace(i("^"+c(u[0])),""),u=u[1]),p(e)||(e="/"+I.url((t&&t.path&&I.url(t.path+"/../")||"/")+e).replace(j,""));for(n in fe)fe[n].matches(e)&&(!r||r.weight<fe[n].weight)&&(r=fe[n]);return l||f(a,b)?(a.handler=u,a.path=e,l&&(a.url=s(I.url(r.process(e)))),void 0):{handler:u,path:e}}},k={get:function(e,t){var n,r;if(B&&O){if(n=F+"["+e+"]",r=JSON.parse(B.getItem(n+G)),r&&r.version===N&&r.url===t&&(0===r.expires||r.expires>l))return B.getItem(n+Q);k.clear(e)}},set:function(e,t,n){var r,a;if(B&&O){r=F+"["+e+"]";try{if(a=oe?B.remainingSpace:null,B.setItem(r+Q,t),B.setItem(r+G,JSON.stringify({version:N,expires:U>0?l+U:0,url:n})),null!==a&&B.remainingSpace===a)throw"QuotaExceedError"}catch(u){o("unable to cache module "+e)}}},clear:function(e){var t,n,r,a;if(B)switch(typeof e){case K:t=F+"["+e+"]",B.removeItem(t+G),B.removeItem(t+Q);break;case V:if(e)for(n in B)r=n.match(E),r&&(a=JSON.parse(B.getItem(F+"["+r[1]+"]"+G)),a&&a.expires>0&&a.expires<=l&&k.clear(r[1]));break;case z:for(n in B)0===n.indexOf(F)&&B.removeItem(n)}}},q={resolve:function(e,t){var n=D.createElement("script");n.type="application/javascript",n.defer=n.async=!0,n.text=t,n.setAttribute("demand-path",e),$.appendChild(n)},modify:function(e,t){for(var n,r;n=ae.exec(t);)r=s(I.url(e+"/../"+n[1])),t=t.replace(n[0],"//# sourcemap="+r+".map");return t}},M={resolve:function(e,t){var r=D.createElement("style"),a=r.styleSheet;r.type="text/css",r.media="only x",a&&(a.cssText=t)||(r.innerHTML=t),r.setAttribute("demand-path",e),$.appendChild(r),H(function(){n(function(){return r})})},modify:function(e,t){for(var n,r=I.url(e+"/..");n=ue.exec(t);)t=t.replace(n[0],"url("+I.url(r+n[1])+")");return t}},g.prototype={constructor:g,state:W,value:null,listener:null,then:null},g.defer=function(){var e={};return e.pledge=new g(function(t,n){e.resolve=t,e.reject=n}),e},g.all=function(e){var t=g.defer(),n=t.pledge,r=[],a=[],u=e.length,l=0;return e.forEach(function(e,n){e.then(function(){r[n]=L.call(arguments),l++,l===u&&t.resolve.apply(null,X.apply([],r))},function(){a.push(L.call(arguments)),a.length+l===u&&t.reject.apply(null,X.apply([],a))})}),n},g.race=function(e){var t=g.defer();return e.forEach(function(e){e.then(t.resolve,t.reject)}),t.pledge},v.prototype={message:null,module:null,stack:null,toString:function(){var e=this,t=F+" "+e.message+" "+e.module;return e.stack&&(t=v.traverse(e.stack,t,1)),t}},v.traverse=function(e,t,n){var r=new Array(n+1).join(" ");return e.forEach(function(e){t+="\n"+r+"> "+e.message+" "+e.module,e.stack&&(t=v.traverse(e.stack,t,n+1))}),t},y.prototype={weight:0,url:null,regexPattern:null,regexUrl:null,matches:function(e){return this.regexPattern.test(e)},remove:function(e){return e.replace(this.regexUrl,"")},process:function(e){var t=this;return e.replace(t.regexPattern,t.url)}},w.prototype={current:null,queue:null,length:0,add:function(e){var t=this,n=t.queue;n.push(e),t.length++,1===n.length&&t.next()},next:function(){var e,t,n,r=this,a=r.current,u=r.queue;a&&(r.current=null,u.shift(),r.length--),u.length&&(a=r.current=r.queue[0],e=a.defered,t=a.path,n=he[a.handler],!a.cached&&n.modify&&(a.source=n.modify(a.url,a.source)),n.resolve(t,a.source),de[t]&&a.probe(),a.timeout=H(function(){e.reject(new v("timeout resolving module",t))},R))}},x.prototype={handler:null,path:null,url:null,defered:null,pledge:null,cached:!1,source:null,timeout:null,probe:function(){var e,t=this,r=t.path,a=t.pledge.state===W;a&&((e=de[r]())?n(function(){return e}):H(t.probe,100))},store:function(){var e=this;k.set(e.path,e.source,e.url)},retrieve:function(){var e=this,t=k.get(e.path,e.url),n=e.cached=!!t;n&&(e.source=t)}},b.prototype={handler:null,path:null,pledge:null},j=i("^"+c(I.url("/"))),E=i("^"+c(F+"[(.+?)]"+G+"$")),S=new w,k.clear(!0),a("application/javascript",".js",q),a("text/css",".css",M),r(ie)&&se&&r(se),t.configure=r,t.addHandler=a,t.clear=k.clear,e.demand=t,e.provide=n,u("/demand",t),u("/provide",n),u("/pledge",g),u("/validator/isTypeOf",d),u("/validator/isInstanceOf",f),u("/validator/isObject",h),u("/validator/isPositiveInteger",m),ce&&t(ce)}(this);
//# sourceMappingURL=demand.js.map