/*
 * ng-sharepoint
 * https://github.com/Kaldeera/ng-sharepoint/
 * Pau Codina - Kaldeera
 * Version: 0.0.1 - 2014-06-18
 * License: MIT
 */
angular.module("kld.CamlHelper",[]).value("CamlOperatorEnumerator",{CamlQueryOperator:{BeginsWith:"BeginsWith",Contains:"Contains",DateRangesOverlap:"DateRangesOverlap",Eq:"Eq",Geq:"Geq",Gt:"Gt",In:"In",Includes:"Includes",IsNotNull:"IsNotNull",IsNull:"IsNull",Leq:"Leq",Lt:"Lt",Neq:"Neq",NotIncludes:"NotIncludes"}}).provider("CamlQueryHelperProvider",function(){"use strict";var a=function(a){this.CamlQueryHelper=function(){return{Query:"",OrderByFields:"",GroupByFiels:"",Wrap:function(a,b){return"<"+a+">"+b+"</"+a+">"},Join:function(b,c,d,e,f){var g;g=f?"<FieldRef Name='"+c+"' LookupId='True' />":"<FieldRef Name='"+c+"' />";var h=b,i="";switch(b){case a.CamlQueryOperator.In:e=e.replace("[",""),e=e.replace("]","");var j=e.split(","),k="<Values>";j.forEach(function(a){var b=a.trim(),c="";c=isNaN(parseInt(b))?"<Value Type='Text'>"+b+"</Value>":"<Value Type='Integer'>"+b+"</Value>",k+=c}),k+="</Values>",i=g+k;break;case a.CamlQueryOperator.IsNull:case a.CamlQueryOperator.IsNotNull:i=g;break;default:var l="<Value Type='"+d+"'>"+e+"</Value>";i=g+l}return this.Wrap(h,i)},OrJoin:function(a,b,c,d,e){var f=this.Join(a,b,c,d,e);this.Query?(this.Query+=f,this.Query=this.Wrap("Or",this.Query)):this.Query+=f},AndJoin:function(a,b,c,d,e){var f=this.Join(a,b,c,d,e);this.Query?(this.Query+=f,this.Query=this.Wrap("And",this.Query)):this.Query+=f},AddOrderByField:function(a,b){this.OrderByFields+="<FieldRef Name='"+a+"' Ascending='"+b+"' />"},AddGroupByField:function(a){this.GroupByFiels+="<FieldRef Name='"+a+"' />"},ToString:function(){var a="",b="",c="";return this.Query&&(a=this.Wrap("Where",this.Query)),this.OrderByFields&&(b=this.Wrap("OrderBy",this.OrderByFields)),this.GroupByFiels&&(c=this.Wrap("GroupBy",this.GroupByFiels)),"<Query>"+a+c+b+"</Query>"}}}};this.$get=function(b){return new a(b)}}).provider("ODataSentencePartProvider",function(){var a=function(a){this.ODataSentencePart=function(b,c,d){return{Expression:b,Join:c,Fields:d,ProcessOk:!1,Operator:"",Left:"",Right:"",Field:"",Value:"",process:function(){if(this.testOperator(" eq ")&&this.processOperator(" eq ",a.CamlQueryOperator.Eq),this.testOperator(" ne ")&&this.processOperator(" ne ",a.CamlQueryOperator.Neq),this.testOperator(" gt ")&&this.processOperator(" gt ",a.CamlQueryOperator.Gt),this.testOperator(" ge ")&&this.processOperator(" ge ",a.CamlQueryOperator.Geq),this.testOperator(" lt ")&&this.processOperator(" lt ",a.CamlQueryOperator.Lt),this.testOperator(" le ")&&this.processOperator(" le ",a.CamlQueryOperator.Leq),this.testOperator(" lt ")&&this.processOperator(" lt ",a.CamlQueryOperator.Lt),this.testOperator(" in ")&&this.processOperator(" in ",a.CamlQueryOperator.In),this.testOperator(" contains ")&&this.processOperator(" contains ",a.CamlQueryOperator.Contains),this.testOperator(" beginswith ")&&this.processOperator(" beginswith ",a.CamlQueryOperator.Contains),this.testOperator(" isnull")&&this.processOperator(" isnull",a.CamlQueryOperator.IsNull),this.testOperator(" isnotnull")&&this.processOperator(" isnotnull",a.CamlQueryOperator.IsNotNull),!this.ProcessOk)throw"Invalid sentence: "+this.Expression;if(!this.isValidFieldInternalName(this.Fields,this.Left,this.Right)&&!this.isValidFieldInternalName(this.Fields,this.Right,this.Left))throw"Invalid sentence, any valid field vas specified ("+this.Expression+")"},isValidFieldInternalName:function(a,b,c){try{return this.Field=this.Fields.Fields[b],this.Value=c,!0}catch(d){return!1}},processOperator:function(a,b){this.Operator=b;var c=this.Expression.indexOf(a);this.Left=this.Expression.substring(0,c),this.Right=this.Expression.substring(c+a.length),this.ProcessOk=!0},testOperator:function(a){return-1==this.Expression.toLowerCase().indexOf(a)?!1:!0}}}};this.$get=function(b){return new a(b)}}).provider("ODataParserProvider",function(){var a=function(a,b){this.ODataParser=function(c){if(void 0===c)throw"fieldsSchema not specified";return{Filter:"",Sort:"",Select:"",Top:"",Paging:!1,Skip:"",Sentences:[],FieldsSchema:c,parseExpression:function(a){this.Filter="",this.Sort="",this.Select="",this.Top="",this.Skip="",this.GroupBy="",this.Paging=!1,void 0!==a.filter&&(this.Filter=a.filter),void 0!==a.orderBy&&(this.Sort=a.orderBy),void 0!==a.select&&(this.Select=a.select),void 0!==a.groupBy&&(this.GroupBy=a.groupBy),void 0!==a.top&&(this.Top=a.top),void 0!==a.paging&&(this.Paging=a.paging),void 0!==a.skip&&(this.Skip=a.skip);for(var b=this.Filter;b.length>0;){var c=this.getNextSentence(b),d=c.dataSentencePart;d.process(),b=c.expression,this.Sentences.push(d)}},getCAMLQuery:function(){var b="",c=a.CamlQueryHelper();this.Sentences.reverse();for(var d=0;d<this.Sentences.length;d++){var e=!1,f=this.Sentences[d];if("Lookup"==f.Field.get_typeAsString()||"User"==f.Field.get_typeAsString()||"LookupMulti"==f.Field.get_typeAsString()||"UserMulti"==f.Field.get_typeAsString()){var g=f.Value;g=g.replace("[",""),g=g.replace("]","");var h=g.split(",");e=isNaN(parseInt(h[0]))?!1:!0}switch(f.Join){case"or":c.OrJoin(f.Operator,f.Field.get_internalName(),f.Field.get_typeAsString(),f.Value,e);break;default:c.AndJoin(f.Operator,f.Field.get_internalName(),f.Field.get_typeAsString(),f.Value,e)}}if(this.Sort.length>0)for(var i=this.Sort.split(","),j=0;j<i.length;j++)if(""!==i[j]){var k=i[j],l=k.trim().split(" ");try{var m=this.FieldsSchema.Fields[l[0]],n=!0;l.length>1&&"desc"==l[1].trim().toLowerCase()&&(n=!1),c.AddOrderByField(m.get_internalName(),n)}catch(o){throw o}}if(void 0!==this.GroupBy&&""!==this.GroupBy)for(var p=this.GroupBy.split(","),q=0;q<p.length;q++){var r=p[q].trim();r.length>0&&c.AddGroupByField(r)}b=c.ToString();var s="";void 0!==this.Top&&""!==this.Top&&(s+="<RowLimit Paged='TRUE'>"+this.Top+"</RowLimit>");var t="";if(this.Select.length>0){t="<ViewFields>";for(var u=this.Select.split(","),v=0;v<u.length;v++){var w=u[v].trim();w.length>0&&(t+="<FieldRef Name='"+w+"' />")}t+="</ViewFields>"}return"<View>"+t+b+s+"</View>"},getNextSentence:function(a){var c=-1,d=" and ";c=a.toLowerCase().indexOf(d),-1==c&&(d=" or ",c=a.toLowerCase().indexOf(d)),-1==c&&(c=a.length,d="");var e=a.substring(0,c);a=a.substring(c+d.length);var f=b.ODataSentencePart(e,d.trim(),this.FieldsSchema),g={expression:a,dataSentencePart:f};return g}}}};this.$get=function(b,c,d){return new a(b,c,d)}}),angular.module("kld.ngSharePoint").directive("kldScroll",["SPUtils","$compile","$templateCache","$http",function(a,b,c,d){"use strict";return{restrict:"EA",replace:!0,templateUrl:"templates/scroll.html",scope:{pageSize:"@",list:"=",query:"=",results:"=",autoScroll:"=",forwardOnly:"="},compile:function(e,f){return{pre:function(a,e){f.templateUrl&&d.get(f.templateUrl,{cache:c}).success(function(c){var d=b(c)(a);e.replaceWith(d)})},post:function(b,c,d){b.autoScroll&&$(window).scroll(function(){$(window).scrollTop()+$(window).height()>=$(document).height()-150&&(b.lastPage||b.onLoading||b.loadNextPage())}),b.lastPage=!1,b.firstPage=!0,b.onLoading=!1,b.noResults=!1,b.currentPage=0,a.SharePointReady().then(function(){b.list.initContext().then(function(){b.$watch(function(){return b.query.filter},function(){b.onLoading=!0,b.noResults=!1,b.query.top=d.pageSize,b.pageInfo=void 0,b.results=[],b.lastPage=!1,b.firstPage=!0,b.currentPage=0,b.loadNextPage()},!0)})}),b.loadNextPage=function(){b.onLoading=!0,b.query.pagingInfo=b.pageInfo?b.pageInfo.get_pagingInfo():"",b.list.getListItems(b.query).then(function(a){b.forwardOnly?(angular.forEach(a,function(a){b.results.push(a)}),b.noResults=0===b.results.length?!0:!1):b.results=a,b.currentPage++,b.pageInfo=b.list.Items.get_listItemCollectionPosition(),null===b.pageInfo&&(b.lastPage=!0),b.firstPage=1==b.currentPage,b.onLoading=!1})},b.loadPreviousPage=function(){b.onLoading=!0,b.query.pagingInfo="Paged=TRUE&PagedPrev=TRUE&p_ID="+b.list.Items.get_item(0).get_id(),b.list.getListItems(b.query).then(function(a){b.results=a,b.pageInfo=b.list.Items.get_listItemCollectionPosition(),b.lastPage=!1,b.currentPage--,b.firstPage=1==b.currentPage,b.onLoading=!1})}}}}}}]),angular.module("kld.ngSharePoint").directive("kldSplist",["SPUtils","SharePoint","$compile","$templateCache","$http",function(a,b,c,d,e){return{restrict:"A",replace:!0,transclude:!0,scope:{list:"@kldSplist",web:"@spweb",query:"@"},compile:function(f,g,h){return function(f,g,i){function j(){f.SPList.getListItems(f.query).then(function(a){f.ListItems=a,i.templateUrl&&!f.templateLoaded&&e.get(i.templateUrl,{cache:d}).success(function(a){var b=c(a)(f);g.html("").append(b),f.templateLoaded=!0})},function(a){console.error(angular.toJson(a))})}a.inDesignMode()||(h(f,function(a){angular.forEach(a,function(a){g.append(a)})}),f.ListItems=[],f.SPList=b.SPList(i.kldSplist,i.spweb),"string"==typeof f.query&&(f.query=f.$eval(f.query)),f.$watch("query",function(){j()},!0))}}}}]),angular.module("kld.ngSharePoint").filter("ListItemUrl",["$location",function(a){"use strict";return function(b,c,d,e,f){var g="_layouts/copyutil.aspx?Use=id&Action="+(f||"dispform");return g+="&ItemId="+b,g+="&ListId="+e,g+="&WebId="+d,g+="&SiteId="+c,g+="&Source="+a.absUrl()}}]),angular.module("kld.ngSharePoint").filter("userFormat",["kldConstants","$location",function(a,b){"use strict";return function(c){if(void 0===c)return"";if("string"==typeof c){var d=c.substring(0,c.indexOf(";#")),e=c.substring(c.indexOf(";#")+2),f=a.userProfileUrl+d+"&source="+b.absUrl();return'<a href="'+f+'">'+e+"</a>"}return""}}]),angular.module("kld.ngSharePoint",["kld.CamlHelper"]),angular.module("kld.SharePoint").value("kldConstants",{errorTemplate:"templates/error.html",userProfileUrl:"_layouts/userdisp.aspx?ID="}),angular.module("kld.ngSharePoint").provider("SharePoint",function(){"use strict";var a=function(a,b,c){this.SPList=function(d,e,f){if(void 0===d)throw"listName not specified";return{webUrl:f,ListName:d,webId:e,initContext:function(){var b=c.defer();if(this.Context&&this.List&&this.Schema)return b.resolve(this.Schema),b.promise;this.Context=this.webUrl?new SP.ClientContext(this.webUrl):new SP.ClientContext.get_current;var e="";e=void 0!==this.webId?this.Context.get_web(this.webId):this.Context.get_web(),this.ListName=this.ListName.trim(),this.ListName=this.ListName.replace("{",""),this.ListName=this.ListName.replace("}","");var f=new RegExp("^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$");this.List=f.test(this.ListName)?e.get_lists().getById(this.ListName):"userinfolist"==this.ListName?e.get_siteUserInfoList():e.get_lists().getByTitle(this.ListName);var g=a.get("SPListCache");if(void 0===g&&(g=a("SPListCache")),this.Schema=g.get(e+"."+d),void 0===this.Schema){this.ListFields=this.List.get_fields(),this.Context.load(this.ListFields);var h=this;h.Context.executeQueryAsync(Function.createDelegate(h,function(){var a=h.ListFields.getEnumerator();for(h.Schema={Fields:{}};a.moveNext();){var c=a.get_current();h.Schema.Fields[c.get_internalName()]=c}g.put(e+"."+d,h.Schema),b.resolve(h.Schema)}),Function.createDelegate(h,function(){console.error("Error al recuperar el schema!!"),b.reject()}))}else b.resolve(this.Schema);return b.promise},onError:function(a,b){var c=this,d={Code:b.get_errorCode(),Details:b.get_errorDetails(),TypeName:b.get_errorTypeName(),Value:b.get_errorValue(),message:b.get_message(),request:b.get_request(),stackTrace:b.get_stackTrace()};console.error("SPList request failed: "+d.message+"\n"+d.stackTrace),c.deferred.reject(d)},getListItems:function(a){this.deferred=c.defer();var d=this,e=a;return b.SharePointReady().then(function(){d.initContext().then(function(){var c=b.generateCamlQuery(e,d.Schema);d.Items=d.List.getItems(c);var f;a&&a.select&&(f="Include("+a.select+")"),void 0!==f?d.Context.load(d.Items,f):d.Context.load(d.Items),d.Context.executeQueryAsync(Function.createDelegate(d,function(){for(var a=[],b=this.Items.getEnumerator();b.moveNext();){var c=b.get_current();a.push(c.get_fieldValues())}d.deferred.resolve(a)}),Function.createDelegate(d,d.onError))})}),this.deferred.promise},getItemById:function(a){this.deferred=c.defer();var d=this;return b.SharePointReady().then(function(){d.initContext().then(function(){d.Item=d.List.getItemById(a),d.Context.load(d.Item),d.Context.executeQueryAsync(Function.createDelegate(d,function(){var a=d.Item.get_fieldValues();d.deferred.resolve(a)}),Function.createDelegate(d,d.onError))})}),this.deferred.promise},insertItem:function(a){this.deferred=c.defer();var d=this;return b.SharePointReady().then(function(){d.initContext();var b=new SP.ListItemCreationInformation,c=d.List.addItem(b);angular.forEach(a,function(a,b){c.set_item(b,a)}),c.update(),d.Context.load(c),d.Context.executeQueryAsync(Function.createDelegate(d,function(){d.deferred.resolve(c.get_fieldValues())}),Function.createDelegate(d,d.onError))}),this.deferred.promise},updateItem:function(a,d){this.deferred=c.defer();var e=this;return b.SharePointReady().then(function(){e.initContext(),e.Item=e.List.getItemById(a),angular.forEach(d,function(a,b){var c=e.Schema.Fields[b];c.get_readOnlyField()||"Attachments"==c.get_typeAsString()||e.Item.set_item(b,a)}),e.Item.update(),e.Context.executeQueryAsync(Function.createDelegate(e,function(){var b=e.Item.get_fieldValues();b.ID=a,e.deferred.resolve(b)}),Function.createDelegate(e,e.onError))}),this.deferred.promise},deleteItem:function(a){this.deferred=c.defer();var d=this;return b.SharePointReady().then(function(){d.initContext();var b=a;"object"==typeof a&&(b=a.ID);var c=d.List.getItemById(b);c.deleteObject(),d.Context.executeQueryAsync(Function.createDelegate(d,function(){d.deferred.resolve()}),Function.createDelegate(d,d.onError))}),this.deferred.promise}}},this.SPUser=function(){return{getCurrent:function(){var a=this;return a.def=c.defer(),a.currentUser&&console.log("Ya existe currentUser"),b.SharePointReady().then(function(){a.context=new SP.ClientContext.get_current,a.usersInfoList=a.context.get_web().get_siteUserInfoList(),a.currentUser=a.usersInfoList.getItemById(_spPageContextInfo.userId),a.context.load(a.currentUser),a.context.executeQueryAsync(Function.createDelegate(a,function(){a.def.resolve(a.currentUser.get_fieldValues())}),Function.createDelegate(a,function(b,c){console.error("Error retrieving currentUser!!"),console.error(c.get_message()),void 0===a.currentUser.get_fieldValues().Id?a.def.reject({Code:c.get_errorCode(),Details:c.get_errorDetails(),TypeName:c.get_errorTypeName,Value:c.get_errorValue(),message:c.get_message(),request:c.get_request(),stackTrace:c.get_stackTrace()}):a.def.resolve(a.currentUser.get_fieldValues())}))}),a.def.promise},getUserByLoginName:function(a){var d=this;return d.def=c.defer(),b.SharePointReady().then(function(){d.context=new SP.ClientContext.get_current,d.user=d.context.get_web().ensureUser(a),d.context.load(d.user),d.context.executeQueryAsync(Function.createDelegate(d,function(){d.def.resolve(d.user)}),Function.createDelegate(d,function(a){console.error("Error at getUserByLoginName"),d.def.reject({Code:a.get_errorCode(),Details:a.get_errorDetails(),TypeName:a.get_errorTypeName,Value:a.get_errorValue(),message:a.get_message(),request:a.get_request(),stackTrace:a.get_stackTrace()})}))}),d.def.promise},ensureUser:function(a){var d=this;return d.def=c.defer(),b.SharePointReady().then(function(){d.context=new SP.ClientContext.get_current,d.web=d.context.get_web(),d.currentUser=d.web.ensureUser(a),d.context.load(d.currentUser),d.context.executeQueryAsync(Function.createDelegate(d,function(){d.def.resolve(d.currentUser)}),Function.createDelegate(d,function(a){console.error("Error on ensureUser!!"),d.def.reject({Code:a.get_errorCode(),Details:a.get_errorDetails(),TypeName:a.get_errorTypeName,Value:a.get_errorValue(),message:a.get_message(),request:a.get_request(),stackTrace:a.get_stackTrace()})}))}),d.def.promise}}}};this.$get=function(b,c,d){return new a(b,c,d)}}),angular.module("kld.ngSharePoint").factory("SPUtils",["$q","ODataParserProvider",function(a,b){"use strict";return{inDesignMode:function(){var a=window.g_disableCheckoutInEditMode,b=document.forms[MSOWebPartPageFormName],c=b.MSOLayout_InDesignMode||b._wikiPageMode;return!!(a||c&&c.value)},SharePointReady:function(){var b=a.defer();return SP.SOD.executeOrDelayUntilScriptLoaded(function(){b.resolve()},"sp.js"),b.promise},generateCamlQuery:function(a,c){var d,e="";if(void 0===a)d=SP.CamlQuery.createAllItemsQuery();else{if("string"==typeof a)e=a;else if("object"==typeof a){var f=b.ODataParser(c);f.parseExpression(a),e=f.getCAMLQuery()}if(e&&(d=new SP.CamlQuery,d.set_viewXml(e)),a.pagingInfo){var g=new SP.ListItemCollectionPosition;g.set_pagingInfo(a.pagingInfo),d.set_listItemCollectionPosition(g)}}return d}}}]);