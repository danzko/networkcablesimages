/**
 * @file jQuery Plugin: jquery.csv-calc
 * @version 1.0.2
 * @author Yuusaku Miyazaki <toumin.m7@gmail.com>
 * @license MIT License
 */
(function(b){b.fn.csvCalc=function(c,d){return this.each(function(){new a(this,c,d);});};function a(e,c,d){this.elem=e;this.file=c;this.option=d;this.setOption();this.showCSV();this.calcTotal();}b.extend(a.prototype,{setOption:function(){this.option=b.extend({line_endings:"\n",ignore_first_line:true,ignore_last_line:true,only_integer:true},this.option);this.option.line_endings=(this.option.line_endings=="\r")?"\r":"\n";},showCSV:function(){var c=this;b.get(c.file,function(d){d=c.csvToArray.call(c,d);c.showAtHtml.call(c,d);});},csvToArray:function(d){d=d.split(this.option.line_endings);if(this.option.ignore_first_line){d.shift();}for(var c=0;c<d.length;c++){d[c]=d[c].split(",");}if(this.option.ignore_last_line){d.pop();}return d;},showAtHtml:function(h){var f=b(this.elem).find("[data-csvcalc-repeat]");var e=b(f).find("[data-csvcalc-id]").attr("data-csvcalc-cell");for(var c=0;c<h.length;c++){var j=b(f).clone();b(f).before(j);for(var i=0;i<h[c].length;i++){b(j).find('[data-csvcalc-cell="'+i+'"]').text(h[c][i]);}var d=b(j).find("[data-csvcalc-id]");b(d).attr("data-csvcalc-id",b(d).text());var g=b(j).find("[data-csvcalc-price]");b(g).attr("data-csvcalc-price",b(g).text());b(j).find("[data-csvcalc-input]").attr("name",h[c][e]);}b(f).remove();},calcTotal:function(){var c=this;b(document).on("change",b(c.elem).find("[data-csvcalc-input]"),function(h){var d=c.validateNumber.call(c,b(h.target).val());b(h.target).val(d);var e=b(h.target).parents("[data-csvcalc-repeat]");var g=b(e).find("[data-csvcalc-price]").text();b(e).find("[data-csvcalc-sum]").text(d*g).attr("data-csvcalc-sum",d*g);var f=0;b(c.elem).find("[data-csvcalc-sum]").each(function(i,k){var j=Number(b(k).attr("data-csvcalc-sum"));if(!isNaN(j)){f+=j;}});b(c.elem).find("[data-csvcalc-total]").text(f).attr("data-csvcalc-total",f);});},validateNumber:function(c){c=c.replace(/[０-９]/g,function(d){return String.fromCharCode(d.charCodeAt(0)-65248);});c=(this.option.only_integer)?parseInt(c,10):Number(c);if(isNaN(c)){c=0;}return c;}});})(jQuery);