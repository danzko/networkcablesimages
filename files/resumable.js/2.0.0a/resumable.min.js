function Resumable(opts){this.version="2.0.0";this.support=(typeof File!=="undefined"&&typeof Blob!=="undefined"&&typeof FileList!=="undefined"&&(!!Blob.prototype.slice||!!Blob.prototype.webkitSlice||!!Blob.prototype.mozSlice||false));if(!this.support){return}var $=this;$.files=[];$.defaults={chunkSize:1024*1024,forceChunkSize:false,simultaneousUploads:3,singleFile:false,fileParameterName:"file",progressCallbacksInterval:500,speedSmoothingFactor:0.1,query:{},headers:{},withCredentials:false,preprocess:null,method:"multipart",prioritizeFirstAndLastChunk:false,target:"/",testChunks:true,generateUniqueIdentifier:null,maxChunkRetries:0,chunkRetryInterval:null,permanentErrors:[404,415,500,501]};$.opts={};$.events=[];var $h={};$h.extend=function(dst){$h.each(arguments,function(obj){if(obj!==dst){$h.each(obj,function(key,value){dst[key]=value})}});return dst};$h.each=function(o,callback){if(typeof(o.length)!=="undefined"){for(var i=0;i<o.length;i++){if(callback(o[i])===false){return}}}else{for(i in o){if(o.hasOwnProperty(i)&&callback(i,o[i])===false){return}}}};$h.generateUniqueIdentifier=function(file){var custom=$.opts.generateUniqueIdentifier;if(typeof custom==="function"){return custom(file)}var relativePath=file.webkitRelativePath||file.fileName||file.name;var size=file.size;return size+"-"+relativePath.replace(/[^0-9a-zA-Z_-]/img,"")};$h.getTarget=function(params){var target=$.opts.target;if(target.indexOf("?")<0){target+="?"}else{target+="&"}return target+params.join("&")};var onDrop=function(event){event.stopPropagation();event.preventDefault();appendFilesFromFileList(event.dataTransfer.files,event)};var onDragOver=function(event){event.preventDefault()};var appendFilesFromFileList=function(fileList,event){var files=[];$h.each(fileList,function(file){if(!(!file.size&&(file.name=="."||file.fileName=="."))&&!$.getFromUniqueIdentifier($h.generateUniqueIdentifier(file))){var f=new ResumableFile($,file);if($.fire("fileAdded",f,event)){files.push(f)}}});if($.fire("filesAdded",files,event)){$h.each(files,function(file){if($.opts.singleFile&&$.files.length>0){$.removeFile($.files[0])}$.files.push(file)})}$.fire("filesSubmitted",files,event)};function ResumableFile(resumableObj,file){var $=this;$.resumableObj=resumableObj;$.file=file;$.name=file.fileName||file.name;$.size=file.size;$.relativePath=file.webkitRelativePath||$.name;$.uniqueIdentifier=$h.generateUniqueIdentifier(file);$.chunks=[];$.paused=false;$.error=false;$.averageSpeed=0;$.currentSpeed=0;$._lastProgressCallback=Date.now();$._prevUploadedSize=0;$._prevProgress=0;function measureSpeed(){var smoothingFactor=$.resumableObj.opts.speedSmoothingFactor;var timeSpan=Date.now()-$._lastProgressCallback;var uploaded=$.sizeUploaded();$.currentSpeed=Math.max((uploaded-$._prevUploadedSize)/timeSpan*1000,0);$.averageSpeed=smoothingFactor*$.currentSpeed+(1-smoothingFactor)*$.averageSpeed;$._prevUploadedSize=uploaded}$.chunkEvent=function(event,message){switch(event){case"progress":if(Date.now()-$._lastProgressCallback<$.resumableObj.opts.progressCallbacksInterval){break}measureSpeed();$.resumableObj.fire("fileProgress",$);$.resumableObj.fire("progress");$._lastProgressCallback=Date.now();break;case"error":$.error=true;$.abort();$.chunks=[];$.resumableObj.fire("fileError",$,message);$.resumableObj.fire("error",message,$);break;case"success":if($.error){return}$.resumableObj.fire("fileProgress",$);$.resumableObj.fire("progress");if($.isComplete()){$.resumableObj.fire("fileSuccess",$,message)}break;case"retry":$.resumableObj.fire("fileRetry",$);break}};$.pause=function(){$.paused=true;$.abort()};$.resume=function(){$.paused=false;$.resumableObj.upload()};$.abort=function(){$.currentSpeed=0;$.averageSpeed=0;$h.each($.chunks,function(c){if(c.status()=="uploading"){c.abort();$.resumableObj.uploadNextChunk()}})};$.cancel=function(){$.resumableObj.removeFile($)};$.retry=function(){$.bootstrap();$.resumableObj.upload()};$.bootstrap=function(){$.abort();$.error=false;$.chunks=[];$._prevProgress=0;var round=$.resumableObj.opts.forceChunkSize?Math.ceil:Math.floor;var chunks=Math.max(round($.file.size/$.resumableObj.opts.chunkSize),1);for(var offset=0;offset<chunks;offset++){$.chunks.push(new ResumableChunk($.resumableObj,$,offset))}};$.progress=function(){if($.error){return 1}var bytesLoaded=0;$h.each($.chunks,function(c){bytesLoaded+=c.progress()*(c.endByte-c.startByte)});var percent=bytesLoaded/$.size;$._prevProgress=Math.max($._prevProgress,percent>0.999?1:percent);return $._prevProgress};$.isUploading=function(){var uploading=false;$h.each($.chunks,function(chunk){if(chunk.status()=="uploading"){uploading=true;return false}});return uploading};$.isComplete=function(){var outstanding=false;$h.each($.chunks,function(chunk){var status=chunk.status();if(status=="pending"||status=="uploading"||chunk.preprocessState===1){outstanding=true;return false}});return !outstanding};$.sizeUploaded=function(){var size=0;$h.each($.chunks,function(chunk){if(chunk.status()=="success"){size+=chunk.endByte-chunk.startByte}else{size+=chunk.loaded}});return size};$.timeRemaining=function(){if(!$.averageSpeed){return 0}return Math.floor(Math.max(file.size-$.sizeUploaded(),0)/$.averageSpeed)};$.getType=function(){return $.file.type&&$.file.type.split("/")[1]};$.getExtension=function(){return $.name.substr((~-$.name.lastIndexOf(".")>>>0)+2).toLowerCase()};$.bootstrap()}function ResumableChunk(resumableObj,fileObj,offset){var $=this;$.resumableObj=resumableObj;$.fileObj=fileObj;$.fileObjSize=fileObj.size;$.offset=offset;$.tested=false;$.retries=0;$.pendingRetry=false;$.preprocessState=0;$.loaded=0;$.total=0;var chunkSize=$.resumableObj.opts.chunkSize;$.startByte=$.offset*chunkSize;$.endByte=Math.min($.fileObjSize,($.offset+1)*chunkSize);$.xhr=null;if($.fileObjSize-$.endByte<chunkSize&&!$.resumableObj.opts.forceChunkSize){$.endByte=$.fileObjSize}$.getParams=function(){return{resumableChunkNumber:$.offset+1,resumableChunkSize:$.resumableObj.opts.chunkSize,resumableCurrentChunkSize:$.endByte-$.startByte,resumableTotalSize:$.fileObjSize,resumableIdentifier:$.fileObj.uniqueIdentifier,resumableFilename:$.fileObj.name,resumableRelativePath:$.fileObj.relativePath,resumableTotalChunks:$.fileObj.chunks.length}};$.test=function(){$.xhr=new XMLHttpRequest();$.xhr.addEventListener("load",testHandler,false);$.xhr.addEventListener("error",testHandler,false);var data=prepareXhrRequest("GET");$.xhr.send(data)};$.preprocessFinished=function(){$.preprocessState=2;$.send()};$.send=function(){var preprocess=$.resumableObj.opts.preprocess;if(typeof preprocess==="function"){switch($.preprocessState){case 0:preprocess($);$.preprocessState=1;return;case 1:return;case 2:break}}if($.resumableObj.opts.testChunks&&!$.tested){$.test();return}$.loaded=0;$.total=0;$.pendingRetry=false;var func=($.fileObj.file.slice?"slice":($.fileObj.file.mozSlice?"mozSlice":($.fileObj.file.webkitSlice?"webkitSlice":"slice")));var bytes=$.fileObj.file[func]($.startByte,$.endByte);$.xhr=new XMLHttpRequest();$.xhr.upload.addEventListener("progress",progressHandler,false);$.xhr.addEventListener("load",doneHandler,false);$.xhr.addEventListener("error",doneHandler,false);var data=prepareXhrRequest("POST",$.resumableObj.opts.method,bytes);$.xhr.send(data)};$.abort=function(){var xhr=$.xhr;$.xhr=null;if(xhr){xhr.abort()}};$.status=function(){if($.pendingRetry){return"uploading"}else{if(!$.xhr){return"pending"}else{if($.xhr.readyState<4){return"uploading"}else{if($.xhr.status==200){return"success"}else{if($.resumableObj.opts.permanentErrors.indexOf($.xhr.status)>-1||$.retries>=$.resumableObj.opts.maxChunkRetries){return"error"}else{$.abort();return"pending"}}}}}};$.message=function(){return $.xhr?$.xhr.responseText:""};$.progress=function(){if($.pendingRetry){return 0}var s=$.status();switch(s){case"success":case"error":return 1;case"pending":return 0;default:return $.total>0?$.loaded/$.total:0}};function prepareXhrRequest(method,paramsMethod,blob){var query=$.resumableObj.opts.query;if(typeof query=="function"){query=query($.fileObj,$)}query=$h.extend($.getParams(),query);var target=$.resumableObj.opts.target;var data=null;if(method=="GET"||paramsMethod=="octet"){var params=[];$h.each(query,function(k,v){params.push([encodeURIComponent(k),encodeURIComponent(v)].join("="))});target=$h.getTarget(params);data=blob||null}else{data=new FormData();$h.each(query,function(k,v){data.append(k,v)});data.append($.resumableObj.opts.fileParameterName,blob)}$.xhr.open(method,target);$.xhr.withCredentials=$.resumableObj.opts.withCredentials;$h.each($.resumableObj.opts.headers,function(k,v){$.xhr.setRequestHeader(k,v)});return data}function progressHandler(event){if(event.lengthComputable){$.loaded=event.loaded;$.total=event.total}$.fileObj.chunkEvent("progress")}function testHandler(event){var status=$.status();if(status=="success"){$.tested=true;$.fileObj.chunkEvent(status,$.message());$.resumableObj.uploadNextChunk()}else{if(!$.fileObj.paused){$.tested=true;$.send()}}}function doneHandler(event){var status=$.status();if(status=="success"||status=="error"){$.fileObj.chunkEvent(status,$.message());$.resumableObj.uploadNextChunk()}else{$.fileObj.chunkEvent("retry",$.message());$.pendingRetry=true;$.abort();$.retries++;var retryInterval=$.resumableObj.opts.chunkRetryInterval;if(retryInterval!==null){setTimeout($.send,retryInterval)}else{$.send()}}}}$.on=function(event,callback){$.events.push(event.toLowerCase(),callback)};$.fire=function(event){var args=Array.prototype.slice.call(arguments);event=event.toLowerCase();var preventDefault=false;for(var i=0;i<=$.events.length;i+=2){if($.events[i]==event){preventDefault=$.events[i+1].apply($,args.slice(1))===false||preventDefault}if($.events[i]=="catchall"){preventDefault=$.events[i+1].apply(null,args)===false||preventDefault}}return !preventDefault};$.uploadNextChunk=function(){var found=false;if($.opts.prioritizeFirstAndLastChunk){$h.each($.files,function(file){if(!file.paused&&file.chunks.length&&file.chunks[0].status()=="pending"&&file.chunks[0].preprocessState===0){file.chunks[0].send();found=true;return false}if(!file.paused&&file.chunks.length>1&&file.chunks[file.chunks.length-1].status()=="pending"&&file.chunks[0].preprocessState===0){file.chunks[file.chunks.length-1].send();found=true;return false}});if(found){return true}}$h.each($.files,function(file){file.paused||$h.each(file.chunks,function(chunk){if(chunk.status()=="pending"&&chunk.preprocessState===0){chunk.send();found=true;return false}});if(found){return false}});if(found){return true}var outstanding=false;$h.each($.files,function(file){if(!file.isComplete()){outstanding=true;return false}});if(!outstanding){$.fire("complete")}return false};$.assignBrowse=function(domNodes,isDirectory,singleFile){if(typeof domNodes.length=="undefined"){domNodes=[domNodes]}$h.each(domNodes,function(domNode){var input;if(domNode.tagName==="INPUT"&&domNode.type==="file"){input=domNode}else{input=document.createElement("input");input.setAttribute("type","file");domNode.style.display="inline-block";domNode.style.position="relative";input.style.position="absolute";input.style.top=input.style.left=0;input.style.bottom=input.style.right=0;input.style.opacity=0;input.style.cursor="pointer";domNode.appendChild(input)}if(!$.opts.singleFile&&!singleFile){input.setAttribute("multiple","multiple")}if(isDirectory){input.setAttribute("webkitdirectory","webkitdirectory")}input.addEventListener("change",function(e){appendFilesFromFileList(e.target.files,e);e.target.value=""},false)})};$.assignDrop=function(domNodes){if(typeof domNodes.length=="undefined"){domNodes=[domNodes]}$h.each(domNodes,function(domNode){domNode.addEventListener("dragover",onDragOver,false);domNode.addEventListener("drop",onDrop,false)})};$.unAssignDrop=function(domNodes){if(typeof domNodes.length=="undefined"){domNodes=[domNodes]}$h.each(domNodes,function(domNode){domNode.removeEventListener("dragover",onDragOver);domNode.removeEventListener("drop",onDrop)})};$.isUploading=function(){var uploading=false;$h.each($.files,function(file){if(file.isUploading()){uploading=true;return false}});return uploading};$.upload=function(){if($.isUploading()){return}$.fire("uploadStart");for(var num=1;num<=$.opts.simultaneousUploads;num++){$.uploadNextChunk()}};$.resume=function(){$h.each($.files,function(file){file.resume()})};$.pause=function(){$h.each($.files,function(file){file.pause()})};$.cancel=function(){for(var i=$.files.length-1;i>=0;i--){$.files[i].cancel()}};$.progress=function(){var totalDone=0;var totalSize=0;$h.each($.files,function(file){totalDone+=file.progress()*file.size;totalSize+=file.size});return totalSize>0?totalDone/totalSize:0};$.addFile=function(file,event){appendFilesFromFileList([file],event)};$.addFiles=function(files,event){appendFilesFromFileList(files,event)};$.removeFile=function(file){for(var i=$.files.length-1;i>=0;i--){if($.files[i]===file){$.files.splice(i,1);file.abort()}}};$.getFromUniqueIdentifier=function(uniqueIdentifier){var ret=false;$h.each($.files,function(f){if(f.uniqueIdentifier==uniqueIdentifier){ret=f}});return ret};$.getSize=function(){var totalSize=0;$h.each($.files,function(file){totalSize+=file.size});return totalSize};$.ResumableFile=ResumableFile;$.ResumableChunk=ResumableChunk;$.opts=$h.extend({},$.defaults,opts||{})}if(typeof module!="undefined"){module.exports=Resumable};