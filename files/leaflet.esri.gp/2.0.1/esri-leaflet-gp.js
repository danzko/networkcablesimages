!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("leaflet"),require("esri-leaflet")):"function"==typeof define&&define.amd?define(["exports","leaflet","esri-leaflet"],t):t((e.L=e.L||{},e.L.esri=e.L.esri||{},e.L.esri.GP=e.L.esri.GP||{}),e.L,e.L.esri)}(this,function(e,t,s){"use strict";function i(e){return new n(e)}function o(e){return new a(e)}t="default"in t?t["default"]:t;var r="2.0.1",n=s.Task.extend({includes:t.Mixin.Events,params:{},resultParams:{},initialize:function(e){s.Task.prototype.initialize.call(this,e),this.options.path?this.options.async!==!0&&"submitJob"!==this.options.path&&(this.options.async=!1):(this.options.async=!1,this.options.path="execute",this._service.metadata(function(e,t){return e?(this.options.async=!1,void(this.options.path="execute")):("esriExecutionTypeSynchronous"===t.executionType?(this.options.async=!1,this.options.path="execute"):(this.options.async=!0,this.options.path="submitJob"),void this.fire("initialized"))},this))},setParam:function(e,t){return"boolean"==typeof t?void(this.params[e]=t):"object"!=typeof t?void(this.params[e]=t):void this._setGeometry(e,t)},setOutputParam:function(e){this.params.outputParam=e},gpAsyncResultParam:function(e,t){this.resultParams[e]=t},_setGeometry:function(e,i){var o={geometryType:"",features:[]};i instanceof t.LatLngBounds&&(o.features.push({geometry:t.esri.Util.boundsToExtent(i)}),o.geometryType=t.esri.Util.geojsonTypeToArcGIS(i.type)),i.getLatLng&&(i=i.getLatLng()),i instanceof t.LatLng&&(i={type:"Point",coordinates:[i.lng,i.lat]}),i instanceof t.GeoJSON&&(i=i.getLayers()[0].feature.geometry,o.features.push({geometry:s.Util.geojsonToArcGIS(i)}),o.geometryType=s.Util.geojsonTypeToArcGIS(i.type)),i.toGeoJSON&&(i=i.toGeoJSON()),"Feature"===i.type&&(i=i.geometry),"Point"===i.type||"LineString"===i.type||"Polygon"===i.type?(o.features.push({geometry:s.Util.geojsonToArcGIS(i)}),o.geometryType=s.Util.geojsonTypeToArcGIS(i.type)):console&&console.warn&&console.warn("invalid geometry passed as GP input. Should be an L.LatLng, L.LatLngBounds, L.Marker or GeoJSON Point Line or Polygon object"),this.params[e]=o},run:function(e,t){return this._done=!1,this.options.async!==!0?this._service.request(this.options.path,this.params,function(s,i){e.call(t,s,i&&this.processGPOutput(i),i)},this):void this._service.request(this.options.path,this.params,function(s,i){this._currentJobId=i.jobId,this.checkJob(this._currentJobId,e,t)},this)},checkJob:function(e,t,s){var i=function(){this._service.request("jobs/"+e,{},function(i,r){"esriJobSucceeded"===r.jobStatus?(this._done||(this._done=!0,this._service.request("jobs/"+e+"/results/"+this.params.outputParam,this.resultParams,function(e,i){t.call(s,e,i&&this.processAsyncOutput(i),i)},this)),window.clearInterval(o)):"esriJobFailed"===r.jobStatus&&(t.call(s,"Job Failed",null),window.clearInterval(o))},this)}.bind(this),o=window.setInterval(i,1e3*this._service.options.asyncInterval)},processGPOutput:function(e){var t={};if(this.options.async===!1)for(var i=0;i<e.results.length;i++)if(t[e.results[i].paramName],"GPFeatureRecordSetLayer"===e.results[i].dataType){var o=s.Util.responseToFeatureCollection(e.results[i].value);t[e.results[i].paramName]=o}else t[e.results[i].paramName]=e.results[i].value;else t.jobId=this._currentJobId;if(this.options.async===!0&&"GPRasterDataLayer"===e.dataType){var r=this.options.url,n=r.indexOf("GPServer"),a=r.slice(0,n)+"MapServer/";t.outputMapService=a+"jobs/"+this._currentJobId}return t},processAsyncOutput:function(e){var t={};if(t.jobId=this._currentJobId,this.options.async===!0&&"GPRasterDataLayer"===e.dataType){var i=this.options.url,o=i.indexOf("GPServer"),r=i.slice(0,o)+"MapServer/";t.outputMapService=r+"jobs/"+this._currentJobId}if("GPFeatureRecordSetLayer"===e.dataType){var n=s.Util.responseToFeatureCollection(e.value);t[e.paramName]=n}else t[e.paramName]=e.value;return t}}),a=s.Service.extend({options:{asyncInterval:1},createTask:function(){return new n(this,this.options)}});e.VERSION=r,e.Task=n,e.task=i,e.Service=a,e.service=o});
//# sourceMappingURL=esri-leaflet-gp.js.map