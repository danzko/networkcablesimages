var Genetic=Genetic||function(){"use strict";function Genetic(){this.fitness=null,this.seed=null,this.mutate=null,this.crossover=null,this.select1=null,this.select2=null,this.optimize=null,this.generation=null,this.notification=null,this.configuration={size:250,crossover:.9,mutation:.2,iterations:100,fittestAlwaysSurvives:!0,maxResults:100,webWorkers:!0,skip:0},this.userData={},this.internalGenState={},this.entities=[],this.usingWebWorker=!1,this.start=function(){function t(t){return Math.random()<=n.configuration.mutation&&n.mutate?n.mutate(Clone(t)):t}var e,n=this;for(e=0;e<this.configuration.size;++e)this.entities.push(Clone(this.seed()));for(e=0;e<this.configuration.iterations;++e){this.internalGenState={};var i=this.entities.map(function(t){return{fitness:n.fitness(t),entity:t}}).sort(function(t,e){return n.optimize(t.fitness,e.fitness)?-1:1}),r=i.reduce(function(t,e){return t+e.fitness},0)/i.length,a=Math.sqrt(i.map(function(t){return(t.fitness-r)*(t.fitness-r)}).reduce(function(t,e){return t+e},0)/i.length),s={maximum:i[0].fitness,minimum:i[i.length-1].fitness,mean:r,stdev:a},o=this.generation?this.generation(i,e,s):!0,l="undefined"!=typeof o&&!o||e==this.configuration.iterations-1;if(this.notification&&(l||0==this.configuration.skip||e%this.configuration.skip==0)&&this.sendNotification(i.slice(0,this.maxResults),e,s,l),l)break;var u=[];for(this.configuration.fittestAlwaysSurvives&&u.push(i[0].entity);u.length<n.configuration.size;)if(this.crossover&&Math.random()<=this.configuration.crossover&&u.length+1<n.configuration.size){var c=this.select2(i),f=this.crossover(Clone(c[0]),Clone(c[1])).map(t);u.push(f[0],f[1])}else u.push(t(n.select1(i)));this.entities=u}},this.sendNotification=function(t,e,n,i){var r={pop:t.map(Serialization.stringify),generation:e,stats:n,isFinished:i};this.usingWebWorker?postMessage(r):self.notification(r.pop.map(Serialization.parse),r.generation,r.stats,r.isFinished)}}var Serialization={stringify:function(t){return JSON.stringify(t,function(t,e){return e instanceof Function||"function"==typeof e?"__func__:"+e.toString():e instanceof RegExp?"__regex__:"+e:e})},parse:function(str){return JSON.parse(str,function(key,value){return"string"!=typeof value?value:0===value.lastIndexOf("__func__:",0)?eval("("+value.slice(9)+")"):0===value.lastIndexOf("__regex__:",0)?eval("("+value.slice(10)+")"):value})}},Clone=function(t){return null==t||"object"!=typeof t?t:JSON.parse(JSON.stringify(t))},Optimize={Maximize:function(t,e){return t>=e},Minimize:function(t,e){return e>t}},Select1={Tournament2:function(t){var e=t.length,n=t[Math.floor(Math.random()*e)],i=t[Math.floor(Math.random()*e)];return this.optimize(n.fitness,i.fitness)?n.entity:i.entity},Tournament3:function(t){var e=t.length,n=t[Math.floor(Math.random()*e)],i=t[Math.floor(Math.random()*e)],r=t[Math.floor(Math.random()*e)],a=this.optimize(n.fitness,i.fitness)?n:i;return a=this.optimize(a.fitness,r.fitness)?a:r,a.entity},Fittest:function(t){return t[0].entity},Random:function(t){return t[Math.floor(Math.random()*t.length)].entity},RandomLinearRank:function(t){return this.internalGenState.rlr=this.internalGenState.rlr||0,t[Math.floor(Math.random()*Math.min(t.length,this.internalGenState.rlr++))].entity},Sequential:function(t){return this.internalGenState.seq=this.internalGenState.seq||0,t[this.internalGenState.seq++%t.length].entity}},Select2={Tournament2:function(t){return[Select1.Tournament2.call(this,t),Select1.Tournament2.call(this,t)]},Tournament3:function(t){return[Select1.Tournament3.call(this,t),Select1.Tournament3.call(this,t)]},Random:function(t){return[Select1.Random.call(this,t),Select1.Random.call(this,t)]},RandomLinearRank:function(t){return[Select1.RandomLinearRank.call(this,t),Select1.RandomLinearRank.call(this,t)]},Sequential:function(t){return[Select1.Sequential.call(this,t),Select1.Sequential.call(this,t)]},FittestRandom:function(t){return[Select1.Fittest.call(this,t),Select1.Random.call(this,t)]}};return Genetic.prototype.evolve=function(config,userData){function addslashes(t){return t.replace(/[\\"']/g,"\\$&").replace(/\u0000/g,"\\0")}var k;for(k in config)this.configuration[k]=config[k];for(k in userData)this.userData[k]=userData[k];this.usingWebWorker=this.configuration.webWorkers&&"undefined"!=typeof Blob&&"undefined"!=typeof Worker&&"undefined"!=typeof window.URL&&"undefined"!=typeof window.URL.createObjectURL;var blobScript="'use strict'\n";blobScript+="var Serialization = {'stringify': "+Serialization.stringify.toString()+", 'parse': "+Serialization.parse.toString()+"};\n",blobScript+="var Clone = "+Clone.toString()+";\n",blobScript+='var Optimize = Serialization.parse("'+addslashes(Serialization.stringify(Optimize))+'");\n',blobScript+='var Select1 = Serialization.parse("'+addslashes(Serialization.stringify(Select1))+'");\n',blobScript+='var Select2 = Serialization.parse("'+addslashes(Serialization.stringify(Select2))+'");\n',blobScript+='var genetic = Serialization.parse("'+addslashes(Serialization.stringify(this))+'");\n',blobScript+="onmessage = function(e) { genetic.start(); }\n";var self=this;if(this.usingWebWorker){var blob=new Blob([blobScript]),worker=new Worker(window.URL.createObjectURL(blob));worker.onmessage=function(t){var e=t.data;self.notification(e.pop.map(Serialization.parse),e.generation,e.stats,e.isFinished)},worker.onerror=function(t){alert("ERROR: Line "+t.lineno+" in "+t.filename+": "+t.message)},worker.postMessage("")}else!function(){var onmessage;eval(blobScript),onmessage(null)}()},{create:function(){return new Genetic},Select1:Select1,Select2:Select2,Optimize:Optimize,Clone:Clone}}();"undefined"!=typeof module&&(module.exports=Genetic);
