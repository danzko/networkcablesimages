
/****
 * Grapnel.js
 * https://github.com/gregsabia/Grapnel.js 
 * 
 * @author Greg Sabia
 * @link http://gregsabia.com
 * @version 0.2.1
 * 
 * Released under MIT License. See LICENSE.txt or http://opensource.org/licenses/MIT
*/

function Grapnel(e){"use strict";var t=this,n={actions:[],listeners:[]};this.action=null;this.hook=e||":";this.value=null;this.params=[];this.anchor={"default":window.location.hash};this.version="0.2.1";this.add=function(e,r){var i=function(){var i=t.action&&e instanceof RegExp?t.anchor.get().match(e):false;if(i||e===t.action||t.anchor.get()==e){n.trigger("match",t.value,t.params,t.action);n.actions.push({name:e,handler:r});r.call(t,t.value,t.params)}return t};return i().on(["initialized","hashchange"],i)};n.trigger=function(e){var r=Array.prototype.slice.call(arguments,1);n.forEach(n.listeners,function(n){if(n.event==e)n.handler.apply(t,r)});return t};this.on=function(e,t){var r=typeof e==="string"?e.split():e;n.forEach(r,function(e){n.listeners.push({event:e,handler:t})});return this};n.map=function(e,t){if(typeof Array.prototype.map==="function")return Array.prototype.map.call(e,t);return function(e,t){var n=new Array(this.length);for(var r=0,i=this.length;r<i;r++){if(r in this)n[r]=e.call(t,this[r],r,this)}return n}.call(e,t)};n.forEach=function(e,t){if(typeof Array.prototype.forEach==="function")return Array.prototype.forEach.call(e,t);return function(e,t){for(var n=0,r=this.length;n<r;++n){e.call(t,this[n],n,this)}}.call(e,t)};n.routeRegExp=function(e,t,n,r){if(e instanceof RegExp)return e;if(e instanceof Array)e="("+e.join("|")+")";e=e.concat(r?"":"/?").replace(/\/\(/g,"(?:/").replace(/\+/g,"__plus__").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(e,n,r,i,s,o){t.push({name:i,optional:!!o});n=n||"";return""+(o?"":n)+"(?:"+(o?n:"")+(r||"")+(s||r&&"([^/.]+?)"||"([^/]+?)")+")"+(o||"")}).replace(/([\/.])/g,"\\$1").replace(/__plus__/g,"(.+)").replace(/\*/g,"(.*)");return new RegExp("^"+e+"$",n?"":"i")};this.anchor.get=function(){return window.location.hash?window.location.hash.split("#")[1]:""};this.anchor.set=function(e){window.location.hash=!e?"":e;return t};this.anchor.clear=function(){return this.set(false)};this.parse=function(){var e=this.anchor.get(),t=e.split(this.hook),r=e.match(this.hook),i=t[0],s=[],o;if(this.anchor.get().match(this.hook)){s=t.slice(1);o=s.join(r[0])}n.trigger("parse",t);return{value:o,action:i,params:s}};this.matches=function(){var e=[];n.forEach(n.actions,function(n){var r=n.name instanceof RegExp&&t.action.match(n.name);if(r||n.name===t.action){e.push(n)}});return e};this.router=function(){this.hook=/\//gi;this.get=function(e,r){var i=[];var s=new n.routeRegExp(e,i);this.add(s,function(){var e={params:{}};n.forEach(i,function(n,r){e.params[n.name]=t.params&&t.params[r]?t.params[r]:undefined});r.call(t,e)});return t};delete this.router;return n.trigger("initialized")};this.on(["initialized","hashchange"],function(){var e=this.parse();this.action=e.action;this.value=e.value;this.params=e.params;n.actions=[]});if(typeof window.onhashchange==="function")this.on("hashchange",window.onhashchange);window.onhashchange=function(){n.trigger("hashchange")};return n.trigger("initialized")}