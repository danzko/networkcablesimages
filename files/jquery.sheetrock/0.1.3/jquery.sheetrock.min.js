(function(sheetrock){if(typeof define==="function"&&define.amd){define("jquery.sheetrock",["jquery"],sheetrock)}else{sheetrock(window.jQuery)}})(function($){$.fn.sheetrock=function(options,data){options.target=(this.length)?this:false;options=_options(options);if(options){if(_def(data)&&data!==null){_data(options,data)}else{_init(options)}}return this};var _columns={},_callbackIndex=0,_error="sheetrockError",_loaded="sheetrockLoaded",_offset="sheetrockRowOffset",_init=function(options){$.fn.sheetrock.promise=$.fn.sheetrock.promise.pipe(function(){return _prefetch(options)}).pipe(function(){return _fetch(options)})},_data=function(options,data){_begin(options);_validate.call(options,data);_always.call(options)},_prefetch=function(options){var prefetch={sql:"select * limit 1",dataHandler:_columns_hash,userCallback:$.noop,target:false};if(options.sql.indexOf("%")!==-1&&!_get_columns(options)){_log("Prefetching column labels.");return _fetch($.extend({},options,prefetch))}else{return $.Deferred().resolve()}},_fetch=function(options){_begin(options);if(options.chunkSize&&options.target){options.sql+=" limit "+(options.chunkSize+1)+" offset "+options.offset;_put(options.target,_offset,options.offset+options.chunkSize)}options.callback="sheetrock_"+_callbackIndex++;var request={data:_params(options),context:options,url:$.fn.sheetrock.server,dataType:"jsonp",cache:true,jsonp:false,jsonpCallback:options.callback};_log(request,options.debug);return $.ajax(request).promise().done(_validate).fail(_fail).always(_always)},_begin=function(options){options.loading.show();$.fn.sheetrock.working++},_validate=function(data){_enumerate(data,"warnings");_enumerate(data,"errors");_log(data,this.debug);if(_has(data,"status","table")&&_has(data.table,"cols","rows")){this.dataHandler.call(_extend.call(this,data),data)}else{_fail.call(this,data)}},_fail=function(){_put(this.target,_error,1);_log("Request failed.")},_always=function(){this.loading.hide();this.userCallback(this);$.fn.sheetrock.working--},_enumerate=function(data,state){if(_has(data,state)){$.each(data[state],function(i,status){if(_has(status,"detailed_message")){_log(status.detailed_message)}else{if(_has(status,"message")){_log(status.message)}}})}},_extend=function(data){var options=this;options.parsed={};options.parsed.last=(options.chunkSize)?Math.min(data.table.rows.length,options.chunkSize):data.table.rows.length;options.parsed.loaded=(!options.chunkSize||options.parsed.last<options.chunkSize)?1:0;options.parsed.header=($.map(data.table.cols,_map_label).length)?1:0;options.parsed.labels=(options.labels&&options.labels.length===data.table.cols.length)?options.labels:$.map(data.table.cols,_map_label_letter);_put(options.target,_loaded,options.parsed.loaded);return options},_parse=function(data){var options=this;if(!options.offset&&!options.headersOff){if(options.parsed.header||!options.headers){options.target.append(options.rowHandler({num:0,cells:_arr_to_obj(options.parsed.labels)}))}}$.each(data.table.rows,function(i,obj){if(_has(obj,"c")&&i<options.parsed.last){var counter=_nat(options.offset+i+1+options.parsed.header-options.headers),objData={num:counter,cells:{}};if(counter||!options.headersOff){$.each(obj.c,function(x,cell){var style=(options.formatting)?_style(cell):false,value=(cell&&_has(cell,"v"))?options.cellHandler(cell.v):"";objData.cells[options.parsed.labels[x]]=(style)?_wrap(value,"span",style):value});options.target.append(options.rowHandler(objData))}}})},_columns_hash=function(data){var hash={};$.each(data.table.cols,function(i,col){hash[col.id]=_map_label_letter(col)});_columns[this.key+this.gid]=hash},_get_columns=function(options){if($.isEmptyObject(options.columns)){return _columns[options.key+options.gid]||false}else{return options.columns}},_options=function(options){options=$.extend({},$.fn.sheetrock.options,options);options.key=_key(options.url);options.gid=_gid(options.url);options.chunkSize=(options.target)?_nat(options.chunkSize):0;options.headers=_nat(options.headers);options.offset=(options.chunkSize)?_get(options.target,_offset):0;options.loading=_val_jquery(options.loading);if(!options.target&&options.dataHandler===_parse){return _log("No element targeted or data handler provided.")}else{if(_get(options.target,_loaded)){return _log("No more rows to load!")}else{if(_get(options.target,_error)){return _log("A previous request for this resource failed.")}else{if(!options.url){return _log("No spreadsheet URL provided.")}else{if(!options.key){return _log("Could not find a key in the provided URL.")}else{if(!options.gid){return _log("Could not find a gid in the provided URL.")}}}}}}_log(options,options.debug);return options},_params=function(options){var params={key:options.key,gid:options.gid,tqx:"responseHandler:"+options.callback};if(options.sql){params.tq=_swap(options.sql,_get_columns(options))}return params},_trim=function(str){return str.toString().replace(/^ +/,"").replace(/ +$/,"")},_nat=function(str){return Math.max(0,parseInt(str,10)||0)},_has=function(obj){for(var i=1;i<arguments.length;i++){if(!_def(obj[arguments[i]])){return false}}return true},_def=function(def){return(typeof def==="undefined")?false:true},_log=function(msg,show){show=!_def(show)||(_def(show)&&show);if(show&&window.console&&console.log){console.log(msg)}return false},_get=function(el,key){return(el.length)?$.data(el[0],key)||0:0},_put=function(el,key,val){return(el.length)?$.data(el[0],key,val)||0:0},_key=function(url){var keyRegExp=new RegExp("key=([a-z0-9-]{30,})&?","i");return(keyRegExp.test(url))?url.match(keyRegExp)[1]:false},_gid=function(url){var gidRegExp=new RegExp("gid=([0-9]+)","i");return(gidRegExp.test(url))?url.match(gidRegExp)[1]:false},_label=function(col){return(_has(col,"label"))?col.label.replace(/\s/g,""):false},_map_label=function(col){return _label(col)||null},_map_label_letter=function(col){return _label(col)||col.id},_swap=function(sql,columns){$.each(columns,function(key,val){sql=sql.replace(new RegExp("%"+val+"%","g"),key)});return sql},_val_jquery=function(ref){return(ref&&!(ref instanceof $))?$(ref):ref},_arr_to_obj=function(arr){var obj={};$.each(arr,function(i,str){obj[str]=str});return obj},_style=function(cell){return(cell&&_has(cell,"p")&&_has(cell.p,"style"))?cell.p.style:false},_output=function(row){var prop,str="",tag=(row.num)?"td":"th";for(prop in row.cells){if(_has(row.cells,prop)){str+=_wrap(row.cells[prop],tag,"")}}return _wrap(str,"tr","")},_wrap=function(str,tag,style){var attr=(style)?' style="'+style+'"':"";return"<"+tag+attr+">"+str+"</"+tag+">"};$.fn.sheetrock.options={url:"",sql:"",chunkSize:0,columns:{},labels:[],rowHandler:_output,cellHandler:_trim,dataHandler:_parse,userCallback:$.noop,loading:$(),debug:false,headers:0,headersOff:false,formatting:false};$.fn.sheetrock.server="https://spreadsheets.google.com/tq";$.fn.sheetrock.working=0;$.fn.sheetrock.promise=$.Deferred().resolve();$.fn.sheetrock.version="0.1.3"});