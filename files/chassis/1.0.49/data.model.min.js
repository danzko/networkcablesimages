/**
  * v1.0.49 generated on: Tue Jun 14 2016 18:34:55 GMT-0500 (CDT)
  * Copyright (c) 2014-2016, Ecor Ventures LLC. All Rights Reserved. See LICENSE (BSD).
  */
"use strict";window.NGN=window.NGN||{},window.NGN.DATA=window.NGN.DATA||{},window.NGN.DATA.Entity=function(e){e=e||{};var t=this;Object.defineProperties(this,{idAttribute:NGN.define(!1,!1,!1,e.idAttribute||"id"),fields:NGN.define(!1,!0,!0,e.fields||{id:{required:!0,type:String,"default":e.id||null}}),joins:NGN.define(!1,!0,!0,e.relationships||{}),virtuals:NGN.define(!1,!0,!0,e.virtuals||{}),validators:NGN.define(!1,!0,!1,{}),validation:NGN.define(!0,!0,!1,NGN.coalesce(e.validation,!0)),isNew:NGN.define(!1,!0,!1,!0),isDestroyed:NGN.define(!1,!0,!1,!1),modified:NGN._get(function(){return this.checksum!==this.benchmark}),oid:NGN.define(!1,!0,!0,e[this.idAttribute]||null),id:{enumerable:!0,get:function(){return this.oid},set:function(e){this.oid=e}},autoid:NGN.define(!0,!1,!1,NGN.coalesce(e.autoid,!1)),checksum:NGN._get(function(){return NGN.DATA.util.checksum(JSON.stringify(this.data))}),benchmark:NGN.define(!1,!0,!1,null),setUnmodified:NGN.define(!1,!1,!1,function(){this.benchmark=this.checksum,this.changelog=[],this.emit("reset")}),allowInvalidSave:NGN.define(!1,!0,!1,NGN.coalesce(e.allowInvalidSave,!1)),disableDataValidation:NGN.define(!1,!0,!1,NGN.coalesce(e.disableDataValidation,!1)),invalidDataAttributes:NGN.define(!1,!0,!1,[]),initialDataAttributes:NGN.define(!1,!0,!1,[]),changelog:NGN.define(!1,!0,!1,[]),_nativeValidators:NGN.define(!1,!1,!1,{min:function(e,t){return t instanceof Array?t.length>=e:t instanceof Number?t>=e:t instanceof String?t.trim().length>=e:t instanceof Date?t.parse()>=e.parse():!1},max:function(e,t){return t instanceof Array?t.length<=e:t instanceof Number?e>=t:t instanceof String?t.trim().length<=e:t instanceof Date?t.parse()<=e.parse():!1},"enum":function(e,t){return e.indexOf(t)>=0},required:function(e){return this.hasOwnProperty(e)}}),_dataMap:NGN.define(!0,!0,!1,e.dataMap||null),_reverseDataMap:NGN.define(!0,!0,!1,null),dataMap:{get:function(){return this._dataMap},set:function(e){this._dataMap=e,this._reverseDataMap=null}},reverseMap:NGN._get(function(){if(null!==this.dataMap){if(null!==this._reverseDataMap)return this._reverseDataMap;var e={};return Object.keys(this._dataMap).forEach(function(i){e[t._dataMap[i]]=i}),this._reverseDataMap=e,e}return null}),raw:NGN.define(!1,!0,!1,{}),rawjoins:NGN.define(!1,!0,!1,{}),_store:NGN.define(!1,!0,!1,null),datastore:NGN._get(function(){return this._store}),addValidator:NGN.define(!0,!1,!1,function(e,t){if(!this.hasOwnProperty(e))return void console.warn("No validator could be create for "+e.toUpperCase()+". It is not an attribute of "+this.type.toUpperCase()+".");switch(typeof t){case"function":this.validators[e]=this.validators[e]||[],this.validators[e].push(t),this.emit("validator.add",e);break;case"object":Array.isArray(t)?(this.validators[e]=this.validators[e]||[],this.validators[e].push(function(e){return t.indexOf(e)>=0}),this.emit("validator.add",e)):t.test?(this.validators[e]=this.validators[e]||[],this.validators[e].push(function(e){return t.test(e)}),this.emit("validator.add",e)):console.warn("No validator could be created for "+e.toUpperCase()+". The validator appears to be invalid.");break;case"string":case"number":case"date":this.validators[e]=this.validators[e]||[],this.validators[e].push(function(e){return e===t}),this.emit("validator.add",e);break;default:console.warn("No validator could be create for "+e.toUpperCase()+". The validator appears to be invalid.")}}),removeValidator:NGN.define(!0,!1,!1,function(e){this.validators.hasOwnProperty(e)&&(delete this.validators[e],this.emit("validator.remove",e))}),validate:NGN.define(!0,!1,!1,function(e){var i=!0;if(e&&this.validators.hasOwnProperty(e)){for(r=0;r<this.validators[e].length;r++)if(!t.validators[e][r](t[e]))return t.invalidDataAttributes.indexOf(e)<0&&t.invalidDataAttributes.push(e),!1;return!0}for(var a in this.validators)if(this[a]&&this.validators.hasOwnProperty(a)){for(var n=!0,r=0;r<this.validators[a].length&&(n=this.validators[a][r](this[a]),n);r++);!n&&this.invalidDataAttributes.indexOf(a)<0&&this.invalidDataAttributes.push(a),i&&!n&&(i=!1)}return!0}),valid:NGN._get(function(){return 0===this.invalidDataAttributes.length}),relationships:NGN._get(function(){return Object.keys(this.joins)}),getRelationshipField:NGN.define(!0,!1,!1,function(e){return this.joins[e]}),hasRelationship:NGN.define(!0,!1,!1,function(e){return this.joins.hasOwnProperty(e)}),datafields:NGN._get(function(){return Object.keys(this.fields)}),getDataField:NGN.define(!0,!1,!1,function(e){return this.fields[e]}),hasDataField:NGN.define(!0,!1,!1,function(e){return this.fields.hasOwnProperty(e)}),virtualdatafields:NGN._get(function(){return Object.keys(this.virtuals)}),data:NGN._get(function(){var e=this.serialize();return!e.hasOwnProperty(this.idAttribute)&&this.autoid&&(e[this.idAttribute]=this[this.idAttribute]),this.dataMap&&Object.keys(this.dataMap).forEach(function(i){e.hasOwnProperty(i)&&(e[i]instanceof NGN.DATA.Model?e[t.dataMap[i]]=e[i].data:e[t.dataMap[i]]=e[i],delete e[i])}),e}),serialize:NGN.define(!1,!1,!1,function(e){var i=e||this.raw,a={};for(var n in i)if(i.nonEnumerableProperties=i.nonEnumerableProperties||"",this.fields.hasOwnProperty(n)&&(n="id"===n?this.idAttribute:n,i.hasOwnProperty(n)&&i.nonEnumerableProperties.indexOf(n)<0&&/^[a-z0-9 ]$/.test(n.substr(0,1))||void 0!==i[n]&&i.enumerableProperties.indexOf(n)>=0)){var r=Object.getOwnPropertyDescriptor(i,n);if(!r.set)switch(typeof r.value){case"function":"Date"===r.value.name?a[n]=i[n].refs.toJSON():"RegExp"===r.value.name&&(a[n]=r.value());break;case"object":i[n]instanceof Array&&!Array.isArray(i[n])&&(i[n]=i[n].slice(0)),a[n]=i[n];break;default:a[n]=i[n]}}return this.relationships.forEach(function(e){a[e]=t[e].data}),a}),addField:NGN.define(!0,!1,!1,function(e,i,a){if("boolean"==typeof i&&(a=i,i=null),a=void 0!==a?a:!1,"id"!==e.toLowerCase()){if("object"==typeof e){if(!e.name)throw new Error("Cannot create data field. The supplied configuration does not contain a unique data field name.");var n=e;e=n.name,delete n.name}if(void 0!==t[e]&&(console.warn(e+" data field defined multiple times. Only the last defintion will be used."),delete t[e]),t.fields[e]=n||t.fields[e]||{},t.fields[e].required=NGN.coalesce(t.fields[e].required,!1),t.fields[e].type=NGN.coalesce(t.fields[e].type,String),e===t.idAttribute&&t.autoid===!0?(t.fields[e].type=String,t.fields[e]["default"]=NGN.DATA.util.GUID()):t.fields[e]["default"]=t.fields[e]["default"]||null,t.raw[e]=t.fields[e]["default"],t[e]=t.raw[e],Object.defineProperty(t,e,{get:function(){return t.raw[e]},set:function(i){var a=t.raw[e];t.raw[e]=i;var n={action:"update",field:e,old:a,"new":t.raw[e]};this.changelog.push(n),this.emit("field.update",n),t.validate(e)||t.emit("field.invalid",{field:e})}}),!a){var r={action:"create",field:e};this.changelog.push(r),this.emit("field.create",r)}t.fields.hasOwnProperty(e)&&(t.fields[e].hasOwnProperty("pattern")&&t.addValidator(e,t.fields[e].pattern),["min","max","enum"].forEach(function(i){t.fields[e].hasOwnProperty(i)&&t.addValidator(e,function(a){return t._nativeValidators[i](t.fields[e],a)})}),t.fields[e].hasOwnProperty("required")&&t.fields[e].required&&t.addValidator(e,function(e){return t._nativeValidators.required(e)}),t.fields[e].hasOwnProperty("validate")&&("function"==typeof t.fields[e]?t.addValidator(e,function(i){return t.fields[e](i)}):console.warn("Invalid custom validation function. The value passed to the validate attribute must be a function.")))}else null===t.id&&t.autoid&&(t.id=NGN.DATA.util.GUID())}),addVirtual:NGN.define(!0,!1,!1,function(e,i){Object.defineProperty(this,e,NGN._get(function(){return i.apply(t)}))}),addRelationshipField:NGN.define(!0,!1,!1,function(e,t,i){if(i=void 0!==i?i:!1,this.rawjoins.hasOwnProperty(e)||this.fields.hasOwnProperty(e)||this.hasOwnProperty(e))throw new Error(e+" already exists. It cannot be added to the model again.");if(("function"==typeof t||"object"==typeof t&&!t.hasOwnProperty("ref"))&&(t={ref:t}),!t.ref)throw new Error("Configuration has no reference! The reference must be an NGN.DATA.Model or NGN.DATA.Store.");t.required=NGN.coalesce(t.required,!0),t["default"]=t["default"]||null;var a=this;if(t.ref.prototype?this.rawjoins[e]=null!==t["default"]?new t.ref(t["default"]):new t.ref:t.ref.model&&(this.rawjoins[e]=t.ref,this.rawjoins[e].hasOwnProperty("proxy")&&(this.rawjoins[e].on("record.create",function(t){var i=a[e].data;i.pop();var n={action:"update",field:e,join:!0,old:i,"new":a[e].data};a.emit("field.update",n)}),this.rawjoins[e].on("record.update",function(t,i){var n={action:"update",field:e+"."+i.field,join:!0,old:i.old,"new":i["new"]};a.emit("field.update",n)}),this.rawjoins[e].on("record.delete",function(t){var i=a[e].data;i.push(t.data);var n={action:"update",field:e,join:!0,old:i,"new":a[e].data};a.emit("field.update",n)}))),Object.defineProperty(this,e,{enumerable:!0,get:function(){return a.rawjoins[e]}}),!i){var n={action:"create",field:e};this.changelog.push(n),this.emit("relationship.create",n)}}),removeField:NGN.define(!0,!1,!1,function(e){if(this.raw.hasOwnProperty(e)){var t=this.raw[e];delete this[e],delete this.fields[e],delete this.raw[e],this.invalidDataAttributes.indexOf(e)>=0&&this.invalidDataAttributes.splice(this.invalidDataAttributes.indexOf(e),1);var i={action:"delete",field:e,old:t};this.emit("field.remove",i),this.changelog.push(i)}}),removeVirtual:NGN.define(!0,!1,!1,function(e){delete this[e]}),removeRelationshipField:NGN.define(!0,!1,!1,function(e,t){if(t=void 0!==t?t:!1,this.joins.hasOwnProperty(e)){var i=this.rawjoins[e];if(delete this.rawjoins[e],delete this[e],delete this.joins[e],!t){var a={action:"delete",field:e,old:i,join:!0};this.changelog.push(a),this.emit("relationship.remove",a)}}}),history:NGN._get(function(){return this.changelog.reverse()}),undo:NGN.define(!0,!1,!1,function(e){e=e||1;var i=this.changelog.splice(this.changelog.length-e,e);i.reverse().forEach(function(e){if("boolean"==typeof e.join?e.join:!1)switch(e.action){case"create":t.removeRelationshipField(e.field);break;case"delete":t.addRelationshipField(e.field),t[e.field]=e.old}else switch(e.action){case"update":t[e.field]=e.old;break;case"create":t.removeField(e.field);break;case"delete":t.addField(e.field),t[e.field]=t.old}})}),load:NGN.define(!0,!1,!1,function(e){e=e||{},null!==this._dataMap&&Object.keys(this.reverseMap).forEach(function(i){e.hasOwnProperty(i)&&(e[t.reverseMap[i]]=e[i],delete e[i])}),Object.keys(e).forEach(function(i){if(t.fields.hasOwnProperty(i))t.raw.hasOwnProperty(i)?t.raw[i]=e[i]:i===t.idAttribute&&(t.id=e[i]);else if(t.joins.hasOwnProperty(i)){var a=new t.getRelated(i).type();a.load(e[i]),t.rawjoin[i]=a}else console.warn(i+" was specified as a data field but is not defined in the model.")}),this.setUnmodified()})});var i=this.datafields.concat(this.virtualdatafields).concat(this.relationships).filter(function(e,t,i){return i.indexOf(e)!==t});if(i.length>0)throw new Error("Duplicate field names exist: "+i.join(", ")+". Unique fieldnames are required for data fields, virtuals, and relationship fields.");this.fields.hasOwnProperty("id")||(e.fields.id={required:!0,type:String,"default":e.id||null}),Object.keys(this.fields).forEach(function(e){t.addField(e,!0)}),Object.keys(this.virtuals).forEach(function(e){Object.defineProperty(t,e,NGN._get(function(){return t.virtuals[e].apply(t)}))}),Object.keys(this.joins).forEach(function(e){t.addRelationshipField(e,t.joins[e],!0)}),this.setUnmodified()},window.NGN.DATA.Model=function(e){var t=function(t){this.constructor(e),t&&this.load(t)};return NGN.DATA.util.inherit(NGN.DATA.Entity,t),t},NGN.DATA.util.inherit(NGN.DATA.util.EventEmitter,NGN.DATA.Entity);