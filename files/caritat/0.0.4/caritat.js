!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("lodash")):"function"==typeof define&&define.amd?define(["exports","lodash"],e):e(t.caritat=t.caritat||{},t._)}(this,function(t,e){"use strict";function n(t,n){var r=e.every(t,function(t){return e.isString(t)?!0:!(!e.isArray(t)||!e.every(t,e.isString))});if(!r)throw new TypeError("Invalid votes.");this.votes=e.cloneDeep(t),this.ranks=a(t),this.candidates=e.uniq(t),this.count=n||1}function a(t){var n;return n=e.reduce(t,function(t,n,a){return e.isString(n)?(t[n]=a,t):e.isArray(n)?(e.forEach(n,function(e){t[e]=a}),t):void 0},Object.create(null))}function r(t){t=e.defaults(t,{allowTies:!1,minSeats:0,maxSeats:1/0}),t.ballots?this.ballots=e.cloneDeep(t.ballots):this.ballots=[],t.candidates&&Object.defineProperty(this,"_providedCandidates",{value:e.cloneDeep(t.candidates),enumerable:!1,writable:!1,configurable:!1}),Object.defineProperty(this,"allowTies",{value:t.allowTies,enumerable:!0,writable:!1,configurable:!1}),Object.defineProperty(this,"minSeats",{value:t.minSeats,enumerable:!0,writable:!1,configurable:!1}),Object.defineProperty(this,"maxSeats",{value:t.maxSeats,enumerable:!0,writable:!1,configurable:!1})}function i(t,n){var a=t.count||1,r=t.ranks,i=Object.create(null);return e.forEach(n,function(t){i[t]=Object.create(null),e.forEach(n,function(n){r[t]<r[n]||!e.has(r,n)?i[t][n]=a:i[t][n]=0})}),i}function o(t,n){var a=Object.create(null);e.forEach(n,function(t){a[t]=Object.create(null),e.forEach(n,function(e){a[t][e]=0})});var r=e.map(t,e.partial(i,e,n));return e.forEach(r,function(t){e.forEach(n,function(r){e.forEach(n,function(e){a[r][e]+=t[r][e]})})}),a}function c(t,n){var a=Object.create(null);return e.forEach(n,function(r){a[r]=Object.create(null);var i=e.without(n,r);e.forEach(i,function(e){t[r][e]>t[e][r]?a[r][e]=t[r][e]:a[r][e]=0})}),e.forEach(n,function(t){var r=e.without(n,t);e.forEach(r,function(n){e.forEach(e.without(r,n),function(r){a[n][r]=e.max([a[n][r],e.min([a[n][t],a[t][r]])])})})}),a}function s(t){var n=t.ballots,a=t.candidates,r=o(n,a),i=c(r,a),s=e.clone(a);return s=s.sort(function(t,e){return i[e][t]-i[t][e]})}function u(t){var n=t.ballots,a=t.candidates,r=o(n,a),i=Object.create(null);e.forEach(a,function(t){var n=e.filter(a,function(e){return t!=e});i[t]=e.every(n,function(e){return r[t][e]>r[e][t]})});var c=e.findKey(i);return c?c:!1}function f(t,n){var a=Object.create(null);return e.forEach(n,function(n){a[n]=0,e.forEach(t,function(t){0===t.ranks[n]&&(a[n]+=t.count)})}),a}function l(t,n){var a=Object.create(null);return e.forEach(n,function(t){a[t]=0}),e.forEach(t,function(t){e.forEach(t.candidates,function(e){a[e]+=t.count})}),a}function d(t,n){n=e.defaults(n,{seats:1,tiebreak:e.sample});var a=l(t.ballots,t.candidates),r=e.orderBy(e.toPairs(a),function(t){return t[1]},["desc"]),i=e.map(r,function(t){return t[0]});return e.take(i,n.seats)}function h(t,n){var a=t.ballots,r=t.candidates;n=e.defaults(n,{seats:1});var i=f(a,r),o=e.orderBy(e.toPairs(i),function(t){return t[1]},["desc"]);return e.take(e.map(o,function(t){return t[0]}),n.seats)}function v(t,n){var a,r,i,o,c,s,u;n=e.defaults(n,{threshold:.5,tiebreak:e.sample,log:e.noop}),a=t.ballots,r=t.candidates;for(var l=function(){if(i=e.sumBy(a,"count"),o=f(a,r),c=e.mapValues(o,function(t){return t/i}),s=e.findKey(c,function(t){return t>n.threshold}))return n.log({type:"elected",candidate:s,state:o}),{v:s};var t=e.min(e.values(o)),l=e.keys(e.pickBy(o,function(e){return e===t}));1===e.size(l)?u=l[0]:0===t?u=l:(u=n.tiebreak(l),n.log({type:"tiebreak",candidate:u,tied:l,state:o})),e.forEach(e.castArray(u),function(t){n.log({type:"eliminated",candidate:t,state:o}),r=e.without(r,t)}),a=e.compact(e.map(a,function(t){return t.eliminate(e.castArray(u))}))};;){var d=l();if("object"===("undefined"==typeof d?"undefined":A["typeof"](d)))return d.v}}function p(t,n){var a=Object.create(null),r=n.length-1;return e.forEach(t.votes,function(n,i){var o=t.count*(r-i);e.isString(n)?a[n]=o:e.isArray(n)&&(o=o*n.length/n.length,e.forEach(n,function(t){a[t]=o}))}),a}function b(t){var n=t.ballots,a=t.candidates,r=Object.create(null);return e.forEach(a,function(t){r[t]=0}),e.forEach(n,function(t){e.forEach(p(t,a),function(t,e){r[e]+=t})}),r}function y(t){var n=b(t),a=e.orderBy(e.toPairs(n),function(t){return t[1]},["desc"]);return e.map(a,function(t){return t[0]})}function m(t,n){var a=e.cloneDeep(t);return a.excess=0,e.forEach(a.candidates,function(t){t.votes=0}),e.forEach(n,function(t){var n=t.count;e.forEach(t.votes,function(t){if(e.isArray(t)){var r=0;if(e.forEach(t,function(t){r+=a.candidates[t].weight}),0===r)return!1;e.forEach(t,function(t){var e=a.candidates[t].weight/r,i=e*a.candidates[t].weight;a.candidates[t].votes+=n*i,n*=1-e})}else a.candidates[t].votes+=n*a.candidates[t].weight,n*=1-a.candidates[t].weight}),a.excess+=n}),a.quota=(a.totalVotes-a.excess)*a.hbFactor,a}function E(t){var n=e.cloneDeep(t);return e.forEach(n.candidates,function(t){if("elected"===t.status){var e=n.quota/t.votes;t.weight*=e}}),n}function w(t){var n=!0;return e.forEach(e.filter(t.candidates,{status:"elected"}),function(e){var a=t.quota/e.votes;return a>1.00001||.9999>a?(n=!1,!1):void 0}),n}function g(t){var n=e.cloneDeep(t),a=[],r=!1,i=!1,o=e.pickBy(n.candidates,function(t){return"elected"===t.status}),c=e.pickBy(n.candidates,function(t){return"hopeful"===t.status});return n.seats===e.size(o)+e.size(c)&&(i=!0),a=e.keys(e.pickBy(n.candidates,function(t){return"hopeful"===t.status&&t.votes>n.quota})),e.size(a)+n.electedCount>n.seats&&(n=O(n,e.sample(a))),e.forEach(e.filter(n.candidates,{status:"hopeful"}),function(t){(t.votes>n.quota||i)&&(r=!0,t.status="elected",n.electedCount++)}),r?n:!1}function j(t){var n=e.pickBy(t.candidates,function(t){return"hopeful"===t.status}),a=e.mapValues(n,"votes");if(e.isEmpty(a))throw new Error("No hopefuls remain. Are there enough candidates?");var r=e.min(e.values(a)),i=e.keys(e.pickBy(n,function(t){return t.votes===r}));return i}function O(t,n){function a(t){var n=r.candidates[t];if(!e.isObject(n))throw new Error("Can't find candidate to be eliminated.");n.status="eliminated",n.weight=0}var r=e.cloneDeep(t);return e.isArray(n)?e.forEach(n,a):a(n),r}function k(t){var n=e.sample(j(t));return O(t,n)}function S(t,n){var a,r=t.ballots,i=[],o=Object.create(null);if(o.candidates=Object.create(null),e.forEach(t.candidates,function(t){o.candidates[t]={status:"hopeful",votes:0,weight:1}}),!e.isNumber(n.seats))throw new TypeError("The number of seats must be a number.");for(o.seats=n.seats,o.excess=0,o.totalVotes=e.sumBy(r,"count"),o.hbFactor=1/(n.seats+1),o.quota=o.totalVotes*o.hbFactor,o.electedCount=0;o.electedCount<n.seats;){do o=m(o,r),o=E(o);while(!w(o));o=g(o)||k(o),i.push(e.cloneDeep(o))}return a=e.filter(e.keys(o.candidates),function(t){return"elected"===o.candidates[t].status}),a.log=i,a}function x(t,n){n=e.defaults(n,{seats:1,tiebreak:e.sample});var a,r;for(a=e.clone(t.candidates),r=[];e.size(r)<n.seats;){var i=n.tiebreak(a);r.push(i),a=e.without(a,i)}return 1===n.seats?r[0]:r}e="default"in e?e["default"]:e;var A={};A["typeof"]="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},n.prototype.eliminate=function(t){var a=!1;if(e.isString(t)&&(a=!0),e.isArray(t)&&e.every(t,e.isString)&&(a=!0),!a)return this;var r=e.castArray(t),i=e.compact(e.map(this.votes,function(t){if(e.isArray(t)){var n=e.difference(t,r);return n.length>1?n:1===n.length?n[0]:!1}return-1!==r.indexOf(t)?!1:t}));return new n(i,this.count)},n.prototype.isValid=function(t){return t=e.defaults(t,{allowTies:!0}),t.candidates&&0!==e.difference(this.candidates,t.candidates).length?!1:t.allowTies&&e.some(this.votes,e.isArray)?!1:!(t.maxCandidates&&e.size(this.votes)>t.maxCandidates)},Object.defineProperty(r.prototype,"candidates",{get:function(){return this._providedCandidates?this._providedCandidates:e.uniq(e.flatten(e.map(this.ballots,function(t){var n=t.votes;return e.isArray(n)?n:[n]})))},enumerable:!0,configurable:!1}),r.prototype.validBallot=function(t){return this._providedCandidates&&0!==e.difference(t.candidates,this._providedCandidates).length?!1:this.allowTies&&e.some(t.votes,e.isArray)?!1:this.maxSeats&&e.size(t.votes)>this.maxSeats?!1:!(this.minSeats&&e.size(t.votes)<this.minSeats)},r.prototype.addBallot=function(t){if(t instanceof n||(t=new n(t)),this.validBallot(t))return this.ballots.push(t),!0;throw new Error("Ballot not valid.")};var B=Object.freeze({ballotToPairs:i,ballotArrayToPairs:o}),z=Object.freeze({winner:u,common:B,schulze:s}),C=Object.freeze({countFirstPrefs:f,countAppearances:l}),P=Object.freeze({meek:S});t.Ballot=n,t.Election=r,t.condorcet=z,t.plurality=h,t.approval=d,t.irv=v,t.borda=y,t.stv=P,t.utils=C,t.lot=x});
//# sourceMappingURL=caritat.js.map