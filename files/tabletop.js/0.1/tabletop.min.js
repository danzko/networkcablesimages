(function(global){var inNodeJS=false;if(typeof process!=="undefined"){inNodeJS=true;var request=require("request")}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(obj,fromIndex){if(fromIndex===null){fromIndex=0}else{if(fromIndex<0){fromIndex=Math.max(0,this.length+fromIndex)}}for(var i=fromIndex,j=this.length;i<j;i++){if(this[i]===obj){return i}}return -1}}var Tabletop=global.Tabletop=function(options){if(!this||!(this instanceof Tabletop)){return new Tabletop(options)}if(typeof(options)==="string"){options={key:options}}this.callback=options.callback;this.wanted=options.wanted||[];this.key=options.key;this.simpleSheet=!!options.simpleSheet;this.parseNumbers=!!options.parseNumbers;this.wait=!!options.wait;this.postProcess=options.postProcess;this.debug=!!options.debug;this.query=options.query||"";this.endpoint=options.endpoint||"https://spreadsheets.google.com";this.singleton=!!options.singleton;this.simple_url=!!options.simple_url;if(typeof(options.proxy)!=="undefined"){this.endpoint=options.proxy;this.simple_url=true;this.singleton=true}this.parameterize=options.parameterize||false;if(this.singleton){if(typeof(Tabletop.singleton)!=="undefined"){this.log("WARNING! Tabletop singleton already defined")}Tabletop.singleton=this}if(/key=/.test(this.key)){this.log("You passed a key as a URL! Attempting to parse.");this.key=this.key.match("key=(.*?)&")[1]}if(!this.key){this.log("You need to pass Tabletop a key!");return}this.log("Initializing with key "+this.key);this.models={};this.model_names=[];this.base_json_path="/feeds/worksheets/"+this.key+"/public/basic?alt=";if(inNodeJS){this.base_json_path+="json"}else{this.base_json_path+="json-in-script"}if(!this.wait){this.fetch()}};Tabletop.callbacks={};Tabletop.init=function(options){return new Tabletop(options)};Tabletop.sheets=function(){this.log("Times have changed! You'll want to use var tabletop = Tabletop.init(...); tabletop.sheets(...); instead of Tabletop.sheets(...)")};Tabletop.prototype={fetch:function(callback){if(typeof(callback)!=="undefined"){this.callback=callback}this.requestData(this.base_json_path,this.loadSheets)},requestData:function(path,callback){if(inNodeJS){this.serverSideFetch(path,callback)}else{this.injectScript(path,callback)}},injectScript:function(path,callback){var script=document.createElement("script");var callbackName;if(this.singleton){if(callback===this.loadSheets){callbackName="Tabletop.singleton.loadSheets"}else{if(callback===this.loadSheet){callbackName="Tabletop.singleton.loadSheet"}}}else{var self=this;callbackName="tt"+(+new Date())+(Math.floor(Math.random()*100000));Tabletop.callbacks[callbackName]=function(){var args=Array.prototype.slice.call(arguments,0);callback.apply(self,args);script.parentNode.removeChild(script);delete Tabletop.callbacks[callbackName]};callbackName="Tabletop.callbacks."+callbackName}var url=path+"&callback="+callbackName;if(this.simple_url){if(path.indexOf("/list/")!==-1){script.src=this.endpoint+"/"+this.key+"-"+path.split("/")[4]}else{script.src=this.endpoint+"/"+this.key}}else{script.src=this.endpoint+url}if(this.parameterize){script.src=this.parameterize+encodeURIComponent(script.src)}document.getElementsByTagName("script")[0].parentNode.appendChild(script)},serverSideFetch:function(path,callback){var self=this;request({url:this.endpoint+path,json:true},function(err,resp,body){if(err){return console.error(err)}callback.call(self,body)})},isWanted:function(sheetName){if(this.wanted.length===0){return true}else{return this.wanted.indexOf(sheetName)!==-1}},data:function(){if(this.model_names.length===0){return undefined}if(this.simpleSheet){if(this.model_names.length>1&&this.debug){this.log("WARNING You have more than one sheet but are using simple sheet mode! Don't blame me when something goes wrong.")}return this.models[this.model_names[0]].all()}else{return this.models}},addWanted:function(sheet){if(this.wanted.indexOf(sheet)===-1){this.wanted.push(sheet)}},loadSheets:function(data){var i,ilen;var toLoad=[];this.foundSheetNames=[];for(i=0,ilen=data.feed.entry.length;i<ilen;i++){this.foundSheetNames.push(data.feed.entry[i].title.$t);if(this.isWanted(data.feed.entry[i].content.$t)){var sheet_id=data.feed.entry[i].link[3].href.substr(data.feed.entry[i].link[3].href.length-3,3);var json_path="/feeds/list/"+this.key+"/"+sheet_id+"/public/values?sq="+this.query+"&alt=";if(inNodeJS){json_path+="json"}else{json_path+="json-in-script"}toLoad.push(json_path)}}this.sheetsToLoad=toLoad.length;for(i=0,ilen=toLoad.length;i<ilen;i++){this.requestData(toLoad[i],this.loadSheet)}},sheets:function(sheetName){if(typeof sheetName==="undefined"){return this.models}else{if(typeof(this.models[sheetName])==="undefined"){return}else{return this.models[sheetName]}}},loadSheet:function(data){var model=new Tabletop.Model({data:data,parseNumbers:this.parseNumbers,postProcess:this.postProcess,tabletop:this});this.models[model.name]=model;if(this.model_names.indexOf(model.name)===-1){this.model_names.push(model.name)}this.sheetsToLoad--;if(this.sheetsToLoad===0){this.doCallback()}},doCallback:function(){if(this.sheetsToLoad===0){this.callback.apply(this.callbackContext||this,[this.data(),this])}},log:function(msg){if(this.debug){if(typeof console!=="undefined"&&typeof console.log!=="undefined"){Function.prototype.apply.apply(console.log,[console,arguments])}}}};Tabletop.Model=function(options){var i,j,ilen,jlen;this.column_names=[];this.name=options.data.feed.title.$t;this.elements=[];this.raw=options.data;if(typeof(options.data.feed.entry)==="undefined"){options.tabletop.log("Missing data for "+this.name+", make sure you didn't forget column headers");this.elements=[];return}for(var key in options.data.feed.entry[0]){if(/^gsx/.test(key)){this.column_names.push(key.replace("gsx$",""))}}for(i=0,ilen=options.data.feed.entry.length;i<ilen;i++){var source=options.data.feed.entry[i];var element={};for(var j=0,jlen=this.column_names.length;j<jlen;j++){var cell=source["gsx$"+this.column_names[j]];if(typeof(cell)!=="undefined"){if(options.parseNumbers&&cell.$t!==""&&!isNaN(cell.$t)){element[this.column_names[j]]=+cell.$t}else{element[this.column_names[j]]=cell.$t}}else{element[this.column_names[j]]=""}}if(element.rowNumber===undefined){element.rowNumber=i+1}if(options.postProcess){options.postProcess(element)}this.elements.push(element)}};Tabletop.Model.prototype={all:function(){return this.elements},toArray:function(){var array=[],i,j,ilen,jlen;for(i=0,ilen=this.elements.length;i<ilen;i++){var row=[];for(j=0,jlen=this.column_names.length;j<jlen;j++){row.push(this.elements[i][this.column_names[j]])}array.push(row)}return array}}})(typeof process==="undefined"?this:module.exports);