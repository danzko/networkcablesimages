!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.Jotted=b()}(this,function(){"use strict";function a(){return'\n    <ul class="jotted-nav">\n      <li class="jotted-nav-item jotted-nav-item-result">\n        <a href="#" data-jotted-type="result">\n          Result\n        </a>\n      </li>\n      <li class="jotted-nav-item jotted-nav-item-html">\n        <a href="#" data-jotted-type="html">\n          HTML\n        </a>\n      </li>\n      <li class="jotted-nav-item jotted-nav-item-css">\n        <a href="#" data-jotted-type="css">\n          CSS\n        </a>\n      </li>\n      <li class="jotted-nav-item jotted-nav-item-js">\n        <a href="#" data-jotted-type="js">\n          JavaScript\n        </a>\n      </li>\n    </ul>\n    <div class="jotted-pane jotted-pane-result"><iframe></iframe></div>\n    <div class="jotted-pane jotted-pane-html"></div>\n    <div class="jotted-pane jotted-pane-css"></div>\n    <div class="jotted-pane jotted-pane-js"></div>\n  '}function b(a){return"jotted-pane-active-"+a}function c(){return"jotted"}function d(a){return"jotted-has-"+a}function e(a){return"jotted-editor jotted-editor-"+a}function f(a){var b=arguments.length<=1||void 0===arguments[1]?"":arguments[1];return'\n    <textarea data-jotted-type="'+a+'" data-jotted-file="'+b+'"></textarea>\n    <div class="jotted-status"></div>\n  '}function g(a){return"\n    <p>"+a+"</p>\n  "}function h(a){return"jotted-status-"+a}function i(a){return"jotted-status-active-"+a}function j(a){return"jotted-plugin-"+a}function k(){var a=arguments.length<=0||void 0===arguments[0]?"":arguments[0],b=arguments.length<=1||void 0===arguments[1]?"":arguments[1],c=arguments.length<=2||void 0===arguments[2]?"":arguments[2];return"\n    <!doctype html>\n    <html>\n      <head>\n        <style>"+a+"</style>\n      </head>\n      <body>\n        "+b+"\n\n        <script>\n          (function () {\n            window.addEventListener('DOMContentLoaded', function () {\n              window.parent.postMessage(JSON.stringify({\n                type: 'jotted-dom-ready'\n              }), '*')\n            })\n          }())\n        </script>\n        <script>"+c+"</script>\n      </body>\n    </html>\n  "}function l(a){return"Loading <strong>"+a+"</strong>.."}function m(a){return"There was an error loading <strong>"+a+"</strong>."}function n(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],c={};return Object.keys(a).forEach(function(b){c[b]=a[b]}),Object.keys(b).forEach(function(d){"undefined"!=typeof c[d]?c[d]=a[d]:c[d]=b[d]}),c}function o(a,b){var c=new window.XMLHttpRequest;c.open("GET",a),c.responseType="text",c.onload=function(){200===c.status?b(null,c.responseText):b(a,c)},c.onerror=function(a){b(a)},c.send()}function p(a,b,c,d,e){return function(b,f){b&&d.push(b),a++,a===c.length?e(d,f):q(a,f,c,d,e)}}function q(a,b,c,d,e){c[a](b,p.apply(this,arguments))}function r(a,b){var c=arguments.length<=2||void 0===arguments[2]?function(){}:arguments[2],d=[];return a.length?void q(0,b,a,d,c):c(d,b)}function s(a,b){var c=null,d=null;return function(){var e=this,f=arguments;c?d=!0:a.apply(this,arguments),clearTimeout(c),c=setTimeout(function(){d&&a.apply(e,f),c=null,d=null},b)}}function t(a,b){if(!a.className)return!1;var c=" "+a.className+" ";return b=" "+b+" ",-1!==c.indexOf(b)?!0:!1}function u(a,b){return t(a,b)?a.className:(a.className&&(b=" "+b),a.className+=b,a.className)}function v(a,b){var c=" "+b,d=b+" ";return-1!==a.className.indexOf(c)?a.className=a.className.replace(c,""):-1!==a.className.indexOf(d)?a.className=a.className.replace(d,""):a.className=a.className.replace(b,""),a.className}function w(a,b){return a.getAttribute("data-"+b)}function x(){var a=arguments.length<=0||void 0===arguments[0]?"":arguments[0],b=arguments.length<=1||void 0===arguments[1]?"":arguments[1],c=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],d=n(c,D);for(var e in d){var f=e.length;if(b.slice(-f++)==="."+e)return d[e]}for(var e in d)if(a===e)return d[e];return a}function y(a){for(var b in E){var c=E[b];if(c._id===a)return c}throw new Error("Plugin "+a+" is not registered.")}function z(a,b){b._id=a,E.push(b)}function A(){var a=this;this._get("options").plugins.forEach(function(b){var c=void 0,d=void 0,e={};"string"==typeof b?d=b:"object"===("undefined"==typeof b?"undefined":C["typeof"](b))&&(d=b.name,e=b.options||{}),c=y(d),a._get("plugins")[b]=new c(a,e),u(a._get("$container"),j(d))})}function B(a){a.plugin("render",Q),a.plugin("scriptless",P),a.plugin("ace",O),a.plugin("codemirror",N),a.plugin("less",M),a.plugin("coffeescript",L),a.plugin("stylus",K),a.plugin("babel",J),a.plugin("markdown",I),a.plugin("console",H),a.plugin("play",G)}var C={};C["typeof"]="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},C.classCallCheck=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},C.createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();var D={html:"html",css:"css",js:"javascript",less:"less",styl:"stylus",coffee:"coffeescript"},E=[],F=function(){function a(){C.classCallCheck(this,a),this.topics={},this.callbacks={}}return C.createClass(a,[{key:"find",value:function(a){return this.topics[a]=this.topics[a]||[],this.topics[a]}},{key:"subscribe",value:function(a,b){var c=arguments.length<=2||void 0===arguments[2]?90:arguments[2],d=this.find(a);b._priority=c,d.push(b),d.sort(function(a,b){return a._priority>b._priority?1:b._priority>a._priority?-1:0})}},{key:"remover",value:function(a,b){a.forEach(function(){if(!b)return void(a.length=0);var c=[].indexOf.call(a,b);-1!==c&&a.splice(c,1)})}},{key:"unsubscribe",value:function(a,b){var c=this.find(a);this.remover(c,b),this.callbacks[a]=this.callbacks[a]||[],this.remover(this.callbacks[a],b)}},{key:"publish",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],c=this.find(a),d=[];c.forEach(function(a){d.push(a)}),r(d,b,this.runCallbacks(a))}},{key:"runCallbacks",value:function(a){var b=this;return function(){var c=this,d=arguments;b.callbacks[a]=b.callbacks[a]||[],b.callbacks[a].forEach(function(a){a.apply(c,d)})}}},{key:"done",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?function(){}:arguments[1];this.callbacks[a]=this.callbacks[a]||[],this.callbacks[a].push(b)}}]),a}(),G=function(){function a(b,c){C.classCallCheck(this,a),c=n(c,{});var d=10,e={},f={},g=document.createElement("button");g.className="jotted-button jotted-button-play",g.innerHTML="Run",b.$container.appendChild(g),g.addEventListener("click",this.run.bind(this)),b.on("change",this.change.bind(this),d),this.cache=e,this.code=f,this.jotted=b}return C.createClass(a,[{key:"change",value:function(a,b){this.code[a.type]=n(a),this.cache[a.type]?(b(null,this.cache[a.type]),this.cache[a.type].forceRender=null):(this.cache[a.type]=n(a),b(null,a))}},{key:"run",value:function(){for(var a in this.code)this.cache[a]=n(this.code[a],{forceRender:!0}),this.jotted.trigger("change",this.cache[a])}}]),a}(),H=function(){function a(b,c){C.classCallCheck(this,a),c=n(c,{autoClear:!1});var d=30,e=[],f=0,g="("+this.capture.toString()+")();",h={html:"",css:"",js:""},i=b.$container.querySelector(".jotted-pane-result iframe"),j=document.createElement("li");u(j,"jotted-nav-item jotted-nav-item-console"),j.innerHTML='<a href="#" data-jotted-type="console">JS Console</a>';var k=document.createElement("div");u(k,"jotted-pane jotted-pane-console"),k.innerHTML='\n      <div class="jotted-console-container">\n        <ul class="jotted-console-output"></ul>\n        <form class="jotted-console-input">\n          <input type="text">\n        </form>\n      </div>\n      <button class="jotted-button jotted-console-clear">Clear</button>\n    ',b.$container.appendChild(k),b.$container.querySelector(".jotted-nav").appendChild(j);var l=b.$container.querySelector(".jotted-console-container"),m=b.$container.querySelector(".jotted-console-output"),o=b.$container.querySelector(".jotted-console-input input"),p=b.$container.querySelector(".jotted-console-input"),q=b.$container.querySelector(".jotted-console-clear");p.addEventListener("submit",this.submit.bind(this)),o.addEventListener("keydown",this.history.bind(this)),q.addEventListener("click",this.clear.bind(this)),c.autoClear===!0&&b.on("change",this.autoClear.bind(this),d-1),b.on("change",this.change.bind(this),d),window.addEventListener("message",this.getMessage.bind(this)),this.$container=l,this.$input=o,this.$output=m,this.$iframe=i,this.history=e,this.historyIndex=f,this.logCaptureSnippet=g,this.contentCache=h}return C.createClass(a,[{key:"getMessage",value:function(a){if(a.source===this.$iframe.contentWindow){var b=JSON.parse(a.data);"jotted-console-log"===b.type&&this.log(b.message)}}},{key:"autoClear",value:function(a,b){var c=a.content;"js"===a.type&&(c=c.replace(this.logCaptureSnippet,"")),(a.forceRender===!0||this.contentCache[a.type]!==c)&&this.clear(),this.contentCache[a.type]=c,b(null,a)}},{key:"change",value:function(a,b){return"js"!==a.type?b(null,a):(-1===a.content.indexOf(this.logCaptureSnippet)&&(a.content=""+this.logCaptureSnippet+a.content),void b(null,a))}},{key:"capture",value:function(){("undefined"==typeof window.console||"undefined"==typeof window.console.log)&&(window.console={log:function(){}});var a=Function.prototype.bind.call(window.console.log,window.console);window.console.log=function(){[].slice.call(arguments).forEach(function(a){window.parent.postMessage(JSON.stringify({type:"jotted-console-log",message:a}),"*")}),a.apply(a,arguments)}}},{key:"log",value:function(){var a=arguments.length<=0||void 0===arguments[0]?"":arguments[0],b=arguments[1],c=document.createElement("li");u(c,"jotted-console-log"),"undefined"!=typeof b&&u(c,"jotted-console-log-"+b),c.innerHTML=a,this.$output.appendChild(c)}},{key:"submit",value:function(a){var b=this.$input.value.trim();if(""===b)return a.preventDefault();this.history.push(b),this.historyIndex=this.history.length,this.log(b,"history"),0!==b.indexOf("return")&&(b="return "+b);try{var c=this.$iframe.contentWindow.eval("(function() {"+b+"})()");this.log(c)}catch(d){this.log(d,"error")}this.$input.value="",this.$container.scrollTop=this.$container.scrollHeight,a.preventDefault()}},{key:"clear",value:function(){this.$output.innerHTML=""}},{key:"history",value:function(a){var b=38,c=40,d=!1,e=this.$input.selectionStart;a.keyCode===b&&0!==this.historyIndex&&0===e&&(this.historyIndex--,d=!0),a.keyCode===c&&this.historyIndex!==this.history.length-1&&e===this.$input.value.length&&(this.historyIndex++,d=!0),d&&(this.$input.value=this.history[this.historyIndex])}}]),a}(),I=function(){function a(b,c){C.classCallCheck(this,a);var d=20;this.options=n(c,{}),"undefined"!=typeof window.marked&&(window.marked.setOptions(c),b.$container.querySelector('a[data-jotted-type="html"]').innerHTML="Markdown",b.on("change",this.change.bind(this),d))}return C.createClass(a,[{key:"change",value:function(a,b){if("html"===a.type){try{a.content=window.marked(a.content)}catch(c){return b(c,a)}b(null,a)}else b(null,a)}}]),a}(),J=function(){function a(b,c){C.classCallCheck(this,a);var d=20;if(this.options=n(c,{}),"undefined"!=typeof window.Babel)this.babel=window.Babel;else{if("undefined"==typeof window.babel)return;this.babel={transform:window.babel}}b.$container.querySelector('a[data-jotted-type="js"]').innerHTML="ES2015",b.on("change",this.change.bind(this),d)}return C.createClass(a,[{key:"change",value:function(a,b){if("js"===a.type){try{a.content=this.babel.transform(a.content,this.options).code}catch(c){return b(c,a)}b(null,a)}else b(null,a)}}]),a}(),K=function(){function a(b,c){C.classCallCheck(this,a);var d=20;c=n(c,{}),"undefined"!=typeof window.stylus&&(b.$container.querySelector('a[data-jotted-type="css"]').innerHTML="Stylus",b.on("change",this.change.bind(this),d))}return C.createClass(a,[{key:"isStylus",value:function(a){return"css"!==a.type?!1:-1!==a.file.indexOf(".styl")||""===a.file}},{key:"change",value:function(a,b){this.isStylus(a)?window.stylus(a.content,this.options).render(function(c,d){return c?b(c,a):(a.content=d,void b(null,a))}):b(null,a)}}]),a}(),L=function(){function a(b,c){C.classCallCheck(this,a);var d=20;c=n(c,{}),"undefined"!=typeof window.CoffeeScript&&(b.$container.querySelector('a[data-jotted-type="js"]').innerHTML="CoffeeScript",b.on("change",this.change.bind(this),d))}return C.createClass(a,[{key:"isCoffee",value:function(a){return"js"!==a.type?!1:-1!==a.file.indexOf(".coffee")||""===a.file}},{key:"change",value:function(a,b){if(this.isCoffee(a))try{a.content=window.CoffeeScript.compile(a.content)}catch(c){return b(c,a)}b(null,a)}}]),a}(),M=function(){function a(b,c){C.classCallCheck(this,a);var d=20;c=n(c,{}),"undefined"!=typeof window.less&&(b.$container.querySelector('a[data-jotted-type="css"]').innerHTML="Less",b.on("change",this.change.bind(this),d))}return C.createClass(a,[{key:"isLess",value:function(a){return"css"!==a.type?!1:-1!==a.file.indexOf(".less")||""===a.file}},{key:"change",value:function(a,b){this.isLess(a)?window.less.render(a.content,this.options,function(c,d){return c?b(c,a):(a.content=d.css,void b(null,a))}):b(null,a)}}]),a}(),N=function(){function a(b,c){C.classCallCheck(this,a);var d,e=1;this.editor={},this.jotted=b;var f={html:"htmlmixed"};if(c=n(c,{lineNumbers:!0}),"undefined"!=typeof window.CodeMirror){var g=b.$container.querySelectorAll(".jotted-editor");for(d=0;d<g.length;d++){var h=g[d].querySelector("textarea"),i=w(h,"jotted-type"),j=w(h,"jotted-file");this.editor[i]=window.CodeMirror.fromTextArea(h,c),this.editor[i].setOption("mode",x(i,j,f))}b.on("change",this.change.bind(this),e)}}return C.createClass(a,[{key:"editorChange",value:function(a){var b=this;return function(){b.jotted.trigger("change",a)}}},{key:"change",value:function(a,b){var c=this.editor[a.type];a.cmEditor||(c.setValue(a.content),a.cmEditor=c,c.on("change",this.editorChange(a))),a.content=c.getValue(),b(null,a)}}]),a}(),O=function(){function a(b,c){C.classCallCheck(this,a);var d,e=1;if(this.editor={},this.jotted=b,c=n(c,{}),"undefined"!=typeof window.ace){var f=b.$container.querySelectorAll(".jotted-editor");for(d=0;d<f.length;d++){var g=f[d].querySelector("textarea"),h=w(g,"jotted-type"),i=w(g,"jotted-file"),j=document.createElement("div");f[d].appendChild(j),this.editor[h]=window.ace.edit(j);var k=this.editor[h],l=n(c);k.getSession().setMode("ace/mode/"+x(h,i)),k.getSession().setOptions(l),k.$blockScrolling=1/0}b.on("change",this.change.bind(this),e)}}return C.createClass(a,[{key:"editorChange",value:function(a){var b=this;return function(){b.jotted.trigger("change",a)}}},{key:"change",value:function(a,b){var c=this.editor[a.type];a.aceEditor||(c.getSession().setValue(a.content),a.aceEditor=c,c.on("change",this.editorChange(a))),a.content=c.getValue(),b(null,a)}}]),a}(),P=function(){function a(b,c){C.classCallCheck(this,a),c=n(c,{});var d=["application/javascript","application/ecmascript","application/x-ecmascript","application/x-javascript","text/ecmascript","text/javascript","text/javascript1.0","text/javascript1.1","text/javascript1.2","text/javascript1.3","text/javascript1.4","text/javascript1.5","text/jscript","text/livescript","text/x-ecmascript","text/x-javascript"];b.on("change",this.change.bind(this)),this.runScriptTypes=d}return C.createClass(a,[{key:"change",value:function(a,b){if("html"!==a.type)return b(null,a);var c=document.createElement("div");c.innerHTML=a.content;for(var d=null,e=c.querySelectorAll("script"),f=0;f<e.length;f++)d=e[f].getAttribute("type"),d&&-1===this.runScriptTypes.indexOf(d)||e[f].parentNode.removeChild(e[f]);a.content=c.innerHTML,b(null,a)}}]),a}(),Q=function(){function a(b,c){C.classCallCheck(this,a),c=n(c,{});var d=!!("srcdoc"in document.createElement("iframe")),e=b.$container.querySelector(".jotted-pane-result iframe"),f="",g=function(){},h={html:"",css:"",js:""};window.addEventListener("message",this.domready.bind(this)),b.on("change",this.change.bind(this),100),this.supportSrcdoc=d,this.latestCallback=g,this.content=h,this.frameContent=f,this.$resultFrame=e}return C.createClass(a,[{key:"change",value:function(a,b){this.content[a.type]=a.content;var c=this.frameContent;if(this.frameContent=k(this.content.css,this.content.html,this.content.js),a.forceRender!==!0&&this.frameContent===c)return void b(null,a);if(this.latestCallback=function(){b(null,a)},this.$resultFrame.setAttribute("srcdoc",this.frameContent),!this.supportSrcdoc){var d='javascript:window.frameElement.getAttribute("srcdoc");';this.$resultFrame.setAttribute("src",d),this.$resultFrame.contentWindow&&(this.$resultFrame.contentWindow.location=d)}}},{key:"domready",value:function(a){if(a.source===this.$resultFrame.contentWindow){var b=JSON.parse(a.data);"jotted-dom-ready"===b.type&&this.latestCallback()}}}]),a}(),R=function(){function j(e,f){if(C.classCallCheck(this,j),!e)throw new Error("Can't find Jotted container.");var g={};this._get=function(a){return g[a]},this._set=function(a,b){return g[a]=b,g[a]};var h=this._set("options",n(f,{files:[],showBlank:!1,runScripts:!0,pane:"result",debounce:250,plugins:[]}));h.plugins.push("render"),h.runScripts===!1&&h.plugins.push("scriptless"),this._set("cachedContent",{html:"",css:"",js:""});var i=this._set("pubsoup",new F);this._set("trigger",this.trigger()),this._set("on",function(){i.subscribe.apply(i,arguments)}),this._set("off",function(){i.unsubscribe.apply(i,arguments)});var k=this._set("done",function(){i.done.apply(i,arguments)});k("change",this.errors.bind(this));var l=this._set("$container",e);l.innerHTML=a(),u(l,c());var m=this._set("paneActive",h.pane);u(l,b(m)),this._set("$status",{});for(var o=["html","css","js"],p=0;p<o.length;p++){var q=o[p];this.markup(q)}l.addEventListener("keyup",s(this.change.bind(this),h.debounce)),l.addEventListener("change",s(this.change.bind(this),h.debounce)),l.addEventListener("click",this.pane.bind(this)),this.$container=this._get("$container"),this.on=this._get("on"),this.off=this._get("off"),this.done=this._get("done"),this.trigger=this._get("trigger"),this.paneActive=this._get("paneActive"),this._set("plugins",{}),A.call(this);for(var r=["html","css","js"],t=0;t<r.length;t++){var q=r[t];this.load(q)}if(h.showBlank)for(var v=["html","css","js"],w=0;w<v.length;w++){var q=v[w];u(l,d(q))}}return C.createClass(j,[{key:"findFile",value:function(a){var b={},c=this._get("options");for(var d in c.files){var e=c.files[d];if(e.type===a)return e}return b}},{key:"markup",value:function(a){var b=this._get("$container"),c=b.querySelector(".jotted-pane-"+a),g=this.findFile(a),h=document.createElement("div");h.innerHTML=f(a,g.url),h.className=e(a),c.appendChild(h),this._get("$status")[a]=c.querySelector(".jotted-status"),("undefined"!=typeof g.url||"undefined"!=typeof g.content)&&u(b,d(a))}},{key:"load",value:function(a){var b=this,c=this.findFile(a),d=this._get("$container").querySelector(".jotted-pane-"+a+" textarea");"undefined"!=typeof c.content?this.setValue(d,c.content):"undefined"!=typeof c.url?(this.status("loading",[l(c.url)],{type:a,file:c}),o(c.url,function(c,e){return c?void b.status("error",[m(c)],{type:a}):(b.clearStatus("loading",{type:a}),void b.setValue(d,e))})):this.setValue(d,"")}},{key:"setValue",value:function(a,b){a.value=b,this.change({target:a})}},{key:"change",value:function(a){var b=w(a.target,"jotted-type");if(b){var c=this._get("cachedContent");c[b]!==a.target.value&&(c[b]=a.target.value,this.trigger("change",{type:b,file:w(a.target,"jotted-file"),content:c[b]}))}}},{key:"errors",value:function(a,b){this.status("error",a,b)}},{key:"pane",value:function(a){if(w(a.target,"jotted-type")){var c=this._get("$container"),d=this._get("paneActive");v(c,b(d)),d=this._set("paneActive",w(a.target,"jotted-type")),u(c,b(d)),a.preventDefault()}}},{key:"status",value:function(){var a=arguments.length<=0||void 0===arguments[0]?"error":arguments[0],b=arguments.length<=1||void 0===arguments[1]?[]:arguments[1],c=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];if(!b.length)return this.clearStatus(a,c);var d=this._get("$status");u(d[c.type],h(a)),u(this._get("$container"),i(c.type));var e="";b.forEach(function(a){e+=g(a)}),d[c.type].innerHTML=e}},{key:"clearStatus",value:function(a,b){var c=this._get("$status");v(c[b.type],h(a)),v(this._get("$container"),i(b.type)),c[b.type].innerHTML=""}},{key:"trigger",value:function(){var a=this._get("options"),b=this._get("pubsoup");if(a.debounce===!1)return function(){b.publish.apply(b,arguments)};var c={},d={};return function(e){var f=arguments,g=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],h=g.type,i=void 0===h?"default":h;c[i]?d[i]=!0:b.publish.apply(b,arguments),clearTimeout(c[i]),c[i]=setTimeout(function(){d[i]&&b.publish.apply(b,f),d[i]=null,c[i]=null},a.debounce)}}}]),j}();return R.plugin=function(){return z.apply(this,arguments)},B(R),R});