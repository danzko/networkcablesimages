/*! resumable.js 2013-07-28 */
"use strict";var MaybeResumable=function(a){var b=new Resumable(a);return b.support?b:new NotResumable(a)};"undefined"!=typeof module&&(module.exports=MaybeResumable);var NotResumable=function(opts){function NotResumableFile(a,b){function c(){var a=/MSIE (6|7|8)/.test(navigator.userAgent)?document.createElement('<iframe name="'+g.uniqueIdentifier+"_iframe"+'">'):document.createElement("iframe");return a.setAttribute("id",g.uniqueIdentifier+"_iframe_id"),a.setAttribute("name",g.uniqueIdentifier+"_iframe"),a.style.display="none",document.body.appendChild(a),a}function d(){var a=g.getOpt(["target"]),b=document.createElement("form");return b.encoding="multipart/form-data",b.method="POST",b.setAttribute("action",a.target),g.iFrame||(g.iFrame=c()),b.setAttribute("target",g.iFrame.name),b.style.display="none",document.body.appendChild(b),b}function e(a,b){var c;$h.each(b,function(b,d){d&&1===d.nodeType?c=d:(c=document.createElement("input"),c.setAttribute("value",d)),c.setAttribute("name",b),a.appendChild(c)})}function f(){if(g.iFrame&&g.iFrame.parentNode){try{if(g.iFrame.contentDocument&&g.iFrame.contentDocument.body&&"false"==g.iFrame.contentDocument.body.innerHTML)return}catch(a){i=!0,g.resumableObj.fire("fileError",g,a)}var b=g.iFrame.contentDocument||g.iFrame.contentWindow.document,c=b.body.innerHTML;g.abort(),h=!0,g.resumableObj.fire("fileSuccess",g,c),g.resumableObj.upload()}}var g=this;g.opts={},g.getOpt=a.getOpt,g.resumableObj=a,g.element=b,g.fileName=b.value&&b.value.replace(/.*(\/|\\)/,""),g.size=null,g.relativePath=g.fileName,g.uniqueIdentifier=$h.generateUniqueIdentifier(b),g.iFrame=null;var h=!1,i=!1;return g.abort=function(){g.iFrame&&(g.iFrame.setAttribute("src","java"+String.fromCharCode(115)+"cript:false;"),$h.removeElement(g.iFrame),g.iFrame=null),g.resumableObj.fire("fileProgress",g)},g.cancel=function(){g.abort(),g.resumableObj.removeFile(g),g.resumableObj.fire("fileProgress",g)},g.retry=function(){g.bootstrap(),g.resumableObj.upload()},g.bootstrap=function(){g.abort(),i=!1},g.progress=function(){return i?1:h?1:0},g.isUploading=function(){return null!==g.iFrame},g.sizeUploaded=function(){return null},g.timeRemaining=function(){return null},g.send=function(){if(!h){var a=g.getOpt(["query","fileParameterName","paramNames"]),b=d(),c=a.query;$h.isFunction(c)&&(c=c(g)),c[a.fileParameterName]=g.element,c[a.paramNames.resumableFilename]=g.fileName,c[a.paramNames.resumableRelativePath]=g.relativePath,c[a.paramNames.resumableIdentifier]=g.uniqueIdentifier,e(b,c),g.resumableObj.fire("fileProgress",g),$h.addEvent(g.iFrame,"load",f),b.submit(),$h.removeElement(b)}},g.bootstrap(),this}if(!(this instanceof NotResumable))return new NotResumable(opts);this.support=!0;var $=this;$.files=[],$.defaults={simultaneousUploads:3,fileParameterName:"file",paramNames:{resumableFilename:"resumableFilename",resumableRelativePath:"resumableRelativePath",resumableIdentifier:"resumableIdentifier"},query:{},target:"/",generateUniqueIdentifier:null},$.opts=opts||{},$.getOpt=function(a){var b=this;if(a instanceof Array){var c={};return $h.each(a,function(a){c[a]=b.getOpt(a)}),c}if(b instanceof NotResumableFile){if("undefined"!=typeof b.opts[a])return b.opts[a];b=b.resumableObj}return b instanceof NotResumable?"undefined"!=typeof b.opts[a]?b.opts[a]:b.defaults[a]:void 0},$.events=[],$.on=function(a,b){$.events.push(a.toLowerCase(),b)},$.fire=function(){for(var a=[],b=0;b<arguments.length;b++)a.push(arguments[b]);for(var c=a[0].toLowerCase(),b=0;b<=$.events.length;b+=2)$.events[b]==c&&$.events[b+1].apply($,a.slice(1)),"catchall"==$.events[b]&&$.events[b+1].apply(null,a);"fileerror"==c&&$.fire("error",a[2],a[1]),"fileprogress"==c&&$.fire("progress")};var $h={stopEvent:function(a){a.stopPropagation(),a.preventDefault()},each:function(a,b){if(a&&"undefined"!=typeof a.length){for(var c=0;c<a.length;c++)if(b(a[c])===!1)return}else for(c in a)if(b(c,a[c])===!1)return},generateUniqueIdentifier:function(a){var b=$.getOpt("generateUniqueIdentifier");return"function"==typeof b?b(a):"xxxxxxxx-xxxx-yxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=0|16*Math.random(),c="x"==a?b:8|3&b;return c.toString(16)})},addEvent:function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,c):a["on"+b]=c},removeEvent:function(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent?a.detachEvent("on"+b,c):a["on"+b]=null},removeElement:function(a){a.parentNode.removeChild(a)},parseJson:function(json){return window.JSON?JSON.parse(json):eval("("+json+")")},isFunction:function(a){var b={};return a&&"[object Function]"===b.toString.call(a)}},appendFilesFromDomElements=function(a,b){var c=0,d=$.getOpt(["maxFiles","maxFilesErrorCallback"]);if("undefined"!=typeof d.maxFiles&&d.maxFiles<a.length+$.files.length){if(1!==d.maxFiles||1!==$.files.length||1!==a.length)return d.maxFilesErrorCallback(a,c++),!1;$.removeFile($.files[0])}var e=[];$h.each(a,function(a){if(a.value){var c=new NotResumableFile($,a);$.files.push(c),e.push(c),$.fire("fileAdded",c,b)}}),$.fire("filesAdded",e)},inputChangeEvent=function(a){var b=a.srcElement;$h.removeEvent(b,"change",inputChangeEvent),$.addFile(b,a);var c=b.cloneNode();b.parentNode.replaceChild(c,b),c.value="",$h.addEvent(c,"change",inputChangeEvent)};return $.assignBrowse=function(a){"undefined"==typeof a.length&&(a=[a]),$h.each(a,function(a){var b;"INPUT"===a.tagName&&"file"===a.type?b=a:(b=document.createElement("input"),b.setAttribute("type","file"),a.style.display="inline-block",a.style.position="relative",b.style.position="absolute",b.style.top=b.style.left=b.style.bottom=b.style.right=0,b.style.opacity=0,b.style.cursor="pointer",a.appendChild(b)),$h.addEvent(b,"change",inputChangeEvent)})},$.assignDrop=function(){},$.unAssignDrop=function(){},$.isUploading=function(){var a=!1;return $h.each($.files,function(b){return b.isUploading()?(a=!0,!1):void 0}),a},$.upload=function(){var a=0;$h.each($.files,function(b){if(1!=b.progress()){if(b.isUploading())return a++,void 0;if(a++>=$.getOpt("simultaneousUploads"))return!1;1==a&&$.fire("uploadStart"),b.send()}}),a||$.fire("complete")},$.pause=function(){$h.each($.files,function(a){a.abort()}),$.fire("pause")},$.cancel=function(){$h.each($.files,function(a){a.cancel()}),$.fire("cancel")},$.progress=function(){var a=0,b=0;return $h.each($.files,function(c){a+=c.progress(),b++}),totalSize>0?a/b:0},$.addFile=function(a,b){1===a.nodeType&&appendFilesFromDomElements([a],b)},$.removeFile=function(a){var b=[];$h.each($.files,function(c){c!==a&&b.push(c)}),$.files=b},$.getFromUniqueIdentifier=function(a){var b=!1;return $h.each($.files,function(c){c.uniqueIdentifier==a&&(b=c)}),b},$.getSize=function(){return null},this};"undefined"!=typeof module&&(module.exports=NotResumable);var Resumable=function(a){function b(a,b){var d=this;d.opts={},d.getOpt=a.getOpt,d._prevProgress=0,d.resumableObj=a,d.file=b,d.fileName=b.fileName||b.name,d.size=b.size,d.relativePath=b.webkitRelativePath||d.fileName,d.uniqueIdentifier=e.generateUniqueIdentifier(b),d.averageSpeed=0,d.currentSpeed=0,d._stopWatch=0,d._prevUploadedSize=0;var f=!1,g=function(a){var b=d.averageSpeed?d.getOpt("speedSmoothingFactor"):1,c=d.sizeUploaded();d.currentSpeed=Math.max(1e3*((c-d._prevUploadedSize)/a),0),d.averageSpeed=b*d.currentSpeed+(1-b)*d.averageSpeed,d._prevUploadedSize=c,d._stopWatch=Date.now()},h=function(a,b){switch(a){case"progress":var c=Date.now()-d._stopWatch;c>=d.getOpt("measureSpeedInterval")&&g(c),d.resumableObj.fire("fileProgress",d);break;case"error":d.abort(),f=!0,d.chunks=[],d.resumableObj.fire("fileError",d,b);break;case"success":if(f)return;d.resumableObj.fire("fileProgress",d),1==d.progress()&&d.resumableObj.fire("fileSuccess",d,b);break;case"retry":d.resumableObj.fire("fileRetry",d)}};return d.chunks=[],d.abort=function(){e.each(d.chunks,function(a){"uploading"==a.status()&&a.abort()}),d.resumableObj.fire("fileProgress",d)},d.cancel=function(){var a=d.chunks;d.chunks=[],e.each(a,function(a){"uploading"==a.status()&&(a.abort(),d.resumableObj.uploadNextChunk())}),d.resumableObj.removeFile(d),d.resumableObj.fire("fileProgress",d)},d.retry=function(){d.bootstrap(),d.resumableObj.upload()},d.bootstrap=function(){d.abort(),f=!1,d.chunks=[],d._prevProgress=0;for(var a=d.getOpt("forceChunkSize")?Math.ceil:Math.floor,b=0;b<Math.max(a(d.file.size/d.getOpt("chunkSize")),1);b++)d.chunks.push(new c(d.resumableObj,d,b,h))},d.progress=function(){if(f)return 1;var a=0,b=!1;return e.each(d.chunks,function(c){"error"==c.status()&&(b=!0),a+=c.progress(!0)}),a=b?1:a>.999?1:a,a=Math.max(d._prevProgress,a),d._prevProgress=a,a},d.isUploading=function(){var a=!1;return e.each(d.chunks,function(b){return"uploading"==b.status()?(a=!0,!1):void 0}),a},d.sizeUploaded=function(){var a=0;return e.each(d.chunks,function(b){a+="success"==b.status()?b.endByte-b.startByte:b.loaded}),a},d.timeRemaining=function(){return(b.size-d.sizeUploaded())/d.averageSpeed},d.bootstrap(),this}function c(a,b,c,d){var f=this;f.opts={},f.getOpt=a.getOpt,f.resumableObj=a,f.fileObj=b,f.fileObjSize=b.size,f.offset=c,f.callback=d,f.lastProgressCallback=new Date,f.tested=!1,f.retries=0,f.preprocessState=0;var g=f.getOpt("chunkSize");return f.loaded=0,f.startByte=f.offset*g,f.endByte=Math.min(f.fileObjSize,(f.offset+1)*g),f.fileObjSize-f.endByte<g&&!f.getOpt("forceChunkSize")&&(f.endByte=f.fileObjSize),f.xhr=null,f.test=function(){f.xhr=new XMLHttpRequest;var a=function(){f.tested=!0;var a=f.status();"success"==a?(f.callback(a,f.message()),f.resumableObj.uploadNextChunk()):f.send()};f.xhr.addEventListener("load",a,!1),f.xhr.addEventListener("error",a,!1);var b=[],c=f.getOpt("query");"function"==typeof c&&(c=c(f.fileObj,f)),e.each(c,function(a,c){b.push([encodeURIComponent(a),encodeURIComponent(c)].join("="))}),b.push(["resumableChunkNumber",encodeURIComponent(f.offset+1)].join("=")),b.push(["resumableChunkSize",encodeURIComponent(f.getOpt("chunkSize"))].join("=")),b.push(["resumableCurrentChunkSize",encodeURIComponent(f.endByte-f.startByte)].join("=")),b.push(["resumableTotalSize",encodeURIComponent(f.fileObjSize)].join("=")),b.push(["resumableIdentifier",encodeURIComponent(f.fileObj.uniqueIdentifier)].join("=")),b.push(["resumableFilename",encodeURIComponent(f.fileObj.fileName)].join("=")),b.push(["resumableRelativePath",encodeURIComponent(f.fileObj.relativePath)].join("=")),f.xhr.open("GET",f.getOpt("target")+"?"+b.join("&")),e.each(f.getOpt("headers"),function(a,b){f.xhr.setRequestHeader(a,b)}),f.xhr.send(null)},f.preprocessFinished=function(){f.preprocessState=2,f.send()},f.send=function(){var a=f.getOpt("preprocess");if("function"==typeof a)switch(f.preprocessState){case 0:return a(f),f.preprocessState=1,void 0;case 1:return;case 2:}if(f.getOpt("testChunks")&&!f.tested)return f.test(),void 0;f.xhr=new XMLHttpRequest,f.xhr.upload.addEventListener("progress",function(a){new Date-f.lastProgressCallback>1e3*f.getOpt("throttleProgressCallbacks")&&(f.callback("progress"),f.lastProgressCallback=new Date),f.loaded=a.loaded||0},!1),f.loaded=0,f.callback("progress");var b=function(){var a=f.status();if("success"==a||"error"==a)f.callback(a,f.message()),f.resumableObj.uploadNextChunk();else{f.callback("retry",f.message()),f.abort(),f.retries++;var b=f.getOpt("chunkRetryInterval");void 0!==b?setTimeout(f.send,b):f.send()}};f.xhr.addEventListener("load",b,!1),f.xhr.addEventListener("error",b,!1);var c={resumableChunkNumber:f.offset+1,resumableChunkSize:f.getOpt("chunkSize"),resumableCurrentChunkSize:f.endByte-f.startByte,resumableTotalSize:f.fileObjSize,resumableIdentifier:f.fileObj.uniqueIdentifier,resumableFilename:f.fileObj.fileName,resumableRelativePath:f.fileObj.relativePath},d=f.getOpt("query");"function"==typeof d&&(d=d(f.fileObj,f)),e.each(d,function(a,b){c[a]=b});var g=f.fileObj.file.slice?"slice":f.fileObj.file.mozSlice?"mozSlice":f.fileObj.file.webkitSlice?"webkitSlice":"slice",h=f.fileObj.file[g](f.startByte,f.endByte),i=null,j=f.getOpt("target");if("octet"===f.getOpt("method")){i=h;var k=[];e.each(c,function(a,b){k.push([encodeURIComponent(a),encodeURIComponent(b)].join("="))}),j+="?"+k.join("&")}else i=new FormData,e.each(c,function(a,b){i.append(a,b)}),i.append(f.getOpt("fileParameterName"),h);f.xhr.open("POST",j),e.each(f.getOpt("headers"),function(a,b){f.xhr.setRequestHeader(a,b)}),f.xhr.send(i)},f.abort=function(){f.xhr&&f.xhr.abort(),f.xhr=null},f.status=function(){return f.xhr?f.xhr.readyState<4?"uploading":200==f.xhr.status?"success":e.contains(f.getOpt("permanentErrors"),f.xhr.status)||f.retries>=f.getOpt("maxChunkRetries")?"error":(f.abort(),"pending"):"pending"},f.message=function(){return f.xhr?f.xhr.responseText:""},f.progress=function(a){"undefined"==typeof a&&(a=!1);var b=a?(f.endByte-f.startByte)/f.fileObjSize:1,c=f.status();switch(c){case"success":case"error":return 1*b;case"pending":return 0*b;default:return f.loaded/(f.endByte-f.startByte)*b}},this}if(!(this instanceof Resumable))return new Resumable(a);if(this.support=!("undefined"==typeof File||"undefined"==typeof Blob||"undefined"==typeof FileList||!Blob.prototype.webkitSlice&&!Blob.prototype.mozSlice&&!Blob.prototype.slice),!this.support)return!1;var d=this;d.files=[],d.defaults={chunkSize:1048576,forceChunkSize:!1,simultaneousUploads:3,fileParameterName:"file",throttleProgressCallbacks:.5,query:{},headers:{},preprocess:null,method:"multipart",prioritizeFirstAndLastChunk:!1,target:"/",testChunks:!0,generateUniqueIdentifier:null,maxChunkRetries:void 0,chunkRetryInterval:void 0,measureSpeedInterval:1e3,speedSmoothingFactor:.1,permanentErrors:[415,500,501],maxFiles:void 0,maxFilesErrorCallback:function(){var a=d.getOpt("maxFiles");alert("Please upload "+a+" file"+(1===a?"":"s")+" at a time.")},minFileSize:1,minFileSizeErrorCallback:function(a){alert(a.fileName+" is too small, please upload files larger than "+e.formatSize(d.getOpt("minFileSize"))+".")},maxFileSize:void 0,maxFileSizeErrorCallback:function(a){alert(a.fileName+" is too large, please upload files less than "+e.formatSize(d.getOpt("maxFileSize"))+".")},fileType:[],fileTypeErrorCallback:function(a){alert(a.fileName+" has type not allowed, please upload files of type "+d.getOpt("fileType")+".")}},d.opts=a||{},d.getOpt=function(a){var d=this;if(a instanceof Array){var f={};return e.each(a,function(a){f[a]=d.getOpt(a)}),f}if(d instanceof c){if("undefined"!=typeof d.opts[a])return d.opts[a];d=d.fileObj}if(d instanceof b){if("undefined"!=typeof d.opts[a])return d.opts[a];d=d.resumableObj}return d instanceof Resumable?"undefined"!=typeof d.opts[a]?d.opts[a]:d.defaults[a]:void 0},d.events=[],d.on=function(a,b){d.events.push(a.toLowerCase(),b)},d.fire=function(){for(var a=[],b=0;b<arguments.length;b++)a.push(arguments[b]);for(var c=a[0].toLowerCase(),b=0;b<=d.events.length;b+=2)d.events[b]==c&&d.events[b+1].apply(d,a.slice(1)),"catchall"==d.events[b]&&d.events[b+1].apply(null,a);"fileerror"==c&&d.fire("error",a[2],a[1]),"fileprogress"==c&&d.fire("progress")};var e={stopEvent:function(a){a.stopPropagation(),a.preventDefault()},each:function(a,b){if("undefined"!=typeof a.length){for(var c=0;c<a.length;c++)if(b(a[c])===!1)return}else for(c in a)if(b(c,a[c])===!1)return},generateUniqueIdentifier:function(a){var b=d.getOpt("generateUniqueIdentifier");if("function"==typeof b)return b(a);var c=a.webkitRelativePath||a.fileName||a.name,e=a.size;return e+"-"+c.replace(/[^0-9a-zA-Z_-]/gim,"")},contains:function(a,b){var c=!1;return e.each(a,function(a){return a==b?(c=!0,!1):!0}),c},formatSize:function(a){return 1024>a?a+" bytes":1048576>a?(a/1024).toFixed(0)+" KB":1073741824>a?(a/1024/1024).toFixed(1)+" MB":(a/1024/1024/1024).toFixed(1)+" GB"}},f=function(a){e.stopEvent(a),h(a.dataTransfer.files,a)},g=function(a){a.preventDefault()},h=function(a,c){var f=0,g=d.getOpt(["maxFiles","minFileSize","maxFileSize","maxFilesErrorCallback","minFileSizeErrorCallback","maxFileSizeErrorCallback","fileType","fileTypeErrorCallback"]);if("undefined"!=typeof g.maxFiles&&g.maxFiles<a.length+d.files.length){if(1!==g.maxFiles||1!==d.files.length||1!==a.length)return g.maxFilesErrorCallback(a,f++),!1;d.removeFile(d.files[0])}var h=[];e.each(a,function(a){if(a.name=a.fileName=a.fileName||a.name,g.fileType.length>0&&!e.contains(g.fileType,a.type.split("/")[1]))return g.fileTypeErrorCallback(a,f++),!1;if("undefined"!=typeof g.minFileSize&&a.size<g.minFileSize)return g.minFileSizeErrorCallback(a,f++),!1;if("undefined"!=typeof g.maxFileSize&&a.size>g.maxFileSize)return g.maxFileSizeErrorCallback(a,f++),!1;if(!d.getFromUniqueIdentifier(e.generateUniqueIdentifier(a))){var i=new b(d,a);d.files.push(i),h.push(i),d.fire("fileAdded",i,c)}}),d.fire("filesAdded",h)};return d.uploadNextChunk=function(){var a=!1;if(d.getOpt("prioritizeFirstAndLastChunk")&&(e.each(d.files,function(b){return b.chunks.length&&"pending"==b.chunks[0].status()&&0===b.chunks[0].preprocessState?(b.chunks[0].send(),a=!0,!1):b.chunks.length>1&&"pending"==b.chunks[b.chunks.length-1].status()&&0===b.chunks[0].preprocessState?(b.chunks[b.chunks.length-1].send(),a=!0,!1):void 0}),a))return!0;if(e.each(d.files,function(b){return e.each(b.chunks,function(b){return"pending"==b.status()&&0===b.preprocessState?(b.send(),a=!0,!1):void 0}),a?!1:void 0}),a)return!0;var b=!1;return e.each(d.files,function(a){return e.each(a.chunks,function(a){var c=a.status();return"pending"==c||"uploading"==c||1===a.preprocessState?(b=!0,!1):void 0}),b?!1:void 0}),b||d.fire("complete"),!1},d.assignBrowse=function(a,b){"undefined"==typeof a.length&&(a=[a]),e.each(a,function(a){var c;"INPUT"===a.tagName&&"file"===a.type?c=a:(c=document.createElement("input"),c.setAttribute("type","file"),a.style.display="inline-block",a.style.position="relative",c.style.position="absolute",c.style.top=c.style.left=c.style.bottom=c.style.right=0,c.style.opacity=0,c.style.cursor="pointer",a.appendChild(c));var e=d.getOpt("maxFiles");"undefined"==typeof e||1!=e?c.setAttribute("multiple","multiple"):c.removeAttribute("multiple"),b?c.setAttribute("webkitdirectory","webkitdirectory"):c.removeAttribute("webkitdirectory"),c.addEventListener("change",function(a){h(a.target.files),a.target.value=""},!1)})},d.assignDrop=function(a){"undefined"==typeof a.length&&(a=[a]),e.each(a,function(a){a.addEventListener("dragover",g,!1),a.addEventListener("drop",f,!1)})},d.unAssignDrop=function(a){"undefined"==typeof a.length&&(a=[a]),e.each(a,function(a){a.removeEventListener("dragover",g),a.removeEventListener("drop",f)})},d.isUploading=function(){var a=!1;return e.each(d.files,function(b){return b.isUploading()?(a=!0,!1):void 0}),a},d.upload=function(){if(!d.isUploading()){d.fire("uploadStart");for(var a=1;a<=d.getOpt("simultaneousUploads");a++)d.uploadNextChunk()}},d.pause=function(){e.each(d.files,function(a){a.abort()}),d.fire("pause")},d.cancel=function(){e.each(d.files,function(a){a.cancel()}),d.fire("cancel")},d.progress=function(){var a=0,b=0;return e.each(d.files,function(c){a+=c.progress()*c.size,b+=c.size}),b>0?a/b:0},d.addFile=function(a){h([a])},d.removeFile=function(a){for(var b=d.files.length-1;b>=0;b--)d.files[b]===a&&d.files.splice(b,1)},d.getFromUniqueIdentifier=function(a){var b=!1;return e.each(d.files,function(c){c.uniqueIdentifier==a&&(b=c)}),b},d.getSize=function(){var a=0;return e.each(d.files,function(b){a+=b.size}),a},this};"undefined"!=typeof module&&(module.exports=Resumable);