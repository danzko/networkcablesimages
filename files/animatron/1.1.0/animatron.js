/*
 * Copyright (c) 2011-2014 by Animatron.
 * All rights are reserved.
 * 
 * Animatron Player is licensed under the MIT License.
 * 
 * v1.1.0, built at Tue Apr 15 2014 22:57:16 GMT+0200 (CEST) / 2014-04-15T20:57:16.554Z
 */
function Transform(){this.m=[1,0,0,1,0,0]}Transform.prototype.reset=function(){this.m=[1,0,0,1,0,0]};Transform.prototype.multiply=function(matrix){var m11=this.m[0]*matrix.m[0]+this.m[2]*matrix.m[1];var m12=this.m[1]*matrix.m[0]+this.m[3]*matrix.m[1];var m21=this.m[0]*matrix.m[2]+this.m[2]*matrix.m[3];var m22=this.m[1]*matrix.m[2]+this.m[3]*matrix.m[3];var dx=this.m[0]*matrix.m[4]+this.m[2]*matrix.m[5]+this.m[4];var dy=this.m[1]*matrix.m[4]+this.m[3]*matrix.m[5]+this.m[5];this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22;this.m[4]=dx;this.m[5]=dy};Transform.prototype.invert=function(){var d=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]);var m0=this.m[3]*d;var m1=-this.m[1]*d;var m2=-this.m[2]*d;var m3=this.m[0]*d;var m4=d*(this.m[2]*this.m[5]-this.m[3]*this.m[4]);var m5=d*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=m0;this.m[1]=m1;this.m[2]=m2;this.m[3]=m3;this.m[4]=m4;this.m[5]=m5};Transform.prototype.rotate=function(rad){var c=Math.cos(rad);var s=Math.sin(rad);var m11=this.m[0]*c+this.m[2]*s;var m12=this.m[1]*c+this.m[3]*s;var m21=this.m[0]*-s+this.m[2]*c;var m22=this.m[1]*-s+this.m[3]*c;this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22};Transform.prototype.rotateDegrees=function(angle){var rad=angle*Math.PI/180;var c=Math.cos(rad);var s=Math.sin(rad);var m11=this.m[0]*c+this.m[2]*s;var m12=this.m[1]*c+this.m[3]*s;var m21=this.m[0]*-s+this.m[2]*c;var m22=this.m[1]*-s+this.m[3]*c;this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22};Transform.prototype.translate=function(x,y){this.m[4]+=this.m[0]*x+this.m[2]*y;this.m[5]+=this.m[1]*x+this.m[3]*y};Transform.prototype.scale=function(sx,sy){this.m[0]*=sx;this.m[1]*=sx;this.m[2]*=sy;this.m[3]*=sy};Transform.prototype.transformPoint=function(px,py){return[px*this.m[0]+py*this.m[2]+this.m[4],px*this.m[1]+py*this.m[3]+this.m[5]]};Transform.prototype.shear=function(hx,hy){this.m[2]+=hx;this.m[1]+=hy};Transform.prototype.apply=function(ctx){var m=this.m;ctx.transform(m[0],m[1],m[2],m[3],m[4],m[5])};Transform.prototype.clone=function(){var cl=new Transform;cl.m[0]=this.m[0];cl.m[1]=this.m[1];cl.m[2]=this.m[2];cl.m[3]=this.m[3];cl.m[4]=this.m[4];cl.m[5]=this.m[5];return cl};Transform.prototype.inverted=function(){var clone=this.clone();clone.invert();return clone};if(typeof exports!=="undefined")exports.Transform=Transform;(function(_GLOBAL_){var $glob,$wnd,$doc;var isAmd=typeof define==="function"&&define.amd,isCommonJSModule=typeof module!="undefined",isCommonJSExports=typeof exports==="object";var $glob=typeof window!=="undefined"?window:_GLOBAL_;$wnd=typeof window!=="undefined"?window:null,$doc=typeof document!=="undefined"?document:null;if(!$glob)throw new Error("Failed to find global object");$glob.__anm_getGlobal=function(name){return($glob||$wnd)[name]};$glob.__anm_registerGlobally=function(name,obj){($glob||$wnd)[name]=obj};var $engine=DomEngine();__define("anm/engines/dom-engine",[],$engine);$glob.__anm_engine=$engine;function DomEngine(){return function(){var MARKER_ATTR="anm-player",URL_ATTR="data-url";var $DE={};$DE.require=__require;$DE.define=__define;$DE.__frameFunc=null;$DE.__cancelFunc=null;$DE.getRequestFrameFunc=function(){if($DE.__frameFunc)return $DE.__frameFunc;return $DE.__frameFunc=$wnd.requestAnimationFrame||$wnd.webkitRequestAnimationFrame||$wnd.mozRequestAnimationFrame||$wnd.oRequestAnimationFrame||$wnd.msRequestAnimationFrame||$wnd.__anm__frameGen||function(callback){return $wnd.setTimeout(callback,1e3/60)}};$DE.getCancelFrameFunc=function(){if($DE.__cancelFunc)return $DE.__cancelFunc;return $DE.__cancelFunc=$wnd.cancelAnimationFrame||$wnd.webkitCancelAnimationFrame||$wnd.mozCancelAnimationFrame||$wnd.oCancelAnimationFrame||$wnd.msCancelAnimationFrame||$wnd.__anm__frameRem||function(id){return $wnd.clearTimeout(id)}};$DE.PX_RATIO=$wnd.devicePixelRatio||1;$DE.ajax=function(url,callback,errback){var req=false;if(!$wnd.ActiveXObject){req=new $wnd.XMLHttpRequest}else{try{req=new $wnd.ActiveXObject("Msxml2.XMLHTTP")}catch(e1){try{req=$wnd.ActiveXObject("Microsoft.XMLHTTP")}catch(e2){throw new Error("No AJAX/XMLHttp support")}}}if(!req){throw new Error("Failed to create XMLHttp instance")}var whenDone=function(){if(req.readyState==4){if(req.status==200){if(callback)callback(req)}else{var error=new Error("AJAX request for "+url+" returned "+req.status+" instead of 200");if(errback){errback(error,req)}else{throw error}}}};req.onreadystatechange=whenDone;req.open("GET",url,true);req.send(null)};$DE.__textBuf=null;$DE.createTextMeasurer=function(){var buff=$DE.__textBuf;if(!buff){var _div=$doc.createElement("div");_div.style.visibility="hidden";_div.style.position="absolute";_div.style.top=-1e4+"px";_div.style.left=-1e4+"px";var _span=$doc.createElement("span");_div.appendChild(_span);$doc.body.appendChild(_div);$DE.__textBuf=_span;buff=$DE.__textBuf}return function(text,lines_arg){var has_arg=typeof lines_arg!=="undefined";var lines=has_arg?lines_arg:text.lines;buff.style.font=text.font;buff.style.textAlign=text.align;buff.style.verticalAlign=text.baseline||"bottom";if(Array.isArray(text.lines)){buff.textContent=text.lines.join("<br/>")}else{buff.textContent=text.lines.toString()}return[buff.offsetWidth,buff.offsetHeight]}};$DE.createTransform=function(){return new Transform};$DE.getElementById=function(id){return $doc.getElementById(id)};$DE.findElementPosition=function(elm){var curleft=0,curtop=0;do{curleft+=elm.offsetLeft;curtop+=elm.offsetTop}while(elm=elm.offsetParent);return[curleft,curtop]};$DE.findScrollAwarePosition=function(elm){var curleft=0,curtop=0;do{curleft+=elm.offsetLeft-(elm!==document.body?elm.scrollLeft:document.documentElement.scrollLeft);curtop+=elm.offsetTop-(elm!==document.body?elm.scrollTop:document.documentElement.scrollTop)}while(elm=elm.offsetParent);return[curleft,curtop]};$DE.moveElementTo=function(elm,pos){elm.style.left=pos[0]+"px";elm.style.top=pos[1]+"px"};$DE.__trashBin;$DE.disposeElement=function(elm){var trashBin=$DE.__trashBin;if(!trashBin){trashBin=$doc.createElement("div");trashBin.id="trash-bin";trashBin.style.display="none";$doc.body.appendChild(trashBin);$DE.__trashBin=trashBin}trashBin.appendChild(elm);trashBin.innerHTML=""};$DE.detachElement=function(parent,child){(parent||child.parentNode).removeChild(child)};$DE.createCanvas=function(width,height,bg,ratio){var cvs=$doc.createElement("canvas");$DE.setCanvasSize(cvs,width,height,ratio);if(bg)$DE.setCanvasBackground(cvs,bg);return cvs};$DE.assignPlayerToCanvas=function(cvs,player){if(!cvs)return null;if(cvs.getAttribute(MARKER_ATTR))throw new Error("Player is already attached to canvas '"+id+"'.");cvs.setAttribute(MARKER_ATTR,true);return cvs};$DE.playerAttachedTo=function(cvs,player){return cvs.hasAttribute(MARKER_ATTR)};$DE.detachPlayer=function(cvs,player){cvs.removeAttribute(MARKER_ATTR)};$DE.getContext=function(cvs,type){return cvs.getContext(type)};$DE.extractUserOptions=function(cvs){var ratio=$DE.PX_RATIO;var width=cvs.getAttribute("anm-width");if(!width){width=cvs.hasAttribute("width")?cvs.getAttribute("width")/ratio:undefined}var height=cvs.getAttribute("anm-height");if(!height){height=cvs.hasAttribute("height")?cvs.getAttribute("height")/ratio:undefined}return{debug:cvs.getAttribute("anm-debug"),mode:cvs.getAttribute("anm-mode"),repeat:cvs.getAttribute("anm-repeat"),zoom:cvs.getAttribute("anm-zoom"),speed:cvs.getAttribute("anm-speed"),width:width,height:height,bgColor:cvs.getAttribute("anm-bgcolor"),drawStill:cvs.getAttribute("anm-draw-still"),audioEnabled:cvs.getAttribute("anm-audio-enabled"),controlsEnabled:cvs.getAttribute("anm-controls-enabled"),handleEvents:cvs.getAttribute("anm-handle-events"),forceSceneSize:cvs.getAttribute("anm-force-scene-size"),inParent:undefined,muteErrors:cvs.getAttribute("anm-mute-errors")}};$DE.checkPlayerCanvas=function(cvs){return true};$DE.hasUrlToLoad=function(cvs){return cvs.getAttribute(URL_ATTR)};$DE.setTabIndex=function(cvs,idx){cvs.setAttribute("tabindex",idx)};$DE.getCanvasParams=function(cvs){if(!cvs.__anm_width||!cvs.__anm_height)return null;return[cvs.__anm_width,cvs.__anm_height,$DE.PX_RATIO]};$DE.getCanvasSize=function(cvs){return[cvs.getAttribute("clientWidth")||cvs.clientWidth,cvs.getAttribute("clientHeight")||cvs.clientHeight]};$DE.getCanvasPos=function(cvs){return $DE.findScrollAwarePosition(cvs)};$DE.getCanvasBounds=function(cvs){var params=$DE.getCanvasParams(cvs);if(!params)return null;var pos=$DE.getCanvasPos(cvs);return[pos[0],pos[1],params[0],params[1],params[2]]};$DE.setCanvasSize=function(cvs,width,height,ratio){var ratio=ratio||$DE.PX_RATIO;var _w=width|0,_h=height|0;cvs.__anm_ratio=ratio;cvs.__anm_width=_w;cvs.__anm_height=_h;if(!cvs.style.width)cvs.style.width=_w+"px";if(!cvs.style.height)cvs.style.height=_h+"px";cvs.setAttribute("width",_w*(ratio||1));cvs.setAttribute("height",_h*(ratio||1));$DE._saveCanvasPos(cvs);return[_w,_h]};$DE.setCanvasPos=function(cvs,x,y){cvs.__anm_usr_x=x;cvs.__anm_usr_y=y;$engine._saveCanvasPos(cvs)};$DE.setCanvasBackground=function(cvs,bg){cvs.style.backgroundColor=bg};$DE.updateCanvasMetrics=function(cvs){var pos=$DE.getCanvasPos(cvs),size=$DE.getCanvasSize(cvs);cvs.__anm_ratio=$DE.PX_RATIO;cvs.__anm_x=pos[0];cvs.__anm_y=pos[1];cvs.__anm_width=size[0];cvs.__anm_height=size[1];$DE._saveCanvasPos(cvs)};$DE._saveCanvasPos=function(cvs){var gcs=$doc.defaultView&&$doc.defaultView.getComputedStyle;var cpl=gcs?parseInt(gcs(cvs,null).paddingLeft,10)||0:0,cpt=gcs?parseInt(gcs(cvs,null).paddingTop,10)||0:0,cbl=gcs?parseInt(gcs(cvs,null).borderLeftWidth,10)||0:0,cbt=gcs?parseInt(gcs(cvs,null).borderTopWidth,10)||0:0;var html=$doc.body.parentNode,htol=html.offsetLeft,htot=html.offsetTop;var elm=cvs,ol=cpl+cbl+htol,ot=cpt+cbt+htot;if(elm.offsetParent!==undefined){do{ol+=elm.offsetLeft;ot+=elm.offsetTop}while(elm=elm.offsetParent)}ol+=cpl+cbl+htol;ot+=cpt+cbt+htot;cvs.__rOffsetLeft=ol||cvs.__anm_usr_x;cvs.__rOffsetTop=ot||cvs.__anm_usr_y};$DE.addChildCanvas=function(id,parent,pos,style,inside){var _ratio=$DE.PX_RATIO,_x=pos[0],_y=pos[1],_w=pos[2],_h=pos[3],_pp=$DE.findElementPosition(parent),_bp=[_pp[0]+parent.clientLeft+_x,_pp[1]+parent.clientTop+_y],_cp=inside?[parent.parentNode.offsetLeft+parent.clientLeft+_x,parent.parentNode.offsetTop+parent.clientTop+_y]:_bp;var cvs=$DE.createCanvas(_w,_h,null,_ratio);cvs.id=parent.id?"__"+parent.id+"_"+id:"__anm_"+id;if(style._class)cvs.className=style._class;for(var prop in style){cvs.style[prop]=style[prop]}cvs.style.left=_cp[0]+"px";cvs.style.top=_cp[1]+"px";var appendTo=inside?parent.parentNode:$doc.body;if(inside){appendTo.style.position="relative"}appendTo.appendChild(cvs);return cvs};$DE.getEventPos=function(evt,elm){if(elm){var shift=$DE.findElementPosition(elm);return[evt.pageX-shift[0],evt.pageY-shift[1]]}else return[evt.pageX,evt.pageY]};$DE.subscribeWindowEvents=function(handlers){for(var type in handlers){$wnd.addEventListener(type,handlers[type],false)}};$DE.subscribeCanvasEvents=function(cvs,handlers){for(var type in handlers){cvs.addEventListener(type,handlers[type],false)}};$DE.unsubscribeCanvasEvents=function(cvs,handlers){for(var type in handlers){cvs.removeEventListener(type,handlers[type])}};$DE.keyEvent=function(e){return{key:e.keyCode!=null?e.keyCode:e.which,ch:e.charCode}};$DE.mouseEvent=function(e,cvs){return{pos:$DE.getEventPos(e,cvs)}};var _kevt=$DE.keyEvent,_mevt=$DE.mouseEvent;$DE.subscribeSceneToEvents=function(cvs,scene,map){if(cvs.__anm_subscribed&&cvs.__anm_subscribed[scene.id]){return}if(!cvs.__anm_handlers)cvs.__anm_handlers={};if(!cvs.__anm_subscribed)cvs.__anm_subscribed={};var handlers=cvs.__anm_subscribed[scene.id]||{mouseup:function(evt){scene.fire(map.mouseup,_mevt(evt,cvs))},mousedown:function(evt){scene.fire(map.mousedown,_mevt(evt,cvs))},mousemove:function(evt){scene.fire(map.mousemove,_mevt(evt,cvs))},mouseover:function(evt){scene.fire(map.mouseover,_mevt(evt,cvs))},mouseout:function(evt){scene.fire(map.mouseout,_mevt(evt,cvs))},click:function(evt){scene.fire(map.click,_mevt(evt,cvs))},dblclick:function(evt){scene.fire(map.dblclick,_mevt(evt,cvs))},keyup:function(evt){scene.fire(map.keyup,_kevt(evt))},keydown:function(evt){scene.fire(map.keydown,_kevt(evt))},keypress:function(evt){scene.fire(map.keypress,_kevt(evt))}};cvs.__anm_handlers[scene.id]=handlers;cvs.__anm_subscribed[scene.id]=true;$DE.subscribeCanvasEvents(cvs,handlers)};$DE.unsubscribeSceneFromEvents=function(cvs,scene){if(!cvs.__anm_handlers||!cvs.__anm_subscribed||!cvs.__anm_subscribed[scene.id])return;var handlers=cvs.__anm_handlers[scene.id];if(!handlers)return;$DE.unsubscribeCanvasEvents(cvs,handlers)};return $DE}(this)}function __getAllFromGlob(what){var what=Array.isArray(what)?what:[what],collected=[];for(var i=0,il=what.length;i<il;i++){collected.push(__getGlob(what[i]))}return collected}function __getGlob(path){var split=path.split("/");var trg=$glob;for(var i=0,il=split.length;i<il;i++){trg=trg[split[i]]}return trg}function __setGlob(path,val){var split=path.split("/");var trg=$glob;for(var i=0,il=split.length;i<il;i++){if(!trg[split[i]]){trg[split[i]]=i===il-1?val:{}}else if(i===il-1){for(var prop in val){trg[split[i]][prop]=val[prop]}}trg=trg[split[i]]}}function __prepareForNativeRequire(what){var what=Array.isArray(what)?what:[what],collected=[],split;for(var i=0,il=what.length;i<il;i++){collected.push(__adaptForNativeRequire(what[i]))}return collected}function __adaptForNativeRequire(what){var split=what[i].split("/");if(split.length==1)return split[0];var trg="";for(var i=1,il=split.length;i<il;i++){trg+=split[i]+(i!==il-1?"/":"")}return trg}function __require(what,func){if(isAmd||isCommonJSModule||isCommonJSExports){require(__prepareForNativeRequire(what),func)}else{func.apply(null,__getGlob(what))}}function __define(arg1,arg2,arg3){var id=arg3?arg1:null,req=arg3?arg2:arg1,value=arg3?arg3:arg2;if(isAmd){define.apply(null,arguments)}else{var isFunc=typeof value=="function";var call_with=req?isCommonJSModule||isCommonJSExports?__prepareForNativeRequire(req):__getAllFromGlob(req):[];if(!isFunc){for(var i=0,il=call_with.length;i<il;i++){require(call_with[i])}}var result=typeof value=="function"?value.apply(null,call_with):value;if(isCommonJSModule){module.exports=result}else if(isCommonJSExports){exports=result}else{__setGlob(id,result)}}}})(this);(function(_GLOBAL_){var PUBLIC_NAMESPACE="anm";var PRIVATE_CONF="__anm_conf",ENGINE_VAR="__anm_engine";var _getGlobal=_GLOBAL_["__anm_getGlobal"],_registerGlobally=_GLOBAL_["__anm_registerGlobally"];if(!_getGlobal||!_registerGlobally)throw new Error("Potentially, no Engine was provided to player, so we cannot proceed :(");var $glob=_GLOBAL_;$conf=_getGlobal(PRIVATE_CONF)||{logImport:false,logResMan:false,logEvents:false,logLevel:0,doNotLoadAudio:false,doNotLoadImages:false,doNotRenderShadows:false,engine:null};_registerGlobally(PRIVATE_CONF,$conf);var $engine=getEngine();function getEngine(){if(_getGlobal(ENGINE_VAR))return $conf.engine=_getGlobal(ENGINE_VAR);if(typeof DomEngine==="undefined")throw new Error("Can't find any Engine to fallback to. DomEngine is not accessible.");return $conf.engine=DomEngine(PUBLIC_NAMESPACE,$conf)}function switchEngineTo($engine){throw new Error("Not implemented")}$engine.define(PUBLIC_NAMESPACE,[],function(){var $publ={global:$glob,undefined:{}.___undefined___,C:null,M:null,I:null,console:null,guid:guid,conf:$conf,is:__is,iter:iter,namespace:PUBLIC_NAMESPACE,engine:$engine,switchEngineTo:switchEngineTo,registerModule:registerModule,getModule:getModule,isModuleAccessible:isModuleAccessible,registerImporter:registerImporter,getImporter:getImporter,createImporter:createImporter,isImporterAccessible:isImporterAccessible,provideEvents:provideEvents,registerEvent:registerEvent,resource_manager:new ResourceManager,player_manager:null,Strings:null,Errors:null,SystemError:null,PlayerError:null,AnimationError:null,getGlobal:_getGlobal,registerGlobally:_registerGlobally};$publ.C={};var C=$publ.C;C.L_DEBUG=1;C.L_INFO=2;C.L_WARN=4;C.L_ERROR=8;$conf.logLevel=C.L_ERROR;var nop=function(){};var console=$glob["console"]||{log:nop,info:nop,warn:nop,error:nop};$publ.log={debug:function(){if($conf.logLevel&C.L_DEBUG)(console.debug||console.log).apply(console,arguments)},info:function(){if($conf.logLevel&C.L_INFO)(console.info||console.log).apply(console,arguments)},warn:function(){if($conf.logLevel&C.L_WARN)(console.warn||console.log).apply(console,arguments)},error:function(){if($conf.logLevel&C.L_ERROR)(console.error||console.log).apply(console,arguments)}};var $log=$publ.log;$publ.M={};var M=$publ.M;function registerModule(alias,conf){if(M[alias])throw new Error("Module "+alias+" is already registered!");M[alias]=conf}function getModule(alias){return M[alias]}function isModuleAccessible(alias){return typeof M[alias]!=="undefined"}$publ.I={};var I=$publ.I;function registerImporter(alias,conf){if(I[alias])throw new Error("Importer "+alias+" is already registered!");I[alias]=conf}function getImporter(alias){return I[alias]}function createImporter(alias){return new I[alias]}function isImporterAccessible(alias){return typeof I[alias]!=="undefined"}C.__enmap={};function registerEvent(id,name,value){C[id]=value;C.__enmap[value]=name}function provideEvents(subj,events){subj.prototype._initHandlers=function(evts){return function(){var _hdls={};this.handlers=_hdls;for(var ei=0,el=evts.length;ei<el;ei++){_hdls[evts[ei]]=[]}}}(events);subj.prototype.on=function(event,handler){if(!this.handlers)throw new Error("Instance is not initialized with handlers, call __initHandlers in its constructor");if(!this.provides(event))throw new Error("Event '"+C.__enmap[event]+"' not provided by "+this);if(!handler)throw new Error("You are trying to assign "+"undefined handler for event "+event);this.handlers[event].push(handler);return this.handlers[event].length-1};subj.prototype.fire=function(event){if(!this.handlers)throw new Error("Instance is not initialized with handlers, call __initHandlers in its constructor");if(!this.provides(event))throw new Error("Event '"+C.__enmap[event]+"' not provided by "+this);if(this.disabled)return;var evt_args=Array.prototype.slice.call(arguments,1);if(this.handle__x&&!this.handle__x.apply(this,arguments))return;var name=C.__enmap[event];if(this["handle_"+name])this["handle_"+name].apply(this,evt_args);var _hdls=this.handlers[event];for(var hi=0,hl=_hdls.length;hi<hl;hi++){_hdls[hi].apply(this,evt_args)}};subj.prototype.provides=function(evts){return function(event){if(!this.handlers)throw new Error("Instance is not initialized with handlers, call __initHandlers in its constructor");if(!event)return evts;return this.handlers.hasOwnProperty(event)}}(events);subj.prototype.unbind=function(event,idx){if(!this.handlers)throw new Error("Instance is not initialized with handlers, call __initHandlers in its constructor");if(!this.provides(event))throw new Error("Event "+event+" not provided by "+this);if(this.handlers[event][idx]){this.handlers[event].splice(idx,1)}else{throw new Error("No such handler "+idx+" for event "+event)}};subj.prototype.disposeHandlers=function(){if(!this.handlers)throw new Error("Instance is not initialized with handlers, call __initHandlers in its constructor");var _hdls=this.handlers;for(var evt in _hdls){if(_hdls.hasOwnProperty(evt))_hdls[evt]=[]}};var _event;for(var ei=0,el=events.length;ei<el;ei++){_event=events[ei];subj.prototype["e_"+_event]=function(event){return function(evtobj){this.fire(event,evtobj)}}(_event)}}function ResourceManager(){this._cache={};this._errors={};this._waiting={};this._subscriptions=[]}ResourceManager.prototype.subscribe=function(urls,callbacks){var filteredUrls=[];if($conf.logResMan){$log.debug("subscribing "+callbacks.length+" to "+urls.length+" urls: "+urls)}for(var i=0;i<urls.length;i++){if(urls[i])filteredUrls.push(urls[i])}this._subscriptions.push([filteredUrls,__is.arr(callbacks)?callbacks:[callbacks]]);this.check()};ResourceManager.prototype.loadOrGet=function(url,loader,onComplete,onError){var me=this;if($conf.logResMan){$log.debug("request to load "+url)}if(me._cache[url]){if($conf.logResMan){$log.debug("> already received, trigerring success")}var result=me._cache[url];me.trigger(url,result);if(onComplete)onComplete(result)}else if(me._errors[url]){if($conf.logResMan){$log.debug("> failed to load before, notifying with error")}if(onError)onError(me._errors[url])}else if(!me._waiting[url]){if($conf.logResMan){$log.debug("> not cached, requesting")}me._waiting[url]=loader;loader(function(result){if($conf.logResMan){$log.debug("file at "+url+" succeeded to load, triggering success")}me.trigger(url,result);if(onComplete)onComplete(result);me.check()},function(err){if($conf.logResMan){$log.debug("file at "+url+" failed to load, triggering eror")}me.error(url,err);if(onError)onError(err);me.check()})}else{if($conf.logResMan){$log.debug("> someone is already waiting for it, subscribing")}if(me._waiting[url]!==loader)me.subscribe([url],function(res){onComplete(res[0])})}};ResourceManager.prototype.trigger=function(url,value){if(this._cache[url]||this._errors[url]){this.check();return}if($conf.logResMan){$log.debug("triggering success for url "+url)}delete this._waiting[url];this._cache[url]=value};ResourceManager.prototype.error=function(url,err){if(this._cache[url]||this._errors[url]){this.check();return}if($conf.logResMan){$log.debug("triggering error for url "+url)}delete this._waiting[url];this._errors[url]=err};ResourceManager.prototype.has=function(url){return typeof this._cache[url]!=="undefined"};ResourceManager.prototype.check=function(){if($conf.logResMan){$log.debug("checking subscriptions")}var subscriptions=this._subscriptions,cache=this._cache,errors=this._errors,to_remove=null;if($conf.logResMan){$log.debug("number of subscriptions: "+subscriptions.length)}for(var i=0,il=subscriptions.length;i<il;i++){var urls=subscriptions[i][0],callbacks=subscriptions[i][1],error_count=0,success_count=0;for(var u=0,ul=urls.length;u<ul;u++){if(errors[urls[u]])error_count++;if(cache[urls[u]])success_count++}if($conf.logResMan){$log.debug("stats for "+urls+". length: "+urls.length+", "+"success: "+success_count+", errors: "+error_count+", ready: "+(success_count+error_count===urls.length))}if(success_count+error_count===urls.length){var ready=[];for(var u=0,ul=urls.length;u<ul;u++){ready.push(cache[urls[u]]||errors[urls[u]])}if($conf.logResMan){$log.debug("notifying subscribers that "+urls+" are all ready")}for(var k=0,kl=callbacks.length;k<kl;k++){callbacks[k](ready,error_count)}if(!to_remove)to_remove=[];to_remove.push(subscriptions[i])}}if(to_remove){for(var i=0,il=to_remove.length;i<il;i++){if($conf.logResMan){$log.debug("removing notified subscribers for "+to_remove[i][0]+" from queue")}subscriptions.splice(subscriptions.indexOf(to_remove[i]),1)}}};ResourceManager.prototype.clear=function(){this._cache={};this._errors={};this._waiting={};this._subscriptions=[]};registerEvent("S_NEW_PLAYER","new_player","new_player");registerEvent("S_PLAYER_DETACH","player_detach","player_detach");function PlayerManager(){this.hash={};this.instances=[];this._initHandlers()}provideEvents(PlayerManager,[C.S_NEW_PLAYER,C.S_PLAYER_DETACH]);PlayerManager.prototype.handle__x=function(evt,player){if(evt==C.S_NEW_PLAYER){this.hash[player.id]=player;this.instances.push(player)}else if(evt==C.S_PLAYER_DETACH){}return true};PlayerManager.prototype.getPlayer=function(cvs_id){return this.hash[cvs_id]};$publ.player_manager=new PlayerManager;function guid(){return Math.random().toString(36).substring(2,10)+Math.random().toString(36).substring(2,10)}var __is=function(){var __defined=function(v){return!(typeof v==="undefined"||typeof v==="null"||v===null||v===undefined)};var __finite=isFinite||Number.isFinite||function(n){return n!==Infinity};var __nan=isNaN||Number.isNaN||function(n){n!==NaN};function __builder(obj){return typeof anm.Builder!=="undefined"&&obj instanceof anm.Builder}var __arr=Array.isArray;function __num(n){return!__nan(parseFloat(n))&&__finite(n)}function __fun(fun){return fun!=null&&typeof fun==="function"}function __obj(obj){return obj!=null&&typeof obj==="object"}function __str(obj){return obj!=null&&typeof obj==="string"}var __is={};__is.defined=__defined;__is.finite=__finite;__is.nan=__nan;__is.builder=__builder;__is.arr=__arr;__is.num=__num;__is.fun=__fun;__is.obj=__obj;__is.str=__str;return __is}();$publ.is=__is;function StopIteration(){}function iter(a){if(a.__iter){a.__iter.reset();return a.__iter}var pos=0,len=a.length;return a.__iter={next:function(){if(pos<len)return a[pos++];pos=0;throw new StopIteration},hasNext:function(){return pos<len},remove:function(){len--;return a.splice(--pos,1)},reset:function(){pos=0;len=a.length},get:function(){return a[pos]},each:function(f,rf){this.reset();while(this.hasNext()){if(f(this.next())===false){if(rf)rf(this.remove());else this.remove()}}}}}function __errorAs(name){return function(message){if(Error.captureStackTrace)Error.captureStackTrace(this,this);var err=new Error(message||"");err.name=name;return err}}var SystemError=__errorAs("SystemError"),PlayerError=__errorAs("PlayerError"),AnimationError=__errorAs("AnimationError");$publ.SystemError=SystemError;$publ.PlayerError=PlayerError;$publ.AnimationError=AnimationError;var Strings={};$publ.Strings=Strings;Strings.COPYRIGHT="© Animatron Player";Strings.LOADING="Loading...";Strings.LOADING_ANIMATION="Loading {0}...";var Errors={};$publ.Errors=Errors;Errors.S={};Errors.P={};Errors.A={};Errors.S.NO_JSON_PARSER="JSON parser is not accessible";Errors.S.ERROR_HANDLING_FAILED="Error-handling mechanics were broken with error {0}";Errors.S.NO_METHOD_FOR_PLAYER="No method '{0}' exist for player";Errors.P.NO_IMPORTER_TO_LOAD_WITH="Cannot load this project without importer. Please define it";Errors.P.NO_CANVAS_WITH_ID="No canvas found with given id: {0}";Errors.P.NO_CANVAS_WAS_PASSED="No canvas was passed";Errors.P.CANVAS_NOT_VERIFIED="Canvas is not verified by the provider";Errors.P.CANVAS_NOT_PREPARED="Canvas is not prepared, don't forget to call 'init' method";Errors.P.ALREADY_PLAYING="Player is already in playing mode, please call "+"'stop' or 'pause' before playing again";Errors.P.PAUSING_WHEN_STOPPED="Player is stopped, so it is not allowed to pause";Errors.P.NO_SCENE_PASSED="No scene passed to load method";Errors.P.NO_STATE="There's no player state defined, nowhere to draw, "+"please load something in player before "+"calling its playing-related methods";Errors.P.NO_SCENE="There's nothing at all to manage with, "+"please load something in player before "+"calling its playing-related methods";Errors.P.COULD_NOT_LOAD_WHILE_PLAYING="Could not load any scene while playing or paused, "+"please stop player before loading";Errors.P.BEFOREFRAME_BEFORE_PLAY="Please assign beforeFrame callback before calling play()";Errors.P.AFTERFRAME_BEFORE_PLAY="Please assign afterFrame callback before calling play()";Errors.P.BEFORERENDER_BEFORE_PLAY="Please assign beforeRender callback before calling play()";Errors.P.AFTERRENDER_BEFORE_PLAY="Please assign afterRender callback before calling play()";Errors.P.PASSED_TIME_VALUE_IS_NO_TIME="Given time is not allowed, it is treated as no-time";Errors.P.PASSED_TIME_NOT_IN_RANGE="Passed time ({0}) is not in scene range";Errors.P.DURATION_IS_NOT_KNOWN="Duration is not known";Errors.P.ALREADY_ATTACHED="Player is already attached to this canvas, please use another one";Errors.P.INIT_TWICE="Initialization was called twice";Errors.P.INIT_AFTER_LOAD="Initialization was called after loading a scene";Errors.A.ELEMENT_IS_REGISTERED="This element is already registered in scene";Errors.A.ELEMENT_IS_NOT_REGISTERED="There is no such element registered in scene";Errors.A.UNSAFE_TO_REMOVE="Unsafe to remove, please use iterator-based looping (with returning false from iterating function) to remove safely";Errors.A.NO_ELEMENT_TO_REMOVE="Please pass some element or use detach() method";Errors.A.NO_ELEMENT="No such element found";Errors.A.ELEMENT_NOT_ATTACHED="Element is not attached to something at all";Errors.A.MODIFIER_NOT_ATTACHED="Modifier wasn't applied to anything";Errors.A.NO_MODIFIER_PASSED="No modifier was passed";Errors.A.NO_PAINTER_PASSED="No painter was passed";Errors.A.MODIFIER_REGISTERED="Modifier was already added to this element";Errors.A.PAINTER_REGISTERED="Painter was already added to this element";Errors.A.RESOURCES_FAILED_TO_LOAD="Some of resources required to play this animation were failed to load";Errors.A.MASK_SHOULD_BE_ATTACHED_TO_SCENE="Element to be masked should be attached to scene when rendering";return $publ})})(this);if(typeof __anm_engine==="undefined")throw new Error("No engine found!");__anm_engine.define("anm/Player",["anm"],function(anm){var $engine=anm.engine;var $conf=anm.conf;var $log=anm.log;var provideEvents=anm.provideEvents;var registerEvent=anm.registerEvent;var getGlobal=anm.getGlobal;var registerGlobally=anm.registerGlobally;var iter=anm.iter;var guid=anm.guid;var is=anm.is;var __defined=is.defined,__finite=is.finite,__nan=is.nan,__builder=is.builder,__arr=is.arr,__num=is.num,__fun=is.fun,__obj=is.obj,__str=is.str;var Strings=anm.Strings,Errors=anm.Errors;var SystemError=anm.SystemError,SysErr=SystemError;var PlayerError=anm.PlayerError,PlayerErr=PlayerError;var AnimationError=anm.AnimationError,AnimErr=AnimationError;function __collect_to(str,start,ch){var result="";for(var i=start;str[i]!==ch;i++){if(i===str.length)throw new SysErr("Reached end of string");result+=str[i]}return result}function get_rgb(hex){if(!hex||!hex.length)return[0,0,0];var _hex=hex.substring(1);if(_hex.length===3){_hex=_hex[0]+_hex[0]+_hex[1]+_hex[1]+_hex[2]+_hex[2]}var bigint=parseInt(_hex,16);return[bigint>>16&255,bigint>>8&255,bigint&255]}function to_rgba(r,g,b,a){return"rgba("+Math.floor(r)+","+Math.floor(g)+","+Math.floor(b)+","+(typeof a!=="undefined"?a:1)+")"}function fmt_time(time){var _time=Math.abs(time),_h=Math.floor(_time/3600),_m=Math.floor((_time-_h*3600)/60),_s=Math.floor(_time-_h*3600-_m*60);return(time<0?"-":"")+(_h>0?(_h<10?"0"+_h:_h)+":":"")+(_m<10?"0"+_m:_m)+":"+(_s<10?"0"+_s:_s)}function ell_text(text,max_len){if(!text)return"";var _len=text.length;if(_len<=max_len)return text;var _semilen=Math.floor(_len/2)-2;return text.slice(0,_semilen)+"..."+text.slice(_len-_semilen)}function __close(n1,n2,precision){if(!(precision===0)){precision=precision||2}var multiplier=Math.pow(10,precision);return Math.round(n1*multiplier)==Math.round(n2*multiplier)}function __roundTo(n,precision){if(!precision)return Math.round(n);var multiplier=Math.pow(10,precision);return Math.round(n*multiplier)/multiplier}function __paramsToObj(pstr){var o={},ps=pstr.split("&"),i=ps.length,pair;while(i--){pair=ps[i].split("=");o[pair[0]]=pair[1]}return o}function obj_clone(what){var dest={};for(var prop in what){dest[prop]=what[prop]}return dest}function _mrg_obj(src,backup,trg){if(!backup)return src;var res=trg||{};for(var prop in backup){res[prop]=__defined(src[prop])?src[prop]:backup[prop]}return res}function _strf(str,subst){var args=subst;return str.replace(/{(\d+)}/g,function(match,number){return __defined(args[number])?args[number]:match})}var TIME_PRECISION=9;function __adjust(t){return __roundTo(t,TIME_PRECISION)}function __t_cmp(t0,t1){if(__adjust(t0)>__adjust(t1))return 1;if(__adjust(t0)<__adjust(t1))return-1;return 0}var C=anm.C;var _ResMan=anm.resource_manager;var _PlrMan=anm.player_manager;C.NOTHING=-1;C.STOPPED=0;C.PLAYING=1;C.PAUSED=2;C.LOADING=3;C.RES_LOADING=4;C.ERROR=5;C.M_CONTROLS_ENABLED=1;C.M_CONTROLS_DISABLED=2;C.M_INFO_ENABLED=4;C.M_INFO_DISABLED=8;C.M_HANDLE_EVENTS=16;C.M_DO_NOT_HANDLE_EVENTS=32;C.M_DRAW_STILL=64;C.M_DO_NOT_DRAW_STILL=128;C.M_INFINITE_DURATION=256;C.M_FINITE_DURATION=512;C.M_PREVIEW=C.M_CONTROLS_DISABLED|C.M_INFO_DISABLED|C.M_DO_NOT_HANDLE_EVENTS|C.M_DRAW_STILL|C.M_FINITE_DURATION;C.M_DYNAMIC=C.M_CONTROLS_DISABLED|C.M_INFO_DISABLED|C.M_HANDLE_EVENTS|C.M_DO_NOT_DRAW_STILL|C.M_INFINITE_DURATION;C.M_VIDEO=C.M_CONTROLS_ENABLED|C.M_INFO_ENABLED|C.M_DO_NOT_HANDLE_EVENTS|C.M_DRAW_STILL|C.M_FINITE_DURATION;C.M_SANDBOX=C.M_CONTROLS_DISABLED|C.M_INFO_DISABLED|C.M_DO_NOT_HANDLE_EVENTS|C.M_DO_NOT_DRAW_STILL|C.M_FINITE_DURATION;
C.LT_BUILDER=1;C.LT_SCENE=2;C.LT_CLIPS=3;C.LT_IMPORT=4;C.LT_URL=5;registerEvent("X_MCLICK","mclick",1);registerEvent("X_MDCLICK","mdclick",2);registerEvent("X_MUP","mup",4);registerEvent("X_MDOWN","mdown",8);registerEvent("X_MMOVE","mmove",16);registerEvent("X_MOVER","mover",32);registerEvent("X_MOUT","mout",64);registerEvent("XT_MOUSE","mouse",C.X_MCLICK|C.X_MDCLICK|C.X_MUP|C.X_MDOWN|C.X_MMOVE|C.X_MOVER|C.X_MOUT);registerEvent("X_KPRESS","kpress",128);registerEvent("X_KUP","kup",256);registerEvent("X_KDOWN","kdown",1024);registerEvent("XT_KEYBOARD","keyboard",C.X_KPRESS|C.X_KUP|C.X_KDOWN);registerEvent("XT_CONTROL","control",C.XT_KEYBOARD|C.XT_MOUSE);registerEvent("X_DRAW","draw","draw");registerEvent("X_START","start","x_start");registerEvent("X_STOP","stop","x_stop");registerEvent("S_PLAY","play","play");registerEvent("S_PAUSE","pause","pause");registerEvent("S_STOP","stop","stop");registerEvent("S_REPEAT","repeat","repeat");registerEvent("S_IMPORT","import","import");registerEvent("S_LOAD","load","load");registerEvent("S_RES_LOAD","res_load","res_load");registerEvent("S_ERROR","error","error");var DOM_TO_EVT_MAP={mouseup:C.X_MUP,mousedown:C.X_MDOWN,mousemove:C.X_MMOVE,mouseover:C.X_MOVER,mouseout:C.X_MOUT,click:C.X_MCLICK,dblclick:C.X_MDCLICK,keyup:C.X_KUP,keydown:C.X_KDOWN,keypress:C.X_KPRESS};var M={};C.MOD_PLAYER="player";var global_opts={liveDebug:false,autoFocus:true,setTabindex:true};M[C.MOD_PLAYER]=global_opts;var I={};function Player(){this.id="";this.state=null;this.anim=null;this.canvas=null;this.ctx=null;this.controls=null;this.__canvasPrepared=false;this.__instanceNum=++Player.__instances;this.__makeSafe(Player._SAFE_METHODS)}Player.__instances=0;Player.PREVIEW_POS=0;Player.PEFF=0;Player.NO_TIME=-1;Player.DEFAULT_CONFIGURATION={debug:false,repeat:false,autoPlay:false,mode:C.M_VIDEO,zoom:1,speed:1,width:undefined,height:undefined,infiniteDuration:undefined,drawStill:undefined,audioEnabled:true,imagesEnabled:true,shadowsEnabled:true,handleEvents:undefined,controlsEnabled:undefined,bgColor:undefined,forceSceneSize:false,inParent:false,muteErrors:false};Player._SAFE_METHODS=["init","load","play","stop","pause","drawAt"];Player.prototype.init=function(cvs,opts){if(this.canvas)throw new PlayerErr(Errors.P.INIT_TWICE);if(this.anim)throw new PlayerErr(Errors.P.INIT_AFTER_LOAD);this._initHandlers();this._prepare(cvs);this._addOpts(Player.DEFAULT_CONFIGURATION);this._addOpts($engine.extractUserOptions(this.canvas));this._addOpts(opts||{});this._postInit();this._checkOpts();_PlrMan.fire(C.S_NEW_PLAYER,this);return this};Player.prototype.load=function(arg1,arg2,arg3,arg4){var player=this;if(player.state.happens===C.RES_LOADING){player._clearPostpones()}var object=arg1,duration,importer,callback;var durationPassed=false;if(__fun(arg2)){callback=arg2}else if(__num(arg2)){duration=arg2;durationPassed=true;if(__obj(arg3)){importer=arg3;callback=arg4}else if(__fun(arg3)){callback=arg3}}else if(__obj(arg2)){importer=arg2;callback=arg3}if(!object){player.anim=null;player._reset();player.stop();throw new PlayerErr(Errors.P.NO_SCENE_PASSED)}if(player.state.happens===C.PLAYING||player.state.happens===C.PAUSED){throw new PlayerErr(Errors.P.COULD_NOT_LOAD_WHILE_PLAYING)}if(!player.__canvasPrepared)throw new PlayerErr(Errors.P.CANVAS_NOT_PREPARED);player._reset();player.state.happens=C.LOADING;player._runLoadingAnimation();var whenDone=function(result){var scene=player.anim;if(player.handleEvents){player.__subscribeDynamicEvents(scene)}var remotes=scene._collectRemoteResources(player);if(!remotes.length){player._stopLoadingAnimation();player.fire(C.S_LOAD,result);if(!player.handleEvents)player.stop();if(callback)callback(result);if(player.autoPlay)player.play()}else{player.state.happens=C.RES_LOADING;player.fire(C.S_RES_LOAD,remotes);_ResMan.subscribe(remotes,[player.__defAsyncSafe(function(res_results,err_count){if(player.anim===result){player._stopLoadingAnimation();player.state.happens=C.LOADING;player.fire(C.S_LOAD,result);if(!player.handleEvents)player.stop();player._callPostpones();if(callback)callback(result);if(player.autoPlay)player.play()}})]);scene._loadRemoteResources(player)}};whenDone=player.__defAsyncSafe(whenDone);if(player.anim){player.__unsubscribeDynamicEvents(player.anim);player.anim.__removeMaskCanvases()}if(object){if(__builder(object)){player._loadTarget=C.LT_BUILDER;L.loadBuilder(player,object,whenDone)}else if(object instanceof Scene){player._loadTarget=C.LT_SCENE;L.loadScene(player,object,whenDone)}else if(__arr(object)){player._loadTarget=C.LT_CLIPS;L.loadClips(player,object,whenDone)}else if(__str(object)){var controls=player.controls;player._loadTarget=C.LT_URL;player._loadSrc=object;L.loadFromUrl(player,object,importer,whenDone)}else{player._loadTarget=C.LT_IMPORT;L.loadFromObj(player,object,importer,whenDone)}}else{player._loadTarget=C.LT_SCENE;player.anim=new Scene;whenDone(player.anim)}if(durationPassed){player.anim.duration=duration;if(player.controls)player.controls.setDuration(duration)}return player};var __nextFrame=$engine.getRequestFrameFunc(),__stopAnim=$engine.getCancelFrameFunc();Player.prototype.play=function(from,speed,stopAfter){if(this.state.happens===C.PLAYING){if(this.handleEvents)return;else throw new PlayerErr(Errors.P.ALREADY_PLAYING)}if(this.state.happens===C.RES_LOADING){this._postpone("play",arguments);return}var player=this;player._ensureHasAnim();player._ensureHasState();var state=player.state;var scene=player.anim;scene.reset();state.__lastPlayConf=[from,speed,stopAfter];state.from=from||0;state.time=Player.NO_TIME;state.speed=(speed||1)*(player.speed||1)*(scene.speed||1);state.stop=typeof stopAfter!=="undefined"?stopAfter:state.stop;state.duration=player.inifiniteDuration?Infinity:scene.duration||(scene.isEmpty()?0:Scene.DEFAULT_DURATION);if(state.duration==undefined)throw new PlayerErr(Errors.P.DURATION_IS_NOT_KNOWN);state.__startTime=Date.now();state.__redraws=0;state.__rsec=0;state.__prevt=0;state.__supressFrames=false;state.happens=C.PLAYING;state.__firstReq=__r_loop(player.ctx,player,scene,player.__beforeFrame(scene),player.__afterFrame(scene),player.__userBeforeRender,player.__userAfterRender);player.fire(C.S_PLAY,state.from);return player};Player.prototype.stop=function(){if(this.state.happens===C.RES_LOADING){this._postpone("stop",arguments);return}var player=this,scene=player.anim;player._ensureHasState();var state=player.state;if(state.happens===C.PLAYING||state.happens===C.PAUSED){state.__supressFrames=true;__stopAnim(state.__firstReq)}state.time=Player.NO_TIME;state.from=0;state.stop=Player.NO_TIME;if(scene){state.happens=C.STOPPED;if(player.drawStill){if(!player.infiniteDuration&&__finite(scene.duration)){player.drawAt(scene.duration*Player.PREVIEW_POS)}else{player.drawAt(state.from)}}else{player._drawEmpty()}if(player.controls){player._renderControlsAt(state.time)}}else if(state.happens!==C.ERROR){state.happens=C.NOTHING;player._drawSplash()}player.fire(C.S_STOP);if(scene)scene.reset();return player};Player.prototype.pause=function(){var player=this;if(player.state.happens===C.RES_LOADING){player._postpone("pause",arguments);return}player._ensureHasState();player._ensureHasAnim();var state=player.state;if(state.happens===C.STOPPED){throw new PlayerErr(Errors.P.PAUSING_WHEN_STOPPED)}if(state.happens===C.PLAYING){state.__supressFrames=true;__stopAnim(state.__firstReq)}if(state.time>state.duration){state.time=state.duration}state.from=state.time;state.happens=C.PAUSED;player.drawAt(state.time);player.fire(C.S_PAUSE,state.time);return player};Player.prototype.onerror=function(callback){this.__err_handler=callback;return this};provideEvents(Player,[C.S_IMPORT,C.S_LOAD,C.S_RES_LOAD,C.S_PLAY,C.S_PAUSE,C.S_STOP,C.S_REPEAT,C.S_ERROR]);Player.prototype._prepare=function(cvs){if(!cvs)throw new PlayerErr(Errors.P.NO_CANVAS_PASSED);var canvas_id,canvas;if(__str(cvs)){canvas_id=cvs;canvas=$engine.getElementById(canvas_id);if(!canvas)throw new PlayerErr(_strf(Errors.P.NO_CANVAS_WITH_ID,[id]))}else{if(!cvs.id)cvs.id="anm-player-"+Player.__instances;canvas_id=cvs.id;canvas=cvs}$engine.assignPlayerToCanvas(canvas,this);if(!$engine.checkPlayerCanvas(canvas))throw new PlayerErr(Errors.P.CANVAS_NOT_VERIFIED);this.id=canvas_id;this.canvas=canvas;this.ctx=$engine.getContext(canvas,"2d");this.state=Player.createState(this);this.subscribeEvents(canvas);this.__canvasPrepared=true};Player.prototype._addOpts=function(opts){this.debug=__defined(opts.debug)?opts.debug:this.debug;this.mode=__defined(opts.mode)?opts.mode:this.mode;this.repeat=__defined(opts.repeat)?opts.repeat:this.repeat;this.autoPlay=__defined(opts.autoPlay)?opts.autoPlay:this.autoPlay;this.zoom=opts.zoom||this.zoom;this.speed=opts.speed||this.speed;this.width=opts.width||this.width;this.height=opts.height||this.height;this.bgColor=opts.bgColor||this.bgColor;this.audioEnabled=__defined(opts.audioEnabled)?opts.audioEnabled:this.audioEnabled;this.imagesEnabled=__defined(opts.imagesEnabled)?opts.imagesEnabled:this.imagesEnabled;this.shadowsEnabled=__defined(opts.shadowsEnabled)?opts.shadowsEnabled:this.shadowsEnabled;this.controlsEnabled=__defined(opts.controlsEnabled)?opts.controlsEnabled:this.controlsEnabled;this.handleEvents=__defined(opts.handleEvents)?opts.handleEvents:this.handleEvents;this.drawStill=__defined(opts.drawStill)?opts.drawStill:this.drawStill;this.infiniteDuration=__defined(opts.infiniteDuration)?opts.infiniteDuration:this.infiniteDuration;this.forceSceneSize=__defined(opts.forceSceneSize)?opts.forceSceneSize:this.forceSceneSize;this.inParent=__defined(opts.inParent)?opts.inParent:this.inParent;this.muteErrors=__defined(opts.muteErrors)?opts.muteErrors:this.muteErrors};Player.prototype._checkOpts=function(){if(!this.canvas)return;this.infiniteDuration=__defined(this.infiniteDuration)?this.infiniteDuration:this.mode?this.mode&C.M_INFINITE_DURATION:undefined;this.handleEvents=__defined(this.handleEvents)?this.handleEvents:this.mode?this.mode&C.M_HANDLE_EVENTS:undefined;this.controlsEnabled=__defined(this.controlsEnabled)?this.controlsEnabled:this.mode?this.mode&C.M_CONTROLS_ENABLED:undefined;this.infoEnabled=__defined(this.infoEnabled)?this.infoEnabled:this.mode?this.mode&C.M_INFO_ENABLED:undefined;this.drawStill=__defined(this.drawStill)?this.drawStill:this.mode?this.mode&C.M_DRAW_STILL:undefined;if(!this.width||!this.height){var cvs_size=$engine.getCanvasSize(this.canvas);this.width=cvs_size[0];this.height=cvs_size[1]}this._resize(this.width,this.height);if(this.anim&&this.handleEvents){this.__subscribeDynamicEvents(this.anim)}if(this.controlsEnabled&&!this.controls){this._enableControls();if(this.infoEnabled){this._enableInfo()}else{this._disableInfo()}}else if(!this.controlsEnabled&&this.controls){this._disableInfo();this._disableControls()}if(this.ctx)this.ctx.__anm_skipShadows=!this.shadowsEnabled};Player.prototype._postInit=function(){this.stop();Text.__measuring_f=$engine.createTextMeasurer();var mayBeUrl=$engine.hasUrlToLoad(this.canvas);if(mayBeUrl)this.load(mayBeUrl)};Player.prototype.changeRect=function(rect){this.x=rect.x;this.y=rect.y;this.width=rect.width;this.height=rect.height;this._moveTo(rect.x,rect.y);this._resize(rect.width,rect.height)};Player.prototype.forceRedraw=function(){if(this.controls)this.controls.forceNextRedraw();switch(this.state.happens){case C.STOPPED:this.stop();break;case C.PAUSED:if(this.anim)this.drawAt(this.state.time);break;case C.PLAYING:if(this.anim){this._stopAndContinue()}break;case C.NOTHING:this._drawSplash();break}if(this.controls)this.controls.render(this.state.time)};Player.prototype.changeZoom=function(zoom){this.zoom=zoom};Player.prototype.configureAnim=function(conf){this._animInfo=conf;_mrg_obj(conf,{},this.anim);this._checkOpts()};Player.prototype.configureMeta=function(info){this._metaInfo=info;if(this.controls)this.controls.inject(info,this._metaInfo)};Player.prototype.drawAt=function(time){if(time===Player.NO_TIME)throw new PlayerErr(Errors.P.PASSED_TIME_VALUE_IS_NO_TIME);if(this.state.happens===C.RES_LOADING){this._postpone("drawAt",arguments);return}if(time<0||time>this.anim.duration){throw new PlayerErr(_strf(Errors.P.PASSED_TIME_NOT_IN_RANGE,[time]))}var scene=this.anim,u_before=this.__userBeforeRender,u_after=this.__userAfterRender;scene.reset();scene.__informEnabled=false;__r_at(time,0,this.ctx,this.anim,this.width,this.height,this.zoom,u_before,u_after);if(this.controls)this._renderControlsAt(time);return this};Player.prototype.setSize=function(width,height){this.__userSize=[width,height];this._resize()};Player.prototype.beforeFrame=function(callback){if(this.state.happens===C.PLAYING)throw new PlayerErr(Errors.P.BEFOREFRAME_BEFORE_PLAY);this.__userBeforeFrame=callback};Player.prototype.afterFrame=function(callback){if(this.state.happens===C.PLAYING)throw new PlayerErr(Errors.P.AFTERFRAME_BEFORE_PLAY);this.__userAfterFrame=callback};Player.prototype.beforeRender=function(callback){if(this.state.happens===C.PLAYING)throw new PlayerErr(Errors.P.BEFORENDER_BEFORE_PLAY);this.__userBeforeRender=callback};Player.prototype.afterRender=function(callback){if(this.state.happens===C.PLAYING)throw new PlayerErr(Errors.P.AFTERRENDER_BEFORE_PLAY);this.__userAfterRender=callback};Player.prototype.detach=function(){if(!$engine.playerAttachedTo(this.canvas,this))return;if(this.controls)this.controls.detach(this.canvas.parentNode);$engine.detachPlayer(this.canvas,this);if(this.ctx)delete this.ctx.__anm_skipShadows;this._reset();_PlrMan.fire(C.S_PLAYER_DETACH,this)};Player.prototype.attachedTo=function(canvas){return $engine.playerAttachedTo(canvas,this)};Player.prototype.isAttached=function(){return $engine.playerAttachedTo(this.canvas,this)};Player.attachedTo=function(canvas,player){return $engine.playerAttachedTo(canvas,player)};Player.__getPosAndRedraw=function(player){return function(evt){if(player.controls){player.controls.update(player.canvas)}}};Player.prototype.subscribeEvents=function(canvas){var doRedraw=Player.__getPosAndRedraw(this);$engine.subscribeWindowEvents({load:doRedraw,scroll:doRedraw,resize:doRedraw});$engine.subscribeCanvasEvents(canvas,{mouseover:function(player){return function(evt){if(global_opts.autoFocus&&player.handleEvents&&player.canvas){player.canvas.focus()}return true}}(this),mouseout:function(player){return function(evt){if(global_opts.autoFocus&&player.handleEvents&&player.canvas){player.canvas.blur()}return true}}(this)})};Player.prototype._drawEmpty=function(){var ctx=this.ctx,w=this.width,h=this.height;ctx.save();var ratio=$engine.PX_RATIO;ctx.fillStyle="#ffe";ctx.fillRect(0,0,w*ratio,h*ratio);ctx.restore()};Player.prototype._drawSplash=function(){var ctx=this.ctx,w=this.width,h=this.height;ctx.save();ctx.setTransform(1,0,0,1,0,0);var ratio=$engine.PX_RATIO;ctx.fillStyle="#ffe";ctx.fillRect(0,0,w*ratio,h*ratio);if(this.controls){ctx.restore();return}ctx.fillStyle="#999966";ctx.font="18px sans-serif";ctx.fillText(Strings.COPYRIGHT,20*ratio,(h-20)*ratio);ctx.globalAlpha=.6;ctx.beginPath();ctx.arc(w/2*ratio,h/2*ratio,Math.min(w/4,h/4)*ratio,0,2*Math.PI);ctx.fillStyle="#a00";ctx.strokeStyle="#ffe";ctx.lineWidth=10;ctx.stroke();ctx.fill();ctx.globalAlpha=.9;ctx.restore();Controls._drawGuyInCenter(ctx,Controls.THEME,w*ratio,h*ratio,["#fff","#900"],[.5,.5],.2)};Player.prototype._drawLoadingSplash=function(text){this._drawSplash();if(this.controls)return;var ctx=this.ctx;ctx.save();ctx.setTransform(1,0,0,1,0,0);ctx.fillStyle="#006";ctx.font="12px sans-serif";ctx.fillText(text||Strings.LOADING,20,25);ctx.restore()};Player.prototype._drawLoadingCircles=function(){var theme=Controls.THEME;Controls._runLoadingAnimation(this.ctx,function(ctx){var w=ctx.canvas.clientWidth,h=ctx.canvas.clientHeight;ctx.clearRect(0,0,w,h);Controls._drawLoadingCircles(ctx,w,h,Date.now()/100%60/60,.5,theme.colors.stroke,theme.colors.text)})};Player.prototype._stopDrawingLoadingCircles=function(){Controls._stopLoadingAnimation(this.ctx);this._drawEmpty()};Player.prototype._drawErrorSplash=function(e){if(!this.canvas||!this.ctx)return;if(this.controls){this.controls.forceNextRedraw();this.controls.render();return}this._drawSplash();var ctx=this.ctx;ctx.save();ctx.setTransform(1,0,0,1,0,0);ctx.fillStyle="#006";ctx.font="14px sans-serif";ctx.fillText(Strings.ERROR+(e?": "+(e.message||typeof Error):"")+".",20,25);ctx.restore()};Player.prototype._runLoadingAnimation=function(what){if(this.controls){this._drawLoadingSplash(what);this.controls._scheduleLoading()}else{this._drawLoadingCircles()}};Player.prototype._stopLoadingAnimation=function(){if(this.controls){this.controls._stopLoading()}else{this._stopDrawingLoadingCircles()}};Player.prototype.toString=function(){return"[ Player '"+this.id+"' m-"+this.mode+" ]"};Player.prototype._reset=function(){var state=this.state;state.happens=C.NOTHING;state.from=0;state.time=Player.NO_TIME;state.duration=undefined;if(this.controls)this.controls.reset();this.ctx.clearRect(0,0,this.width*$engine.PX_RATIO,this.height*$engine.PX_RATIO)};Player.prototype._stopAndContinue=function(){var state=this.state,last_conf=state.__lastPlayConf;var stoppedAt=state.time;this.stop();this.play(stoppedAt,last_conf[1],last_conf[2])};Player.prototype._moveTo=function(x,y){$engine.setCanvasPos(this.canvas,x,y)};Player.prototype._resize=function(width,height){var cvs=this.canvas,new_size=this.__userSize||[width,height],cur_size=$engine.getCanvasParams(cvs);if(cur_size&&cur_size[0]===new_size[0]&&cur_size[1]===new_size[1])return;if(!new_size[0]||!new_size[1]){new_size=$engine.getCanvasSize(cvs)}$engine.setCanvasSize(cvs,new_size[0],new_size[1]);if(this.controls)this.controls.update(cvs);this.forceRedraw();return new_size};Player.prototype._restyle=function(bg){$engine.setCanvasBackground(this.canvas,bg);this.forceRedraw()};Player.prototype._enableControls=function(){if(!this.controls)this.controls=new Controls(this);if(this.state.happens===C.NOTHING){this._drawSplash()}if(this.state.happens===C.LOADING||this.state.happens===C.RES_LOADING){this._drawLoadingSplash()}this.controls.enable()};Player.prototype._disableControls=function(){if(!this.controls)return;this.controls.disable();this.controls=null};Player.prototype._enableInfo=function(){if(!this.controls)return;this.controls.enableInfo()};Player.prototype._disableInfo=function(){if(!this.controls)return;this.controls.disableInfo()};Player.prototype._renderControlsAt=function(time){this.controls.render(time)};Player.prototype.__subscribeDynamicEvents=function(scene){if(global_opts.setTabindex){$engine.setTabIndex(this.canvas,this.__instanceNum)}if(scene){var subscribed=false;if(!this.__boundTo){this.__boundTo=[]}else{for(var i=0,ix=this.__boundTo,il=ix.length;i<il;i++){if(scene.id===ix[i][0]&&this.canvas===ix[i][1]){subscribed=true}}}if(!subscribed){this.__boundTo.push([scene.id,this.canvas]);scene.subscribeEvents(this.canvas)}}};Player.prototype.__unsubscribeDynamicEvents=function(scene){if(global_opts.setTabindex){$engine.setTabIndex(this.canvas,undefined)}if(scene){if(!this.__boundTo)return;var toRemove=-1;for(var i=0,ix=this.__boundTo,il=ix.length;i<il;i++){if(scene.id===ix[i][0]){toRemove=i;scene.unsubscribeEvents(ix[i][1])}}if(toRemove>=0){this.__boundTo.splice(toRemove,1)}}};Player.prototype._ensureHasState=function(){if(!this.state)throw new PlayerErr(Errors.P.NO_STATE)};Player.prototype._ensureHasAnim=function(){if(!this.anim)throw new PlayerErr(Errors.P.NO_SCENE)};Player.prototype.__beforeFrame=function(scene){return function(player,state,scene,callback){return function(time){scene.clearAllLaters();if(state.happens!==C.PLAYING)return false;if(state.stop!==Player.NO_TIME&&time>=state.from+state.stop||time>state.duration+Player.PEFF){state.time=0;scene.reset();player.stop();if(player.repeat||scene.repeat){player.play();player.fire(C.S_REPEAT)}else if(!player.infiniteDuration&&__finite(state.duration)){player.drawAt(state.duration)}return false}if(callback)callback(time,player.ctx);return true}}(this,this.state,scene,this.__userBeforeFrame)};Player.prototype.__afterFrame=function(scene){return function(player,state,scene,callback){return function(time){if(player.controls&&!player.controls.hidden){player._renderControlsAt(time)}if(callback)callback(time);scene.invokeAllLaters();return true}}(this,this.state,scene,this.__userAfterFrame)};Player.prototype.__onerror=function(err){var player=this;var doMute=player.muteErrors;doMute=doMute&&!(err instanceof SysErr);if(player.state&&(player.state.happens==C.LOADING||player.state.happens==C.RES_LOADING)){player._stopLoadingAnimation()}try{if(player.state)player.state.happens=C.ERROR;player.__lastError=err;player.fire(C.S_ERROR,err);player.anim=null}catch(e){throw new SysErr(_strf(Errors.S.ERROR_HANDLING_FAILED,[err.message||err]))}try{if(player.state&&(player.state.happens!=C.NOTHING||player.state.happens!=C.STOPPED)){player.__unsafe_stop()}}catch(e){}doMute=this.__err_handler&&this.__err_handler(err)||doMute;if(!doMute){try{this._drawErrorSplash(err)}catch(e){}throw err}};Player.prototype.__callSafe=function(f){try{return f.call(this)}catch(err){this.__onerror(err)}};Player.prototype.__defSafe=function(method_f){var player=this;return function(){var args=arguments;if(!this.__safe_ctx){this.__safe_ctx=true;try{var ret_val=player.__callSafe(function(){return method_f.apply(player,args)});this.__safe_ctx=false;return ret_val}catch(err){this.__safe_ctx=false;throw err}}else{return method_f.apply(player,args)}}};Player.prototype.__defAsyncSafe=function(func){var player=this;return function(){var args=arguments;try{var ret_val=player.__callSafe(function(){return func.apply(player,args)});return ret_val}catch(err){throw err}}};Player.prototype.__makeSafe=function(methods){var player=this;for(var i=0,il=methods.length;i<il;i++){var method=methods[i];if(!player[method])throw new SysErr(_strf(Errors.S.NO_METHOD_FOR_PLAYER,[method]));player["__unsafe_"+method]=player[method];player[method]=player.__defSafe(player[method])}};Player.prototype.handle__x=function(type,evt){if(this.anim)this.anim.fire(type,this);return true};Player.prototype._clearPostpones=function(){this._queue=[]};Player.prototype._postpone=function(method,args){if(!this._queue)this._queue=[];this._queue.push([method,args])};Player.prototype._callPostpones=function(){if(this._queue&&this._queue.length){var q=this._queue,spec;for(var i=0,il=q.length;i<il;i++){spec=q[i];this[spec[0]].apply(this,spec[1])}}this._queue=[]};Player.createState=function(player){return{happens:C.NOTHING,time:Player.NO_TIME,from:0,stop:Player.NO_TIME,afps:0,speed:1,duration:undefined,__startTime:-1,__redraws:0,__rsec:0}};Player._isPlayerEvent=function(type){return type==C.S_PLAY||type==C.S_PAUSE||type==C.S_STOP||type==C.S_REPEAT||type==C.S_LOAD||type==C.S_RES_LOAD||type==C.S_ERROR||type==C.S_IMPORT};Player._optsFromUrlParams=function(params){function __boolParam(val){if(!val)return false;if(val==0)return false;if(val==1)return true;if(val=="false")return false;if(val=="true")return true;if(val=="off")return false;if(val=="on")return true;if(val=="no")return false;if(val=="yes")return true}function __extractBool(){var variants=arguments;for(var i=0;i<variants.length;i++){if(__defined(params[variants[i]]))return __boolParam(params[variants[i]])}return undefined}var opts={};opts.debug=__defined(params.debug)?__boolParam(params.debug):undefined;opts.muteErrors=__extractBool("me","muterrors");opts.repeat=__extractBool("r","repeat");opts.autoPlay=__extractBool("a","auto","autoplay");opts.mode=params.m||params.mode||undefined;opts.zoom=params.z||params.zoom;opts.speed=params.v||params.speed;opts.width=params.w||params.width;opts.height=params.h||params.height;opts.infiniteDuration=__extractBool("i","inf","infinite");opts.audioEnabled=__extractBool("s","snd","sound","audio");opts.controlsEnabled=__extractBool("c","controls");opts.bgColor=params.bg||params.bgcolor;return opts};Player.forSnapshot=function(canvasId,snapshotUrl,importer,callback){var urlWithParams=snapshotUrl.split("?"),snapshotUrl=urlWithParams[0],urlParams=urlWithParams[1],params=urlParams&&urlParams.length>0?__paramsToObj(urlParams):{},options=Player._optsFromUrlParams(params),player=new Player;player.init(canvasId,options);player.load(snapshotUrl,importer,function(){player._applyUrlParamsToAnimation(params);if(callback)callback(player)});return player};Player.prototype._applyUrlParamsToAnimation=function(params){if(__defined(params.t)){this.play(params.t/100)}else if(__defined(params.from)){this.play(params.from/100)}else if(__defined(params.p)){this.play(params.p/100).pause()}else if(__defined(params.still)){this.play(params.still/100).pause()}};function Scene(){this.id=guid();this.tree=[];this.hash={};this.name="";this.duration=undefined;this.bgfill=null;this.width=undefined;this.height=undefined;this.zoom=1;this.speed=1;this.repeat=false;this.meta={};this.__informEnabled=true;this._laters=[];this._initHandlers()}Scene.DEFAULT_DURATION=10;provideEvents(Scene,[C.X_MCLICK,C.X_MDCLICK,C.X_MUP,C.X_MDOWN,C.X_MMOVE,C.X_MOVER,C.X_MOUT,C.X_KPRESS,C.X_KUP,C.X_KDOWN,C.X_DRAW,C.S_PLAY,C.S_PAUSE,C.S_STOP,C.S_REPEAT,C.S_IMPORT,C.S_LOAD,C.S_RES_LOAD,C.S_ERROR]);Scene.prototype.add=function(arg1,arg2,arg3){if(arg2){var _elm=new Element(arg1,arg2);if(arg3)_elm.changeTransform(arg3);this._addToTree(_elm);return _elm}else if(__arr(arg1)){var _clip=new Clip;_clip.add(arg1);this._addToTree(_clip);return _clip}else if(__builder(arg1)){this._addToTree(arg1.v)}else{this._addToTree(arg1)}};Scene.prototype.remove=function(elm){if(elm.parent){elm.parent.remove(elm)}else{this._unregister(elm)}};Scene.prototype.visitElems=function(visitor,data){for(var elmId in this.hash){visitor(this.hash[elmId],data)}};Scene.prototype.travelChildren=Scene.prototype.visitElems;Scene.prototype.visitRoots=function(visitor,data){for(var i=0,tlen=this.tree.length;i<tlen;i++){visitor(this.tree[i],data)}};Scene.prototype.visitChildren=Scene.prototype.visitRoots;Scene.prototype.iterateRoots=function(func,rfunc){iter(this.tree).each(func,rfunc)};Scene.prototype.render=function(ctx,time,dt){ctx.save();var zoom=this.zoom;try{if(zoom!=1){ctx.scale(zoom,zoom)}if(this.bgfill){ctx.fillStyle=Brush.create(ctx,this.bgfill);ctx.fillRect(0,0,this.width,this.height)}this.visitRoots(function(elm){elm.render(ctx,time,dt)})}finally{ctx.restore()}this.fire(C.X_DRAW,ctx)};Scene.prototype.handle__x=function(type,evt){this.visitElems(function(elm){elm.fire(type,evt)});return true};Scene.prototype.getFittingDuration=function(){var max_pos=-Infinity;var me=this;this.visitRoots(function(elm){var elm_tpos=elm._max_tpos();if(elm_tpos>max_pos)max_pos=elm_tpos});return max_pos};Scene.prototype.reset=function(){this.__informEnabled=true;this.visitRoots(function(elm){elm.reset()})};Scene.prototype.dispose=function(){this.disposeHandlers();var me=this;this.iterateRoots(function(elm){me._unregister_no_rm(elm);elm.dispose();return false})};Scene.prototype.isEmpty=function(){return this.tree.length==0};Scene.prototype.toString=function(){return"[ Scene "+(this.name?"'"+this.name+"'":"")+"]"};Scene.prototype.subscribeEvents=function(canvas){$engine.subscribeSceneToEvents(canvas,this,DOM_TO_EVT_MAP)};Scene.prototype.unsubscribeEvents=function(canvas){$engine.unsubscribeSceneFromEvents(canvas,this)};Scene.prototype._addToTree=function(elm){if(!elm.children){throw new AnimErr("It appears that it is not a clip object or element that you pass")}this._register(elm);this.tree.push(elm)};Scene.prototype._register=function(elm){if(this.hash[elm.id])throw new AnimErr(Errors.A.ELEMENT_IS_REGISTERED);elm.registered=true;elm.scene=this;this.hash[elm.id]=elm;var me=this;elm.visitChildren(function(elm){me._register(elm)})};Scene.prototype._unregister_no_rm=function(elm){this._unregister(elm,true)};Scene.prototype._unregister=function(elm,save_in_tree){if(!elm.registered)throw new AnimErr(Errors.A.ELEMENT_IS_NOT_REGISTERED);var me=this;elm.visitChildren(function(elm){me._unregister(elm)});var pos=-1;if(!save_in_tree){while((pos=this.tree.indexOf(elm))>=0){this.tree.splice(pos,1)}}delete this.hash[elm.id];elm.registered=false;elm.scene=null};Scene.prototype._collectRemoteResources=function(player){var remotes=[],scene=this;this.visitElems(function(elm){if(elm._hasRemoteResources(scene,player)){remotes=remotes.concat(elm._collectRemoteResources(scene,player))}});return remotes};Scene.prototype._loadRemoteResources=function(player){var scene=this;this.visitElems(function(elm){if(elm._hasRemoteResources(scene,player)){elm._loadRemoteResources(scene,player)}})};Scene.prototype.__ensureHasMaskCanvas=function(lvl){if(this.__maskCvs&&this.__backCvs&&this.__maskCvs[lvl]&&this.__backCvs[lvl])return;if(!this.__maskCvs){this.__maskCvs=[];this.__maskCtx=[]}if(!this.__backCvs){this.__backCvs=[];this.__backCtx=[]}this.__maskCvs[lvl]=$engine.createCanvas(this.width*2,this.height*2);this.__maskCtx[lvl]=$engine.getContext(this.__maskCvs[lvl],"2d");this.__backCvs[lvl]=$engine.createCanvas(this.width*2,this.height*2);this.__backCtx[lvl]=$engine.getContext(this.__backCvs[lvl],"2d")};Scene.prototype.__removeMaskCanvases=function(){if(!this.__maskCvs&&!this.__backCvs)return;if(this.__maskCvs){for(var i=0,il=this.__maskCvs.length;i<il;i++){if(this.__maskCvs[i]){$engine.disposeElement(this.__maskCvs[i]);this.__maskCvs[i]=null;this.__maskCtx[i]=null}}this.__maskCvs=null;this.__maskCtx=null}if(this.__backCvs){for(var i=0,il=this.__backCvs.length;i<il;i++){if(this.__backCvs[i]){$engine.disposeElement(this.__backCvs[i]);this.__backCvs[i]=null;this.__backCtx[i]=null}}this.__maskCvs=null;this.__backCtx=null}};Scene.prototype.findById=function(id){return this.hash[id]};Scene.prototype.invokeAllLaters=function(){for(var i=0;i<this._laters.length;i++){this._laters[i].call(this)}};Scene.prototype.clearAllLaters=function(){this._laters=[]};Scene.prototype.invokeLater=function(f){this._laters.push(f)};C.R_ONCE=0;C.R_STAY=1;C.R_LOOP=2;C.R_BOUNCE=3;C.C_SRC_OVER=1;C.C_SRC_ATOP=2;C.C_SRC_IN=3;C.C_SRC_OUT=4;C.C_DST_OVER=5;C.C_DST_ATOP=6;C.C_DST_IN=7;C.C_DST_OUT=8;C.C_LIGHTER=9;C.C_DARKER=10;C.C_COPY=11;C.C_XOR=12;C.AC_NAMES=[];C.AC_NAMES[C.C_SRC_OVER]="source-over";C.AC_NAMES[C.C_SRC_ATOP]="source-atop";C.AC_NAMES[C.C_SRC_IN]="source-in";C.AC_NAMES[C.C_SRC_OUT]="source-out";C.AC_NAMES[C.C_DST_OVER]="destination-over";C.AC_NAMES[C.C_DST_ATOP]="destination-atop";C.AC_NAMES[C.C_DST_IN]="destination-in";C.AC_NAMES[C.C_DST_OUT]="destination-out";C.AC_NAMES[C.C_LIGHTER]="lighter";C.AC_NAMES[C.C_DARKER]="darker";C.AC_NAMES[C.C_COPY]="copy";C.AC_NAMES[C.C_XOR]="xor";Element.DEFAULT_PVT=[.5,.5];Element.DEFAULT_REG=[0,0];Element.TYPE_MAX_BIT=16;Element.PRRT_MAX_BIT=8;Element.SYS_MOD=0;Element.TWEEN_MOD=1;Element.USER_MOD=2;Element.EVENT_MOD=3;Element.FIRST_MOD=Element.SYS_MOD;Element.LAST_MOD=Element.EVENT_MOD;Element.ALL_MODIFIERS=[Element.SYS_MOD,Element.TWEEN_MOD,Element.USER_MOD,Element.EVENT_MOD];Element.NOEVT_MODIFIERS=[Element.SYS_MOD,Element.TWEEN_MOD,Element.USER_MOD];Element.SYS_PNT=0;Element.USER_PNT=1;Element.DEBUG_PNT=2;Element.FIRST_PNT=Element.SYS_PNT;Element.LAST_PNT=Element.DEBUG_PNT;Element.ALL_PAINTERS=[Element.SYS_PNT,Element.USER_PNT,Element.DEBUG_PNT];Element.NODBG_PAINTERS=[Element.SYS_PNT,Element.USER_PNT];function Element(draw,onframe){this.id=guid();this.name="";this.bstate=Element.createBaseState();this.state=Element.createState(this);this.astate=null;this.xdata=Element.createXData(this);this.children=[];this.parent=null;this.level=0;this.scene=null;this.visible=true;this.shown=false;this.registered=false;this.disabled=false;this.rendering=false;this.__data=null;this._modifiers=[];this._painters=[];if(onframe)this.__modify({type:Element.USER_MOD},onframe);if(draw)this.__paint({type:Element.USER_PNT},draw);this.__lastJump=null;this.__jumpLock=false;this.__modifying=null;this.__painting=null;this.__evtCache=[];this.__detachQueue=[];this.__frameProcessors=[];this._initHandlers();var _me=this,default_on=this.on;this.on=function(type,handler){if(type&C.XT_CONTROL){this.m_on.call(_me,type,handler)}else default_on.call(_me,type,handler)};Element.__addSysModifiers(this);
Element.__addSysPainters(this);if(global_opts.liveDebug)Element.__addDebugRender(this)}Element.NO_BAND=null;Element.DEFAULT_LEN=Infinity;Element._customImporters=[];provideEvents(Element,[C.X_MCLICK,C.X_MDCLICK,C.X_MUP,C.X_MDOWN,C.X_MMOVE,C.X_MOVER,C.X_MOUT,C.X_KPRESS,C.X_KUP,C.X_KDOWN,C.X_DRAW,C.X_START,C.X_STOP,C.S_PLAY,C.S_PAUSE,C.S_STOP,C.S_REPEAT,C.S_IMPORT,C.S_LOAD,C.S_RES_LOAD,C.S_ERROR]);Element.prototype.prepare=function(){this.state._matrix.reset();return true};Element.prototype.onframe=function(ltime,dt){return this.__callModifiers(Element.ALL_MODIFIERS,ltime,dt)};Element.prototype.drawTo=function(ctx,t,dt){return this.__callPainters(Element.ALL_PAINTERS,ctx,t,dt)};Element.prototype.draw=Element.prototype.drawTo;Element.prototype.transform=function(ctx){var s=this.state,bs=this.bstate,as=Element._mergeStates(bs,s);this.astate=as;s._matrix=Element._getMatrixOf(as,s._matrix);ctx.globalAlpha*=as.alpha;s._matrix.apply(ctx);as._matrix=s._matrix};Element.prototype.render=function(ctx,gtime,dt){if(this.disabled)return;this.rendering=true;var drawMe=false;var ltime=this.ltime(gtime);drawMe=this.__preRender(gtime,ltime,ctx);if(this.scene&&this.scene.__informEnabled)this.inform(ltime);if(drawMe){drawMe=this.fits(ltime)&&this.onframe(ltime,dt)&&this.prepare()&&this.visible}if(drawMe){ctx.save();try{gtime=this.gtime(ltime);if(!this.__mask){this.transform(ctx);this.draw(ctx,ltime,dt);this.visitChildren(function(elm){elm.render(ctx,gtime,dt)})}else{var scene=this.scene;if(!scene)throw new AnimErr(Errors.A.MASK_SHOULD_BE_ATTACHED_TO_SCENE);var level=this.level;scene.__ensureHasMaskCanvas(level);var mcvs=scene.__maskCvs[level],mctx=scene.__maskCtx[level],bcvs=scene.__backCvs[level],bctx=scene.__backCtx[level];var scene_width=scene.width,scene_height=scene.height,dbl_scene_width=scene.width*2,dbl_scene_height=scene.height*2,ratio=$engine.PX_RATIO;bctx.save();if(ratio!==1)bctx.scale(ratio,ratio);bctx.clearRect(0,0,dbl_scene_width,dbl_scene_height);bctx.save();bctx.translate(scene_width,scene_height);this.transform(bctx);this.visitChildren(function(elm){elm.render(bctx,gtime,dt)});this.draw(bctx,ltime,dt);bctx.restore();bctx.globalCompositeOperation="destination-in";mctx.save();if(ratio!==1)mctx.scale(ratio,ratio);mctx.clearRect(0,0,dbl_scene_width,dbl_scene_height);mctx.translate(scene_width,scene_height);this.__mask.render(mctx,gtime,dt);mctx.restore();bctx.drawImage(mcvs,0,0,dbl_scene_width,dbl_scene_height);bctx.restore();ctx.drawImage(bcvs,-scene_width,-scene_height,dbl_scene_width,dbl_scene_height)}}catch(e){$log.error(e)}finally{ctx.restore()}}this.shown=drawMe;this.__postRender();this.rendering=false;if(drawMe)this.fire(C.X_DRAW,ctx)};Element.prototype.addModifier=function(modifier,easing,data,priority){if(__obj(modifier)){modifier.type=Element.USER_MOD;return this.__modify(modifier,easing)}else{return this.__modify({type:Element.USER_MOD,priority:priority,easing:easing,data:data},modifier)}};Element.prototype.addTModifier=function(time,modifier,easing,data,priority){return this.__modify({type:Element.USER_MOD,priority:priority,time:time,easing:easing,data:data},modifier)};Element.prototype.addRModifier=function(modifier,easing,data,priority){return this.__modify({type:Element.USER_MOD,priority:priority,easing:easing,relative:true,data:data},modifier)};Element.prototype.addRTModifier=function(time,modifier,easing,data,priority){return this.__modify({type:Element.USER_MOD,priority:priority,time:time,easing:easing,relative:true,data:data},modifier)};Element.prototype.removeModifier=function(modifier){if(!modifier.__m_ids)throw new AnimErr(Errors.A.MODIFIER_NOT_ATTACHED);var id=modifier.__m_ids[this.id];delete modifier.__m_ids[this.id];if(!id)throw new AnimErr("Modifier wasn't applied to this element");var TB=Element.TYPE_MAX_BIT,PB=Element.PRRT_MAX_BIT;var type=id>>TB,priority=id-(type<<TB)>>PB,i=id-(type<<TB)-(priority<<PB);this._modifiers[type][priority][i]=null};Element.prototype.addPainter=function(painter,data,priority){return this.__paint({type:Element.USER_PNT,priority:priority,data:data},painter)};Element.prototype.removePainter=function(painter){if(!painter.__p_ids)throw new AnimErr("Painter wasn't applied to anything");var id=painter.__p_ids[this.id];delete painter.__p_ids[this.id];var TB=Element.TYPE_MAX_BIT,PB=Element.PRRT_MAX_BIT;var type=id>>TB,priority=id-(type<<TB)>>PB,i=id-(type<<TB)-(priority<<PB);this._painters[type][priority][i]=null};Element.prototype.addTween=function(tween){return Element.__addTweenModifier(this,tween)};Element.prototype.changeTransform=function(transform){this.transform=function(elm,new_,prev){return function(ctx){new_.call(elm,ctx,prev)}}(this,transform,this.transform)};Element.prototype.add=function(arg1,arg2,arg3){if(arg2){var _elm=new Element(arg1,arg2);if(arg3)_elm.changeTransform(arg3);this._addChild(_elm);return _elm}else if(__arr(arg1)){this._addChildren(arg1)}else if(__builder(arg1)){this._addChild(arg1.v)}else{this._addChild(arg1)}};Element.prototype.__safeDetach=function(what,_cnt){var pos=-1,found=_cnt||0;var children=this.children;if((pos=children.indexOf(what))>=0){if(this.rendering||what.rendering){this.__detachQueue.push(what)}else{if(this.__unsafeToRemove)throw new AnimErr(Errors.A.UNSAFE_TO_REMOVE);what._unbind();children.splice(pos,1)}return 1}else{this.visitChildren(function(ielm){found+=ielm.__safeDetach(what,found)});return found}};Element.prototype.remove=function(elm){if(!elm)throw new AnimErr(Errors.A.NO_ELEMENT_TO_REMOVE);if(this.__safeDetach(elm)==0)throw new AnimErr(Errors.A.NO_ELEMENT)};Element.prototype._unbind=function(){if(this.parent.__unsafeToRemove||this.__unsafeToRemove)throw new AnimErr(Errors.A.UNSAFE_TO_REMOVE);this.parent=null;if(this.scene)this.scene._unregister(this)};Element.prototype.detach=function(){if(this.parent.__safeDetach(this)==0)throw new AnimErr(Errors.A.ELEMENT_NOT_ATTACHED)};Element.prototype.makeBandFit=function(){var wband=this.findWrapBand();this.xdata.gband=wband;this.xdata.lband[1]=wband[1]-wband[0]};Element.prototype.setBand=function(band){this.xdata.lband=band;Bands.recalc(this)};Element.prototype.fits=function(ltime){if(ltime<0)return false;return __t_cmp(ltime,this.xdata.lband[1]-this.xdata.lband[0])<=0};Element.prototype.gtime=function(ltime){return this.xdata.gband[0]+ltime};Element.prototype.ltime=function(gtime){var x=this.xdata;if(!__finite(x.gband[1]))return this.__checkJump(gtime-x.gband[0]);switch(x.mode){case C.R_ONCE:return this.__checkJump(gtime-x.gband[0]);case C.R_STAY:return __t_cmp(gtime,x.gband[1])<=0?this.__checkJump(gtime-x.gband[0]):this.__checkJump(x.lband[1]-x.lband[0]);case C.R_LOOP:{var p=this.parent,px=p?p.xdata:null;var durtn=x.lband[1]-x.lband[0],pdurtn=p?px.lband[1]-px.lband[0]:durtn;if(durtn<0)return-1;var ffits=(gtime-x.gband[0])/durtn,fits=Math.floor(ffits);if(fits<0||ffits>x.nrep)return-1;var t=gtime-x.gband[0]-fits*durtn;return this.__checkJump(t)}case C.R_BOUNCE:{var p=this.parent,px=p?p.xdata:null;var durtn=x.lband[1]-x.lband[0],pdurtn=p?px.lband[1]-px.lband[0]:durtn;if(durtn<0)return-1;var ffits=(gtime-x.gband[0])/durtn,fits=Math.floor(ffits);if(fits<0||ffits>x.nrep)return-1;var t=gtime-x.gband[0]-fits*durtn,t=fits%2===0?t:durtn-t;return this.__checkJump(t)}}};Element.prototype.handlePlayerEvent=function(event,handler){if(!Player._isPlayerEvent(event))throw new Error("This method is intended to assign only player-related handles");this.on(event,handler)};Element.prototype.inform=function(ltime){if(__t_cmp(ltime,0)>=0){var duration=this.xdata.lband[1]-this.xdata.lband[0],cmp=__t_cmp(ltime,duration);if(!this.__firedStart){this.fire(C.X_START,ltime,duration);this.__firedStart=true}if(cmp>=0){if(!this.__firedStop){this.fire(C.X_STOP,ltime,duration);this.travelChildren(function(elm){if(!elm.__firedStop){elm.fire(C.X_STOP,ltime,duration);elm.__firedStop=true}});this.__firedStop=true}}}};Element.prototype.duration=function(){return this.xdata.lband[1]-this.xdata.lband[0]};Element.prototype._max_tpos=function(){return this.xdata.gband[1]>=0?this.xdata.gband[1]:0};Element.prototype.m_on=function(type,handler){return this.__modify({type:Element.EVENT_MOD},function(t){if(this.__evt_st&type){var evts=this.__evts[type];for(var i=0,el=evts.length;i<el;i++){if(handler.call(this,evts[i],t)===false)return false}}})};Element.prototype.findWrapBand=function(){var children=this.children;if(children.length===0)return this.xdata.gband;var result=[Infinity,0];this.visitChildren(function(elm){result=Bands.expand(result,elm.xdata.gband)});return result[0]!==Infinity?result:null};Element.prototype.dispose=function(){this.disposeHandlers();this.disposeXData();this.visitChildren(function(elm){elm.dispose()})};Element.prototype.disposeXData=function(){if(this.xdata.path)this.xdata.path.dispose();if(this.xdata.text)this.xdata.text.dispose();if(this.xdata.sheet)this.xdata.sheet.dispose()};Element.prototype.reset=function(){this.__resetState();this.__lastJump=null;this.__firedStart=false;this.__firedStop=false;(function(elm){elm.__forAllModifiers(function(modifier){if(modifier.__wasCalled)modifier.__wasCalled[elm.id]=false;if(modifier.__wasCalledAt)modifier.__wasCalledAt[elm.id]=-1})})(this);this.visitChildren(function(elm){elm.reset()})};Element.prototype.visitChildren=function(func){var children=this.children;this.__unsafeToRemove=true;for(var ei=0,el=children.length;ei<el;ei++){func(children[ei])}this.__unsafeToRemove=false};Element.prototype.travelChildren=function(func){var children=this.children;this.__unsafeToRemove=true;for(var ei=0,el=children.length;ei<el;ei++){var elem=children[ei];func(elem);elem.travelChildren(func)}this.__unsafeToRemove=false};Element.prototype.iterateChildren=function(func,rfunc){this.__unsafeToRemove=true;iter(this.children).each(func,rfunc);this.__unsafeToRemove=false};Element.prototype.hasChildren=function(){return this.children.length>0};Element.prototype.deepIterateChildren=function(func,rfunc){this.__unsafeToRemove=true;iter(this.children).each(function(elem){elem.deepIterateChildren(func,rfunc);return func(elem)},rfunc);this.__unsafeToRemove=false};Element.prototype.__performDetach=function(){var children=this.children;iter(this.__detachQueue).each(function(elm){if((idx=children.indexOf(elm))>=0){children.splice(idx,1);elm._unbind()}});this.__detachQueue=[]};Element.prototype.clear=function(){if(this.__unsafeToRemove)throw new AnimErr(Errors.A.UNSAFE_TO_REMOVE);if(!this.rendering){var children=this.children;this.children=[];iter(children).each(function(elm){elm._unbind()})}else{this.__detachQueue=this.__detachQueue.concat(this.children)}};Element.prototype.lock=function(){this.__jumpLock=true;this.__lstate=obj_clone(this.state);this.__pstate=this._state?obj_clone(this._state):null};Element.prototype.unlock=function(){var result=this.state;this.state=this.__lstate;this._state=this.__pstate;this.__lstate=null;this.__jumpLock=false;return result};Element.prototype.stateAt=function(t){this.lock();var success=this.__callModifiers(Element.NOEVT_MODIFIERS,t,0);var state=this.unlock();return success?Element._mergeStates(this.bstate,state):null};Element.prototype.getPosition=function(){return[this.bstate.x+this.state.x,this.bstate.y+this.state.y]};Element.prototype.offset=function(){var xsum=0,ysum=0;var p=this.parent;while(p){var pbs=p.bstate,ps=p.state;xsum+=pbs.x+ps.x;ysum+=pbs.y+ps.y;p=p.parent}return[xsum,ysum]};Element.prototype.dimen=function(){if(this._dimen)return this._dimen;var x=this.xdata;var subj=x.path||x.text||x.sheet;if(subj)return subj.dimen()};Element.prototype.lbounds=function(){var x=this.xdata;var subj=x.path||x.text||x.sheet;if(subj)return subj.bounds()};Element.prototype.lrect=function(){var b=this.lbounds();if(!b)return null;return[b[0],b[1],b[2],b[1],b[2],b[3],b[0],b[3]]};Element.prototype.setMask=function(elm){if(!elm)throw new AnimErr("No valid masking element was passed");if(this.scene)this.scene.__ensureHasMaskCanvas(this.level);this.__mask=elm};Element.prototype.clearMask=function(){this.__mask=null};Element.prototype.data=function(val){if(typeof val!=="undefined")return this.__data=val;return this.__data};Element.prototype.toString=function(){var buf=["[ Element "];buf.push("'"+(this.name||this.id)+"' ");buf.push("]");return buf.join("")};Element.prototype.clone=function(){var clone=new Element;clone.name=this.name;clone.children=[].concat(this.children);clone._modifiers=[].concat(this._modifiers);clone._painters=[].concat(this._painters);clone.level=this.level;clone.xdata=obj_clone(this.xdata);clone.xdata.$=clone;clone.__data=this.__data;return clone};Element.prototype.deepClone=function(){var clone=this.clone();clone.children=[];var src_children=this.children;var trg_children=clone.children;for(var sci=0,scl=src_children.length;sci<scl;sci++){var csrc=src_children[sci],cclone=csrc.deepClone();cclone.parent=clone;trg_children.push(cclone)}clone._modifiers=[];for(var mti=0,mtl=this._modifiers.length;mti<mtl;mti++){var type_group=this._modifiers[mti];if(!type_group)continue;clone._modifiers[mti]=[];for(var mpi=0,mpl=type_group.length;mpi<mpl;mpi++){var priority_group=type_group[mpi];if(!priority_group)continue;clone._modifiers[mti][mpi]=[].concat(priority_group);for(var mi=0,ml=priority_group.length;mi<ml;mi++){var modifier=priority_group[mi];if(modifier&&modifier.__m_ids){modifier.__m_ids[clone.id]=modifier.__m_ids[this.id]}}}}clone._painters=[];for(var pti=0,ptl=this._painters.length;pti<ptl;pti++){var type_group=this._painters[pti];if(!type_group)continue;clone._painters[pti]=[];for(var ppi=0,ppl=type_group.length;ppi<ppl;ppi++){var priority_group=type_group[ppi];if(!priority_group)continue;clone._painters[pti][ppi]=[].concat(priority_group);for(var pi=0,pl=priority_group.length;pi<pl;pi++){var painter=priority_group[pi];if(painter&&painter.__p_ids){painter.__p_ids[clone.id]=painter.__p_ids[this.id]}}}}clone.__data=obj_clone(this.__data);var src_x=this.xdata,trg_x=clone.xdata;if(src_x.path)trg_x.path=src_x.path.clone();if(src_x.text)trg_x.text=src_x.text.clone();if(src_x.sheet)trg_x.sheet=src_x.sheet.clone();trg_x.pos=[].concat(src_x.pos);trg_x.pvt=[].concat(src_x.pvt);trg_x.reg=[].concat(src_x.reg);trg_x.lband=[].concat(src_x.lband);trg_x.gband=[].concat(src_x.gband);trg_x.keys=obj_clone(src_x.keys);return clone};Element.prototype._addChild=function(elm){elm.parent=this;elm.level=this.level+1;this.children.push(elm);if(this.scene)this.scene._register(elm);Bands.recalc(this)};Element.prototype._addChildren=function(elms){for(var ei=0,el=elms.length;ei<el;ei++){this._addChild(elms[ei])}};Element.prototype._stateStr=function(){var state=this.state;return"x: "+s.x+" y: "+s.y+"\n"+"sx: "+s.sx+" sy: "+s.sy+"\n"+"angle: "+s.angle+" alpha: "+s.alpha+"\n"+"p: "+s.p+" t: "+s.t+" key: "+s.key+"\n"};Element.prototype.__adaptModTime=function(ltime,conf,state,modifier){var lband=this.xdata.lband,elm_duration=lband[1]-lband[0],easing=conf.easing,time=conf.time,relative=conf.relative;var _tpair=null;if(time==null){_tpair=[relative?__adjust(ltime)/__adjust(elm_duration):__adjust(ltime),__adjust(elm_duration)]}else if(__arr(time)){var band=time;if(!relative){var mod_duration=band[1]-band[0];if(__t_cmp(ltime,band[0])<0)return false;if(__t_cmp(ltime,band[1])>0)return false;_tpair=[__adjust(ltime-band[0]),__adjust(mod_duration)]}else{var abs_band=[band[0]*elm_duration,band[1]*elm_duration];var mod_duration=abs_band[1]-abs_band[0];if(__t_cmp(ltime,abs_band[0])<0)return false;if(__t_cmp(ltime,abs_band[1])>0)return false;_tpair=[__adjust(ltime-abs_band[0])/__adjust(mod_duration),__adjust(mod_duration)]}}else if(__num(time)){if(modifier.__wasCalled&&modifier.__wasCalled[this.id])return false;var tpos=relative?time*elm_duration:time;if(__t_cmp(ltime,tpos)>=0){if(!modifier.__wasCalled)modifier.__wasCalled={};if(!modifier.__wasCalledAt)modifier.__wasCalledAt={};modifier.__wasCalled[this.id]=true;modifier.__wasCalledAt[this.id]=ltime}else return false;_tpair=[relative?__adjust(ltime)/__adjust(elm_duration):__adjust(ltime),__adjust(elm_duration)]}else _tpair=[relative?__adjust(ltime)/__adjust(elm_duration):__adjust(ltime),__adjust(elm_duration)];return!easing?_tpair:[easing(_tpair[0],_tpair[1]),_tpair[1]]};Element.prototype.__callModifiers=function(order,ltime,dt){return function(elm){elm.state._=null;elm._state=Element.createState(elm);elm._state._=obj_clone(elm.state);elm.__loadEvts(elm._state);if(!elm.__forAllModifiers(order,function(modifier,conf){var lbtime=elm.__adaptModTime(ltime,conf,elm._state,modifier);if(lbtime===false)return true;return modifier.call(elm._state,lbtime[0],dt,lbtime[1],conf.data)},function(type){elm.__modifying=type;elm.__mbefore(type)},function(type){elm.__mafter(ltime,type,true)})){elm.__mafter(ltime,elm.__modifying,false);elm.__modifying=null;elm.__clearEvts(elm._state);return false}elm.__modifying=null;elm._state._applied=true;elm._state._appliedAt=ltime;elm.__clearEvts(elm._state);elm.state=elm._state;elm._state=null;return true}(this)};Element.prototype.__callPainters=function(order,ctx,t,dt){(function(elm){elm.__forAllPainters(order,function(painter,conf){painter.call(elm.xdata,ctx,conf.data,t,dt)},function(type){elm.__painting=type;elm.__pbefore(ctx,type)},function(type){elm.__pafter(ctx,type)});elm.__painting=null})(this)};Element.prototype.__addTypedModifier=function(conf,modifier){if(!modifier)throw new AnimErr(Errors.A.NO_MODIFIER_PASSED);var modifiers=this._modifiers;var elm_id=this.id;if(!modifier.__m_ids)modifier.__m_ids={};else if(modifier.__m_ids[elm_id])throw new AnimErr(Errors.A.MODIFIER_REGISTERED);var priority=conf.priority||0,type=conf.type;if(!modifiers[type])modifiers[type]=[];if(!modifiers[type][priority])modifiers[type][priority]=[];modifiers[type][priority].push([modifier,{type:type,priority:priority,time:conf.time,relative:conf.relative,easing:Element.__convertEasing(conf.easing,null,conf.relative),data:conf.data}]);modifier.__m_ids[elm_id]=type<<Element.TYPE_MAX_BIT|priority<<Element.PRRT_MAX_BIT|modifiers[type][priority].length-1;return modifier};Element.prototype.__modify=Element.prototype.__addTypedModifier;Element.prototype.__forAllModifiers=function(order,f,before_type,after_type){var modifiers=this._modifiers;var type,seq,cur;for(var typenum=0,last=order.length;typenum<last;typenum++){type=order[typenum];seq=modifiers[type];if(before_type)before_type(type);if(seq){for(var pi=0,pl=seq.length;pi<pl;pi++){if(cur=seq[pi]){for(var ci=0,cl=cur.length;ci<cl;ci++){var modifier;if(modifier=cur[ci]){if(f(modifier[0],modifier[1])===false)return false}}}}}if(after_type)after_type(type)}return true};Element.prototype.__addTypedPainter=function(conf,painter){if(!painter)throw new AnimErr(Errors.A.NO_PAINTER_PASSED);var painters=this._painters;var elm_id=this.id;if(!painter.__p_ids)painter.__p_ids={};else if(painter.__p_ids[elm_id])throw new AnimErr(Errors.A.PAINTER_REGISTERED);var priority=conf.priority||0,type=conf.type;if(!painters[type])painters[type]=[];if(!painters[type][priority])painters[type][priority]=[];painters[type][priority].push([painter,{type:type,priority:priority,data:conf.data}]);painter.__p_ids[elm_id]=type<<Element.TYPE_MAX_BIT|priority<<Element.PRRT_MAX_BIT|painters[type][priority].length-1;return painter};Element.prototype.__paint=Element.prototype.__addTypedPainter;Element.prototype.__forAllPainters=function(order,f,before_type,after_type){var painters=this._painters;var type,seq,cur;for(var typenum=0,last=order.length;typenum<last;typenum++){type=order[typenum];seq=painters[type];if(before_type)before_type(type);if(seq){for(var pi=0,pl=seq.length;pi<pl;pi++){if(cur=seq[pi]){for(var ci=0,cl=cur.length;ci<cl;ci++){if(cur[ci])f(cur[ci][0],cur[ci][1])}}}}if(after_type)after_type(type)}return true};Element.prototype.__mbefore=function(t,type){};Element.prototype.__mafter=function(t,type,result){};Element.prototype.__pbefore=function(ctx,type){};Element.prototype.__pafter=function(ctx,type){};Element.prototype.__checkJump=function(at){var x=this.xdata,s=this.state;if(x.tf)return x.tf(at);var t=null,duration=x.lband[1]-x.lband[0];t=s.p!==null?s.p:null;t=t===null&&s.t!==null?s.t*duration:t;t=t===null&&s.key!==null?x.keys[s.key]:t;if(t!==null){if(t<0||t>duration){throw new AnimErr("failed to calculate jump")}if(!this.__jumpLock){this.__lastJump=[at,t];s.p=null;s.t=null;s.key=null;return t}}t=t!==null?t:at;if(this.__lastJump!==null){return this.__lastJump[1]+(t-this.__lastJump[0])}return t};Element.prototype.handle__x=function(type,evt){if(!Player._isPlayerEvent(type)&&type!=C.X_START&&type!=C.X_STOP){if(this.shown){this.__saveEvt(type,evt)}else{return false}}return true};Element.prototype.__saveEvt=function(type,evt){this.__evtCache.push([type,evt])};Element.prototype.__loadEvts=function(to){var cache=this.__evtCache;var cache_len=cache.length;this.__clearEvts(to);if(cache_len>0){var edata,type,evts;for(var ei=0;ei<cache_len;ei++){edata=cache[ei];type=edata[0];to.__evt_st|=type;evts=to.__evts;if(!evts[type])evts[type]=[];evts[type].push(edata[1])}this.__evtCache=[]}};Element.prototype.__clearEvts=function(from){from.__evt_st=0;from.__evts={}};Element.prototype.__preRender=function(gtime,ltime,ctx){var cr=this.__frameProcessors;for(var i=0,cl=cr.length;i<cl;i++){if(cr[i].call(this,gtime,ltime,ctx)===false)return false}return true};Element.prototype.__postRender=function(){this.__performDetach()};Element.prototype.__resetState=function(){var s=this.state;s.x=0;s.y=0;s.angle=0;s.alpha=1;s.sx=1;s.sy=1;s.p=null;s.t=null;s.key=null;s._applied=false;s._appliedAt=null;s._matrix.reset()};Element.prototype._hasRemoteResources=function(scene,player){if(player.imagesEnabled&&this.xdata.sheet)return true};Element.prototype._collectRemoteResources=function(scene,player){if(!player.imagesEnabled)return null;if(!this.xdata.sheet)return null;return[this.xdata.sheet.src]};Element.prototype._loadRemoteResources=function(scene,player){if(!player.imagesEnabled)return;if(!this.xdata.sheet)return;this.xdata.sheet.load()};Element.createBaseState=function(){return{x:0,y:0,angle:0,sx:1,sy:1,hx:0,hy:0,alpha:1,p:null,t:null,key:null,_applied:true}};Element.createState=function(owner){return{x:0,y:0,angle:0,sx:1,sy:1,hx:0,hy:0,alpha:1,p:null,t:null,key:null,_matrix:$engine.createTransform(),_evts:{},_evt_st:0,$:owner}};Element.createXData=function(owner){return{pvt:Element.DEFAULT_PVT,reg:Element.DEFAULT_REG,path:null,text:null,sheet:null,mode:C.R_ONCE,nrep:Infinity,lband:[0,Element.DEFAULT_LEN],gband:[0,Element.DEFAULT_LEN],keys:{},tf:null,acomp:null,_mpath:null,$:owner}};Element.__addSysModifiers=function(elm){};Element.__addSysPainters=function(elm){elm.__paint({type:Element.SYS_PNT},Render.p_usePivot);elm.__paint({type:Element.SYS_PNT},Render.p_useReg);elm.__paint({type:Element.SYS_PNT},Render.p_applyAComp);elm.__paint({type:Element.SYS_PNT},Render.p_drawXData)};Element.__addDebugRender=function(elm){elm.__paint({type:Element.DEBUG_PNT},Render.p_drawPivot);elm.__paint({type:Element.DEBUG_PNT},Render.p_drawReg);elm.__paint({type:Element.DEBUG_PNT},Render.p_drawName);elm.__paint({type:Element.DEBUG_PNT,priority:1},Render.p_drawMPath)};Element.__addTweenModifier=function(elm,conf){var tween_f=Tweens[conf.type](),m_tween;if(conf.relative){m_tween=tween_f}else{m_tween=function(t,dt,duration,data){return tween_f.call(this,__finite(duration)&&duration?t/duration:0,dt,duration,data)}}return elm.__modify({type:Element.TWEEN_MOD,priority:Tween.TWEENS_PRIORITY[conf.type],time:conf.band||conf.time,relative:conf.relative,easing:conf.easing,data:conf.data},m_tween)};Element.__convertEasing=function(easing,data,relative){if(!easing)return null;if(__str(easing)){var f=EasingImpl[easing](data);return relative?f:function(t,len){return f(t/len,len)*len}}if(__fun(easing)&&!data)return easing;if(__fun(easing)&&data)return easing(data);if(easing.type){var f=EasingImpl[easing.type](easing.data||data);return relative?f:function(t,len){return f(t/len,len)*len}}if(easing.f)return easing.f(easing.data||data)};Element._mergeStates=function(s1,s2){return{x:s1.x+s2.x,y:s1.y+s2.y,sx:s1.sx*s2.sx,sy:s1.sy*s2.sy,hx:s1.hx+s2.hx,hy:s1.hy+s2.hy,angle:s1.angle+s2.angle,alpha:s1.alpha*s2.alpha,_applied:s1._applied&&s2._applied}};Element._getMatrixOf=function(s,m){var _t=m?(m.reset(),m):new Transform;_t.translate(s.x,s.y);_t.rotate(s.angle);_t.shear(s.hx,s.hy);_t.scale(s.sx,s.sy);return _t};Element._getIMatrixOf=function(s,m){var _t=Element._getMatrixOf(s,m);_t.invert();return _t};var Clip=Element;var L={};L.loadFromUrl=function(player,url,importer,callback){if(!JSON)throw new SysErr(Errors.S.NO_JSON_PARSER);var success=function(req){L.loadFromObj(player,JSON.parse(req.responseText),importer,callback)};var failure=player.__defAsyncSafe(function(err){throw new SysErr("Snapshot failed to load")});$engine.ajax(url,success,failure)};L.loadFromObj=function(player,object,importer,callback){if(!importer)throw new PlayerErr(Errors.P.NO_IMPORTER_TO_LOAD_WITH);var scene=importer.load(object);player.fire(C.S_IMPORT,importer,scene,object);L.loadScene(player,scene,callback)};L.loadScene=function(player,scene,callback){if(player.anim)player.anim.dispose();if(player.debug&&!global_opts.liveDebug)scene.visitElems(Element.__addDebugRender);player.anim=scene;if(callback)callback.call(player,scene)};L.loadClips=function(player,clips,callback){var _anim=new Scene;_anim.add(clips);L.loadScene(player,_anim,callback)};L.loadBuilder=function(player,builder,callback){var _anim=new Scene;_anim.add(builder.v);if(builder.d!=undefined)_anim.duration=builder.d;L.loadScene(player,_anim,callback)};var Render={};function __r_loop(ctx,player,scene,before,after,before_render,after_render){var pl_state=player.state;if(pl_state.happens!==C.PLAYING)return;var msec=Date.now()-pl_state.__startTime;var sec=msec/1e3;var time=sec*pl_state.speed+pl_state.from,dt=time-pl_state.__prevt;pl_state.time=time;pl_state.__dt=dt;pl_state.__prevt=time;if(before){if(!before(time))return}if(pl_state.__rsec===0)pl_state.__rsec=msec;if(msec-pl_state.__rsec>=1e3){pl_state.afps=pl_state.__redraws;pl_state.__rsec=msec;pl_state.__redraws=0}pl_state.__redraws++;__r_at(time,dt,ctx,scene,player.width,player.height,player.zoom,before_render,after_render);if(player.debug){__r_fps(ctx,pl_state.afps,time)}if(after){if(!after(time))return}if(pl_state.__supressFrames)return;return __nextFrame(function(){__r_loop(ctx,player,scene,before,after,before_render,after_render)})}function __r_at(time,dt,ctx,scene,width,height,zoom,before,after){ctx.save();var ratio=$engine.PX_RATIO;if(ratio!==1)ctx.scale(ratio,ratio);var width=width|0,height=height|0;var size_differs=width!=scene.width||height!=scene.height;if(!size_differs){try{ctx.clearRect(0,0,scene.width,scene.height);if(before)before(time,ctx);if(zoom!=1)ctx.scale(zoom,zoom);scene.render(ctx,time,dt);if(after)after(time,ctx)}finally{ctx.restore()}}else{__r_with_ribbons(ctx,width,height,scene.width,scene.height,function(_scale){try{ctx.clearRect(0,0,scene.width,scene.height);if(before)before(time,ctx);if(zoom!=1)ctx.scale(zoom,zoom);scene.render(ctx,time,dt);if(after)after(time,ctx)}finally{ctx.restore()}})}}function __r_with_ribbons(ctx,pw,ph,sw,sh,draw_f){var xw=pw/sw,xh=ph/sh;var x=Math.min(xw,xh);var hcoord=(pw-sw*x)/2,vcoord=(ph-sh*x)/2;var scaled=xw!=1||xh!=1;if(scaled){ctx.save();ctx.save();ctx.fillStyle="#000";if(hcoord!=0){ctx.fillRect(0,0,hcoord,ph);ctx.fillRect(hcoord+sw*x,0,hcoord,ph)}if(vcoord!=0){ctx.fillRect(0,0,pw,vcoord);ctx.fillRect(0,vcoord+sh*x,pw,vcoord)}ctx.restore();ctx.beginPath();ctx.rect(hcoord,vcoord,sw*x,sh*x);ctx.clip();ctx.translate(hcoord,vcoord);ctx.scale(x,x)}draw_f(x);if(scaled){ctx.restore()}}function __r_fps(ctx,fps,time){ctx.fillStyle="#999";ctx.font="20px sans-serif";ctx.fillText(Math.floor(fps),8,20);ctx.font="10px sans-serif";ctx.fillText(Math.floor(time*1e3)/1e3,8,35)}Render.loop=__r_loop;Render.at=__r_at;Render._drawFPS=__r_fps;Render.p_drawPivot=function(ctx,pvt){if(!(pvt=pvt||this.pvt))return;var dimen=this.$.dimen()||[0,0];var stokeStyle=dimen?"#600":"#f00";ctx.save();ctx.translate(pvt[0]*dimen[0],pvt[1]*dimen[1]);ctx.beginPath();ctx.lineWidth=1;ctx.strokeStyle=stokeStyle;ctx.moveTo(0,-10);ctx.lineTo(0,0);ctx.moveTo(3,0);ctx.arc(0,0,3,0,Math.PI*2,true);ctx.closePath();ctx.stroke();ctx.restore()};Render.p_drawReg=function(ctx,reg){if(!(reg=reg||this.reg))return;ctx.save();ctx.lineWidth=1;ctx.strokeStyle="#00f";ctx.fillStyle="rgba(0,0,255,.3)";ctx.translate(reg[0],reg[1]);ctx.beginPath();ctx.moveTo(-4,-4);ctx.lineTo(4,-4);ctx.lineTo(4,4);ctx.lineTo(-4,4);ctx.lineTo(-4,-4);ctx.closePath();ctx.stroke();ctx.beginPath();ctx.moveTo(0,-10);ctx.lineTo(0,0);ctx.moveTo(3,0);ctx.closePath();ctx.stroke();ctx.restore()};Render.p_drawXData=function(ctx){var subj=this.path||this.text||this.sheet;if(!subj)return;subj.apply(ctx)};Render.p_drawName=function(ctx,name){if(!(name=name||this.$.name))return;ctx.save();ctx.fillStyle="#666";ctx.font="12px sans-serif";ctx.fillText(name,0,10);ctx.restore()};Render.p_applyAComp=function(ctx){if(this.acomp)ctx.globalCompositeOperation=C.AC_NAMES[this.acomp]};Render.p_useReg=function(ctx){var reg=this.reg;if(reg[0]===0&&reg[1]===0)return;ctx.translate(-reg[0],-reg[1])};Render.p_usePivot=function(ctx){var dimen=this.$.dimen(),pvt=this.pvt;if(!dimen)return;if(pvt[0]===0&&pvt[1]===0)return;ctx.translate(-(pvt[0]*dimen[0]),-(pvt[1]*dimen[1]))};Render.p_drawMPath=function(ctx,mPath){if(!(mPath=mPath||this.$.state._mpath))return;ctx.save();mPath.cstroke("#600",2);ctx.beginPath();mPath.apply(ctx);ctx.closePath();ctx.stroke();ctx.restore()};Render.m_checkBand=function(time,duration,band){if(band[0]>duration*time)return false;if(band[1]<duration*time)return false};var Bands={};Bands.recalc=function(elm,in_band){var x=elm.xdata;var in_band=in_band||(elm.parent?elm.parent.xdata.gband:[0,0]);x.gband=[in_band[0]+x.lband[0],in_band[0]+x.lband[1]];elm.visitChildren(function(celm){Bands.recalc(celm,x.gband)})};Bands.wrap=function(outer,inner){if(!outer)return inner;return[outer[0]+inner[0],outer[0]+inner[1]<=outer[1]?outer[0]+inner[1]:outer[1]]};Bands.expand=function(from,to){if(!from)return to;return[to[0]<from[0]?to[0]:from[0],to[1]>from[1]?to[1]:from[1]]};Bands.reduce=function(from,to){if(!from)return to;return[to[0]>from[0]?to[0]:from[0],to[1]<from[1]?to[1]:from[1]]};C.T_TRANSLATE="TRANSLATE";C.T_SCALE="SCALE";C.T_ROTATE="ROTATE";C.T_ROT_TO_PATH="ROT_TO_PATH";C.T_ALPHA="ALPHA";C.T_SHEAR="SHEAR";var Tween={};var Easing={};Tween.TWEENS_PRIORITY={};Tween.TWEENS_PRIORITY[C.T_TRANSLATE]=0;Tween.TWEENS_PRIORITY[C.T_SCALE]=1;Tween.TWEENS_PRIORITY[C.T_ROTATE]=2;Tween.TWEENS_PRIORITY[C.T_ROT_TO_PATH]=3;Tween.TWEENS_PRIORITY[C.T_ALPHA]=4;Tween.TWEENS_PRIORITY[C.T_SHEAR]=5;Tween.TWEENS_COUNT=6;var Tweens={};Tweens[C.T_ROTATE]=function(){return function(t,dt,duration,data){this.angle=data[0]*(1-t)+data[1]*t}};Tweens[C.T_TRANSLATE]=function(){return function(t,dt,duration,data){var p=data.pointAt(t);this._mpath=data;this.x=p[0];this.y=p[1]}};Tweens[C.T_ALPHA]=function(){return function(t,dt,duration,data){this.alpha=data[0]*(1-t)+data[1]*t}};Tweens[C.T_SCALE]=function(){return function(t,dt,duration,data){this.sx=data[0][0]*(1-t)+data[1][0]*t;this.sy=data[0][1]*(1-t)+data[1][1]*t}};Tweens[C.T_ROT_TO_PATH]=function(){return function(t,dt,duration,data){var path=this._mpath;if(path)this.angle+=path.tangentAt(t)}};Tweens[C.T_SHEAR]=function(){return function(t,dt,duration,data){this.hx=data[0][0]*(1-t)+data[1][0]*t;this.hy=data[0][1]*(1-t)+data[1][1]*t}};C.E_PATH="PATH";C.E_FUNC="FUNC";C.E_CSEG="CSEG";C.E_STDF="STDF";var EasingImpl={};EasingImpl[C.E_PATH]=function(path){return function(t){return path.pointAt(t)[1]}};EasingImpl[C.E_FUNC]=function(f){return f};EasingImpl[C.E_CSEG]=function(seg){return function(t){return seg.atT([0,0],t)[1]}};EasingImpl[C.E_STDF]=function(num){return Easing.__STD_EASINGS[num]};Easing.__SEGS={};function __registerSegEasing(alias,points){C["E_"+alias]=alias;var seg=new CSeg(points);Easing.__SEGS[alias]=seg;var func=function(t){return seg.atT([0,0],t)[1]};C["EF_"+alias]=func;EasingImpl[alias]=function(){return func
}}__registerSegEasing("DEF",[.25,.1,.25,1,1,1]);__registerSegEasing("IN",[.42,0,1,1,1,1]);__registerSegEasing("OUT",[0,0,.58,1,1,1]);__registerSegEasing("INOUT",[.42,0,.58,1,1,1]);__registerSegEasing("SIN",[.47,0,.745,.715,1,1]);__registerSegEasing("SOUT",[.39,.575,.565,1,1,1]);__registerSegEasing("SINOUT",[.445,.05,.55,.95,1,1]);__registerSegEasing("QIN",[.55,.085,.68,.53,1,1]);__registerSegEasing("QOUT",[.25,.46,.45,.94,1,1]);__registerSegEasing("QINOUT",[.455,.03,.515,.955,1,1]);__registerSegEasing("CIN",[.55,.055,.675,.19,1,1]);__registerSegEasing("COUT",[.215,.61,.355,1,1,1]);__registerSegEasing("CINOUT",[.645,.045,.355,1,1,1]);__registerSegEasing("QTIN",[.895,.03,.685,.22,1,1]);__registerSegEasing("QTOUT",[.165,.84,.44,1,1,1]);__registerSegEasing("QTINOUT",[.77,0,.175,1,1,1]);__registerSegEasing("QIIN",[.755,.05,.855,.06,1,1]);__registerSegEasing("QIOUT",[.23,1,.32,1,1,1]);__registerSegEasing("QIINOUT",[.86,0,.07,1,1,1]);__registerSegEasing("EIN",[.95,.05,.795,.035,1,1]);__registerSegEasing("EOUT",[.19,1,.22,1,1,1]);__registerSegEasing("EINOUT",[1,0,0,1,1,1]);__registerSegEasing("CRIN",[.6,.04,.98,.335,1,1]);__registerSegEasing("CROUT",[.075,.82,.165,1,1,1]);__registerSegEasing("CRINOUT",[.785,.135,.15,.86,1,1]);__registerSegEasing("BIN",[.6,-.28,.735,.045,1,1]);__registerSegEasing("BOUT",[.175,.885,.32,1.275,1,1]);__registerSegEasing("BINOUT",[.68,-.55,.265,1.55,1,1]);Easing.__STD_EASINGS=[function(t){return C["EF_DEF"](t)},function(t){return C["EF_IN"](t)},function(t){return C["EF_OUT"](t)},function(t){return C["EF_INOUT"](t)},function(t){return t*t},function(t){return t*(2-t)},function(t){if(t<.5)return 2*t*t;else{t=(t-.5)*2;return-(t*(t-2)-1)/2}},function(t){return t*t*t},function(t){t=t-1;return t*t*t+1},function(t){if(t<.5){t=t*2;return t*t*t/2}else{t=(t-.5)*2-1;return(t*t*t+2)/2}},function(t){return 1-Math.cos(t*(Math.PI/2))},function(t){return Math.sin(t*(Math.PI/2))},function(t){return-(Math.cos(Math.PI*t)-1)/2},function(t){return t<=0?0:Math.pow(2,10*(t-1))},function(t){return t>=1?1:-Math.pow(2,-10*t)+1},function(t){if(t<=0)return 0;if(t>=1)return 1;if(t<.5)return Math.pow(2,10*(t*2-1))/2;else{return(-Math.pow(2,-10*(t-.5)*2)+2)/2}},function(t){return 1-Math.sqrt(1-t*t)},function(t){t=t-1;return Math.sqrt(1-t*t)},function(t){if((t*=2)<1)return-(Math.sqrt(1-t*t)-1)/2;return(Math.sqrt(1-(t-=2)*t)+1)/2},function(t){var s=1.70158;return t*t*((s+1)*t-s)},function(t){var s=1.70158;return(t-=1)*t*((s+1)*t+s)+1},function(t){var s=1.70158;if((t*=2)<1)return t*t*(((s*=1.525)+1)*t-s)/2;return((t-=2)*t*(((s*=1.525)+1)*t+s)+2)/2},function(t){return 1-Easing.__STD_EASINGS[23](1-t)},function(t){if(t<1/2.75){return 7.5625*t*t}else if(t<2/2.75){return 7.5625*(t-=1.5/2.75)*t+.75}else if(t<2.5/2.75){return 7.5625*(t-=2.25/2.75)*t+.9375}else{return 7.5625*(t-=2.625/2.75)*t+.984375}},function(t){if(t<.5)return Easing.__STD_EASINGS[22](t*2)*.5;return Easing.__STD_EASINGS[23](t*2-1)*.5+.5}];C.P_MOVETO=0;C.P_LINETO=1;C.P_CURVETO=2;C.PC_ROUND="round";C.PC_BUTT="butt";C.PC_MITER="miter";C.PC_SQUARE="square";C.PC_BEVEL="bevel";function Path(val,fill,stroke,shadow){this.fill=fill;this.stroke=stroke;this.shadow=shadow;this.segs=[];if(__str(val)){this.parse(val)}else if(__arr(val)){this.segs=val}}Path.DEFAULT_CAP=C.PC_ROUND;Path.DEFAULT_JOIN=C.PC_ROUND;Path.EMPTY_FILL={color:"transparent"};Path.DEFAULT_FILL=Path.EMPTY_FILL;Path.BASE_FILL={color:"#fff666"};Path.EMPTY_STROKE={width:0,color:"transparent"};Path.DEFAULT_STROKE=Path.EMPTY_STROKE;Path.BASE_STROKE={width:1,color:"#000",cap:Path.DEFAULT_CAP,join:Path.DEFAULT_JOIN};Path.prototype.visit=function(visitor,data){var segments=this.segs;for(var si=0,sl=segments.length;si<sl;si++){visitor(segments[si],data)}};Path.prototype.length=function(){var sum=0;var p=this.start();this.visit(function(segment){sum+=segment.length(p);p=segment.last()});return sum};Path.prototype.add=function(seg){this.segs.push(seg)};Path.prototype.apply=function(ctx){var p=this;Path.applyF(ctx,p.fill||Path.DEFAULT_FILL,p.stroke||Path.DEFAULT_STROKE,p.shadow,function(){p.visit(Path._applyVisitor,ctx)})};Path.prototype.cstroke=function(color,width,cap,join){this.stroke={width:width!=null?width:Path.DEFAULT_STROKE.width,color:color,cap:cap||Path.DEFAULT_CAP,join:join||Path.DEFAULT_JOIN}};Path.prototype.cfill=function(color){this.fill={color:color}};Path.prototype.parse=function(str){if(str)Path.parse(str,this);return this};Path.prototype.hitAt=function(t){var plen=this.length();if(t<0||t>1)return null;var startp=this.start();if(t===0)return{seg:this.segs[0],start:startp,slen:0,segt:0};var nsegs=this.segs.length;var distance=t*plen;var p=startp;var length=0;var seg,slen;for(var si=0;si<nsegs;si++){seg=this.segs[si];if(seg.type!==C.P_MOVE_TO){slen=seg.length(p);if(distance<=length+slen){var segdist=distance-length;return{seg:seg,start:p,slen:slen,segt:slen!=0?segdist/slen:0}}length+=slen}p=seg.last()}return null};Path.prototype.pointAt=function(t){var hit=this.hitAt(t);if(!hit)return this.start();return hit.seg.atT(hit.start,hit.segt)};Path.prototype.tangentAt=function(t){var hit=this.hitAt(t);if(!hit)return 0;return hit.seg.tangentAt(hit.start,hit.segt)};Path.prototype.start=function(){if(this.segs.length<1)return null;return[this.segs[0].pts[0],this.segs[0].pts[1]]};Path.prototype.end=function(){if(this.segs.length<1)return null;var lastidx=this.segs.length-1;var s=this.segs[lastidx].count;return[this.segs[lastidx].pts[s-2],this.segs[lastidx].pts[s-1]]};Path.prototype.bounds=function(){if(this.segs.length<=0)return[0,0,0,0];var minX=this.segs[0].pts[0],maxX=this.segs[0].pts[0],minY=this.segs[0].pts[1],maxY=this.segs[0].pts[1];this.visit(function(segment){var pts=segment.pts,pnum=pts.length;for(var pi=0;pi<pnum;pi+=2){minX=Math.min(minX,pts[pi]);maxX=Math.max(maxX,pts[pi])}for(var pi=1;pi<pnum;pi+=2){minY=Math.min(minY,pts[pi]);maxY=Math.max(maxY,pts[pi])}});return[minX,minY,maxX,maxY]};Path.prototype.dimen=function(){var bounds=this.bounds();return[bounds[2],bounds[3]]};Path.prototype.rect=function(){var b=this.bounds();return[b[0],b[1],b[2],b[1],b[2],b[3],b[0],b[3]]};Path.prototype.vpoints=function(func){this.visit(function(segment){var pts=segment.pts,pnum=pts.length;for(var pi=0;pi<pnum;pi+=2){var res=func(pts[pi],pts[pi+1]);if(res){pts[pi]=res[0];pts[pi+1]=res[1]}}})};Path.prototype.shift=function(pt){this.vpoints(function(x,y){return[x+pt[0],y+pt[1]]})};Path.prototype.zoom=function(vals){this.vpoints(function(x,y){return[x*vals[0],y*vals[1]]})};Path.prototype.normalize=function(){var bounds=this.bounds();var w=bounds[2]-bounds[0],h=bounds[3]-bounds[1];var hw=Math.floor(w/2),hh=Math.floor(h/2);var min_x=bounds[0],min_y=bounds[1];this.vpoints(function(x,y){return[x-min_x-hw,y-min_y-hh]});return[hw,hh]};Path.prototype.getPoints=function(){var points=[];this.visit(function(seg){points=points.concat(seg.pts)});return points};Path.prototype.toString=function(){return"[ Path '"+Path.toSVGString(this)+"' ]"};Path.prototype.duplicate=function(){var seg_copy=new Path;this.visit(function(seg){seg_copy.add(Path.makeSeg(seg.type,[].concat(seg.pts)))});return seg_copy};Path.prototype.load=function(src){if(src.stroke)this.stroke=obj_clone(src.stroke);if(src.fill)this.fill=obj_clone(src.fill);if(src.shadow)this.shadow=obj_clone(src.shadow)};Path.prototype.clone=function(){var clone=this.duplicate();if(this.stroke)clone.stroke=obj_clone(this.stroke);if(this.fill)clone.fill=obj_clone(this.fill);if(this.shadow)clone.shadow=obj_clone(this.shadow);return clone};Path.prototype.dispose=function(){};Path.applyF=function(ctx,fill,stroke,shadow,func){ctx.beginPath();Brush.fill(ctx,fill);Brush.stroke(ctx,stroke);Brush.shadow(ctx,shadow);func(ctx);if(Brush._hasVal(fill))ctx.fill();if(Brush._hasVal(stroke))ctx.stroke()};Path.visitStrPath=function(path,visitor,data){var cur_pos=0;while(true){var marker=path[cur_pos];if(marker==="Z"){visitor(marker,[],data);return}var pos_data=null;if(marker==="M"||marker==="L"){pos_data=Path._collectPositions(path,cur_pos,2)}else if(marker==="C"){pos_data=Path._collectPositions(path,cur_pos,6)}cur_pos+=pos_data[0];var positions=pos_data[1];visitor(marker,positions,data)}};Path.toSVGString=function(path){var buffer=[];path.visit(Path._encodeVisitor,buffer);buffer.push("Z");return buffer.join(" ")};Path._collectPositions=function(path,start,count){var pos=start+1;var positions=[];var got=0;while(got!=count){var posstr=__collect_to(path,pos," ");pos+=posstr.length+1;got++;positions.push(parseFloat(posstr))}return[pos-start,positions]};Path._parserVisitor=function(marker,positions,path){if(marker==="M"){path.add(new MSeg(positions))}else if(marker==="L"){path.add(new LSeg(positions))}else if(marker==="C"){path.add(new CSeg(positions))}};Path._strApplyVisitor=function(marker,positions,ctx){if(marker==="M"){ctx.moveTo(positions[0],positions[1])}else if(marker==="L"){ctx.lineTo(positions[0],positions[1])}else if(marker==="C"){ctx.bezierCurveTo(positions[0],positions[1],positions[2],positions[3],positions[4],positions[5])}};Path._applyVisitor=function(segment,ctx){var type=segment.type;var positions=segment.pts;if(type===C.P_MOVETO){ctx.moveTo(positions[0],positions[1])}else if(type===C.P_LINETO){ctx.lineTo(positions[0],positions[1])}else if(type===C.P_CURVETO){ctx.bezierCurveTo(positions[0],positions[1],positions[2],positions[3],positions[4],positions[5])}};Path._encodeVisitor=function(segment,buffer){var type=segment.type;var positions=segment.pts;if(type===C.P_MOVETO){buffer.push("M"+positions[0]+" "+positions[1])}else if(type===C.P_LINETO){buffer.push("L"+positions[0]+" "+positions[1])}else if(type===C.P_CURVETO){buffer.push("C"+positions[0]+" "+positions[1]+" "+positions[2]+" "+positions[3]+" "+positions[4]+" "+positions[5])}};Path.parse=function(path,target){var target=target||new Path;target.segs=[];Path.visitStrPath(path,Path._parserVisitor,target);target.str=path;return target};Path.parseAndApply=function(ctx,path){Path.visitStrPath(path,Path._strApplyVisitor,ctx)};Path.makeSeg=function(type,pts){if(type===C.P_MOVETO){return new MSeg(pts)}else if(type===C.P_LINETO){return new LSeg(pts)}else if(type===C.P_CURVETO){return new CSeg(pts)}};function MSeg(pts){this.type=C.P_MOVETO;this.pts=pts;this.count=pts.length}MSeg.prototype.length=function(start){return 0};MSeg.prototype.atDist=function(start,dist){return[this.pts[0],this.pts[1]]};MSeg.prototype.atT=function(start,t){return this.atDist(start,null)};MSeg.prototype.tangentAt=function(start,t){return 0};MSeg.prototype.last=function(){return[this.pts[0],this.pts[1]]};MSeg.prototype.toString=function(){return"M "+this.pts.join(" ")};function LSeg(pts){this.type=C.P_LINETO;this.pts=pts;this.count=pts.length}LSeg.prototype.length=function(start){var dx=this.pts[0]-start[0];var dy=this.pts[1]-start[1];return Math.sqrt(dx*dx+dy*dy)};LSeg.prototype.atDist=function(start,dist){return this.atT(start,dist/this.length(start))};LSeg.prototype.atT=function(start,t){var p0x=start[0];var p0y=start[1];var p1x=this.pts[0];var p1y=this.pts[1];return[p0x+(p1x-p0x)*t,p0y+(p1y-p0y)*t]};LSeg.prototype.tangentAt=function(start,t){return Math.atan2(this.pts[1]-start[1],this.pts[0]-start[0])};LSeg.prototype.last=function(){return[this.pts[0],this.pts[1]]};LSeg.prototype.toString=function(){return"L "+this.pts.join(" ")};function CSeg(pts){this.type=C.P_CURVETO;this.pts=pts;this.count=pts.length}CSeg.prototype.length=function(start){var positions=this.pts;var p0x=start[0];var p0y=start[1];var p1x=positions[0];var p1y=positions[1];var p2x=positions[2];var p2y=positions[3];var p3x=positions[4];var p3y=positions[5];var p0to1=Math.sqrt(Math.pow(p1x-p0x,2)+Math.pow(p1y-p0y,2));var p1to2=Math.sqrt(Math.pow(p2x-p1x,2)+Math.pow(p2y-p1y,2));var p2to3=Math.sqrt(Math.pow(p3x-p2x,2)+Math.pow(p3y-p2y,2));var len=p0to1+p1to2+p2to3+1;var count=len*3;var dt=1/len;var q1=3*dt;var q2=q1*dt;var q3=dt*dt*dt;var q4=2*q2;var q5=6*q3;var q6x=p0x-2*p1x+p2x;var q6y=p0y-2*p1y+p2y;var q7x=3*(p1x-p2x)-p0x+p3x;var q7y=3*(p1y-p2y)-p0y+p3y;var bx=p0x;var by=p0y;var dbx=(p1x-p0x)*q1+q6x*q2+q3*q7x;var dby=(p1y-p0y)*q1+q6y*q2+q3*q7y;var ddbx=q6x*q4+q7x*q5;var ddby=q6y*q4+q7y*q5;var dddbx=q7x*q5;var dddby=q7y*q5;var length=0;for(var idx=0;idx<count;idx+=3){var px=bx;var py=by;bx+=dbx;by+=dby;dbx+=ddbx;dby+=ddby;ddbx+=dddbx;ddby+=dddby;length+=Math.sqrt((bx-px)*(bx-px)+(by-py)*(by-py))}return length};CSeg.prototype.atDist=function(start,dist){return this.atT(start,dist/this.length(start))};CSeg.prototype.atT=function(start,t){var tt=t*t,ttt=tt*t,t1=1-t,tt1=t1*t1,tt2=tt1*t1,tt3=3*t*tt1,tt4=3*tt*t1;return[start[0]*tt2+this.pts[0]*tt3+this.pts[2]*tt4+this.pts[4]*ttt,start[1]*tt2+this.pts[1]*tt3+this.pts[3]*tt4+this.pts[5]*ttt]};CSeg.prototype.last=function(){return[this.pts[4],this.pts[5]]};CSeg.prototype.tangentAt=function(start,t){if(t<0||t>1)return 0;var p1=this.atT(start,t),p2=this.atT(start,t+.001);return Math.atan2(p2[1]-p1[1],p2[0]-p1[0])};CSeg.prototype._ensure_params=function(start){if(this._lstart&&this._lstart[0]===start[0]&&this._lstart[1]===start[1])return;this._lstart=start;this._params=this._calc_params(start)};CSeg.prototype._calc_params=function(start){var pts=this.pts;var params=[];var p0x=start[0];var p0y=start[1];var p1x=pts[0];var p1y=pts[1];var p2x=pts[2];var p2y=pts[3];var p3x=pts[4];var p3y=pts[5];params[0]=p3x-3*p2x+3*p1x-p0x;params[1]=3*p2x-6*p1x+3*p0x;params[2]=3*p1x-3*p0x;params[3]=p0x;params[4]=p3y-3*p2y+3*p1y-p0y;params[5]=3*p2y-6*p1y+3*p0y;params[6]=3*p1y-3*p0y;params[7]=p0y;return params};function Text(lines,font,fill,stroke,shadow,align,baseline,underlined){this.lines=lines;this.font=font||Text.DEFAULT_FONT;this.fill=fill||Text.DEFAULT_FILL;this.stroke=stroke||Text.DEFAULT_STROKE;this.shadow=shadow;this.align=align||Text.DEFAULT_ALIGN;this.baseline=baseline||Text.DEFAULT_BASELINE;this.underlined=underlined||Text.DEFAULT_UNDERLINE;this._bnds=null}Text.DEFAULT_CAP=C.PC_ROUND;Text.DEFAULT_JOIN=C.PC_ROUND;Text.DEFAULT_FFACE="sans-serif";Text.DEFAULT_FSIZE=24;Text.DEFAULT_FONT=Text.DEFAULT_FSIZE+"px "+Text.DEFAULT_FFACE;Text.DEFAULT_FILL={color:"#000"};Text.DEFAULT_ALIGN="left";Text.DEFAULT_BASELINE="bottom";Text.DEFAULT_STROKE=null;Text.DEFAULT_UNDERLINE=false;Text.prototype.apply=function(ctx,pos,baseline){ctx.save();var pos=pos||[0,0],dimen=this.dimen(),ascent=this.ascent(dimen[1]),underlined=this.underlined;ctx.font=this.font;ctx.textBaseline=this.baseline||Text.DEFAULT_BASELINE;ctx.textAlign=this.align||Text.DEFAULT_ALIGN;ctx.translate(pos[0],pos[1]);if(Brush._hasVal(this.fill)){Brush.shadow(ctx,this.shadow);Brush.fill(ctx,this.fill);ctx.save();this.visitLines(function(line){ctx.fillText(line,0,ascent);ctx.translate(0,ascent)});ctx.restore()}if(Brush._hasVal(this.stroke)){Brush.shadow(ctx,this.shadow);Brush.stroke(ctx,this.stroke);ctx.save();this.visitLines(function(line){ctx.strokeText(line,0,ascent);ctx.translate(0,ascent)});ctx.restore()}if(underlined){var offset=0,stroke=this.fill,me=this;ctx.save();Brush.stroke(ctx,stroke);ctx.lineWidth=1;this.visitLines(function(line){var width=me.dimen(line)[0];ctx.beginPath();ctx.moveTo(0,offset+ascent);ctx.lineTo(width,offset+ascent);ctx.stroke();offset+=ascent});ctx.restore()}ctx.restore()};Text.prototype.dimen=function(lines){if(!Text.__measuring_f)throw new SysErr("no Text buffer, bounds call failed");return Text.__measuring_f(this,lines)};Text.prototype.bounds=function(){var dimen=this.dimen();return[0,0,dimen[0],dimen[1]]};Text.prototype.ascent=function(height){return height};Text.prototype.cstroke=function(color,width,cap,join){this.stroke={width:width!=null?width:0,color:color,cap:cap||Text.DEFAULT_CAP,join:join||Text.DEFAULT_JOIN}};Text.prototype.cfill=function(color){this.fill={color:color}};Text.prototype.visitLines=function(func,data){var lines=this.lines;if(__arr(lines)){var line;for(var i=0,ilen=lines.length;i<ilen;i++){line=lines[i];func(line,data)}}else{func(lines.toString(),data)}};Text.prototype.clone=function(){var c=new Text(this.lines,this.font,this.fill,this.stroke,this.shadow);if(this.lines&&Array.isArray(this.lines)){c.lines=[].concat(this.lines)}if(this.stroke)c.stroke=obj_clone(this.stroke);if(this.fill)c.fill=obj_clone(this.fill);return c};Text.prototype.dispose=function(){};var Brush={};Brush.create=function(ctx,src){if(__str(src))return src;if(!src._style){src._style=Brush._create(ctx,src)}return src._style};Brush._create=function(ctx,brush){if(brush.color)return brush.color;if(brush.lgrad){var src=brush.lgrad,stops=src.stops,dir=src.dir,bounds=src.bounds;var grad=bounds?ctx.createLinearGradient(bounds[0]+dir[0][0]*bounds[2],bounds[1]+dir[0][1]*bounds[3],bounds[0]+dir[1][0]*bounds[2],bounds[1]+dir[1][1]*bounds[3]):ctx.createLinearGradient(dir[0][0],dir[0][1],dir[1][0],dir[1][1]);for(var i=0,slen=stops.length;i<slen;i++){var stop=stops[i];grad.addColorStop(stop[0],stop[1])}return grad}if(brush.rgrad){var src=brush.rgrad,stops=src.stops,dir=src.dir,r=src.r,bounds=src.bounds;var grad=bounds?ctx.createRadialGradient(bounds[0]+dir[0][0]*bounds[2],bounds[1]+dir[0][1]*bounds[3],Math.max(bounds[2],bounds[3])*r[0],bounds[0]+dir[1][0]*bounds[2],bounds[1]+dir[1][1]*bounds[3],Math.max(bounds[2],bounds[3])*r[1]):ctx.createRadialGradient(dir[0][0],dir[0][1],r[0],dir[1][0],dir[1][1],r[1]);for(var i=0,slen=stops.length;i<slen;i++){var stop=stops[i];grad.addColorStop(stop[0],stop[1])}return grad}return null};Brush.stroke=function(ctx,stroke){if(!stroke)return;ctx.lineWidth=stroke.width;ctx.strokeStyle=Brush.create(ctx,stroke);ctx.lineCap=stroke.cap;ctx.lineJoin=stroke.join};Brush.fill=function(ctx,fill){if(!fill)return;ctx.fillStyle=Brush.create(ctx,fill)};Brush.shadow=function(ctx,shadow){if(!shadow||$conf.doNotRenderShadows||ctx.__anm_skipShadows)return;ctx.shadowColor=shadow.color;ctx.shadowBlur=shadow.blurRadius;ctx.shadowOffsetX=shadow.offsetX;ctx.shadowOffsetY=shadow.offsetY};Brush._hasVal=function(fsval){return fsval&&(__str(fsval)||fsval.color||fsval.lgrad||fsval.rgrad)};Sheet.instances=0;Sheet.MISSED_SIDE=50;function Sheet(src,callback,start_region){this.id=Sheet.instances++;this.src=src;this._dimen=[0,0];this.regions=[[0,0,1,1]];this.regions_f=null;this.cur_region=start_region||0;this.ready=false;this.wasError=false;this._image=null;this._cvs_cache=null;this._callback=callback}Sheet.prototype.load=function(callback){var callback=callback||this._callback;if(this._image)throw new Error("Already loaded");var me=this;_ResMan.loadOrGet(me.src,function(notify_success,notify_error){if($conf.doNotLoadImages){notify_error("Loading images is turned off");return}var _img=new Image;_img.onload=_img.onreadystatechange=function(){if(_img.__anm_ready)return;if(this.readyState&&this.readyState!=="complete"){notify_error(this.readyState)}_img.__anm_ready=true;_img.isReady=true;notify_success(_img)};_img.onerror=notify_error;_img.addEventListener("error",notify_error,false);try{_img.src=me.src}catch(e){notify_error(e)}},function(image){me._image=image;me._dimen=[image.width,image.height];me.ready=true;me._drawToCache();if(callback)callback.call(me,image)},function(err){$log.error(err.message||err);me.ready=true;me.wasError=true})};Sheet.prototype._drawToCache=function(){if(!this.ready||this.wasError)return;if(this._image.__cvs){this._cvs_cache=this._image.__cvs;return}var _canvas=$engine.createCanvas(this._dimen[0],this._dimen[1],null,1);var _ctx=$engine.getContext(_canvas,"2d");_ctx.drawImage(this._image,0,0,this._dimen[0],this._dimen[1]);this._image.__cvs=_canvas;this._cvs_cache=_canvas};Sheet.prototype.apply=function(ctx){if(!this.ready)return;if(this.wasError){this.applyMissed(ctx);return}if(this.cur_region<0)return;var region;if(this.region_f){region=this.region_f(this.cur_region)}else{var r=this.regions[this.cur_region],d=this._dimen;region=[r[0]*d[0],r[1]*d[1],r[2]*d[0],r[3]*d[1]]}this._active_region=region;ctx.drawImage(this._cvs_cache,region[0],region[1],region[2],region[3],0,0,region[2],region[3])};Sheet.prototype.applyMissed=function(ctx){ctx.save();ctx.strokeStyle="#900";ctx.lineWidth=1;ctx.beginPath();var side=Sheet.MISSED_SIDE;ctx.moveTo(0,0);ctx.lineTo(side,0);ctx.lineTo(0,side);ctx.lineTo(side,side);ctx.lineTo(0,0);ctx.lineTo(0,side);ctx.lineTo(side,0);ctx.lineTo(side,side);ctx.stroke();ctx.restore()};Sheet.prototype.dimen=function(){if(this.wasError)return[Sheet.MISSED_SIDE,Sheet.MISSED_SIDE];return this._dimen};Sheet.prototype.bounds=function(){if(this.wasError)return[0,0,Sheet.MISSED_SIDE,Sheet.MISSED_SIDE];if(!this.ready||!this._active_region)return[0,0,0,0];var r=this._active_region;return[0,0,r[2],r[3]]};Sheet.prototype.rect=function(){throw new Error("Not Implemented. Why?")};Sheet.prototype.clone=function(){return new Sheet(this.src)};Sheet.prototype.dispose=function(){this._cvs_cache=null};var _Image=Sheet;function Controls(player){this.player=player;this.canvas=null;this.ctx=null;this.ready=false;this.bounds=[];this.hidden=false;this.focused=false;this.elapsed=false;this.theme=null;this.info=null;this._time=-1e3;this._lhappens=C.NOTHING;this._initHandlers();this._inParent=player.inParent}Controls.DEFAULT_THEME={font:{face:"Arial, sans-serif",weight:"bold",timesize:13.5,statussize:8.5,infosize_a:12,infosize_b:10},radius:{inner:.25,outer:.28,buttonv:.15,buttonh:.14,time:.5,status:.8,substatus:.9},width:{inner:5,outer:3,button:7},statuslimit:40,join:{button:"round"},colors:{bggrad:[[.2,"rgba(124,124,124,.35)"],[.3,"rgba(0,0,0,0)"]],progress:{passed:"rgba(241,91,42,1.0)",left:"rgba(255,255,255,1)"},button:"rgba(50,158,192,1)",stroke:"rgba(50,158,192,.85)",fill:"rgba(255,255,255,1)",hoverfill:"rgba(255,255,255,1)",disabledfill:"rgba(124,30,30,0)",text:"rgba(90,90,90,.8)",error:"rgba(250,0,0,.8)",infobg:"rgba(128,0,0,.8)",secondary:"rgba(255,255,255,.6)"},anmguy:{colors:["rgba(65,61,62,1)","rgba(241,91,42,1)"],center_pos:[.5,.8],corner_pos:[.825,.9692],copy_pos:[.917,.98],center_alpha:1,corner_alpha:.3,center_scale:.07,corner_scale:.04}};Controls.THEME=Controls.DEFAULT_THEME;Controls.LAST_ID=0;provideEvents(Controls,[C.X_DRAW]);Controls.prototype.update=function(parent){var cvs=this.canvas,pconf=$engine.getCanvasSize(parent);var _w=pconf[0],_h=pconf[1];if(!cvs){cvs=$engine.addChildCanvas("ctrls-"+Controls.LAST_ID,parent,[0,0,_w,_h],{_class:"anm-controls",position:"absolute",zIndex:100,cursor:"pointer",backgroundColor:"rgba(0, 0, 0, 0)"},this._inParent);Controls.LAST_ID++;this.id=cvs.id;this.canvas=cvs;this.ctx=$engine.getContext(cvs,"2d");this.subscribeEvents(cvs,parent);this.hide();this.changeTheme(Controls.THEME)}else{$engine.setCanvasSize(cvs,_w,_h);$engine.moveElementTo(cvs,$engine.findElementPosition(parent))}this.handleAreaChange();if(this.info)this.info.update(parent)};Controls.prototype.subscribeEvents=function(canvas,parent){$engine.subscribeWindowEvents({scroll:function(controls){return function(evt){controls.handleAreaChange();controls.forceNextRedraw();controls.handleMouseMove(controls._last_mevt)}}(this),mousemove:function(controls){return function(evt){controls.handleMouseMove(evt)}}(this)});$engine.subscribeCanvasEvents(parent,{mouseover:function(controls){return function(evt){controls.handleMouseOver()}}(this),click:function(controls){return function(evt){controls.handlePlayerClick()}}(this)});$engine.subscribeCanvasEvents(canvas,{mousemove:function(controls){return function(evt){controls.handleMouseMove(evt)}}(this),mouseover:function(controls){return function(evt){controls.handleMouseOver()}}(this),mouseout:function(controls){return function(evt){controls.handleMouseOut()}}(this),mousedown:function(controls){return function(evt){controls.handleClick()}}(this)})};Controls.prototype.render=function(time){if(this.hidden&&!this.__force)return;var player=this.player,state=player.state,_s=state.happens;var time=time>0?time:0;if(!this.__force&&time===this._time&&_s===this._lhappens)return;this.rendering=true;if((this._lhappens===C.LOADING||this._lhappens===C.RES_LOADING)&&(_s!==C.LOADING&&_s!==C.RES_LOADING)){Controls._stopLoadingAnimation(this.ctx)}this._time=time;this._lhappens=_s;var ctx=this.ctx,theme=this.theme,duration=state.duration,progress=time/(duration!==0?duration:1);var _w=this.bounds[2],_h=this.bounds[3],ratio=$engine.PX_RATIO;ctx.save();ctx.setTransform(1,0,0,1,0,0);if(ratio!=1)ctx.scale(ratio,ratio);ctx.clearRect(0,0,_w,_h);if(_s===C.PLAYING){}else if(_s===C.STOPPED){Controls._drawBack(ctx,theme,_w,_h);Controls._drawPlay(ctx,theme,_w,_h,this.focused)}else if(_s===C.PAUSED){Controls._drawBack(ctx,theme,_w,_h);Controls._drawProgress(ctx,theme,_w,_h,progress);Controls._drawPlay(ctx,theme,_w,_h,this.focused);if(duration){Controls._drawTime(ctx,theme,_w,_h,time,duration)}}else if(_s===C.NOTHING){Controls._drawNoScene(ctx,theme,_w,_h,this.focused)}else if(_s===C.LOADING||_s===C.RES_LOADING){Controls._runLoadingAnimation(ctx,function(ctx){ctx.clearRect(0,0,_w,_h);Controls._drawLoading(ctx,theme,_w,_h,Date.now()/100%60/60,"")})}else if(_s===C.ERROR){Controls._drawBack(ctx,theme,_w,_h);Controls._drawError(ctx,theme,_w,_h,player.__lastError,this.focused)}ctx.restore();this.fire(C.X_DRAW,state);this.__force=false;if(this.info){if(_s!==C.NOTHING){this._infoShown=true;this.info.render()}else{this._infoShown=false}}this.rendering=false};Controls.prototype.react=function(time){if(this.hidden)return;var _p=this.player,_s=_p.state.happens;if(_s===C.NOTHING||_s===C.LOADING||_s===C.ERROR)return;if(_s===C.STOPPED){_p.play(0);return}if(_s===C.PAUSED){_p.play(this._time);return}if(_s===C.PLAYING){this._time=time;_p.pause();return}};Controls.prototype.refreshByMousePos=function(pos){var state=this.player.state,_lx=pos[0],_ly=pos[1],_w=this.bounds[2],_h=this.bounds[3],button_rad=Math.min(_w/2,_h/2)*this.theme.radius.inner;var lfocused=this.focused;this.focused=_lx>=_w/2-button_rad&&_lx<=_w/2+button_rad&&_ly>=_h/2-button_rad&&_ly<=_h/2+button_rad;if(lfocused!==this.focused){this.forceNextRedraw()}this.render(state.time)};Controls.prototype.handleAreaChange=function(){this.bounds=$engine.getCanvasBounds(this.canvas)};Controls.prototype.handleMouseMove=function(evt){if(!evt)return;if(this.player.mode===C.M_DYNAMIC||this.player.handleEvents)return;this._last_mevt=evt;var pos=$engine.getEventPos(evt,this.canvas);if(this.localInBounds(pos)&&this.player.state.happens!==C.PLAYING){this.show();this.refreshByMousePos(pos)}else{this.handleMouseOut()}};Controls.prototype.handleClick=function(){if(this.player.mode===C.M_DYNAMIC)return;var state=this.player.state;this.forceNextRedraw();this.react(state.time);this.render(state.time);if(state.happens===C.PLAYING)this.hide()};Controls.prototype.handlePlayerClick=function(){if(this.player.mode===C.M_DYNAMIC)return;var state=this.player.state;if(state.happens===C.PLAYING){this.show();this.forceNextRedraw();this.react(state.time);this.render(state.time)}};Controls.prototype.handleMouseOver=function(){if(this.player.mode===C.M_DYNAMIC)return;var state=this.player.state;if(state.happens!==C.PLAYING){if(this.hidden)this.show();this.forceNextRedraw();this.render(state.time)}};Controls.prototype.handleMouseOut=function(){if(this.player.mode===C.M_DYNAMIC)return;var state=this.player.state;if(state.happens===C.NOTHING||state.happens===C.LOADING||state.happens===C.RES_LOADING||state.happens===C.ERROR){this.forceNextRedraw();this.render(state.time)}else{this.hide()}};Controls.prototype.forceRefresh=function(){this.forceNextRedraw();this.render(this.player.state.time)};Controls.prototype.hide=function(){this.hidden=true;this.canvas.style.visibility="hidden";if(this.info)this.info.hide()};Controls.prototype.show=function(){this.hidden=false;this.canvas.style.visibility="visible";if(this.info&&this._infoShown)this.info.show()};Controls.prototype.reset=function(){this._time=-1e3;this.elapsed=false;if(this.info)this.info.reset()};Controls.prototype.detach=function(parent){$engine.detachElement(this._inParent?parent:null,this.canvas);if(this.info)this.info.detach(parent);if(this.ctx&&this.ctx.__anm_loadingReq)delete this.ctx.__anm_loadingReq;if(this.ctx)delete this.ctx.__anm_supressLoading};Controls.prototype.inBounds=function(pos){var _b=this.bounds;return pos[0]>=_b[0]&&pos[0]<=_b[0]+_b[2]&&pos[1]>=_b[1]&&pos[1]<=_b[1]+_b[3]};Controls.prototype.localInBounds=function(pos){var _b=this.bounds;return pos[0]>=0&&pos[0]<=_b[2]&&pos[1]>=0&&pos[1]<=_b[3]};Controls.prototype.changeTheme=function(to){this.theme=to};Controls.prototype.forceNextRedraw=function(){this.__force=true};Controls.prototype._scheduleLoading=function(){if(this._loadingInterval)return;var controls=this;this._loadingInterval=setInterval(function(){controls.forceNextRedraw();controls.render()},50)};Controls.prototype._stopLoading=function(){if(!this._loadingInterval)return;clearInterval(this._loadingInterval);this._loadingInterval=0;this.forceNextRedraw();this.render(this.player.state.time)};Controls.prototype.enable=function(){var player=this.player,state=player.state;this.update(this.player.canvas);if(state.happens===C.NOTHING||state.happens===C.LOADING||state.happens===C.RES_LOADING||state.happens===C.ERROR){this.show();this.forceNextRedraw();this.render()}};Controls.prototype.disable=function(){this.hide();this.detach(this.player.canvas.parentNode)};Controls.prototype.enableInfo=function(){if(!this.info)this.info=new InfoBlock(this.player);this.info.update(this.player.canvas)};Controls.prototype.disableInfo=function(){if(this.info)this.info.detach(this.player.canvas.parentNode);this.info=null};Controls.prototype.setDuration=function(value){if(this.info)this.info.setDuration(value)};Controls.prototype.inject=function(meta,anim){if(this.info)this.info.inject(meta,anim)};Controls._drawBack=function(ctx,theme,w,h){ctx.save();var cx=w/2,cy=h/2;var grd=ctx.createRadialGradient(cx,cy,0,cx,cy,Math.max(cx,cy)*1.2);var stops=theme.colors.bggrad;for(var i=0,il=stops.length;i<il;i++){grd.addColorStop(stops[i][0],stops[i][1])}ctx.fillStyle=grd;ctx.fillRect(0,0,w,h);ctx.restore()};Controls._drawProgress=function(ctx,theme,w,h,progress){ctx.save();var cx=w/2,cy=h/2,progress_rad=Math.min(cx,cy)*theme.radius.outer;ctx.beginPath();ctx.arc(cx,cy,progress_rad,1.5*Math.PI,1.5*Math.PI+2*Math.PI*progress);ctx.strokeStyle=theme.colors.progress.passed;ctx.lineWidth=theme.width.outer;ctx.stroke();ctx.beginPath();ctx.arc(cx,cy,progress_rad,1.5*Math.PI,1.5*Math.PI+2*Math.PI*progress,true);ctx.strokeStyle=theme.colors.progress.left;ctx.lineWidth=theme.width.outer;ctx.stroke();ctx.restore()};Controls._drawPause=function(ctx,theme,w,h,focused){ctx.save();var cx=w/2,cy=h/2,inner_rad=Math.min(cx,cy)*theme.radius.inner,button_width=Math.min(cx,cy)*theme.radius.buttonh,button_height=Math.min(cx,cy)*theme.radius.buttonv;ctx.beginPath();ctx.arc(cx,cy,inner_rad,0,2*Math.PI);ctx.fillStyle=focused?theme.colors.hoverfill:theme.colors.fill;ctx.strokeStyle=theme.colors.stroke;ctx.lineWidth=theme.width.inner;ctx.stroke();ctx.fill();var x=cx-button_width/2,y=cy-button_height/2,bar_width=1/4,between=2/4;ctx.lineWidth=theme.width.button;ctx.lineJoin=theme.join.button;ctx.fillStyle=theme.colors.button;ctx.strokeStyle=theme.colors.button;ctx.strokeRect(x,y,bar_width*button_width,button_height);ctx.strokeRect(x+(bar_width+between)*button_width,y,bar_width*button_width,button_height);ctx.fillRect(x,y,bar_width*button_width,button_height);ctx.fillRect(x+(bar_width+between)*button_width,y,bar_width*button_width,button_height);ctx.restore();Controls._drawGuyInCorner(ctx,theme,w,h)};Controls._drawPlay=function(ctx,theme,w,h,focused){ctx.save();var cx=w/2,cy=h/2,inner_rad=Math.min(cx,cy)*theme.radius.inner,button_width=Math.min(cx,cy)*theme.radius.buttonh*.8,button_height=Math.min(cx,cy)*theme.radius.buttonv;ctx.beginPath();ctx.arc(cx,cy,inner_rad,0,2*Math.PI);ctx.fillStyle=focused?theme.colors.hoverfill:theme.colors.fill;ctx.strokeStyle=theme.colors.stroke;ctx.lineWidth=theme.width.inner;ctx.stroke();ctx.fill();ctx.translate(button_width/((button_width>button_height?button_width/button_height:button_height/button_width)*4),0);ctx.beginPath();ctx.moveTo(cx-button_width/2,cy-button_height/2);ctx.lineTo(cx+button_width/2,cy);ctx.lineTo(cx-button_width/2,cy+button_height/2);
ctx.closePath();ctx.lineWidth=theme.width.button;ctx.lineJoin=theme.join.button;ctx.fillStyle=theme.colors.button;ctx.strokeStyle=theme.colors.button;ctx.stroke();ctx.fill();ctx.restore();Controls._drawGuyInCorner(ctx,theme,w,h)};Controls._drawLoading=function(ctx,theme,w,h,hilite_pos,src){Controls._drawLoadingCircles(ctx,w,h,hilite_pos,theme.radius.outer,theme.colors.stroke,theme.colors.text);if(src){Controls._drawText(ctx,theme,w/2,h/2*(1+theme.radius.status),theme.font.statussize,ell_text(src,theme.statuslimit))}else if(hilite_pos==-1){Controls._drawText(ctx,theme,w/2,h/2*(1+theme.radius.status),theme.font.statussize,"...")}Controls._drawText(ctx,theme,w/2,h/2*(1+theme.radius.substatus),theme.font.statussize,Strings.COPYRIGHT);Controls._drawGuyInCenter(ctx,theme,w,h)};Controls._drawLoadingCircles=function(ctx,w,h,hilite_pos,radius,normal_color,hilite_color){ctx.save();var cx=w/2,cy=h/2,circles=15,outer_rad=Math.min(cx,cy)*radius,circle_rad=Math.min(cx,cy)/25,two_pi=2*Math.PI,hilite_idx=Math.ceil(circles*hilite_pos);ctx.translate(cx,cy);for(var i=0;i<=circles;i++){ctx.beginPath();ctx.arc(0,outer_rad,circle_rad,0,two_pi);ctx.fillStyle=i!=hilite_idx?normal_color:hilite_color;ctx.fill();ctx.rotate(two_pi/circles)}ctx.restore()};Controls._drawNoScene=function(ctx,theme,w,h,focused){ctx.save();var cx=w/2,cy=h/2,inner_rad=Math.min(cx,cy)*theme.radius.inner,button_width=Math.min(cx,cy)*theme.radius.buttonh,button_height=Math.min(cx,cy)*theme.radius.buttonv;ctx.beginPath();ctx.arc(cx,cy,inner_rad,0,2*Math.PI);ctx.fillStyle=focused?theme.colors.disabledfill:theme.colors.fill;ctx.strokeStyle=theme.colors.stroke;ctx.lineWidth=theme.width.inner;ctx.stroke();ctx.fill();ctx.translate(cx,cy);ctx.lineWidth=theme.width.button;ctx.lineJoin=theme.join.button;ctx.fillStyle=theme.colors.button;ctx.strokeStyle=theme.colors.button;ctx.rotate(-Math.PI/4);ctx.strokeRect(-(button_width/2),-(button_height/8),button_width,button_height/4);ctx.fillRect(-(button_width/2),-(button_height/8),button_width,button_height/4);ctx.rotate(2*Math.PI/4);ctx.strokeRect(-(button_width/2),-(button_height/8),button_width,button_height/4);ctx.fillRect(-(button_width/2),-(button_height/8),button_width,button_height/4);ctx.restore();Controls._drawText(ctx,theme,w/2,h/2*(1+theme.radius.status),theme.font.statussize,Strings.COPYRIGHT);Controls._drawGuyInCenter(ctx,theme,w,h)};Controls._drawError=function(ctx,theme,w,h,error,focused){ctx.save();var cx=w/2,cy=h/2,inner_rad=Math.min(cx,cy)*theme.radius.inner,button_width=Math.min(cx,cy)*theme.radius.buttonh,button_height=Math.min(cx,cy)*theme.radius.buttonv;ctx.beginPath();ctx.arc(cx,cy,inner_rad,0,2*Math.PI);ctx.fillStyle=focused?theme.colors.disabledfill:theme.colors.fill;ctx.strokeStyle=theme.colors.stroke;ctx.lineWidth=theme.width.inner;ctx.stroke();ctx.fill();ctx.translate(cx,cy);ctx.lineWidth=theme.width.button;ctx.lineJoin=theme.join.button;ctx.fillStyle=theme.colors.error;ctx.strokeStyle=theme.colors.error;ctx.rotate(-Math.PI/4);ctx.strokeRect(-(button_width/2),-(button_height/8),button_width,button_height/4);ctx.fillRect(-(button_width/2),-(button_height/8),button_width,button_height/4);ctx.rotate(2*Math.PI/4);ctx.strokeRect(-(button_width/2),-(button_height/8),button_width,button_height/4);ctx.fillRect(-(button_width/2),-(button_height/8),button_width,button_height/4);ctx.restore();Controls._drawText(ctx,theme,w/2,h/2*(1+theme.radius.status),theme.font.statussize*1.2,error&&error.message?ell_text(error.message,theme.statuslimit):error,theme.colors.error);Controls._drawText(ctx,theme,w/2,h/2*(1+theme.radius.substatus),theme.font.statussize,Strings.COPYRIGHT);Controls._drawGuyInCenter(ctx,theme,w,h,[theme.colors.button,theme.colors.error])};Controls._drawTime=function(ctx,theme,w,h,time,duration){Controls._drawText(ctx,theme,w/2,h/2*(1+theme.radius.time),theme.font.timesize,fmt_time(time)+" / "+fmt_time(duration))};Controls._drawText=function(ctx,theme,x,y,size,text,color,align){ctx.save();ctx.font=theme.font.weight+" "+Math.floor(size||15)+"pt "+theme.font.face;ctx.textAlign=align||"center";ctx.textBaseline="middle";ctx.fillStyle=color||theme.colors.text;ctx.fillText(text,x,y);ctx.restore()};Controls._drawGuyInCorner=function(ctx,theme,w,h,colors,pos,scale){};Controls._drawGuyInCenter=function(ctx,theme,w,h,colors,pos,scale){drawAnimatronGuy(ctx,(pos?pos[0]:theme.anmguy.center_pos[0])*w,(pos?pos[1]:theme.anmguy.center_pos[1])*h,(scale||theme.anmguy.center_scale)*Math.min(w,h),colors||theme.anmguy.colors,theme.anmguy.center_alpha)};Controls._runLoadingAnimation=function(ctx,paint){if(ctx.__anm_loadingReq)return;var ratio=$engine.PX_RATIO;ctx.__anm_supressLoading=false;function loading_loop(){if(ctx.__anm_supressLoading)return;ctx.save();ctx.setTransform(1,0,0,1,0,0);if(ratio!=1)ctx.scale(ratio,ratio);paint(ctx);ctx.restore();return __nextFrame(loading_loop)}ctx.__anm_loadingReq=__nextFrame(loading_loop)};Controls._stopLoadingAnimation=function(ctx,paint){if(!ctx.__anm_loadingReq)return;ctx.__anm_supressLoading=true;__stopAnim(ctx.__anm_loadingReq);ctx.__anm_loadingReq=null};function InfoBlock(player){this.canvas=null;this.ctx=null;this.ready=false;this.hidden=false;this._inParent=player.inParent;this.attached=false}InfoBlock.BASE_BGCOLOR=Controls.THEME.colors.infobg;InfoBlock.BASE_FGCOLOR=Controls.THEME.colors.text;InfoBlock.OPACITY=1;InfoBlock.PADDING=6;InfoBlock.MARGIN=5;InfoBlock.FONT=Controls.THEME.font.face;InfoBlock.FONT_SIZE_A=Controls.THEME.font.infosize_a;InfoBlock.FONT_SIZE_B=Controls.THEME.font.infosize_b;InfoBlock.DEFAULT_WIDTH=0;InfoBlock.DEFAULT_HEIGHT=60;InfoBlock.LAST_ID=0;InfoBlock.prototype.detach=function(parent){if(!this.attached)return;$engine.detachElement(this._inParent?parent:null,this.canvas);this.attached=false};InfoBlock.prototype.update=function(parent){var cvs=this.canvas,pconf=$engine.getCanvasSize(parent),_m=InfoBlock.MARGIN,_w=InfoBlock.DEFAULT_WIDTH,_h=InfoBlock.DEFAULT_HEIGHT;if(!cvs){cvs=$engine.addChildCanvas("info-"+InfoBlock.LAST_ID,parent,[_m,_m,_w,_h],{_class:"anm-info ",position:"absolute",opacity:InfoBlock.OPACITY,zIndex:110,cursor:"pointer",backgroundColor:"rgba(0, 0, 0, 0)"},this._inParent);InfoBlock.LAST_ID++;this.id=cvs.id;this.canvas=cvs;this.attached=true;this.ctx=$engine.getContext(cvs,"2d");this.hide();this.changeTheme(InfoBlock.BASE_FGCOLOR,InfoBlock.BASE_BGCOLOR)}else{var parent_pos=$engine.findElementPosition(parent);$engine.setCanvasSize(cvs,_w,_h);$engine.moveElementTo(cvs,[parent_pos[0]+_m,parent_pos[1]+_m])}this.bounds=$engine.getCanvasBounds(cvs)};InfoBlock.prototype.render=function(){if(!this.__data)return;var meta=this.__data[0],anim=this.__data[1],duration=this.__data[2]||meta.duration;var ratio=$engine.PX_RATIO;var _tl=new Text(meta.title||"[No title]","bold "+Math.floor(InfoBlock.FONT_SIZE_A)+"px "+InfoBlock.FONT,{color:this.__fgcolor}),_bl=new Text((meta.author||"[Unknown]")+" "+(duration?duration+"s":"?s")+" "+(anim.width||0)+"x"+(anim.height||0),Math.floor(InfoBlock.FONT_SIZE_B)+"px "+InfoBlock.FONT,{color:this.__fgcolor}),_p=InfoBlock.PADDING,_td=_tl.dimen(),_bd=_bl.dimen(),_nw=Math.max(_td[0],_bd[0])+_p+_p,_nh=_td[1]+_bd[1]+_p*3,ctx=this.ctx;$engine.setCanvasSize(this.canvas,_nw,_nh);ctx.save();if(ratio!=1)ctx.scale(ratio,ratio);ctx.clearRect(0,0,_nw,_nh);ctx.fillStyle=this.__bgcolor;ctx.fill();ctx.fillStyle=this.__fgcolor;ctx.translate(_p,_p);_tl.apply(ctx);ctx.globalAlpha=.8;ctx.translate(0,_bd[1]+_p);_bl.apply(ctx);ctx.restore()};InfoBlock.prototype.inject=function(meta,anim,duration){this.__data=[meta,anim,duration||meta.duration];if(this.ready)this.render()};InfoBlock.prototype.reset=function(){};InfoBlock.prototype.hide=function(){this.hidden=true;this.canvas.style.visibility="hidden"};InfoBlock.prototype.show=function(){this.hidden=false;this.canvas.style.visibility="visible"};InfoBlock.prototype.setDuration=function(value){if(this.__data)this.inject(this.__data[0],this.__data[1],value)};InfoBlock.prototype.changeTheme=function(front,back){this.__fgcolor=front;this.__bgcolor=back};var _anmGuySpec=[[180,278],[235,290],["rgba(35,31,32,1.0)","rgba(241,91,42,1.0)"],[[0,"M206.367 561.864 L210.181 558.724 C228.037 544.497 253.515 532.989 280.474 527.013 C310.171 520.432 331.881 522.276 352.215 531.595 L357.041 534.028 C357.35 534.198 357.661 534.362 357.965 534.536 C358.084 534.603 358.207 534.646 358.333 534.68 L358.358 534.693 C358.38 534.698 358.404 534.697 358.427 534.701 C358.499 534.716 358.572 534.723 358.644 534.726 C358.665 534.727 358.687 534.734 358.708 534.734 C358.718 534.734 358.727 534.729 358.736 534.729 C358.901 534.725 359.061 534.695 359.214 534.639 C359.235 534.631 359.255 534.624 359.275 534.617 C359.427 534.555 359.568 534.468 359.694 534.357 C359.703 534.35 359.713 534.347 359.72 534.34 C359.734 534.327 359.742 534.312 359.755 534.299 C359.812 534.242 359.864 534.182 359.911 534.115 C359.934 534.084 359.958 534.054 359.977 534.022 C359.987 534.005 360.0 533.993 360.01 533.976 C360.042 533.919 360.063 533.859 360.088 533.8 C360.099 533.773 360.113 533.747 360.123 533.719 C360.16 533.612 360.185 533.502 360.197 533.393 C360.199 533.372 360.197 533.352 360.197 533.331 C360.204 533.239 360.202 533.147 360.191 533.057 C360.189 533.042 360.192 533.029 360.19 533.014 C357.081 511.941 353.944 495.52 351.031 482.785 C357.244 479.02 363.189 474.743 368.789 469.964 C393.406 448.956 409.766 419.693 414.851 387.568 C414.984 386.729 414.572 385.898 413.824 385.495 C413.078 385.094 412.154 385.206 411.528 385.778 C411.211 386.068 379.366 414.738 343.77 414.738 C342.291 414.738 340.805 414.687 339.353 414.59 C337.351 414.454 335.324 414.175 333.283 413.779 C331.964 409.499 330.461 404.804 328.77 399.802 C359.392 384.303 365.286 347.489 365.523 345.916 L365.673 344.918 L364.958 344.204 C343.833 323.079 316.491 319.925 302.074 319.925 C297.818 319.925 294.309 320.184 292.346 320.397 C292.057 319.943 291.367 318.531 291.075 318.082 L291.075 318.082 L289.93 318.134 C288.782 318.186 262.998 319.502 240.402 333.108 C240.257 332.844 240.11 332.58 239.97 332.321 C239.519 331.483 238.543 331.077 237.63 331.355 C237.138 331.503 188.319 346.777 182.558 392.748 C179.346 418.379 183.819 442.529 195.154 460.749 C198.743 466.519 202.966 471.691 207.797 476.277 C205.628 493.159 199.308 523.779 199.131 560.445 C199.131 560.448 199.131 560.449 199.131 560.449 C199.103 560.84 199.374 561.582 199.61 561.929 C200.857 563.749 203.878 563.485 206.367 561.864 L206.367 561.864 M329.861 356.921 C337.152 356.921 343.681 355.511 347.423 354.501 C343.397 371.078 329.711 383.191 323.809 387.651 C319.732 376.532 315.353 363.711 309.755 351.798 C315.197 355.032 321.929 356.921 329.861 356.921 L329.861 356.921 M274.473 524.377 C255.607 528.559 237.545 535.219 222.207 543.738 C226.13 536.158 235.429 517.686 244.087 496.592 C250.783 498.607 257.965 500.123 265.665 501.096 C271.15 501.789 276.723 502.14 282.228 502.14 C295.39 502.14 308.416 500.139 320.898 496.304 C330.401 510.462 338.24 520.043 342.222 524.674 C323.029 518.972 299.648 518.8 274.473 524.377 L274.473 524.377 M206.367 561.864 Z"]],["M228.106 361.104 L235.292 339.707 C220.431 347.023 207.762 353.681 193.499 382.89 L193.371 383.129 C193.335 383.196 193.081 398.216 215.426 411.593 L217.722 398.247 C213.866 395.442 209.922 392.815 203.684 382.392 L203.684 382.392 L206.09 382.041 C206.795 381.993 223.527 380.653 227.963 361.515 L228.106 361.104 L228.106 361.104 M228.106 361.104 Z","M335.139 434.771 C330.899 418.584 314.627 362.091 288.434 321.155 C282.932 321.595 258.458 326.742 239.48 337.752 C237.387 342.508 222.985 385.396 214.605 457.106 C223.094 451.426 246.173 437.705 278.306 432.083 C289.482 430.127 298.912 429.177 307.136 429.177 C318.52 429.176 327.736 431.012 335.139 434.771 L335.139 434.771 M335.139 434.771 Z","M261.669 283.483 C261.122 283.608 260.536 283.529 259.968 283.62 C259.175 283.855 244.69 288.784 240.497 330.304 L252.545 325.896 C252.958 325.746 253.41 325.735 253.829 325.865 C254.189 325.977 262.588 328.605 265.889 329.881 C265.942 329.886 266.001 329.886 266.067 329.886 C268.22 329.886 273.176 328.592 274.266 327.977 C274.929 327.028 277.335 323.153 279.406 319.753 C279.715 319.246 280.233 318.902 280.82 318.815 L287.047 317.888 C283.65 306.582 275.276 280.377 261.669 283.483 L261.669 283.483 M261.669 283.483 Z"],[[0,"M258.16 316.686 L260.482 319.943 C260.531 319.909 265.533 316.427 272.469 316.574 L272.549 312.574 C264.239 312.415 258.404 316.512 258.16 316.686 L258.16 316.686 M258.16 316.686 Z"],[0,"M291.524 319.015 C290.269 315.412 275.55 278.38 261.669 279.484 C260.863 279.548 259.839 279.603 258.948 279.754 C258.183 279.914 240.364 284.186 236.22 333.101 C236.162 333.782 236.456 334.445 236.999 334.86 C237.353 335.13 237.78 335.27 238.213 335.27 C238.444 335.27 238.677 335.23 238.9 335.148 L253.28 329.887 C255.368 330.545 261.949 332.636 264.544 333.651 C264.954 333.811 265.438 333.886 266.065 333.886 C266.065 333.886 266.065 333.886 266.065 333.886 C268.166 333.886 275.679 332.241 277.179 330.305 C277.858 329.427 281.074 323.856 282.394 321.697 L289.246 321.084 C289.809 321.0 290.95 321.105 291.263 320.63 C291.575 320.151 291.711 319.553 291.524 319.015 L291.524 319.015 M280.818 318.813 C280.231 318.901 279.713 319.245 279.404 319.751 C277.333 323.15 274.927 327.025 274.264 327.975 C273.174 328.59 268.218 329.884 266.065 329.884 C265.999 329.884 265.94 329.884 265.887 329.879 C262.586 328.604 254.187 325.976 253.827 325.863 C253.408 325.733 252.956 325.744 252.543 325.894 L240.495 330.302 C241.15 323.815 242.058 318.233 243.124 313.412 C246.317 310.925 256.071 305.486 274.186 302.326 L272.507 297.31 C256.366 300.166 248.436 303.975 245.019 306.105 C246.927 299.814 249.104 295.257 251.197 291.967 C253.956 288.64 261.686 281.937 265.486 288.565 C266.311 290.004 265.915 293.995 261.883 294.298 C261.883 294.298 271.143 298.247 272.283 289.079 C277.986 295.21 284.709 310.11 287.043 317.884 L280.818 318.813 L280.818 318.813 M291.524 319.015 Z"],[1,"M232.358 389.656 C232.358 389.656 247.035 382.551 257.026 379.59 L272.548 358.341 L289.591 374.478 C289.591 374.478 302.954 372.629 311.024 374.716 C311.024 374.716 291.608 351.323 279.443 344.346 L261.899 346.255 C256.74 352.255 242.601 369.901 232.358 389.656 L232.358 389.656 M232.358 389.656 Z"]]];var anmGuyCanvas,anmGuyCtx;function drawAnimatronGuy(ctx,x,y,size,colors,opacity){var spec=_anmGuySpec,origin=spec[0],dimensions=spec[1],scale=size?size/Math.max(dimensions[0],dimensions[1]):1,colors=colors||spec[2],shapes_before=spec[3];masking_shapes=spec[4],shapes_after=spec[5];var w=dimensions[0]*scale,h=dimensions[1]*scale;if(!anmGuyCanvas){anmGuyCanvas=$engine.createCanvas(w,h);anmGuyCtx=$engine.getContext(anmGuyCanvas,"2d")}else{$engine.setCanvasSize(anmGuyCanvas,w,h)}var maskCanvas=anmGuyCanvas;var maskCtx=anmGuyCtx;maskCtx.save();maskCtx.clearRect(0,0,w,h);if(scale!=1)maskCtx.scale(scale,scale);maskCtx.translate(-origin[0],-origin[1]);maskCtx.save();for(var i=0;i<shapes_before.length;i++){var shape=shapes_before[i],fill=colors[shape[0]],path=new Path(shape[1],fill);path.apply(maskCtx)}maskCtx.save();maskCtx.globalCompositeOperation="destination-out";for(var i=0;i<masking_shapes.length;i++){var shape=masking_shapes[i],path=new Path(shape,"#fff");path.apply(maskCtx)}maskCtx.restore();for(var i=0;i<shapes_after.length;i++){var shape=shapes_after[i],fill=colors[shape[0]],path=new Path(shape[1],fill);path.apply(maskCtx)}maskCtx.restore();maskCtx.restore();ctx.save();if(opacity)ctx.globalAlpha=opacity;ctx.drawImage(maskCanvas,x-w/2,y-h/2);ctx.restore()}return function($trg){function __createPlayer(cvs,opts){var p=new Player;p.init(cvs,opts);return p}$trg.createPlayer=__createPlayer;$trg.findById=function(where,id){var found=[];if(where.name==name)found.push(name);where.travelChildren(function(elm){if(elm.id==id)found.push(elm)});return found};$trg.findByName=function(where,name){var found=[];if(where.name==name)found.push(name);where.travelChildren(function(elm){if(elm.name==name)found.push(elm)});return found};$trg._$=__createPlayer;$trg.Player=Player;$trg.Scene=Scene;$trg.Element=Element;$trg.Clip=Clip;$trg.Path=Path;$trg.Text=Text;$trg.Sheet=Sheet;$trg.Image=_Image;$trg.Tweens=Tweens;$trg.Tween=Tween;$trg.Easing=Easing;$trg.MSeg=MSeg;$trg.LSeg=LSeg;$trg.CSeg=CSeg;$trg.Render=Render;$trg.Bands=Bands;$trg.obj_clone=obj_clone;$trg.__dev={strf:_strf,adjust:__adjust,t_cmp:__t_cmp,TIME_PRECISION:TIME_PRECISION};return Player}(anm)});if(typeof __anm_engine==="undefined")throw new Error("No engine found!");__anm_engine.define("anm/Builder",["anm","anm/Player"],function(anm){var Path=anm.Path;var Element=anm.Element;var Text=anm.Text;var Image=anm.Image;var Sheet=anm.Sheet;var C=anm.C;var MSeg=anm.MSeg,LSeg=anm.LSeg,CSeg=anm.CSeg;var is=anm.is;var modCollisions=anm.isModuleAccessible("collisions");var __b_cache={};function Builder(obj){if(!obj){this.n="";this.v=new Element}else if(obj instanceof Builder){this.n=obj.n;this.v=obj.v.deepClone();this.x=this.v.xdata;this.f=this._extractFill(obj.f);this.s=this._extractStroke(obj.s);this.v.__b$=this;return}else if(obj instanceof Element){this.n=obj.name;this.v=obj}else if(is.str(obj)){this.n=obj;this.v=new Element;this.v.name=this.n}this.x=this.v.xdata;this.bs=this.v.bstate;this.v.__b$=this;this.f=this._extractFill(Builder.DEFAULT_FILL);this.s=this._extractStroke(Builder.DEFAULT_STROKE);this.d=undefined;this.a=undefined}Builder._$=function(obj){if(obj&&obj instanceof Element){if(__b_cache[obj.id])return __b_cache[obj.id];return __b_cache[obj.id]=new Builder(obj)}var inst=new Builder(obj);__b_cache[inst.v.id]=inst;return inst};Builder.__path=function(val,join){return is.arr(val)?Builder.path(val,join):val instanceof Path?val:Path.parse(val,join)};Builder.DEFAULT_STROKE=Path.EMPTY_STROKE;Builder.DEFAULT_FILL=Path.BASE_FILL;Builder.DEFAULT_CAP=Path.DEFAULT_CAP;Builder.DEFAULT_JOIN=Path.DEFAULT_JOIN;Builder.DEFAULT_FFACE=Text.DEFAULT_FFACE;Builder.DEFAULT_FSIZE=Text.DEFAULT_FSIZE;Builder.prototype.build=function(){return this.v};Builder.prototype.add=function(what){if(what instanceof Element){this.v.add(what)}else if(what instanceof Builder){this.v.add(what.v)}return this};Builder.prototype.remove=function(what){if(what instanceof Element){this.v.remove(what)}else if(what instanceof Builder){this.v.remove(what.v)}else throw new Error("Don't know what to remove");return this};Builder.prototype.path=function(pt,path){this.move(pt||[0,0]);var path=Builder.__path(path,this.x.path);this.x.path=path;if(!path.fill){path.fill=this.f}else{this.f=path.fill}if(!path.stroke){path.stroke=this.s}else{this.s=path.stroke}return this};Builder.prototype.npath=function(pt,path){var _npath=Builder.__path(path,this.x.path).clone();_npath.normalize();this.path(pt,_npath);return this};Builder.prototype.rect=function(pt,rect){this.path(pt,Builder.rect(rect));return this};Builder.prototype.oval=function(pt,radius){this.move(pt||[0,0]);var dimen=is.arr(radius)?[radius[0]+radius[0],radius[1]+radius[1]]:[radius+radius,radius+radius],scale=null,d_rad=radius;if(is.arr(radius)){if(dimen[0]<dimen[1]&&dimen[1]>0){scale=[dimen[0]/dimen[1],1];d_rad=radius[1]}else if(dimen[0]>dimen[1]&&dimen[0]>0){scale=[1,dimen[1]/dimen[0]];d_rad=radius[0]}}this.v._dimen=dimen;var pvt=this.pvt(),center=[pvt[0]*dimen[0],pvt[1]*dimen[1]];this.paint(function(ctx){var b=this.$.__b$;Path.applyF(ctx,b.f,b.s,null,function(){if(scale)ctx.scale(scale[0],scale[1]);ctx.arc(center[0],center[1],d_rad,0,Math.PI*2,true)})});if(modCollisions)this.v.reactAs(Builder.arcPath(center[0],center[1],d_rad,0,1,12));return this};Builder.prototype.circle=Builder.prototype.oval;Builder.prototype.image=function(pt,src,callback){this.move(pt||[0,0]);if(src){var b=this;this.x.sheet=new Image(src,callback)}return this};Builder.prototype.text=function(pt,lines,size,font){this.move(pt||[0,0]);var text=lines instanceof Text?lines:Builder.text(lines,size,font);this.x.text=text;if(!text.stroke){text.stroke=this.s}else{this.s=text.stroke}if(!text.fill){text.fill=this.f}else{this.f=text.fill}return this};Builder.prototype.sprite=function(pt,src,tile_spec,callback){this.move(pt||[0,0]);var animator;if(is.str(src)){animator=Builder.sheet(src,tile_spec,callback)(this.v)}else if(is.fun(src)){animator=src(this.v)}else throw new Error("Incorrect source for sprite");this.x.sheet=animator.sheet;this.a=animator;return this};Builder.prototype.switch=function(frames,fps,repeat){if(!this.a)throw new Error("This builder has no animator, so no switch possible");this.a.switch(frames,fps,repeat);return this};Builder.prototype.animate=function(t,frames,fps,repeat){if(!this.a)throw new Error("This builder has no animator, so no animation possible");this.a.animate(t,frames,fps,repeat);return this};Builder.prototype.run=function(t){if(!this.a)throw new Error("This builder has no animator, so no running possible");this.a.run(t);return this};Builder.prototype.fill=function(fval){this.f=is.str(fval)?{color:fval}:fval.r?{rgrad:fval}:{lgrad:fval};if(this.x.path)this.x.path.fill=this.f;if(this.x.text)this.x.text.fill=this.f;return this};Builder.prototype.stroke=function(sval,width,cap,join){this.s=is.str(sval)?{width:width!=null?width:Builder.DEFAULT_STROKE.width,color:sval,cap:cap||Builder.DEFAULT_CAP,join:join||Builder.DEFAULT_JOIN}:sval.r?{rgrad:sval}:{lgrad:sval};if(this.x.path)this.x.path.stroke=this.s;if(this.x.text)this.x.text.stroke=this.s;return this};Builder.prototype.nofill=function(){this.f=null;if(this.x.path)this.x.path.fill=null;if(this.x.text)this.x.text.fill=null;return this};Builder.prototype.nostroke=function(){this.s=null;if(this.x.path)this.x.path.stroke=null;if(this.x.text)this.x.text.stroke=null;return this};C.R_TL=[0,0];C.R_TC=[.5,0];C.R_TR=[1,0];C.R_ML=[0,.5];C.R_MC=[.5,.5];C.R_MR=[1,.5];C.R_BL=[0,1];C.R_BC=[.5,1];C.R_BR=[1,1];Builder.prototype.reg=function(pt){var x=this.x;if(!pt)return x.reg;x.reg=pt||x.reg;return this};Builder.prototype.pvt=function(pt){var x=this.x;if(!pt)return x.pvt;x.pvt=pt;return this};Builder.prototype.pvtpt=function(pt){var x=this.x;if(pt){var dimen=this.v.dimen();x.pvt=[dimen[0]?pt[0]/dimen[0]:0,dimen[1]?pt[1]/dimen[1]:0];return this}else{var pvt=x.pvt;var dimen=this.v.dimen();return[dimen[0]*pvt[0],dimen[1]*pvt[1]]}};Builder.prototype.init=function(state){this.v.bstate=state;this.bs=state;return this};Builder.prototype.move=function(pt){this.bs.x=pt[0];this.bs.y=pt[1];return this};Builder.prototype.pos=function(pt){return pt?this.move(pt):[this.bs.x,this.bs.y]};Builder.prototype.dpos=function(){return this.v.getPosition()};Builder.prototype.apos=function(){var pos=this.dpos(),off=this.offset();return[off[0]+pos[0],off[1]+pos[1]]};Builder.prototype.offset=function(){return this.v.offset()};Builder.prototype.zoom=function(val){if(this.x.path){this.x.path.zoom(val)}else{this.size([val,val])}return this};Builder.prototype.size=function(val){this.bs.sx=val[0];this.bs.sy=val[1];return this};Builder.prototype.resize=Builder.prototype.size;Builder.prototype.proportions=Builder.prototype.size;Builder.prototype.skew=function(val){this.bs.hx=val[0];this.bs.hy=val[1];return this};Builder.prototype.angle=function(val){this.bs.angle=val;return this};Builder.prototype.slope=Builder.prototype.angle;Builder.prototype.turn=Builder.prototype.angle;Builder.prototype.opacity=function(val){this.bs.alpha=val;return this};Builder.prototype.bounds=function(bounds){if(!bounds.length===4)throw new Error("Incorrect bounds");this.x.__bounds=bounds;return this};Builder.prototype.band=function(band){this.v.setBand(band);return this};Builder.prototype.duration=function(value){if(this.v.parent)throw new Error("Please set duration only to the root element");this.d=value;return this};Builder.prototype.tween=function(type,band,data,easing){this.v.addTween({type:type,time:band,data:data,easing:easing});return this};Builder.prototype.rtween=function(type,band,data,easing){this.v.addTween({type:type,time:band,data:data,easing:easing,relative:true});return this};Builder.prototype.untween=Builder.prototype.unmodify;Builder.prototype.rotate=function(band,angles,easing){return this.tween(C.T_ROTATE,band,angles,easing)};Builder.prototype.rotateP=function(band,easing){return this.tween(C.T_ROT_TO_PATH,band,null,easing)};Builder.prototype.scale=function(band,values,easing){return this.tween(C.T_SCALE,band,values,easing)};Builder.prototype.xscale=function(band,values,easing){return this.scale(band,[[values[0],values[0]],[values[1],values[1]]],easing)};Builder.prototype.shear=function(band,values,easing){return this.tween(C.T_SHEAR,band,values,easing)};Builder.prototype.xshear=function(band,values,easing){return this.shear(band,[[values[0],values[0]],[values[1],values[1]]],easing)};Builder.prototype.trans=function(band,points,easing){return this.transP(band,[[points[0][0],points[0][1]],[points[1][0],points[1][1]]],easing)};Builder.prototype.transP=function(band,path,easing){return this.tween(C.T_TRANSLATE,band,Builder.__path(path,this.x.path),easing)};Builder.prototype.alpha=function(band,values,easing){return this.tween(C.T_ALPHA,band,values,easing)};Builder.prototype.mode=function(mode,nrep){this.x.mode=mode;if(typeof nrep!=="undefined")this.x.nrep=nrep;return this};Builder.prototype.once=function(){return this.mode(C.R_ONCE)};Builder.prototype.stay=function(){return this.mode(C.R_STAY)};Builder.prototype.loop=function(val){return this.mode(C.R_LOOP,val)};Builder.prototype.repeat=function(val){return this.mode(C.R_LOOP,val)};Builder.prototype.bounce=function(val){return this.mode(C.R_BOUNCE,val)};Builder.prototype.modify=function(band,modifier,data,easing,priority){if(is.arr(band)||is.num(band)){this.v.addModifier({time:band,easing:easing,data:data,priority:priority},modifier)}else{priority=easing;easing=data;data=modifier;modifier=band;this.v.addModifier({easing:easing,data:data,priority:priority},modifier)}return this};Builder.prototype.rmodify=function(band,modifier,data,easing,priority){if(is.arr(band)||is.num(band)){this.v.addModifier({time:band,easing:easing,data:data,relative:true,priority:priority},modifier)}else{priority=easing;easing=data;data=modifier;modifier=band;this.v.addModifier({easing:easing,data:data,relative:true,priority:priority},modifier)}return this};Builder.prototype.paint=function(func,data,priority){this.v.addPainter(func,data,priority);return this};Builder.prototype.at=function(t,func,data,priority){return this.modify(t,func,data,priority)};Builder.prototype.rat=function(t,func,data,priority){return this.rmodify(t,func,data,priority)};Builder.prototype.unmodify=function(modifier){this.v.removeModifier(modifier);return this};Builder.prototype.unpaint=function(painter){this.v.removePainter(painter);return this};Builder.prototype.key=function(name,value){this.x.keys[name]=value;return this};Builder.prototype.time=function(f){this.x.tf=f;return this};Builder.prototype.tease=function(ease){if(!ease)throw new Error("Ease function not defined");var duration=this.x.duration();this.time(function(t){return ease(t/duration)});return this};Builder.prototype.on=function(type,handler){this.v.m_on(type,handler);return this};Builder.prototype.off=Builder.prototype.unmodify;Builder.prototype.unhandle=Builder.prototype.unmodify;Builder.prototype.onstart=function(handler){this.v.on(C.X_START,handler);return this};Builder.prototype.onbirth=Builder.prototype.onstart;Builder.prototype.onborn=Builder.prototype.onstart;Builder.prototype.onstop=function(handler){this.v.on(C.X_STOP,handler);return this};Builder.prototype.ondeath=Builder.prototype.onstart;Builder.prototype.ondie=Builder.prototype.onstart;Builder.prototype.whenPlayer=function(event,handler){this.v.handlePlayerEvent(event,handler);return this};Builder.prototype.take=function(b){this.n=b.n;this.v=b.v.clone();this.x=this.v.xdata;this.bs=this.v.bstate;return this};Builder.prototype.use=function(b){this.n=b.n;this.v=b.v.deepClone();this.x=this.v.xdata;this.bs=this.v.bstate;return this};Builder.prototype.disable=function(){this.v.disabled=true;this.v.travelChildren(function(elm){elm.disabled=true});return this};Builder.prototype.enable=function(){this.v.disabled=false;this.v.travelChildren(function(elm){elm.disabled=false});return this};Builder.prototype.each=function(func){this.v.visitChildren(func);return this};Builder.prototype.deach=function(func){this.v.travelChildren(func);return this};Builder.prototype.iter=function(func,rfunc){this.v.iterateChildren(func,rfunc);return this};Builder.prototype.diter=function(func,rfunc){this.v.deepIterateChildren(func,rfunc);return this};Builder.prototype.detach=function(){this.v.detach();return this};Builder.prototype.clear=function(){this.v.clear();return this};Builder.prototype.data=function(value){if(typeof value!=="undefined"){this.v.data(value);return this}return this.v.data()};Builder.prototype.acomp=function(value){this.x.acomp=value;return this};Builder.prototype.mask=function(mask){if(mask instanceof Element){this.v.setMask(mask)}else if(mask instanceof Builder){this.v.setMask(mask.v)}return this};Builder.prototype._extractStroke=function(def_){if(this.x.path)return this.x.path.stroke||def_;if(this.x.text)return this.x.text.stroke||def_;return def_};Builder.prototype._extractFill=function(def_){if(this.x.path)return this.x.path.fill||def_;if(this.x.text)return this.x.text.fill||def_;return def_};Builder.rgb=function(r,g,b,a){return"rgba("+Math.floor(r)+","+Math.floor(g)+","+Math.floor(b)+","+(typeof a!=="undefined"?a:1)+")"};Builder.frgb=function(r,g,b,a){return B.rgb(r*255,g*255,b*255,a)};Builder.hsv=function(h,s,v,a){return B.fhsv(h/360,s,v,a)};Builder.fhsv=function(h,s,v,a){var c=v*s;var h1=h*6;var x=c*(1-Math.abs(h1%2-1));var m=v-c;var rgb;if(h1<1)rgb=[c,x,0];else if(h1<2)rgb=[x,c,0];else if(h1<3)rgb=[0,c,x];else if(h1<4)rgb=[0,x,c];else if(h1<5)rgb=[x,0,c];else if(h1<=6)rgb=[c,0,x];return Builder.rgb(255*(rgb[0]+m),255*(rgb[1]+m),255*(rgb[2]+m),a)};Builder.lgrad=function(dir,stops){return{dir:dir,stops:stops}};Builder.rgrad=function(dir,rad,stops){return{dir:dir,r:rad,stops:stops}};Builder.path=function(points,src){var p=new Path;if(src)p.load(src);if(is.str(points)){p.parse(points)}else if(is.arr(points)){p.add(new MSeg([points[0][0],points[0][1]]));var i=1,pl=points.length;for(;i<pl;i++){var pts=points[i];if(pts.length<3){p.add(new LSeg([pts[0],pts[1]]))}else{p.add(new CSeg([pts[0],pts[1],pts[2],pts[3],pts[4],pts[5]]))}}}return p};Builder.rect=function(rect){var rect=is.arr(rect)?rect:[rect,rect];var w=rect[0],h=rect[1];return Builder.path([[0,0],[w,0],[w,h],[0,h],[0,0]])};Builder.text=function(lines,size,font){return new Text(lines,Builder.font(size,font))};Builder.easing=function(func,data){return{f:function(data){return func},data:data}};Builder.easingF=Builder.easing;Builder.easingP=function(path){return{type:C.E_PATH,data:Builder.__path(path)}};Builder.easingC=function(seg){return{type:C.E_CSEG,data:seg instanceof CSeg?seg:new CSeg(seg)}};Builder.tween=function(){};Builder.font=function(size,name){var fface=name||Builder.DEFAULT_FFACE;fface=is.str(fface)?fface:fface.join(",");var fsize=size!=null?size:Builder.DEFAULT_FSIZE;return fsize+"px "+fface};var __t=anm.__dev.adjust;if(!__t)throw new Error("adjust should be defined");function _get_frame(start,t,anim){var frames=anim[0],fps=anim[1],step=frames.length>2?frames[2]:1,repeat=frames.length>3?frames[3]:anim[2]||false,start_frame=frames[0],end_frame=frames[1],dt=__t(t-start);var len=__t(end_frame+1-start_frame);var tframe=Math.floor(dt*fps)*step;if(tframe<0)return-1;if(!repeat&&tframe>=len)return-1;if(repeat){tframe=tframe%len}return Math.floor(start_frame+tframe)}function _Animator(sheet,elm){this.sheet=sheet;this.elm=elm;this.cur_anim=null;var me=this;this.elm.addModifier(function(t){if(!me.cur_anim)return false;var frame=_get_frame(me.start,t,me.cur_anim);if(frame>=0){sheet.cur_region=frame}else{sheet.cur_region=-1;me.cur_anim=null;return false}})}_Animator.prototype.switch=function(frames,fps,repeat){this._prepared_anim=[frames,fps,repeat]};_Animator.prototype.run=function(t){this.start=t;this.cur_anim=this._prepared_anim
};_Animator.prototype.animate=function(t,frames,fps,repeat){this.switch(frames,fps,repeat);this.run(t)};Builder.sheet=function(src,tile_spec,callback){var sheet=new Sheet(src,function(img){if(is.arr(tile_spec)){var tdimen=tile_spec,sdimen=this.dimen(),h_factor=Math.floor(sdimen[0]/tdimen[0]);this.region_f=function(n){var v_pos=Math.floor(n/h_factor),h_pos=n%h_factor;return[h_pos*tdimen[0],v_pos*tdimen[1],tdimen[0],tdimen[1]]}}else if(is.fun(tile_spec)){this.region_f=tile_spec}if(callback)callback()});return function(elm){return new _Animator(sheet,elm)}};Builder.arcPath=function(centerX,centerY,radius,startAngle,arcAngle,steps){var twoPI=2*Math.PI;var angleStep=arcAngle/steps;var res=[];var xx=centerX+Math.cos(startAngle*twoPI)*radius;var yy=centerY+Math.sin(startAngle*twoPI)*radius;res.push([xx,yy]);for(var i=1;i<=steps;i++){var angle=startAngle+i*angleStep;xx=centerX+Math.cos(angle*twoPI)*radius;yy=centerY+Math.sin(angle*twoPI)*radius;res.push([xx,yy])}return Builder.path(res)};Builder._path=function(ctx,pos,path,fill,stroke,stroke_w){var p=B.path(path);ctx.save();ctx.translate(pos[0],pos[1]);if(fill)p.fill={color:fill};if(stroke)p.stroke={width:stroke_w!==undefined?stroke_w:0,color:stroke};p.apply(ctx);ctx.restore()};Builder._text=function(ctx,pos,text,size,font,fill,stroke,stroke_w){var t=B.text(text,size,font);if(fill)t.fill={color:fill};if(stroke)t.stroke={width:stroke_w!==undefined?stroke_w:0,color:stroke};t.apply(ctx,pos,"bottom")};Builder._rect=function(ctx,pos,rect,fill,stroke,stroke_w){var r=Builder.rect(rect);ctx.save();ctx.translate(pos[0],pos[1]);if(fill)r.fill={color:fill};if(stroke)r.stroke={width:stroke_w!==undefined?stroke_w:0,color:stroke};r.apply(ctx);ctx.restore()};Builder._oval=function(ctx,pos,radius,fill,stroke,stroke_w){var dimen=is.arr(radius)?[radius[0]+radius[0],radius[1]+radius[1]]:[radius+radius,radius+radius],scale=null,d_rad=radius;if(is.arr(radius)){if(dimen[0]<dimen[1]&&dimen[1]>0){scale=[dimen[0]/dimen[1],1];d_rad=radius[1]}else if(dimen[0]>dimen[1]&&dimen[0]>0){scale=[1,dimen[1]/dimen[0]];d_rad=radius[0]}}Path.applyF(ctx,fill?{color:fill}:Path.DEFAULT_FILL,stroke?{width:stroke_w!==undefined?stroke_w:0,color:stroke}:Path.DEFAULT_STROKE,null,function(ctx){ctx.translate(pos[0],pos[1]);if(scale)ctx.scale(scale[0],scale[1]);ctx.arc(0,0,d_rad,0,Math.PI*2,true)})};var prevClone=Element.prototype.clone;Element.prototype.clone=function(){var clone=prevClone.call(this);clone.__b$=this.__b$;return clone};return Builder});if(typeof __anm_engine==="undefined")throw new Error("No engine found!");__anm_engine.define("anm/importers/animatron",["anm","anm/Player"],function(anm){var AnimatronImporter=function(){var IMPORTER_ID="ANM";var C=anm.C,Scene=anm.Scene,Element=anm.Element,Path=anm.Path,Text=anm.Text,Bands=anm.Bands,is=anm.is,$log=anm.log;function _reportError(e){$log.error(e)}var Import={};var cur_import_id;Import._find=function(idx,src){var res=src[idx];if(!res)_reportError("Element with index "+idx+" was not found"+(src?" among "+src.length+" elements.":"."));return src[idx]};Import._type=function(src){return src[0]};Import.project=function(prj){if(anm.conf.logImport)$log.debug(prj);cur_import_id=anm.guid();anm.lastImportedProject=prj;anm.lastImportId=cur_import_id;var scenes_ids=prj.anim.scenes;if(!scenes_ids.length)_reportError("No scenes found in given project");var root=new Scene,elems=prj.anim.elements,last_scene_band=[0,0];root.__import_id=cur_import_id;root.meta=Import.meta(prj);Import.anim(prj,root);if(prj.meta.duration)root.duration=prj.meta.duration;var _a=prj.anim;Import._paths=prj.anim.paths;Import._path_cache=new ValueCache;for(var i=0,il=scenes_ids.length;i<il;i++){var node_src=Import._find(scenes_ids[i],elems);if(Import._type(node_src)!=TYPE_SCENE)_reportError("Given Scene ID "+scenes_ids[i]+" points to something else");var node_res=Import.node(node_src,elems,null,root);if(i>0){var gband_before=node_res.xdata.gband;node_res.xdata.gband=[last_scene_band[1]+gband_before[0],last_scene_band[1]+gband_before[1]];node_res.xdata.lband=node_res.xdata.gband;node_res.travelChildren(function(elm){var e_gband_before=elm.xdata.gband;elm.xdata.gband=[last_scene_band[1]+e_gband_before[0],last_scene_band[1]+e_gband_before[1]]})}last_scene_band=node_res.xdata.gband;root.add(node_res)}if(scenes_ids.length>0){node_res.xdata.gband=[last_scene_band[0],Infinity];node_res.xdata.lband=node_res.xdata.gband}Import._paths=undefined;Import._path_cache=undefined;return root};Import.meta=function(prj){var _m=prj.meta;return{title:_m.name,author:_m.author,copyright:_m.copyright,version:_m.version,description:_m.description,duration:_m.duration,created:_m.created,modified:_m.modified}};Import.anim=function(prj,trg){var _a=prj.anim;trg.fps=_a.framerate;trg.width=_a.dimension?Math.floor(_a.dimension[0]):undefined;trg.height=_a.dimension?Math.floor(_a.dimension[1]):undefined;trg.bgfill=_a.background?Import.fill(_a.background):undefined;trg.zoom=_a.zoom?Import.fill(_a.zoom):undefined;trg.speed=_a.speed?Import.fill(_a.speed):undefined;if(_a.loop&&(_a.loop===true||_a.loop==="true"))trg.repeat=true};var TYPE_UNKNOWN=0,TYPE_CLIP=1,TYPE_SCENE=2,TYPE_PATH=3,TYPE_TEXT=4,TYPE_RECT=5,TYPE_OVAL=6,TYPE_PENCIL=7,TYPE_IMAGE=8,TYPE_GROUP=9,TYPE_BRUSH=10,TYPE_STAR=11,TYPE_POLYGON=12,TYPE_CURVE=13,TYPE_AUDIO=14,TYPE_LINE=15,TYPE_LAYER=255;Import.node=function(src,all,parent,scene){var type=Import._type(src),trg=null;if(type==TYPE_CLIP||type==TYPE_SCENE||type==TYPE_GROUP){trg=Import.branch(type,src,all,scene)}else if(type!=TYPE_UNKNOWN){trg=Import.leaf(type,src,parent,scene)}if(trg){Import.callCustom(trg,src,type)}return trg};var L_ROT_TO_PATH=1,L_OPAQUE_TRANSFORM=2;L_VISIBLE=4;Import.branch=function(type,src,all,scene){var trg=new Element;trg.name=src[1];var _layers=type==TYPE_SCENE?src[3]:src[2],_layers_targets=[];if(type==TYPE_SCENE){trg.xdata.gband=[0,src[2]];trg.xdata.lband=[0,src[2]]}else{trg.xdata.gband=[0,Infinity];trg.xdata.lband=[0,Infinity]}for(var li=_layers.length;li--;){var lsrc=_layers[li];var nsrc=Import._find(lsrc[0],all);if(!nsrc)continue;var ltrg=Import.node(nsrc,all,trg,scene);if(!ltrg.name){ltrg.name=lsrc[1]}var flags=lsrc[6];ltrg.disabled=!(flags&L_VISIBLE);var x=ltrg.xdata,b=Import.band(lsrc[2]);if(type==TYPE_GROUP){x.gband=[0,b[1]];x.lband=[0,b[1]]}else{x.lband=b;x.gband=b}x.pvt=[0,0];x.reg=lsrc[4]||[0,0];if(lsrc[7]){var translates;for(var tweens=lsrc[7],ti=0,tl=tweens.length;ti<tl;ti++){var t=Import.tween(tweens[ti]);if(!t)continue;if(t.type==C.T_TRANSLATE){if(!translates)translates=[];translates.push(t)}ltrg.addTween(t)}if(translates&&flags&L_ROT_TO_PATH){for(var ti=0,til=translates.length;ti<til;ti++){ltrg.addTween({type:C.T_ROT_TO_PATH,band:translates[ti].band})}}translates=[]}if(lsrc[5]){x.mode=Import.mode(lsrc[5][0]);if(lsrc[5].length>1){x.nrep=lsrc[5][1]||Infinity}}else{x.mode=Import.mode(null)}if(!lsrc[3]){trg.add(ltrg);_layers_targets.push(ltrg)}else{var mask=ltrg,togo=lsrc[3],targets_n=_layers_targets.length;if(togo>targets_n){_reportError("No layers collected to apply mask, expected "+togo+", got "+targets_n);togo=targets_n}while(togo){var masked=_layers_targets[targets_n-togo];masked.setMask(mask);togo--}}Import.callCustom(ltrg,lsrc,TYPE_LAYER);if(ltrg._audio_master){x.lband=[x.lband[0],Infinity];x.gband=[x.gband[0],Infinity];trg.remove(ltrg);scene.add(ltrg)}}return trg};Import.leaf=function(type,src,parent,scene){var trg=new Element;var x=trg.xdata;if(type==TYPE_IMAGE){x.sheet=Import.sheet(src)}else if(type==TYPE_TEXT){x.text=Import.text(src)}else if(type!=TYPE_AUDIO){x.path=Import.path(src)}return trg};Import.callCustom=function(trg,src,type){if(Element._customImporters&&Element._customImporters.length){var importers=Element._customImporters;for(var i=0,il=importers.length;i<il;i++){importers[i].call(trg,src,type,IMPORTER_ID,cur_import_id)}}};Import.band=function(src){if(!src||!src.length)return[0,Infinity];if(src.length==1)return[src[0],Infinity];if(src.length==2)return src;_reportError("Unknown format of band: "+src)};Import.path=function(src){var path=Import._pathDecode(src[4]);if(!path)return;return new Path(path,Import.fill(src[1]),Import.stroke(src[2]),Import.shadow(src[3]))};Import._pathDecode=function(src){if(is.str(src))return src;if(!is.num(src)||src==-1)return null;var encoded=Import._paths[src];if(!encoded)return;var val=Import._path_cache.get(encoded);if(val){return val.duplicate().segs}else{val=Import._decodeBinaryPath(encoded);Import._path_cache.put(encoded,val)}return val.segs};Import._decodeBinaryPath=function(encoded){var path=new Path;if(encoded){encoded=encoded.replace(/\s/g,"");try{var decoded=Base64Decoder.decode(encoded);var s=new BitStream(decoded);var base=[0,0];if(s){var _do=true;while(_do){var type=s.readBits(2);switch(type){case 0:var p=Import._pathReadPoint(s,[],base);base=p;Path._parserVisitor("M",p,path);break;case 1:var p=Import._pathReadPoint(s,[],base);base=p;Path._parserVisitor("L",p,path);break;case 2:var p=Import._pathReadPoint(s,[],base);Import._pathReadPoint(s,p);Import._pathReadPoint(s,p);base=[p[p.length-2],p[p.length-1]];Path._parserVisitor("C",p,path);break;case 3:_do=false;break;default:_do=false;_reportError('Unknown type "'+type+' for path "'+encoded+'"');break}}}else{_reportError('Unable to decode Path "'+encoded+'"')}}catch(err){_reportError('Unable to decode Path "'+encoded+'"')}}return path};Import._pathReadPoint=function(stream,target,base){var l=stream.readBits(5);var x=stream.readSBits(l);var y=stream.readSBits(l);var b_x=base?base[0]:target.length?target[target.length-2]:0;var b_y=base?base[1]:target.length?target[target.length-1]:0;target.push(b_x+x/1e3);target.push(b_y+y/1e3);return target};Import.text=function(src){var lines=is.arr(src[6])?src:src[6].split("\n");return new Text(lines.length>1?lines:lines[0],src[4],Import.fill(src[1]),Import.stroke(src[2]),Import.shadow(src[3]),null,src[5],src[7]?true:false)};Import.sheet=function(src){var sheet=new anm.Sheet(src[1]);if(src[2])sheet._dimen=src[2];return sheet};Import.tween=function(src){var type=Import.tweentype(src[0]);if(type==null)return null;return{type:type,band:Import.band(src[1]),easing:Import.easing(src[2]),data:Import.tweendata(type,src[3])}};Import.tweentype=function(src){if(src===0)return C.T_ALPHA;if(src===1)return C.T_ROTATE;if(src===2)return C.T_SCALE;if(src===3)return C.T_SHEAR;if(src===4)return C.T_TRANSLATE};Import.tweendata=function(type,src){if(src==null)return null;if(type===C.T_TRANSLATE)return Import.pathval(src);if(type===C.T_ROTATE||type===C.T_ALPHA){if(src.length==2)return src;if(src.length==1)return[src[0],src[0]]}if(type===C.T_SCALE||type===C.T_SHEAR){if(src.length==4)return[[src[0],src[1]],[src[2],src[3]]];if(src.length==2)return[[src[0],src[1]],[src[0],src[1]]];if(src.length==1)return[[src[0],src[0]],[src[0],src[0]]]}};Import.easing=function(src){if(!src)return null;if(is.str(src)){return{type:C.E_PATH,data:Import.pathval("M0 0 "+src+" Z")}}else if(is.num(src)){return{type:C.E_STDF,data:src}}};Import.mode=function(src){if(!src)return C.R_ONCE;if(src===0)return C.R_ONCE;if(src===1)return C.R_LOOP;if(src===2)return C.R_BOUNCE;if(src===3)return C.R_STAY};Import.brush=function(src){if(!src)return null;if(is.str(src)){return{color:src}}else if(is.arr(src)){return Import.grad(src)}else _reportError("Unknown type of brush")};Import.fill=Import.brush;Import.stroke=function(src){if(!src)return null;var stroke=Import.brush(src[1]);stroke.width=src[0];stroke.cap=src[2]||C.PC_ROUND;stroke.join=src[3]||C.PC_ROUND;stroke.mitter=src[4];return stroke};Import.shadow=function(src){if(!src)return null;var shadow={};shadow.offsetX=src[0];shadow.offsetY=src[1];shadow.blurRadius=src[2];shadow.color=src[3];return shadow};Import.grad=function(src){var pts=src[0],colors=src[1],offsets=src[2];if(colors.length!=offsets.length){_reportError("Number of colors do not corresponds to number of offsets in gradient")}var stops=[];for(var i=0;i<offsets.length;i++){stops.push([offsets[i],colors[i]])}if(pts.length==4){return{lgrad:{dir:[[pts[0],pts[1]],[pts[2],pts[3]]],stops:stops}}}else if(pts.length==6){return{rgrad:{r:[pts[2],pts[5]],dir:[[pts[0],pts[1]],[pts[3],pts[4]]],stops:stops}}}else{_reportError("Unknown type of graient with "+pts.length+" points")}};Import.pathval=function(src){return new Path(Import._pathDecode(src))};function BitStream(int8array){this.buf=int8array;this.pos=0;this.bitPos=0;this.bitsBuf=0}BitStream.prototype.readBits=function(n){var v=0;for(;;){var s=n-this.bitPos;if(s>0){v|=this.bitBuf<<s;n-=this.bitPos;this.bitBuf=this.readUByte();this.bitPos=8}else{s=-s;v|=this.bitBuf>>s;this.bitPos=s;this.bitBuf&=(1<<s)-1;return v}}};BitStream.prototype.readUByte=function(){return this.buf[this.pos++]&255};BitStream.prototype.readSBits=function(n){var v=this.readBits(n);if((v&1<<n-1)!=0){v|=-1<<n}return v};function Base64Decoder(){}Base64Decoder.decode=function(str){return Base64Decoder.str2ab(Base64Decoder._decode(str))};Base64Decoder.str2ab=function(str){var result=new Int8Array(str.length);for(var i=0,strLen=str.length;i<strLen;i++){result[i]=str.charCodeAt(i)}return result};Base64Decoder._decode=function(data){if(typeof window["atob"]==="function"){return atob(data)}var b64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var o1,o2,o3,h1,h2,h3,h4,bits,i=0,ac=0,dec="",tmp_arr=[];if(!data){return data}data+="";do{h1=b64.indexOf(data.charAt(i++));h2=b64.indexOf(data.charAt(i++));h3=b64.indexOf(data.charAt(i++));h4=b64.indexOf(data.charAt(i++));bits=h1<<18|h2<<12|h3<<6|h4;o1=bits>>16&255;o2=bits>>8&255;o3=bits&255;if(h3==64){tmp_arr[ac++]=String.fromCharCode(o1)}else if(h4==64){tmp_arr[ac++]=String.fromCharCode(o1,o2)}else{tmp_arr[ac++]=String.fromCharCode(o1,o2,o3)}}while(i<data.length);dec=tmp_arr.join("");return dec};function ValueCache(){this.hash2val={}}ValueCache.prototype.put=function(str,val){this.hash2val[this.hash(str)]=val};ValueCache.prototype.get=function(str){return this.hash2val[this.hash(str)]};ValueCache.prototype.hash=function(str){var hash=0,i,char;if(str.length==0)return hash;for(i=0,l=str.length;i<l;i++){char=str.charCodeAt(i);hash=(hash<<5)-hash+char;hash|=0}return hash};function __MYSELF(){}__MYSELF.prototype.load=Import.project;__MYSELF.Import=Import;__MYSELF.IMPORTER_ID=IMPORTER_ID;return __MYSELF}();anm.registerImporter("animatron",AnimatronImporter);return AnimatronImporter});if(typeof __anm_engine==="undefined")throw new Error("No engine found!");__anm_engine.define("anm/modules/audio",["anm","anm/Player"],function(anm){var C=anm.C,Tween=anm.Tween,Tweens=anm.Tweens;var _ResMan=anm.resource_manager;var m_ctx={};var E=anm.Element;m_ctx._audio_ctx=function(){var context=window.webkitAudioContext||window.audioContext||window.AudioContext;return context?new context:null}();C.T_VOLUME="VOLUME";Tween.TWEENS_PRIORITY[C.T_VOLUME]=Tween.TWEENS_COUNT++;Tweens[C.T_VOLUME]=function(){return function(t,duration,data){if(!this.$._audio_is_loaded)return;this.$._audio.volume=data[0]*(1-t)+data[1]*t}};if(anm.isImporterAccessible("animatron")){var Import=anm.getImporter("animatron").Import;var prev_tweentype=Import.tweentype;Import.tweentype=function(src){if(src===7)return C.T_VOLUME;return prev_tweentype.apply(this,arguments)};var prev_tweendata=Import.tweendata;Import.tweendata=function(type,src){if(type===C.T_VOLUME&&src){if(src.length==2)return src;if(src.length==1)return[src[0],src[0]]}return prev_tweendata.apply(this,arguments)}}var _audio_customRender=function(gtime,ltime,ctx){};var _onAudioStart=function(ltime,duration){if(!this._audio_is_loaded||this._audio_is_playing){return false}this._audio_is_playing=true;var current_time=this._audio_band_offset+ltime;if(m_ctx._audio_ctx){this._source=m_ctx._audio_ctx.createBufferSource();this._source.buffer=this._audio;this._source.connect(m_ctx._audio_ctx.destination);if(this._source.play){this._source.play(0,current_time)}else if(this._source.start){this._source.start(0,current_time,this._source.buffer.duration-current_time)}else{this._source.noteGrainOn(0,current_time,this._source.buffer.duration-current_time)}}else{this._audio.currentTime=current_time;this._audio.volume=1;this._audio.play()}};var _onAudioStopIfNotMaster=function(ltime,duration){if(this._audio_master)return;_onAudioStop.call(this,ltime,duration)};var _onAudioStop=function(ltime,duration){if(this._audio_is_playing){try{if(m_ctx._audio_ctx){if(this._source.stop){this._source.stop(0)}else{this._source.noteOff(0)}this._source=null}else{this._audio.pause();this._audio.volume=0}}catch(err){}this._audio_is_playing=false}};E._customImporters.push(function(source,type,importer){if(14==type||"0e"==type){if(importer=="ANM"){this._audio_url=source[1];this._audio_band_offset=source[2];this._audio_master=source[3]}else if(importer=="ANM_INTACT"){this._audio_band_offset=source.bandOffset;this._audio_url=this._audio_format_url(source.url)}this.isAudio=true;this._audio=null;this._audio_is_loaded=false;this._audio_is_playing=false;this._audio_canPlay=false;this.on(C.X_START,_onAudioStart);this.on(C.X_STOP,_onAudioStopIfNotMaster);this.on(C.S_STOP,_onAudioStop);this.on(C.S_PAUSE,_onAudioStop);this.__frameProcessors.push(_audio_customRender)}});E.prototype._audio_format_url=function(url){return url+(this._ogg_supported()?".ogg":".mp3")};E.__test_elm=null;E.prototype._ogg_supported=function(){var a=E.__test_elm?E.__test_elm:(E.__test_elm=document.createElement("audio"),E.__test_elm);return!!(a.canPlayType&&a.canPlayType("audio/ogg;").replace(/no/,""))};var prev__hasRemoteResources=E.prototype._hasRemoteResources;E.prototype._hasRemoteResources=function(scene,player){return prev__hasRemoteResources.apply(this,arguments)||this.isAudio&&player.audioEnabled};var prev__collectRemoteResources=E.prototype._collectRemoteResources;E.prototype._collectRemoteResources=function(scene,player){var prev=prev__collectRemoteResources.apply(this,arguments);if(!player.audioEnabled)return prev;if(!this.isAudio)return prev;return prev?[this._audio_url].concat(prev):[this._audio_url]};var prev__loadRemoteResources=E.prototype._loadRemoteResources;E.prototype._loadRemoteResources=function(scene,player){var prev=prev__loadRemoteResources.apply(this,arguments);if(this.isAudio&&player.audioEnabled)this._audioLoad()};function audioErrProxy(src,pass_to){return function(err){pass_to(new Error("Failed to load audio file from "+src+" with error code: "+err.currentTarget.error.code))}}function syncStream(node){var buf8=new Uint8Array(node.buf);buf8.indexOf=Array.prototype.indexOf;var i=node.sync,b=buf8;while(1){node.retry++;i=b.indexOf(255,i);if(i==-1||b[i+1]&224==224)break;i++}if(i!=-1){var tmp=node.buf.slice(i);delete node.buf;node.buf=null;node.buf=tmp;node.sync=i;return true}return false}E.prototype._audioLoad=function(){var me=this;_ResMan.loadOrGet(me._audio_url,function(notify_success,notify_error){if(anm.conf.doNotLoadAudio){notify_error("Loading audio is turned off");return}if(m_ctx._audio_ctx){var url=me._audio_format_url(me._audio_url);var node={};var decode=function(node,url){try{m_ctx._audio_ctx.decodeAudioData(node.buf,function onSuccess(decodedBuffer){notify_success(decodedBuffer)},function(err){if(syncStream(node))decode(node,url)})}catch(e){notify_error("Unable to load audio "+url+": "+e.message)}};var loadingDone=function(e){var req=e.target;if(req.status==200){node.buf=req.response;node.sync=0;node.retry=0;decode(node)}else{notify_error("Unable to load audio "+url+": "+req.statusText)}};node.xhr=new XMLHttpRequest;node.xhr.open("GET",url,true);node.xhr.responseType="arraybuffer";node.xhr.addEventListener("load",loadingDone,false);node.xhr.addEventListener("error",audioErrProxy(url,notify_error),false);node.xhr.send()}else{var el=document.createElement("audio");el.setAttribute("preload","auto");var progressListener=function(e){var buffered=el.buffered;if(buffered.length==1){var end=buffered.end(0);if(el.duration-end<.05){el.removeEventListener("progress",progressListener,false);el.removeEventListener("canplay",canPlayListener,false);notify_success(el);return}if(me._audio_canPlay&&window.chrome){el.volume=0;el.currentTime=end;el.play();el.pause()}}else if(me._audio_canPlay&&buffered.length!=1){notify_success(el)}};var canPlayListener=function(e){me._audio_canPlay=true;progressListener(e)};el.addEventListener("progress",progressListener,false);el.addEventListener("canplay",canPlayListener,false);el.addEventListener("error",audioErrProxy(me._audio_url,notify_error),false);var addSource=function(audio,url,type){var src=document.createElement("source");src.type=type;src.src=url;src.addEventListener("error",notify_error,false);audio.appendChild(src)};try{document.getElementsByTagName("body")[0].appendChild(el);addSource(el,me._audio_url+".mp3","audio/mpeg");addSource(el,me._audio_url+".ogg","audio/ogg")}catch(e){notify_error(e)}}},function(audio){me._audio=audio;me._audio_is_loaded=true},function(err){anm.log.error(err?err.message||err:"Unknown error")})};anm.registerModule("audio",m_ctx);return m_ctx});if(typeof __anm_engine==="undefined")throw new Error("No engine found!");__anm_engine.define("anm/modules/collisions",["anm","anm/Player"],function(anm){var $engine=anm.engine;var C=anm.C;var opts={pathDriven:false,useSnaps:false,vectorSpan:1,predictSpan:1,mouseBound:false};anm.registerModule("collisions",opts);function __filled(arr,val){var l=arr.length;result=new Array(l),i=l;while(i--)result[i]=val;return result}var E=anm.Element;var Path=anm.Path,MSeg=anm.MSeg,LSeg=anm.LSeg,CSeg=anm.CSeg;var Scene=anm.Scene;E.prototype.bounds=function(t){return this._pradopt(this._cpa_bounds(),t)};E.prototype.dbounds=function(t){var b=this.bounds(t);var minX,minY,maxX,maxY;if(b){minX=b[0];minY=b[1];maxX=b[2];maxY=b[3]}else{minX=minY=Number.MAX_VALUE;maxX=maxY=0}this.travelChildren(function(elm){var cb=elm.bounds(t);if(!cb)return;minX=Math.min(minX,cb[0]);minY=Math.min(minY,cb[1]);maxX=Math.max(maxX,cb[2]);maxY=Math.max(maxY,cb[3])});return[minX,minY,maxX,maxY]};E.prototype.rect=function(t){return this._pradopt(this._cpa_rect(),t)};E.prototype.drect=function(t){var r=this.rect(t);var x1,y1,x2,y2,x3,y3,x4,y4;if(r){x1=r[0];y1=r[1];x2=r[2];y2=r[3];x3=r[4];y3=r[5];x4=r[6];y4=r[7]}else{x1=y1=y2=x4=Number.MAX_VALUE;x2=y4=x3=y3=0}this.travelChildren(function(elm){var cr=elm.rect(t);if(!cr)return;x1=Math.min(x1,cr[0]);y1=Math.min(y1,cr[1]);x2=Math.max(x2,cr[2]);y2=Math.min(y2,cr[3]);x3=Math.max(x3,cr[4]);y3=Math.max(y3,cr[5]);x4=Math.min(x4,cr[6]);y4=Math.max(y4,cr[7])});return[x1,y1,x2,y2,x3,y3,x4,y4]};E.prototype.local=function(pt,t){return this._padopt(pt,t)};E.prototype.global=function(pt,t){return this._pradopt(pt,t)};E.prototype.reactAs=function(path){this.xdata.__cpath=path};E.prototype.reactWith=function(func){this.xdata.__cfunc=func};E.prototype.collectPoints=function(){var x=this.xdata;if(x.__cpath)return x.__cpath.getPoints();if(x.path)return x.path.getPoints();if(x.image||x.text)return this.lrect()};E.prototype.contains=function(pt,t){if(!pt)return false;var b=this._cpa_bounds();if(!b){if(this.hasChildren()){var result=false;this.iterateChildren(function(child){if(!result&&child.contains(pt,t)){result=true}});return result}return false}var pt=this._padopt(pt,t);var x=this.xdata;if(x.__cfunc)return x.__cfunc.call(this,pt);var inBounds;if(inBounds=G.__inBounds(b,pt)){if(!opts.pathDriven)return true;if(x.__cpath)return x.__cpath.contains(pt);if(x.path)return x.path.contains(pt);if(x.image||x.text)return inBounds}return false};E.prototype.dcontains=function(pt,t){var matched=[];if(this.contains(pt,t)){matched.push(this)}if(this.children){elm.visitChildren(function(celm){matched.concat(celm.dcontains(pt,t))})}return matched};E.prototype.intersects=function(elm,t){var rectsMatched;if(rectsMatched=G.__isecRects(this.rect(t),elm.rect(t))){if(!opts.pathDriven)return true;var cx=this.xdata,ex=elm.xdata;var pathOfC=cx.__cpath||cx.path;var pathOfE=ex.__cpath||ex.path;if(!pathOfC&&!pathOfE)return rectsMatched;else if(pathOfC&&pathOfE){return G.__pointsInPath(this.__pathAt(t),elm.__pointsAt(t))||G.__pointsInPath(elm.__pathAt(t),this.__pointsAt(t))}else if(pathOfC&&!pathOfE){var e_rect=elm.rect(t);return G.__pointsInRect(this.__pointsAt(t),e_rect)||G.__pointsInPath(this.__pathAt(t),e_rect)}else if(!pathOfC&&pathOfE){var c_rect=this.rect(t);return G.__pointsInRect(elm.__pointsAt(t),c_rect)||G.__pointsInPath(elm.__pathAt(t),c_rect)}return false}};E.prototype.dintersects=function(elm,t){var matched=[];if(this.intersects(elm,t)){matched.push(this)}if(this.children){elm.visitChildren(function(celm){matched.concat(celm.dintersects(elm,t))})}return matched};E.prototype.collides=function(elm,func){if(!this._collisionTests)this._collisionTests=[];if(!this._collisionElms)this._collisionElms=[];this._collisionTests.push(func);this._collisionElms.push(elm)};E.prototype.dcollides=function(elm,t){throw new Error("Not implemented")};E.prototype._adopt=function(pts,t){if(!pts)return null;this.__ensureTimeTestAllowedFor(t);var s=t==null?this.astate||this.bstate:this.stateAt(t);if(!s._applied)return __filled(pts,Number.MIN_VALUE);return this.__adoptWithM(this.__updateWithRegAndPivot(pts,s.sx,s.sy),E._getIMatrixOf(s))};E.prototype._radopt=function(pts,t){if(!pts)return null;this.__ensureTimeTestAllowedFor(t);var s=t==null?this.astate||this.bstate:this.stateAt(t);if(!s._applied)return __filled(pts,Number.MIN_VALUE);return this.__adoptWithM(this.__rupdateWithRegAndPivot(pts,s.sx,s.sy),E._getMatrixOf(s))};E.prototype._padopt=function(pt,t){var p=this.parent;while(p){pt=p._adopt(pt,t);p=p.parent}return this._adopt(pt,t)};E.prototype._pradopt=function(pt,t){var pt=this._radopt(pt,t);var p=this.parent;while(p){pt=p._radopt(pt,t);p=p.parent}return pt};E.prototype.__updateWithRegAndPivot=function(pts,sx,sy){var dimen=this.dimen(),reg=this.xdata.reg,pvt=this.xdata.pvt;if(!dimen)dimen=[0,0];if(pvt[0]===0&&pvt[1]===0&&reg[0]===0&&reg[1]===0)return pts;if(pts.length>2){var transformed=[];for(var pi=0,pl=pts.length;pi<pl;pi+=2){transformed.push(reg[0]*sx+pvt[0]*dimen[0]*sx+pts[pi],reg[1]*sy+pvt[1]*dimen[1]*sy+pts[pi+1])}return transformed}else{return[reg[0]*sx+pvt[0]*dimen[0]*sx+pts[0],reg[1]*sy+pvt[1]*dimen[1]*sy+pts[1]]}};E.prototype.__rupdateWithRegAndPivot=function(pts,sx,sy){var dimen=this.dimen(),reg=this.xdata.reg,pvt=this.xdata.pvt;if(!dimen)dimen=[0,0];if(pvt[0]===0&&pvt[1]===0&&reg[0]===0&&reg[1]===0)return pts;if(pts.length>2){var transformed=[];for(var pi=0,pl=pts.length;pi<pl;pi+=2){transformed.push(-(reg[0]*sx)+-(pvt[0]*dimen[0]*sx)+pts[pi],-(reg[1]*sy)+-(pvt[1]*dimen[1]*sy)+pts[pi+1])}return transformed}else{return[-(reg[0]*sx)+-(pvt[0]*dimen[0]*sx)+pts[0],-(reg[1]*sy)+-(pvt[1]*dimen[1]*sy)+pts[1]]}};E.prototype.__adoptWithM=function(pts,m){if(pts.length>2){var transformed=[];for(var pi=0,pl=pts.length;pi<pl;pi+=2){var tpt=m.transformPoint(pts[pi],pts[pi+1]);transformed.push(tpt[0],tpt[1])}return transformed}else{return m.transformPoint(pts[0],pts[1])}};E.___vecErrText="Ensure you have passed actual "+"(current) time to _getVects "+"or check if vectorSpan value is > (1 / min.framerate) "+"or may be framerate itself is too low";E.prototype._makeGhost=function(t){var s0,s1,t_diff;var t_pred=opts.predictSpan;if(!opts.useSnaps){if(this.__modifying!==null){s0=this.state;s1=this._state}else{s0=this.state._||this.state;s1=this.state}t_diff=t-s0._appliedAt}else{var s=this.__modifying!==null?this._state:this.state,sn0=s.snap0,sn1=s.snap1;if(!sn0&&!sn1)throw new Error("No vector data available, is this element tracked?");var pos=Math.floor(t/opts.vectorSpan);if(!sn1){if(pos!=sn0._at)throw new Error(E.__vecErrText);s0=sn0;s1=s;t_diff=t-sn0._atT}else{var pass_t=t-sn1._atT;if(pass_t<=opts.vectorSpan){var span_t=sn1._atT-sn0._atT;if(span_t<opts.vectorSpan-pass_t)throw new Error(E.__vecErrText);var span_pos=span_t-(opts.vectorSpan-pass_t);s0=E._stateBetween(sn0,sn1,span_t,span_pos);s1=s;t_diff=opts.vectorSpan}else{s0=sn1;s1=s;t_diff=pass_t}}}var vec=E._getVect(s0,s1||s0,t_diff);var ghost=E._predictState(s1||s0,vec,opts.predictSpan);ghost._applied=true;ghost._appliedAt=t;ghost._matrix=E._getMatrixOf(E._mergeStates(this.bstate,ghost),ghost._matrix);ghost._vec=vec;ghost._tdiff=t_diff;this.__ghost=ghost;return ghost};E.prototype._defCollides=function(t,elm,func){var prev_src_st=this.state;var prev_cmp_st=elm.state;var src_ghost=this._makeGhost(t);var cmp_ghost=elm._makeGhost(t);this.state=src_ghost;elm.state=cmp_ghost;var intersects=this.intersects(elm);this.state=prev_src_st;elm.state=prev_cmp_st;if(intersects){func.call(this,t,src_ghost._tdiff,src_ghost._vec,cmp_ghost._vec)}};E.prototype.__pathAt=function(t){var path=this.xdata.__cpath||this.xdata.path;if(!path)throw new Error("No path found for elm "+this.id);var mpath=path.duplicate();var me=this;mpath.vpoints(function(x,y){return me._pradopt([x,y],t)});return mpath};E.prototype.__pointsAt=function(t){return this._pradopt(this.collectPoints(),t)};E.prototype._cpa_bounds=function(){var cpath=this.xdata.__cpath;return cpath?cpath.bounds():this.lbounds()};E.prototype._cpa_rect=function(){var cpath=this.xdata.__cpath;return cpath?cpath.rect():this.lrect()};E.prototype.__ensureTimeTestAllowedFor=function(t){if(t!=null&&this.__modifying!=null&&this.__modifying!==E.EVENT_MOD){throw new Error("Time-related tests may happen only outside of modifier or inside event handler")}return true};E._getVect=function(s0,s1,t_diff){if(t_diff==0)return E.createState();return{x:(s1.x-s0.x)/t_diff,y:(s1.y-s0.y)/t_diff,lx:(s1.lx-s0.lx)/t_diff,ly:(s1.ly-s0.ly)/t_diff,rx:(s1.rx-s0.rx)/t_diff,ry:(s1.ry-s0.ry)/t_diff,sx:(s1.sx-s0.sx)/t_diff,sy:(s1.sy-s0.sy)/t_diff,angle:(s1.angle-s0.angle)/t_diff,alpha:(s1.alpha-s0.alpha)/t_diff}};E._stateBetween=function(s0,s1,t_diff,at){if(t_diff==0)return s0;return{x:s0.x+(s1.x-s0.x)/t_diff*at,y:s0.y+(s1.y-s0.y)/t_diff*at,lx:s0.lx+(s1.lx-s0.lx)/t_diff*at,ly:s0.lx+(s1.ly-s0.ly)/t_diff*at,rx:s0.rx+(s1.rx-s0.rx)/t_diff*at,ry:s0.ry+(s1.ry-s0.ry)/t_diff*at,sx:s0.sx+(s1.sx-s0.sx)/t_diff*at,sy:s0.sy+(s1.sy-s0.sy)/t_diff*at,angle:s0.angle+(s1.angle-s0.angle)/t_diff*at,alpha:s0.alpha+(s1.alpha-s0.alpha)/t_diff*at}};E._predictState=function(s1,vec,t_pred){return{x:s1.x+vec.x*t_pred,y:s1.y+vec.y*t_pred,lx:s1.lx+vec.lx*t_pred,ly:s1.ly+vec.ly*t_pred,rx:s1.rx+vec.rx*t_pred,ry:s1.ry+vec.ry*t_pred,sx:s1.sx+vec.sx*t_pred,sy:s1.sy+vec.sy*t_pred,angle:s1.angle+vec.angle*t_pred,alpha:s1.alpha+vec.alpha*t_pred}};function p_drawCPath(ctx,cPath){if(!(cPath=cPath||this.__cpath))return;cPath.cstroke("#f00",2);cPath.apply(ctx)}function p_drawAdoptedRect(ctx){var rect=this.$._cpa_rect();if(rect){var ratio=$engine.PX_RATIO||1;rect=this.$._pradopt(rect);ctx.save();ctx.setTransform(ratio,0,0,ratio,0,0);ctx.fillStyle="#0f0";ctx.fillRect(rect[0]-2,rect[1]-2,4,4);ctx.fillRect(rect[2]-2,rect[3]-2,4,4);ctx.fillRect(rect[4]-2,rect[5]-2,4,4);ctx.fillRect(rect[6]-2,rect[7]-2,4,4);ctx.beginPath();ctx.strokeStyle="#0f0";ctx.lineWidth=2;ctx.moveTo(rect[0],rect[1]);ctx.lineTo(rect[2],rect[3]);ctx.lineTo(rect[4],rect[5]);ctx.lineTo(rect[6],rect[7]);ctx.lineTo(rect[0],rect[1]);ctx.closePath();ctx.stroke();ctx.restore()}}function p_drawAdoptedPoints(ctx){var pts=this.$.collectPoints();if(pts){var ratio=$engine.PX_RATIO||1;pts=this.$._pradopt(pts);ctx.save();ctx.setTransform(ratio,0,0,ratio,0,0);ctx.fillStyle="#00f";for(var pi=0,pl=pts.length;pi<pl;pi+=2){ctx.fillRect(pts[pi]-2,pts[pi+1]-2,4,4)}ctx.restore()}}function p_drawGhost(ctx){var me=this.$;if(me.__ghost&&!me.__ghostLock){var ratio=$engine.PX_RATIO||1;ctx.save();me.__ghostLock=true;ctx.setTransform(ratio,0,0,ratio,0,0);me.__ghost._matrix.apply(ctx);ctx.globalAlpha=.6;me.draw(ctx);me.__ghostLock=false;ctx.restore()}}var prevAddDebugRender=E.__addDebugRender;E.__addDebugRender=function(elm){prevAddDebugRender(elm);elm.__paint({type:E.DEBUG_PNT},p_drawCPath);elm.__paint({type:E.DEBUG_PNT},p_drawAdoptedRect);elm.__paint({type:E.DEBUG_PNT},p_drawAdoptedPoints);elm.__paint({type:E.DEBUG_PNT},p_drawGhost)};var prevMAfter=E.prototype.__mafter;E.prototype.__mafter=function(t,type,result){prevMAfter.call(this,t,type,result);if(result&&type===E.LAST_MOD){if(opts.useSnaps&&this.track){this.__updateSnaps(t)
}var colTests=this._collisionTests;if(colTests&&colTests.length>0){var colElms=this._collisionElms;for(var ci=0,cl=colTests.length;ci<cl;ci++){this._defCollides(t,colElms[ci],colTests[ci])}this._collisionTests=[];this._collisionElms=[]}}};E.prototype.__updateSnaps=function(t){var pos=Math.floor(t/opts.vectorSpan);var s=this.state,_s=this._state;if(!s._applied||!s.snap0){_s.snap0=anm.obj_clone(_s);_s.snap0._at=pos;_s.snap0._atT=t;_s.snap1=null}else if(s.snap0){var offset0=pos-s.snap0._at;if(!s.snap1&&pos>0){_s.snap1=anm.obj_clone(_s);_s.snap1._at=pos;_s.snap1._atT=t}else if(offset0>1&&pos!=s.snap1._at){_s.snap0=s.snap1;_s.snap1=anm.obj_clone(_s);_s.snap1._at=pos;_s.snap1._atT=pos}else{_s.snap0=s.snap0;_s.snap1=s.snap1}if(_s.snap1&&t-_s.snap1._at<0){_s.snap0=null;_s.snap1=null}}};E.prototype._getVects=function(t){var s=this._state,s0=s.snap0,s1=s.snap1;if(!s0&&!s1)throw new Error("No vector data available, is this element tracked?");var pos=Math.floor(t/opts.vectorSpan);if(!s1){if(pos!=s0._at)throw new Error(E.__vecErrText);var vec_t=t-s0._at;return{mov:[s0.x,s0.y,s.x,s.y,vec_t],rot:[s0.angle,s.angle,vec_t],scl:[s0.sx,s0.sy,s.sx,s.sy,vec_t]}}else{var pass_t=t-s1._at;if(pass_t>opts.vectorSpan){return{mov:[s1.x,s1.y,s.x,s.y,pass_t],rot:[s1.angle,s.angle,pass_t],scl:[s1.sx,s1.sy,s.x,s.y,pass_t]}}var span_t=s1._at-s0._at;if(span_t<opts.vectorSpan-pass_t)throw new Error(E.__vecErrText);var span_pos=span_t-(opts.vectorSpan-pass_t);var vec_t=opts.vectorSpan;return{mov:[s0.x+(s1.x-s0.x)*span_pos,s0.y+(s1.y-s0.y)*span_pos,s1.x+(s.x-s1.x)*pass_t,s1.y+(s.y-s1.y)*pass_t,vec_t],rot:[s0.angle+(s1.angle-s0.angle)*span_pos,s1.angle+(s.x-s1.x)*pass_t,s1.y+(s.y-s1.y)*pass_t,vec_t],scl:[s0.sx+(s1.sx-s0.sx)*span_pos,s0.sy+(s1.sy-s0.sy)*span_pos,s1.sx+(s.sx-s1.sx)*pass_t,s1.sy+(s.sy-s1.sy)*pass_t,vec_t]}}throw new Error(E.__vecErrText)};var prev_handle__x=Scene.prototype.handle__x;Scene.prototype.handle__x=function(type,evt){if(opts.mouseBound){if(type&C.XT_MOUSE){switch(type){case C.X_MCLICK:case C.X_MDCLICK:case C.X_MUP:case C.X_MDOWN:{this.visitElems(function(elm){if(elm.shown&&elm.contains(evt.pos))elm.fire(type,evt)});return true}case C.X_MMOVE:{this.visitElems(function(elm){if(elm.shown){if(elm.contains(evt.pos)){elm.fire(C.X_MMOVE,evt);if(elm.__wout){elm.fire(C.X_MOVER,evt);elm.__wout=false}}else{if(!elm.__wout){elm.fire(C.X_MOUT,evt);elm.__wout=true}}}});return true}case C.X_MOVER:case C.X_MOUT:{return true}}}}return prev_handle__x.call(this,type,evt)};Path.prototype.contains=function(pt){return(this.crosses(pt)&-1)!=0};Path.prototype.crosses=function(pt){if(this.segs.length<2)return false;var start=this.start();var cur=start;var crossings=0;this.visit(function(segment){crossings+=segment.crosses(cur,pt);cur=segment.last()});if(pt[0]!=start[0]&&pt[1]!=start[1]){crossings+=G.__lineCrosses(pt[0],pt[1],cur[0],cur[1],start[0],start[1])}return crossings};MSeg.prototype.crosses=function(start,point){var pts=this.pts;return G.__lineCrosses(point[0],point[1],start[0],start[1],pts[0],pts[1])};LSeg.prototype.crosses=function(start,point){var pts=this.pts;return G.__lineCrosses(point[0],point[1],start[0],start[1],pts[0],pts[1])};CSeg.prototype.crosses=function(start,point){var level=level||0,pts=this.pts;return G.__curveCrosses(point[0],point[1],start[0],start[1],pts[0],pts[1],pts[2],pts[3],pts[4],pts[5],0)};var G={};G.__zeroBounds=function(b){return b[0]===b[1]&&b[1]===b[2]&&b[2]===b[3]};G.__zeroRect=function(r){return r[0]===r[1]&&r[1]===r[2]&&r[2]===r[3]&&r[3]===r[4]&&r[4]===r[5]&&r[5]===r[6]&&r[6]===r[7]};G.__inBounds=function(b,pt,zeroTest){if(!b)throw new Error("Bounds are not accessible");if(zeroTest&&G.__zeroBounds(b))return false;return pt[0]>=b[0]&&pt[0]<=b[2]&&pt[1]>=b[1]&&pt[1]<=b[3]};G.__inRect=function(r,pt,zeroTest){if(!r)throw new Error("Rect is not accessible");if(zeroTest&&G.__zeroRect(r))return false;return pt[0]>=r[0]&&pt[0]<=r[2]&&pt[1]>=r[1]&&pt[1]<=r[5]};G.__edgeTest=function(p1,p2,p3,r2){var rot=[-(p2[1]-p1[1]),p2[0]-p1[0]];var ref=rot[0]*(p3[0]-p1[0])+rot[1]*(p3[1]-p1[1])>=0;for(var i=0,il=r2.length;i<il;i+=2){if(rot[0]*(r2[i]-p1[0])+rot[1]*(r2[i+1]-p1[1])>=0===ref)return false}return true};G.__isecRects=function(r1,r2){if(!r1||!r2)throw new Error("One (or both) of rects / bounds is not accessible");if(G.__zeroRect(r1)||G.__zeroRect(r2))return false;var edgeTest=G.__edgeTest;var pn,px;for(var pi=0,pl=r1.length;pi<pl;pi+=2){pn=pi===pl-2?0:pi+2;px=pn===pl-2?0:pn+2;if(edgeTest([r1[pi],r1[pi+1]],[r1[pn],r1[pn+1]],[r1[px],r1[px+1]],r2))return false}for(var pi=0,pl=r2.length;pi<pl;pi+=2){pn=pi===pl-2?0:pi+2;px=pn===pl-2?0:pn+2;if(edgeTest([r2[pi],r2[pi+1]],[r2[pn],r2[pn+1]],[r2[px],r2[px+1]],r1))return false}return true};G.__pointsInPath=function(path,pts){for(var pi=0,pl=pts.length;pi<pl;pi+=2){if(path.contains([pts[pi],pts[pi+1]]))return true}return false};G.__pointsInRect=function(r,pts){if(G.__zeroRect(r))return false;var inRect=G.__inRect;for(var pi=0,pl=pts.length;pi<pl;pi+=2){if(inRect(r,[pts[pi],pts[pi+1]],false))return true}return false};G.__lineCrosses=function(px,py,x0,y0,x1,y1){if(py<y0&&py<y1)return 0;if(py>=y0&&py>=y1)return 0;if(px>=x0&&px>=x1)return 0;if(px<x0&&px<x1)return y0<y1?1:-1;var xitcpt=x0+(py-y0)*(x1-x0)/(y1-y0);if(px>=xitcpt)return 0;return y0<y1?1:-1};G.__curveCrosses=function(px,py,x0,y0,xc0,yc0,xc1,yc1,x1,y1,level){var level=level||0;if(py<y0&&py<yc0&&py<yc1&&py<y1)return 0;if(py>=y0&&py>=yc0&&py>=yc1&&py>=y1)return 0;if(px>=x0&&px>=xc0&&px>=xc1&&px>=x1)return 0;if(px<x0&&px<xc0&&px<xc1&&px<x1){if(py>=y0){if(py<y1)return 1}else{if(py>=y1)return-1}return 0}if(level>52)return G.__lineCrosses(px,py,x0,y0,x1,y1);var xmid=(xc0+xc1)/2,ymid=(yc0+yc1)/2;var xc0=(x0+xc0)/2,yc0=(y0+yc0)/2,xc1=(xc1+x1)/2,yc1=(yc1+y1)/2;var xc0m=(xc0+xmid)/2,yc0m=(yc0+ymid)/2;xmc1=(xmid+xc1)/2;ymc1=(ymid+yc1)/2;xmid=(xc0m+xmc1)/2;ymid=(yc0m+ymc1)/2;if(isNaN(xmid)||isNaN(ymid)){return 0}return G.__curveCrosses(px,py,x0,y0,xc0,yc0,xc0m,yc0m,xmid,ymid,level+1)+G.__curveCrosses(px,py,xmid,ymid,xmc1,ymc1,xc1,yc1,x1,y1,level+1)};return opts});if(typeof __anm_engine==="undefined")throw new Error("No engine found!");__anm_engine.define("anm/modules/scripting",["anm","anm/Player"],function(anm){var _ResMan=anm.resource_manager;var Player=anm.Player;var is=anm.is;var C=anm.C;var E=anm.Element;var $log=anm.log;var __findByName=function(elm){return function(name,context){return anm.findByName(context||elm.scene,name)}};var __jumpToScene=function(elm){return function(name){var scenes=this.findByName(name);if(scenes.length){elm.scene.invokeLater(function(){if(elm.scene.__player_instance){elm.scene.__player_instance.pause();elm.scene.__player_instance.play(scenes[0].xdata.gband[0])}})}}};var __jumpToTime=function(elm){return function(t){elm.scene.invokeLater(function(){if(elm.scene.__player_instance){elm.scene.__player_instance.pause();elm.scene.__player_instance.play(t)}})}};function user_ctx(elm){var ctx=elm.bstate||{};ctx.findByName=__findByName(elm);ctx.jumpToScene=__jumpToScene(elm);ctx.jumpToTime=__jumpToTime(elm);ctx.$=elm;return ctx}function _tpl_base(inner){return"(function(ctx) { "+"return function(evt, t) { "+inner+"}"+"})(____user_ctx)"}function tpl(bounds,inner){if(bounds){return _tpl_base("if (this.$.contains(evt.pos, t)) { "+"(function(ctx, evt, t) { "+"var _b = anm.Builder._$;"+inner+"\n}).call(user_ctx(this.$ || this), ctx, evt, t);"+"}")}else{return _tpl_base("(function(ctx, evt, t) { "+"var _b = anm.Builder._$;"+inner+"\n}).call(user_ctx(this.$ || this), ctx, evt, t);")}}var handler_map={click:C.X_MCLICK,m_up:C.X_MUP,m_down:C.X_MDOWN,m_enter:C.X_MMOVE,m_leave:C.X_MMOVE,m_move:C.X_MMOVE,k_up:C.X_KUP,k_down:C.X_KDOWN,k_press:C.X_KPRESS,init:C.S_LOAD};function iterate_handlers(handlers,e_type){if(!handlers)return false;var result=false;for(var handler_type in handlers){var body=handlers[handler_type];var handler_code;switch(handler_type){case"m_move","m_up","k_up","k_down","k_press":handler_code=tpl(false,body);break;case"m_enter":handler_code=_tpl_base("if ((this.$.__last_p_in == undefined || !this.$.contains(this.$.__last_p_in, t)) && this.$.contains(evt.pos, t)) { "+"(function(ctx, evt, t) { "+"var _b = anm.Builder._$;"+body+"\n}).call(user_ctx(this.$ || this), ctx, evt, t);"+"}"+"this.$.__last_p_in = evt.pos;");break;case"m_leave":handler_code=_tpl_base("if (this.$.__last_p_out != undefined && this.$.contains(this.$.__last_p_out, t) && !this.$.contains(evt.pos, t)) { "+"(function(ctx, evt, t) { "+"var _b = anm.Builder._$;"+body+"\n}).call(user_ctx(this.$ || this), ctx, evt, t);"+"}"+"this.$.__last_p_out = evt.pos;");break;default:handler_code=tpl(e_type==255,body);break}result=true;var registar=handler_type=="init"?"on":"m_on";try{eval("this."+registar+"(handler_map[handler_type], "+handler_code+");")}catch(e){$log.error("A potential error in scripting code, skipping: "+handler_code)}}return result}var ____user_ctx={foo:"bar"};var is_dynamic={};E._customImporters.push(function(source,type,importer,import_id){if(importer==="ANM"){switch(type){case 2:is_dynamic[import_id]=iterate_handlers.call(this,source[4],type)||is_dynamic[import_id];break;case 255:is_dynamic[import_id]=iterate_handlers.call(this,source[8],type)||is_dynamic[import_id];break;default:break}}});anm.player_manager.on(C.S_NEW_PLAYER,function(player){player.on(C.S_LOAD,function(scene){if(is_dynamic[scene.__import_id]){player.mode=C.M_DYNAMIC;player.anim.duration=Infinity;player._checkOpts();scene.__player_instance=player;player.play()}})});var conf={};anm.registerModule("scripting",conf);return conf});
